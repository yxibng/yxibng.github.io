{"meta":{"version":1,"warehouse":"5.0.1"},"models":{"Asset":[{"_id":"node_modules/hexo-theme-fluid/source/css/gitalk.css","path":"css/gitalk.css","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/css/highlight-dark.styl","path":"css/highlight-dark.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/css/highlight.styl","path":"css/highlight.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/avatar.png","path":"img/avatar.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/default.png","path":"img/default.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/fluid.png","path":"img/fluid.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/loading.gif","path":"img/loading.gif","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/police_beian.png","path":"img/police_beian.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/boot.js","path":"js/boot.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/color-schema.js","path":"js/color-schema.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/events.js","path":"js/events.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/img-lazyload.js","path":"js/img-lazyload.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/leancloud.js","path":"js/leancloud.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/local-search.js","path":"js/local-search.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/plugins.js","path":"js/plugins.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/xml/local-search.xml","path":"xml/local-search.xml","modified":0,"renderable":1}],"Cache":[{"_id":"source/_posts/2022-05-11-å‘½ä»¤è¡Œä¿®æ”¹ xcode pbxproj æ–‡ä»¶.md","hash":"d729d1d68d2b79a7b9bc294c80f14a44d50e7cf5","modified":1709725993562},{"_id":"source/.DS_Store","hash":"59c6ef1e5601c94d7113ecc8948d2806f59fc68b","modified":1709781049879},{"_id":"source/_posts/debug-xlog-osx.md","hash":"ccce7d9610cb16f9b1835494d4c929a0652c2972","modified":1709868389893},{"_id":"source/_posts/.DS_Store","hash":"0a3d229aac44f23609732d4b9c75c538519ef82e","modified":1709780593977},{"_id":"source/_posts/2022-12-21-rbenv.md","hash":"984f48ba85cabc312a88cad0523fc8b9708c1c6d","modified":1709725993562},{"_id":"source/_posts/2023-03-07-open-your-terminal-from-xcode.md","hash":"7e5face379b9e65e62f696a71f9d5f54b8e007be","modified":1709725993562},{"_id":"source/about/index.md","hash":"70b4f2598f7be89eddd5f4c6b6ad379b5a15d896","modified":1709726013622},{"_id":"source/_posts/Shell/2022-02-25-Shell å˜é‡.md","hash":"31d9bbf2857dfd5c6e90d22f5c217da6d52f6481","modified":1709725993562},{"_id":"source/_posts/Shell/2022-02-25-shell å‡½æ•°.md","hash":"bae1a65ffb688f98c226afa6904c59d9b14d9bf2","modified":1709725993563},{"_id":"source/_posts/Shell/2022-02-25-shell æ¡ä»¶è¯­å¥.md","hash":"6704063d5281a147be167e283e25ef3b59d816be","modified":1709725993563},{"_id":"source/_posts/Shell/2022-02-25-shell ç‰¹æ®Šå˜é‡.md","hash":"003695b65b7703b8a1be9f6f309849684b0eb0ed","modified":1709725993563},{"_id":"source/_posts/Shell/2022-02-25-shell å¾ªç¯è¯­å¥.md","hash":"53c2061667f76cce940e5095abf2ef87e93bb518","modified":1709725993563},{"_id":"source/_posts/Shell/2022-02-25-shell è¿ç®—ç¬¦.md","hash":"de3a1f02d709171377bac95815ecf3d676f46cae","modified":1709725993563},{"_id":"source/_posts/Shell/2022-03-09-shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°.md","hash":"d42936b0f4036657394f11c4c62da75cdaa606fc","modified":1709725993563},{"_id":"source/_posts/Shell/2022-02-25-Shell æ•°ç»„.md","hash":"ea649457b5083aff925f89b279cd8a0762675fe5","modified":1709725993563},{"_id":"source/_posts/Shell/2022-11-16-å‘½ä»¤è¡Œé‡å¯iPhone.md","hash":"68d894d99a3d1ceba81b4170096f4a6d0068b68a","modified":1709725993563},{"_id":"source/_posts/aac/2022-09-23-aac-adts.md","hash":"9e53f8abfd562e8f195904bc98138fe2c8566077","modified":1709725993564},{"_id":"source/_posts/Shell/2023-05-17-oh my zsh å±•ç¤ºè·¯å¾„.md","hash":"b47c570743be2a71b7f072d4dc4895a48e4890f1","modified":1709725993563},{"_id":"source/_posts/aac/2022-09-23-fdk-aac.md","hash":"1cc45d2a2dd532b548f93f8cc063fc67df0e2dac","modified":1709725993564},{"_id":"source/_posts/c++/2022-03-19-pragma once ç”¨æ³•æ€»ç»“.md","hash":"c4b581c5e58ac526c7b9cc9738c530d290d27090","modified":1709725993564},{"_id":"source/_posts/Shell/å¸¸ç”¨çš„shellè¯­å¥.md","hash":"3aa7d2753bb90d76e6968aac0205343b779fef86","modified":1709780760029},{"_id":"source/_posts/c++/2022-03-21-git hook clang-format.md","hash":"8ccd9cbf60302ac4751c84343cafdd859e908b97","modified":1709725993564},{"_id":"source/_posts/c++/2023-06-09-ä½åŸŸ é«˜ä½ä½.md","hash":"9a517bae6b3a44a40b4b12f820187b8ac5c1ff81","modified":1709725993564},{"_id":"source/_posts/c++/2022-10-29-Xcode é…ç½® clang-format æ ¼å¼åŒ– c++ ä»£ç .md","hash":"81271ff87f353b3fd2ed68fcb3668342363c7a18","modified":1709725993564},{"_id":"source/_posts/cmake/2022-03-13-cmake find_package.md","hash":"c73545be664e0add06a6ebd2cdc1b1467ae4f9d7","modified":1709725993564},{"_id":"source/_posts/cmake/2022-10-25 Clion Google sannitizers.md ","hash":"72f008c99508975fe3457cb8e021634b5b715812","modified":1709725993565},{"_id":"source/_posts/cmake/2022-10-23-cmake add_custom_command.md","hash":"b9fca4574bcf46fd678c68939e5a151a25d3948f","modified":1709725993564},{"_id":"source/_posts/cmake/2022-03-17-cmake å…¥é—¨.md","hash":"3ce6fb0884b7766e2770b9a4380bd37c63d61234","modified":1709725993564},{"_id":"source/_posts/cmake/2022-10-24-cmake Importing and Exporting Guide.md","hash":"4fe9e1280b0ce5e7c14215a84bc9c7a7ef4538f8","modified":1709725993564},{"_id":"source/_posts/hls/2022-10-12-MPEG-TS æ ¼å¼åˆ†æ.md","hash":"3090a4f1fde93aa15311310c4f34fdcb2f0b7a1d","modified":1709725993566},{"_id":"source/_posts/hls/2022-10-13-HLS-ä»‹ç».md","hash":"b18f4ac14db7525c7b5a953ed6e9a8bb6ab438c6","modified":1709725993567},{"_id":"source/_posts/ios/2023-03-14-ä½¿ç”¨Apple Configurator è·å– ipa æ–‡ä»¶.md","hash":"3fea58ad4f5068286ed7e416303754a21f08ff16","modified":1709725993567},{"_id":"source/_posts/ios/2022-11-26-ios keychain æ€»ç»“.md","hash":"f3ec9863c7591dea13efd7b06cc4856a49836f94","modified":1709725993567},{"_id":"source/_posts/ffmpeg/2022-03-09-å¦‚ä½•ä½¿ç”¨vscodeåœ¨macOSå¹³å°è°ƒè¯•ffmpeg.md","hash":"17f04ffad678bba21e0d1735416f9b03a45e4824","modified":1709725993565},{"_id":"source/_posts/ffmpeg/2022-03-09-ä½¿ç”¨Xcodeè°ƒè¯•ffmpeg.md","hash":"a56c1dcfe60017101ab7726debbc6d1ec7b3b57f","modified":1709725993565},{"_id":"source/_posts/ffmpeg/2022-03-11-ffmpeg example å­¦ä¹  2.md","hash":"f852558147139ce1a375ea3d39d73386131c873a","modified":1709725993565},{"_id":"source/_posts/ffmpeg/2022-03-10-ffmpeg example å­¦ä¹  1.md","hash":"2d5872891c5a0db3ea14dd5b9820fabd178dd17c","modified":1709725993565},{"_id":"source/_posts/ffmpeg/2022-03-12-ffmpeg example å­¦ä¹  3.md","hash":"7e1fb6ca21232be54ad8392150b155e52d6b3027","modified":1709725993565},{"_id":"source/_posts/ffmpeg/2022-03-13-ffmpeg example å­¦ä¹  4.md","hash":"ef3c745d4e7349975f55a05d4fa2ee2f78ccb9bd","modified":1709725993565},{"_id":"source/_posts/ffmpeg/2022-03-13-ffmpeg+nginx+rtmpæ­å»ºæ¨æµæœåŠ¡å™¨.md","hash":"46285cafb0a086a09581141c799a8788b21ef13d","modified":1709725993565},{"_id":"source/_posts/ffmpeg/2022-03-14-ffmpeg example å­¦ä¹  5.md","hash":"9c4a5fdef9cb98680f9560cd531c5e892e0d6f24","modified":1709725993565},{"_id":"source/_posts/ffmpeg/2022-03-20-ffplay read_thread åˆ†æ.md","hash":"03974761fa3a37f417260c5ba5dc4c2c0d424c5e","modified":1709725993566},{"_id":"source/_posts/ffmpeg/2022-03-15-ffplay-frame queue åˆ†æ.md","hash":"f61a9e1c7f7a8042bad2e0389391108b5536711d","modified":1709725993566},{"_id":"source/_posts/ffmpeg/2022-03-26-macä¸Šé€šè¿‡ doxygen + graphvizç”Ÿæˆå‡½æ•°è°ƒç”¨å›¾.md","hash":"6fd071539d7c17a0397b8126db9dbec6b35cf3fb","modified":1709725993566},{"_id":"source/_posts/ffmpeg/2022-03-27-ffplay ä»£ç ç»“æ„ä¸æ€»ç»“.md","hash":"7a4f17f822e358fe49ca136b53ae632c58783366","modified":1709725993566},{"_id":"source/_posts/ffmpeg/2022-03-14-ffplay-packet queue  åˆ†æ.md","hash":"b745b0c5b58885be63646dab1f2d8ba67f402674","modified":1709725993566},{"_id":"source/_posts/ffmpeg/2022-03-22-ffplay video_thread åˆ†æ.md","hash":"b1b84a01c1affb3cc5082b23be8ec48922ba7786","modified":1709725993566},{"_id":"source/_posts/lldb/2023-05-23-GDB Examining Memory.md","hash":"135a579e51c14bcd37640e0f18275c85daf4614c","modified":1709725993567},{"_id":"source/_posts/ffmpeg/2022-09-23-ffmpeg-å‘½ä»¤.md","hash":"882b34cc6e795fb6ed356f3fa3b52b9531fcff67","modified":1709725993566},{"_id":"source/_posts/webrtc/2023-05-09-webrtc-è°ƒè¯•.md","hash":"b6a75607f88f8c52858d229be1eda36891ac7cb5","modified":1709725993567},{"_id":"source/_posts/ffmpeg/2022-03-15-ffmpeg filters.md","hash":"92cef37691508bee7bd0befb8e919e626c9d8d92","modified":1709780852474},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_tag/tag.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1709726012845},{"_id":"node_modules/hexo-theme-fluid/package.json","hash":"c640b57695b7b6002399711f1a7708b0f6c05b84","modified":1709726012836},{"_id":"node_modules/hexo-theme-fluid/languages/en.yml","hash":"cb11b39f44ea069652c9647179606b6cecc98d50","modified":1709726012828},{"_id":"node_modules/hexo-theme-fluid/languages/eo.yml","hash":"a556251cc50a5680578c03f1efbf252b1f4ab860","modified":1709726012828},{"_id":"node_modules/hexo-theme-fluid/LICENSE","hash":"26f9356fd6e84b5a88df6d9014378f41b65ba209","modified":1709726012827},{"_id":"node_modules/hexo-theme-fluid/README.md","hash":"ff9b0e1fb9dba665af2f1e4a577f8cb9e840464b","modified":1709726012828},{"_id":"node_modules/hexo-theme-fluid/_config.yml","hash":"759d78d97cfe364a4bcf0b5cd2d3505967674276","modified":1709726012828},{"_id":"node_modules/hexo-theme-fluid/languages/de.yml","hash":"0e7d455d9e004ff15d8924b7a0c35cea25ee5b1d","modified":1709726012828},{"_id":"node_modules/hexo-theme-fluid/languages/es.yml","hash":"7112594259c88c04714be152af7fd377687dad40","modified":1709726012828},{"_id":"node_modules/hexo-theme-fluid/languages/ja.yml","hash":"3dd6d20f8d26585a7c154a8e59fe8d5d902f4c6a","modified":1709726012828},{"_id":"node_modules/hexo-theme-fluid/languages/zh-HK.yml","hash":"80ed400a7adaa92ea54fc7f5d534c9af795bed00","modified":1709726012829},{"_id":"node_modules/hexo-theme-fluid/languages/zh-TW.yml","hash":"596d031dff3826ae8e4ffc8931fff28977b73247","modified":1709726012829},{"_id":"node_modules/hexo-theme-fluid/languages/ru.yml","hash":"7dc78f22696649a4c68dc65a9b52d9a992fa82a0","modified":1709726012828},{"_id":"node_modules/hexo-theme-fluid/layout/404.ejs","hash":"b84d575c7b7f778b4cb64e89ad3d0aed4a896820","modified":1709726012829},{"_id":"node_modules/hexo-theme-fluid/languages/zh-CN.yml","hash":"2253e1bc61694b3bdc5e434ea2660d13d941b50e","modified":1709726012829},{"_id":"node_modules/hexo-theme-fluid/layout/category.ejs","hash":"f099161b738a16a32253f42085b5444f902018ed","modified":1709726012835},{"_id":"node_modules/hexo-theme-fluid/layout/categories.ejs","hash":"13859726c27b6c79b5876ec174176d0f9c1ee164","modified":1709726012835},{"_id":"node_modules/hexo-theme-fluid/layout/index.ejs","hash":"33c3317cdcee062789de2336dd8d0cc7f86d3650","modified":1709726012835},{"_id":"node_modules/hexo-theme-fluid/layout/links.ejs","hash":"1cac32ec4579aaf7b9fa39d317497331d4c5e1dd","modified":1709726012835},{"_id":"node_modules/hexo-theme-fluid/layout/layout.ejs","hash":"7e0023474128fbe4d68c467704c41f1712432415","modified":1709726012835},{"_id":"node_modules/hexo-theme-fluid/layout/page.ejs","hash":"ed5007a3feb8f14d3d2843271bfb298eb0c56219","modified":1709726012835},{"_id":"node_modules/hexo-theme-fluid/layout/tag.ejs","hash":"9d686364c4d16a1a9219471623af452035c5b966","modified":1709726012836},{"_id":"node_modules/hexo-theme-fluid/layout/archive.ejs","hash":"7c1f44005849791feae4abaa10fae4cb983d3277","modified":1709726012835},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/category-list.ejs","hash":"f8d2f1907450e61968e6d54443e9be8138196a77","modified":1709726012829},{"_id":"node_modules/hexo-theme-fluid/layout/post.ejs","hash":"9bf0d357a607a282f3b9cb04525a4df0cc2a8b76","modified":1709726012836},{"_id":"node_modules/hexo-theme-fluid/layout/tags.ejs","hash":"1d06af34b6cf1d8a20d2eb565e309326ceba309f","modified":1709726012836},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/category-chains.ejs","hash":"18309584aab83bc4deb20723ebad832149dd2e24","modified":1709726012829},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/archive-list.ejs","hash":"7520fbf91f762207c2ab06b2c293235cd5b23905","modified":1709726012829},{"_id":"node_modules/hexo-theme-fluid/layout/about.ejs","hash":"163bee643e6a38912d3ae70923c83c48d57222e7","modified":1709726012835},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/footer.ejs","hash":"10ccfb8eef4e16182183c9a3e175c90d5b6397d3","modified":1709726012832},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments.ejs","hash":"d707c47b2638c94e489bc43d4cfd098b7c58447f","modified":1709726012829},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/css.ejs","hash":"85f6e051550907681ab4ed2e268ac8f6e9ebf931","modified":1709726012831},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/head.ejs","hash":"7b7b1d098726e86687a15fe3d520d178577ffcae","modified":1709726012832},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/paginator.ejs","hash":"0f38a2c238169edcb63fc46c23bfc529ff3859b7","modified":1709726012832},{"_id":"node_modules/hexo-theme-fluid/scripts/filters/default-injects.js","hash":"b2013ae8e189cd07ebc8a2ff48a78e153345210f","modified":1709726012837},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/markdown-plugins.ejs","hash":"fc4bdf7de0cf1a66d0e5e4fba1b31d6f7ed49468","modified":1709726012832},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/scripts.ejs","hash":"da5810785105e5075861593c7ac22c7aa9665a72","modified":1709726012834},{"_id":"node_modules/hexo-theme-fluid/scripts/events/index.js","hash":"79de5a379b28cad759a49048351c7f6b8915bd7d","modified":1709726012836},{"_id":"node_modules/hexo-theme-fluid/scripts/filters/locals.js","hash":"58d0fec976f6b1d35e7ea03edc45414088acf05c","modified":1709726012837},{"_id":"node_modules/hexo-theme-fluid/scripts/generators/index-generator.js","hash":"9159fc22fa84a7b605dd15fe4104f01fe9c71147","modified":1709726012837},{"_id":"node_modules/hexo-theme-fluid/scripts/generators/pages.js","hash":"d3e75f53c59674d171309e50702954671f31f1a4","modified":1709726012838},{"_id":"node_modules/hexo-theme-fluid/scripts/filters/post-filter.js","hash":"82bb06686158ebe160a631c79f156cd4fde35656","modified":1709726012837},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/search.ejs","hash":"70e1c929e084ca8a2648cedabf29b372511ea2b8","modified":1709726012835},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/engine.js","hash":"d3a231d106795ce99cb0bc77eb65f9ae44515933","modified":1709726012838},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/export-config.js","hash":"8e67b522c47aa250860e3fe2c733f1f958a506c0","modified":1709726012838},{"_id":"node_modules/hexo-theme-fluid/scripts/generators/local-search.js","hash":"9ac5ddad06e9b0e6015ce531430018182a4bc0fa","modified":1709726012837},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/import.js","hash":"ca53e8dbf7d44cfd372cfa79ac60f35a7d5b0076","modified":1709726012838},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/injects.js","hash":"1ad2ae6b11bd8806ee7dd6eb7140d8b54a95d613","modified":1709726012838},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/page.js","hash":"4607607445233b3029ef20ed5e91de0da0a7f9c5","modified":1709726012838},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/date.js","hash":"9bda6382f61b40a20c24af466fe10c8366ebb74c","modified":1709726012838},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/header.ejs","hash":"0d5e397d30051e5fbabe7b47cfd1f1e6a5820af1","modified":1709726012832},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/scope.js","hash":"d41d9d658fcb54964b388598e996747aadb85b0f","modified":1709726012838},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/wordcount.js","hash":"4d48c424e47ff9a17a563167ea5f480890267adf","modified":1709726012839},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/checkbox.js","hash":"0857aa86db2a711ae5c77218a9e3fa686d0e87b1","modified":1709726012839},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/group-image.js","hash":"4aeebb797026f1df25646a5d69f7fde79b1bcd26","modified":1709726012839},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/utils.js","hash":"966689d7c5e4320008285395fbaa2751f6209be5","modified":1709726012839},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/url.js","hash":"2a6a8288176d0e0f6ec008056bf2745a86e8943e","modified":1709726012838},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/button.js","hash":"3eb43a8cdea0a64576ad6b31b4df6c2bf5698d4c","modified":1709726012839},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/fold.js","hash":"73e4fd12ce3e47981479391ed354b7d9d3279f70","modified":1709726012839},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/mermaid.js","hash":"75160561e1ef3603b6d2ad2938464ab1cb77fd38","modified":1709726012839},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/label.js","hash":"f05a6d32cca79535b22907dc03edb9d3fa2d8176","modified":1709726012839},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/compare-versions.js","hash":"dbbc928c914fc2bd242cd66aa0c45971aec13a5d","modified":1709726012840},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/crypto.js","hash":"ae4ad8a188ef5b3fa6818b01629fc962b3de8551","modified":1709726012840},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/object.js","hash":"33b57e4decdc5e75c518859f168c8ba80b2c665b","modified":1709726012840},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/url-join.js","hash":"718aab5e7b2059a06b093ca738de420d9afa44ba","modified":1709726012840},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/resolve.js","hash":"8c4a8b62aa8608f12f1e9046231dff04859dc3e9","modified":1709726012840},{"_id":"node_modules/hexo-theme-fluid/source/css/gitalk.css","hash":"a57b3cc8e04a0a4a27aefa07facf5b5e7bca0e76","modified":1709726012846},{"_id":"node_modules/hexo-theme-fluid/source/css/highlight-dark.styl","hash":"45695ef75c31a4aa57324dd408b7e2327a337018","modified":1709726012846},{"_id":"node_modules/hexo-theme-fluid/source/img/avatar.png","hash":"fe739a158cc128f70f780eb5fa96f388b81d478f","modified":1709726012846},{"_id":"node_modules/hexo-theme-fluid/source/css/main.styl","hash":"855ae5fe229c51afa57f7645f6997a27a705d7e4","modified":1709726012846},{"_id":"node_modules/hexo-theme-fluid/source/img/fluid.png","hash":"64b215db2cb3af98fe639e94537cb5209f959c78","modified":1709726012847},{"_id":"node_modules/hexo-theme-fluid/source/css/highlight.styl","hash":"a9efc52a646a9e585439c768557e3e3c9e3326dc","modified":1709726012846},{"_id":"node_modules/hexo-theme-fluid/source/img/loading.gif","hash":"2d2fc0f947940f98c21afafef39ecf226a2e8d55","modified":1709726012847},{"_id":"node_modules/hexo-theme-fluid/source/js/boot.js","hash":"38bd26c6b7acdafda86dda3560e6a3ca488d3c76","modified":1709726012848},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/note.js","hash":"e3b456a079e5dc0032473b516c865b20f83d2c26","modified":1709726012839},{"_id":"node_modules/hexo-theme-fluid/source/js/color-schema.js","hash":"c5939d14065d38c86e16d1642e154dde5a23e830","modified":1709726012848},{"_id":"node_modules/hexo-theme-fluid/source/js/events.js","hash":"5891534506b959a2f559f29e122baa3eb9159d93","modified":1709726012848},{"_id":"node_modules/hexo-theme-fluid/source/js/img-lazyload.js","hash":"cbdeca434ec4da51f488c821d51b4d23c73294af","modified":1709726012848},{"_id":"node_modules/hexo-theme-fluid/source/js/leancloud.js","hash":"eff77c7a5c399fcaefda48884980571e15243fc9","modified":1709726012848},{"_id":"node_modules/hexo-theme-fluid/source/js/local-search.js","hash":"b9945f76f8682f3ec32edfb285b26eb559f7b7e8","modified":1709726012848},{"_id":"node_modules/hexo-theme-fluid/source/js/plugins.js","hash":"c34916291e392a774ff3e85c55badb83e8661297","modified":1709726012848},{"_id":"node_modules/hexo-theme-fluid/source/xml/local-search.xml","hash":"8c96ba6a064705602ce28d096fd7dd9069630a55","modified":1709726012849},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/changyan.ejs","hash":"c9b2d68ed3d375f1953e7007307d2a3f75ed6249","modified":1709726012830},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/disqus.ejs","hash":"aab4a4d24c55231a37db308ae94414319cecdd9b","modified":1709726012830},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/cusdis.ejs","hash":"5f9dc012be27040bbe874d0c093c0d53958cc987","modified":1709726012830},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/discuss.ejs","hash":"98d065b58ce06b7d18bff3c974e96fa0f34ae03a","modified":1709726012830},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/giscus.ejs","hash":"95f8b866b158eff9352c381c243b332a155a5110","modified":1709726012831},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/livere.ejs","hash":"2264758fed57542a7389c7aa9f00f1aefa17eb87","modified":1709726012831},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/remark42.ejs","hash":"d4e9532feeb02aed61bd15eda536b5b631454dac","modified":1709726012831},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/twikoo.ejs","hash":"d84bcb5ccd78470a60c067fc914ac0ac67ac8777","modified":1709726012831},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/utterances.ejs","hash":"c7ccf7f28308334a6da6f5425b141a24b5eca0e2","modified":1709726012831},{"_id":"node_modules/hexo-theme-fluid/source/js/utils.js","hash":"b82e7c289a66dfd36064470fd41c0e96fc598b43","modified":1709726012848},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/gitalk.ejs","hash":"843bc141a4545eb20d1c92fb63c85d459b4271ec","modified":1709726012831},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/valine.ejs","hash":"19ba937553dddd317f827d682661a1066a7b1f30","modified":1709726012831},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/footer/beian.ejs","hash":"4fb9b5dd3f3e41a586d6af44e5069afe7c81fff2","modified":1709726012832},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/waline.ejs","hash":"12727da7cf3ac83443270f550be4d1c06135b52b","modified":1709726012831},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/footer/statistics.ejs","hash":"454d8dd4c39f9494ebeb03ca0746f5bc122af76a","modified":1709726012832},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/header/banner.ejs","hash":"e07757b59e7b89eea213d0e595cb5932f812fd32","modified":1709726012832},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/analytics.ejs","hash":"4f68c80bd1395e2f6d11e373116e54de11cb62e8","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/code-widget.ejs","hash":"3a505cba37942badf62a56bbb8b605b72af330aa","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/anchorjs.ejs","hash":"40181442d3a2b8734783a0ad7caf2d2522e3f2ab","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/encrypt.ejs","hash":"0fff24cf5bf99fbe5c56c292e2eac4a89bf29db4","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/fancybox.ejs","hash":"9d1ea2a46b8c8ad8c168594d578f40764818ef13","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/highlight.ejs","hash":"7529dd215b09d3557804333942377b9e20fa554e","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/math.ejs","hash":"dcbf9a381ee76f2f1f75fcbc22c50a502ec85023","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/moment.ejs","hash":"4ff3fb1b60ccc95a0af3bbdbd0757fedefc088b5","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/nprogress.ejs","hash":"4c2d39ce816b8a6dcd6b53113c8695f8bd650a23","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/source/img/police_beian.png","hash":"90efded6baa2dde599a9d6b1387973e8e64923ea","modified":1709726012847},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/mermaid.ejs","hash":"03ac02762f801970d1c4e73d6ec8d4c503780e50","modified":1709726012833},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/typed.ejs","hash":"f345374885cd6a334f09a11f59c443b5d577c06c","modified":1709726012834},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/header/navigation.ejs","hash":"37d750428772d7c71ba36ce0c2540780d90fadea","modified":1709726012832},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/compatible-configs.js","hash":"ef474d1fa5bbafc52619ced0f9dc7eaf2affb363","modified":1709726012836},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/copyright.ejs","hash":"529f3069742b3d338c769ba2d836e7f3c342a09d","modified":1709726012834},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/meta-bottom.ejs","hash":"375974ec017696e294dc12469fb0ae257800dc2d","modified":1709726012834},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/footnote.js","hash":"c19ac8050b82c3676b0332a56099ccfcc36d9d52","modified":1709726012836},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/sidebar-left.ejs","hash":"9992c99b3eb728ad195970e1b84d665f2c8691c4","modified":1709726012834},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/category-bar.ejs","hash":"8772bce97ed297e7a88523f4e939ed6436c22f87","modified":1709726012834},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/highlight.js","hash":"a5fe1deccb73b5f578797dbb11038efc15f63ce8","modified":1709726012836},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/lazyload.js","hash":"9ba0d4bc224e22af8a5a48d6ff13e5a0fcfee2a4","modified":1709726012837},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/sidebar-right.ejs","hash":"d5fcc9b60e02f869a29a8c17a16a6028ecc1e6d8","modified":1709726012834},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/toc.ejs","hash":"635a89060fbf72eeda066fc4bd0a97462f069417","modified":1709726012834},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/merge-configs.js","hash":"7c944c43b2ece5dd84859bd9d1fe955d13427387","modified":1709726012837},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/hello.js","hash":"bd8376e1cf7892dc2daa58f2f443574be559fdbf","modified":1709726012836},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/injects.js","hash":"5ae4b07204683e54b5a1b74e931702bbce2ac23e","modified":1709726012837},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/meta-top.ejs","hash":"ce6e9f578f4faa45840abddf8f46af3f4b69c177","modified":1709726012834},{"_id":"node_modules/hexo-theme-fluid/source/css/_functions/base.styl","hash":"2e46f3f4e2c9fe34c1ff1c598738fc7349ae8188","modified":1709726012840},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_about/about.styl","hash":"97fe42516ea531fdad771489b68aa8b2a7f6ae46","modified":1709726012841},{"_id":"node_modules/hexo-theme-fluid/source/css/_mixins/base.styl","hash":"542e306ee9494e8a78e44d6d7d409605d94caeb3","modified":1709726012841},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_archive/archive.styl","hash":"c475e6681546d30350eaed11f23081ecae80c375","modified":1709726012841},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/pages.styl","hash":"b8e887bc7fb3b765a1f8ec9448eff8603a41984f","modified":1709726012845},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/keyframes.styl","hash":"94065ea50f5bef7566d184f2422f6ac20866ba22","modified":1709726012843},{"_id":"node_modules/hexo-theme-fluid/source/css/_variables/base.styl","hash":"4ed5f0ae105ef4c7dd92eaf652ceda176c38e502","modified":1709726012845},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/print.styl","hash":"166afbc596ea4b552bad7290ec372d25ec34db7b","modified":1709726012843},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_category/category-chain.styl","hash":"0cdf7ef50dfd0669d3b257821384ff31cd81b7c9","modified":1709726012844},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_links/links.styl","hash":"5c7f2044e3f1da05a3229537c06bd879836f8d6e","modified":1709726012844},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_category/category-bar.styl","hash":"cc6df43fef6bb3efecbfdd8b9e467424a1dea581","modified":1709726012843},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/base.styl","hash":"643284c567665f96915f0b64e59934dda315f74d","modified":1709726012843},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/inline.styl","hash":"411a3fa3f924a87e00ff04d18b5c83283b049a4d","modified":1709726012843},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/color-schema.styl","hash":"85492ef64d7e5f70f0f7e46d570bbc911e686d7e","modified":1709726012843},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_category/category-list.styl","hash":"7edfe1b571ecca7d08f5f4dbcf76f4ffdcfbf0b5","modified":1709726012844},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/comment.styl","hash":"780f3788e7357bcd3f3262d781cb91bb53976a93","modified":1709726012844},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/highlight.styl","hash":"4df764d298fe556e501db4afc2b05686fe6ebcfb","modified":1709726012845},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_index/index.styl","hash":"25fb6fa4c783b847c632584c49a7e1593cdb2f5d","modified":1709726012844},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/markdown.styl","hash":"1e3d3a82721e7c10bcfcecec6d81cf2979039452","modified":1709726012845},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/post-tag.styl","hash":"c96d36aa8fe20f0c3c1a29ee2473cd8064b10f73","modified":1709726012845},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/post-page.styl","hash":"cd432a6411ccac7df47e6a300fb1a872cfc763e7","modified":1709726012845},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_tag/tags.styl","hash":"65bfc01c76abc927fa1a23bf2422892b0d566c3f","modified":1709726012845},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/banner.styl","hash":"7a0bd629bc234fc75e3cc8e3715ffada92f09e73","modified":1709726012841},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/anchorjs.styl","hash":"e0cebda4a6f499aff75e71417d88caa7ceb13b94","modified":1709726012841},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/code-widget.styl","hash":"b66ab013f0f37d724a149b85b3c7432afcf460ad","modified":1709726012841},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/board.styl","hash":"4397037fc3f0033dbe546c33cd9dbdabd8cb1632","modified":1709726012841},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/copyright.styl","hash":"26f71a9cd60d96bb0cb5bbdf58150b8e524d9707","modified":1709726012842},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/footer.styl","hash":"2caaca71dd1ff63d583099ed817677dd267b457e","modified":1709726012842},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/footnote.styl","hash":"ae9289cc89649af2042907f8a003303b987f3404","modified":1709726012842},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/header.styl","hash":"c4459248c66ea1326feed021179b847ae91d465f","modified":1709726012842},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/modal.styl","hash":"adf6c1e5c8e1fb41c77ce6e2258001df61245aa2","modified":1709726012842},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/ngrogress.styl","hash":"5d225357b4a58d46118e6616377168336ed44cb2","modified":1709726012842},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/pagination.styl","hash":"8bb1b68e5f3552cb48c2ffa31edbc53646a8fb4c","modified":1709726012842},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/noscript.styl","hash":"0cf2f2bb44f456150d428016675d5876a9d2e2aa","modified":1709726012842},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/qrcode.styl","hash":"78704a94c0436097abfb0e0a57abeb3429c749b7","modified":1709726012842},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/scroll-btn.styl","hash":"f0e429a27fa8a7658fcbddbb4d4dbe4afa12499a","modified":1709726012843},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/search.styl","hash":"10f7e91a91e681fb9fe46f9df7707b9ef78707c8","modified":1709726012843},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/toc.styl","hash":"9e7452aa2372153f25d7a4675c9d36d281a65d24","modified":1709726012843},{"_id":"node_modules/hexo-theme-fluid/source/img/default.png","hash":"167a12978d80371cf578c8a2e45c24a2eb25b6fb","modified":1709726012847}],"Category":[],"Data":[],"Page":[{"title":"about","layout":"about","_content":"\nä¸€äº›å¼€å‘ä¸­çš„ç¬”è®°ï¼","source":"about/index.md","raw":"---\ntitle: about\nlayout: about\n---\n\nä¸€äº›å¼€å‘ä¸­çš„ç¬”è®°ï¼","date":"2024-03-06T11:53:33.622Z","updated":"2024-03-06T11:53:33.622Z","path":"about/index.html","comments":1,"_id":"clti3glke000057wh231ne59e","content":"<p>ä¸€äº›å¼€å‘ä¸­çš„ç¬”è®°ï¼</p>\n","excerpt":"","more":"<p>ä¸€äº›å¼€å‘ä¸­çš„ç¬”è®°ï¼</p>\n"}],"Post":[{"layout":"post","title":"ç”¨ rbenv æ¥å®‰è£…ruby","date":"2022-12-20T16:00:00.000Z","_content":"\nå‚è€ƒï¼š [rbenv](https://github.com/rbenv/rbenv)\n\n```\n# Install Homebrew\n/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"\n\n# Install rbenv and ruby-build\nbrew install rbenv\n\n# Set up rbenv integration with your shell\nrbenv init\n\n# Check your installation\ncurl -fsSL https://github.com/rbenv/rbenv-installer/raw/main/bin/rbenv-doctor | bash\n```\n\né…ç½® .zshrc\n\n```\n# rbenv\neval \"$(rbenv init - zsh)\"\n```\n\nRestart your terminal to apply your changes. Next, you can install the Ruby version you want. Letâ€™s install the latest stable version:\n\n```\nrbenv install 3.0.0\nrbenv global 3.0.0\nruby -v\nruby 3.0.0p0 (2020-12-25 revision 95aff21468)\n```","source":"_posts/2022-12-21-rbenv.md","raw":"---\n\nlayout: post\ntitle: \"ç”¨ rbenv æ¥å®‰è£…ruby\"\ndate: 2022-12-21 \ntag: ruby\n\n---\n\nå‚è€ƒï¼š [rbenv](https://github.com/rbenv/rbenv)\n\n```\n# Install Homebrew\n/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"\n\n# Install rbenv and ruby-build\nbrew install rbenv\n\n# Set up rbenv integration with your shell\nrbenv init\n\n# Check your installation\ncurl -fsSL https://github.com/rbenv/rbenv-installer/raw/main/bin/rbenv-doctor | bash\n```\n\né…ç½® .zshrc\n\n```\n# rbenv\neval \"$(rbenv init - zsh)\"\n```\n\nRestart your terminal to apply your changes. Next, you can install the Ruby version you want. Letâ€™s install the latest stable version:\n\n```\nrbenv install 3.0.0\nrbenv global 3.0.0\nruby -v\nruby 3.0.0p0 (2020-12-25 revision 95aff21468)\n```","slug":"2022-12-21-rbenv","published":1,"updated":"2024-03-06T11:53:13.562Z","comments":1,"photos":[],"_id":"clti3glkf000157wh84l07l5p","content":"<p>å‚è€ƒï¼š <a href=\"https://github.com/rbenv/rbenv\">rbenv</a></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\"># Install Homebrew</span><br><span class=\"hljs-regexp\">/bin/</span>bash -c <span class=\"hljs-string\">&quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot;</span><br><br><span class=\"hljs-comment\"># Install rbenv and ruby-build</span><br>brew install rbenv<br><br><span class=\"hljs-comment\"># Set up rbenv integration with your shell</span><br>rbenv init<br><br><span class=\"hljs-comment\"># Check your installation</span><br>curl -fsSL https:<span class=\"hljs-regexp\">//gi</span>thub.com<span class=\"hljs-regexp\">/rbenv/</span>rbenv-installer<span class=\"hljs-regexp\">/raw/m</span>ain<span class=\"hljs-regexp\">/bin/</span>rbenv-doctor | bash<br></code></pre></td></tr></table></figure>\n\n<p>é…ç½® .zshrc</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># rbenv</span><br><span class=\"hljs-built_in\">eval</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(rbenv init - zsh)</span>&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>Restart your terminal to apply your changes. Next, you can install the Ruby version you want. Letâ€™s install the latest stable version:</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">rbenv</span> install <span class=\"hljs-number\">3</span>.<span class=\"hljs-number\">0</span>.<span class=\"hljs-number\">0</span><br><span class=\"hljs-attribute\">rbenv</span> global <span class=\"hljs-number\">3</span>.<span class=\"hljs-number\">0</span>.<span class=\"hljs-number\">0</span><br><span class=\"hljs-attribute\">ruby</span> -v<br><span class=\"hljs-attribute\">ruby</span> <span class=\"hljs-number\">3</span>.<span class=\"hljs-number\">0</span>.<span class=\"hljs-number\">0</span>p0 (<span class=\"hljs-number\">2020</span>-<span class=\"hljs-number\">12</span>-<span class=\"hljs-number\">25</span> revision <span class=\"hljs-number\">95</span>aff21468)<br></code></pre></td></tr></table></figure>","excerpt":"","more":"<p>å‚è€ƒï¼š <a href=\"https://github.com/rbenv/rbenv\">rbenv</a></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\"># Install Homebrew</span><br><span class=\"hljs-regexp\">/bin/</span>bash -c <span class=\"hljs-string\">&quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot;</span><br><br><span class=\"hljs-comment\"># Install rbenv and ruby-build</span><br>brew install rbenv<br><br><span class=\"hljs-comment\"># Set up rbenv integration with your shell</span><br>rbenv init<br><br><span class=\"hljs-comment\"># Check your installation</span><br>curl -fsSL https:<span class=\"hljs-regexp\">//gi</span>thub.com<span class=\"hljs-regexp\">/rbenv/</span>rbenv-installer<span class=\"hljs-regexp\">/raw/m</span>ain<span class=\"hljs-regexp\">/bin/</span>rbenv-doctor | bash<br></code></pre></td></tr></table></figure>\n\n<p>é…ç½® .zshrc</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># rbenv</span><br><span class=\"hljs-built_in\">eval</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(rbenv init - zsh)</span>&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>Restart your terminal to apply your changes. Next, you can install the Ruby version you want. Letâ€™s install the latest stable version:</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">rbenv</span> install <span class=\"hljs-number\">3</span>.<span class=\"hljs-number\">0</span>.<span class=\"hljs-number\">0</span><br><span class=\"hljs-attribute\">rbenv</span> global <span class=\"hljs-number\">3</span>.<span class=\"hljs-number\">0</span>.<span class=\"hljs-number\">0</span><br><span class=\"hljs-attribute\">ruby</span> -v<br><span class=\"hljs-attribute\">ruby</span> <span class=\"hljs-number\">3</span>.<span class=\"hljs-number\">0</span>.<span class=\"hljs-number\">0</span>p0 (<span class=\"hljs-number\">2020</span>-<span class=\"hljs-number\">12</span>-<span class=\"hljs-number\">25</span> revision <span class=\"hljs-number\">95</span>aff21468)<br></code></pre></td></tr></table></figure>"},{"layout":"post","title":"é€šè¿‡è„šæœ¬ä¿®æ”¹xcode pbxprojæ–‡ä»¶","date":"2022-05-10T16:00:00.000Z","_content":"\n\n\n## åˆ†æ xcode pbxproj æ–‡ä»¶æ ¼å¼\n\n åˆ›å»ºä¸€ä¸ªæ–°çš„iOSå·¥ç¨‹`demo`, è¿›å…¥å·¥ç¨‹ç›®å½•, æ‰¾åˆ°`project.pbxproj`ã€‚\n\n```\nâœ  demo git:(main) âœ— ls\ndemo           demo.xcodeproj demoTests      demoUITests\nâœ  demo git:(main) âœ— cd demo.xcodeproj\nâœ  demo.xcodeproj git:(main) âœ— ls\nproject.pbxproj     project.xcworkspace xcuserdata\n```\n\né€šè¿‡codeæ‰“å¼€çœ‹çœ‹æ–‡ä»¶å†…å®¹ã€‚\n\n> The Xcode project file is an old-style plist (Next style) based on braces to delimit the hierarchy. The file begins with an explicit encoding information, usually the UTF-8 one.\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521761658021652176165259.png)\n\n`project.pbxproj`æ–‡ä»¶æ ¼å¼æ˜¯æ—§å¼çš„plistï¼Œé€šè¿‡`plutil`å°†project.pbxprojè½¬æ¢ä¸ºjson\n\n```\nplutil -convert json project.pbxproj\n```\n\né€šè¿‡å¯è§†åŒ–å·¥å…·åˆ†æjsonå†…å®¹\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521715227351652171521885.png)\n\nrootObject å¯¹åº”çš„valueæ˜¯24ä½16è¿›åˆ¶çš„UUIDã€‚\n\nå±•å¼€objects æ‰¾åˆ°`FEF5F49A2829212600E85303`å¯¹åº”çš„object\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521733421961652173342151.png)\n\nbuildConfigurationList ä¿å­˜äº†é…ç½®ä¿¡æ¯ï¼Œå¯¹åº”çš„UUIDä¸º FEF5F49D2829212600E85303\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521737007771652173700399.png)\n\nbuildConfigurationsæ˜¯ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬åˆ†æç¬¬ä¸€ä¸ªã€‚æ‰¾åˆ°FEF5F4CF2829212700E85303å¯¹åº”çš„object\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521738897811652173889220.png)\n\nå±•å¼€buildSettingsçœ‹ä¸€çœ‹\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521739817831652173981353.png)\n\nåœ¨xcode-build settingsä¸­å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„è®¾ç½®ã€‚\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521742047871652174204307.png)\n\nè¯´æ˜ï¼š\n\n1. objectsæ•°ç»„åŒ…å«äº†æ‰€æœ‰object å¯¹è±¡çš„ä¿¡æ¯ï¼Œ åŒ…å«rootObjectï¼Œ rootObject çš„isa æ˜¯`PBXProject`\n\n2. é€šè¿‡rootObjectï¼Œæ ¹æ®UUIDåœ¨objectsæ•°ç»„æ‰¾åˆ°å¯¹åº”çš„object, å¯ä»¥æ„å»ºä¸€æ£µæ ‘ï¼Œè¿™æ£µæ ‘æè¿°äº†xcodeå·¥ç¨‹çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚\n\n## é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•\n\n1. é€šè¿‡`plutil`å°†pbxprojè½¬æ¢ä¸ºjsonæˆ–xmlï¼Œ ç¼–è¾‘è½¬æ¢åçš„jsonæˆ–è€…xmlã€‚è™½ç„¶æ–‡ä»¶å†…å®¹ä¼šè¢«è½¬æ¢ä¸ºjsonæˆ–è€…xmlï¼Œ ä½†æ˜¯xcode ä¾ç„¶å¯ä»¥åŠ è½½ä¿®æ”¹åçš„pbxprojæ–‡ä»¶ã€‚ é€šè¿‡xcode ä¿®æ”¹ä»»ä½•é…ç½®ä¿¡æ¯åï¼Œpbxprojä¼šè¢«é‡æ–°æ”¹å†™ä¸ºæ—§å¼çš„plistæ–‡ä»¶æ ¼å¼ã€‚\n\n2. é€šè¿‡ç°æˆçš„ä¸€äº›å·¥å…·\n   \n   - [GitHub - CocoaPods/Xcodeproj: Create and modify Xcode projects from Ruby.](https://github.com/CocoaPods/Xcodeproj)\n   \n   - [GitHub - tuist/XcodeProj: ğŸ“ Read, update and write your Xcode projects](https://github.com/tuist/XcodeProj)\n   \n   - [GitHub - kronenthaler/mod-pbxproj: A python module to manipulate XCode projects](https://github.com/kronenthaler/mod-pbxproj)\n   \n   - [GitHub - alunny/node-xcode: tools and utilities for working with xcode/ios projects](https://github.com/alunny/node-xcode)\n   \n   - \n\n### [Xcodeproj](https://github.com/CocoaPods/Xcodeproj) ä½¿ç”¨ä»‹ç»\n\n1. å®‰è£…\n   \n   ```\n   gem install xcodeproj\n   ```\n\n2. å†™rubyè„šæœ¬ï¼Œä¸ä¼šçš„å¯ä»¥å»å­¦ä¸€ä¸‹rubyï¼Œ å…¥é—¨å¾ˆå¾ˆç®€å•\n   \n   ```\n   require 'xcodeproj'\n   project_path = '/your_path/your_project.xcodeproj'\n   project = Xcodeproj::Project.open(project_path)\n   project.targets.each do |target|\n     target.build_configurations.each do |config|\n       config.build_settings['MY_CUSTOM_FLAG'] ||= 'TRUE'\n     end\n   end\n   project.save\n   ```\n\nå‚è€ƒï¼š\n\n[Let's Talk About project.pbxproj](http://yulingtianxia.com/blog/2016/09/28/Let-s-Talk-About-project-pbxproj/)\n\n[Xcode Project File Format](http://www.monobjc.net/xcode-project-file-format.html)\n","source":"_posts/2022-05-11-å‘½ä»¤è¡Œä¿®æ”¹ xcode pbxproj æ–‡ä»¶.md","raw":"---\n\nlayout: post\ntitle: \"é€šè¿‡è„šæœ¬ä¿®æ”¹xcode pbxprojæ–‡ä»¶\"\ndate: 2022-05-11 \ntag: Shell\n\n---\n\n\n\n## åˆ†æ xcode pbxproj æ–‡ä»¶æ ¼å¼\n\n åˆ›å»ºä¸€ä¸ªæ–°çš„iOSå·¥ç¨‹`demo`, è¿›å…¥å·¥ç¨‹ç›®å½•, æ‰¾åˆ°`project.pbxproj`ã€‚\n\n```\nâœ  demo git:(main) âœ— ls\ndemo           demo.xcodeproj demoTests      demoUITests\nâœ  demo git:(main) âœ— cd demo.xcodeproj\nâœ  demo.xcodeproj git:(main) âœ— ls\nproject.pbxproj     project.xcworkspace xcuserdata\n```\n\né€šè¿‡codeæ‰“å¼€çœ‹çœ‹æ–‡ä»¶å†…å®¹ã€‚\n\n> The Xcode project file is an old-style plist (Next style) based on braces to delimit the hierarchy. The file begins with an explicit encoding information, usually the UTF-8 one.\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521761658021652176165259.png)\n\n`project.pbxproj`æ–‡ä»¶æ ¼å¼æ˜¯æ—§å¼çš„plistï¼Œé€šè¿‡`plutil`å°†project.pbxprojè½¬æ¢ä¸ºjson\n\n```\nplutil -convert json project.pbxproj\n```\n\né€šè¿‡å¯è§†åŒ–å·¥å…·åˆ†æjsonå†…å®¹\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521715227351652171521885.png)\n\nrootObject å¯¹åº”çš„valueæ˜¯24ä½16è¿›åˆ¶çš„UUIDã€‚\n\nå±•å¼€objects æ‰¾åˆ°`FEF5F49A2829212600E85303`å¯¹åº”çš„object\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521733421961652173342151.png)\n\nbuildConfigurationList ä¿å­˜äº†é…ç½®ä¿¡æ¯ï¼Œå¯¹åº”çš„UUIDä¸º FEF5F49D2829212600E85303\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521737007771652173700399.png)\n\nbuildConfigurationsæ˜¯ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬åˆ†æç¬¬ä¸€ä¸ªã€‚æ‰¾åˆ°FEF5F4CF2829212700E85303å¯¹åº”çš„object\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521738897811652173889220.png)\n\nå±•å¼€buildSettingsçœ‹ä¸€çœ‹\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521739817831652173981353.png)\n\nåœ¨xcode-build settingsä¸­å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„è®¾ç½®ã€‚\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521742047871652174204307.png)\n\nè¯´æ˜ï¼š\n\n1. objectsæ•°ç»„åŒ…å«äº†æ‰€æœ‰object å¯¹è±¡çš„ä¿¡æ¯ï¼Œ åŒ…å«rootObjectï¼Œ rootObject çš„isa æ˜¯`PBXProject`\n\n2. é€šè¿‡rootObjectï¼Œæ ¹æ®UUIDåœ¨objectsæ•°ç»„æ‰¾åˆ°å¯¹åº”çš„object, å¯ä»¥æ„å»ºä¸€æ£µæ ‘ï¼Œè¿™æ£µæ ‘æè¿°äº†xcodeå·¥ç¨‹çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚\n\n## é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•\n\n1. é€šè¿‡`plutil`å°†pbxprojè½¬æ¢ä¸ºjsonæˆ–xmlï¼Œ ç¼–è¾‘è½¬æ¢åçš„jsonæˆ–è€…xmlã€‚è™½ç„¶æ–‡ä»¶å†…å®¹ä¼šè¢«è½¬æ¢ä¸ºjsonæˆ–è€…xmlï¼Œ ä½†æ˜¯xcode ä¾ç„¶å¯ä»¥åŠ è½½ä¿®æ”¹åçš„pbxprojæ–‡ä»¶ã€‚ é€šè¿‡xcode ä¿®æ”¹ä»»ä½•é…ç½®ä¿¡æ¯åï¼Œpbxprojä¼šè¢«é‡æ–°æ”¹å†™ä¸ºæ—§å¼çš„plistæ–‡ä»¶æ ¼å¼ã€‚\n\n2. é€šè¿‡ç°æˆçš„ä¸€äº›å·¥å…·\n   \n   - [GitHub - CocoaPods/Xcodeproj: Create and modify Xcode projects from Ruby.](https://github.com/CocoaPods/Xcodeproj)\n   \n   - [GitHub - tuist/XcodeProj: ğŸ“ Read, update and write your Xcode projects](https://github.com/tuist/XcodeProj)\n   \n   - [GitHub - kronenthaler/mod-pbxproj: A python module to manipulate XCode projects](https://github.com/kronenthaler/mod-pbxproj)\n   \n   - [GitHub - alunny/node-xcode: tools and utilities for working with xcode/ios projects](https://github.com/alunny/node-xcode)\n   \n   - \n\n### [Xcodeproj](https://github.com/CocoaPods/Xcodeproj) ä½¿ç”¨ä»‹ç»\n\n1. å®‰è£…\n   \n   ```\n   gem install xcodeproj\n   ```\n\n2. å†™rubyè„šæœ¬ï¼Œä¸ä¼šçš„å¯ä»¥å»å­¦ä¸€ä¸‹rubyï¼Œ å…¥é—¨å¾ˆå¾ˆç®€å•\n   \n   ```\n   require 'xcodeproj'\n   project_path = '/your_path/your_project.xcodeproj'\n   project = Xcodeproj::Project.open(project_path)\n   project.targets.each do |target|\n     target.build_configurations.each do |config|\n       config.build_settings['MY_CUSTOM_FLAG'] ||= 'TRUE'\n     end\n   end\n   project.save\n   ```\n\nå‚è€ƒï¼š\n\n[Let's Talk About project.pbxproj](http://yulingtianxia.com/blog/2016/09/28/Let-s-Talk-About-project-pbxproj/)\n\n[Xcode Project File Format](http://www.monobjc.net/xcode-project-file-format.html)\n","slug":"2022-05-11-å‘½ä»¤è¡Œä¿®æ”¹ xcode pbxproj æ–‡ä»¶","published":1,"updated":"2024-03-06T11:53:13.562Z","comments":1,"photos":[],"_id":"clti3glkg000257whf9lqhhge","content":"<h2 id=\"åˆ†æ-xcode-pbxproj-æ–‡ä»¶æ ¼å¼\"><a href=\"#åˆ†æ-xcode-pbxproj-æ–‡ä»¶æ ¼å¼\" class=\"headerlink\" title=\"åˆ†æ xcode pbxproj æ–‡ä»¶æ ¼å¼\"></a>åˆ†æ xcode pbxproj æ–‡ä»¶æ ¼å¼</h2><p> åˆ›å»ºä¸€ä¸ªæ–°çš„iOSå·¥ç¨‹<code>demo</code>, è¿›å…¥å·¥ç¨‹ç›®å½•, æ‰¾åˆ°<code>project.pbxproj</code>ã€‚</p>\n<figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs maxima\">âœ  <span class=\"hljs-built_in\">demo</span> git:(main) âœ— ls<br><span class=\"hljs-built_in\">demo</span>           <span class=\"hljs-built_in\">demo</span>.xcodeproj demoTests      demoUITests<br>âœ  <span class=\"hljs-built_in\">demo</span> git:(main) âœ— cd <span class=\"hljs-built_in\">demo</span>.xcodeproj<br>âœ  <span class=\"hljs-built_in\">demo</span>.xcodeproj git:(main) âœ— ls<br>project.pbxproj     project.xcworkspace xcuserdata<br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡codeæ‰“å¼€çœ‹çœ‹æ–‡ä»¶å†…å®¹ã€‚</p>\n<blockquote>\n<p>The Xcode project file is an old-style plist (Next style) based on braces to delimit the hierarchy. The file begins with an explicit encoding information, usually the UTF-8 one.</p>\n</blockquote>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521761658021652176165259.png\"></p>\n<p><code>project.pbxproj</code>æ–‡ä»¶æ ¼å¼æ˜¯æ—§å¼çš„plistï¼Œé€šè¿‡<code>plutil</code>å°†project.pbxprojè½¬æ¢ä¸ºjson</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cmake\">plutil -convert json <span class=\"hljs-keyword\">project</span>.pbxproj<br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡å¯è§†åŒ–å·¥å…·åˆ†æjsonå†…å®¹</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521715227351652171521885.png\"></p>\n<p>rootObject å¯¹åº”çš„valueæ˜¯24ä½16è¿›åˆ¶çš„UUIDã€‚</p>\n<p>å±•å¼€objects æ‰¾åˆ°<code>FEF5F49A2829212600E85303</code>å¯¹åº”çš„object</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521733421961652173342151.png\"></p>\n<p>buildConfigurationList ä¿å­˜äº†é…ç½®ä¿¡æ¯ï¼Œå¯¹åº”çš„UUIDä¸º FEF5F49D2829212600E85303</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521737007771652173700399.png\"></p>\n<p>buildConfigurationsæ˜¯ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬åˆ†æç¬¬ä¸€ä¸ªã€‚æ‰¾åˆ°FEF5F4CF2829212700E85303å¯¹åº”çš„object</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521738897811652173889220.png\"></p>\n<p>å±•å¼€buildSettingsçœ‹ä¸€çœ‹</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521739817831652173981353.png\"></p>\n<p>åœ¨xcode-build settingsä¸­å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„è®¾ç½®ã€‚</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521742047871652174204307.png\"></p>\n<p>è¯´æ˜ï¼š</p>\n<ol>\n<li><p>objectsæ•°ç»„åŒ…å«äº†æ‰€æœ‰object å¯¹è±¡çš„ä¿¡æ¯ï¼Œ åŒ…å«rootObjectï¼Œ rootObject çš„isa æ˜¯<code>PBXProject</code></p>\n</li>\n<li><p>é€šè¿‡rootObjectï¼Œæ ¹æ®UUIDåœ¨objectsæ•°ç»„æ‰¾åˆ°å¯¹åº”çš„object, å¯ä»¥æ„å»ºä¸€æ£µæ ‘ï¼Œè¿™æ£µæ ‘æè¿°äº†xcodeå·¥ç¨‹çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚</p>\n</li>\n</ol>\n<h2 id=\"é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•\"><a href=\"#é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•\" class=\"headerlink\" title=\"é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•\"></a>é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•</h2><ol>\n<li><p>é€šè¿‡<code>plutil</code>å°†pbxprojè½¬æ¢ä¸ºjsonæˆ–xmlï¼Œ ç¼–è¾‘è½¬æ¢åçš„jsonæˆ–è€…xmlã€‚è™½ç„¶æ–‡ä»¶å†…å®¹ä¼šè¢«è½¬æ¢ä¸ºjsonæˆ–è€…xmlï¼Œ ä½†æ˜¯xcode ä¾ç„¶å¯ä»¥åŠ è½½ä¿®æ”¹åçš„pbxprojæ–‡ä»¶ã€‚ é€šè¿‡xcode ä¿®æ”¹ä»»ä½•é…ç½®ä¿¡æ¯åï¼Œpbxprojä¼šè¢«é‡æ–°æ”¹å†™ä¸ºæ—§å¼çš„plistæ–‡ä»¶æ ¼å¼ã€‚</p>\n</li>\n<li><p>é€šè¿‡ç°æˆçš„ä¸€äº›å·¥å…·</p>\n<ul>\n<li><p><a href=\"https://github.com/CocoaPods/Xcodeproj\">GitHub - CocoaPods&#x2F;Xcodeproj: Create and modify Xcode projects from Ruby.</a></p>\n</li>\n<li><p><a href=\"https://github.com/tuist/XcodeProj\">GitHub - tuist&#x2F;XcodeProj: ğŸ“ Read, update and write your Xcode projects</a></p>\n</li>\n<li><p><a href=\"https://github.com/kronenthaler/mod-pbxproj\">GitHub - kronenthaler&#x2F;mod-pbxproj: A python module to manipulate XCode projects</a></p>\n</li>\n<li><p><a href=\"https://github.com/alunny/node-xcode\">GitHub - alunny&#x2F;node-xcode: tools and utilities for working with xcode&#x2F;ios projects</a></p>\n</li>\n<li></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"Xcodeproj-ä½¿ç”¨ä»‹ç»\"><a href=\"#Xcodeproj-ä½¿ç”¨ä»‹ç»\" class=\"headerlink\" title=\"Xcodeproj ä½¿ç”¨ä»‹ç»\"></a><a href=\"https://github.com/CocoaPods/Xcodeproj\">Xcodeproj</a> ä½¿ç”¨ä»‹ç»</h3><ol>\n<li><p>å®‰è£…</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cmake\">gem <span class=\"hljs-keyword\">install</span> xcodeproj<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>å†™rubyè„šæœ¬ï¼Œä¸ä¼šçš„å¯ä»¥å»å­¦ä¸€ä¸‹rubyï¼Œ å…¥é—¨å¾ˆå¾ˆç®€å•</p>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gradle\">require <span class=\"hljs-string\">&#x27;xcodeproj&#x27;</span><br>project_path = <span class=\"hljs-string\">&#x27;/your_path/your_project.xcodeproj&#x27;</span><br><span class=\"hljs-keyword\">project</span> = Xcodeproj::<span class=\"hljs-keyword\">Project</span>.open(project_path)<br><span class=\"hljs-keyword\">project</span>.targets.<span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">do</span> |target|<br>  target.build_configurations.<span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">do</span> |config|<br>    config.build_settings[<span class=\"hljs-string\">&#x27;MY_CUSTOM_FLAG&#x27;</span>] ||= <span class=\"hljs-string\">&#x27;TRUE&#x27;</span><br>  end<br>end<br><span class=\"hljs-keyword\">project</span>.save<br></code></pre></td></tr></table></figure></li>\n</ol>\n<p>å‚è€ƒï¼š</p>\n<p><a href=\"http://yulingtianxia.com/blog/2016/09/28/Let-s-Talk-About-project-pbxproj/\">Letâ€™s Talk About project.pbxproj</a></p>\n<p><a href=\"http://www.monobjc.net/xcode-project-file-format.html\">Xcode Project File Format</a></p>\n","excerpt":"","more":"<h2 id=\"åˆ†æ-xcode-pbxproj-æ–‡ä»¶æ ¼å¼\"><a href=\"#åˆ†æ-xcode-pbxproj-æ–‡ä»¶æ ¼å¼\" class=\"headerlink\" title=\"åˆ†æ xcode pbxproj æ–‡ä»¶æ ¼å¼\"></a>åˆ†æ xcode pbxproj æ–‡ä»¶æ ¼å¼</h2><p> åˆ›å»ºä¸€ä¸ªæ–°çš„iOSå·¥ç¨‹<code>demo</code>, è¿›å…¥å·¥ç¨‹ç›®å½•, æ‰¾åˆ°<code>project.pbxproj</code>ã€‚</p>\n<figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs maxima\">âœ  <span class=\"hljs-built_in\">demo</span> git:(main) âœ— ls<br><span class=\"hljs-built_in\">demo</span>           <span class=\"hljs-built_in\">demo</span>.xcodeproj demoTests      demoUITests<br>âœ  <span class=\"hljs-built_in\">demo</span> git:(main) âœ— cd <span class=\"hljs-built_in\">demo</span>.xcodeproj<br>âœ  <span class=\"hljs-built_in\">demo</span>.xcodeproj git:(main) âœ— ls<br>project.pbxproj     project.xcworkspace xcuserdata<br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡codeæ‰“å¼€çœ‹çœ‹æ–‡ä»¶å†…å®¹ã€‚</p>\n<blockquote>\n<p>The Xcode project file is an old-style plist (Next style) based on braces to delimit the hierarchy. The file begins with an explicit encoding information, usually the UTF-8 one.</p>\n</blockquote>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521761658021652176165259.png\"></p>\n<p><code>project.pbxproj</code>æ–‡ä»¶æ ¼å¼æ˜¯æ—§å¼çš„plistï¼Œé€šè¿‡<code>plutil</code>å°†project.pbxprojè½¬æ¢ä¸ºjson</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cmake\">plutil -convert json <span class=\"hljs-keyword\">project</span>.pbxproj<br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡å¯è§†åŒ–å·¥å…·åˆ†æjsonå†…å®¹</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521715227351652171521885.png\"></p>\n<p>rootObject å¯¹åº”çš„valueæ˜¯24ä½16è¿›åˆ¶çš„UUIDã€‚</p>\n<p>å±•å¼€objects æ‰¾åˆ°<code>FEF5F49A2829212600E85303</code>å¯¹åº”çš„object</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521733421961652173342151.png\"></p>\n<p>buildConfigurationList ä¿å­˜äº†é…ç½®ä¿¡æ¯ï¼Œå¯¹åº”çš„UUIDä¸º FEF5F49D2829212600E85303</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521737007771652173700399.png\"></p>\n<p>buildConfigurationsæ˜¯ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬åˆ†æç¬¬ä¸€ä¸ªã€‚æ‰¾åˆ°FEF5F4CF2829212700E85303å¯¹åº”çš„object</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521738897811652173889220.png\"></p>\n<p>å±•å¼€buildSettingsçœ‹ä¸€çœ‹</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521739817831652173981353.png\"></p>\n<p>åœ¨xcode-build settingsä¸­å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„è®¾ç½®ã€‚</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16521742047871652174204307.png\"></p>\n<p>è¯´æ˜ï¼š</p>\n<ol>\n<li><p>objectsæ•°ç»„åŒ…å«äº†æ‰€æœ‰object å¯¹è±¡çš„ä¿¡æ¯ï¼Œ åŒ…å«rootObjectï¼Œ rootObject çš„isa æ˜¯<code>PBXProject</code></p>\n</li>\n<li><p>é€šè¿‡rootObjectï¼Œæ ¹æ®UUIDåœ¨objectsæ•°ç»„æ‰¾åˆ°å¯¹åº”çš„object, å¯ä»¥æ„å»ºä¸€æ£µæ ‘ï¼Œè¿™æ£µæ ‘æè¿°äº†xcodeå·¥ç¨‹çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚</p>\n</li>\n</ol>\n<h2 id=\"é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•\"><a href=\"#é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•\" class=\"headerlink\" title=\"é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•\"></a>é€šè¿‡è„šæœ¬ä¿®æ”¹pbxprojæ–‡ä»¶çš„æ–¹æ³•</h2><ol>\n<li><p>é€šè¿‡<code>plutil</code>å°†pbxprojè½¬æ¢ä¸ºjsonæˆ–xmlï¼Œ ç¼–è¾‘è½¬æ¢åçš„jsonæˆ–è€…xmlã€‚è™½ç„¶æ–‡ä»¶å†…å®¹ä¼šè¢«è½¬æ¢ä¸ºjsonæˆ–è€…xmlï¼Œ ä½†æ˜¯xcode ä¾ç„¶å¯ä»¥åŠ è½½ä¿®æ”¹åçš„pbxprojæ–‡ä»¶ã€‚ é€šè¿‡xcode ä¿®æ”¹ä»»ä½•é…ç½®ä¿¡æ¯åï¼Œpbxprojä¼šè¢«é‡æ–°æ”¹å†™ä¸ºæ—§å¼çš„plistæ–‡ä»¶æ ¼å¼ã€‚</p>\n</li>\n<li><p>é€šè¿‡ç°æˆçš„ä¸€äº›å·¥å…·</p>\n<ul>\n<li><p><a href=\"https://github.com/CocoaPods/Xcodeproj\">GitHub - CocoaPods&#x2F;Xcodeproj: Create and modify Xcode projects from Ruby.</a></p>\n</li>\n<li><p><a href=\"https://github.com/tuist/XcodeProj\">GitHub - tuist&#x2F;XcodeProj: ğŸ“ Read, update and write your Xcode projects</a></p>\n</li>\n<li><p><a href=\"https://github.com/kronenthaler/mod-pbxproj\">GitHub - kronenthaler&#x2F;mod-pbxproj: A python module to manipulate XCode projects</a></p>\n</li>\n<li><p><a href=\"https://github.com/alunny/node-xcode\">GitHub - alunny&#x2F;node-xcode: tools and utilities for working with xcode&#x2F;ios projects</a></p>\n</li>\n<li></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"Xcodeproj-ä½¿ç”¨ä»‹ç»\"><a href=\"#Xcodeproj-ä½¿ç”¨ä»‹ç»\" class=\"headerlink\" title=\"Xcodeproj ä½¿ç”¨ä»‹ç»\"></a><a href=\"https://github.com/CocoaPods/Xcodeproj\">Xcodeproj</a> ä½¿ç”¨ä»‹ç»</h3><ol>\n<li><p>å®‰è£…</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cmake\">gem <span class=\"hljs-keyword\">install</span> xcodeproj<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>å†™rubyè„šæœ¬ï¼Œä¸ä¼šçš„å¯ä»¥å»å­¦ä¸€ä¸‹rubyï¼Œ å…¥é—¨å¾ˆå¾ˆç®€å•</p>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gradle\">require <span class=\"hljs-string\">&#x27;xcodeproj&#x27;</span><br>project_path = <span class=\"hljs-string\">&#x27;/your_path/your_project.xcodeproj&#x27;</span><br><span class=\"hljs-keyword\">project</span> = Xcodeproj::<span class=\"hljs-keyword\">Project</span>.open(project_path)<br><span class=\"hljs-keyword\">project</span>.targets.<span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">do</span> |target|<br>  target.build_configurations.<span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">do</span> |config|<br>    config.build_settings[<span class=\"hljs-string\">&#x27;MY_CUSTOM_FLAG&#x27;</span>] ||= <span class=\"hljs-string\">&#x27;TRUE&#x27;</span><br>  end<br>end<br><span class=\"hljs-keyword\">project</span>.save<br></code></pre></td></tr></table></figure></li>\n</ol>\n<p>å‚è€ƒï¼š</p>\n<p><a href=\"http://yulingtianxia.com/blog/2016/09/28/Let-s-Talk-About-project-pbxproj/\">Letâ€™s Talk About project.pbxproj</a></p>\n<p><a href=\"http://www.monobjc.net/xcode-project-file-format.html\">Xcode Project File Format</a></p>\n"},{"layout":"post","title":"Xcode æºç è°ƒè¯•å¾®ä¿¡ xlog","date":"2024-03-07T16:00:00.000Z","_content":"\n# Tencent/masr xlog macOS æºç è°ƒè¯•\n\n## get include folder \n\n```\ncd mars\npython build_osx.py\nEnter menu:\n1. Clean && build.\n2. Gen OSX Project.\n3. Build xlog.\n4. Exit\n```\n\né€‰æ‹©1ï¼Œç”Ÿæˆ `mars.framework`, æˆ‘ä»¬ä¸»è¦æ˜¯ä½¿ç”¨å¤´æ–‡ä»¶ç›®å½•ã€‚\n\n## gen osx project\n```\ncd mars\npython build_osx.py\nEnter menu:\n1. Clean && build.\n2. Gen OSX Project.\n3. Build xlog.\n4. Exit\n# input 2\n```\n\næ‰§è¡Œç»“æœ\n\n```\n-- ==============config mars====================\n-- Configuring done (6.6s)\n-- Generating done (0.0s)\n-- Build files have been written to: /Users/yxibng/Github/mars/mars/cmake_build/OSX\n```\n\nåœ¨ mars/cmake_build/OSX ç›®å½•ä¸­æ‰¾åˆ° mars.xcodeproj\n\n```\ncd mars/cmake_build/OSX \n\nls\nCMakeCache.txt       baseevent            comm                 sdt\nCMakeFiles           boost                include              stn\nCMakeScripts         boot                 install_manifest.txt xlog\nDarwin.out           build                lib                  zstd\napp                  cmake_install.cmake  mars.xcodeproj\n```\n\n## å°† mars.xcodeproj ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹\n\né€šè¿‡ cmake ç”Ÿæˆçš„ project å®šä¹‰äº†ç”Ÿæˆ mars.framework çš„å‡ ä¸ªç›¸å…³targetï¼Œ å°† mars.xcodeproj è®¾ç½®ä¸ºå­å·¥ç¨‹ï¼Œ\nä¸»å·¥ç¨‹ä¾èµ– mars.xcodeproj å®šä¹‰çš„targetï¼Œå³å¯å®ç° xlog çš„æºç è°ƒè¯•ã€‚\n\n1. create new macOS project: xlog-test, selcte language: Objective-C\n2. mars.xcodeproj æ·»åŠ åˆ° xlog-test å·¥ç¨‹ä¸­\n3. å°† mars.framework/Headers æ‹·è´åˆ° xlog-test æ ¹ç›®å½•\n4. xlog-test é…ç½® header search pathsï¼Œ å€¼ä¸º `$(SRCROOT)/Headers`\n![17098674388361709867437953.png](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098674388361709867437953.png)\n5. xlog-test é…ç½® linked libraries\n![17098675228351709867522443.png](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098675228351709867522443.png)\n6. æ·»åŠ è¾…åŠ©ä»£ç ï¼Œä» MacDemo ä¸­è·å–ï¼Œ æ‹·è´åˆ° xlog-test å·¥ç¨‹ä¸­\n![17098675948351709867593931.png](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098675948351709867593931.png)\n7. LogHelper ä¸­æ·»åŠ  setup æ–¹æ³•ï¼Œç”¨äºåˆå§‹åŒ– xlog\n```\n+ (void)setup {\n    NSArray *paths = NSSearchPathForDirectoriesInDomains(NSLibraryDirectory, NSUserDomainMask, YES);\n    NSString *libraryDirectory = [paths firstObject];\n    \n    // init xlog\n#if DEBUG\n    xlogger_SetLevel(kLevelDebug);\n    mars::xlog::appender_set_console_log(true);\n#else\n    xlogger_SetLevel(kLevelInfo);\n    appender_set_console_log(false);\n#endif\n    mars::xlog::XLogConfig config;\n    config.mode_ = mars::xlog::kAppenderAsync;\n    config.logdir_ = [[libraryDirectory stringByAppendingString:@\"/log/\"] UTF8String];\n    config.nameprefix_ = \"Test\";\n    config.pub_key_ = \"\";\n    config.compress_mode_ = mars::xlog::kZlib;\n    config.compress_level_ = 0;\n    config.cachedir_ = \"\";\n    config.cache_days_ = 0;\n    appender_open(config);\n}\n```\n8. AppDelegateåˆå§‹åŒ–è°ƒç”¨\n```\n- (void)applicationDidFinishLaunching:(NSNotification *)aNotification {\n    // Insert code here to initialize your application\n    [LogHelper setup];\n}\n```\n9. ç”¨`LogUtil.h`ä¸­å®å®šä¹‰æ‰“log\n```\nLOG_ERROR(kModuleViewController, @\"this is a test log!\");\n```\n10. æ„‰å¿«åœ°æ–­ç‚¹ï¼Œè°ƒè¯•å§\n","source":"_posts/debug-xlog-osx.md","raw":"\n---\n\nlayout: post\ntitle: \"Xcode æºç è°ƒè¯•å¾®ä¿¡ xlog\"\ndate: 2024-03-08\n\n---\n\n# Tencent/masr xlog macOS æºç è°ƒè¯•\n\n## get include folder \n\n```\ncd mars\npython build_osx.py\nEnter menu:\n1. Clean && build.\n2. Gen OSX Project.\n3. Build xlog.\n4. Exit\n```\n\né€‰æ‹©1ï¼Œç”Ÿæˆ `mars.framework`, æˆ‘ä»¬ä¸»è¦æ˜¯ä½¿ç”¨å¤´æ–‡ä»¶ç›®å½•ã€‚\n\n## gen osx project\n```\ncd mars\npython build_osx.py\nEnter menu:\n1. Clean && build.\n2. Gen OSX Project.\n3. Build xlog.\n4. Exit\n# input 2\n```\n\næ‰§è¡Œç»“æœ\n\n```\n-- ==============config mars====================\n-- Configuring done (6.6s)\n-- Generating done (0.0s)\n-- Build files have been written to: /Users/yxibng/Github/mars/mars/cmake_build/OSX\n```\n\nåœ¨ mars/cmake_build/OSX ç›®å½•ä¸­æ‰¾åˆ° mars.xcodeproj\n\n```\ncd mars/cmake_build/OSX \n\nls\nCMakeCache.txt       baseevent            comm                 sdt\nCMakeFiles           boost                include              stn\nCMakeScripts         boot                 install_manifest.txt xlog\nDarwin.out           build                lib                  zstd\napp                  cmake_install.cmake  mars.xcodeproj\n```\n\n## å°† mars.xcodeproj ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹\n\né€šè¿‡ cmake ç”Ÿæˆçš„ project å®šä¹‰äº†ç”Ÿæˆ mars.framework çš„å‡ ä¸ªç›¸å…³targetï¼Œ å°† mars.xcodeproj è®¾ç½®ä¸ºå­å·¥ç¨‹ï¼Œ\nä¸»å·¥ç¨‹ä¾èµ– mars.xcodeproj å®šä¹‰çš„targetï¼Œå³å¯å®ç° xlog çš„æºç è°ƒè¯•ã€‚\n\n1. create new macOS project: xlog-test, selcte language: Objective-C\n2. mars.xcodeproj æ·»åŠ åˆ° xlog-test å·¥ç¨‹ä¸­\n3. å°† mars.framework/Headers æ‹·è´åˆ° xlog-test æ ¹ç›®å½•\n4. xlog-test é…ç½® header search pathsï¼Œ å€¼ä¸º `$(SRCROOT)/Headers`\n![17098674388361709867437953.png](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098674388361709867437953.png)\n5. xlog-test é…ç½® linked libraries\n![17098675228351709867522443.png](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098675228351709867522443.png)\n6. æ·»åŠ è¾…åŠ©ä»£ç ï¼Œä» MacDemo ä¸­è·å–ï¼Œ æ‹·è´åˆ° xlog-test å·¥ç¨‹ä¸­\n![17098675948351709867593931.png](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098675948351709867593931.png)\n7. LogHelper ä¸­æ·»åŠ  setup æ–¹æ³•ï¼Œç”¨äºåˆå§‹åŒ– xlog\n```\n+ (void)setup {\n    NSArray *paths = NSSearchPathForDirectoriesInDomains(NSLibraryDirectory, NSUserDomainMask, YES);\n    NSString *libraryDirectory = [paths firstObject];\n    \n    // init xlog\n#if DEBUG\n    xlogger_SetLevel(kLevelDebug);\n    mars::xlog::appender_set_console_log(true);\n#else\n    xlogger_SetLevel(kLevelInfo);\n    appender_set_console_log(false);\n#endif\n    mars::xlog::XLogConfig config;\n    config.mode_ = mars::xlog::kAppenderAsync;\n    config.logdir_ = [[libraryDirectory stringByAppendingString:@\"/log/\"] UTF8String];\n    config.nameprefix_ = \"Test\";\n    config.pub_key_ = \"\";\n    config.compress_mode_ = mars::xlog::kZlib;\n    config.compress_level_ = 0;\n    config.cachedir_ = \"\";\n    config.cache_days_ = 0;\n    appender_open(config);\n}\n```\n8. AppDelegateåˆå§‹åŒ–è°ƒç”¨\n```\n- (void)applicationDidFinishLaunching:(NSNotification *)aNotification {\n    // Insert code here to initialize your application\n    [LogHelper setup];\n}\n```\n9. ç”¨`LogUtil.h`ä¸­å®å®šä¹‰æ‰“log\n```\nLOG_ERROR(kModuleViewController, @\"this is a test log!\");\n```\n10. æ„‰å¿«åœ°æ–­ç‚¹ï¼Œè°ƒè¯•å§\n","slug":"debug-xlog-osx","published":1,"updated":"2024-03-08T03:26:29.893Z","_id":"clti3glkh000457wh0myk2mj8","comments":1,"photos":[],"content":"<h1 id=\"Tencent-masr-xlog-macOS-æºç è°ƒè¯•\"><a href=\"#Tencent-masr-xlog-macOS-æºç è°ƒè¯•\" class=\"headerlink\" title=\"Tencent&#x2F;masr xlog macOS æºç è°ƒè¯•\"></a>Tencent&#x2F;masr xlog macOS æºç è°ƒè¯•</h1><h2 id=\"get-include-folder\"><a href=\"#get-include-folder\" class=\"headerlink\" title=\"get include folder\"></a>get include folder</h2><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">cd</span> mars<br><span class=\"hljs-keyword\">python</span> build_osx.<span class=\"hljs-keyword\">py</span><br>Enter <span class=\"hljs-keyword\">menu</span>:<br><span class=\"hljs-number\">1</span>. Clean &amp;&amp; build.<br><span class=\"hljs-number\">2</span>. Gen OSX Project.<br><span class=\"hljs-number\">3</span>. Build xlog.<br><span class=\"hljs-number\">4</span>. Exit<br></code></pre></td></tr></table></figure>\n\n<p>é€‰æ‹©1ï¼Œç”Ÿæˆ <code>mars.framework</code>, æˆ‘ä»¬ä¸»è¦æ˜¯ä½¿ç”¨å¤´æ–‡ä»¶ç›®å½•ã€‚</p>\n<h2 id=\"gen-osx-project\"><a href=\"#gen-osx-project\" class=\"headerlink\" title=\"gen osx project\"></a>gen osx project</h2><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">cd</span> mars<br><span class=\"hljs-keyword\">python</span> build_osx.<span class=\"hljs-keyword\">py</span><br>Enter <span class=\"hljs-keyword\">menu</span>:<br><span class=\"hljs-number\">1</span>. Clean &amp;&amp; build.<br><span class=\"hljs-number\">2</span>. Gen OSX Project.<br><span class=\"hljs-number\">3</span>. Build xlog.<br><span class=\"hljs-number\">4</span>. Exit<br># <span class=\"hljs-built_in\">input</span> <span class=\"hljs-number\">2</span><br></code></pre></td></tr></table></figure>\n\n<p>æ‰§è¡Œç»“æœ</p>\n<figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ada\"><span class=\"hljs-comment\">-- ==============config mars====================</span><br><span class=\"hljs-comment\">-- Configuring done (6.6s)</span><br><span class=\"hljs-comment\">-- Generating done (0.0s)</span><br><span class=\"hljs-comment\">-- Build files have been written to: /Users/yxibng/Github/mars/mars/cmake_build/OSX</span><br></code></pre></td></tr></table></figure>\n\n<p>åœ¨ mars&#x2F;cmake_build&#x2F;OSX ç›®å½•ä¸­æ‰¾åˆ° mars.xcodeproj</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\"><span class=\"hljs-keyword\">cd</span> mars/cmake_build/OSX <br><br><span class=\"hljs-keyword\">ls</span><br>CMakeCache.txt       baseevent            comm                 sdt<br>CMakeFiles           boost                <span class=\"hljs-keyword\">include</span>              stn<br>CMakeScripts         <span class=\"hljs-keyword\">boot</span>                 install_manifest.txt xlog<br>Darwin.<span class=\"hljs-keyword\">out</span>           build                lib                  zstd<br><span class=\"hljs-keyword\">app</span>                  cmake_install.cmake  mars.xcodeproj<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å°†-mars-xcodeproj-ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹\"><a href=\"#å°†-mars-xcodeproj-ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹\" class=\"headerlink\" title=\"å°† mars.xcodeproj ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹\"></a>å°† mars.xcodeproj ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹</h2><p>é€šè¿‡ cmake ç”Ÿæˆçš„ project å®šä¹‰äº†ç”Ÿæˆ mars.framework çš„å‡ ä¸ªç›¸å…³targetï¼Œ å°† mars.xcodeproj è®¾ç½®ä¸ºå­å·¥ç¨‹ï¼Œ<br>ä¸»å·¥ç¨‹ä¾èµ– mars.xcodeproj å®šä¹‰çš„targetï¼Œå³å¯å®ç° xlog çš„æºç è°ƒè¯•ã€‚</p>\n<ol>\n<li>create new macOS project: xlog-test, selcte language: Objective-C</li>\n<li>mars.xcodeproj æ·»åŠ åˆ° xlog-test å·¥ç¨‹ä¸­</li>\n<li>å°† mars.framework&#x2F;Headers æ‹·è´åˆ° xlog-test æ ¹ç›®å½•</li>\n<li>xlog-test é…ç½® header search pathsï¼Œ å€¼ä¸º <code>$(SRCROOT)/Headers</code><br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098674388361709867437953.png\" alt=\"17098674388361709867437953.png\"></li>\n<li>xlog-test é…ç½® linked libraries<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098675228351709867522443.png\" alt=\"17098675228351709867522443.png\"></li>\n<li>æ·»åŠ è¾…åŠ©ä»£ç ï¼Œä» MacDemo ä¸­è·å–ï¼Œ æ‹·è´åˆ° xlog-test å·¥ç¨‹ä¸­<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098675948351709867593931.png\" alt=\"17098675948351709867593931.png\"></li>\n<li>LogHelper ä¸­æ·»åŠ  setup æ–¹æ³•ï¼Œç”¨äºåˆå§‹åŒ– xlog<figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arduino\">+ (<span class=\"hljs-type\">void</span>)setup &#123;<br>    NSArray *paths = <span class=\"hljs-built_in\">NSSearchPathForDirectoriesInDomains</span>(NSLibraryDirectory, NSUserDomainMask, YES);<br>    NSString *libraryDirectory = [paths firstObject];<br>    <br>    <span class=\"hljs-comment\">// init xlog</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">if</span> DEBUG</span><br>    <span class=\"hljs-built_in\">xlogger_SetLevel</span>(kLevelDebug);<br>    mars::xlog::<span class=\"hljs-built_in\">appender_set_console_log</span>(<span class=\"hljs-literal\">true</span>);<br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">else</span></span><br>    <span class=\"hljs-built_in\">xlogger_SetLevel</span>(kLevelInfo);<br>    <span class=\"hljs-built_in\">appender_set_console_log</span>(<span class=\"hljs-literal\">false</span>);<br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">endif</span></span><br>    mars::xlog::XLogConfig config;<br>    config.mode_ = mars::xlog::kAppenderAsync;<br>    config.logdir_ = [[libraryDirectory stringByAppendingString:@<span class=\"hljs-string\">&quot;/log/&quot;</span>] UTF8String];<br>    config.nameprefix_ = <span class=\"hljs-string\">&quot;Test&quot;</span>;<br>    config.pub_key_ = <span class=\"hljs-string\">&quot;&quot;</span>;<br>    config.compress_mode_ = mars::xlog::kZlib;<br>    config.compress_level_ = <span class=\"hljs-number\">0</span>;<br>    config.cachedir_ = <span class=\"hljs-string\">&quot;&quot;</span>;<br>    config.cache_days_ = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-built_in\">appender_open</span>(config);<br>&#125;<br></code></pre></td></tr></table></figure></li>\n<li>AppDelegateåˆå§‹åŒ–è°ƒç”¨<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">- (<span class=\"hljs-built_in\">void</span>)applicationDidFinishLaunching:(NSNotification *)aNotification &#123;<br>    <span class=\"hljs-comment\">// Insert code here to initialize your application</span><br><span class=\"hljs-string\">    [LogHelper setup]</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>\n<li>ç”¨<code>LogUtil.h</code>ä¸­å®å®šä¹‰æ‰“log<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\">LOG_ERROR<span class=\"hljs-comment\">(kModuleViewController, @&quot;this is a test log!&quot;)</span>;<br></code></pre></td></tr></table></figure></li>\n<li>æ„‰å¿«åœ°æ–­ç‚¹ï¼Œè°ƒè¯•å§</li>\n</ol>\n","excerpt":"","more":"<h1 id=\"Tencent-masr-xlog-macOS-æºç è°ƒè¯•\"><a href=\"#Tencent-masr-xlog-macOS-æºç è°ƒè¯•\" class=\"headerlink\" title=\"Tencent&#x2F;masr xlog macOS æºç è°ƒè¯•\"></a>Tencent&#x2F;masr xlog macOS æºç è°ƒè¯•</h1><h2 id=\"get-include-folder\"><a href=\"#get-include-folder\" class=\"headerlink\" title=\"get include folder\"></a>get include folder</h2><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">cd</span> mars<br><span class=\"hljs-keyword\">python</span> build_osx.<span class=\"hljs-keyword\">py</span><br>Enter <span class=\"hljs-keyword\">menu</span>:<br><span class=\"hljs-number\">1</span>. Clean &amp;&amp; build.<br><span class=\"hljs-number\">2</span>. Gen OSX Project.<br><span class=\"hljs-number\">3</span>. Build xlog.<br><span class=\"hljs-number\">4</span>. Exit<br></code></pre></td></tr></table></figure>\n\n<p>é€‰æ‹©1ï¼Œç”Ÿæˆ <code>mars.framework</code>, æˆ‘ä»¬ä¸»è¦æ˜¯ä½¿ç”¨å¤´æ–‡ä»¶ç›®å½•ã€‚</p>\n<h2 id=\"gen-osx-project\"><a href=\"#gen-osx-project\" class=\"headerlink\" title=\"gen osx project\"></a>gen osx project</h2><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">cd</span> mars<br><span class=\"hljs-keyword\">python</span> build_osx.<span class=\"hljs-keyword\">py</span><br>Enter <span class=\"hljs-keyword\">menu</span>:<br><span class=\"hljs-number\">1</span>. Clean &amp;&amp; build.<br><span class=\"hljs-number\">2</span>. Gen OSX Project.<br><span class=\"hljs-number\">3</span>. Build xlog.<br><span class=\"hljs-number\">4</span>. Exit<br># <span class=\"hljs-built_in\">input</span> <span class=\"hljs-number\">2</span><br></code></pre></td></tr></table></figure>\n\n<p>æ‰§è¡Œç»“æœ</p>\n<figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ada\"><span class=\"hljs-comment\">-- ==============config mars====================</span><br><span class=\"hljs-comment\">-- Configuring done (6.6s)</span><br><span class=\"hljs-comment\">-- Generating done (0.0s)</span><br><span class=\"hljs-comment\">-- Build files have been written to: /Users/yxibng/Github/mars/mars/cmake_build/OSX</span><br></code></pre></td></tr></table></figure>\n\n<p>åœ¨ mars&#x2F;cmake_build&#x2F;OSX ç›®å½•ä¸­æ‰¾åˆ° mars.xcodeproj</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\"><span class=\"hljs-keyword\">cd</span> mars/cmake_build/OSX <br><br><span class=\"hljs-keyword\">ls</span><br>CMakeCache.txt       baseevent            comm                 sdt<br>CMakeFiles           boost                <span class=\"hljs-keyword\">include</span>              stn<br>CMakeScripts         <span class=\"hljs-keyword\">boot</span>                 install_manifest.txt xlog<br>Darwin.<span class=\"hljs-keyword\">out</span>           build                lib                  zstd<br><span class=\"hljs-keyword\">app</span>                  cmake_install.cmake  mars.xcodeproj<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å°†-mars-xcodeproj-ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹\"><a href=\"#å°†-mars-xcodeproj-ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹\" class=\"headerlink\" title=\"å°† mars.xcodeproj ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹\"></a>å°† mars.xcodeproj ä½œä¸ºå­å·¥ç¨‹ï¼Œæ·»åŠ ä¸ºä¾èµ–é¡¹</h2><p>é€šè¿‡ cmake ç”Ÿæˆçš„ project å®šä¹‰äº†ç”Ÿæˆ mars.framework çš„å‡ ä¸ªç›¸å…³targetï¼Œ å°† mars.xcodeproj è®¾ç½®ä¸ºå­å·¥ç¨‹ï¼Œ<br>ä¸»å·¥ç¨‹ä¾èµ– mars.xcodeproj å®šä¹‰çš„targetï¼Œå³å¯å®ç° xlog çš„æºç è°ƒè¯•ã€‚</p>\n<ol>\n<li>create new macOS project: xlog-test, selcte language: Objective-C</li>\n<li>mars.xcodeproj æ·»åŠ åˆ° xlog-test å·¥ç¨‹ä¸­</li>\n<li>å°† mars.framework&#x2F;Headers æ‹·è´åˆ° xlog-test æ ¹ç›®å½•</li>\n<li>xlog-test é…ç½® header search pathsï¼Œ å€¼ä¸º <code>$(SRCROOT)/Headers</code><br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098674388361709867437953.png\" alt=\"17098674388361709867437953.png\"></li>\n<li>xlog-test é…ç½® linked libraries<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098675228351709867522443.png\" alt=\"17098675228351709867522443.png\"></li>\n<li>æ·»åŠ è¾…åŠ©ä»£ç ï¼Œä» MacDemo ä¸­è·å–ï¼Œ æ‹·è´åˆ° xlog-test å·¥ç¨‹ä¸­<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/17098675948351709867593931.png\" alt=\"17098675948351709867593931.png\"></li>\n<li>LogHelper ä¸­æ·»åŠ  setup æ–¹æ³•ï¼Œç”¨äºåˆå§‹åŒ– xlog<figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arduino\">+ (<span class=\"hljs-type\">void</span>)setup &#123;<br>    NSArray *paths = <span class=\"hljs-built_in\">NSSearchPathForDirectoriesInDomains</span>(NSLibraryDirectory, NSUserDomainMask, YES);<br>    NSString *libraryDirectory = [paths firstObject];<br>    <br>    <span class=\"hljs-comment\">// init xlog</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">if</span> DEBUG</span><br>    <span class=\"hljs-built_in\">xlogger_SetLevel</span>(kLevelDebug);<br>    mars::xlog::<span class=\"hljs-built_in\">appender_set_console_log</span>(<span class=\"hljs-literal\">true</span>);<br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">else</span></span><br>    <span class=\"hljs-built_in\">xlogger_SetLevel</span>(kLevelInfo);<br>    <span class=\"hljs-built_in\">appender_set_console_log</span>(<span class=\"hljs-literal\">false</span>);<br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">endif</span></span><br>    mars::xlog::XLogConfig config;<br>    config.mode_ = mars::xlog::kAppenderAsync;<br>    config.logdir_ = [[libraryDirectory stringByAppendingString:@<span class=\"hljs-string\">&quot;/log/&quot;</span>] UTF8String];<br>    config.nameprefix_ = <span class=\"hljs-string\">&quot;Test&quot;</span>;<br>    config.pub_key_ = <span class=\"hljs-string\">&quot;&quot;</span>;<br>    config.compress_mode_ = mars::xlog::kZlib;<br>    config.compress_level_ = <span class=\"hljs-number\">0</span>;<br>    config.cachedir_ = <span class=\"hljs-string\">&quot;&quot;</span>;<br>    config.cache_days_ = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-built_in\">appender_open</span>(config);<br>&#125;<br></code></pre></td></tr></table></figure></li>\n<li>AppDelegateåˆå§‹åŒ–è°ƒç”¨<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">- (<span class=\"hljs-built_in\">void</span>)applicationDidFinishLaunching:(NSNotification *)aNotification &#123;<br>    <span class=\"hljs-comment\">// Insert code here to initialize your application</span><br><span class=\"hljs-string\">    [LogHelper setup]</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>\n<li>ç”¨<code>LogUtil.h</code>ä¸­å®å®šä¹‰æ‰“log<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\">LOG_ERROR<span class=\"hljs-comment\">(kModuleViewController, @&quot;this is a test log!&quot;)</span>;<br></code></pre></td></tr></table></figure></li>\n<li>æ„‰å¿«åœ°æ–­ç‚¹ï¼Œè°ƒè¯•å§</li>\n</ol>\n"},{"layout":"post","title":"open your terminal from xcode","date":"2023-03-06T16:00:00.000Z","_content":"\nå‚è€ƒï¼š [Open your terminal from Xcode](https://blog.eidinger.info/open-your-terminal-from-xcode)\n\n\nå®ç°æ–¹å¼ï¼š \n\næ·»åŠ ä¸€ä¸ª Xcode Behaviorsï¼Œ ç»™ behavior æŒ‡å®šä¸€ä¸ª shell scriptï¼Œ behavior è§¦å‘çš„æ—¶å€™ï¼Œ æ‰§è¡Œæ”¹è„šæœ¬ä»¥å½“å‰ç›®å½•æ‰“å¼€ terminalã€‚\n\n\n\n# æ­¥éª¤\n\nåˆ›å»ºä¸€ä¸ª shell è„šæœ¬\n\n> open-iterm-from-xcode\n\n```\n#!/bin/sh\ndir=\"$PWD\"\n# remove a potential suffix in case Xcode shows a Swift Package\nsuffix=\"/.swiftpm/xcode\"\ndir=${dir//$suffix/}\nopen -a iterm \"$dir\n```\n\næ·»åŠ æ‰§è¡Œæƒé™\n\n```\nchmod +x open-iterm-from-xcode\n```\n\n\næ·»åŠ  Xcode Behaviors\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16781590158101678159015713.png)\n\n\næ‰“å¼€ç»ˆç«¯\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16781591208101678159120572.png)\n\n\nä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå¿«æ·é”® `cmd + T`\n\n","source":"_posts/2023-03-07-open-your-terminal-from-xcode.md","raw":"---\n\nlayout: post\ntitle: \"open your terminal from xcode\"\ndate: 2023-03-07\ntag: shell\n\n---\n\nå‚è€ƒï¼š [Open your terminal from Xcode](https://blog.eidinger.info/open-your-terminal-from-xcode)\n\n\nå®ç°æ–¹å¼ï¼š \n\næ·»åŠ ä¸€ä¸ª Xcode Behaviorsï¼Œ ç»™ behavior æŒ‡å®šä¸€ä¸ª shell scriptï¼Œ behavior è§¦å‘çš„æ—¶å€™ï¼Œ æ‰§è¡Œæ”¹è„šæœ¬ä»¥å½“å‰ç›®å½•æ‰“å¼€ terminalã€‚\n\n\n\n# æ­¥éª¤\n\nåˆ›å»ºä¸€ä¸ª shell è„šæœ¬\n\n> open-iterm-from-xcode\n\n```\n#!/bin/sh\ndir=\"$PWD\"\n# remove a potential suffix in case Xcode shows a Swift Package\nsuffix=\"/.swiftpm/xcode\"\ndir=${dir//$suffix/}\nopen -a iterm \"$dir\n```\n\næ·»åŠ æ‰§è¡Œæƒé™\n\n```\nchmod +x open-iterm-from-xcode\n```\n\n\næ·»åŠ  Xcode Behaviors\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16781590158101678159015713.png)\n\n\næ‰“å¼€ç»ˆç«¯\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16781591208101678159120572.png)\n\n\nä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå¿«æ·é”® `cmd + T`\n\n","slug":"2023-03-07-open-your-terminal-from-xcode","published":1,"updated":"2024-03-06T11:53:13.562Z","comments":1,"photos":[],"_id":"clti3glki000557wh5t4ld6ay","content":"<p>å‚è€ƒï¼š <a href=\"https://blog.eidinger.info/open-your-terminal-from-xcode\">Open your terminal from Xcode</a></p>\n<p>å®ç°æ–¹å¼ï¼š </p>\n<p>æ·»åŠ ä¸€ä¸ª Xcode Behaviorsï¼Œ ç»™ behavior æŒ‡å®šä¸€ä¸ª shell scriptï¼Œ behavior è§¦å‘çš„æ—¶å€™ï¼Œ æ‰§è¡Œæ”¹è„šæœ¬ä»¥å½“å‰ç›®å½•æ‰“å¼€ terminalã€‚</p>\n<h1 id=\"æ­¥éª¤\"><a href=\"#æ­¥éª¤\" class=\"headerlink\" title=\"æ­¥éª¤\"></a>æ­¥éª¤</h1><p>åˆ›å»ºä¸€ä¸ª shell è„šæœ¬</p>\n<blockquote>\n<p>open-iterm-from-xcode</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/bin/sh</span><br><span class=\"hljs-built_in\">dir</span>=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$PWD</span>&quot;</span><br><span class=\"hljs-comment\"># remove a potential suffix in case Xcode shows a Swift Package</span><br>suffix=<span class=\"hljs-string\">&quot;/.swiftpm/xcode&quot;</span><br><span class=\"hljs-built_in\">dir</span>=<span class=\"hljs-variable\">$&#123;dir//$suffix/&#125;</span><br>open -a iterm <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$dir</span></span><br></code></pre></td></tr></table></figure>\n\n<p>æ·»åŠ æ‰§è¡Œæƒé™</p>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs livecodeserver\">chmod +x <span class=\"hljs-built_in\">open</span>-iterm-<span class=\"hljs-built_in\">from</span>-xcode<br></code></pre></td></tr></table></figure>\n\n\n<p>æ·»åŠ  Xcode Behaviors</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16781590158101678159015713.png\"></p>\n<p>æ‰“å¼€ç»ˆç«¯</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16781591208101678159120572.png\"></p>\n<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå¿«æ·é”® <code>cmd + T</code></p>\n","excerpt":"","more":"<p>å‚è€ƒï¼š <a href=\"https://blog.eidinger.info/open-your-terminal-from-xcode\">Open your terminal from Xcode</a></p>\n<p>å®ç°æ–¹å¼ï¼š </p>\n<p>æ·»åŠ ä¸€ä¸ª Xcode Behaviorsï¼Œ ç»™ behavior æŒ‡å®šä¸€ä¸ª shell scriptï¼Œ behavior è§¦å‘çš„æ—¶å€™ï¼Œ æ‰§è¡Œæ”¹è„šæœ¬ä»¥å½“å‰ç›®å½•æ‰“å¼€ terminalã€‚</p>\n<h1 id=\"æ­¥éª¤\"><a href=\"#æ­¥éª¤\" class=\"headerlink\" title=\"æ­¥éª¤\"></a>æ­¥éª¤</h1><p>åˆ›å»ºä¸€ä¸ª shell è„šæœ¬</p>\n<blockquote>\n<p>open-iterm-from-xcode</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/bin/sh</span><br><span class=\"hljs-built_in\">dir</span>=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$PWD</span>&quot;</span><br><span class=\"hljs-comment\"># remove a potential suffix in case Xcode shows a Swift Package</span><br>suffix=<span class=\"hljs-string\">&quot;/.swiftpm/xcode&quot;</span><br><span class=\"hljs-built_in\">dir</span>=<span class=\"hljs-variable\">$&#123;dir//$suffix/&#125;</span><br>open -a iterm <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$dir</span></span><br></code></pre></td></tr></table></figure>\n\n<p>æ·»åŠ æ‰§è¡Œæƒé™</p>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs livecodeserver\">chmod +x <span class=\"hljs-built_in\">open</span>-iterm-<span class=\"hljs-built_in\">from</span>-xcode<br></code></pre></td></tr></table></figure>\n\n\n<p>æ·»åŠ  Xcode Behaviors</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16781590158101678159015713.png\"></p>\n<p>æ‰“å¼€ç»ˆç«¯</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16781591208101678159120572.png\"></p>\n<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå¿«æ·é”® <code>cmd + T</code></p>\n"},{"layout":"post","title":"Shell å˜é‡","date":"2022-02-24T16:00:00.000Z","_content":"  \n\n# Shell å˜é‡\n\n## å˜é‡å\n\nThe name of a variable can contain only letters (a to z or A to Z), numbers ( 0 to 9) or the underscore character ( _).\n\nBy convention, Unix shell variables will have their names in UPPERCASE.\n\nåˆæ³•çš„å˜é‡\n\n```shell\n_ALI\nTOKEN_A\nVAR_1\nVAR_2\n```\n\néæ³•å˜é‡\n\n```shell\n2_VAR\n-VARIABLE\nVAR1-VAR2\nVAR_A!\n```\n\n## å®šä¹‰å˜é‡\n\n```shell\nvariable_name=variable_value\n```\n\nä¾‹å¦‚ï¼š\n\n```shell\nNAME=\"Zara Ali\"\n```\n\nshell å…è®¸å˜é‡å­˜ä½ æƒ³è¦çš„ä»»ä½•å€¼ï¼Œ ä¾‹å¦‚\n\n```shell\nVAR1=\"Zara Ali\"\nVAR2=100\n```\n\n## è·å–å˜é‡çš„å€¼\n\né€šè¿‡åœ¨å˜é‡å‰æ·»åŠ `$`æ¥å¼•ç”¨å˜é‡\n\n```shell\n#!/bin/sh\n\nNAME=\"Zara Ali\"\necho $NAME\n```\n\nè¾“å‡º\n\n```shell\nZara Ali\n```\n\n## åªè¯»å˜é‡\n\nåœ¨å˜é‡å‰æ·»åŠ `readonly`å°†å˜é‡æ ‡è®°ä¸ºåªè¯»ï¼Œåªè¯»å˜é‡ä¸å…è®¸è¢«ä¿®æ”¹ã€‚\n\n```shell\n#!/bin/sh\n\nNAME=\"Zara Ali\"\nreadonly NAME\nNAME=\"Qadiri\"\n```\n\næŠ¥é”™\n\n```shell\nNAME: readonly variable\n```\n\n## åˆ é™¤ä¸€ä¸ªå˜é‡\n\nä½¿ç”¨`unset`å‘½ä»¤åˆ é™¤ä¸€ä¸ªå˜é‡ï¼Œå˜é‡è¢«åˆ é™¤åï¼Œæ— æ³•è®¿é—®è¯¥å˜é‡çš„å€¼ã€‚\n\n```shell\nunset variable_name\n```\n\nä¾‹å¦‚\n\n```shell\n#!/bin/sh\n\nNAME=\"Zara Ali\"\nunset NAME\necho $NAME\n```\n\n\bNAME è¢«åˆ é™¤ï¼Œ è¾“å‡ºä¸ºç©ºã€‚\n\n## å˜é‡ç±»å‹\n\n- æœ¬åœ°å˜é‡\n  \n  - ä½¿ç”¨`local`å…³é”®å­—ä¿®é¥°çš„å˜é‡\n  - åªèƒ½ç”¨åœ¨å‡½æ•°å†…éƒ¨\n  - å¦‚æœä¸å…¨å±€å˜é‡åŒåï¼Œåœ¨å‡½æ•°å†…éƒ¨ï¼Œä¼šå±è”½åŒåçš„å…¨å±€å˜é‡\n  - å‡½æ•°çš„å‚æ•°æ˜¯`local`çš„\n\n- shell å…¨å±€å˜é‡\n  \n  - åœ¨ Shell ä¸­å®šä¹‰çš„å˜é‡ï¼Œé»˜è®¤å°±æ˜¯å…¨å±€å˜é‡ã€‚\n  - åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡ï¼Œæ²¡æœ‰ç”¨`local`å…³é”®å­—ä¿®é¥°ï¼Œä¹Ÿæ˜¯å…¨å±€å˜é‡\n    \n    \n\n- ç¯å¢ƒå˜é‡\n  \n  - å…¨å±€å˜é‡åªåœ¨å½“å‰ Shell è¿›ç¨‹ä¸­æœ‰æ•ˆï¼Œå¯¹å…¶å®ƒ Shell è¿›ç¨‹å’Œå­è¿›ç¨‹éƒ½æ— æ•ˆã€‚å¦‚æœä½¿ç”¨`export`å‘½ä»¤å°†å…¨å±€å˜é‡å¯¼å‡ºï¼Œé‚£ä¹ˆå®ƒå°±åœ¨æ‰€æœ‰çš„å­è¿›ç¨‹ä¸­ä¹Ÿæœ‰æ•ˆäº†ï¼Œè¿™ç§°ä¸ºâ€œç¯å¢ƒå˜é‡â€ã€‚\n\nåœ¨shell å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ä¹Ÿæ˜¯å…¨å±€å˜é‡\n\n```shell\n#!/bin/bash\n#å®šä¹‰å‡½æ•°\nfunction func(){\n    a=99\n}\n#è°ƒç”¨å‡½æ•°\nfunc\n#è¾“å‡ºå‡½æ•°å†…éƒ¨çš„å˜é‡\necho $a\n```\n\nè¾“å‡ºç»“æœï¼š \n\n```\n99\n```\n\nè¦æƒ³å˜é‡çš„ä½œç”¨åŸŸä»…é™äºå‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥åœ¨å®šä¹‰æ—¶åŠ ä¸Š`local`å‘½ä»¤ï¼Œæ­¤æ—¶è¯¥å˜é‡å°±æˆäº†å±€éƒ¨å˜é‡ã€‚\n\n```shell\n#!/bin/bash\n\n#å®šä¹‰å‡½æ•°\nfunction func(){\n    local a=99\n}\n\n#è°ƒç”¨å‡½æ•°\nfunc\n\n#è¾“å‡ºå‡½æ•°å†…éƒ¨çš„å˜é‡\necho $a\n```\n\nè¾“å‡ºç»“æœä¸ºç©ºï¼Œè¡¨æ˜å˜é‡ a åœ¨å‡½æ•°å¤–éƒ¨æ— æ•ˆï¼Œæ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ã€‚\n","source":"_posts/Shell/2022-02-25-Shell å˜é‡.md","raw":"---\n\nlayout: post\ntitle: \"Shell å˜é‡\"\ndate: 2022-02-25 \ntag: Shell\n\n---  \n\n# Shell å˜é‡\n\n## å˜é‡å\n\nThe name of a variable can contain only letters (a to z or A to Z), numbers ( 0 to 9) or the underscore character ( _).\n\nBy convention, Unix shell variables will have their names in UPPERCASE.\n\nåˆæ³•çš„å˜é‡\n\n```shell\n_ALI\nTOKEN_A\nVAR_1\nVAR_2\n```\n\néæ³•å˜é‡\n\n```shell\n2_VAR\n-VARIABLE\nVAR1-VAR2\nVAR_A!\n```\n\n## å®šä¹‰å˜é‡\n\n```shell\nvariable_name=variable_value\n```\n\nä¾‹å¦‚ï¼š\n\n```shell\nNAME=\"Zara Ali\"\n```\n\nshell å…è®¸å˜é‡å­˜ä½ æƒ³è¦çš„ä»»ä½•å€¼ï¼Œ ä¾‹å¦‚\n\n```shell\nVAR1=\"Zara Ali\"\nVAR2=100\n```\n\n## è·å–å˜é‡çš„å€¼\n\né€šè¿‡åœ¨å˜é‡å‰æ·»åŠ `$`æ¥å¼•ç”¨å˜é‡\n\n```shell\n#!/bin/sh\n\nNAME=\"Zara Ali\"\necho $NAME\n```\n\nè¾“å‡º\n\n```shell\nZara Ali\n```\n\n## åªè¯»å˜é‡\n\nåœ¨å˜é‡å‰æ·»åŠ `readonly`å°†å˜é‡æ ‡è®°ä¸ºåªè¯»ï¼Œåªè¯»å˜é‡ä¸å…è®¸è¢«ä¿®æ”¹ã€‚\n\n```shell\n#!/bin/sh\n\nNAME=\"Zara Ali\"\nreadonly NAME\nNAME=\"Qadiri\"\n```\n\næŠ¥é”™\n\n```shell\nNAME: readonly variable\n```\n\n## åˆ é™¤ä¸€ä¸ªå˜é‡\n\nä½¿ç”¨`unset`å‘½ä»¤åˆ é™¤ä¸€ä¸ªå˜é‡ï¼Œå˜é‡è¢«åˆ é™¤åï¼Œæ— æ³•è®¿é—®è¯¥å˜é‡çš„å€¼ã€‚\n\n```shell\nunset variable_name\n```\n\nä¾‹å¦‚\n\n```shell\n#!/bin/sh\n\nNAME=\"Zara Ali\"\nunset NAME\necho $NAME\n```\n\n\bNAME è¢«åˆ é™¤ï¼Œ è¾“å‡ºä¸ºç©ºã€‚\n\n## å˜é‡ç±»å‹\n\n- æœ¬åœ°å˜é‡\n  \n  - ä½¿ç”¨`local`å…³é”®å­—ä¿®é¥°çš„å˜é‡\n  - åªèƒ½ç”¨åœ¨å‡½æ•°å†…éƒ¨\n  - å¦‚æœä¸å…¨å±€å˜é‡åŒåï¼Œåœ¨å‡½æ•°å†…éƒ¨ï¼Œä¼šå±è”½åŒåçš„å…¨å±€å˜é‡\n  - å‡½æ•°çš„å‚æ•°æ˜¯`local`çš„\n\n- shell å…¨å±€å˜é‡\n  \n  - åœ¨ Shell ä¸­å®šä¹‰çš„å˜é‡ï¼Œé»˜è®¤å°±æ˜¯å…¨å±€å˜é‡ã€‚\n  - åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡ï¼Œæ²¡æœ‰ç”¨`local`å…³é”®å­—ä¿®é¥°ï¼Œä¹Ÿæ˜¯å…¨å±€å˜é‡\n    \n    \n\n- ç¯å¢ƒå˜é‡\n  \n  - å…¨å±€å˜é‡åªåœ¨å½“å‰ Shell è¿›ç¨‹ä¸­æœ‰æ•ˆï¼Œå¯¹å…¶å®ƒ Shell è¿›ç¨‹å’Œå­è¿›ç¨‹éƒ½æ— æ•ˆã€‚å¦‚æœä½¿ç”¨`export`å‘½ä»¤å°†å…¨å±€å˜é‡å¯¼å‡ºï¼Œé‚£ä¹ˆå®ƒå°±åœ¨æ‰€æœ‰çš„å­è¿›ç¨‹ä¸­ä¹Ÿæœ‰æ•ˆäº†ï¼Œè¿™ç§°ä¸ºâ€œç¯å¢ƒå˜é‡â€ã€‚\n\nåœ¨shell å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ä¹Ÿæ˜¯å…¨å±€å˜é‡\n\n```shell\n#!/bin/bash\n#å®šä¹‰å‡½æ•°\nfunction func(){\n    a=99\n}\n#è°ƒç”¨å‡½æ•°\nfunc\n#è¾“å‡ºå‡½æ•°å†…éƒ¨çš„å˜é‡\necho $a\n```\n\nè¾“å‡ºç»“æœï¼š \n\n```\n99\n```\n\nè¦æƒ³å˜é‡çš„ä½œç”¨åŸŸä»…é™äºå‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥åœ¨å®šä¹‰æ—¶åŠ ä¸Š`local`å‘½ä»¤ï¼Œæ­¤æ—¶è¯¥å˜é‡å°±æˆäº†å±€éƒ¨å˜é‡ã€‚\n\n```shell\n#!/bin/bash\n\n#å®šä¹‰å‡½æ•°\nfunction func(){\n    local a=99\n}\n\n#è°ƒç”¨å‡½æ•°\nfunc\n\n#è¾“å‡ºå‡½æ•°å†…éƒ¨çš„å˜é‡\necho $a\n```\n\nè¾“å‡ºç»“æœä¸ºç©ºï¼Œè¡¨æ˜å˜é‡ a åœ¨å‡½æ•°å¤–éƒ¨æ— æ•ˆï¼Œæ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ã€‚\n","slug":"Shell/2022-02-25-Shell å˜é‡","published":1,"updated":"2024-03-06T11:53:13.562Z","comments":1,"photos":[],"_id":"clti3glki000657wh2bsz4zzr","content":"<h1 id=\"Shell-å˜é‡\"><a href=\"#Shell-å˜é‡\" class=\"headerlink\" title=\"Shell å˜é‡\"></a>Shell å˜é‡</h1><h2 id=\"å˜é‡å\"><a href=\"#å˜é‡å\" class=\"headerlink\" title=\"å˜é‡å\"></a>å˜é‡å</h2><p>The name of a variable can contain only letters (a to z or A to Z), numbers ( 0 to 9) or the underscore character ( _).</p>\n<p>By convention, Unix shell variables will have their names in UPPERCASE.</p>\n<p>åˆæ³•çš„å˜é‡</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">_ALI<br>TOKEN_A<br>VAR_1<br>VAR_2<br></code></pre></td></tr></table></figure>\n\n<p>éæ³•å˜é‡</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">2_VAR<br>-VARIABLE<br>VAR1-VAR2<br>VAR_A!<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å®šä¹‰å˜é‡\"><a href=\"#å®šä¹‰å˜é‡\" class=\"headerlink\" title=\"å®šä¹‰å˜é‡\"></a>å®šä¹‰å˜é‡</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">variable_name=variable_value<br></code></pre></td></tr></table></figure>\n\n<p>ä¾‹å¦‚ï¼š</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">NAME=&quot;Zara Ali&quot;<br></code></pre></td></tr></table></figure>\n\n<p>shell å…è®¸å˜é‡å­˜ä½ æƒ³è¦çš„ä»»ä½•å€¼ï¼Œ ä¾‹å¦‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">VAR1=&quot;Zara Ali&quot;<br>VAR2=100<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"è·å–å˜é‡çš„å€¼\"><a href=\"#è·å–å˜é‡çš„å€¼\" class=\"headerlink\" title=\"è·å–å˜é‡çš„å€¼\"></a>è·å–å˜é‡çš„å€¼</h2><p>é€šè¿‡åœ¨å˜é‡å‰æ·»åŠ <code>$</code>æ¥å¼•ç”¨å˜é‡</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>NAME=&quot;Zara Ali&quot;<br>echo $NAME<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡º</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">Zara Ali<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"åªè¯»å˜é‡\"><a href=\"#åªè¯»å˜é‡\" class=\"headerlink\" title=\"åªè¯»å˜é‡\"></a>åªè¯»å˜é‡</h2><p>åœ¨å˜é‡å‰æ·»åŠ <code>readonly</code>å°†å˜é‡æ ‡è®°ä¸ºåªè¯»ï¼Œåªè¯»å˜é‡ä¸å…è®¸è¢«ä¿®æ”¹ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>NAME=&quot;Zara Ali&quot;<br>readonly NAME<br>NAME=&quot;Qadiri&quot;<br></code></pre></td></tr></table></figure>\n\n<p>æŠ¥é”™</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">NAME: readonly variable<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"åˆ é™¤ä¸€ä¸ªå˜é‡\"><a href=\"#åˆ é™¤ä¸€ä¸ªå˜é‡\" class=\"headerlink\" title=\"åˆ é™¤ä¸€ä¸ªå˜é‡\"></a>åˆ é™¤ä¸€ä¸ªå˜é‡</h2><p>ä½¿ç”¨<code>unset</code>å‘½ä»¤åˆ é™¤ä¸€ä¸ªå˜é‡ï¼Œå˜é‡è¢«åˆ é™¤åï¼Œæ— æ³•è®¿é—®è¯¥å˜é‡çš„å€¼ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">unset variable_name<br></code></pre></td></tr></table></figure>\n\n<p>ä¾‹å¦‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>NAME=&quot;Zara Ali&quot;<br>unset NAME<br>echo $NAME<br></code></pre></td></tr></table></figure>\n\n<p>\bNAME è¢«åˆ é™¤ï¼Œ è¾“å‡ºä¸ºç©ºã€‚</p>\n<h2 id=\"å˜é‡ç±»å‹\"><a href=\"#å˜é‡ç±»å‹\" class=\"headerlink\" title=\"å˜é‡ç±»å‹\"></a>å˜é‡ç±»å‹</h2><ul>\n<li><p>æœ¬åœ°å˜é‡</p>\n<ul>\n<li>ä½¿ç”¨<code>local</code>å…³é”®å­—ä¿®é¥°çš„å˜é‡</li>\n<li>åªèƒ½ç”¨åœ¨å‡½æ•°å†…éƒ¨</li>\n<li>å¦‚æœä¸å…¨å±€å˜é‡åŒåï¼Œåœ¨å‡½æ•°å†…éƒ¨ï¼Œä¼šå±è”½åŒåçš„å…¨å±€å˜é‡</li>\n<li>å‡½æ•°çš„å‚æ•°æ˜¯<code>local</code>çš„</li>\n</ul>\n</li>\n<li><p>shell å…¨å±€å˜é‡</p>\n<ul>\n<li>åœ¨ Shell ä¸­å®šä¹‰çš„å˜é‡ï¼Œé»˜è®¤å°±æ˜¯å…¨å±€å˜é‡ã€‚</li>\n<li>åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡ï¼Œæ²¡æœ‰ç”¨<code>local</code>å…³é”®å­—ä¿®é¥°ï¼Œä¹Ÿæ˜¯å…¨å±€å˜é‡</li>\n</ul>\n</li>\n<li><p>ç¯å¢ƒå˜é‡</p>\n<ul>\n<li>å…¨å±€å˜é‡åªåœ¨å½“å‰ Shell è¿›ç¨‹ä¸­æœ‰æ•ˆï¼Œå¯¹å…¶å®ƒ Shell è¿›ç¨‹å’Œå­è¿›ç¨‹éƒ½æ— æ•ˆã€‚å¦‚æœä½¿ç”¨<code>export</code>å‘½ä»¤å°†å…¨å±€å˜é‡å¯¼å‡ºï¼Œé‚£ä¹ˆå®ƒå°±åœ¨æ‰€æœ‰çš„å­è¿›ç¨‹ä¸­ä¹Ÿæœ‰æ•ˆäº†ï¼Œè¿™ç§°ä¸ºâ€œç¯å¢ƒå˜é‡â€ã€‚</li>\n</ul>\n</li>\n</ul>\n<p>åœ¨shell å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ä¹Ÿæ˜¯å…¨å±€å˜é‡</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">å®šä¹‰å‡½æ•°</span><br>function func()&#123;<br>    a=99<br>&#125;<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">è°ƒç”¨å‡½æ•°</span><br>func<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">è¾“å‡ºå‡½æ•°å†…éƒ¨çš„å˜é‡</span><br>echo $a<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡ºç»“æœï¼š </p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs\">99<br></code></pre></td></tr></table></figure>\n\n<p>è¦æƒ³å˜é‡çš„ä½œç”¨åŸŸä»…é™äºå‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥åœ¨å®šä¹‰æ—¶åŠ ä¸Š<code>local</code>å‘½ä»¤ï¼Œæ­¤æ—¶è¯¥å˜é‡å°±æˆäº†å±€éƒ¨å˜é‡ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">å®šä¹‰å‡½æ•°</span><br>function func()&#123;<br>    local a=99<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">è°ƒç”¨å‡½æ•°</span><br>func<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">è¾“å‡ºå‡½æ•°å†…éƒ¨çš„å˜é‡</span><br>echo $a<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡ºç»“æœä¸ºç©ºï¼Œè¡¨æ˜å˜é‡ a åœ¨å‡½æ•°å¤–éƒ¨æ— æ•ˆï¼Œæ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ã€‚</p>\n","excerpt":"","more":"<h1 id=\"Shell-å˜é‡\"><a href=\"#Shell-å˜é‡\" class=\"headerlink\" title=\"Shell å˜é‡\"></a>Shell å˜é‡</h1><h2 id=\"å˜é‡å\"><a href=\"#å˜é‡å\" class=\"headerlink\" title=\"å˜é‡å\"></a>å˜é‡å</h2><p>The name of a variable can contain only letters (a to z or A to Z), numbers ( 0 to 9) or the underscore character ( _).</p>\n<p>By convention, Unix shell variables will have their names in UPPERCASE.</p>\n<p>åˆæ³•çš„å˜é‡</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">_ALI<br>TOKEN_A<br>VAR_1<br>VAR_2<br></code></pre></td></tr></table></figure>\n\n<p>éæ³•å˜é‡</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">2_VAR<br>-VARIABLE<br>VAR1-VAR2<br>VAR_A!<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å®šä¹‰å˜é‡\"><a href=\"#å®šä¹‰å˜é‡\" class=\"headerlink\" title=\"å®šä¹‰å˜é‡\"></a>å®šä¹‰å˜é‡</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">variable_name=variable_value<br></code></pre></td></tr></table></figure>\n\n<p>ä¾‹å¦‚ï¼š</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">NAME=&quot;Zara Ali&quot;<br></code></pre></td></tr></table></figure>\n\n<p>shell å…è®¸å˜é‡å­˜ä½ æƒ³è¦çš„ä»»ä½•å€¼ï¼Œ ä¾‹å¦‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">VAR1=&quot;Zara Ali&quot;<br>VAR2=100<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"è·å–å˜é‡çš„å€¼\"><a href=\"#è·å–å˜é‡çš„å€¼\" class=\"headerlink\" title=\"è·å–å˜é‡çš„å€¼\"></a>è·å–å˜é‡çš„å€¼</h2><p>é€šè¿‡åœ¨å˜é‡å‰æ·»åŠ <code>$</code>æ¥å¼•ç”¨å˜é‡</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>NAME=&quot;Zara Ali&quot;<br>echo $NAME<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡º</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">Zara Ali<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"åªè¯»å˜é‡\"><a href=\"#åªè¯»å˜é‡\" class=\"headerlink\" title=\"åªè¯»å˜é‡\"></a>åªè¯»å˜é‡</h2><p>åœ¨å˜é‡å‰æ·»åŠ <code>readonly</code>å°†å˜é‡æ ‡è®°ä¸ºåªè¯»ï¼Œåªè¯»å˜é‡ä¸å…è®¸è¢«ä¿®æ”¹ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>NAME=&quot;Zara Ali&quot;<br>readonly NAME<br>NAME=&quot;Qadiri&quot;<br></code></pre></td></tr></table></figure>\n\n<p>æŠ¥é”™</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">NAME: readonly variable<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"åˆ é™¤ä¸€ä¸ªå˜é‡\"><a href=\"#åˆ é™¤ä¸€ä¸ªå˜é‡\" class=\"headerlink\" title=\"åˆ é™¤ä¸€ä¸ªå˜é‡\"></a>åˆ é™¤ä¸€ä¸ªå˜é‡</h2><p>ä½¿ç”¨<code>unset</code>å‘½ä»¤åˆ é™¤ä¸€ä¸ªå˜é‡ï¼Œå˜é‡è¢«åˆ é™¤åï¼Œæ— æ³•è®¿é—®è¯¥å˜é‡çš„å€¼ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">unset variable_name<br></code></pre></td></tr></table></figure>\n\n<p>ä¾‹å¦‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>NAME=&quot;Zara Ali&quot;<br>unset NAME<br>echo $NAME<br></code></pre></td></tr></table></figure>\n\n<p>\bNAME è¢«åˆ é™¤ï¼Œ è¾“å‡ºä¸ºç©ºã€‚</p>\n<h2 id=\"å˜é‡ç±»å‹\"><a href=\"#å˜é‡ç±»å‹\" class=\"headerlink\" title=\"å˜é‡ç±»å‹\"></a>å˜é‡ç±»å‹</h2><ul>\n<li><p>æœ¬åœ°å˜é‡</p>\n<ul>\n<li>ä½¿ç”¨<code>local</code>å…³é”®å­—ä¿®é¥°çš„å˜é‡</li>\n<li>åªèƒ½ç”¨åœ¨å‡½æ•°å†…éƒ¨</li>\n<li>å¦‚æœä¸å…¨å±€å˜é‡åŒåï¼Œåœ¨å‡½æ•°å†…éƒ¨ï¼Œä¼šå±è”½åŒåçš„å…¨å±€å˜é‡</li>\n<li>å‡½æ•°çš„å‚æ•°æ˜¯<code>local</code>çš„</li>\n</ul>\n</li>\n<li><p>shell å…¨å±€å˜é‡</p>\n<ul>\n<li>åœ¨ Shell ä¸­å®šä¹‰çš„å˜é‡ï¼Œé»˜è®¤å°±æ˜¯å…¨å±€å˜é‡ã€‚</li>\n<li>åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡ï¼Œæ²¡æœ‰ç”¨<code>local</code>å…³é”®å­—ä¿®é¥°ï¼Œä¹Ÿæ˜¯å…¨å±€å˜é‡</li>\n</ul>\n</li>\n<li><p>ç¯å¢ƒå˜é‡</p>\n<ul>\n<li>å…¨å±€å˜é‡åªåœ¨å½“å‰ Shell è¿›ç¨‹ä¸­æœ‰æ•ˆï¼Œå¯¹å…¶å®ƒ Shell è¿›ç¨‹å’Œå­è¿›ç¨‹éƒ½æ— æ•ˆã€‚å¦‚æœä½¿ç”¨<code>export</code>å‘½ä»¤å°†å…¨å±€å˜é‡å¯¼å‡ºï¼Œé‚£ä¹ˆå®ƒå°±åœ¨æ‰€æœ‰çš„å­è¿›ç¨‹ä¸­ä¹Ÿæœ‰æ•ˆäº†ï¼Œè¿™ç§°ä¸ºâ€œç¯å¢ƒå˜é‡â€ã€‚</li>\n</ul>\n</li>\n</ul>\n<p>åœ¨shell å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ä¹Ÿæ˜¯å…¨å±€å˜é‡</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">å®šä¹‰å‡½æ•°</span><br>function func()&#123;<br>    a=99<br>&#125;<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">è°ƒç”¨å‡½æ•°</span><br>func<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">è¾“å‡ºå‡½æ•°å†…éƒ¨çš„å˜é‡</span><br>echo $a<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡ºç»“æœï¼š </p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs\">99<br></code></pre></td></tr></table></figure>\n\n<p>è¦æƒ³å˜é‡çš„ä½œç”¨åŸŸä»…é™äºå‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥åœ¨å®šä¹‰æ—¶åŠ ä¸Š<code>local</code>å‘½ä»¤ï¼Œæ­¤æ—¶è¯¥å˜é‡å°±æˆäº†å±€éƒ¨å˜é‡ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">å®šä¹‰å‡½æ•°</span><br>function func()&#123;<br>    local a=99<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">è°ƒç”¨å‡½æ•°</span><br>func<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">è¾“å‡ºå‡½æ•°å†…éƒ¨çš„å˜é‡</span><br>echo $a<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡ºç»“æœä¸ºç©ºï¼Œè¡¨æ˜å˜é‡ a åœ¨å‡½æ•°å¤–éƒ¨æ— æ•ˆï¼Œæ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ã€‚</p>\n"},{"layout":"post","title":"Shell æ•°ç»„","date":"2022-02-24T16:00:00.000Z","_content":"  \n\n# Shell æ•°ç»„\n\nå‚è€ƒï¼š [Shellä¸­çš„æ•°ç»„åŠå…¶ç›¸å…³æ“ä½œ_æ°ç‘çš„ä¸“æ -CSDNåšå®¢](https://blog.csdn.net/Jerry_1126/article/details/52027539)\n\nåº”ç”¨åœºæ™¯ï¼š\n\n1. æ±‚æ•°ç»„çš„é•¿åº¦\n\n2. å…ƒç´ é•¿åº¦\n\n3. éå†æ•°ç»„\n\n4. å…ƒç´ åˆ‡ç‰‡\n\n5. æ›¿æ¢\n\n6. åˆ é™¤\n\n\n\nå¤‡æ³¨ï¼š\n\n1. Shellä¸­çš„æ•°ç»„ä¸åƒJAVA/Cï¼Œåªèƒ½æ˜¯ä¸€ç»´æ•°ç»„ï¼Œ æ²¡æœ‰äºŒç»´æ•°ç»„\n\n2. æ•°ç»„å…ƒç´ å¤§å°æ— çº¦æŸï¼Œä¹Ÿæ— éœ€å…ˆå®šä¹‰æ•°ç»„çš„å…ƒç´ ä¸ªæ•°\n\n3. ç´¢å¼•ä»0å¼€å§‹\n\n4. ä¸åƒJAVA/Cç­‰å¼ºç¼–ç¨‹è¯­è¨€ï¼Œåœ¨èµ‹å€¼å‰å¿…é¡»å£°æ˜ï¼›SHELLåªæ˜¯å¼±ç¼–ç¨‹è¯­è¨€ï¼Œå¯äº‹å…ˆå£°æ˜ä¹Ÿå¯ä¸å£°æ˜ï¼›\n\n5. ç”¨unsetæ¥æ’¤é”€æ•°ç»„ï¼Œå¯ç”¨unset array_name[i]æ¥åˆ é™¤é‡Œé¢çš„å…ƒç´ \n\n\n\n## å£°æ˜\n\n```shell\ndeclare -a array_name       # å£°æ˜æ•°ç»„ï¼Œä¹Ÿå¯ä¸å£°æ˜\ndeclare -a nums=(1 2 3 4)   # å£°æ˜æ•°ç»„ï¼Œ åŒæ—¶èµ‹å€¼\nunset array_name            # åˆ é™¤æ•°ç»„ï¼Œæ’¤é”€æ•°ç»„\nunset nums[0]               # åˆ é™¤æ•°ç»„ä¸­æŸä¸ªå…ƒç´ \n```\n\n## å®šä¹‰\n\n```shell\n#æ–¹å¼ä¸€ï¼š\narray_names=(\nvalue0\nvaluel\nvalue2\nvalue3\n)\n#æ–¹å¼äºŒï¼š\nnames=(Jerry Alice David wendy)\n#æ–¹å¼ä¸‰ï¼š\nnames[0]=Jerry\nnames[1]=Alice\nnames[2]=David\nnames[3]=Wendy\n#æ–¹å¼å››ï¼š\nnames=([0]=Jerry [1]=Alice [2]=David [3]=Wendy)\n#æ–¹å¼äº”ï¼š\nstr=\"Jerry Alice David Wendy\"\nnames=($str)\n```\n\nå¤‡æ³¨ï¼š\n\n1. æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå¿…é¡»ç”¨\"ç©ºæ ¼\"æ¥éš”å¼€\n\n2. å®šä¹‰æ•°ç»„ç´¢å¼•ï¼Œå¯ä»¥ä¸æŒ‰é¡ºåºæ¥ï¼Œä¾‹å¦‚ï¼Œ`names=([0]=Jerry [1]=Alice [2]=David [8]=Wendy)`\n\n3. å­—ç¬¦ä¸²æ˜¯SHELLä¸­æœ€é‡è¦çš„æ•°æ®ç±»å‹ï¼Œå…¶ä¹Ÿå¯é€šè¿‡`($str)`æ¥è½¬æˆæ•°ç»„ï¼Œæ“ä½œèµ·æ¥éå¸¸æ–¹ä¾¿\n\n## æ•°ç»„é•¿åº¦\n\n```shell\nnums=(Jerry Alice David Wendy)\n\n#æ–¹å¼1 ${#æ•°ç»„å[@]}\n~ echo ${#nums[@]}\n4\n#æ–¹å¼2 ${#æ•°ç»„å[*]}\n~ echo ${#nums[*]}\n4\n```\n\nå¤‡æ³¨ï¼š\n\n1) ä½¿ç”¨`${array_name[@]}` æˆ–è€… `${array_name[*]}` éƒ½å¯ä»¥å…¨éƒ¨æ˜¾ç¤ºæ•°ç»„ä¸­çš„å…ƒç´ \n\n2) åŒæ ·é“ç†`${#array_name[@]}` æˆ–è€… `${#array_name[*]}`éƒ½å¯ä»¥ç”¨æ¥æ±‚æ•°ç»„çš„é•¿åº¦\n\n3) æ±‚æ•°ç»„ä¸­å…ƒç´ çš„é•¿åº¦æ–¹æ³•æœ‰å¾ˆå¤šï¼Œç›¸å½“äºæ±‚å­—ç¬¦ä¸²çš„é•¿åº¦\n   \n\n## æ•°ç»„éå†\n\n```shell\nnames=(Jerry Alice David Wendy)\n\n# æ–¹å¼ä¸€ï¼š æŒ‰ç´¢å¼•æ¥éå†\nfor((i=0;i<${#names[@]};i++))\ndo \n    echo ${names[$i]}\ndone\n\n# æ–¹å¼äºŒï¼š ä¸æŒ‰ç´¢å¼•æ¥éå†\nindex=0\nfor name in ${names[@]} \ndo \n    echo \"ç¬¬${index}ä¸ªå…ƒç´ çš„å€¼ä¸ºï¼š==> ${name}\"\n    let index++\ndone\n\n```\n\n## æ•°ç»„èµ‹å€¼\n\n```shell\nnums=(1 2 3 4)  # å®šä¹‰æ•°ç»„\nnums[3]=44      # ç¬¬ä¸‰ä¸ªå…ƒç´ é‡æ–°èµ‹å€¼\necho ${nums[@]} # ç»“æœå˜æˆäº† 1 2 3 44\n```\n\n**å¤‡æ³¨:**\n\n1) ç¬¬ä¸€ç§æ˜¯ç»™å·²ç»å­˜åœ¨çš„å…ƒç´ é¡¹é‡æ–°èµ‹å€¼\n\n2) å½“ç„¶ä¹Ÿå¯ä»¥ç»™ä¸å­˜åœ¨çš„ç´¢å¼•æ·»åŠ èµ‹å€¼ï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹\n\n```shell\n### æ•°ç»„æ·»åŠ å…ƒç´ \n\n# æ–¹å¼-ï¼š ç»™ä¸å­˜åœ¨çš„ç´¢å¼•èµ‹å€¼\nnums=(1 2 3 4)  # å®šä¹‰æ•°ç»„\nnums[4]=5       # ç»™ç¬¬å››ä¸ªæ–°å…ƒç´ èµ‹å€¼\necho ${nums[@]} # ç»“æœå˜æˆäº† 1 2 3 4 5\nnums[8]=8       # ç»™ç¬¬8ä¸ªå…ƒç´ èµ‹å€¼\necho ${nums[@]} # ç»“æœå˜æˆäº† 1 2 3 4 5 8\n\n# æ–¹å¼äºŒï¼š ç›´æ¥ä½¿ç”¨ æ–°æ•°ç»„=(æ—§æ•°ç»„ æ–°å…ƒç´ ) çš„æ–¹æ³•æ·»åŠ å…ƒç´ \nold=(1 2 3 4)\nnew=(${old[*]} 5)\necho ${new[@]}\n```\n\n\n","source":"_posts/Shell/2022-02-25-Shell æ•°ç»„.md","raw":"---\nlayout: post\ntitle: \"Shell æ•°ç»„\"\ndate: 2022-02-25 \ntag: Shell\n---  \n\n# Shell æ•°ç»„\n\nå‚è€ƒï¼š [Shellä¸­çš„æ•°ç»„åŠå…¶ç›¸å…³æ“ä½œ_æ°ç‘çš„ä¸“æ -CSDNåšå®¢](https://blog.csdn.net/Jerry_1126/article/details/52027539)\n\nåº”ç”¨åœºæ™¯ï¼š\n\n1. æ±‚æ•°ç»„çš„é•¿åº¦\n\n2. å…ƒç´ é•¿åº¦\n\n3. éå†æ•°ç»„\n\n4. å…ƒç´ åˆ‡ç‰‡\n\n5. æ›¿æ¢\n\n6. åˆ é™¤\n\n\n\nå¤‡æ³¨ï¼š\n\n1. Shellä¸­çš„æ•°ç»„ä¸åƒJAVA/Cï¼Œåªèƒ½æ˜¯ä¸€ç»´æ•°ç»„ï¼Œ æ²¡æœ‰äºŒç»´æ•°ç»„\n\n2. æ•°ç»„å…ƒç´ å¤§å°æ— çº¦æŸï¼Œä¹Ÿæ— éœ€å…ˆå®šä¹‰æ•°ç»„çš„å…ƒç´ ä¸ªæ•°\n\n3. ç´¢å¼•ä»0å¼€å§‹\n\n4. ä¸åƒJAVA/Cç­‰å¼ºç¼–ç¨‹è¯­è¨€ï¼Œåœ¨èµ‹å€¼å‰å¿…é¡»å£°æ˜ï¼›SHELLåªæ˜¯å¼±ç¼–ç¨‹è¯­è¨€ï¼Œå¯äº‹å…ˆå£°æ˜ä¹Ÿå¯ä¸å£°æ˜ï¼›\n\n5. ç”¨unsetæ¥æ’¤é”€æ•°ç»„ï¼Œå¯ç”¨unset array_name[i]æ¥åˆ é™¤é‡Œé¢çš„å…ƒç´ \n\n\n\n## å£°æ˜\n\n```shell\ndeclare -a array_name       # å£°æ˜æ•°ç»„ï¼Œä¹Ÿå¯ä¸å£°æ˜\ndeclare -a nums=(1 2 3 4)   # å£°æ˜æ•°ç»„ï¼Œ åŒæ—¶èµ‹å€¼\nunset array_name            # åˆ é™¤æ•°ç»„ï¼Œæ’¤é”€æ•°ç»„\nunset nums[0]               # åˆ é™¤æ•°ç»„ä¸­æŸä¸ªå…ƒç´ \n```\n\n## å®šä¹‰\n\n```shell\n#æ–¹å¼ä¸€ï¼š\narray_names=(\nvalue0\nvaluel\nvalue2\nvalue3\n)\n#æ–¹å¼äºŒï¼š\nnames=(Jerry Alice David wendy)\n#æ–¹å¼ä¸‰ï¼š\nnames[0]=Jerry\nnames[1]=Alice\nnames[2]=David\nnames[3]=Wendy\n#æ–¹å¼å››ï¼š\nnames=([0]=Jerry [1]=Alice [2]=David [3]=Wendy)\n#æ–¹å¼äº”ï¼š\nstr=\"Jerry Alice David Wendy\"\nnames=($str)\n```\n\nå¤‡æ³¨ï¼š\n\n1. æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå¿…é¡»ç”¨\"ç©ºæ ¼\"æ¥éš”å¼€\n\n2. å®šä¹‰æ•°ç»„ç´¢å¼•ï¼Œå¯ä»¥ä¸æŒ‰é¡ºåºæ¥ï¼Œä¾‹å¦‚ï¼Œ`names=([0]=Jerry [1]=Alice [2]=David [8]=Wendy)`\n\n3. å­—ç¬¦ä¸²æ˜¯SHELLä¸­æœ€é‡è¦çš„æ•°æ®ç±»å‹ï¼Œå…¶ä¹Ÿå¯é€šè¿‡`($str)`æ¥è½¬æˆæ•°ç»„ï¼Œæ“ä½œèµ·æ¥éå¸¸æ–¹ä¾¿\n\n## æ•°ç»„é•¿åº¦\n\n```shell\nnums=(Jerry Alice David Wendy)\n\n#æ–¹å¼1 ${#æ•°ç»„å[@]}\n~ echo ${#nums[@]}\n4\n#æ–¹å¼2 ${#æ•°ç»„å[*]}\n~ echo ${#nums[*]}\n4\n```\n\nå¤‡æ³¨ï¼š\n\n1) ä½¿ç”¨`${array_name[@]}` æˆ–è€… `${array_name[*]}` éƒ½å¯ä»¥å…¨éƒ¨æ˜¾ç¤ºæ•°ç»„ä¸­çš„å…ƒç´ \n\n2) åŒæ ·é“ç†`${#array_name[@]}` æˆ–è€… `${#array_name[*]}`éƒ½å¯ä»¥ç”¨æ¥æ±‚æ•°ç»„çš„é•¿åº¦\n\n3) æ±‚æ•°ç»„ä¸­å…ƒç´ çš„é•¿åº¦æ–¹æ³•æœ‰å¾ˆå¤šï¼Œç›¸å½“äºæ±‚å­—ç¬¦ä¸²çš„é•¿åº¦\n   \n\n## æ•°ç»„éå†\n\n```shell\nnames=(Jerry Alice David Wendy)\n\n# æ–¹å¼ä¸€ï¼š æŒ‰ç´¢å¼•æ¥éå†\nfor((i=0;i<${#names[@]};i++))\ndo \n    echo ${names[$i]}\ndone\n\n# æ–¹å¼äºŒï¼š ä¸æŒ‰ç´¢å¼•æ¥éå†\nindex=0\nfor name in ${names[@]} \ndo \n    echo \"ç¬¬${index}ä¸ªå…ƒç´ çš„å€¼ä¸ºï¼š==> ${name}\"\n    let index++\ndone\n\n```\n\n## æ•°ç»„èµ‹å€¼\n\n```shell\nnums=(1 2 3 4)  # å®šä¹‰æ•°ç»„\nnums[3]=44      # ç¬¬ä¸‰ä¸ªå…ƒç´ é‡æ–°èµ‹å€¼\necho ${nums[@]} # ç»“æœå˜æˆäº† 1 2 3 44\n```\n\n**å¤‡æ³¨:**\n\n1) ç¬¬ä¸€ç§æ˜¯ç»™å·²ç»å­˜åœ¨çš„å…ƒç´ é¡¹é‡æ–°èµ‹å€¼\n\n2) å½“ç„¶ä¹Ÿå¯ä»¥ç»™ä¸å­˜åœ¨çš„ç´¢å¼•æ·»åŠ èµ‹å€¼ï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹\n\n```shell\n### æ•°ç»„æ·»åŠ å…ƒç´ \n\n# æ–¹å¼-ï¼š ç»™ä¸å­˜åœ¨çš„ç´¢å¼•èµ‹å€¼\nnums=(1 2 3 4)  # å®šä¹‰æ•°ç»„\nnums[4]=5       # ç»™ç¬¬å››ä¸ªæ–°å…ƒç´ èµ‹å€¼\necho ${nums[@]} # ç»“æœå˜æˆäº† 1 2 3 4 5\nnums[8]=8       # ç»™ç¬¬8ä¸ªå…ƒç´ èµ‹å€¼\necho ${nums[@]} # ç»“æœå˜æˆäº† 1 2 3 4 5 8\n\n# æ–¹å¼äºŒï¼š ç›´æ¥ä½¿ç”¨ æ–°æ•°ç»„=(æ—§æ•°ç»„ æ–°å…ƒç´ ) çš„æ–¹æ³•æ·»åŠ å…ƒç´ \nold=(1 2 3 4)\nnew=(${old[*]} 5)\necho ${new[@]}\n```\n\n\n","slug":"Shell/2022-02-25-Shell æ•°ç»„","published":1,"updated":"2024-03-06T11:53:13.563Z","comments":1,"photos":[],"_id":"clti3glki000957wh08s4ev8w","content":"<h1 id=\"Shell-æ•°ç»„\"><a href=\"#Shell-æ•°ç»„\" class=\"headerlink\" title=\"Shell æ•°ç»„\"></a>Shell æ•°ç»„</h1><p>å‚è€ƒï¼š <a href=\"https://blog.csdn.net/Jerry_1126/article/details/52027539\">Shellä¸­çš„æ•°ç»„åŠå…¶ç›¸å…³æ“ä½œ_æ°ç‘çš„ä¸“æ -CSDNåšå®¢</a></p>\n<p>åº”ç”¨åœºæ™¯ï¼š</p>\n<ol>\n<li><p>æ±‚æ•°ç»„çš„é•¿åº¦</p>\n</li>\n<li><p>å…ƒç´ é•¿åº¦</p>\n</li>\n<li><p>éå†æ•°ç»„</p>\n</li>\n<li><p>å…ƒç´ åˆ‡ç‰‡</p>\n</li>\n<li><p>æ›¿æ¢</p>\n</li>\n<li><p>åˆ é™¤</p>\n</li>\n</ol>\n<p>å¤‡æ³¨ï¼š</p>\n<ol>\n<li><p>Shellä¸­çš„æ•°ç»„ä¸åƒJAVA&#x2F;Cï¼Œåªèƒ½æ˜¯ä¸€ç»´æ•°ç»„ï¼Œ æ²¡æœ‰äºŒç»´æ•°ç»„</p>\n</li>\n<li><p>æ•°ç»„å…ƒç´ å¤§å°æ— çº¦æŸï¼Œä¹Ÿæ— éœ€å…ˆå®šä¹‰æ•°ç»„çš„å…ƒç´ ä¸ªæ•°</p>\n</li>\n<li><p>ç´¢å¼•ä»0å¼€å§‹</p>\n</li>\n<li><p>ä¸åƒJAVA&#x2F;Cç­‰å¼ºç¼–ç¨‹è¯­è¨€ï¼Œåœ¨èµ‹å€¼å‰å¿…é¡»å£°æ˜ï¼›SHELLåªæ˜¯å¼±ç¼–ç¨‹è¯­è¨€ï¼Œå¯äº‹å…ˆå£°æ˜ä¹Ÿå¯ä¸å£°æ˜ï¼›</p>\n</li>\n<li><p>ç”¨unsetæ¥æ’¤é”€æ•°ç»„ï¼Œå¯ç”¨unset array_name[i]æ¥åˆ é™¤é‡Œé¢çš„å…ƒç´ </p>\n</li>\n</ol>\n<h2 id=\"å£°æ˜\"><a href=\"#å£°æ˜\" class=\"headerlink\" title=\"å£°æ˜\"></a>å£°æ˜</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">declare -a array_name       # å£°æ˜æ•°ç»„ï¼Œä¹Ÿå¯ä¸å£°æ˜<br>declare -a nums=(1 2 3 4)   # å£°æ˜æ•°ç»„ï¼Œ åŒæ—¶èµ‹å€¼<br>unset array_name            # åˆ é™¤æ•°ç»„ï¼Œæ’¤é”€æ•°ç»„<br>unset nums[0]               # åˆ é™¤æ•°ç»„ä¸­æŸä¸ªå…ƒç´ <br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å®šä¹‰\"><a href=\"#å®šä¹‰\" class=\"headerlink\" title=\"å®šä¹‰\"></a>å®šä¹‰</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼ä¸€ï¼š</span><br>array_names=(<br>value0<br>valuel<br>value2<br>value3<br>)<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼äºŒï¼š</span><br>names=(Jerry Alice David wendy)<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼ä¸‰ï¼š</span><br>names[0]=Jerry<br>names[1]=Alice<br>names[2]=David<br>names[3]=Wendy<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼å››ï¼š</span><br>names=([0]=Jerry [1]=Alice [2]=David [3]=Wendy)<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼äº”ï¼š</span><br>str=&quot;Jerry Alice David Wendy&quot;<br>names=($str)<br></code></pre></td></tr></table></figure>\n\n<p>å¤‡æ³¨ï¼š</p>\n<ol>\n<li><p>æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå¿…é¡»ç”¨â€ç©ºæ ¼â€æ¥éš”å¼€</p>\n</li>\n<li><p>å®šä¹‰æ•°ç»„ç´¢å¼•ï¼Œå¯ä»¥ä¸æŒ‰é¡ºåºæ¥ï¼Œä¾‹å¦‚ï¼Œ<code>names=([0]=Jerry [1]=Alice [2]=David [8]=Wendy)</code></p>\n</li>\n<li><p>å­—ç¬¦ä¸²æ˜¯SHELLä¸­æœ€é‡è¦çš„æ•°æ®ç±»å‹ï¼Œå…¶ä¹Ÿå¯é€šè¿‡<code>($str)</code>æ¥è½¬æˆæ•°ç»„ï¼Œæ“ä½œèµ·æ¥éå¸¸æ–¹ä¾¿</p>\n</li>\n</ol>\n<h2 id=\"æ•°ç»„é•¿åº¦\"><a href=\"#æ•°ç»„é•¿åº¦\" class=\"headerlink\" title=\"æ•°ç»„é•¿åº¦\"></a>æ•°ç»„é•¿åº¦</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">nums=(Jerry Alice David Wendy)<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼1 <span class=\"hljs-variable\">$&#123;#æ•°ç»„å[@]&#125;</span></span><br>~ echo $&#123;#nums[@]&#125;<br>4<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼2 <span class=\"hljs-variable\">$&#123;#æ•°ç»„å[*]&#125;</span></span><br>~ echo $&#123;#nums[*]&#125;<br>4<br></code></pre></td></tr></table></figure>\n\n<p>å¤‡æ³¨ï¼š</p>\n<ol>\n<li><p>ä½¿ç”¨<code>$&#123;array_name[@]&#125;</code> æˆ–è€… <code>$&#123;array_name[*]&#125;</code> éƒ½å¯ä»¥å…¨éƒ¨æ˜¾ç¤ºæ•°ç»„ä¸­çš„å…ƒç´ </p>\n</li>\n<li><p>åŒæ ·é“ç†<code>$&#123;#array_name[@]&#125;</code> æˆ–è€… <code>$&#123;#array_name[*]&#125;</code>éƒ½å¯ä»¥ç”¨æ¥æ±‚æ•°ç»„çš„é•¿åº¦</p>\n</li>\n<li><p>æ±‚æ•°ç»„ä¸­å…ƒç´ çš„é•¿åº¦æ–¹æ³•æœ‰å¾ˆå¤šï¼Œç›¸å½“äºæ±‚å­—ç¬¦ä¸²çš„é•¿åº¦</p>\n</li>\n</ol>\n<h2 id=\"æ•°ç»„éå†\"><a href=\"#æ•°ç»„éå†\" class=\"headerlink\" title=\"æ•°ç»„éå†\"></a>æ•°ç»„éå†</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">names=(Jerry Alice David Wendy)<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">æ–¹å¼ä¸€ï¼š æŒ‰ç´¢å¼•æ¥éå†</span><br>for((i=0;i&lt;$&#123;#names[@]&#125;;i++))<br>do <br>    echo $&#123;names[$i]&#125;<br>done<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">æ–¹å¼äºŒï¼š ä¸æŒ‰ç´¢å¼•æ¥éå†</span><br>index=0<br>for name in $&#123;names[@]&#125; <br>do <br>    echo &quot;ç¬¬$&#123;index&#125;ä¸ªå…ƒç´ çš„å€¼ä¸ºï¼š==&gt; $&#123;name&#125;&quot;<br>    let index++<br>done<br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æ•°ç»„èµ‹å€¼\"><a href=\"#æ•°ç»„èµ‹å€¼\" class=\"headerlink\" title=\"æ•°ç»„èµ‹å€¼\"></a>æ•°ç»„èµ‹å€¼</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">nums=(1 2 3 4)  # å®šä¹‰æ•°ç»„<br>nums[3]=44      # ç¬¬ä¸‰ä¸ªå…ƒç´ é‡æ–°èµ‹å€¼<br>echo $&#123;nums[@]&#125; # ç»“æœå˜æˆäº† 1 2 3 44<br></code></pre></td></tr></table></figure>\n\n<p><strong>å¤‡æ³¨:</strong></p>\n<ol>\n<li><p>ç¬¬ä¸€ç§æ˜¯ç»™å·²ç»å­˜åœ¨çš„å…ƒç´ é¡¹é‡æ–°èµ‹å€¼</p>\n</li>\n<li><p>å½“ç„¶ä¹Ÿå¯ä»¥ç»™ä¸å­˜åœ¨çš„ç´¢å¼•æ·»åŠ èµ‹å€¼ï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹</p>\n</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\"><span class=\"hljs-comment\">## æ•°ç»„æ·»åŠ å…ƒç´ </span></span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">æ–¹å¼-ï¼š ç»™ä¸å­˜åœ¨çš„ç´¢å¼•èµ‹å€¼</span><br>nums=(1 2 3 4)  # å®šä¹‰æ•°ç»„<br>nums[4]=5       # ç»™ç¬¬å››ä¸ªæ–°å…ƒç´ èµ‹å€¼<br>echo $&#123;nums[@]&#125; # ç»“æœå˜æˆäº† 1 2 3 4 5<br>nums[8]=8       # ç»™ç¬¬8ä¸ªå…ƒç´ èµ‹å€¼<br>echo $&#123;nums[@]&#125; # ç»“æœå˜æˆäº† 1 2 3 4 5 8<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">æ–¹å¼äºŒï¼š ç›´æ¥ä½¿ç”¨ æ–°æ•°ç»„=(æ—§æ•°ç»„ æ–°å…ƒç´ ) çš„æ–¹æ³•æ·»åŠ å…ƒç´ </span><br>old=(1 2 3 4)<br>new=($&#123;old[*]&#125; 5)<br>echo $&#123;new[@]&#125;<br></code></pre></td></tr></table></figure>\n\n\n","excerpt":"","more":"<h1 id=\"Shell-æ•°ç»„\"><a href=\"#Shell-æ•°ç»„\" class=\"headerlink\" title=\"Shell æ•°ç»„\"></a>Shell æ•°ç»„</h1><p>å‚è€ƒï¼š <a href=\"https://blog.csdn.net/Jerry_1126/article/details/52027539\">Shellä¸­çš„æ•°ç»„åŠå…¶ç›¸å…³æ“ä½œ_æ°ç‘çš„ä¸“æ -CSDNåšå®¢</a></p>\n<p>åº”ç”¨åœºæ™¯ï¼š</p>\n<ol>\n<li><p>æ±‚æ•°ç»„çš„é•¿åº¦</p>\n</li>\n<li><p>å…ƒç´ é•¿åº¦</p>\n</li>\n<li><p>éå†æ•°ç»„</p>\n</li>\n<li><p>å…ƒç´ åˆ‡ç‰‡</p>\n</li>\n<li><p>æ›¿æ¢</p>\n</li>\n<li><p>åˆ é™¤</p>\n</li>\n</ol>\n<p>å¤‡æ³¨ï¼š</p>\n<ol>\n<li><p>Shellä¸­çš„æ•°ç»„ä¸åƒJAVA&#x2F;Cï¼Œåªèƒ½æ˜¯ä¸€ç»´æ•°ç»„ï¼Œ æ²¡æœ‰äºŒç»´æ•°ç»„</p>\n</li>\n<li><p>æ•°ç»„å…ƒç´ å¤§å°æ— çº¦æŸï¼Œä¹Ÿæ— éœ€å…ˆå®šä¹‰æ•°ç»„çš„å…ƒç´ ä¸ªæ•°</p>\n</li>\n<li><p>ç´¢å¼•ä»0å¼€å§‹</p>\n</li>\n<li><p>ä¸åƒJAVA&#x2F;Cç­‰å¼ºç¼–ç¨‹è¯­è¨€ï¼Œåœ¨èµ‹å€¼å‰å¿…é¡»å£°æ˜ï¼›SHELLåªæ˜¯å¼±ç¼–ç¨‹è¯­è¨€ï¼Œå¯äº‹å…ˆå£°æ˜ä¹Ÿå¯ä¸å£°æ˜ï¼›</p>\n</li>\n<li><p>ç”¨unsetæ¥æ’¤é”€æ•°ç»„ï¼Œå¯ç”¨unset array_name[i]æ¥åˆ é™¤é‡Œé¢çš„å…ƒç´ </p>\n</li>\n</ol>\n<h2 id=\"å£°æ˜\"><a href=\"#å£°æ˜\" class=\"headerlink\" title=\"å£°æ˜\"></a>å£°æ˜</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">declare -a array_name       # å£°æ˜æ•°ç»„ï¼Œä¹Ÿå¯ä¸å£°æ˜<br>declare -a nums=(1 2 3 4)   # å£°æ˜æ•°ç»„ï¼Œ åŒæ—¶èµ‹å€¼<br>unset array_name            # åˆ é™¤æ•°ç»„ï¼Œæ’¤é”€æ•°ç»„<br>unset nums[0]               # åˆ é™¤æ•°ç»„ä¸­æŸä¸ªå…ƒç´ <br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å®šä¹‰\"><a href=\"#å®šä¹‰\" class=\"headerlink\" title=\"å®šä¹‰\"></a>å®šä¹‰</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼ä¸€ï¼š</span><br>array_names=(<br>value0<br>valuel<br>value2<br>value3<br>)<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼äºŒï¼š</span><br>names=(Jerry Alice David wendy)<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼ä¸‰ï¼š</span><br>names[0]=Jerry<br>names[1]=Alice<br>names[2]=David<br>names[3]=Wendy<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼å››ï¼š</span><br>names=([0]=Jerry [1]=Alice [2]=David [3]=Wendy)<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼äº”ï¼š</span><br>str=&quot;Jerry Alice David Wendy&quot;<br>names=($str)<br></code></pre></td></tr></table></figure>\n\n<p>å¤‡æ³¨ï¼š</p>\n<ol>\n<li><p>æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå¿…é¡»ç”¨â€ç©ºæ ¼â€æ¥éš”å¼€</p>\n</li>\n<li><p>å®šä¹‰æ•°ç»„ç´¢å¼•ï¼Œå¯ä»¥ä¸æŒ‰é¡ºåºæ¥ï¼Œä¾‹å¦‚ï¼Œ<code>names=([0]=Jerry [1]=Alice [2]=David [8]=Wendy)</code></p>\n</li>\n<li><p>å­—ç¬¦ä¸²æ˜¯SHELLä¸­æœ€é‡è¦çš„æ•°æ®ç±»å‹ï¼Œå…¶ä¹Ÿå¯é€šè¿‡<code>($str)</code>æ¥è½¬æˆæ•°ç»„ï¼Œæ“ä½œèµ·æ¥éå¸¸æ–¹ä¾¿</p>\n</li>\n</ol>\n<h2 id=\"æ•°ç»„é•¿åº¦\"><a href=\"#æ•°ç»„é•¿åº¦\" class=\"headerlink\" title=\"æ•°ç»„é•¿åº¦\"></a>æ•°ç»„é•¿åº¦</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">nums=(Jerry Alice David Wendy)<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼1 <span class=\"hljs-variable\">$&#123;#æ•°ç»„å[@]&#125;</span></span><br>~ echo $&#123;#nums[@]&#125;<br>4<br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">æ–¹å¼2 <span class=\"hljs-variable\">$&#123;#æ•°ç»„å[*]&#125;</span></span><br>~ echo $&#123;#nums[*]&#125;<br>4<br></code></pre></td></tr></table></figure>\n\n<p>å¤‡æ³¨ï¼š</p>\n<ol>\n<li><p>ä½¿ç”¨<code>$&#123;array_name[@]&#125;</code> æˆ–è€… <code>$&#123;array_name[*]&#125;</code> éƒ½å¯ä»¥å…¨éƒ¨æ˜¾ç¤ºæ•°ç»„ä¸­çš„å…ƒç´ </p>\n</li>\n<li><p>åŒæ ·é“ç†<code>$&#123;#array_name[@]&#125;</code> æˆ–è€… <code>$&#123;#array_name[*]&#125;</code>éƒ½å¯ä»¥ç”¨æ¥æ±‚æ•°ç»„çš„é•¿åº¦</p>\n</li>\n<li><p>æ±‚æ•°ç»„ä¸­å…ƒç´ çš„é•¿åº¦æ–¹æ³•æœ‰å¾ˆå¤šï¼Œç›¸å½“äºæ±‚å­—ç¬¦ä¸²çš„é•¿åº¦</p>\n</li>\n</ol>\n<h2 id=\"æ•°ç»„éå†\"><a href=\"#æ•°ç»„éå†\" class=\"headerlink\" title=\"æ•°ç»„éå†\"></a>æ•°ç»„éå†</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">names=(Jerry Alice David Wendy)<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">æ–¹å¼ä¸€ï¼š æŒ‰ç´¢å¼•æ¥éå†</span><br>for((i=0;i&lt;$&#123;#names[@]&#125;;i++))<br>do <br>    echo $&#123;names[$i]&#125;<br>done<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">æ–¹å¼äºŒï¼š ä¸æŒ‰ç´¢å¼•æ¥éå†</span><br>index=0<br>for name in $&#123;names[@]&#125; <br>do <br>    echo &quot;ç¬¬$&#123;index&#125;ä¸ªå…ƒç´ çš„å€¼ä¸ºï¼š==&gt; $&#123;name&#125;&quot;<br>    let index++<br>done<br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æ•°ç»„èµ‹å€¼\"><a href=\"#æ•°ç»„èµ‹å€¼\" class=\"headerlink\" title=\"æ•°ç»„èµ‹å€¼\"></a>æ•°ç»„èµ‹å€¼</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">nums=(1 2 3 4)  # å®šä¹‰æ•°ç»„<br>nums[3]=44      # ç¬¬ä¸‰ä¸ªå…ƒç´ é‡æ–°èµ‹å€¼<br>echo $&#123;nums[@]&#125; # ç»“æœå˜æˆäº† 1 2 3 44<br></code></pre></td></tr></table></figure>\n\n<p><strong>å¤‡æ³¨:</strong></p>\n<ol>\n<li><p>ç¬¬ä¸€ç§æ˜¯ç»™å·²ç»å­˜åœ¨çš„å…ƒç´ é¡¹é‡æ–°èµ‹å€¼</p>\n</li>\n<li><p>å½“ç„¶ä¹Ÿå¯ä»¥ç»™ä¸å­˜åœ¨çš„ç´¢å¼•æ·»åŠ èµ‹å€¼ï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹</p>\n</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\"><span class=\"hljs-comment\">## æ•°ç»„æ·»åŠ å…ƒç´ </span></span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">æ–¹å¼-ï¼š ç»™ä¸å­˜åœ¨çš„ç´¢å¼•èµ‹å€¼</span><br>nums=(1 2 3 4)  # å®šä¹‰æ•°ç»„<br>nums[4]=5       # ç»™ç¬¬å››ä¸ªæ–°å…ƒç´ èµ‹å€¼<br>echo $&#123;nums[@]&#125; # ç»“æœå˜æˆäº† 1 2 3 4 5<br>nums[8]=8       # ç»™ç¬¬8ä¸ªå…ƒç´ èµ‹å€¼<br>echo $&#123;nums[@]&#125; # ç»“æœå˜æˆäº† 1 2 3 4 5 8<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">æ–¹å¼äºŒï¼š ç›´æ¥ä½¿ç”¨ æ–°æ•°ç»„=(æ—§æ•°ç»„ æ–°å…ƒç´ ) çš„æ–¹æ³•æ·»åŠ å…ƒç´ </span><br>old=(1 2 3 4)<br>new=($&#123;old[*]&#125; 5)<br>echo $&#123;new[@]&#125;<br></code></pre></td></tr></table></figure>\n\n\n"},{"layout":"post","title":"Shell å‡½æ•°","date":"2022-02-24T16:00:00.000Z","_content":"  \n\n# shell å‡½æ•°\n\nè¯­æ³•\n\n```shell\nfunction_name () { \n   list of commands\n}\n```\n\nç¤ºä¾‹\n\n```shell\n#!/bin/sh\n\n# Define your function here\nHello () {\n   echo \"Hello World\"\n}\n\n# Invoke your function\nHello\n```\n\n## å‡½æ•°ä¼ å‚\n\nå‡½æ•°ä¼ å‚ç±»ä¼¼äºè„šæœ¬ä¼ å‚`$1, $2..$n`\n\n```shell\n#!/bin/sh\n\n# Define your function here\nHello () {\n   echo \"Hello World $1 $2\"\n}\n\n# Invoke your function\nHello Zara Ali\n```\n\n## è¿”å›å€¼\n\n```shell\n#!/bin/sh\n\n# Define your function here\nHello () {\n   echo \"Hello World $1 $2\"\n   return 10\n}\n\n# Invoke your function\nHello Zara Ali\n\n# Capture value returnd by last command\nret=$?\n\necho \"Return value is $ret\"\n```\n\n## å‡½æ•°åµŒå¥—\n\n```shell\n\n#!/bin/sh\n\n# Calling one function from another\nnumber_one () {\n   echo \"This is the first function speaking...\"\n   number_two\n}\n\nnumber_two () {\n   echo \"This is now the second function speaking...\"\n}\n\n# Calling function one.\nnumber_one\n\n```\n","source":"_posts/Shell/2022-02-25-shell å‡½æ•°.md","raw":"---\nlayout: post\ntitle: \"Shell å‡½æ•°\"\ndate: 2022-02-25 \ntag: Shell\n---  \n\n# shell å‡½æ•°\n\nè¯­æ³•\n\n```shell\nfunction_name () { \n   list of commands\n}\n```\n\nç¤ºä¾‹\n\n```shell\n#!/bin/sh\n\n# Define your function here\nHello () {\n   echo \"Hello World\"\n}\n\n# Invoke your function\nHello\n```\n\n## å‡½æ•°ä¼ å‚\n\nå‡½æ•°ä¼ å‚ç±»ä¼¼äºè„šæœ¬ä¼ å‚`$1, $2..$n`\n\n```shell\n#!/bin/sh\n\n# Define your function here\nHello () {\n   echo \"Hello World $1 $2\"\n}\n\n# Invoke your function\nHello Zara Ali\n```\n\n## è¿”å›å€¼\n\n```shell\n#!/bin/sh\n\n# Define your function here\nHello () {\n   echo \"Hello World $1 $2\"\n   return 10\n}\n\n# Invoke your function\nHello Zara Ali\n\n# Capture value returnd by last command\nret=$?\n\necho \"Return value is $ret\"\n```\n\n## å‡½æ•°åµŒå¥—\n\n```shell\n\n#!/bin/sh\n\n# Calling one function from another\nnumber_one () {\n   echo \"This is the first function speaking...\"\n   number_two\n}\n\nnumber_two () {\n   echo \"This is now the second function speaking...\"\n}\n\n# Calling function one.\nnumber_one\n\n```\n","slug":"Shell/2022-02-25-shell å‡½æ•°","published":1,"updated":"2024-03-06T11:53:13.563Z","comments":1,"photos":[],"_id":"clti3glkj000a57wh1vhf9zb8","content":"<h1 id=\"shell-å‡½æ•°\"><a href=\"#shell-å‡½æ•°\" class=\"headerlink\" title=\"shell å‡½æ•°\"></a>shell å‡½æ•°</h1><p>è¯­æ³•</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">function_name () &#123; <br>   list of commands<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ç¤ºä¾‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Define your <span class=\"hljs-keyword\">function</span> here</span><br>Hello () &#123;<br>   echo &quot;Hello World&quot;<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Invoke your <span class=\"hljs-keyword\">function</span></span><br>Hello<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å‡½æ•°ä¼ å‚\"><a href=\"#å‡½æ•°ä¼ å‚\" class=\"headerlink\" title=\"å‡½æ•°ä¼ å‚\"></a>å‡½æ•°ä¼ å‚</h2><p>å‡½æ•°ä¼ å‚ç±»ä¼¼äºè„šæœ¬ä¼ å‚<code>$1, $2..$n</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Define your <span class=\"hljs-keyword\">function</span> here</span><br>Hello () &#123;<br>   echo &quot;Hello World $1 $2&quot;<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Invoke your <span class=\"hljs-keyword\">function</span></span><br>Hello Zara Ali<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"è¿”å›å€¼\"><a href=\"#è¿”å›å€¼\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Define your <span class=\"hljs-keyword\">function</span> here</span><br>Hello () &#123;<br>   echo &quot;Hello World $1 $2&quot;<br>   return 10<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Invoke your <span class=\"hljs-keyword\">function</span></span><br>Hello Zara Ali<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Capture value returnd by last <span class=\"hljs-built_in\">command</span></span><br>ret=$?<br><br>echo &quot;Return value is $ret&quot;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å‡½æ•°åµŒå¥—\"><a href=\"#å‡½æ•°åµŒå¥—\" class=\"headerlink\" title=\"å‡½æ•°åµŒå¥—\"></a>å‡½æ•°åµŒå¥—</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Calling one <span class=\"hljs-keyword\">function</span> from another</span><br>number_one () &#123;<br>   echo &quot;This is the first function speaking...&quot;<br>   number_two<br>&#125;<br><br>number_two () &#123;<br>   echo &quot;This is now the second function speaking...&quot;<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Calling <span class=\"hljs-keyword\">function</span> one.</span><br>number_one<br><br></code></pre></td></tr></table></figure>\n","excerpt":"","more":"<h1 id=\"shell-å‡½æ•°\"><a href=\"#shell-å‡½æ•°\" class=\"headerlink\" title=\"shell å‡½æ•°\"></a>shell å‡½æ•°</h1><p>è¯­æ³•</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">function_name () &#123; <br>   list of commands<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ç¤ºä¾‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Define your <span class=\"hljs-keyword\">function</span> here</span><br>Hello () &#123;<br>   echo &quot;Hello World&quot;<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Invoke your <span class=\"hljs-keyword\">function</span></span><br>Hello<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å‡½æ•°ä¼ å‚\"><a href=\"#å‡½æ•°ä¼ å‚\" class=\"headerlink\" title=\"å‡½æ•°ä¼ å‚\"></a>å‡½æ•°ä¼ å‚</h2><p>å‡½æ•°ä¼ å‚ç±»ä¼¼äºè„šæœ¬ä¼ å‚<code>$1, $2..$n</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Define your <span class=\"hljs-keyword\">function</span> here</span><br>Hello () &#123;<br>   echo &quot;Hello World $1 $2&quot;<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Invoke your <span class=\"hljs-keyword\">function</span></span><br>Hello Zara Ali<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"è¿”å›å€¼\"><a href=\"#è¿”å›å€¼\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Define your <span class=\"hljs-keyword\">function</span> here</span><br>Hello () &#123;<br>   echo &quot;Hello World $1 $2&quot;<br>   return 10<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Invoke your <span class=\"hljs-keyword\">function</span></span><br>Hello Zara Ali<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Capture value returnd by last <span class=\"hljs-built_in\">command</span></span><br>ret=$?<br><br>echo &quot;Return value is $ret&quot;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å‡½æ•°åµŒå¥—\"><a href=\"#å‡½æ•°åµŒå¥—\" class=\"headerlink\" title=\"å‡½æ•°åµŒå¥—\"></a>å‡½æ•°åµŒå¥—</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Calling one <span class=\"hljs-keyword\">function</span> from another</span><br>number_one () &#123;<br>   echo &quot;This is the first function speaking...&quot;<br>   number_two<br>&#125;<br><br>number_two () &#123;<br>   echo &quot;This is now the second function speaking...&quot;<br>&#125;<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">Calling <span class=\"hljs-keyword\">function</span> one.</span><br>number_one<br><br></code></pre></td></tr></table></figure>\n"},{"layout":"post","title":"Shell å¾ªç¯è¯­å¥","date":"2022-02-24T16:00:00.000Z","_content":"  \n\n# shell å¾ªç¯è¯­å¥\n\n## while å¾ªç¯\n\nwhile å¾ªç¯å¯ä»¥åµŒå¥—ï¼Œè¯­æ³•å¦‚ä¸‹\n\n```shell\nwhile command1 ; # this is loop1, the outer loop\ndo\n   Statement(s) to be executed if command1 is true\n\n   while command2 ; # this is loop2, the inner loop\n   do\n      Statement(s) to be executed if command2 is true\n   done\n\n   Statement(s) to be executed if command1 is true\ndone\n```\n\nç¤ºä¾‹\n\n```shell\n#!/bin/sh\n\na=0\nwhile [ \"$a\" -lt 10 ]    # this is loop1\ndo\n   b=\"$a\"\n   while [ \"$b\" -ge 0 ]  # this is loop2\n   do\n      echo -n \"$b \"\n      b=`expr $b - 1`\n   done\n   echo\n   a=`expr $a + 1`\ndone\n```\n\n## break/continue\n\nè¯­æ³•\n\n```shell\nbreak       #è·³å‡ºå½“å‰å¾ªç¯\nbreak n     #è·³å‡ºå¤šé‡å¾ªç¯\n\ncontinue    #å½“å‰å¾ªç¯ continue\ncontinue n  #næŒ‡å®šçš„å¤–å±‚å¾ªç¯ continue\n```\n\nè·³å‡ºå½“å‰å¾ªç¯\n\n```shell\n#!/bin/sh\n\na=0\n\nwhile [ $a -lt 10 ]\ndo\n   echo $a\n   if [ $a -eq 5 ]\n   then\n      break\n   fi\n   a=`expr $a + 1`\ndone\n```\n\nè·³å‡ºå¤–å±‚å¾ªç¯\n\n```shell\n#!/bin/sh\n\nfor var1 in 1 2 3\ndo\n   for var2 in 0 5\n   do\n      if [ $var1 -eq 2 -a $var2 -eq 0 ]\n      then\n         break 2\n      else\n         echo \"$var1 $var2\"\n      fi\n   done\ndone\n```\n\n## for å¾ªç¯\n\n```shell\n#!/bin/sh\n\nNUMS=\"1 2 3 4 5 6 7\"\n\nfor NUM in $NUMS\ndo\n   Q=`expr $NUM % 2`\n   if [ $Q -eq 0 ]\n   then\n      echo \"Number is an even number!!\"\n      continue\n   fi\n   echo \"Found odd number\"\ndone\n```\n\n## until å¾ªç¯\n\n```shell\n#!/bin/sh\n\na=10\n\nuntil [ $a -lt 10 ]\ndo\n   echo $a\n   a=`expr $a + 1`\ndone\n```\n\n\n","source":"_posts/Shell/2022-02-25-shell å¾ªç¯è¯­å¥.md","raw":"---\nlayout: post\ntitle: \"Shell å¾ªç¯è¯­å¥\"\ndate: 2022-02-25 \ntag: Shell\n---  \n\n# shell å¾ªç¯è¯­å¥\n\n## while å¾ªç¯\n\nwhile å¾ªç¯å¯ä»¥åµŒå¥—ï¼Œè¯­æ³•å¦‚ä¸‹\n\n```shell\nwhile command1 ; # this is loop1, the outer loop\ndo\n   Statement(s) to be executed if command1 is true\n\n   while command2 ; # this is loop2, the inner loop\n   do\n      Statement(s) to be executed if command2 is true\n   done\n\n   Statement(s) to be executed if command1 is true\ndone\n```\n\nç¤ºä¾‹\n\n```shell\n#!/bin/sh\n\na=0\nwhile [ \"$a\" -lt 10 ]    # this is loop1\ndo\n   b=\"$a\"\n   while [ \"$b\" -ge 0 ]  # this is loop2\n   do\n      echo -n \"$b \"\n      b=`expr $b - 1`\n   done\n   echo\n   a=`expr $a + 1`\ndone\n```\n\n## break/continue\n\nè¯­æ³•\n\n```shell\nbreak       #è·³å‡ºå½“å‰å¾ªç¯\nbreak n     #è·³å‡ºå¤šé‡å¾ªç¯\n\ncontinue    #å½“å‰å¾ªç¯ continue\ncontinue n  #næŒ‡å®šçš„å¤–å±‚å¾ªç¯ continue\n```\n\nè·³å‡ºå½“å‰å¾ªç¯\n\n```shell\n#!/bin/sh\n\na=0\n\nwhile [ $a -lt 10 ]\ndo\n   echo $a\n   if [ $a -eq 5 ]\n   then\n      break\n   fi\n   a=`expr $a + 1`\ndone\n```\n\nè·³å‡ºå¤–å±‚å¾ªç¯\n\n```shell\n#!/bin/sh\n\nfor var1 in 1 2 3\ndo\n   for var2 in 0 5\n   do\n      if [ $var1 -eq 2 -a $var2 -eq 0 ]\n      then\n         break 2\n      else\n         echo \"$var1 $var2\"\n      fi\n   done\ndone\n```\n\n## for å¾ªç¯\n\n```shell\n#!/bin/sh\n\nNUMS=\"1 2 3 4 5 6 7\"\n\nfor NUM in $NUMS\ndo\n   Q=`expr $NUM % 2`\n   if [ $Q -eq 0 ]\n   then\n      echo \"Number is an even number!!\"\n      continue\n   fi\n   echo \"Found odd number\"\ndone\n```\n\n## until å¾ªç¯\n\n```shell\n#!/bin/sh\n\na=10\n\nuntil [ $a -lt 10 ]\ndo\n   echo $a\n   a=`expr $a + 1`\ndone\n```\n\n\n","slug":"Shell/2022-02-25-shell å¾ªç¯è¯­å¥","published":1,"updated":"2024-03-06T11:53:13.563Z","comments":1,"photos":[],"_id":"clti3glkj000d57wh44us7od4","content":"<h1 id=\"shell-å¾ªç¯è¯­å¥\"><a href=\"#shell-å¾ªç¯è¯­å¥\" class=\"headerlink\" title=\"shell å¾ªç¯è¯­å¥\"></a>shell å¾ªç¯è¯­å¥</h1><h2 id=\"while-å¾ªç¯\"><a href=\"#while-å¾ªç¯\" class=\"headerlink\" title=\"while å¾ªç¯\"></a>while å¾ªç¯</h2><p>while å¾ªç¯å¯ä»¥åµŒå¥—ï¼Œè¯­æ³•å¦‚ä¸‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">while command1 ; # this is loop1, the outer loop<br>do<br>   Statement(s) to be executed if command1 is true<br><br>   while command2 ; # this is loop2, the inner loop<br>   do<br>      Statement(s) to be executed if command2 is true<br>   done<br><br>   Statement(s) to be executed if command1 is true<br>done<br></code></pre></td></tr></table></figure>\n\n<p>ç¤ºä¾‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>a=0<br>while [ &quot;$a&quot; -lt 10 ]    # this is loop1<br>do<br>   b=&quot;$a&quot;<br>   while [ &quot;$b&quot; -ge 0 ]  # this is loop2<br>   do<br>      echo -n &quot;$b &quot;<br>      b=`expr $b - 1`<br>   done<br>   echo<br>   a=`expr $a + 1`<br>done<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"break-continue\"><a href=\"#break-continue\" class=\"headerlink\" title=\"break&#x2F;continue\"></a>break&#x2F;continue</h2><p>è¯­æ³•</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">break       #è·³å‡ºå½“å‰å¾ªç¯<br>break n     #è·³å‡ºå¤šé‡å¾ªç¯<br><br>continue    #å½“å‰å¾ªç¯ continue<br>continue n  #næŒ‡å®šçš„å¤–å±‚å¾ªç¯ continue<br></code></pre></td></tr></table></figure>\n\n<p>è·³å‡ºå½“å‰å¾ªç¯</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>a=0<br><br>while [ $a -lt 10 ]<br>do<br>   echo $a<br>   if [ $a -eq 5 ]<br>   then<br>      break<br>   fi<br>   a=`expr $a + 1`<br>done<br></code></pre></td></tr></table></figure>\n\n<p>è·³å‡ºå¤–å±‚å¾ªç¯</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>for var1 in 1 2 3<br>do<br>   for var2 in 0 5<br>   do<br>      if [ $var1 -eq 2 -a $var2 -eq 0 ]<br>      then<br>         break 2<br>      else<br>         echo &quot;$var1 $var2&quot;<br>      fi<br>   done<br>done<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"for-å¾ªç¯\"><a href=\"#for-å¾ªç¯\" class=\"headerlink\" title=\"for å¾ªç¯\"></a>for å¾ªç¯</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>NUMS=&quot;1 2 3 4 5 6 7&quot;<br><br>for NUM in $NUMS<br>do<br>   Q=`expr $NUM % 2`<br>   if [ $Q -eq 0 ]<br>   then<br>      echo &quot;Number is an even number!!&quot;<br>      continue<br>   fi<br>   echo &quot;Found odd number&quot;<br>done<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"until-å¾ªç¯\"><a href=\"#until-å¾ªç¯\" class=\"headerlink\" title=\"until å¾ªç¯\"></a>until å¾ªç¯</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>a=10<br><br>until [ $a -lt 10 ]<br>do<br>   echo $a<br>   a=`expr $a + 1`<br>done<br></code></pre></td></tr></table></figure>\n\n\n","excerpt":"","more":"<h1 id=\"shell-å¾ªç¯è¯­å¥\"><a href=\"#shell-å¾ªç¯è¯­å¥\" class=\"headerlink\" title=\"shell å¾ªç¯è¯­å¥\"></a>shell å¾ªç¯è¯­å¥</h1><h2 id=\"while-å¾ªç¯\"><a href=\"#while-å¾ªç¯\" class=\"headerlink\" title=\"while å¾ªç¯\"></a>while å¾ªç¯</h2><p>while å¾ªç¯å¯ä»¥åµŒå¥—ï¼Œè¯­æ³•å¦‚ä¸‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">while command1 ; # this is loop1, the outer loop<br>do<br>   Statement(s) to be executed if command1 is true<br><br>   while command2 ; # this is loop2, the inner loop<br>   do<br>      Statement(s) to be executed if command2 is true<br>   done<br><br>   Statement(s) to be executed if command1 is true<br>done<br></code></pre></td></tr></table></figure>\n\n<p>ç¤ºä¾‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>a=0<br>while [ &quot;$a&quot; -lt 10 ]    # this is loop1<br>do<br>   b=&quot;$a&quot;<br>   while [ &quot;$b&quot; -ge 0 ]  # this is loop2<br>   do<br>      echo -n &quot;$b &quot;<br>      b=`expr $b - 1`<br>   done<br>   echo<br>   a=`expr $a + 1`<br>done<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"break-continue\"><a href=\"#break-continue\" class=\"headerlink\" title=\"break&#x2F;continue\"></a>break&#x2F;continue</h2><p>è¯­æ³•</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">break       #è·³å‡ºå½“å‰å¾ªç¯<br>break n     #è·³å‡ºå¤šé‡å¾ªç¯<br><br>continue    #å½“å‰å¾ªç¯ continue<br>continue n  #næŒ‡å®šçš„å¤–å±‚å¾ªç¯ continue<br></code></pre></td></tr></table></figure>\n\n<p>è·³å‡ºå½“å‰å¾ªç¯</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>a=0<br><br>while [ $a -lt 10 ]<br>do<br>   echo $a<br>   if [ $a -eq 5 ]<br>   then<br>      break<br>   fi<br>   a=`expr $a + 1`<br>done<br></code></pre></td></tr></table></figure>\n\n<p>è·³å‡ºå¤–å±‚å¾ªç¯</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>for var1 in 1 2 3<br>do<br>   for var2 in 0 5<br>   do<br>      if [ $var1 -eq 2 -a $var2 -eq 0 ]<br>      then<br>         break 2<br>      else<br>         echo &quot;$var1 $var2&quot;<br>      fi<br>   done<br>done<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"for-å¾ªç¯\"><a href=\"#for-å¾ªç¯\" class=\"headerlink\" title=\"for å¾ªç¯\"></a>for å¾ªç¯</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>NUMS=&quot;1 2 3 4 5 6 7&quot;<br><br>for NUM in $NUMS<br>do<br>   Q=`expr $NUM % 2`<br>   if [ $Q -eq 0 ]<br>   then<br>      echo &quot;Number is an even number!!&quot;<br>      continue<br>   fi<br>   echo &quot;Found odd number&quot;<br>done<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"until-å¾ªç¯\"><a href=\"#until-å¾ªç¯\" class=\"headerlink\" title=\"until å¾ªç¯\"></a>until å¾ªç¯</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>a=10<br><br>until [ $a -lt 10 ]<br>do<br>   echo $a<br>   a=`expr $a + 1`<br>done<br></code></pre></td></tr></table></figure>\n\n\n"},{"layout":"post","title":"Shell æ¡ä»¶è¯­å¥","date":"2022-02-24T16:00:00.000Z","_content":"  \n\n# shell æ¡ä»¶è¯­å¥\n\n# if\n\n```shell\nif test-commands; then\n  consequent-commands;\n[elif more-test-commands; then\n  more-consequents;]\n[else alternate-consequents;]\nfi\n```\n\n## case\n\n```shell\ncase word in\n    [ [(] pattern [| pattern]â€¦) command-list ;;]â€¦\nesac\n```\n\nç¤ºä¾‹\n\n```shell\necho -n \"Enter the name of an animal: \"\nread ANIMAL\necho -n \"The $ANIMAL has \"\ncase $ANIMAL in\n  horse | dog | cat) echo -n \"four\";;\n  man | kangaroo ) echo -n \"two\";;\n  *) echo -n \"an unknown number of\";;\nesac\necho \" legs.\"\n```\n\nå¤‡æ³¨ï¼š\n\n1. `*)`ç›¸å½“äºå…¶ä»–è¯­è¨€çš„default\n\n2. `;;`ç›¸å½“äºbreakï¼Œ `;&`ç›¸å½“äºfall through\n\n3. `|`åˆ†å‰²å¤šä¸ªæ¨¡å¼ï¼Œç›¸å½“äºor\n","source":"_posts/Shell/2022-02-25-shell æ¡ä»¶è¯­å¥.md","raw":"---\nlayout: post\ntitle: \"Shell æ¡ä»¶è¯­å¥\"\ndate: 2022-02-25 \ntag: Shell\n---  \n\n# shell æ¡ä»¶è¯­å¥\n\n# if\n\n```shell\nif test-commands; then\n  consequent-commands;\n[elif more-test-commands; then\n  more-consequents;]\n[else alternate-consequents;]\nfi\n```\n\n## case\n\n```shell\ncase word in\n    [ [(] pattern [| pattern]â€¦) command-list ;;]â€¦\nesac\n```\n\nç¤ºä¾‹\n\n```shell\necho -n \"Enter the name of an animal: \"\nread ANIMAL\necho -n \"The $ANIMAL has \"\ncase $ANIMAL in\n  horse | dog | cat) echo -n \"four\";;\n  man | kangaroo ) echo -n \"two\";;\n  *) echo -n \"an unknown number of\";;\nesac\necho \" legs.\"\n```\n\nå¤‡æ³¨ï¼š\n\n1. `*)`ç›¸å½“äºå…¶ä»–è¯­è¨€çš„default\n\n2. `;;`ç›¸å½“äºbreakï¼Œ `;&`ç›¸å½“äºfall through\n\n3. `|`åˆ†å‰²å¤šä¸ªæ¨¡å¼ï¼Œç›¸å½“äºor\n","slug":"Shell/2022-02-25-shell æ¡ä»¶è¯­å¥","published":1,"updated":"2024-03-06T11:53:13.563Z","comments":1,"photos":[],"_id":"clti3glkj000f57wh0glv8o4j","content":"<h1 id=\"shell-æ¡ä»¶è¯­å¥\"><a href=\"#shell-æ¡ä»¶è¯­å¥\" class=\"headerlink\" title=\"shell æ¡ä»¶è¯­å¥\"></a>shell æ¡ä»¶è¯­å¥</h1><h1 id=\"if\"><a href=\"#if\" class=\"headerlink\" title=\"if\"></a>if</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">if test-commands; then<br>  consequent-commands;<br>[elif more-test-commands; then<br>  more-consequents;]<br>[else alternate-consequents;]<br>fi<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"case\"><a href=\"#case\" class=\"headerlink\" title=\"case\"></a>case</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">case word in<br>    [ [(] pattern [| pattern]â€¦) command-list ;;]â€¦<br>esac<br></code></pre></td></tr></table></figure>\n\n<p>ç¤ºä¾‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">echo -n &quot;Enter the name of an animal: &quot;<br>read ANIMAL<br>echo -n &quot;The $ANIMAL has &quot;<br>case $ANIMAL in<br>  horse | dog | cat) echo -n &quot;four&quot;;;<br>  man | kangaroo ) echo -n &quot;two&quot;;;<br>  *) echo -n &quot;an unknown number of&quot;;;<br>esac<br>echo &quot; legs.&quot;<br></code></pre></td></tr></table></figure>\n\n<p>å¤‡æ³¨ï¼š</p>\n<ol>\n<li><p><code>*)</code>ç›¸å½“äºå…¶ä»–è¯­è¨€çš„default</p>\n</li>\n<li><p><code>;;</code>ç›¸å½“äºbreakï¼Œ <code>;&amp;</code>ç›¸å½“äºfall through</p>\n</li>\n<li><p><code>|</code>åˆ†å‰²å¤šä¸ªæ¨¡å¼ï¼Œç›¸å½“äºor</p>\n</li>\n</ol>\n","excerpt":"","more":"<h1 id=\"shell-æ¡ä»¶è¯­å¥\"><a href=\"#shell-æ¡ä»¶è¯­å¥\" class=\"headerlink\" title=\"shell æ¡ä»¶è¯­å¥\"></a>shell æ¡ä»¶è¯­å¥</h1><h1 id=\"if\"><a href=\"#if\" class=\"headerlink\" title=\"if\"></a>if</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">if test-commands; then<br>  consequent-commands;<br>[elif more-test-commands; then<br>  more-consequents;]<br>[else alternate-consequents;]<br>fi<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"case\"><a href=\"#case\" class=\"headerlink\" title=\"case\"></a>case</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">case word in<br>    [ [(] pattern [| pattern]â€¦) command-list ;;]â€¦<br>esac<br></code></pre></td></tr></table></figure>\n\n<p>ç¤ºä¾‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">echo -n &quot;Enter the name of an animal: &quot;<br>read ANIMAL<br>echo -n &quot;The $ANIMAL has &quot;<br>case $ANIMAL in<br>  horse | dog | cat) echo -n &quot;four&quot;;;<br>  man | kangaroo ) echo -n &quot;two&quot;;;<br>  *) echo -n &quot;an unknown number of&quot;;;<br>esac<br>echo &quot; legs.&quot;<br></code></pre></td></tr></table></figure>\n\n<p>å¤‡æ³¨ï¼š</p>\n<ol>\n<li><p><code>*)</code>ç›¸å½“äºå…¶ä»–è¯­è¨€çš„default</p>\n</li>\n<li><p><code>;;</code>ç›¸å½“äºbreakï¼Œ <code>;&amp;</code>ç›¸å½“äºfall through</p>\n</li>\n<li><p><code>|</code>åˆ†å‰²å¤šä¸ªæ¨¡å¼ï¼Œç›¸å½“äºor</p>\n</li>\n</ol>\n"},{"layout":"post","title":"Shell ç‰¹æ®Šå˜é‡","date":"2022-02-24T16:00:00.000Z","_content":"  \n\n# ç‰¹æ®Šå˜é‡\n## $$\n\nå½“å‰ shell çš„è¿›ç¨‹ID\n\n```shell\n$echo $$\n```\n\nè¾“å‡ºå½“å‰è¿›ç¨‹çš„pid\n\n```\nâœ  ~ echo $$\n19248\n```\n\n| $0  | å½“å‰è„šæœ¬çš„æ–‡ä»¶å                                           |\n| --- | -------------------------------------------------- |\n| $n  | å½“å‰è„šæœ¬çš„å‚æ•°ï¼Œä»1å¼€å§‹ `$1`ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ`$2`ç¬¬äºŒä¸ªå‚æ•°ï¼Œ`$n`ç¬¬nä¸ªå‚æ•°         |\n| $#  | è„šæœ¬å‚æ•°çš„æ€»ä¸ªæ•°                                           |\n| $*  | è„šæœ¬å‚æ•°é›†åˆï¼Œæ‰€æœ‰çš„å‚æ•°è¢«åŒå¼•å·åŒ…è£¹ã€‚å¦‚æœè„šæœ¬2ä¸ªå‚æ•°ï¼Œ`$*`=`\"$1 $2\"`         |\n| $@  | è„šæœ¬å‚æ•°é›†åˆï¼Œæ¯ä¸ªå‚æ•°è¢«å•ç‹¬çš„åŒå¼•å·åŒ…è£¹ã€‚å¦‚æœè„šæœ¬2ä¸ªå‚æ•°ï¼Œ`$*`=`\"$1\" \"$2\"`     |\n| $?  | ä¸Šä¸ªå‘½ä»¤çš„è¿”å›å€¼ã€‚                                          |\n| $$  | å½“å‰shell çš„è¿›ç¨‹IDã€‚                                     |\n| $!  | The process number of the last background command. |\n\nç¤ºä¾‹\n\n```shell\n#!/bin/sh\n\necho \"File Name: $0\"\necho \"First Parameter : $1\"\necho \"Second Parameter : $2\"\necho \"Quoted Values: $@\"\necho \"Quoted Values: $*\"\necho \"Total Number of Parameters : $#\"\n```\n\nè¾“å‡º\n\n```shell\n$./test.sh Zara Ali\nFile Name : ./test.sh\nFirst Parameter : Zara\nSecond Parameter : Ali\nQuoted Values: Zara Ali\nQuoted Values: Zara Ali\nTotal Number of Parameters : 2\n```\n\n## `$* `å’Œ`$@`\n\nthe `$*` special parameter takes the entire list as one argument with spaces between and the `$@` special parameter takes the entire list and separates it into separate arguments.\n\n```shell\n#!/bin/sh\n\nfor TOKEN in $*\ndo\n   echo $TOKEN\ndone\n```\n\nè¾“å‡º\n\n```shell\n$./test.sh Zara Ali 10 Years Old\nZara\nAli\n10\nYears\nOld\n```\n\n## `$?`\n\næ£€æŸ¥ä¸Šä¸ªå‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚\n\n```shell\nâœ  ~ pwd\n/Users/yxb\nâœ  ~ echo $?\n0\n```\n\n\n","source":"_posts/Shell/2022-02-25-shell ç‰¹æ®Šå˜é‡.md","raw":"---\nlayout: post\ntitle: \"Shell ç‰¹æ®Šå˜é‡\"\ndate: 2022-02-25 \ntag: Shell\n---  \n\n# ç‰¹æ®Šå˜é‡\n## $$\n\nå½“å‰ shell çš„è¿›ç¨‹ID\n\n```shell\n$echo $$\n```\n\nè¾“å‡ºå½“å‰è¿›ç¨‹çš„pid\n\n```\nâœ  ~ echo $$\n19248\n```\n\n| $0  | å½“å‰è„šæœ¬çš„æ–‡ä»¶å                                           |\n| --- | -------------------------------------------------- |\n| $n  | å½“å‰è„šæœ¬çš„å‚æ•°ï¼Œä»1å¼€å§‹ `$1`ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ`$2`ç¬¬äºŒä¸ªå‚æ•°ï¼Œ`$n`ç¬¬nä¸ªå‚æ•°         |\n| $#  | è„šæœ¬å‚æ•°çš„æ€»ä¸ªæ•°                                           |\n| $*  | è„šæœ¬å‚æ•°é›†åˆï¼Œæ‰€æœ‰çš„å‚æ•°è¢«åŒå¼•å·åŒ…è£¹ã€‚å¦‚æœè„šæœ¬2ä¸ªå‚æ•°ï¼Œ`$*`=`\"$1 $2\"`         |\n| $@  | è„šæœ¬å‚æ•°é›†åˆï¼Œæ¯ä¸ªå‚æ•°è¢«å•ç‹¬çš„åŒå¼•å·åŒ…è£¹ã€‚å¦‚æœè„šæœ¬2ä¸ªå‚æ•°ï¼Œ`$*`=`\"$1\" \"$2\"`     |\n| $?  | ä¸Šä¸ªå‘½ä»¤çš„è¿”å›å€¼ã€‚                                          |\n| $$  | å½“å‰shell çš„è¿›ç¨‹IDã€‚                                     |\n| $!  | The process number of the last background command. |\n\nç¤ºä¾‹\n\n```shell\n#!/bin/sh\n\necho \"File Name: $0\"\necho \"First Parameter : $1\"\necho \"Second Parameter : $2\"\necho \"Quoted Values: $@\"\necho \"Quoted Values: $*\"\necho \"Total Number of Parameters : $#\"\n```\n\nè¾“å‡º\n\n```shell\n$./test.sh Zara Ali\nFile Name : ./test.sh\nFirst Parameter : Zara\nSecond Parameter : Ali\nQuoted Values: Zara Ali\nQuoted Values: Zara Ali\nTotal Number of Parameters : 2\n```\n\n## `$* `å’Œ`$@`\n\nthe `$*` special parameter takes the entire list as one argument with spaces between and the `$@` special parameter takes the entire list and separates it into separate arguments.\n\n```shell\n#!/bin/sh\n\nfor TOKEN in $*\ndo\n   echo $TOKEN\ndone\n```\n\nè¾“å‡º\n\n```shell\n$./test.sh Zara Ali 10 Years Old\nZara\nAli\n10\nYears\nOld\n```\n\n## `$?`\n\næ£€æŸ¥ä¸Šä¸ªå‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚\n\n```shell\nâœ  ~ pwd\n/Users/yxb\nâœ  ~ echo $?\n0\n```\n\n\n","slug":"Shell/2022-02-25-shell ç‰¹æ®Šå˜é‡","published":1,"updated":"2024-03-06T11:53:13.563Z","comments":1,"photos":[],"_id":"clti3glkk000i57wh0btug6c2","content":"<h1 id=\"ç‰¹æ®Šå˜é‡\"><a href=\"#ç‰¹æ®Šå˜é‡\" class=\"headerlink\" title=\"ç‰¹æ®Šå˜é‡\"></a>ç‰¹æ®Šå˜é‡</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"$$\"></a>$$</h2><p>å½“å‰ shell çš„è¿›ç¨‹ID</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">$</span><span class=\"language-bash\"><span class=\"hljs-built_in\">echo</span> $$</span><br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡ºå½“å‰è¿›ç¨‹çš„pid</p>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gams\">âœ  ~ echo <span class=\"hljs-symbol\">$</span><span class=\"hljs-symbol\">$</span><br><span class=\"hljs-number\">19248</span><br></code></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>$0</th>\n<th>å½“å‰è„šæœ¬çš„æ–‡ä»¶å</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>$n</td>\n<td>å½“å‰è„šæœ¬çš„å‚æ•°ï¼Œä»1å¼€å§‹ <code>$1</code>ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<code>$2</code>ç¬¬äºŒä¸ªå‚æ•°ï¼Œ<code>$n</code>ç¬¬nä¸ªå‚æ•°</td>\n</tr>\n<tr>\n<td>$#</td>\n<td>è„šæœ¬å‚æ•°çš„æ€»ä¸ªæ•°</td>\n</tr>\n<tr>\n<td>$*</td>\n<td>è„šæœ¬å‚æ•°é›†åˆï¼Œæ‰€æœ‰çš„å‚æ•°è¢«åŒå¼•å·åŒ…è£¹ã€‚å¦‚æœè„šæœ¬2ä¸ªå‚æ•°ï¼Œ<code>$*</code>&#x3D;<code>&quot;$1 $2&quot;</code></td>\n</tr>\n<tr>\n<td>$@</td>\n<td>è„šæœ¬å‚æ•°é›†åˆï¼Œæ¯ä¸ªå‚æ•°è¢«å•ç‹¬çš„åŒå¼•å·åŒ…è£¹ã€‚å¦‚æœè„šæœ¬2ä¸ªå‚æ•°ï¼Œ<code>$*</code>&#x3D;<code>&quot;$1&quot; &quot;$2&quot;</code></td>\n</tr>\n<tr>\n<td>$?</td>\n<td>ä¸Šä¸ªå‘½ä»¤çš„è¿”å›å€¼ã€‚</td>\n</tr>\n<tr>\n<td>$$</td>\n<td>å½“å‰shell çš„è¿›ç¨‹IDã€‚</td>\n</tr>\n<tr>\n<td>$!</td>\n<td>The process number of the last background command.</td>\n</tr>\n</tbody></table>\n<p>ç¤ºä¾‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>echo &quot;File Name: $0&quot;<br>echo &quot;First Parameter : $1&quot;<br>echo &quot;Second Parameter : $2&quot;<br>echo &quot;Quoted Values: $@&quot;<br>echo &quot;Quoted Values: $*&quot;<br>echo &quot;Total Number of Parameters : $#&quot;<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡º</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">$</span><span class=\"language-bash\">./test.sh Zara Ali</span><br>File Name : ./test.sh<br>First Parameter : Zara<br>Second Parameter : Ali<br>Quoted Values: Zara Ali<br>Quoted Values: Zara Ali<br>Total Number of Parameters : 2<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å’Œ\"><a href=\"#å’Œ\" class=\"headerlink\" title=\"$* å’Œ$@\"></a><code>$* </code>å’Œ<code>$@</code></h2><p>the <code>$*</code> special parameter takes the entire list as one argument with spaces between and the <code>$@</code> special parameter takes the entire list and separates it into separate arguments.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>for TOKEN in $*<br>do<br>   echo $TOKEN<br>done<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡º</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">$</span><span class=\"language-bash\">./test.sh Zara Ali 10 Years Old</span><br>Zara<br>Ali<br>10<br>Years<br>Old<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"$?\"></a><code>$?</code></h2><p>æ£€æŸ¥ä¸Šä¸ªå‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">âœ  ~ pwd<br>/Users/yxb<br>âœ  ~ echo $?<br>0<br></code></pre></td></tr></table></figure>\n\n\n","excerpt":"","more":"<h1 id=\"ç‰¹æ®Šå˜é‡\"><a href=\"#ç‰¹æ®Šå˜é‡\" class=\"headerlink\" title=\"ç‰¹æ®Šå˜é‡\"></a>ç‰¹æ®Šå˜é‡</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"$$\"></a>$$</h2><p>å½“å‰ shell çš„è¿›ç¨‹ID</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">$</span><span class=\"language-bash\"><span class=\"hljs-built_in\">echo</span> $$</span><br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡ºå½“å‰è¿›ç¨‹çš„pid</p>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gams\">âœ  ~ echo <span class=\"hljs-symbol\">$</span><span class=\"hljs-symbol\">$</span><br><span class=\"hljs-number\">19248</span><br></code></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>$0</th>\n<th>å½“å‰è„šæœ¬çš„æ–‡ä»¶å</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>$n</td>\n<td>å½“å‰è„šæœ¬çš„å‚æ•°ï¼Œä»1å¼€å§‹ <code>$1</code>ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<code>$2</code>ç¬¬äºŒä¸ªå‚æ•°ï¼Œ<code>$n</code>ç¬¬nä¸ªå‚æ•°</td>\n</tr>\n<tr>\n<td>$#</td>\n<td>è„šæœ¬å‚æ•°çš„æ€»ä¸ªæ•°</td>\n</tr>\n<tr>\n<td>$*</td>\n<td>è„šæœ¬å‚æ•°é›†åˆï¼Œæ‰€æœ‰çš„å‚æ•°è¢«åŒå¼•å·åŒ…è£¹ã€‚å¦‚æœè„šæœ¬2ä¸ªå‚æ•°ï¼Œ<code>$*</code>&#x3D;<code>&quot;$1 $2&quot;</code></td>\n</tr>\n<tr>\n<td>$@</td>\n<td>è„šæœ¬å‚æ•°é›†åˆï¼Œæ¯ä¸ªå‚æ•°è¢«å•ç‹¬çš„åŒå¼•å·åŒ…è£¹ã€‚å¦‚æœè„šæœ¬2ä¸ªå‚æ•°ï¼Œ<code>$*</code>&#x3D;<code>&quot;$1&quot; &quot;$2&quot;</code></td>\n</tr>\n<tr>\n<td>$?</td>\n<td>ä¸Šä¸ªå‘½ä»¤çš„è¿”å›å€¼ã€‚</td>\n</tr>\n<tr>\n<td>$$</td>\n<td>å½“å‰shell çš„è¿›ç¨‹IDã€‚</td>\n</tr>\n<tr>\n<td>$!</td>\n<td>The process number of the last background command.</td>\n</tr>\n</tbody></table>\n<p>ç¤ºä¾‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>echo &quot;File Name: $0&quot;<br>echo &quot;First Parameter : $1&quot;<br>echo &quot;Second Parameter : $2&quot;<br>echo &quot;Quoted Values: $@&quot;<br>echo &quot;Quoted Values: $*&quot;<br>echo &quot;Total Number of Parameters : $#&quot;<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡º</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">$</span><span class=\"language-bash\">./test.sh Zara Ali</span><br>File Name : ./test.sh<br>First Parameter : Zara<br>Second Parameter : Ali<br>Quoted Values: Zara Ali<br>Quoted Values: Zara Ali<br>Total Number of Parameters : 2<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å’Œ\"><a href=\"#å’Œ\" class=\"headerlink\" title=\"$* å’Œ$@\"></a><code>$* </code>å’Œ<code>$@</code></h2><p>the <code>$*</code> special parameter takes the entire list as one argument with spaces between and the <code>$@</code> special parameter takes the entire list and separates it into separate arguments.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>for TOKEN in $*<br>do<br>   echo $TOKEN<br>done<br></code></pre></td></tr></table></figure>\n\n<p>è¾“å‡º</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">$</span><span class=\"language-bash\">./test.sh Zara Ali 10 Years Old</span><br>Zara<br>Ali<br>10<br>Years<br>Old<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"$?\"></a><code>$?</code></h2><p>æ£€æŸ¥ä¸Šä¸ªå‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">âœ  ~ pwd<br>/Users/yxb<br>âœ  ~ echo $?<br>0<br></code></pre></td></tr></table></figure>\n\n\n"},{"layout":"post","title":"Shell è¿ç®—ç¬¦","date":"2022-02-24T16:00:00.000Z","_content":"  \n\n# shell è¿ç®—ç¬¦\n\nå‚è€ƒï¼š[Unix / Linux - Shell Basic Operators](https://www.tutorialspoint.com/unix/unix-basic-operators.htm)\n\n## ç®—æ•°è¿ç®—ç¬¦\n\nshell æœ¬èº«ä¸æ”¯æŒç®—æ•°è¿ç®—ï¼Œä½¿ç”¨`awk`  æˆ–è€…`expr`æ¥å®ç°ã€‚\n\nç¤ºä¾‹ï¼š ä¸¤æ•°ç›¸åŠ \n\n```shell\n#!/bin/sh\n\nval=`expr 2 + 2`\necho \"Total value : $val\"\n```\n\nç»“æœ\n\n```shell\nTotal value : 4\n```\n\n\n\nå‡è®¾a=10ï¼Œb=20\n\n| è¿ç®—ç¬¦ | æè¿°   | ç¤ºä¾‹                     |\n| --- | ---- | ---------------------- |\n| +   | åŠ     | `expr $a + $b`Â  Â =Â  30 |\n| -   | å‡    | `expr $a - $b`Â = -10   |\n| *   | ä¹˜    | `expr $a \\* $b`Â = 200  |\n| /   | é™¤    | `expr $b / $a`Â = 2     |\n| %   | æ±‚ä½™   | `expr $b % $a`Â = 0     |\n| =   | èµ‹å€¼   | `a = $b`               |\n| ==  | åˆ¤æ–­ç›¸ç­‰ | `[ $a == $b ]`         |\n| !=  | ä¸ç­‰   | `[ $a != $b ]`         |\n\n## å…³ç³»è¿ç®—ç¬¦\n\nå‡è®¾a=10, b=20\n\n| è¿ç®—ç¬¦ | æè¿°   | ç¤ºä¾‹                           |\n| --- | ---- | ---------------------------- |\n| -eq | ç›¸ç­‰   | `[ $a -eq $b ]` is not true. |\n| -ne | ä¸ç­‰   | `[ $a -ne $b ] `is true.     |\n| -gt | å¤§äº   | `[ $a -gt $b ]` is not true. |\n| -lt | å°äº   | `[ $a -lt $b ]` is true.     |\n| -ge | å¤§äºç­‰äº | `[ $a -ge $b ]` is not true. |\n| -le | å°äºç­‰äº | `[ $a -le $b ]` is true.     |\n\n## é€»è¾‘è¿ç®—ç¬¦\n\nå‡è®¾a=10, b=20\n\n| è¿ç®—ç¬¦ | æè¿°  | ç¤ºä¾‹                                      |\n| --- | --- | --------------------------------------- |\n| !   | é€»è¾‘é | `[ ! false ]` is true.                  |\n| -o  | é€»è¾‘æˆ– | `[ $a -lt 20 -o $b -gt 100 ]` is true.  |\n| -a  | é€»è¾‘ä¸ | `[ $a -lt 20 -a $b -gt 100 ]` is false. |\n\n## å­—ç¬¦ä¸²è¿ç®—ç¬¦\n\nå‡è®¾ a=\"abc\", b =\"efg\"\n\n| è¿ç®—ç¬¦ | æè¿°                       | ç¤ºä¾‹                          |\n| --- | ------------------------ | --------------------------- |\n| =   | ç›¸ç­‰                       | `[ $a = $b ]`Â  is not true. |\n| !=  | ä¸ç­‰                       | `[ $a != $b ]` is true.     |\n| -z  | æ˜¯å¦ä¸ºç©º,Â  ä¸ºç©ºä¸ºtrueï¼Œ ä¸ç©º false | `[ -z $a ]`Â  is not true.   |\n| -n  | æ˜¯å¦éç©ºï¼Œ éç©ºä¸ºtrueï¼Œ ç©ºä¸ºfalse   | `[ -n $a ]` is not false.   |\n| str | æ˜¯å¦éç©ºï¼Œéç©ºä¸ºtrueï¼Œ ç©ºä¸ºfalse    | `[ $a ]` is not false.      |\n\n## æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦\n\n| è¿ç®—ç¬¦     | æè¿°            | ç¤ºä¾‹             |\n| ------- | ------------- | -------------- |\n| -d file | æ£€æµ‹ file æ˜¯å¦æ˜¯ç›®å½• | `[ -d $file ]` |\n| -f file | æ£€æµ‹æ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶     | `[ -f $file ]` |\n| -r file | æ˜¯å¦å¯è¯»          | `[ -r $file ]` |\n| -w file | æ˜¯å¦å¯å†™          | `[ -w $file ]` |\n| -x file | æ˜¯å¦å¯æ‰§è¡Œ         | `[ -x $file ]` |\n| -s file | æ–‡ä»¶å¤§å°æ˜¯å¦å¤§äº0     | `[ -s $file ]` |\n| -e file | æ–‡ä»¶æ˜¯å¦å­˜åœ¨        | `[ -e $file ]` |\n\n\n","source":"_posts/Shell/2022-02-25-shell è¿ç®—ç¬¦.md","raw":"---\nlayout: post\ntitle: \"Shell è¿ç®—ç¬¦\"\ndate: 2022-02-25 \ntag: Shell\n---  \n\n# shell è¿ç®—ç¬¦\n\nå‚è€ƒï¼š[Unix / Linux - Shell Basic Operators](https://www.tutorialspoint.com/unix/unix-basic-operators.htm)\n\n## ç®—æ•°è¿ç®—ç¬¦\n\nshell æœ¬èº«ä¸æ”¯æŒç®—æ•°è¿ç®—ï¼Œä½¿ç”¨`awk`  æˆ–è€…`expr`æ¥å®ç°ã€‚\n\nç¤ºä¾‹ï¼š ä¸¤æ•°ç›¸åŠ \n\n```shell\n#!/bin/sh\n\nval=`expr 2 + 2`\necho \"Total value : $val\"\n```\n\nç»“æœ\n\n```shell\nTotal value : 4\n```\n\n\n\nå‡è®¾a=10ï¼Œb=20\n\n| è¿ç®—ç¬¦ | æè¿°   | ç¤ºä¾‹                     |\n| --- | ---- | ---------------------- |\n| +   | åŠ     | `expr $a + $b`Â  Â =Â  30 |\n| -   | å‡    | `expr $a - $b`Â = -10   |\n| *   | ä¹˜    | `expr $a \\* $b`Â = 200  |\n| /   | é™¤    | `expr $b / $a`Â = 2     |\n| %   | æ±‚ä½™   | `expr $b % $a`Â = 0     |\n| =   | èµ‹å€¼   | `a = $b`               |\n| ==  | åˆ¤æ–­ç›¸ç­‰ | `[ $a == $b ]`         |\n| !=  | ä¸ç­‰   | `[ $a != $b ]`         |\n\n## å…³ç³»è¿ç®—ç¬¦\n\nå‡è®¾a=10, b=20\n\n| è¿ç®—ç¬¦ | æè¿°   | ç¤ºä¾‹                           |\n| --- | ---- | ---------------------------- |\n| -eq | ç›¸ç­‰   | `[ $a -eq $b ]` is not true. |\n| -ne | ä¸ç­‰   | `[ $a -ne $b ] `is true.     |\n| -gt | å¤§äº   | `[ $a -gt $b ]` is not true. |\n| -lt | å°äº   | `[ $a -lt $b ]` is true.     |\n| -ge | å¤§äºç­‰äº | `[ $a -ge $b ]` is not true. |\n| -le | å°äºç­‰äº | `[ $a -le $b ]` is true.     |\n\n## é€»è¾‘è¿ç®—ç¬¦\n\nå‡è®¾a=10, b=20\n\n| è¿ç®—ç¬¦ | æè¿°  | ç¤ºä¾‹                                      |\n| --- | --- | --------------------------------------- |\n| !   | é€»è¾‘é | `[ ! false ]` is true.                  |\n| -o  | é€»è¾‘æˆ– | `[ $a -lt 20 -o $b -gt 100 ]` is true.  |\n| -a  | é€»è¾‘ä¸ | `[ $a -lt 20 -a $b -gt 100 ]` is false. |\n\n## å­—ç¬¦ä¸²è¿ç®—ç¬¦\n\nå‡è®¾ a=\"abc\", b =\"efg\"\n\n| è¿ç®—ç¬¦ | æè¿°                       | ç¤ºä¾‹                          |\n| --- | ------------------------ | --------------------------- |\n| =   | ç›¸ç­‰                       | `[ $a = $b ]`Â  is not true. |\n| !=  | ä¸ç­‰                       | `[ $a != $b ]` is true.     |\n| -z  | æ˜¯å¦ä¸ºç©º,Â  ä¸ºç©ºä¸ºtrueï¼Œ ä¸ç©º false | `[ -z $a ]`Â  is not true.   |\n| -n  | æ˜¯å¦éç©ºï¼Œ éç©ºä¸ºtrueï¼Œ ç©ºä¸ºfalse   | `[ -n $a ]` is not false.   |\n| str | æ˜¯å¦éç©ºï¼Œéç©ºä¸ºtrueï¼Œ ç©ºä¸ºfalse    | `[ $a ]` is not false.      |\n\n## æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦\n\n| è¿ç®—ç¬¦     | æè¿°            | ç¤ºä¾‹             |\n| ------- | ------------- | -------------- |\n| -d file | æ£€æµ‹ file æ˜¯å¦æ˜¯ç›®å½• | `[ -d $file ]` |\n| -f file | æ£€æµ‹æ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶     | `[ -f $file ]` |\n| -r file | æ˜¯å¦å¯è¯»          | `[ -r $file ]` |\n| -w file | æ˜¯å¦å¯å†™          | `[ -w $file ]` |\n| -x file | æ˜¯å¦å¯æ‰§è¡Œ         | `[ -x $file ]` |\n| -s file | æ–‡ä»¶å¤§å°æ˜¯å¦å¤§äº0     | `[ -s $file ]` |\n| -e file | æ–‡ä»¶æ˜¯å¦å­˜åœ¨        | `[ -e $file ]` |\n\n\n","slug":"Shell/2022-02-25-shell è¿ç®—ç¬¦","published":1,"updated":"2024-03-06T11:53:13.563Z","comments":1,"photos":[],"_id":"clti3glkk000k57whfy2v7tmp","content":"<h1 id=\"shell-è¿ç®—ç¬¦\"><a href=\"#shell-è¿ç®—ç¬¦\" class=\"headerlink\" title=\"shell è¿ç®—ç¬¦\"></a>shell è¿ç®—ç¬¦</h1><p>å‚è€ƒï¼š<a href=\"https://www.tutorialspoint.com/unix/unix-basic-operators.htm\">Unix &#x2F; Linux - Shell Basic Operators</a></p>\n<h2 id=\"ç®—æ•°è¿ç®—ç¬¦\"><a href=\"#ç®—æ•°è¿ç®—ç¬¦\" class=\"headerlink\" title=\"ç®—æ•°è¿ç®—ç¬¦\"></a>ç®—æ•°è¿ç®—ç¬¦</h2><p>shell æœ¬èº«ä¸æ”¯æŒç®—æ•°è¿ç®—ï¼Œä½¿ç”¨<code>awk</code>  æˆ–è€…<code>expr</code>æ¥å®ç°ã€‚</p>\n<p>ç¤ºä¾‹ï¼š ä¸¤æ•°ç›¸åŠ </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>val=`expr 2 + 2`<br>echo &quot;Total value : $val&quot;<br></code></pre></td></tr></table></figure>\n\n<p>ç»“æœ</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">Total value : 4<br></code></pre></td></tr></table></figure>\n\n\n\n<p>å‡è®¾a&#x3D;10ï¼Œb&#x3D;20</p>\n<table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>+</td>\n<td>åŠ </td>\n<td><code>expr $a + $b</code>Â  Â &#x3D;Â  30</td>\n</tr>\n<tr>\n<td>-</td>\n<td>å‡</td>\n<td><code>expr $a - $b</code>Â &#x3D; -10</td>\n</tr>\n<tr>\n<td>*</td>\n<td>ä¹˜</td>\n<td><code>expr $a \\* $b</code>Â &#x3D; 200</td>\n</tr>\n<tr>\n<td>&#x2F;</td>\n<td>é™¤</td>\n<td><code>expr $b / $a</code>Â &#x3D; 2</td>\n</tr>\n<tr>\n<td>%</td>\n<td>æ±‚ä½™</td>\n<td><code>expr $b % $a</code>Â &#x3D; 0</td>\n</tr>\n<tr>\n<td>&#x3D;</td>\n<td>èµ‹å€¼</td>\n<td><code>a = $b</code></td>\n</tr>\n<tr>\n<td>&#x3D;&#x3D;</td>\n<td>åˆ¤æ–­ç›¸ç­‰</td>\n<td><code>[ $a == $b ]</code></td>\n</tr>\n<tr>\n<td>!&#x3D;</td>\n<td>ä¸ç­‰</td>\n<td><code>[ $a != $b ]</code></td>\n</tr>\n</tbody></table>\n<h2 id=\"å…³ç³»è¿ç®—ç¬¦\"><a href=\"#å…³ç³»è¿ç®—ç¬¦\" class=\"headerlink\" title=\"å…³ç³»è¿ç®—ç¬¦\"></a>å…³ç³»è¿ç®—ç¬¦</h2><p>å‡è®¾a&#x3D;10, b&#x3D;20</p>\n<table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-eq</td>\n<td>ç›¸ç­‰</td>\n<td><code>[ $a -eq $b ]</code> is not true.</td>\n</tr>\n<tr>\n<td>-ne</td>\n<td>ä¸ç­‰</td>\n<td><code>[ $a -ne $b ] </code>is true.</td>\n</tr>\n<tr>\n<td>-gt</td>\n<td>å¤§äº</td>\n<td><code>[ $a -gt $b ]</code> is not true.</td>\n</tr>\n<tr>\n<td>-lt</td>\n<td>å°äº</td>\n<td><code>[ $a -lt $b ]</code> is true.</td>\n</tr>\n<tr>\n<td>-ge</td>\n<td>å¤§äºç­‰äº</td>\n<td><code>[ $a -ge $b ]</code> is not true.</td>\n</tr>\n<tr>\n<td>-le</td>\n<td>å°äºç­‰äº</td>\n<td><code>[ $a -le $b ]</code> is true.</td>\n</tr>\n</tbody></table>\n<h2 id=\"é€»è¾‘è¿ç®—ç¬¦\"><a href=\"#é€»è¾‘è¿ç®—ç¬¦\" class=\"headerlink\" title=\"é€»è¾‘è¿ç®—ç¬¦\"></a>é€»è¾‘è¿ç®—ç¬¦</h2><p>å‡è®¾a&#x3D;10, b&#x3D;20</p>\n<table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>!</td>\n<td>é€»è¾‘é</td>\n<td><code>[ ! false ]</code> is true.</td>\n</tr>\n<tr>\n<td>-o</td>\n<td>é€»è¾‘æˆ–</td>\n<td><code>[ $a -lt 20 -o $b -gt 100 ]</code> is true.</td>\n</tr>\n<tr>\n<td>-a</td>\n<td>é€»è¾‘ä¸</td>\n<td><code>[ $a -lt 20 -a $b -gt 100 ]</code> is false.</td>\n</tr>\n</tbody></table>\n<h2 id=\"å­—ç¬¦ä¸²è¿ç®—ç¬¦\"><a href=\"#å­—ç¬¦ä¸²è¿ç®—ç¬¦\" class=\"headerlink\" title=\"å­—ç¬¦ä¸²è¿ç®—ç¬¦\"></a>å­—ç¬¦ä¸²è¿ç®—ç¬¦</h2><p>å‡è®¾ a&#x3D;â€abcâ€, b &#x3D;â€efgâ€</p>\n<table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>&#x3D;</td>\n<td>ç›¸ç­‰</td>\n<td><code>[ $a = $b ]</code>Â  is not true.</td>\n</tr>\n<tr>\n<td>!&#x3D;</td>\n<td>ä¸ç­‰</td>\n<td><code>[ $a != $b ]</code> is true.</td>\n</tr>\n<tr>\n<td>-z</td>\n<td>æ˜¯å¦ä¸ºç©º,Â  ä¸ºç©ºä¸ºtrueï¼Œ ä¸ç©º false</td>\n<td><code>[ -z $a ]</code>Â  is not true.</td>\n</tr>\n<tr>\n<td>-n</td>\n<td>æ˜¯å¦éç©ºï¼Œ éç©ºä¸ºtrueï¼Œ ç©ºä¸ºfalse</td>\n<td><code>[ -n $a ]</code> is not false.</td>\n</tr>\n<tr>\n<td>str</td>\n<td>æ˜¯å¦éç©ºï¼Œéç©ºä¸ºtrueï¼Œ ç©ºä¸ºfalse</td>\n<td><code>[ $a ]</code> is not false.</td>\n</tr>\n</tbody></table>\n<h2 id=\"æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦\"><a href=\"#æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦\" class=\"headerlink\" title=\"æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦\"></a>æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦</h2><table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-d file</td>\n<td>æ£€æµ‹ file æ˜¯å¦æ˜¯ç›®å½•</td>\n<td><code>[ -d $file ]</code></td>\n</tr>\n<tr>\n<td>-f file</td>\n<td>æ£€æµ‹æ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶</td>\n<td><code>[ -f $file ]</code></td>\n</tr>\n<tr>\n<td>-r file</td>\n<td>æ˜¯å¦å¯è¯»</td>\n<td><code>[ -r $file ]</code></td>\n</tr>\n<tr>\n<td>-w file</td>\n<td>æ˜¯å¦å¯å†™</td>\n<td><code>[ -w $file ]</code></td>\n</tr>\n<tr>\n<td>-x file</td>\n<td>æ˜¯å¦å¯æ‰§è¡Œ</td>\n<td><code>[ -x $file ]</code></td>\n</tr>\n<tr>\n<td>-s file</td>\n<td>æ–‡ä»¶å¤§å°æ˜¯å¦å¤§äº0</td>\n<td><code>[ -s $file ]</code></td>\n</tr>\n<tr>\n<td>-e file</td>\n<td>æ–‡ä»¶æ˜¯å¦å­˜åœ¨</td>\n<td><code>[ -e $file ]</code></td>\n</tr>\n</tbody></table>\n","excerpt":"","more":"<h1 id=\"shell-è¿ç®—ç¬¦\"><a href=\"#shell-è¿ç®—ç¬¦\" class=\"headerlink\" title=\"shell è¿ç®—ç¬¦\"></a>shell è¿ç®—ç¬¦</h1><p>å‚è€ƒï¼š<a href=\"https://www.tutorialspoint.com/unix/unix-basic-operators.htm\">Unix &#x2F; Linux - Shell Basic Operators</a></p>\n<h2 id=\"ç®—æ•°è¿ç®—ç¬¦\"><a href=\"#ç®—æ•°è¿ç®—ç¬¦\" class=\"headerlink\" title=\"ç®—æ•°è¿ç®—ç¬¦\"></a>ç®—æ•°è¿ç®—ç¬¦</h2><p>shell æœ¬èº«ä¸æ”¯æŒç®—æ•°è¿ç®—ï¼Œä½¿ç”¨<code>awk</code>  æˆ–è€…<code>expr</code>æ¥å®ç°ã€‚</p>\n<p>ç¤ºä¾‹ï¼š ä¸¤æ•°ç›¸åŠ </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><br>val=`expr 2 + 2`<br>echo &quot;Total value : $val&quot;<br></code></pre></td></tr></table></figure>\n\n<p>ç»“æœ</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">Total value : 4<br></code></pre></td></tr></table></figure>\n\n\n\n<p>å‡è®¾a&#x3D;10ï¼Œb&#x3D;20</p>\n<table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>+</td>\n<td>åŠ </td>\n<td><code>expr $a + $b</code>Â  Â &#x3D;Â  30</td>\n</tr>\n<tr>\n<td>-</td>\n<td>å‡</td>\n<td><code>expr $a - $b</code>Â &#x3D; -10</td>\n</tr>\n<tr>\n<td>*</td>\n<td>ä¹˜</td>\n<td><code>expr $a \\* $b</code>Â &#x3D; 200</td>\n</tr>\n<tr>\n<td>&#x2F;</td>\n<td>é™¤</td>\n<td><code>expr $b / $a</code>Â &#x3D; 2</td>\n</tr>\n<tr>\n<td>%</td>\n<td>æ±‚ä½™</td>\n<td><code>expr $b % $a</code>Â &#x3D; 0</td>\n</tr>\n<tr>\n<td>&#x3D;</td>\n<td>èµ‹å€¼</td>\n<td><code>a = $b</code></td>\n</tr>\n<tr>\n<td>&#x3D;&#x3D;</td>\n<td>åˆ¤æ–­ç›¸ç­‰</td>\n<td><code>[ $a == $b ]</code></td>\n</tr>\n<tr>\n<td>!&#x3D;</td>\n<td>ä¸ç­‰</td>\n<td><code>[ $a != $b ]</code></td>\n</tr>\n</tbody></table>\n<h2 id=\"å…³ç³»è¿ç®—ç¬¦\"><a href=\"#å…³ç³»è¿ç®—ç¬¦\" class=\"headerlink\" title=\"å…³ç³»è¿ç®—ç¬¦\"></a>å…³ç³»è¿ç®—ç¬¦</h2><p>å‡è®¾a&#x3D;10, b&#x3D;20</p>\n<table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-eq</td>\n<td>ç›¸ç­‰</td>\n<td><code>[ $a -eq $b ]</code> is not true.</td>\n</tr>\n<tr>\n<td>-ne</td>\n<td>ä¸ç­‰</td>\n<td><code>[ $a -ne $b ] </code>is true.</td>\n</tr>\n<tr>\n<td>-gt</td>\n<td>å¤§äº</td>\n<td><code>[ $a -gt $b ]</code> is not true.</td>\n</tr>\n<tr>\n<td>-lt</td>\n<td>å°äº</td>\n<td><code>[ $a -lt $b ]</code> is true.</td>\n</tr>\n<tr>\n<td>-ge</td>\n<td>å¤§äºç­‰äº</td>\n<td><code>[ $a -ge $b ]</code> is not true.</td>\n</tr>\n<tr>\n<td>-le</td>\n<td>å°äºç­‰äº</td>\n<td><code>[ $a -le $b ]</code> is true.</td>\n</tr>\n</tbody></table>\n<h2 id=\"é€»è¾‘è¿ç®—ç¬¦\"><a href=\"#é€»è¾‘è¿ç®—ç¬¦\" class=\"headerlink\" title=\"é€»è¾‘è¿ç®—ç¬¦\"></a>é€»è¾‘è¿ç®—ç¬¦</h2><p>å‡è®¾a&#x3D;10, b&#x3D;20</p>\n<table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>!</td>\n<td>é€»è¾‘é</td>\n<td><code>[ ! false ]</code> is true.</td>\n</tr>\n<tr>\n<td>-o</td>\n<td>é€»è¾‘æˆ–</td>\n<td><code>[ $a -lt 20 -o $b -gt 100 ]</code> is true.</td>\n</tr>\n<tr>\n<td>-a</td>\n<td>é€»è¾‘ä¸</td>\n<td><code>[ $a -lt 20 -a $b -gt 100 ]</code> is false.</td>\n</tr>\n</tbody></table>\n<h2 id=\"å­—ç¬¦ä¸²è¿ç®—ç¬¦\"><a href=\"#å­—ç¬¦ä¸²è¿ç®—ç¬¦\" class=\"headerlink\" title=\"å­—ç¬¦ä¸²è¿ç®—ç¬¦\"></a>å­—ç¬¦ä¸²è¿ç®—ç¬¦</h2><p>å‡è®¾ a&#x3D;â€abcâ€, b &#x3D;â€efgâ€</p>\n<table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>&#x3D;</td>\n<td>ç›¸ç­‰</td>\n<td><code>[ $a = $b ]</code>Â  is not true.</td>\n</tr>\n<tr>\n<td>!&#x3D;</td>\n<td>ä¸ç­‰</td>\n<td><code>[ $a != $b ]</code> is true.</td>\n</tr>\n<tr>\n<td>-z</td>\n<td>æ˜¯å¦ä¸ºç©º,Â  ä¸ºç©ºä¸ºtrueï¼Œ ä¸ç©º false</td>\n<td><code>[ -z $a ]</code>Â  is not true.</td>\n</tr>\n<tr>\n<td>-n</td>\n<td>æ˜¯å¦éç©ºï¼Œ éç©ºä¸ºtrueï¼Œ ç©ºä¸ºfalse</td>\n<td><code>[ -n $a ]</code> is not false.</td>\n</tr>\n<tr>\n<td>str</td>\n<td>æ˜¯å¦éç©ºï¼Œéç©ºä¸ºtrueï¼Œ ç©ºä¸ºfalse</td>\n<td><code>[ $a ]</code> is not false.</td>\n</tr>\n</tbody></table>\n<h2 id=\"æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦\"><a href=\"#æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦\" class=\"headerlink\" title=\"æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦\"></a>æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦</h2><table>\n<thead>\n<tr>\n<th>è¿ç®—ç¬¦</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-d file</td>\n<td>æ£€æµ‹ file æ˜¯å¦æ˜¯ç›®å½•</td>\n<td><code>[ -d $file ]</code></td>\n</tr>\n<tr>\n<td>-f file</td>\n<td>æ£€æµ‹æ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶</td>\n<td><code>[ -f $file ]</code></td>\n</tr>\n<tr>\n<td>-r file</td>\n<td>æ˜¯å¦å¯è¯»</td>\n<td><code>[ -r $file ]</code></td>\n</tr>\n<tr>\n<td>-w file</td>\n<td>æ˜¯å¦å¯å†™</td>\n<td><code>[ -w $file ]</code></td>\n</tr>\n<tr>\n<td>-x file</td>\n<td>æ˜¯å¦å¯æ‰§è¡Œ</td>\n<td><code>[ -x $file ]</code></td>\n</tr>\n<tr>\n<td>-s file</td>\n<td>æ–‡ä»¶å¤§å°æ˜¯å¦å¤§äº0</td>\n<td><code>[ -s $file ]</code></td>\n</tr>\n<tr>\n<td>-e file</td>\n<td>æ–‡ä»¶æ˜¯å¦å­˜åœ¨</td>\n<td><code>[ -e $file ]</code></td>\n</tr>\n</tbody></table>\n"},{"layout":"post","title":"Shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°","date":"2022-02-24T16:00:00.000Z","_content":"\n# shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°\n\nå‚è€ƒï¼š [bash - Passing named arguments to shell scripts - Unix &amp; Linux Stack Exchange](https://unix.stackexchange.com/questions/129391/passing-named-arguments-to-shell-scripts)\n\nFrom [3.5.3 Shell Parameter Expansion](https://www.gnu.org/savannah-checkouts/gnu/bash/manual/bash.html#index-parameter-expansion) of the GNU Bash manual:\n\n> **`${parameter:-word}`**  \n> If parameter is unset or null, the expansion of word is substituted. Otherwise, the value of parameter is substituted.\n\n```shell\n#!/usr/bin/env bash\n\nwhile [ $# -gt 0 ]; do\n  case \"$1\" in\n    -p|-p_out|--p_out)\n      p_out=\"$2\"\n      ;;\n    -a|-arg_1|--arg_1)\n      arg_1=\"$2\"\n      ;;\n    *)\n      printf \"***************************\\n\"\n      printf \"* Error: Invalid argument.*\\n\"\n      printf \"***************************\\n\"\n      exit 1\n  esac\n  shift\n  shift\ndone\n\necho \"Without default values:\"\necho \"p_out: ${p_out}\"\necho \"arg_1: ${arg_1}\"\necho\necho \"With default values:\"\necho \"p_out: ${p_out:-\\\"27\\\"}\"\necho \"arg_1: ${arg_1:-\\\"smarties cereal\\\"}\"\n```\n\nè°ƒç”¨æ–¹å¼\n\n```shel\n$ ./my-script.sh -a \"lofa\" -p \"miez\"\n$ ./my-script.sh -arg_1 \"lofa\" --p_out \"miez\"\n$ ./my-script.sh --arg_1 \"lofa\" -p \"miez\"\n```\n","source":"_posts/Shell/2022-03-09-shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°.md","raw":"---\n\nlayout: post\ntitle: \"Shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°\"\ndate: 2022-02-25 \ntag: Shell\n\n---\n\n# shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°\n\nå‚è€ƒï¼š [bash - Passing named arguments to shell scripts - Unix &amp; Linux Stack Exchange](https://unix.stackexchange.com/questions/129391/passing-named-arguments-to-shell-scripts)\n\nFrom [3.5.3 Shell Parameter Expansion](https://www.gnu.org/savannah-checkouts/gnu/bash/manual/bash.html#index-parameter-expansion) of the GNU Bash manual:\n\n> **`${parameter:-word}`**  \n> If parameter is unset or null, the expansion of word is substituted. Otherwise, the value of parameter is substituted.\n\n```shell\n#!/usr/bin/env bash\n\nwhile [ $# -gt 0 ]; do\n  case \"$1\" in\n    -p|-p_out|--p_out)\n      p_out=\"$2\"\n      ;;\n    -a|-arg_1|--arg_1)\n      arg_1=\"$2\"\n      ;;\n    *)\n      printf \"***************************\\n\"\n      printf \"* Error: Invalid argument.*\\n\"\n      printf \"***************************\\n\"\n      exit 1\n  esac\n  shift\n  shift\ndone\n\necho \"Without default values:\"\necho \"p_out: ${p_out}\"\necho \"arg_1: ${arg_1}\"\necho\necho \"With default values:\"\necho \"p_out: ${p_out:-\\\"27\\\"}\"\necho \"arg_1: ${arg_1:-\\\"smarties cereal\\\"}\"\n```\n\nè°ƒç”¨æ–¹å¼\n\n```shel\n$ ./my-script.sh -a \"lofa\" -p \"miez\"\n$ ./my-script.sh -arg_1 \"lofa\" --p_out \"miez\"\n$ ./my-script.sh --arg_1 \"lofa\" -p \"miez\"\n```\n","slug":"Shell/2022-03-09-shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°","published":1,"updated":"2024-03-06T11:53:13.563Z","comments":1,"photos":[],"_id":"clti3glkl000m57wh9qjzazfh","content":"<h1 id=\"shell-è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°\"><a href=\"#shell-è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°\" class=\"headerlink\" title=\"shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°\"></a>shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°</h1><p>å‚è€ƒï¼š <a href=\"https://unix.stackexchange.com/questions/129391/passing-named-arguments-to-shell-scripts\">bash - Passing named arguments to shell scripts - Unix &amp; Linux Stack Exchange</a></p>\n<p>From <a href=\"https://www.gnu.org/savannah-checkouts/gnu/bash/manual/bash.html#index-parameter-expansion\">3.5.3 Shell Parameter Expansion</a> of the GNU Bash manual:</p>\n<blockquote>\n<p><strong><code>$&#123;parameter:-word&#125;</code></strong><br>If parameter is unset or null, the expansion of word is substituted. Otherwise, the value of parameter is substituted.</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/usr/bin/env bash</span><br><br>while [ $# -gt 0 ]; do<br>  case &quot;$1&quot; in<br>    -p|-p_out|--p_out)<br>      p_out=&quot;$2&quot;<br>      ;;<br>    -a|-arg_1|--arg_1)<br>      arg_1=&quot;$2&quot;<br>      ;;<br>    *)<br>      printf &quot;***************************\\n&quot;<br>      printf &quot;* Error: Invalid argument.*\\n&quot;<br>      printf &quot;***************************\\n&quot;<br>      exit 1<br>  esac<br>  shift<br>  shift<br>done<br><br>echo &quot;Without default values:&quot;<br>echo &quot;p_out: $&#123;p_out&#125;&quot;<br>echo &quot;arg_1: $&#123;arg_1&#125;&quot;<br>echo<br>echo &quot;With default values:&quot;<br>echo &quot;p_out: $&#123;p_out:-\\&quot;27\\&quot;&#125;&quot;<br>echo &quot;arg_1: $&#123;arg_1:-\\&quot;smarties cereal\\&quot;&#125;&quot;<br></code></pre></td></tr></table></figure>\n\n<p>è°ƒç”¨æ–¹å¼</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shel\">$ ./my-script.sh -a &quot;lofa&quot; -p &quot;miez&quot;<br>$ ./my-script.sh -arg_1 &quot;lofa&quot; --p_out &quot;miez&quot;<br>$ ./my-script.sh --arg_1 &quot;lofa&quot; -p &quot;miez&quot;<br></code></pre></td></tr></table></figure>\n","excerpt":"","more":"<h1 id=\"shell-è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°\"><a href=\"#shell-è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°\" class=\"headerlink\" title=\"shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°\"></a>shell è„šæœ¬ï¼Œå¸¦åå­—çš„å‚æ•°</h1><p>å‚è€ƒï¼š <a href=\"https://unix.stackexchange.com/questions/129391/passing-named-arguments-to-shell-scripts\">bash - Passing named arguments to shell scripts - Unix &amp; Linux Stack Exchange</a></p>\n<p>From <a href=\"https://www.gnu.org/savannah-checkouts/gnu/bash/manual/bash.html#index-parameter-expansion\">3.5.3 Shell Parameter Expansion</a> of the GNU Bash manual:</p>\n<blockquote>\n<p><strong><code>$&#123;parameter:-word&#125;</code></strong><br>If parameter is unset or null, the expansion of word is substituted. Otherwise, the value of parameter is substituted.</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/usr/bin/env bash</span><br><br>while [ $# -gt 0 ]; do<br>  case &quot;$1&quot; in<br>    -p|-p_out|--p_out)<br>      p_out=&quot;$2&quot;<br>      ;;<br>    -a|-arg_1|--arg_1)<br>      arg_1=&quot;$2&quot;<br>      ;;<br>    *)<br>      printf &quot;***************************\\n&quot;<br>      printf &quot;* Error: Invalid argument.*\\n&quot;<br>      printf &quot;***************************\\n&quot;<br>      exit 1<br>  esac<br>  shift<br>  shift<br>done<br><br>echo &quot;Without default values:&quot;<br>echo &quot;p_out: $&#123;p_out&#125;&quot;<br>echo &quot;arg_1: $&#123;arg_1&#125;&quot;<br>echo<br>echo &quot;With default values:&quot;<br>echo &quot;p_out: $&#123;p_out:-\\&quot;27\\&quot;&#125;&quot;<br>echo &quot;arg_1: $&#123;arg_1:-\\&quot;smarties cereal\\&quot;&#125;&quot;<br></code></pre></td></tr></table></figure>\n\n<p>è°ƒç”¨æ–¹å¼</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shel\">$ ./my-script.sh -a &quot;lofa&quot; -p &quot;miez&quot;<br>$ ./my-script.sh -arg_1 &quot;lofa&quot; --p_out &quot;miez&quot;<br>$ ./my-script.sh --arg_1 &quot;lofa&quot; -p &quot;miez&quot;<br></code></pre></td></tr></table></figure>\n"},{"layout":"post","title":"å‘½ä»¤è¡Œé‡å¯iPhone","date":"2022-11-15T16:00:00.000Z","_content":"  \n\n\nå‚è€ƒï¼š [Any way to reboot a iDevice that is connected to a USB port via terminal (Mac terminal)?](https://apple.stackexchange.com/questions/150880/any-way-to-reboot-a-idevice-that-is-connected-to-a-usb-port-via-terminal-mac-te)\n\n\nå®‰è£…`libimobiledevice`\n```\nbrew install libimobiledevice\n\n```\nä½¿ç”¨\n\n```\nidevicediagnostics restart\n```\n","source":"_posts/Shell/2022-11-16-å‘½ä»¤è¡Œé‡å¯iPhone.md","raw":"---\nlayout: post\ntitle: \"å‘½ä»¤è¡Œé‡å¯iPhone\"\ndate: 2022-11-16\ntag: Shell\n---  \n\n\nå‚è€ƒï¼š [Any way to reboot a iDevice that is connected to a USB port via terminal (Mac terminal)?](https://apple.stackexchange.com/questions/150880/any-way-to-reboot-a-idevice-that-is-connected-to-a-usb-port-via-terminal-mac-te)\n\n\nå®‰è£…`libimobiledevice`\n```\nbrew install libimobiledevice\n\n```\nä½¿ç”¨\n\n```\nidevicediagnostics restart\n```\n","slug":"Shell/2022-11-16-å‘½ä»¤è¡Œé‡å¯iPhone","published":1,"updated":"2024-03-06T11:53:13.563Z","comments":1,"photos":[],"_id":"clti3glkl000o57wh5to77wmw","content":"<p>å‚è€ƒï¼š <a href=\"https://apple.stackexchange.com/questions/150880/any-way-to-reboot-a-idevice-that-is-connected-to-a-usb-port-via-terminal-mac-te\">Any way to reboot a iDevice that is connected to a USB port via terminal (Mac terminal)?</a></p>\n<p>å®‰è£…<code>libimobiledevice</code></p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>libimobiledevice<br><br></code></pre></td></tr></table></figure>\n<p>ä½¿ç”¨</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ebnf\"><span class=\"hljs-attribute\">idevicediagnostics restart</span><br></code></pre></td></tr></table></figure>\n","excerpt":"","more":"<p>å‚è€ƒï¼š <a href=\"https://apple.stackexchange.com/questions/150880/any-way-to-reboot-a-idevice-that-is-connected-to-a-usb-port-via-terminal-mac-te\">Any way to reboot a iDevice that is connected to a USB port via terminal (Mac terminal)?</a></p>\n<p>å®‰è£…<code>libimobiledevice</code></p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>libimobiledevice<br><br></code></pre></td></tr></table></figure>\n<p>ä½¿ç”¨</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ebnf\"><span class=\"hljs-attribute\">idevicediagnostics restart</span><br></code></pre></td></tr></table></figure>\n"},{"layout":"post","title":"oh my zsh prompt å±•ç¤ºå½“å‰è·¯å¾„","date":"2023-05-16T16:00:00.000Z","_content":"  \n\n\nä½¿ç”¨çš„ä¸»é¢˜ä¸º\n\n```\nZSH_THEME=\"robbyrussell\"\n```\n\nä¿®æ”¹é…ç½®, path `~/.oh-my-zsh/themes/robbyrussell.zsh-theme`, å°† `%c` æ›¿æ¢ä¸º `%d`\n\n```\n\n# before\nPROMPT=\"%(?:%{$fg_bold[green]%}âœ :%{$fg_bold[red]%}âœ ) %{$fg[cyan]%}%c%{$reset_color%}\"\nPROMPT+=' $(git_prompt_info)'\n\n# after\nPROMPT=\"%(?:%{$fg_bold[green]%}âœ :%{$fg_bold[red]%}âœ )\"\nPROMPT+=' %{$fg[cyan]%}%d%{$reset_color%} $(git_prompt_info)'\n\n```\n\nå‚è€ƒï¼š [EXPANSION_OF_PROMPT_SEQUENCES](https://links.jianshu.com/go?to=https%3A%2F%2Fjlk.fjfi.cvut.cz%2Farch%2Fmanpages%2Fman%2Fzshmisc.1%23EXPANSION_OF_PROMPT_SEQUENCES)\n\n\nShell state\n\n```\n%#\nA `#' if the shell is running with privileges, a `%' if not. Equivalent to `%(!.#.%%)'. The definition of `privileged', for these purposes, is that either the effective user ID is zero, or, if POSIX.1e capabilities are supported, that at least one capability is raised in either the Effective or Inheritable capability vectors.\n\n%?\nThe return status of the last command executed just before the prompt.\n\n%_\nThe status of the parser, i.e. the shell constructs (like `if' and `for') that have been started on the command line. If given an integer number that many strings will be printed; zero or negative or no integer means print as many as there are. This is most useful in prompts PS2 for continuation lines and PS4 for debugging with the XTRACE option; in the latter case it will also work non-interactively.\n\n%^\nThe status of the parser in reverse. This is the same as `%_' other than the order of strings. It is often used in RPS2.\n\n%d%/\nCurrent working directory. If an integer follows the `%', it specifies a number of trailing components of the current working directory to show; zero means the whole path. A negative integer specifies leading components, i.e. %-1d specifies the first component.\n\n%~\nAs %d and %/, but if the current working directory starts with $HOME, that part is replaced by a `~'. Furthermore, if it has a named directory as its prefix, that part is replaced by a `~' followed by the name of the directory, but only if the result is shorter than the full path; see Dynamic and Static named directories in zshexpn(1).\n\n%e\nEvaluation depth of the current sourced file, shell function, or eval. This is incremented or decremented every time the value of %N is set or reverted to a previous value, respectively. This is most useful for debugging as part of $PS4.\n\n%h%!\nCurrent history event number.\n\n%i\nThe line number currently being executed in the script, sourced file, or shell function given by %N. This is most useful for debugging as part of $PS4.\n\n%I\nThe line number currently being executed in the file %x. This is similar to %i, but the line number is always a line number in the file where the code was defined, even if the code is a shell function.\n\n%j\nThe number of jobs.\n\n%L\nThe current value of $SHLVL.\n\n%N\nThe name of the script, sourced file, or shell function that zsh is currently executing, whichever was started most recently. If there is none, this is equivalent to the parameter $0. An integer may follow the `%' to specify a number of trailing path components to show; zero means the full path. A negative integer specifies leading components.\n\n%x\nThe name of the file containing the source code currently being executed. This behaves as %N except that function and eval command names are not shown, instead the file where they were defined.\n\n%c%.%C\nTrailing component of the current working directory. An integer may follow the `%' to get more than one component. Unless `%C' is used, tilde contraction is performed first. These are deprecated as %c and %C are equivalent to %1~ and %1/, respectively, while explicit positive integers have the same effect as for the latter two sequences.\n\n```\n\n\n","source":"_posts/Shell/2023-05-17-oh my zsh å±•ç¤ºè·¯å¾„.md","raw":"---\nlayout: post\ntitle: \"oh my zsh prompt å±•ç¤ºå½“å‰è·¯å¾„\"\ndate: 2023-05-17 \ntag: Shell\n---  \n\n\nä½¿ç”¨çš„ä¸»é¢˜ä¸º\n\n```\nZSH_THEME=\"robbyrussell\"\n```\n\nä¿®æ”¹é…ç½®, path `~/.oh-my-zsh/themes/robbyrussell.zsh-theme`, å°† `%c` æ›¿æ¢ä¸º `%d`\n\n```\n\n# before\nPROMPT=\"%(?:%{$fg_bold[green]%}âœ :%{$fg_bold[red]%}âœ ) %{$fg[cyan]%}%c%{$reset_color%}\"\nPROMPT+=' $(git_prompt_info)'\n\n# after\nPROMPT=\"%(?:%{$fg_bold[green]%}âœ :%{$fg_bold[red]%}âœ )\"\nPROMPT+=' %{$fg[cyan]%}%d%{$reset_color%} $(git_prompt_info)'\n\n```\n\nå‚è€ƒï¼š [EXPANSION_OF_PROMPT_SEQUENCES](https://links.jianshu.com/go?to=https%3A%2F%2Fjlk.fjfi.cvut.cz%2Farch%2Fmanpages%2Fman%2Fzshmisc.1%23EXPANSION_OF_PROMPT_SEQUENCES)\n\n\nShell state\n\n```\n%#\nA `#' if the shell is running with privileges, a `%' if not. Equivalent to `%(!.#.%%)'. The definition of `privileged', for these purposes, is that either the effective user ID is zero, or, if POSIX.1e capabilities are supported, that at least one capability is raised in either the Effective or Inheritable capability vectors.\n\n%?\nThe return status of the last command executed just before the prompt.\n\n%_\nThe status of the parser, i.e. the shell constructs (like `if' and `for') that have been started on the command line. If given an integer number that many strings will be printed; zero or negative or no integer means print as many as there are. This is most useful in prompts PS2 for continuation lines and PS4 for debugging with the XTRACE option; in the latter case it will also work non-interactively.\n\n%^\nThe status of the parser in reverse. This is the same as `%_' other than the order of strings. It is often used in RPS2.\n\n%d%/\nCurrent working directory. If an integer follows the `%', it specifies a number of trailing components of the current working directory to show; zero means the whole path. A negative integer specifies leading components, i.e. %-1d specifies the first component.\n\n%~\nAs %d and %/, but if the current working directory starts with $HOME, that part is replaced by a `~'. Furthermore, if it has a named directory as its prefix, that part is replaced by a `~' followed by the name of the directory, but only if the result is shorter than the full path; see Dynamic and Static named directories in zshexpn(1).\n\n%e\nEvaluation depth of the current sourced file, shell function, or eval. This is incremented or decremented every time the value of %N is set or reverted to a previous value, respectively. This is most useful for debugging as part of $PS4.\n\n%h%!\nCurrent history event number.\n\n%i\nThe line number currently being executed in the script, sourced file, or shell function given by %N. This is most useful for debugging as part of $PS4.\n\n%I\nThe line number currently being executed in the file %x. This is similar to %i, but the line number is always a line number in the file where the code was defined, even if the code is a shell function.\n\n%j\nThe number of jobs.\n\n%L\nThe current value of $SHLVL.\n\n%N\nThe name of the script, sourced file, or shell function that zsh is currently executing, whichever was started most recently. If there is none, this is equivalent to the parameter $0. An integer may follow the `%' to specify a number of trailing path components to show; zero means the full path. A negative integer specifies leading components.\n\n%x\nThe name of the file containing the source code currently being executed. This behaves as %N except that function and eval command names are not shown, instead the file where they were defined.\n\n%c%.%C\nTrailing component of the current working directory. An integer may follow the `%' to get more than one component. Unless `%C' is used, tilde contraction is performed first. These are deprecated as %c and %C are equivalent to %1~ and %1/, respectively, while explicit positive integers have the same effect as for the latter two sequences.\n\n```\n\n\n","slug":"Shell/2023-05-17-oh my zsh å±•ç¤ºè·¯å¾„","published":1,"updated":"2024-03-06T11:53:13.563Z","comments":1,"photos":[],"_id":"clti3glkl000q57wh0qu7d1fx","content":"<p>ä½¿ç”¨çš„ä¸»é¢˜ä¸º</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">ZSH_THEME</span>=<span class=\"hljs-string\">&quot;robbyrussell&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>ä¿®æ”¹é…ç½®, path <code>~/.oh-my-zsh/themes/robbyrussell.zsh-theme</code>, å°† <code>%c</code> æ›¿æ¢ä¸º <code>%d</code></p>\n<figure class=\"highlight nsis\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nsis\"><br><span class=\"hljs-comment\"># before</span><br>PROMPT=<span class=\"hljs-string\">&quot;%(?:%&#123;<span class=\"hljs-variable\">$fg_bold</span>[green]%&#125;âœ :%&#123;<span class=\"hljs-variable\">$fg_bold</span>[red]%&#125;âœ ) %&#123;<span class=\"hljs-variable\">$fg</span>[cyan]%&#125;%c%&#123;<span class=\"hljs-variable\">$reset_color</span>%&#125;&quot;</span><br>PROMPT+=<span class=\"hljs-string\">&#x27; <span class=\"hljs-variable\">$(git_prompt_info)</span>&#x27;</span><br><br><span class=\"hljs-comment\"># after</span><br>PROMPT=<span class=\"hljs-string\">&quot;%(?:%&#123;<span class=\"hljs-variable\">$fg_bold</span>[green]%&#125;âœ :%&#123;<span class=\"hljs-variable\">$fg_bold</span>[red]%&#125;âœ )&quot;</span><br>PROMPT+=<span class=\"hljs-string\">&#x27; %&#123;<span class=\"hljs-variable\">$fg</span>[cyan]%&#125;%d%&#123;<span class=\"hljs-variable\">$reset_color</span>%&#125; <span class=\"hljs-variable\">$(git_prompt_info)</span>&#x27;</span><br><br></code></pre></td></tr></table></figure>\n\n<p>å‚è€ƒï¼š <a href=\"https://links.jianshu.com/go?to=https://jlk.fjfi.cvut.cz/arch/manpages/man/zshmisc.1%23EXPANSION_OF_PROMPT_SEQUENCES\">EXPANSION_OF_PROMPT_SEQUENCES</a></p>\n<p>Shell state</p>\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs applescript\">%<span class=\"hljs-comment\">#</span><br>A `<span class=\"hljs-comment\">#&#x27; if the shell is running with privileges, a `%&#x27; if not. Equivalent to `%(!.#.%%)&#x27;. The definition of `privileged&#x27;, for these purposes, is that either the effective user ID is zero, or, if POSIX.1e capabilities are supported, that at least one capability is raised in either the Effective or Inheritable capability vectors.</span><br><br>%?<br>The <span class=\"hljs-literal\">return</span> status <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-keyword\">last</span> command executed just <span class=\"hljs-keyword\">before</span> <span class=\"hljs-keyword\">the</span> prompt.<br><br>%_<br>The status <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> parser, i.e. <span class=\"hljs-keyword\">the</span> shell constructs (like `<span class=\"hljs-keyword\">if</span>&#x27; <span class=\"hljs-keyword\">and</span> `<span class=\"hljs-keyword\">for</span>&#x27;) <span class=\"hljs-keyword\">that</span> have been started <span class=\"hljs-keyword\">on</span> <span class=\"hljs-keyword\">the</span> command line. If <span class=\"hljs-keyword\">given</span> an <span class=\"hljs-built_in\">integer</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">that</span> many strings will be printed; zero <span class=\"hljs-keyword\">or</span> negative <span class=\"hljs-keyword\">or</span> no <span class=\"hljs-built_in\">integer</span> means print <span class=\"hljs-keyword\">as</span> many <span class=\"hljs-keyword\">as</span> there are. This <span class=\"hljs-keyword\">is</span> most useful <span class=\"hljs-keyword\">in</span> prompts PS2 <span class=\"hljs-keyword\">for</span> continuation lines <span class=\"hljs-keyword\">and</span> PS4 <span class=\"hljs-keyword\">for</span> debugging <span class=\"hljs-keyword\">with</span> <span class=\"hljs-keyword\">the</span> XTRACE option; <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> latter case <span class=\"hljs-keyword\">it</span> will also work non-interactively.<br><br>%^<br>The status <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> parser <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">reverse</span>. This <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">the</span> same <span class=\"hljs-keyword\">as</span> `%_&#x27; other than <span class=\"hljs-keyword\">the</span> order <span class=\"hljs-keyword\">of</span> strings. It <span class=\"hljs-keyword\">is</span> often used <span class=\"hljs-keyword\">in</span> RPS2.<br><br>%d%/<br>Current working directory. If an <span class=\"hljs-built_in\">integer</span> follows <span class=\"hljs-keyword\">the</span> `%&#x27;, <span class=\"hljs-keyword\">it</span> specifies a <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> trailing components <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> current working directory <span class=\"hljs-keyword\">to</span> show; zero means <span class=\"hljs-keyword\">the</span> whole path. A negative <span class=\"hljs-built_in\">integer</span> specifies leading components, i.e. %<span class=\"hljs-number\">-1</span>d specifies <span class=\"hljs-keyword\">the</span> <span class=\"hljs-keyword\">first</span> component.<br><br>%~<br>As %d <span class=\"hljs-keyword\">and</span> %/, <span class=\"hljs-keyword\">but</span> <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">the</span> current working directory <span class=\"hljs-keyword\">starts with</span> $HOME, <span class=\"hljs-keyword\">that</span> part <span class=\"hljs-keyword\">is</span> replaced <span class=\"hljs-keyword\">by</span> a `~&#x27;. Furthermore, <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">it</span> has a named directory <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">its</span> prefix, <span class=\"hljs-keyword\">that</span> part <span class=\"hljs-keyword\">is</span> replaced <span class=\"hljs-keyword\">by</span> a `~&#x27; followed <span class=\"hljs-keyword\">by</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">name</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> directory, <span class=\"hljs-keyword\">but</span> only <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-literal\">result</span> <span class=\"hljs-keyword\">is</span> shorter than <span class=\"hljs-keyword\">the</span> full path; see Dynamic <span class=\"hljs-keyword\">and</span> Static named directories <span class=\"hljs-keyword\">in</span> zshexpn(<span class=\"hljs-number\">1</span>).<br><br>%e<br>Evaluation depth <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> current sourced <span class=\"hljs-built_in\">file</span>, shell function, <span class=\"hljs-keyword\">or</span> eval. This <span class=\"hljs-keyword\">is</span> incremented <span class=\"hljs-keyword\">or</span> decremented <span class=\"hljs-keyword\">every</span> <span class=\"hljs-built_in\">time</span> <span class=\"hljs-keyword\">the</span> value <span class=\"hljs-keyword\">of</span> %N <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">or</span> reverted <span class=\"hljs-keyword\">to</span> a previous value, respectively. This <span class=\"hljs-keyword\">is</span> most useful <span class=\"hljs-keyword\">for</span> debugging <span class=\"hljs-keyword\">as</span> part <span class=\"hljs-keyword\">of</span> $PS4.<br><br>%h%!<br>Current history event <span class=\"hljs-built_in\">number</span>.<br><br>%i<br>The line <span class=\"hljs-built_in\">number</span> currently being executed <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-keyword\">script</span>, sourced <span class=\"hljs-built_in\">file</span>, <span class=\"hljs-keyword\">or</span> shell function <span class=\"hljs-keyword\">given</span> <span class=\"hljs-keyword\">by</span> %N. This <span class=\"hljs-keyword\">is</span> most useful <span class=\"hljs-keyword\">for</span> debugging <span class=\"hljs-keyword\">as</span> part <span class=\"hljs-keyword\">of</span> $PS4.<br><br>%I<br>The line <span class=\"hljs-built_in\">number</span> currently being executed <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">file</span> %x. This <span class=\"hljs-keyword\">is</span> similar <span class=\"hljs-keyword\">to</span> %i, <span class=\"hljs-keyword\">but</span> <span class=\"hljs-keyword\">the</span> line <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">is</span> always a line <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">file</span> <span class=\"hljs-keyword\">where</span> <span class=\"hljs-keyword\">the</span> code was defined, even <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">the</span> code <span class=\"hljs-keyword\">is</span> a shell function.<br><br>%j<br>The <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> jobs.<br><br>%L<br>The current value <span class=\"hljs-keyword\">of</span> $SHLVL.<br><br>%N<br>The <span class=\"hljs-built_in\">name</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-keyword\">script</span>, sourced <span class=\"hljs-built_in\">file</span>, <span class=\"hljs-keyword\">or</span> shell function <span class=\"hljs-keyword\">that</span> zsh <span class=\"hljs-keyword\">is</span> currently executing, whichever was started most recently. If there <span class=\"hljs-keyword\">is</span> none, this <span class=\"hljs-keyword\">is</span> equivalent <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">the</span> parameter $<span class=\"hljs-number\">0.</span> An <span class=\"hljs-built_in\">integer</span> may follow <span class=\"hljs-keyword\">the</span> `%&#x27; <span class=\"hljs-keyword\">to</span> specify a <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> trailing path components <span class=\"hljs-keyword\">to</span> show; zero means <span class=\"hljs-keyword\">the</span> full path. A negative <span class=\"hljs-built_in\">integer</span> specifies leading components.<br><br>%x<br>The <span class=\"hljs-built_in\">name</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">file</span> containing <span class=\"hljs-keyword\">the</span> source code currently being executed. This behaves <span class=\"hljs-keyword\">as</span> %N except <span class=\"hljs-keyword\">that</span> function <span class=\"hljs-keyword\">and</span> eval command names are <span class=\"hljs-keyword\">not</span> shown, instead <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">file</span> <span class=\"hljs-keyword\">where</span> they were defined.<br><br>%c%.%C<br>Trailing component <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> current working directory. An <span class=\"hljs-built_in\">integer</span> may follow <span class=\"hljs-keyword\">the</span> `%&#x27; <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">get</span> more than one component. Unless `%C&#x27; <span class=\"hljs-keyword\">is</span> used, tilde contraction <span class=\"hljs-keyword\">is</span> performed <span class=\"hljs-keyword\">first</span>. These are deprecated <span class=\"hljs-keyword\">as</span> %c <span class=\"hljs-keyword\">and</span> %C are equivalent <span class=\"hljs-keyword\">to</span> %<span class=\"hljs-number\">1</span>~ <span class=\"hljs-keyword\">and</span> %<span class=\"hljs-number\">1</span>/, respectively, <span class=\"hljs-keyword\">while</span> explicit positive integers have <span class=\"hljs-keyword\">the</span> same effect <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">the</span> latter two sequences.<br><br></code></pre></td></tr></table></figure>\n\n\n","excerpt":"","more":"<p>ä½¿ç”¨çš„ä¸»é¢˜ä¸º</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">ZSH_THEME</span>=<span class=\"hljs-string\">&quot;robbyrussell&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>ä¿®æ”¹é…ç½®, path <code>~/.oh-my-zsh/themes/robbyrussell.zsh-theme</code>, å°† <code>%c</code> æ›¿æ¢ä¸º <code>%d</code></p>\n<figure class=\"highlight nsis\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nsis\"><br><span class=\"hljs-comment\"># before</span><br>PROMPT=<span class=\"hljs-string\">&quot;%(?:%&#123;<span class=\"hljs-variable\">$fg_bold</span>[green]%&#125;âœ :%&#123;<span class=\"hljs-variable\">$fg_bold</span>[red]%&#125;âœ ) %&#123;<span class=\"hljs-variable\">$fg</span>[cyan]%&#125;%c%&#123;<span class=\"hljs-variable\">$reset_color</span>%&#125;&quot;</span><br>PROMPT+=<span class=\"hljs-string\">&#x27; <span class=\"hljs-variable\">$(git_prompt_info)</span>&#x27;</span><br><br><span class=\"hljs-comment\"># after</span><br>PROMPT=<span class=\"hljs-string\">&quot;%(?:%&#123;<span class=\"hljs-variable\">$fg_bold</span>[green]%&#125;âœ :%&#123;<span class=\"hljs-variable\">$fg_bold</span>[red]%&#125;âœ )&quot;</span><br>PROMPT+=<span class=\"hljs-string\">&#x27; %&#123;<span class=\"hljs-variable\">$fg</span>[cyan]%&#125;%d%&#123;<span class=\"hljs-variable\">$reset_color</span>%&#125; <span class=\"hljs-variable\">$(git_prompt_info)</span>&#x27;</span><br><br></code></pre></td></tr></table></figure>\n\n<p>å‚è€ƒï¼š <a href=\"https://links.jianshu.com/go?to=https://jlk.fjfi.cvut.cz/arch/manpages/man/zshmisc.1%23EXPANSION_OF_PROMPT_SEQUENCES\">EXPANSION_OF_PROMPT_SEQUENCES</a></p>\n<p>Shell state</p>\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs applescript\">%<span class=\"hljs-comment\">#</span><br>A `<span class=\"hljs-comment\">#&#x27; if the shell is running with privileges, a `%&#x27; if not. Equivalent to `%(!.#.%%)&#x27;. The definition of `privileged&#x27;, for these purposes, is that either the effective user ID is zero, or, if POSIX.1e capabilities are supported, that at least one capability is raised in either the Effective or Inheritable capability vectors.</span><br><br>%?<br>The <span class=\"hljs-literal\">return</span> status <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-keyword\">last</span> command executed just <span class=\"hljs-keyword\">before</span> <span class=\"hljs-keyword\">the</span> prompt.<br><br>%_<br>The status <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> parser, i.e. <span class=\"hljs-keyword\">the</span> shell constructs (like `<span class=\"hljs-keyword\">if</span>&#x27; <span class=\"hljs-keyword\">and</span> `<span class=\"hljs-keyword\">for</span>&#x27;) <span class=\"hljs-keyword\">that</span> have been started <span class=\"hljs-keyword\">on</span> <span class=\"hljs-keyword\">the</span> command line. If <span class=\"hljs-keyword\">given</span> an <span class=\"hljs-built_in\">integer</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">that</span> many strings will be printed; zero <span class=\"hljs-keyword\">or</span> negative <span class=\"hljs-keyword\">or</span> no <span class=\"hljs-built_in\">integer</span> means print <span class=\"hljs-keyword\">as</span> many <span class=\"hljs-keyword\">as</span> there are. This <span class=\"hljs-keyword\">is</span> most useful <span class=\"hljs-keyword\">in</span> prompts PS2 <span class=\"hljs-keyword\">for</span> continuation lines <span class=\"hljs-keyword\">and</span> PS4 <span class=\"hljs-keyword\">for</span> debugging <span class=\"hljs-keyword\">with</span> <span class=\"hljs-keyword\">the</span> XTRACE option; <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> latter case <span class=\"hljs-keyword\">it</span> will also work non-interactively.<br><br>%^<br>The status <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> parser <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">reverse</span>. This <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">the</span> same <span class=\"hljs-keyword\">as</span> `%_&#x27; other than <span class=\"hljs-keyword\">the</span> order <span class=\"hljs-keyword\">of</span> strings. It <span class=\"hljs-keyword\">is</span> often used <span class=\"hljs-keyword\">in</span> RPS2.<br><br>%d%/<br>Current working directory. If an <span class=\"hljs-built_in\">integer</span> follows <span class=\"hljs-keyword\">the</span> `%&#x27;, <span class=\"hljs-keyword\">it</span> specifies a <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> trailing components <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> current working directory <span class=\"hljs-keyword\">to</span> show; zero means <span class=\"hljs-keyword\">the</span> whole path. A negative <span class=\"hljs-built_in\">integer</span> specifies leading components, i.e. %<span class=\"hljs-number\">-1</span>d specifies <span class=\"hljs-keyword\">the</span> <span class=\"hljs-keyword\">first</span> component.<br><br>%~<br>As %d <span class=\"hljs-keyword\">and</span> %/, <span class=\"hljs-keyword\">but</span> <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">the</span> current working directory <span class=\"hljs-keyword\">starts with</span> $HOME, <span class=\"hljs-keyword\">that</span> part <span class=\"hljs-keyword\">is</span> replaced <span class=\"hljs-keyword\">by</span> a `~&#x27;. Furthermore, <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">it</span> has a named directory <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">its</span> prefix, <span class=\"hljs-keyword\">that</span> part <span class=\"hljs-keyword\">is</span> replaced <span class=\"hljs-keyword\">by</span> a `~&#x27; followed <span class=\"hljs-keyword\">by</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">name</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> directory, <span class=\"hljs-keyword\">but</span> only <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-literal\">result</span> <span class=\"hljs-keyword\">is</span> shorter than <span class=\"hljs-keyword\">the</span> full path; see Dynamic <span class=\"hljs-keyword\">and</span> Static named directories <span class=\"hljs-keyword\">in</span> zshexpn(<span class=\"hljs-number\">1</span>).<br><br>%e<br>Evaluation depth <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> current sourced <span class=\"hljs-built_in\">file</span>, shell function, <span class=\"hljs-keyword\">or</span> eval. This <span class=\"hljs-keyword\">is</span> incremented <span class=\"hljs-keyword\">or</span> decremented <span class=\"hljs-keyword\">every</span> <span class=\"hljs-built_in\">time</span> <span class=\"hljs-keyword\">the</span> value <span class=\"hljs-keyword\">of</span> %N <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">or</span> reverted <span class=\"hljs-keyword\">to</span> a previous value, respectively. This <span class=\"hljs-keyword\">is</span> most useful <span class=\"hljs-keyword\">for</span> debugging <span class=\"hljs-keyword\">as</span> part <span class=\"hljs-keyword\">of</span> $PS4.<br><br>%h%!<br>Current history event <span class=\"hljs-built_in\">number</span>.<br><br>%i<br>The line <span class=\"hljs-built_in\">number</span> currently being executed <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-keyword\">script</span>, sourced <span class=\"hljs-built_in\">file</span>, <span class=\"hljs-keyword\">or</span> shell function <span class=\"hljs-keyword\">given</span> <span class=\"hljs-keyword\">by</span> %N. This <span class=\"hljs-keyword\">is</span> most useful <span class=\"hljs-keyword\">for</span> debugging <span class=\"hljs-keyword\">as</span> part <span class=\"hljs-keyword\">of</span> $PS4.<br><br>%I<br>The line <span class=\"hljs-built_in\">number</span> currently being executed <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">file</span> %x. This <span class=\"hljs-keyword\">is</span> similar <span class=\"hljs-keyword\">to</span> %i, <span class=\"hljs-keyword\">but</span> <span class=\"hljs-keyword\">the</span> line <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">is</span> always a line <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">file</span> <span class=\"hljs-keyword\">where</span> <span class=\"hljs-keyword\">the</span> code was defined, even <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">the</span> code <span class=\"hljs-keyword\">is</span> a shell function.<br><br>%j<br>The <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> jobs.<br><br>%L<br>The current value <span class=\"hljs-keyword\">of</span> $SHLVL.<br><br>%N<br>The <span class=\"hljs-built_in\">name</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-keyword\">script</span>, sourced <span class=\"hljs-built_in\">file</span>, <span class=\"hljs-keyword\">or</span> shell function <span class=\"hljs-keyword\">that</span> zsh <span class=\"hljs-keyword\">is</span> currently executing, whichever was started most recently. If there <span class=\"hljs-keyword\">is</span> none, this <span class=\"hljs-keyword\">is</span> equivalent <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">the</span> parameter $<span class=\"hljs-number\">0.</span> An <span class=\"hljs-built_in\">integer</span> may follow <span class=\"hljs-keyword\">the</span> `%&#x27; <span class=\"hljs-keyword\">to</span> specify a <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> trailing path components <span class=\"hljs-keyword\">to</span> show; zero means <span class=\"hljs-keyword\">the</span> full path. A negative <span class=\"hljs-built_in\">integer</span> specifies leading components.<br><br>%x<br>The <span class=\"hljs-built_in\">name</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">file</span> containing <span class=\"hljs-keyword\">the</span> source code currently being executed. This behaves <span class=\"hljs-keyword\">as</span> %N except <span class=\"hljs-keyword\">that</span> function <span class=\"hljs-keyword\">and</span> eval command names are <span class=\"hljs-keyword\">not</span> shown, instead <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">file</span> <span class=\"hljs-keyword\">where</span> they were defined.<br><br>%c%.%C<br>Trailing component <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> current working directory. An <span class=\"hljs-built_in\">integer</span> may follow <span class=\"hljs-keyword\">the</span> `%&#x27; <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">get</span> more than one component. Unless `%C&#x27; <span class=\"hljs-keyword\">is</span> used, tilde contraction <span class=\"hljs-keyword\">is</span> performed <span class=\"hljs-keyword\">first</span>. These are deprecated <span class=\"hljs-keyword\">as</span> %c <span class=\"hljs-keyword\">and</span> %C are equivalent <span class=\"hljs-keyword\">to</span> %<span class=\"hljs-number\">1</span>~ <span class=\"hljs-keyword\">and</span> %<span class=\"hljs-number\">1</span>/, respectively, <span class=\"hljs-keyword\">while</span> explicit positive integers have <span class=\"hljs-keyword\">the</span> same effect <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">the</span> latter two sequences.<br><br></code></pre></td></tr></table></figure>\n\n\n"},{"layout":"post","title":"å¸¸ç”¨çš„shellè¯­å¥","date":"2022-02-23T16:00:00.000Z","_content":"  \n\n\n# å¸¸ç”¨çš„shellè¯­å¥\n\n[åˆ¤æ–­è½¯ä»¶æ˜¯å¦å®‰è£…](https://blog.csdn.net/baidu_26678247/article/details/103024812)\n\n```\n#!/bin/bash\n\nif [ ! -x \"$(command -v xcodeproj)\" ]; then \n    echo \"xcodeproj is not installed. installing...\" > &2\n    echo \"run 'gem install xcodeproj'\"\n    gem install xcodeproj\nfi\n```\n\n[å½“å‰shellè„šæœ¬æ‰€åœ¨ç›®å½•](https://stackoverflow.com/questions/242538/unix-shell-script-find-out-which-directory-the-script-file-resides)\n\n```\nSCRIPT_DIR=\"$(cd \"$(dirname \"$0\")\"; pwd)\";\n```\n","source":"_posts/Shell/å¸¸ç”¨çš„shellè¯­å¥.md","raw":"---\nlayout: post\ntitle: \"å¸¸ç”¨çš„shellè¯­å¥\"\ndate: 2022-02-24\ntag: Shell\n---  \n\n\n# å¸¸ç”¨çš„shellè¯­å¥\n\n[åˆ¤æ–­è½¯ä»¶æ˜¯å¦å®‰è£…](https://blog.csdn.net/baidu_26678247/article/details/103024812)\n\n```\n#!/bin/bash\n\nif [ ! -x \"$(command -v xcodeproj)\" ]; then \n    echo \"xcodeproj is not installed. installing...\" > &2\n    echo \"run 'gem install xcodeproj'\"\n    gem install xcodeproj\nfi\n```\n\n[å½“å‰shellè„šæœ¬æ‰€åœ¨ç›®å½•](https://stackoverflow.com/questions/242538/unix-shell-script-find-out-which-directory-the-script-file-resides)\n\n```\nSCRIPT_DIR=\"$(cd \"$(dirname \"$0\")\"; pwd)\";\n```\n","slug":"Shell/å¸¸ç”¨çš„shellè¯­å¥","published":1,"updated":"2024-03-07T03:06:00.029Z","comments":1,"photos":[],"_id":"clti3glkl000s57wh74bc4qea","content":"<h1 id=\"å¸¸ç”¨çš„shellè¯­å¥\"><a href=\"#å¸¸ç”¨çš„shellè¯­å¥\" class=\"headerlink\" title=\"å¸¸ç”¨çš„shellè¯­å¥\"></a>å¸¸ç”¨çš„shellè¯­å¥</h1><p><a href=\"https://blog.csdn.net/baidu_26678247/article/details/103024812\">åˆ¤æ–­è½¯ä»¶æ˜¯å¦å®‰è£…</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/bin/bash</span><br><br><span class=\"hljs-keyword\">if</span> [ ! -x <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(command -v xcodeproj)</span>&quot;</span> ]; <span class=\"hljs-keyword\">then</span> <br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;xcodeproj is not installed. installing...&quot;</span> &gt; &amp;2<br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;run &#x27;gem install xcodeproj&#x27;&quot;</span><br>    gem install xcodeproj<br><span class=\"hljs-keyword\">fi</span><br></code></pre></td></tr></table></figure>\n\n<p><a href=\"https://stackoverflow.com/questions/242538/unix-shell-script-find-out-which-directory-the-script-file-resides\">å½“å‰shellè„šæœ¬æ‰€åœ¨ç›®å½•</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">SCRIPT_DIR=<span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(cd <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(dirname <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$0</span>&quot;</span>)</span>&quot;</span>; pwd)</span>&quot;</span>;<br></code></pre></td></tr></table></figure>\n","excerpt":"","more":"<h1 id=\"å¸¸ç”¨çš„shellè¯­å¥\"><a href=\"#å¸¸ç”¨çš„shellè¯­å¥\" class=\"headerlink\" title=\"å¸¸ç”¨çš„shellè¯­å¥\"></a>å¸¸ç”¨çš„shellè¯­å¥</h1><p><a href=\"https://blog.csdn.net/baidu_26678247/article/details/103024812\">åˆ¤æ–­è½¯ä»¶æ˜¯å¦å®‰è£…</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/bin/bash</span><br><br><span class=\"hljs-keyword\">if</span> [ ! -x <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(command -v xcodeproj)</span>&quot;</span> ]; <span class=\"hljs-keyword\">then</span> <br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;xcodeproj is not installed. installing...&quot;</span> &gt; &amp;2<br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;run &#x27;gem install xcodeproj&#x27;&quot;</span><br>    gem install xcodeproj<br><span class=\"hljs-keyword\">fi</span><br></code></pre></td></tr></table></figure>\n\n<p><a href=\"https://stackoverflow.com/questions/242538/unix-shell-script-find-out-which-directory-the-script-file-resides\">å½“å‰shellè„šæœ¬æ‰€åœ¨ç›®å½•</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">SCRIPT_DIR=<span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(cd <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(dirname <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$0</span>&quot;</span>)</span>&quot;</span>; pwd)</span>&quot;</span>;<br></code></pre></td></tr></table></figure>\n"},{"layout":"post","title":"aac adts æ ¼å¼åˆ†æ","date":"2022-09-22T16:00:00.000Z","_content":"\nAACéŸ³é¢‘æ ¼å¼åœ¨MPEG-2ï¼ˆISO-13318-7 2003ï¼‰ä¸­æœ‰å®šä¹‰ã€‚AACåæ¥åˆè¢«é‡‡ç”¨åˆ°MPEG-4æ ‡å‡†ä¸­ã€‚\n\nAAC æœ‰ä¸¤ç§æ ¼å¼ ADIF(Audio Data Interchange Forma) å’Œ ADTS(Audio Data Transport Stream)\n\n- ADIF: ADIFåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¤´ï¼Œæ‰€ä»¥å¿…é¡»å¾—åˆ°æ‰€æœ‰çš„æ•°æ®åè§£ç \n- ADTS: æ¯ä¸€å¸§éƒ½æœ‰å¤´ä¿¡æ¯, å¯ä»¥åœ¨ä»»æ„å¸§è§£ç \n\n\n## ADIF\n\nadifå¤´ + å¯¹é½å­—èŠ‚ + æ•°æ®å—\n\n```\nadif_sequence() {\n    adif_header();\n    byte_alignment();\n    raw_data_stream();\n}\n```\n## ADTS\næ•°æ®æµæ˜¯ä¸€å¸§ä¸€å¸§çš„adtsï¼Œå¯ä»¥åœ¨ä»»ä½•ä½ç½®è§£ç ã€‚\n```\nadts_sequence() {\n    while (nextbits() == syncword) \n    { \n        adts_frame();\n    } \n}\n```\n## adts_frame\n```\nadts_frame() {\n    adts_fixed_header();\n    adts_variable_header();\n    if (number_of_raw_data_blocks_in_frame == 0) {\n        adts_error_check();\n        raw_data_block(); \n    }\n    else {\n        adts_header_error_check();\n        for (i = 0; i <= number_of_raw_data_blocks_in_frame; i++) {\n            raw_data_block();\n            adts_raw_data_block_error_check();\n        }\n    }\n} \n```\n\næ¯ä¸€å¸§éƒ½æœ‰28ä½çš„å›ºå®šheader + 28ä½çš„å¯å˜headerç»„æˆçš„ï¼Œå…±7å­—èŠ‚ã€‚\n### adts_fixed_header\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653251125631665325112115.png)\n\n**syncword**\n\nThe bit string `1111 1111 1111`.\n\n**ID**\n\n0 for MPEG-4, 1 for MPEG-2\n\n**layer**\n\nIndicates which layer is used. Set to `00`.\n\n**protection_absent**\n\nIndicates whether error_check() data is present or not.\n0 å­˜åœ¨ï¼Œ1 ä¸å­˜åœ¨ã€‚\n\n**profile**\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653255915411665325591471.png)\n\n**sampling_frequency_index**\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653256535451665325652832.png)\n\n**private_bit**\n\nBit for private use. This bit will not be used in the future by ISO/IEC.\nset to 0 when encoding, ignore when decoding ï¼Ÿï¼Ÿ\n\n**channel_configuration**\n\nå£°é“ä¿¡æ¯ï¼Œå¤§äº0 æ ¹æ®ä¸‹è¡¨æ¥å†³å®šï¼Œ ç­‰äº0ï¼Ÿ\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653263524151665326351568.png)\n\n**original/copy**\n\nThis bit equals 'O if the bitstream is a copy, '1' if it is an original.\n\nç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?\n\n**home**\n\nç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?\n\n### adts_variable_header\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653274014091665327401231.png)\n\n\n**copyright_identification_bit**\n\nç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?\n\n**copyright_identification_start**\n\nç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?\n\n**frame_length**\n\nLength of the frame including headers and error_check in bytes\n\n\n\n**adts_buffer_fullness**\n> state of the bit reservoir in the course of encoding the ADTS frame, up to and including the first raw_data_block(). It is transmitted as the number of available bits in the bit reservoir divided by NCC divided by 32 and truncated to an integer value (Table 9). A value of hexadecimal 7FF signals that the bitstream is a variable rate bitstream. In this case, buffer fullness is not applicable\n\n0x7FF ä»£è¡¨ç ç‡æ˜¯å¯å˜çš„ã€‚\n\n**number_of_raw_data_blocks_in_frame**\n> Number of raw_data_block()â€™s that are multiplexed in the adts_frame() is equal to\nraw_data_block_position[i]\nnumber_of_raw_data_blocks_in_frame + 1. The minimum value is 0 indicating 1 raw_data_block()\n\n\næ ¹æ® `number_of_raw_data_blocks_in_frame` æ˜¯å¦ç­‰äº 0 åšåŒºåˆ†\n- ç­‰äº0ï¼Œ è¯¥å¸§é‡Œé¢ä¸­åªæœ‰ä¸€ä¸ªraw_data_block\n- å¤§äº0ï¼Œ è¯¥å¸§ä¸­æœ‰`number_of_raw_data_blocks_in_frame + 1`ä¸ªraw_data_block\n- å¤§äº 0 çš„æƒ…å†µè¾ƒå°‘è§?\n- æ¯ä¸ªraw_data_blockå¯¹åº”äº1024ä¸ªé‡‡æ ·?\n\n### adts_error_check\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653285183621665328517592.png)\n\næ˜¯å¦å¼€å¯å¾ªç¯å†—ä½™æ ¡éªŒï¼Œå¼€å¯åheaderæ€»é•¿ï¼ˆ28 + 28 + 16 = 72ï¼‰9ä¸ªå­—èŠ‚ã€‚\n\n### adts_header_error_check\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653287093611665328708587.png)\n\n\n**raw_data_block_position[i]**\n>Start position of the i-th raw_data_block() in the adts_frame(), measured as an offset in bytes from the start position of the first raw_data_block() in the adts_frame().\n\nå¦‚æœå¼€å¯å¾ªç¯å†—ä½™æ ¡éªŒï¼Œå¹¶ä¸”`number_of_raw_data_blocks_in_frame > 0`, è®°å½•æ¯ä¸ª`raw_data_block`å¼€å§‹ä½ç½®ï¼Œæ·»åŠ crcæ ¡éªŒã€‚\n\n### raw_data_block\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653290063481665329006023.png)\n\nåˆ¤æ–­å£°é“ï¼Œæ ¹æ®å£°é“ä¼šæœ‰å˜åŒ–ã€‚\n\n###  adts_raw_data_block_error_check\n\næ¯ä¸ª`raw_data_block`å¯¹åº”çš„æ ¡éªŒã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653291083431665329107537.png)\n\n\n## å·¥å…·\n\nè®¿é—®[https://www.p23.nl/projects/aac-header/](https://www.p23.nl/projects/aac-header/), å¯ä»¥è¾“å…¥è‡ªå·±çš„aac æ–‡ä»¶å¤´éƒ¨ï¼Œ åˆ†æaac header ä¿¡æ¯ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653292653371665329265242.png)\n\n","source":"_posts/aac/2022-09-23-aac-adts.md","raw":"---\nlayout: post\ntitle: \"aac adts æ ¼å¼åˆ†æ\"\ndate: 2022-09-23 \ntag: aac\n---\n\nAACéŸ³é¢‘æ ¼å¼åœ¨MPEG-2ï¼ˆISO-13318-7 2003ï¼‰ä¸­æœ‰å®šä¹‰ã€‚AACåæ¥åˆè¢«é‡‡ç”¨åˆ°MPEG-4æ ‡å‡†ä¸­ã€‚\n\nAAC æœ‰ä¸¤ç§æ ¼å¼ ADIF(Audio Data Interchange Forma) å’Œ ADTS(Audio Data Transport Stream)\n\n- ADIF: ADIFåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¤´ï¼Œæ‰€ä»¥å¿…é¡»å¾—åˆ°æ‰€æœ‰çš„æ•°æ®åè§£ç \n- ADTS: æ¯ä¸€å¸§éƒ½æœ‰å¤´ä¿¡æ¯, å¯ä»¥åœ¨ä»»æ„å¸§è§£ç \n\n\n## ADIF\n\nadifå¤´ + å¯¹é½å­—èŠ‚ + æ•°æ®å—\n\n```\nadif_sequence() {\n    adif_header();\n    byte_alignment();\n    raw_data_stream();\n}\n```\n## ADTS\næ•°æ®æµæ˜¯ä¸€å¸§ä¸€å¸§çš„adtsï¼Œå¯ä»¥åœ¨ä»»ä½•ä½ç½®è§£ç ã€‚\n```\nadts_sequence() {\n    while (nextbits() == syncword) \n    { \n        adts_frame();\n    } \n}\n```\n## adts_frame\n```\nadts_frame() {\n    adts_fixed_header();\n    adts_variable_header();\n    if (number_of_raw_data_blocks_in_frame == 0) {\n        adts_error_check();\n        raw_data_block(); \n    }\n    else {\n        adts_header_error_check();\n        for (i = 0; i <= number_of_raw_data_blocks_in_frame; i++) {\n            raw_data_block();\n            adts_raw_data_block_error_check();\n        }\n    }\n} \n```\n\næ¯ä¸€å¸§éƒ½æœ‰28ä½çš„å›ºå®šheader + 28ä½çš„å¯å˜headerç»„æˆçš„ï¼Œå…±7å­—èŠ‚ã€‚\n### adts_fixed_header\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653251125631665325112115.png)\n\n**syncword**\n\nThe bit string `1111 1111 1111`.\n\n**ID**\n\n0 for MPEG-4, 1 for MPEG-2\n\n**layer**\n\nIndicates which layer is used. Set to `00`.\n\n**protection_absent**\n\nIndicates whether error_check() data is present or not.\n0 å­˜åœ¨ï¼Œ1 ä¸å­˜åœ¨ã€‚\n\n**profile**\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653255915411665325591471.png)\n\n**sampling_frequency_index**\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653256535451665325652832.png)\n\n**private_bit**\n\nBit for private use. This bit will not be used in the future by ISO/IEC.\nset to 0 when encoding, ignore when decoding ï¼Ÿï¼Ÿ\n\n**channel_configuration**\n\nå£°é“ä¿¡æ¯ï¼Œå¤§äº0 æ ¹æ®ä¸‹è¡¨æ¥å†³å®šï¼Œ ç­‰äº0ï¼Ÿ\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653263524151665326351568.png)\n\n**original/copy**\n\nThis bit equals 'O if the bitstream is a copy, '1' if it is an original.\n\nç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?\n\n**home**\n\nç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?\n\n### adts_variable_header\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653274014091665327401231.png)\n\n\n**copyright_identification_bit**\n\nç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?\n\n**copyright_identification_start**\n\nç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?\n\n**frame_length**\n\nLength of the frame including headers and error_check in bytes\n\n\n\n**adts_buffer_fullness**\n> state of the bit reservoir in the course of encoding the ADTS frame, up to and including the first raw_data_block(). It is transmitted as the number of available bits in the bit reservoir divided by NCC divided by 32 and truncated to an integer value (Table 9). A value of hexadecimal 7FF signals that the bitstream is a variable rate bitstream. In this case, buffer fullness is not applicable\n\n0x7FF ä»£è¡¨ç ç‡æ˜¯å¯å˜çš„ã€‚\n\n**number_of_raw_data_blocks_in_frame**\n> Number of raw_data_block()â€™s that are multiplexed in the adts_frame() is equal to\nraw_data_block_position[i]\nnumber_of_raw_data_blocks_in_frame + 1. The minimum value is 0 indicating 1 raw_data_block()\n\n\næ ¹æ® `number_of_raw_data_blocks_in_frame` æ˜¯å¦ç­‰äº 0 åšåŒºåˆ†\n- ç­‰äº0ï¼Œ è¯¥å¸§é‡Œé¢ä¸­åªæœ‰ä¸€ä¸ªraw_data_block\n- å¤§äº0ï¼Œ è¯¥å¸§ä¸­æœ‰`number_of_raw_data_blocks_in_frame + 1`ä¸ªraw_data_block\n- å¤§äº 0 çš„æƒ…å†µè¾ƒå°‘è§?\n- æ¯ä¸ªraw_data_blockå¯¹åº”äº1024ä¸ªé‡‡æ ·?\n\n### adts_error_check\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653285183621665328517592.png)\n\næ˜¯å¦å¼€å¯å¾ªç¯å†—ä½™æ ¡éªŒï¼Œå¼€å¯åheaderæ€»é•¿ï¼ˆ28 + 28 + 16 = 72ï¼‰9ä¸ªå­—èŠ‚ã€‚\n\n### adts_header_error_check\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653287093611665328708587.png)\n\n\n**raw_data_block_position[i]**\n>Start position of the i-th raw_data_block() in the adts_frame(), measured as an offset in bytes from the start position of the first raw_data_block() in the adts_frame().\n\nå¦‚æœå¼€å¯å¾ªç¯å†—ä½™æ ¡éªŒï¼Œå¹¶ä¸”`number_of_raw_data_blocks_in_frame > 0`, è®°å½•æ¯ä¸ª`raw_data_block`å¼€å§‹ä½ç½®ï¼Œæ·»åŠ crcæ ¡éªŒã€‚\n\n### raw_data_block\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653290063481665329006023.png)\n\nåˆ¤æ–­å£°é“ï¼Œæ ¹æ®å£°é“ä¼šæœ‰å˜åŒ–ã€‚\n\n###  adts_raw_data_block_error_check\n\næ¯ä¸ª`raw_data_block`å¯¹åº”çš„æ ¡éªŒã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653291083431665329107537.png)\n\n\n## å·¥å…·\n\nè®¿é—®[https://www.p23.nl/projects/aac-header/](https://www.p23.nl/projects/aac-header/), å¯ä»¥è¾“å…¥è‡ªå·±çš„aac æ–‡ä»¶å¤´éƒ¨ï¼Œ åˆ†æaac header ä¿¡æ¯ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653292653371665329265242.png)\n\n","slug":"aac/2022-09-23-aac-adts","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkl000u57wh5hl2ezjv","content":"<p>AACéŸ³é¢‘æ ¼å¼åœ¨MPEG-2ï¼ˆISO-13318-7 2003ï¼‰ä¸­æœ‰å®šä¹‰ã€‚AACåæ¥åˆè¢«é‡‡ç”¨åˆ°MPEG-4æ ‡å‡†ä¸­ã€‚</p>\n<p>AAC æœ‰ä¸¤ç§æ ¼å¼ ADIF(Audio Data Interchange Forma) å’Œ ADTS(Audio Data Transport Stream)</p>\n<ul>\n<li>ADIF: ADIFåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¤´ï¼Œæ‰€ä»¥å¿…é¡»å¾—åˆ°æ‰€æœ‰çš„æ•°æ®åè§£ç </li>\n<li>ADTS: æ¯ä¸€å¸§éƒ½æœ‰å¤´ä¿¡æ¯, å¯ä»¥åœ¨ä»»æ„å¸§è§£ç </li>\n</ul>\n<h2 id=\"ADIF\"><a href=\"#ADIF\" class=\"headerlink\" title=\"ADIF\"></a>ADIF</h2><p>adifå¤´ + å¯¹é½å­—èŠ‚ + æ•°æ®å—</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">adif_sequence</span>() &#123;<br>    <span class=\"hljs-built_in\">adif_header</span>();<br>    <span class=\"hljs-built_in\">byte_alignment</span>();<br>    <span class=\"hljs-built_in\">raw_data_stream</span>();<br>&#125;<br></code></pre></td></tr></table></figure>\n<h2 id=\"ADTS\"><a href=\"#ADTS\" class=\"headerlink\" title=\"ADTS\"></a>ADTS</h2><p>æ•°æ®æµæ˜¯ä¸€å¸§ä¸€å¸§çš„adtsï¼Œå¯ä»¥åœ¨ä»»ä½•ä½ç½®è§£ç ã€‚</p>\n<figure class=\"highlight isbl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs isbl\"><span class=\"hljs-function\"><span class=\"hljs-title\">adts_sequence</span>() &#123;</span><br><span class=\"hljs-function\">    <span class=\"hljs-variable\"><span class=\"hljs-keyword\">while</span></span> (<span class=\"hljs-title\">nextbits</span>() == <span class=\"hljs-variable\">syncword</span>) </span><br><span class=\"hljs-function\">    &#123; </span><br><span class=\"hljs-function\">        <span class=\"hljs-title\">adts_frame</span>();</span><br><span class=\"hljs-function\">    &#125; </span><br><span class=\"hljs-function\">&#125;</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"adts-frame\"><a href=\"#adts-frame\" class=\"headerlink\" title=\"adts_frame\"></a>adts_frame</h2><figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">adts_frame</span>() &#123;<br>    <span class=\"hljs-built_in\">adts_fixed_header</span>();<br>    <span class=\"hljs-built_in\">adts_variable_header</span>();<br>    if (number_of_raw_data_blocks_in_frame == <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">adts_error_check</span>();<br>        <span class=\"hljs-built_in\">raw_data_block</span>(); <br>    &#125;<br>    else &#123;<br>        <span class=\"hljs-built_in\">adts_header_error_check</span>();<br>        for (i = <span class=\"hljs-number\">0</span>; i &lt;= number_of_raw_data_blocks_in_frame; i++) &#123;<br>            <span class=\"hljs-built_in\">raw_data_block</span>();<br>            <span class=\"hljs-built_in\">adts_raw_data_block_error_check</span>();<br>        &#125;<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure>\n\n<p>æ¯ä¸€å¸§éƒ½æœ‰28ä½çš„å›ºå®šheader + 28ä½çš„å¯å˜headerç»„æˆçš„ï¼Œå…±7å­—èŠ‚ã€‚</p>\n<h3 id=\"adts-fixed-header\"><a href=\"#adts-fixed-header\" class=\"headerlink\" title=\"adts_fixed_header\"></a>adts_fixed_header</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653251125631665325112115.png\"></p>\n<p><strong>syncword</strong></p>\n<p>The bit string <code>1111 1111 1111</code>.</p>\n<p><strong>ID</strong></p>\n<p>0 for MPEG-4, 1 for MPEG-2</p>\n<p><strong>layer</strong></p>\n<p>Indicates which layer is used. Set to <code>00</code>.</p>\n<p><strong>protection_absent</strong></p>\n<p>Indicates whether error_check() data is present or not.<br>0 å­˜åœ¨ï¼Œ1 ä¸å­˜åœ¨ã€‚</p>\n<p><strong>profile</strong></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653255915411665325591471.png\"></p>\n<p><strong>sampling_frequency_index</strong></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653256535451665325652832.png\"></p>\n<p><strong>private_bit</strong></p>\n<p>Bit for private use. This bit will not be used in the future by ISO&#x2F;IEC.<br>set to 0 when encoding, ignore when decoding ï¼Ÿï¼Ÿ</p>\n<p><strong>channel_configuration</strong></p>\n<p>å£°é“ä¿¡æ¯ï¼Œå¤§äº0 æ ¹æ®ä¸‹è¡¨æ¥å†³å®šï¼Œ ç­‰äº0ï¼Ÿ</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653263524151665326351568.png\"></p>\n<p><strong>original&#x2F;copy</strong></p>\n<p>This bit equals â€˜O if the bitstream is a copy, â€˜1â€™ if it is an original.</p>\n<p>ç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?</p>\n<p><strong>home</strong></p>\n<p>ç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?</p>\n<h3 id=\"adts-variable-header\"><a href=\"#adts-variable-header\" class=\"headerlink\" title=\"adts_variable_header\"></a>adts_variable_header</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653274014091665327401231.png\"></p>\n<p><strong>copyright_identification_bit</strong></p>\n<p>ç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?</p>\n<p><strong>copyright_identification_start</strong></p>\n<p>ç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?</p>\n<p><strong>frame_length</strong></p>\n<p>Length of the frame including headers and error_check in bytes</p>\n<p><strong>adts_buffer_fullness</strong></p>\n<blockquote>\n<p>state of the bit reservoir in the course of encoding the ADTS frame, up to and including the first raw_data_block(). It is transmitted as the number of available bits in the bit reservoir divided by NCC divided by 32 and truncated to an integer value (Table 9). A value of hexadecimal 7FF signals that the bitstream is a variable rate bitstream. In this case, buffer fullness is not applicable</p>\n</blockquote>\n<p>0x7FF ä»£è¡¨ç ç‡æ˜¯å¯å˜çš„ã€‚</p>\n<p><strong>number_of_raw_data_blocks_in_frame</strong></p>\n<blockquote>\n<p>Number of raw_data_block()â€™s that are multiplexed in the adts_frame() is equal to<br>raw_data_block_position[i]<br>number_of_raw_data_blocks_in_frame + 1. The minimum value is 0 indicating 1 raw_data_block()</p>\n</blockquote>\n<p>æ ¹æ® <code>number_of_raw_data_blocks_in_frame</code> æ˜¯å¦ç­‰äº 0 åšåŒºåˆ†</p>\n<ul>\n<li>ç­‰äº0ï¼Œ è¯¥å¸§é‡Œé¢ä¸­åªæœ‰ä¸€ä¸ªraw_data_block</li>\n<li>å¤§äº0ï¼Œ è¯¥å¸§ä¸­æœ‰<code>number_of_raw_data_blocks_in_frame + 1</code>ä¸ªraw_data_block</li>\n<li>å¤§äº 0 çš„æƒ…å†µè¾ƒå°‘è§?</li>\n<li>æ¯ä¸ªraw_data_blockå¯¹åº”äº1024ä¸ªé‡‡æ ·?</li>\n</ul>\n<h3 id=\"adts-error-check\"><a href=\"#adts-error-check\" class=\"headerlink\" title=\"adts_error_check\"></a>adts_error_check</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653285183621665328517592.png\"></p>\n<p>æ˜¯å¦å¼€å¯å¾ªç¯å†—ä½™æ ¡éªŒï¼Œå¼€å¯åheaderæ€»é•¿ï¼ˆ28 + 28 + 16 &#x3D; 72ï¼‰9ä¸ªå­—èŠ‚ã€‚</p>\n<h3 id=\"adts-header-error-check\"><a href=\"#adts-header-error-check\" class=\"headerlink\" title=\"adts_header_error_check\"></a>adts_header_error_check</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653287093611665328708587.png\"></p>\n<p><strong>raw_data_block_position[i]</strong></p>\n<blockquote>\n<p>Start position of the i-th raw_data_block() in the adts_frame(), measured as an offset in bytes from the start position of the first raw_data_block() in the adts_frame().</p>\n</blockquote>\n<p>å¦‚æœå¼€å¯å¾ªç¯å†—ä½™æ ¡éªŒï¼Œå¹¶ä¸”<code>number_of_raw_data_blocks_in_frame &gt; 0</code>, è®°å½•æ¯ä¸ª<code>raw_data_block</code>å¼€å§‹ä½ç½®ï¼Œæ·»åŠ crcæ ¡éªŒã€‚</p>\n<h3 id=\"raw-data-block\"><a href=\"#raw-data-block\" class=\"headerlink\" title=\"raw_data_block\"></a>raw_data_block</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653290063481665329006023.png\"></p>\n<p>åˆ¤æ–­å£°é“ï¼Œæ ¹æ®å£°é“ä¼šæœ‰å˜åŒ–ã€‚</p>\n<h3 id=\"adts-raw-data-block-error-check\"><a href=\"#adts-raw-data-block-error-check\" class=\"headerlink\" title=\"adts_raw_data_block_error_check\"></a>adts_raw_data_block_error_check</h3><p>æ¯ä¸ª<code>raw_data_block</code>å¯¹åº”çš„æ ¡éªŒã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653291083431665329107537.png\"></p>\n<h2 id=\"å·¥å…·\"><a href=\"#å·¥å…·\" class=\"headerlink\" title=\"å·¥å…·\"></a>å·¥å…·</h2><p>è®¿é—®<a href=\"https://www.p23.nl/projects/aac-header/\">https://www.p23.nl/projects/aac-header/</a>, å¯ä»¥è¾“å…¥è‡ªå·±çš„aac æ–‡ä»¶å¤´éƒ¨ï¼Œ åˆ†æaac header ä¿¡æ¯ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653292653371665329265242.png\"></p>\n","excerpt":"","more":"<p>AACéŸ³é¢‘æ ¼å¼åœ¨MPEG-2ï¼ˆISO-13318-7 2003ï¼‰ä¸­æœ‰å®šä¹‰ã€‚AACåæ¥åˆè¢«é‡‡ç”¨åˆ°MPEG-4æ ‡å‡†ä¸­ã€‚</p>\n<p>AAC æœ‰ä¸¤ç§æ ¼å¼ ADIF(Audio Data Interchange Forma) å’Œ ADTS(Audio Data Transport Stream)</p>\n<ul>\n<li>ADIF: ADIFåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¤´ï¼Œæ‰€ä»¥å¿…é¡»å¾—åˆ°æ‰€æœ‰çš„æ•°æ®åè§£ç </li>\n<li>ADTS: æ¯ä¸€å¸§éƒ½æœ‰å¤´ä¿¡æ¯, å¯ä»¥åœ¨ä»»æ„å¸§è§£ç </li>\n</ul>\n<h2 id=\"ADIF\"><a href=\"#ADIF\" class=\"headerlink\" title=\"ADIF\"></a>ADIF</h2><p>adifå¤´ + å¯¹é½å­—èŠ‚ + æ•°æ®å—</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">adif_sequence</span>() &#123;<br>    <span class=\"hljs-built_in\">adif_header</span>();<br>    <span class=\"hljs-built_in\">byte_alignment</span>();<br>    <span class=\"hljs-built_in\">raw_data_stream</span>();<br>&#125;<br></code></pre></td></tr></table></figure>\n<h2 id=\"ADTS\"><a href=\"#ADTS\" class=\"headerlink\" title=\"ADTS\"></a>ADTS</h2><p>æ•°æ®æµæ˜¯ä¸€å¸§ä¸€å¸§çš„adtsï¼Œå¯ä»¥åœ¨ä»»ä½•ä½ç½®è§£ç ã€‚</p>\n<figure class=\"highlight isbl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs isbl\"><span class=\"hljs-function\"><span class=\"hljs-title\">adts_sequence</span>() &#123;</span><br><span class=\"hljs-function\">    <span class=\"hljs-variable\"><span class=\"hljs-keyword\">while</span></span> (<span class=\"hljs-title\">nextbits</span>() == <span class=\"hljs-variable\">syncword</span>) </span><br><span class=\"hljs-function\">    &#123; </span><br><span class=\"hljs-function\">        <span class=\"hljs-title\">adts_frame</span>();</span><br><span class=\"hljs-function\">    &#125; </span><br><span class=\"hljs-function\">&#125;</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"adts-frame\"><a href=\"#adts-frame\" class=\"headerlink\" title=\"adts_frame\"></a>adts_frame</h2><figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">adts_frame</span>() &#123;<br>    <span class=\"hljs-built_in\">adts_fixed_header</span>();<br>    <span class=\"hljs-built_in\">adts_variable_header</span>();<br>    if (number_of_raw_data_blocks_in_frame == <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">adts_error_check</span>();<br>        <span class=\"hljs-built_in\">raw_data_block</span>(); <br>    &#125;<br>    else &#123;<br>        <span class=\"hljs-built_in\">adts_header_error_check</span>();<br>        for (i = <span class=\"hljs-number\">0</span>; i &lt;= number_of_raw_data_blocks_in_frame; i++) &#123;<br>            <span class=\"hljs-built_in\">raw_data_block</span>();<br>            <span class=\"hljs-built_in\">adts_raw_data_block_error_check</span>();<br>        &#125;<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure>\n\n<p>æ¯ä¸€å¸§éƒ½æœ‰28ä½çš„å›ºå®šheader + 28ä½çš„å¯å˜headerç»„æˆçš„ï¼Œå…±7å­—èŠ‚ã€‚</p>\n<h3 id=\"adts-fixed-header\"><a href=\"#adts-fixed-header\" class=\"headerlink\" title=\"adts_fixed_header\"></a>adts_fixed_header</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653251125631665325112115.png\"></p>\n<p><strong>syncword</strong></p>\n<p>The bit string <code>1111 1111 1111</code>.</p>\n<p><strong>ID</strong></p>\n<p>0 for MPEG-4, 1 for MPEG-2</p>\n<p><strong>layer</strong></p>\n<p>Indicates which layer is used. Set to <code>00</code>.</p>\n<p><strong>protection_absent</strong></p>\n<p>Indicates whether error_check() data is present or not.<br>0 å­˜åœ¨ï¼Œ1 ä¸å­˜åœ¨ã€‚</p>\n<p><strong>profile</strong></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653255915411665325591471.png\"></p>\n<p><strong>sampling_frequency_index</strong></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653256535451665325652832.png\"></p>\n<p><strong>private_bit</strong></p>\n<p>Bit for private use. This bit will not be used in the future by ISO&#x2F;IEC.<br>set to 0 when encoding, ignore when decoding ï¼Ÿï¼Ÿ</p>\n<p><strong>channel_configuration</strong></p>\n<p>å£°é“ä¿¡æ¯ï¼Œå¤§äº0 æ ¹æ®ä¸‹è¡¨æ¥å†³å®šï¼Œ ç­‰äº0ï¼Ÿ</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653263524151665326351568.png\"></p>\n<p><strong>original&#x2F;copy</strong></p>\n<p>This bit equals â€˜O if the bitstream is a copy, â€˜1â€™ if it is an original.</p>\n<p>ç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?</p>\n<p><strong>home</strong></p>\n<p>ç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?</p>\n<h3 id=\"adts-variable-header\"><a href=\"#adts-variable-header\" class=\"headerlink\" title=\"adts_variable_header\"></a>adts_variable_header</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653274014091665327401231.png\"></p>\n<p><strong>copyright_identification_bit</strong></p>\n<p>ç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?</p>\n<p><strong>copyright_identification_start</strong></p>\n<p>ç¼–ç æ—¶è®¾ç½®ä¸º0ï¼Œè§£ç æ—¶å¿½ç•¥?</p>\n<p><strong>frame_length</strong></p>\n<p>Length of the frame including headers and error_check in bytes</p>\n<p><strong>adts_buffer_fullness</strong></p>\n<blockquote>\n<p>state of the bit reservoir in the course of encoding the ADTS frame, up to and including the first raw_data_block(). It is transmitted as the number of available bits in the bit reservoir divided by NCC divided by 32 and truncated to an integer value (Table 9). A value of hexadecimal 7FF signals that the bitstream is a variable rate bitstream. In this case, buffer fullness is not applicable</p>\n</blockquote>\n<p>0x7FF ä»£è¡¨ç ç‡æ˜¯å¯å˜çš„ã€‚</p>\n<p><strong>number_of_raw_data_blocks_in_frame</strong></p>\n<blockquote>\n<p>Number of raw_data_block()â€™s that are multiplexed in the adts_frame() is equal to<br>raw_data_block_position[i]<br>number_of_raw_data_blocks_in_frame + 1. The minimum value is 0 indicating 1 raw_data_block()</p>\n</blockquote>\n<p>æ ¹æ® <code>number_of_raw_data_blocks_in_frame</code> æ˜¯å¦ç­‰äº 0 åšåŒºåˆ†</p>\n<ul>\n<li>ç­‰äº0ï¼Œ è¯¥å¸§é‡Œé¢ä¸­åªæœ‰ä¸€ä¸ªraw_data_block</li>\n<li>å¤§äº0ï¼Œ è¯¥å¸§ä¸­æœ‰<code>number_of_raw_data_blocks_in_frame + 1</code>ä¸ªraw_data_block</li>\n<li>å¤§äº 0 çš„æƒ…å†µè¾ƒå°‘è§?</li>\n<li>æ¯ä¸ªraw_data_blockå¯¹åº”äº1024ä¸ªé‡‡æ ·?</li>\n</ul>\n<h3 id=\"adts-error-check\"><a href=\"#adts-error-check\" class=\"headerlink\" title=\"adts_error_check\"></a>adts_error_check</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653285183621665328517592.png\"></p>\n<p>æ˜¯å¦å¼€å¯å¾ªç¯å†—ä½™æ ¡éªŒï¼Œå¼€å¯åheaderæ€»é•¿ï¼ˆ28 + 28 + 16 &#x3D; 72ï¼‰9ä¸ªå­—èŠ‚ã€‚</p>\n<h3 id=\"adts-header-error-check\"><a href=\"#adts-header-error-check\" class=\"headerlink\" title=\"adts_header_error_check\"></a>adts_header_error_check</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653287093611665328708587.png\"></p>\n<p><strong>raw_data_block_position[i]</strong></p>\n<blockquote>\n<p>Start position of the i-th raw_data_block() in the adts_frame(), measured as an offset in bytes from the start position of the first raw_data_block() in the adts_frame().</p>\n</blockquote>\n<p>å¦‚æœå¼€å¯å¾ªç¯å†—ä½™æ ¡éªŒï¼Œå¹¶ä¸”<code>number_of_raw_data_blocks_in_frame &gt; 0</code>, è®°å½•æ¯ä¸ª<code>raw_data_block</code>å¼€å§‹ä½ç½®ï¼Œæ·»åŠ crcæ ¡éªŒã€‚</p>\n<h3 id=\"raw-data-block\"><a href=\"#raw-data-block\" class=\"headerlink\" title=\"raw_data_block\"></a>raw_data_block</h3><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653290063481665329006023.png\"></p>\n<p>åˆ¤æ–­å£°é“ï¼Œæ ¹æ®å£°é“ä¼šæœ‰å˜åŒ–ã€‚</p>\n<h3 id=\"adts-raw-data-block-error-check\"><a href=\"#adts-raw-data-block-error-check\" class=\"headerlink\" title=\"adts_raw_data_block_error_check\"></a>adts_raw_data_block_error_check</h3><p>æ¯ä¸ª<code>raw_data_block</code>å¯¹åº”çš„æ ¡éªŒã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653291083431665329107537.png\"></p>\n<h2 id=\"å·¥å…·\"><a href=\"#å·¥å…·\" class=\"headerlink\" title=\"å·¥å…·\"></a>å·¥å…·</h2><p>è®¿é—®<a href=\"https://www.p23.nl/projects/aac-header/\">https://www.p23.nl/projects/aac-header/</a>, å¯ä»¥è¾“å…¥è‡ªå·±çš„aac æ–‡ä»¶å¤´éƒ¨ï¼Œ åˆ†æaac header ä¿¡æ¯ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16653292653371665329265242.png\"></p>\n"},{"layout":"post","title":"fdk aac","date":"2022-09-22T16:00:00.000Z","_content":"\ngithub åœ°å€ï¼š https://github.com/mstorsjo/fdk-aac\n\nfdk-aac æä¾›äº†è·¨å¹³å°çš„ç¼–è§£ç  aac çš„åŠŸèƒ½ã€‚\n\n## ç¼–è¯‘\nfdk-aacæä¾›äº†CMakeæ„å»ºé™æ€åº“å’ŒåŠ¨æ€åº“ã€‚\n```\ncd fdk-aac\nmkidr build \n#BUILD_SHARED_LIBS æ§åˆ¶æ„å»ºé™æ€åº“è¿˜æ˜¯åŠ¨æ€åº“\ncmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF\ncmake --build --config Release\n# install\ncmake --install <dir> --prefix <prefix>\n```\n## æ–‡æ¡£\n\nåœ¨documentationç›®å½•ä¸‹ï¼Œæœ‰ä¸¤ä¸ªpdfæ–‡ä»¶ï¼Œåˆ†åˆ«å¯¹åº”ç¼–ç å’Œè§£ç ç›¸å…³çš„æ–‡æ¡£ã€‚\n```\naacDecoder.pdf\naacEncoder.pdf\n```\n\n## demo\nfdk-aac æä¾›ä¸€ä¸ªç¼–ç çš„ç¤ºä¾‹`aac-enc.c`ï¼Œ ä¸»è¦ä»‹ç»å¦‚ä½•å®ç°aac ç¼–ç åŠŸèƒ½\nè¯¥demo å¯ä»¥é€šè¿‡cmakeæ¥è°ƒè¯•ã€‚\né¦–å…ˆåœ¨cmake ä¸­å¯ç”¨è¯¥ç¨‹åºï¼Œç»™cmake ä¼ é€’å‚æ•°`-DBUILD_PROGRAMS=TRUE`\n\nè¿è¡Œæ„å»ºåçš„ç¨‹åº \n```\naac-enc [-r bitrate] [-t aot] [-a afterburner] [-s sbr] [-v vbr] in.wav out.aac\n```\nè¯¥ç¨‹åºå¯ä»¥è¯»å–wavéŸ³é¢‘æ–‡ä»¶ï¼Œç¼–ç ä¸ºaacï¼Œå°†ç¼–ç åçš„æ•°æ®å†™å…¥`out.aac` æ–‡ä»¶ä¸­ã€‚\n\n\n## æ³¨æ„äº‹é¡¹\n\nfdk-aac åªæ”¯æŒé‡‡æ ·æ ¼å¼ä¸º`int16`ç±»å‹çš„å®šç‚¹æ ¼å¼ï¼Œä¸æ”¯æŒå¦‚`float32`ç±»å‹çš„æµ®ç‚¹æ ¼å¼ã€‚\n\nfdk-aac é»˜è®¤ä¸€å¸§1024ä¸ªé‡‡æ ·ã€‚\n\n\n\n\n\n\n\n\n\n","source":"_posts/aac/2022-09-23-fdk-aac.md","raw":"---\nlayout: post\ntitle: \"fdk aac\"\ndate: 2022-09-23 \ntag: aac\n---\n\ngithub åœ°å€ï¼š https://github.com/mstorsjo/fdk-aac\n\nfdk-aac æä¾›äº†è·¨å¹³å°çš„ç¼–è§£ç  aac çš„åŠŸèƒ½ã€‚\n\n## ç¼–è¯‘\nfdk-aacæä¾›äº†CMakeæ„å»ºé™æ€åº“å’ŒåŠ¨æ€åº“ã€‚\n```\ncd fdk-aac\nmkidr build \n#BUILD_SHARED_LIBS æ§åˆ¶æ„å»ºé™æ€åº“è¿˜æ˜¯åŠ¨æ€åº“\ncmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF\ncmake --build --config Release\n# install\ncmake --install <dir> --prefix <prefix>\n```\n## æ–‡æ¡£\n\nåœ¨documentationç›®å½•ä¸‹ï¼Œæœ‰ä¸¤ä¸ªpdfæ–‡ä»¶ï¼Œåˆ†åˆ«å¯¹åº”ç¼–ç å’Œè§£ç ç›¸å…³çš„æ–‡æ¡£ã€‚\n```\naacDecoder.pdf\naacEncoder.pdf\n```\n\n## demo\nfdk-aac æä¾›ä¸€ä¸ªç¼–ç çš„ç¤ºä¾‹`aac-enc.c`ï¼Œ ä¸»è¦ä»‹ç»å¦‚ä½•å®ç°aac ç¼–ç åŠŸèƒ½\nè¯¥demo å¯ä»¥é€šè¿‡cmakeæ¥è°ƒè¯•ã€‚\né¦–å…ˆåœ¨cmake ä¸­å¯ç”¨è¯¥ç¨‹åºï¼Œç»™cmake ä¼ é€’å‚æ•°`-DBUILD_PROGRAMS=TRUE`\n\nè¿è¡Œæ„å»ºåçš„ç¨‹åº \n```\naac-enc [-r bitrate] [-t aot] [-a afterburner] [-s sbr] [-v vbr] in.wav out.aac\n```\nè¯¥ç¨‹åºå¯ä»¥è¯»å–wavéŸ³é¢‘æ–‡ä»¶ï¼Œç¼–ç ä¸ºaacï¼Œå°†ç¼–ç åçš„æ•°æ®å†™å…¥`out.aac` æ–‡ä»¶ä¸­ã€‚\n\n\n## æ³¨æ„äº‹é¡¹\n\nfdk-aac åªæ”¯æŒé‡‡æ ·æ ¼å¼ä¸º`int16`ç±»å‹çš„å®šç‚¹æ ¼å¼ï¼Œä¸æ”¯æŒå¦‚`float32`ç±»å‹çš„æµ®ç‚¹æ ¼å¼ã€‚\n\nfdk-aac é»˜è®¤ä¸€å¸§1024ä¸ªé‡‡æ ·ã€‚\n\n\n\n\n\n\n\n\n\n","slug":"aac/2022-09-23-fdk-aac","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkm000w57wh483n88gm","content":"<p>github åœ°å€ï¼š <a href=\"https://github.com/mstorsjo/fdk-aac\">https://github.com/mstorsjo/fdk-aac</a></p>\n<p>fdk-aac æä¾›äº†è·¨å¹³å°çš„ç¼–è§£ç  aac çš„åŠŸèƒ½ã€‚</p>\n<h2 id=\"ç¼–è¯‘\"><a href=\"#ç¼–è¯‘\" class=\"headerlink\" title=\"ç¼–è¯‘\"></a>ç¼–è¯‘</h2><p>fdk-aacæä¾›äº†CMakeæ„å»ºé™æ€åº“å’ŒåŠ¨æ€åº“ã€‚</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\"><span class=\"hljs-keyword\">cd</span> fdk-aac<br>mkidr build <br><span class=\"hljs-comment\">#BUILD_SHARED_LIBS æ§åˆ¶æ„å»ºé™æ€åº“è¿˜æ˜¯åŠ¨æ€åº“</span><br>cmake <span class=\"hljs-string\">..</span> -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF<br>cmake <span class=\"hljs-params\">--build</span> <span class=\"hljs-params\">--config</span> Release<br><span class=\"hljs-comment\"># install</span><br>cmake <span class=\"hljs-params\">--install</span> &lt;dir&gt; <span class=\"hljs-params\">--prefix</span> &lt;prefix&gt;<br></code></pre></td></tr></table></figure>\n<h2 id=\"æ–‡æ¡£\"><a href=\"#æ–‡æ¡£\" class=\"headerlink\" title=\"æ–‡æ¡£\"></a>æ–‡æ¡£</h2><p>åœ¨documentationç›®å½•ä¸‹ï¼Œæœ‰ä¸¤ä¸ªpdfæ–‡ä»¶ï¼Œåˆ†åˆ«å¯¹åº”ç¼–ç å’Œè§£ç ç›¸å…³çš„æ–‡æ¡£ã€‚</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">aacDecoder<span class=\"hljs-selector-class\">.pdf</span><br>aacEncoder.pdf<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"demo\"><a href=\"#demo\" class=\"headerlink\" title=\"demo\"></a>demo</h2><p>fdk-aac æä¾›ä¸€ä¸ªç¼–ç çš„ç¤ºä¾‹<code>aac-enc.c</code>ï¼Œ ä¸»è¦ä»‹ç»å¦‚ä½•å®ç°aac ç¼–ç åŠŸèƒ½<br>è¯¥demo å¯ä»¥é€šè¿‡cmakeæ¥è°ƒè¯•ã€‚<br>é¦–å…ˆåœ¨cmake ä¸­å¯ç”¨è¯¥ç¨‹åºï¼Œç»™cmake ä¼ é€’å‚æ•°<code>-DBUILD_PROGRAMS=TRUE</code></p>\n<p>è¿è¡Œæ„å»ºåçš„ç¨‹åº </p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">aac-enc <span class=\"hljs-selector-attr\">[-r bitrate]</span> <span class=\"hljs-selector-attr\">[-t aot]</span> <span class=\"hljs-selector-attr\">[-a afterburner]</span> <span class=\"hljs-selector-attr\">[-s sbr]</span> <span class=\"hljs-selector-attr\">[-v vbr]</span> <span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.wav</span> out.aac<br></code></pre></td></tr></table></figure>\n<p>è¯¥ç¨‹åºå¯ä»¥è¯»å–wavéŸ³é¢‘æ–‡ä»¶ï¼Œç¼–ç ä¸ºaacï¼Œå°†ç¼–ç åçš„æ•°æ®å†™å…¥<code>out.aac</code> æ–‡ä»¶ä¸­ã€‚</p>\n<h2 id=\"æ³¨æ„äº‹é¡¹\"><a href=\"#æ³¨æ„äº‹é¡¹\" class=\"headerlink\" title=\"æ³¨æ„äº‹é¡¹\"></a>æ³¨æ„äº‹é¡¹</h2><p>fdk-aac åªæ”¯æŒé‡‡æ ·æ ¼å¼ä¸º<code>int16</code>ç±»å‹çš„å®šç‚¹æ ¼å¼ï¼Œä¸æ”¯æŒå¦‚<code>float32</code>ç±»å‹çš„æµ®ç‚¹æ ¼å¼ã€‚</p>\n<p>fdk-aac é»˜è®¤ä¸€å¸§1024ä¸ªé‡‡æ ·ã€‚</p>\n","excerpt":"","more":"<p>github åœ°å€ï¼š <a href=\"https://github.com/mstorsjo/fdk-aac\">https://github.com/mstorsjo/fdk-aac</a></p>\n<p>fdk-aac æä¾›äº†è·¨å¹³å°çš„ç¼–è§£ç  aac çš„åŠŸèƒ½ã€‚</p>\n<h2 id=\"ç¼–è¯‘\"><a href=\"#ç¼–è¯‘\" class=\"headerlink\" title=\"ç¼–è¯‘\"></a>ç¼–è¯‘</h2><p>fdk-aacæä¾›äº†CMakeæ„å»ºé™æ€åº“å’ŒåŠ¨æ€åº“ã€‚</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\"><span class=\"hljs-keyword\">cd</span> fdk-aac<br>mkidr build <br><span class=\"hljs-comment\">#BUILD_SHARED_LIBS æ§åˆ¶æ„å»ºé™æ€åº“è¿˜æ˜¯åŠ¨æ€åº“</span><br>cmake <span class=\"hljs-string\">..</span> -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF<br>cmake <span class=\"hljs-params\">--build</span> <span class=\"hljs-params\">--config</span> Release<br><span class=\"hljs-comment\"># install</span><br>cmake <span class=\"hljs-params\">--install</span> &lt;dir&gt; <span class=\"hljs-params\">--prefix</span> &lt;prefix&gt;<br></code></pre></td></tr></table></figure>\n<h2 id=\"æ–‡æ¡£\"><a href=\"#æ–‡æ¡£\" class=\"headerlink\" title=\"æ–‡æ¡£\"></a>æ–‡æ¡£</h2><p>åœ¨documentationç›®å½•ä¸‹ï¼Œæœ‰ä¸¤ä¸ªpdfæ–‡ä»¶ï¼Œåˆ†åˆ«å¯¹åº”ç¼–ç å’Œè§£ç ç›¸å…³çš„æ–‡æ¡£ã€‚</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">aacDecoder<span class=\"hljs-selector-class\">.pdf</span><br>aacEncoder.pdf<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"demo\"><a href=\"#demo\" class=\"headerlink\" title=\"demo\"></a>demo</h2><p>fdk-aac æä¾›ä¸€ä¸ªç¼–ç çš„ç¤ºä¾‹<code>aac-enc.c</code>ï¼Œ ä¸»è¦ä»‹ç»å¦‚ä½•å®ç°aac ç¼–ç åŠŸèƒ½<br>è¯¥demo å¯ä»¥é€šè¿‡cmakeæ¥è°ƒè¯•ã€‚<br>é¦–å…ˆåœ¨cmake ä¸­å¯ç”¨è¯¥ç¨‹åºï¼Œç»™cmake ä¼ é€’å‚æ•°<code>-DBUILD_PROGRAMS=TRUE</code></p>\n<p>è¿è¡Œæ„å»ºåçš„ç¨‹åº </p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">aac-enc <span class=\"hljs-selector-attr\">[-r bitrate]</span> <span class=\"hljs-selector-attr\">[-t aot]</span> <span class=\"hljs-selector-attr\">[-a afterburner]</span> <span class=\"hljs-selector-attr\">[-s sbr]</span> <span class=\"hljs-selector-attr\">[-v vbr]</span> <span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.wav</span> out.aac<br></code></pre></td></tr></table></figure>\n<p>è¯¥ç¨‹åºå¯ä»¥è¯»å–wavéŸ³é¢‘æ–‡ä»¶ï¼Œç¼–ç ä¸ºaacï¼Œå°†ç¼–ç åçš„æ•°æ®å†™å…¥<code>out.aac</code> æ–‡ä»¶ä¸­ã€‚</p>\n<h2 id=\"æ³¨æ„äº‹é¡¹\"><a href=\"#æ³¨æ„äº‹é¡¹\" class=\"headerlink\" title=\"æ³¨æ„äº‹é¡¹\"></a>æ³¨æ„äº‹é¡¹</h2><p>fdk-aac åªæ”¯æŒé‡‡æ ·æ ¼å¼ä¸º<code>int16</code>ç±»å‹çš„å®šç‚¹æ ¼å¼ï¼Œä¸æ”¯æŒå¦‚<code>float32</code>ç±»å‹çš„æµ®ç‚¹æ ¼å¼ã€‚</p>\n<p>fdk-aac é»˜è®¤ä¸€å¸§1024ä¸ªé‡‡æ ·ã€‚</p>\n"},{"layout":"post","title":"#pragma once ç”¨æ³•æ€»ç»“","date":"2022-03-18T16:00:00.000Z","_content":"\n# pragma once ç”¨æ³•æ€»ç»“\n\n## pragma once è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\n\nä¸ºäº†é¿å…åŒä¸€ä¸ªå¤´æ–‡ä»¶è¢«åŒ…å«ï¼ˆincludeï¼‰å¤šæ¬¡ï¼ŒC/C++ä¸­æœ‰ä¸¤ç§å®å®ç°æ–¹å¼ï¼šä¸€ç§æ˜¯#ifndefæ–¹å¼ï¼›å¦ä¸€ç§æ˜¯#pragma onceæ–¹å¼ã€‚\n\nåœ¨èƒ½å¤Ÿæ”¯æŒè¿™ä¸¤ç§æ–¹å¼çš„ç¼–è¯‘å™¨ä¸Šï¼ŒäºŒè€…å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚ä½†ä¸¤è€…ä»ç„¶æœ‰ä¸€äº›ç»†å¾®çš„åŒºåˆ«ã€‚\n\n## ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ\n\næ–¹å¼1ï¼š\n\n```\n#ifndef  __SOMEFILE_H__\n#define   __SOMEFILE_H__\n ... ... // å£°æ˜ã€å®šä¹‰è¯­å¥\n#endif\n```\n\næ–¹å¼2ï¼š\n\n```\n#pragma once\n ... ... // å£°æ˜ã€å®šä¹‰è¯­å¥\n```\n\n## ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ\n\n### #ifndef\n\n1. #ifndefçš„æ–¹å¼å—C/C++è¯­è¨€æ ‡å‡†æ”¯æŒ\n\n2. é€šè¿‡å®æ¥æ£€æµ‹ï¼Œå®çš„èŒƒå›´å¯ä»¥æ˜¯å•ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»£ç ç‰‡æ®µã€‚ä¿è¯æ–‡ä»¶æˆ–è€…ä»£ç ç‰‡æ®µä¸è¢«é‡å¤åŒ…å«ï¼Œé’ˆå¯¹æ–‡ä»¶çš„å†…å®¹ã€‚\n\n3. å¯èƒ½ä¼šå‘ç”Ÿå®å†²çªï¼Œå¯¼è‡´ä½ çœ‹åˆ°å¤´æ–‡ä»¶æ˜æ˜å­˜åœ¨ï¼Œä½†ç¼–è¯‘å™¨å´ç¡¬è¯´æ‰¾ä¸åˆ°å£°æ˜çš„çŠ¶å†µï¼ˆé‡åˆ°è¿‡ä¸€æ¬¡ï¼ŒæŸ¥äº†ä¸€æ™šä¸Šï¼‰\n\n### #pragma once\n\n1. pragma onceç”±ç¼–è¯‘å™¨æä¾›ä¿è¯ï¼šåŒä¸€ä¸ªæ–‡ä»¶ä¸ä¼šè¢«åŒ…å«å¤šæ¬¡ã€‚æ³¨æ„è¿™é‡Œæ‰€è¯´çš„â€œåŒä¸€ä¸ªæ–‡ä»¶â€æ˜¯æŒ‡ç‰©ç†ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯æŒ‡å†…å®¹ç›¸åŒçš„ä¸¤ä¸ªæ–‡ä»¶\n\n2. #pragma once`ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„æŒ‡ä»¤ï¼Œä½†æ˜¯å¤§å¤šçš„çš„ç¼–è¯‘å™¨å·²ç»æ”¯æŒ\n\n3. `#pragma once`ä»£æ›¿includeé˜²èŒƒå°†åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œifndefæ–¹å¼éœ€è¦å…ˆæ‰“å¼€æ–‡ä»¶\n\n4. ä½ æ— æ³•å¯¹ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­çš„ä¸€æ®µä»£ç ä½œpragma onceå£°æ˜ï¼Œè€Œåªèƒ½é’ˆå¯¹æ–‡ä»¶\n\n5. å¥½å¤„æ˜¯ï¼Œä½ ä¸å¿…å†æ‹…å¿ƒå®åå†²çªäº†ï¼Œå½“ç„¶ä¹Ÿå°±ä¸ä¼šå‡ºç°å®åå†²çªå¼•å‘çš„å¥‡æ€ªé—®é¢˜\n\nå‚è€ƒï¼š [#pragma onceç”¨æ³•æ€»ç»“_è¥¿åŒ—è€ç å†œçš„åšå®¢-CSDNåšå®¢_#pragma once](https://blog.csdn.net/fanyun_01/article/details/77413992)\n","source":"_posts/c++/2022-03-19-pragma once ç”¨æ³•æ€»ç»“.md","raw":"---\n\nlayout: post\ntitle: \"#pragma once ç”¨æ³•æ€»ç»“\"\ndate: 2022-03-19 \ntag: c++\n\n---\n\n# pragma once ç”¨æ³•æ€»ç»“\n\n## pragma once è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\n\nä¸ºäº†é¿å…åŒä¸€ä¸ªå¤´æ–‡ä»¶è¢«åŒ…å«ï¼ˆincludeï¼‰å¤šæ¬¡ï¼ŒC/C++ä¸­æœ‰ä¸¤ç§å®å®ç°æ–¹å¼ï¼šä¸€ç§æ˜¯#ifndefæ–¹å¼ï¼›å¦ä¸€ç§æ˜¯#pragma onceæ–¹å¼ã€‚\n\nåœ¨èƒ½å¤Ÿæ”¯æŒè¿™ä¸¤ç§æ–¹å¼çš„ç¼–è¯‘å™¨ä¸Šï¼ŒäºŒè€…å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚ä½†ä¸¤è€…ä»ç„¶æœ‰ä¸€äº›ç»†å¾®çš„åŒºåˆ«ã€‚\n\n## ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ\n\næ–¹å¼1ï¼š\n\n```\n#ifndef  __SOMEFILE_H__\n#define   __SOMEFILE_H__\n ... ... // å£°æ˜ã€å®šä¹‰è¯­å¥\n#endif\n```\n\næ–¹å¼2ï¼š\n\n```\n#pragma once\n ... ... // å£°æ˜ã€å®šä¹‰è¯­å¥\n```\n\n## ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ\n\n### #ifndef\n\n1. #ifndefçš„æ–¹å¼å—C/C++è¯­è¨€æ ‡å‡†æ”¯æŒ\n\n2. é€šè¿‡å®æ¥æ£€æµ‹ï¼Œå®çš„èŒƒå›´å¯ä»¥æ˜¯å•ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»£ç ç‰‡æ®µã€‚ä¿è¯æ–‡ä»¶æˆ–è€…ä»£ç ç‰‡æ®µä¸è¢«é‡å¤åŒ…å«ï¼Œé’ˆå¯¹æ–‡ä»¶çš„å†…å®¹ã€‚\n\n3. å¯èƒ½ä¼šå‘ç”Ÿå®å†²çªï¼Œå¯¼è‡´ä½ çœ‹åˆ°å¤´æ–‡ä»¶æ˜æ˜å­˜åœ¨ï¼Œä½†ç¼–è¯‘å™¨å´ç¡¬è¯´æ‰¾ä¸åˆ°å£°æ˜çš„çŠ¶å†µï¼ˆé‡åˆ°è¿‡ä¸€æ¬¡ï¼ŒæŸ¥äº†ä¸€æ™šä¸Šï¼‰\n\n### #pragma once\n\n1. pragma onceç”±ç¼–è¯‘å™¨æä¾›ä¿è¯ï¼šåŒä¸€ä¸ªæ–‡ä»¶ä¸ä¼šè¢«åŒ…å«å¤šæ¬¡ã€‚æ³¨æ„è¿™é‡Œæ‰€è¯´çš„â€œåŒä¸€ä¸ªæ–‡ä»¶â€æ˜¯æŒ‡ç‰©ç†ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯æŒ‡å†…å®¹ç›¸åŒçš„ä¸¤ä¸ªæ–‡ä»¶\n\n2. #pragma once`ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„æŒ‡ä»¤ï¼Œä½†æ˜¯å¤§å¤šçš„çš„ç¼–è¯‘å™¨å·²ç»æ”¯æŒ\n\n3. `#pragma once`ä»£æ›¿includeé˜²èŒƒå°†åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œifndefæ–¹å¼éœ€è¦å…ˆæ‰“å¼€æ–‡ä»¶\n\n4. ä½ æ— æ³•å¯¹ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­çš„ä¸€æ®µä»£ç ä½œpragma onceå£°æ˜ï¼Œè€Œåªèƒ½é’ˆå¯¹æ–‡ä»¶\n\n5. å¥½å¤„æ˜¯ï¼Œä½ ä¸å¿…å†æ‹…å¿ƒå®åå†²çªäº†ï¼Œå½“ç„¶ä¹Ÿå°±ä¸ä¼šå‡ºç°å®åå†²çªå¼•å‘çš„å¥‡æ€ªé—®é¢˜\n\nå‚è€ƒï¼š [#pragma onceç”¨æ³•æ€»ç»“_è¥¿åŒ—è€ç å†œçš„åšå®¢-CSDNåšå®¢_#pragma once](https://blog.csdn.net/fanyun_01/article/details/77413992)\n","slug":"c++/2022-03-19-pragma once ç”¨æ³•æ€»ç»“","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkm000z57whgjsucwbd","content":"<h1 id=\"pragma-once-ç”¨æ³•æ€»ç»“\"><a href=\"#pragma-once-ç”¨æ³•æ€»ç»“\" class=\"headerlink\" title=\"pragma once ç”¨æ³•æ€»ç»“\"></a>pragma once ç”¨æ³•æ€»ç»“</h1><h2 id=\"pragma-once-è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\"><a href=\"#pragma-once-è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\" class=\"headerlink\" title=\"pragma once è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\"></a>pragma once è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h2><p>ä¸ºäº†é¿å…åŒä¸€ä¸ªå¤´æ–‡ä»¶è¢«åŒ…å«ï¼ˆincludeï¼‰å¤šæ¬¡ï¼ŒC&#x2F;C++ä¸­æœ‰ä¸¤ç§å®å®ç°æ–¹å¼ï¼šä¸€ç§æ˜¯#ifndefæ–¹å¼ï¼›å¦ä¸€ç§æ˜¯#pragma onceæ–¹å¼ã€‚</p>\n<p>åœ¨èƒ½å¤Ÿæ”¯æŒè¿™ä¸¤ç§æ–¹å¼çš„ç¼–è¯‘å™¨ä¸Šï¼ŒäºŒè€…å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚ä½†ä¸¤è€…ä»ç„¶æœ‰ä¸€äº›ç»†å¾®çš„åŒºåˆ«ã€‚</p>\n<h2 id=\"ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ\"><a href=\"#ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ\" class=\"headerlink\" title=\"ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ\"></a>ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ</h2><p>æ–¹å¼1ï¼š</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">ifndef</span>  __SOMEFILE_H__</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span>   __SOMEFILE_H__</span><br> ... ... <span class=\"hljs-comment\">// å£°æ˜ã€å®šä¹‰è¯­å¥</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">endif</span></span><br></code></pre></td></tr></table></figure>\n\n<p>æ–¹å¼2ï¼š</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\"><span class=\"hljs-comment\">#pragma once</span><br> <span class=\"hljs-string\">...</span> <span class=\"hljs-string\">...</span> <span class=\"hljs-string\">//</span> å£°æ˜ã€å®šä¹‰è¯­å¥<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ\"><a href=\"#ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ\" class=\"headerlink\" title=\"ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ\"></a>ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ</h2><h3 id=\"ifndef\"><a href=\"#ifndef\" class=\"headerlink\" title=\"#ifndef\"></a>#ifndef</h3><ol>\n<li><p>#ifndefçš„æ–¹å¼å—C&#x2F;C++è¯­è¨€æ ‡å‡†æ”¯æŒ</p>\n</li>\n<li><p>é€šè¿‡å®æ¥æ£€æµ‹ï¼Œå®çš„èŒƒå›´å¯ä»¥æ˜¯å•ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»£ç ç‰‡æ®µã€‚ä¿è¯æ–‡ä»¶æˆ–è€…ä»£ç ç‰‡æ®µä¸è¢«é‡å¤åŒ…å«ï¼Œé’ˆå¯¹æ–‡ä»¶çš„å†…å®¹ã€‚</p>\n</li>\n<li><p>å¯èƒ½ä¼šå‘ç”Ÿå®å†²çªï¼Œå¯¼è‡´ä½ çœ‹åˆ°å¤´æ–‡ä»¶æ˜æ˜å­˜åœ¨ï¼Œä½†ç¼–è¯‘å™¨å´ç¡¬è¯´æ‰¾ä¸åˆ°å£°æ˜çš„çŠ¶å†µï¼ˆé‡åˆ°è¿‡ä¸€æ¬¡ï¼ŒæŸ¥äº†ä¸€æ™šä¸Šï¼‰</p>\n</li>\n</ol>\n<h3 id=\"pragma-once\"><a href=\"#pragma-once\" class=\"headerlink\" title=\"#pragma once\"></a>#pragma once</h3><ol>\n<li><p>pragma onceç”±ç¼–è¯‘å™¨æä¾›ä¿è¯ï¼šåŒä¸€ä¸ªæ–‡ä»¶ä¸ä¼šè¢«åŒ…å«å¤šæ¬¡ã€‚æ³¨æ„è¿™é‡Œæ‰€è¯´çš„â€œåŒä¸€ä¸ªæ–‡ä»¶â€æ˜¯æŒ‡ç‰©ç†ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯æŒ‡å†…å®¹ç›¸åŒçš„ä¸¤ä¸ªæ–‡ä»¶</p>\n</li>\n<li><p>#pragma once&#96;ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„æŒ‡ä»¤ï¼Œä½†æ˜¯å¤§å¤šçš„çš„ç¼–è¯‘å™¨å·²ç»æ”¯æŒ</p>\n</li>\n<li><p><code>#pragma once</code>ä»£æ›¿includeé˜²èŒƒå°†åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œifndefæ–¹å¼éœ€è¦å…ˆæ‰“å¼€æ–‡ä»¶</p>\n</li>\n<li><p>ä½ æ— æ³•å¯¹ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­çš„ä¸€æ®µä»£ç ä½œpragma onceå£°æ˜ï¼Œè€Œåªèƒ½é’ˆå¯¹æ–‡ä»¶</p>\n</li>\n<li><p>å¥½å¤„æ˜¯ï¼Œä½ ä¸å¿…å†æ‹…å¿ƒå®åå†²çªäº†ï¼Œå½“ç„¶ä¹Ÿå°±ä¸ä¼šå‡ºç°å®åå†²çªå¼•å‘çš„å¥‡æ€ªé—®é¢˜</p>\n</li>\n</ol>\n<p>å‚è€ƒï¼š <a href=\"https://blog.csdn.net/fanyun_01/article/details/77413992\">#pragma onceç”¨æ³•æ€»ç»“_è¥¿åŒ—è€ç å†œçš„åšå®¢-CSDNåšå®¢_#pragma once</a></p>\n","excerpt":"","more":"<h1 id=\"pragma-once-ç”¨æ³•æ€»ç»“\"><a href=\"#pragma-once-ç”¨æ³•æ€»ç»“\" class=\"headerlink\" title=\"pragma once ç”¨æ³•æ€»ç»“\"></a>pragma once ç”¨æ³•æ€»ç»“</h1><h2 id=\"pragma-once-è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\"><a href=\"#pragma-once-è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\" class=\"headerlink\" title=\"pragma once è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\"></a>pragma once è¿™ä¸ªå®æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h2><p>ä¸ºäº†é¿å…åŒä¸€ä¸ªå¤´æ–‡ä»¶è¢«åŒ…å«ï¼ˆincludeï¼‰å¤šæ¬¡ï¼ŒC&#x2F;C++ä¸­æœ‰ä¸¤ç§å®å®ç°æ–¹å¼ï¼šä¸€ç§æ˜¯#ifndefæ–¹å¼ï¼›å¦ä¸€ç§æ˜¯#pragma onceæ–¹å¼ã€‚</p>\n<p>åœ¨èƒ½å¤Ÿæ”¯æŒè¿™ä¸¤ç§æ–¹å¼çš„ç¼–è¯‘å™¨ä¸Šï¼ŒäºŒè€…å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚ä½†ä¸¤è€…ä»ç„¶æœ‰ä¸€äº›ç»†å¾®çš„åŒºåˆ«ã€‚</p>\n<h2 id=\"ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ\"><a href=\"#ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ\" class=\"headerlink\" title=\"ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ\"></a>ä¸¤è€…çš„ä½¿ç”¨æ–¹å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ</h2><p>æ–¹å¼1ï¼š</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">ifndef</span>  __SOMEFILE_H__</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span>   __SOMEFILE_H__</span><br> ... ... <span class=\"hljs-comment\">// å£°æ˜ã€å®šä¹‰è¯­å¥</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">endif</span></span><br></code></pre></td></tr></table></figure>\n\n<p>æ–¹å¼2ï¼š</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\"><span class=\"hljs-comment\">#pragma once</span><br> <span class=\"hljs-string\">...</span> <span class=\"hljs-string\">...</span> <span class=\"hljs-string\">//</span> å£°æ˜ã€å®šä¹‰è¯­å¥<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ\"><a href=\"#ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ\" class=\"headerlink\" title=\"ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ\"></a>ä¸¤è€…å„æœ‰å’Œç‰¹ç‚¹ï¼Ÿ</h2><h3 id=\"ifndef\"><a href=\"#ifndef\" class=\"headerlink\" title=\"#ifndef\"></a>#ifndef</h3><ol>\n<li><p>#ifndefçš„æ–¹å¼å—C&#x2F;C++è¯­è¨€æ ‡å‡†æ”¯æŒ</p>\n</li>\n<li><p>é€šè¿‡å®æ¥æ£€æµ‹ï¼Œå®çš„èŒƒå›´å¯ä»¥æ˜¯å•ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»£ç ç‰‡æ®µã€‚ä¿è¯æ–‡ä»¶æˆ–è€…ä»£ç ç‰‡æ®µä¸è¢«é‡å¤åŒ…å«ï¼Œé’ˆå¯¹æ–‡ä»¶çš„å†…å®¹ã€‚</p>\n</li>\n<li><p>å¯èƒ½ä¼šå‘ç”Ÿå®å†²çªï¼Œå¯¼è‡´ä½ çœ‹åˆ°å¤´æ–‡ä»¶æ˜æ˜å­˜åœ¨ï¼Œä½†ç¼–è¯‘å™¨å´ç¡¬è¯´æ‰¾ä¸åˆ°å£°æ˜çš„çŠ¶å†µï¼ˆé‡åˆ°è¿‡ä¸€æ¬¡ï¼ŒæŸ¥äº†ä¸€æ™šä¸Šï¼‰</p>\n</li>\n</ol>\n<h3 id=\"pragma-once\"><a href=\"#pragma-once\" class=\"headerlink\" title=\"#pragma once\"></a>#pragma once</h3><ol>\n<li><p>pragma onceç”±ç¼–è¯‘å™¨æä¾›ä¿è¯ï¼šåŒä¸€ä¸ªæ–‡ä»¶ä¸ä¼šè¢«åŒ…å«å¤šæ¬¡ã€‚æ³¨æ„è¿™é‡Œæ‰€è¯´çš„â€œåŒä¸€ä¸ªæ–‡ä»¶â€æ˜¯æŒ‡ç‰©ç†ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯æŒ‡å†…å®¹ç›¸åŒçš„ä¸¤ä¸ªæ–‡ä»¶</p>\n</li>\n<li><p>#pragma once&#96;ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„æŒ‡ä»¤ï¼Œä½†æ˜¯å¤§å¤šçš„çš„ç¼–è¯‘å™¨å·²ç»æ”¯æŒ</p>\n</li>\n<li><p><code>#pragma once</code>ä»£æ›¿includeé˜²èŒƒå°†åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œifndefæ–¹å¼éœ€è¦å…ˆæ‰“å¼€æ–‡ä»¶</p>\n</li>\n<li><p>ä½ æ— æ³•å¯¹ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­çš„ä¸€æ®µä»£ç ä½œpragma onceå£°æ˜ï¼Œè€Œåªèƒ½é’ˆå¯¹æ–‡ä»¶</p>\n</li>\n<li><p>å¥½å¤„æ˜¯ï¼Œä½ ä¸å¿…å†æ‹…å¿ƒå®åå†²çªäº†ï¼Œå½“ç„¶ä¹Ÿå°±ä¸ä¼šå‡ºç°å®åå†²çªå¼•å‘çš„å¥‡æ€ªé—®é¢˜</p>\n</li>\n</ol>\n<p>å‚è€ƒï¼š <a href=\"https://blog.csdn.net/fanyun_01/article/details/77413992\">#pragma onceç”¨æ³•æ€»ç»“_è¥¿åŒ—è€ç å†œçš„åšå®¢-CSDNåšå®¢_#pragma once</a></p>\n"},{"layout":"post","title":"git hooks  ç»“åˆ clang-format æäº¤å‰è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ","date":"2022-03-20T16:00:00.000Z","_content":"\n## [ClangFormat ](https://clang.llvm.org/docs/ClangFormat.html)\n\nClangFormat æè¿°äº†ä¸€ç»„æ„å»ºåœ¨ [LibFormat]((https://clang.llvm.org/docs/LibFormat.html)) ä¹‹ä¸Šçš„å·¥å…·ã€‚å®ƒå¯ä»¥ä»¥å¤šç§æ–¹å¼æ”¯æŒæ‚¨çš„å·¥ä½œæµï¼ŒåŒ…æ‹¬ç‹¬ç«‹å·¥å…·å’Œç¼–è¾‘å™¨é›†æˆã€‚\n\nå…¶ä¸­ç‹¬ç«‹çš„å·¥å…·å°±æ˜¯clang-format, å¯ç”¨äºæ ¼å¼åŒ– c/c + +/Java/JavaScript/JSON/Objective-C/Protobuf/c # ä»£ç ã€‚\n\nclang-formatçš„é»˜è®¤é…ç½®æ–‡ä»¶æ˜¯`.clang-format`æˆ–`_clang-format`, ä¹Ÿå¯ä»¥é€šè¿‡`clang-formatÂ -style=file`æŒ‡å®šé…ç½®æ–‡ä»¶ã€‚\n\n\n\n`.clang-format` ä½¿ç”¨yamlæ ¼å¼ï¼ŒæŒ‡å®šäº†å¦‚ä½•å¯¹æ–‡ä»¶æ ¼å¼åŒ–çš„è§„åˆ™ã€‚\n\nå¯ä»¥åŸºäºé¢„å®šä¹‰çš„æ ·å¼ï¼Œå¿«é€Ÿåˆ›å»º`.clang-format`æ–‡ä»¶ã€‚\n\n- `LLVM`Â A style complying with theÂ [LLVM coding standards](https://llvm.org/docs/CodingStandards.html)\n\n- `Google`Â A style complying withÂ [Googleâ€™s C++ style guide](https://google.github.io/styleguide/cppguide.html)\n\n- `Chromium`Â A style complying withÂ [Chromiumâ€™s style guide](https://chromium.googlesource.com/chromium/src/+/refs/heads/main/styleguide/styleguide.md)\n\n- `Mozilla`Â A style complying withÂ [Mozillaâ€™s style guide](https://firefox-source-docs.mozilla.org/code-quality/coding-style/index.html)\n\n- `WebKit`Â A style complying withÂ [WebKitâ€™s style guide](https://www.webkit.org/coding/coding-style.html)\n\n- `Microsoft`Â A style complying withÂ [Microsoftâ€™s style guide](https://docs.microsoft.com/en-us/visualstudio/ide/editorconfig-code-style-settings-reference)\n\n- `GNU`Â A style complying with theÂ [GNU coding standards](https://www.gnu.org/prep/standards/standards.html)\n\nä¾‹å¦‚ç”Ÿæˆllvmé£æ ¼çš„ï¼š\n\n```\nclang-format -style=llvm -dump-config > .clang-format\n```\n\n ç„¶åå¯ä»¥åŸºäºç”Ÿæˆçš„`.clang-format`æ–‡ä»¶ä¿®æ”¹å‚æ•°ï¼Œå®šåˆ¶è‡ªå·±çš„æ ·å¼ã€‚\n\næ›´å¤šå‚è€ƒï¼š [Clang-Format Style Options ](https://clang.llvm.org/docs/ClangFormatStyleOptions.html)\n\n\n\n\n\nmac ä¸‹å®‰è£… clang-format\n\n```\nbrew install clang-format\n```\n\nå°†ç”Ÿæˆçš„`.clang-format`æ”¾å…¥å·¥ç¨‹ç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤æ ¼å¼åŒ–æ–‡ä»¶\n\n```\nclang-format -i xx.cpp\n```\n\n`-i`æ ¼å¼åŒ–å½“å‰æ–‡ä»¶ï¼Œå¹¶å°†æ ¼å¼åŒ–åçš„å†…å®¹è¾“å‡ºåˆ°å½“å‰æ–‡ä»¶ã€‚ä¸åŠ `-i`ä¼šå°†æ ¼å¼åŒ–çš„å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚\n\n\n\nç„¶åæˆ‘ä»¬å¸Œæœ›åœ¨æäº¤çš„æ—¶å€™æ ¹æ®æˆ‘ä»¬çš„é…ç½®ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ï¼Œå¦‚ä½•åšå‘¢ï¼Ÿ\n\nå¯ä»¥é€šè¿‡git hooks ç»“åˆclang-format åœ¨æäº¤çš„æ—¶å€™è‡ªåŠ¨æ ¼å¼åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚\n\n## [pre-commit](https://pre-commit.com/)\n\n> A framework for managing and maintaining multi-languageÂ pre-commitÂ hooks.\n\n\n\n å®‰è£…ï¼š\n\n```\n$ brew install pre-commit\n# æŸ¥çœ‹ç‰ˆæœ¬\n$ pre-commit --version\npre-commit 2.17.0\n```\n\n\n\næ·»åŠ é…ç½®æ–‡ä»¶`.pre-commit-config.yaml`ï¼Œé€šè¿‡[`pre-commit sample-config`](https://pre-commit.com/#pre-commit-sample-config)\n\nå‘½ä»¤å¿«é€Ÿç”Ÿæˆä¸€ä¸ªåŸºæœ¬çš„é…ç½®æ–‡ä»¶ã€‚ æ›´å¤šå…³äºæ–‡ä»¶ä¸­é€‰é¡¹çš„é…ç½®ï¼Œå‚è€ƒ[pre-commit](https://pre-commit.com/#plugins)\n\n```\nâœ  ~ pre-commit sample-config\n# See https://pre-commit.com for more information\n# See https://pre-commit.com/hooks.html for more hooks\nrepos:\n-   repo: https://github.com/pre-commit/pre-commit-hooks\n    rev: v3.2.0\n    hooks:\n    -   id: trailing-whitespace\n    -   id: end-of-file-fixer\n    -   id: check-yaml\n    -   id: check-added-large-files\n```\n\nä¸Šé¢é…ç½®æŒ‡å®šäº†å¦‚ä½•å»æ ¼å¼åŒ–pythonä»£ç ï¼Œpre commit æ”¯æŒæ ¼å¼åŒ–å…¶ä»–çš„ç¼–ç¨‹è¯­è¨€ï¼Œå‚è€ƒ\n\n[supported hooks](https://pre-commit.com/hooks.html)æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„è¯­è¨€ã€‚\n\n\n\næƒ³ç»“åˆclang-formatå¯¹å·¥ç¨‹ä¸­çš„c++ä»£ç è‡ªåŠ¨æ ¼å¼åŒ–ã€‚åœ¨[supported hooks](https://pre-commit.com/hooks.html)æ‰¾åˆ°äº†[GitHub - doublify/pre-commit-clang-format: ClangFormat hook for pre-commit](https://github.com/doublify/pre-commit-clang-format)\n\n\n\nå¦‚ä½•ä½¿ç”¨å‘¢?\n\n1. åœ¨å·¥ç¨‹ä¸­åˆ›å»º`.pre-commit-config.yaml`æ–‡ä»¶\n\n2. é…ç½®`.pre-commit-config.yaml`æ–‡ä»¶\n   \n   ```\n   repos:\n   -   repo: https://github.com/doublify/pre-commit-clang-format.git\n       rev: 62302476d0da01515660132d76902359bed0f782\n       hooks:\n       -   id: clang-format\n   ```\n\n3. å®‰è£…git hooks è„šæœ¬\n   \n   ```\n   $ pre-commit install\n   pre-commit installed at .git/hooks/pre-commit\n   ```\n\n4.  (å¯é€‰)æ‰‹åŠ¨è°ƒç”¨pre commitï¼Œçœ‹çœ‹æ ¼å¼åŒ–åçš„æ•ˆæœ\n   \n   ```\n   $ pre-commit run --all-files\n   ```\n\n5.  è°ƒç”¨`git commit`, ä¼šè§¦å‘git hookï¼Œè°ƒç”¨`clang-format`è‡ªåŠ¨åŒ–æ ¼å¼ä»£ç ã€‚\n\n\n","source":"_posts/c++/2022-03-21-git hook clang-format.md","raw":"---\n\nlayout: post\ntitle: \"git hooks  ç»“åˆ clang-format æäº¤å‰è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç \"\ndate: 2022-03-21 \ntag: c++\n\n---\n\n## [ClangFormat ](https://clang.llvm.org/docs/ClangFormat.html)\n\nClangFormat æè¿°äº†ä¸€ç»„æ„å»ºåœ¨ [LibFormat]((https://clang.llvm.org/docs/LibFormat.html)) ä¹‹ä¸Šçš„å·¥å…·ã€‚å®ƒå¯ä»¥ä»¥å¤šç§æ–¹å¼æ”¯æŒæ‚¨çš„å·¥ä½œæµï¼ŒåŒ…æ‹¬ç‹¬ç«‹å·¥å…·å’Œç¼–è¾‘å™¨é›†æˆã€‚\n\nå…¶ä¸­ç‹¬ç«‹çš„å·¥å…·å°±æ˜¯clang-format, å¯ç”¨äºæ ¼å¼åŒ– c/c + +/Java/JavaScript/JSON/Objective-C/Protobuf/c # ä»£ç ã€‚\n\nclang-formatçš„é»˜è®¤é…ç½®æ–‡ä»¶æ˜¯`.clang-format`æˆ–`_clang-format`, ä¹Ÿå¯ä»¥é€šè¿‡`clang-formatÂ -style=file`æŒ‡å®šé…ç½®æ–‡ä»¶ã€‚\n\n\n\n`.clang-format` ä½¿ç”¨yamlæ ¼å¼ï¼ŒæŒ‡å®šäº†å¦‚ä½•å¯¹æ–‡ä»¶æ ¼å¼åŒ–çš„è§„åˆ™ã€‚\n\nå¯ä»¥åŸºäºé¢„å®šä¹‰çš„æ ·å¼ï¼Œå¿«é€Ÿåˆ›å»º`.clang-format`æ–‡ä»¶ã€‚\n\n- `LLVM`Â A style complying with theÂ [LLVM coding standards](https://llvm.org/docs/CodingStandards.html)\n\n- `Google`Â A style complying withÂ [Googleâ€™s C++ style guide](https://google.github.io/styleguide/cppguide.html)\n\n- `Chromium`Â A style complying withÂ [Chromiumâ€™s style guide](https://chromium.googlesource.com/chromium/src/+/refs/heads/main/styleguide/styleguide.md)\n\n- `Mozilla`Â A style complying withÂ [Mozillaâ€™s style guide](https://firefox-source-docs.mozilla.org/code-quality/coding-style/index.html)\n\n- `WebKit`Â A style complying withÂ [WebKitâ€™s style guide](https://www.webkit.org/coding/coding-style.html)\n\n- `Microsoft`Â A style complying withÂ [Microsoftâ€™s style guide](https://docs.microsoft.com/en-us/visualstudio/ide/editorconfig-code-style-settings-reference)\n\n- `GNU`Â A style complying with theÂ [GNU coding standards](https://www.gnu.org/prep/standards/standards.html)\n\nä¾‹å¦‚ç”Ÿæˆllvmé£æ ¼çš„ï¼š\n\n```\nclang-format -style=llvm -dump-config > .clang-format\n```\n\n ç„¶åå¯ä»¥åŸºäºç”Ÿæˆçš„`.clang-format`æ–‡ä»¶ä¿®æ”¹å‚æ•°ï¼Œå®šåˆ¶è‡ªå·±çš„æ ·å¼ã€‚\n\næ›´å¤šå‚è€ƒï¼š [Clang-Format Style Options ](https://clang.llvm.org/docs/ClangFormatStyleOptions.html)\n\n\n\n\n\nmac ä¸‹å®‰è£… clang-format\n\n```\nbrew install clang-format\n```\n\nå°†ç”Ÿæˆçš„`.clang-format`æ”¾å…¥å·¥ç¨‹ç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤æ ¼å¼åŒ–æ–‡ä»¶\n\n```\nclang-format -i xx.cpp\n```\n\n`-i`æ ¼å¼åŒ–å½“å‰æ–‡ä»¶ï¼Œå¹¶å°†æ ¼å¼åŒ–åçš„å†…å®¹è¾“å‡ºåˆ°å½“å‰æ–‡ä»¶ã€‚ä¸åŠ `-i`ä¼šå°†æ ¼å¼åŒ–çš„å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚\n\n\n\nç„¶åæˆ‘ä»¬å¸Œæœ›åœ¨æäº¤çš„æ—¶å€™æ ¹æ®æˆ‘ä»¬çš„é…ç½®ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ï¼Œå¦‚ä½•åšå‘¢ï¼Ÿ\n\nå¯ä»¥é€šè¿‡git hooks ç»“åˆclang-format åœ¨æäº¤çš„æ—¶å€™è‡ªåŠ¨æ ¼å¼åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚\n\n## [pre-commit](https://pre-commit.com/)\n\n> A framework for managing and maintaining multi-languageÂ pre-commitÂ hooks.\n\n\n\n å®‰è£…ï¼š\n\n```\n$ brew install pre-commit\n# æŸ¥çœ‹ç‰ˆæœ¬\n$ pre-commit --version\npre-commit 2.17.0\n```\n\n\n\næ·»åŠ é…ç½®æ–‡ä»¶`.pre-commit-config.yaml`ï¼Œé€šè¿‡[`pre-commit sample-config`](https://pre-commit.com/#pre-commit-sample-config)\n\nå‘½ä»¤å¿«é€Ÿç”Ÿæˆä¸€ä¸ªåŸºæœ¬çš„é…ç½®æ–‡ä»¶ã€‚ æ›´å¤šå…³äºæ–‡ä»¶ä¸­é€‰é¡¹çš„é…ç½®ï¼Œå‚è€ƒ[pre-commit](https://pre-commit.com/#plugins)\n\n```\nâœ  ~ pre-commit sample-config\n# See https://pre-commit.com for more information\n# See https://pre-commit.com/hooks.html for more hooks\nrepos:\n-   repo: https://github.com/pre-commit/pre-commit-hooks\n    rev: v3.2.0\n    hooks:\n    -   id: trailing-whitespace\n    -   id: end-of-file-fixer\n    -   id: check-yaml\n    -   id: check-added-large-files\n```\n\nä¸Šé¢é…ç½®æŒ‡å®šäº†å¦‚ä½•å»æ ¼å¼åŒ–pythonä»£ç ï¼Œpre commit æ”¯æŒæ ¼å¼åŒ–å…¶ä»–çš„ç¼–ç¨‹è¯­è¨€ï¼Œå‚è€ƒ\n\n[supported hooks](https://pre-commit.com/hooks.html)æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„è¯­è¨€ã€‚\n\n\n\næƒ³ç»“åˆclang-formatå¯¹å·¥ç¨‹ä¸­çš„c++ä»£ç è‡ªåŠ¨æ ¼å¼åŒ–ã€‚åœ¨[supported hooks](https://pre-commit.com/hooks.html)æ‰¾åˆ°äº†[GitHub - doublify/pre-commit-clang-format: ClangFormat hook for pre-commit](https://github.com/doublify/pre-commit-clang-format)\n\n\n\nå¦‚ä½•ä½¿ç”¨å‘¢?\n\n1. åœ¨å·¥ç¨‹ä¸­åˆ›å»º`.pre-commit-config.yaml`æ–‡ä»¶\n\n2. é…ç½®`.pre-commit-config.yaml`æ–‡ä»¶\n   \n   ```\n   repos:\n   -   repo: https://github.com/doublify/pre-commit-clang-format.git\n       rev: 62302476d0da01515660132d76902359bed0f782\n       hooks:\n       -   id: clang-format\n   ```\n\n3. å®‰è£…git hooks è„šæœ¬\n   \n   ```\n   $ pre-commit install\n   pre-commit installed at .git/hooks/pre-commit\n   ```\n\n4.  (å¯é€‰)æ‰‹åŠ¨è°ƒç”¨pre commitï¼Œçœ‹çœ‹æ ¼å¼åŒ–åçš„æ•ˆæœ\n   \n   ```\n   $ pre-commit run --all-files\n   ```\n\n5.  è°ƒç”¨`git commit`, ä¼šè§¦å‘git hookï¼Œè°ƒç”¨`clang-format`è‡ªåŠ¨åŒ–æ ¼å¼ä»£ç ã€‚\n\n\n","slug":"c++/2022-03-21-git hook clang-format","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkm001157whbvrc18cw","content":"<h2 id=\"ClangFormat\"><a href=\"#ClangFormat\" class=\"headerlink\" title=\"ClangFormat \"></a><a href=\"https://clang.llvm.org/docs/ClangFormat.html\">ClangFormat </a></h2><p>ClangFormat æè¿°äº†ä¸€ç»„æ„å»ºåœ¨ <a href=\"(https://clang.llvm.org/docs/LibFormat.html)\">LibFormat</a> ä¹‹ä¸Šçš„å·¥å…·ã€‚å®ƒå¯ä»¥ä»¥å¤šç§æ–¹å¼æ”¯æŒæ‚¨çš„å·¥ä½œæµï¼ŒåŒ…æ‹¬ç‹¬ç«‹å·¥å…·å’Œç¼–è¾‘å™¨é›†æˆã€‚</p>\n<p>å…¶ä¸­ç‹¬ç«‹çš„å·¥å…·å°±æ˜¯clang-format, å¯ç”¨äºæ ¼å¼åŒ– c&#x2F;c + +&#x2F;Java&#x2F;JavaScript&#x2F;JSON&#x2F;Objective-C&#x2F;Protobuf&#x2F;c # ä»£ç ã€‚</p>\n<p>clang-formatçš„é»˜è®¤é…ç½®æ–‡ä»¶æ˜¯<code>.clang-format</code>æˆ–<code>_clang-format</code>, ä¹Ÿå¯ä»¥é€šè¿‡<code>clang-formatÂ -style=file</code>æŒ‡å®šé…ç½®æ–‡ä»¶ã€‚</p>\n<p><code>.clang-format</code> ä½¿ç”¨yamlæ ¼å¼ï¼ŒæŒ‡å®šäº†å¦‚ä½•å¯¹æ–‡ä»¶æ ¼å¼åŒ–çš„è§„åˆ™ã€‚</p>\n<p>å¯ä»¥åŸºäºé¢„å®šä¹‰çš„æ ·å¼ï¼Œå¿«é€Ÿåˆ›å»º<code>.clang-format</code>æ–‡ä»¶ã€‚</p>\n<ul>\n<li><p><code>LLVM</code>Â A style complying with theÂ <a href=\"https://llvm.org/docs/CodingStandards.html\">LLVM coding standards</a></p>\n</li>\n<li><p><code>Google</code>Â A style complying withÂ <a href=\"https://google.github.io/styleguide/cppguide.html\">Googleâ€™s C++ style guide</a></p>\n</li>\n<li><p><code>Chromium</code>Â A style complying withÂ <a href=\"https://chromium.googlesource.com/chromium/src/+/refs/heads/main/styleguide/styleguide.md\">Chromiumâ€™s style guide</a></p>\n</li>\n<li><p><code>Mozilla</code>Â A style complying withÂ <a href=\"https://firefox-source-docs.mozilla.org/code-quality/coding-style/index.html\">Mozillaâ€™s style guide</a></p>\n</li>\n<li><p><code>WebKit</code>Â A style complying withÂ <a href=\"https://www.webkit.org/coding/coding-style.html\">WebKitâ€™s style guide</a></p>\n</li>\n<li><p><code>Microsoft</code>Â A style complying withÂ <a href=\"https://docs.microsoft.com/en-us/visualstudio/ide/editorconfig-code-style-settings-reference\">Microsoftâ€™s style guide</a></p>\n</li>\n<li><p><code>GNU</code>Â A style complying with theÂ <a href=\"https://www.gnu.org/prep/standards/standards.html\">GNU coding standards</a></p>\n</li>\n</ul>\n<p>ä¾‹å¦‚ç”Ÿæˆllvmé£æ ¼çš„ï¼š</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lua\">clang-<span class=\"hljs-built_in\">format</span> -style=llvm -<span class=\"hljs-built_in\">dump</span>-<span class=\"hljs-built_in\">config</span> &gt; .clang-<span class=\"hljs-built_in\">format</span><br></code></pre></td></tr></table></figure>\n\n<p> ç„¶åå¯ä»¥åŸºäºç”Ÿæˆçš„<code>.clang-format</code>æ–‡ä»¶ä¿®æ”¹å‚æ•°ï¼Œå®šåˆ¶è‡ªå·±çš„æ ·å¼ã€‚</p>\n<p>æ›´å¤šå‚è€ƒï¼š <a href=\"https://clang.llvm.org/docs/ClangFormatStyleOptions.html\">Clang-Format Style Options </a></p>\n<p>mac ä¸‹å®‰è£… clang-format</p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>clang-format<br></code></pre></td></tr></table></figure>\n\n<p>å°†ç”Ÿæˆçš„<code>.clang-format</code>æ”¾å…¥å·¥ç¨‹ç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤æ ¼å¼åŒ–æ–‡ä»¶</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs css\">clang-format -<span class=\"hljs-selector-tag\">i</span> xx<span class=\"hljs-selector-class\">.cpp</span><br></code></pre></td></tr></table></figure>\n\n<p><code>-i</code>æ ¼å¼åŒ–å½“å‰æ–‡ä»¶ï¼Œå¹¶å°†æ ¼å¼åŒ–åçš„å†…å®¹è¾“å‡ºåˆ°å½“å‰æ–‡ä»¶ã€‚ä¸åŠ <code>-i</code>ä¼šå°†æ ¼å¼åŒ–çš„å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚</p>\n<p>ç„¶åæˆ‘ä»¬å¸Œæœ›åœ¨æäº¤çš„æ—¶å€™æ ¹æ®æˆ‘ä»¬çš„é…ç½®ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ï¼Œå¦‚ä½•åšå‘¢ï¼Ÿ</p>\n<p>å¯ä»¥é€šè¿‡git hooks ç»“åˆclang-format åœ¨æäº¤çš„æ—¶å€™è‡ªåŠ¨æ ¼å¼åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚</p>\n<h2 id=\"pre-commit\"><a href=\"#pre-commit\" class=\"headerlink\" title=\"pre-commit\"></a><a href=\"https://pre-commit.com/\">pre-commit</a></h2><blockquote>\n<p>A framework for managing and maintaining multi-languageÂ pre-commitÂ hooks.</p>\n</blockquote>\n<p> å®‰è£…ï¼š</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\">$ brew install pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span><br># æŸ¥çœ‹ç‰ˆæœ¬<br>$ pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-comment\">--version</span><br>pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">2.17</span><span class=\"hljs-number\">.0</span><br></code></pre></td></tr></table></figure>\n\n\n\n<p>æ·»åŠ é…ç½®æ–‡ä»¶<code>.pre-commit-config.yaml</code>ï¼Œé€šè¿‡<a href=\"https://pre-commit.com/#pre-commit-sample-config\"><code>pre-commit sample-config</code></a></p>\n<p>å‘½ä»¤å¿«é€Ÿç”Ÿæˆä¸€ä¸ªåŸºæœ¬çš„é…ç½®æ–‡ä»¶ã€‚ æ›´å¤šå…³äºæ–‡ä»¶ä¸­é€‰é¡¹çš„é…ç½®ï¼Œå‚è€ƒ<a href=\"https://pre-commit.com/#plugins\">pre-commit</a></p>\n<figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs smali\">âœ  ~ pre-commit sample-config<br><span class=\"hljs-comment\"># See https://pre-commit.com for more information</span><br><span class=\"hljs-comment\"># See https://pre-commit.com/hooks.html for more hooks</span><br>repos:<br>-   repo: https://github.com/pre-commit/pre-commit-hooks<br>    rev: v3.2.0<br>    hooks:<br>    -   id: trailing-whitespace<br>    -   id: end-of-file-fixer<br>    -   id:<span class=\"hljs-built_in\"> check-yaml</span><br><span class=\"hljs-built_in\"></span>    -   id: check-added-large-files<br></code></pre></td></tr></table></figure>\n\n<p>ä¸Šé¢é…ç½®æŒ‡å®šäº†å¦‚ä½•å»æ ¼å¼åŒ–pythonä»£ç ï¼Œpre commit æ”¯æŒæ ¼å¼åŒ–å…¶ä»–çš„ç¼–ç¨‹è¯­è¨€ï¼Œå‚è€ƒ</p>\n<p><a href=\"https://pre-commit.com/hooks.html\">supported hooks</a>æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„è¯­è¨€ã€‚</p>\n<p>æƒ³ç»“åˆclang-formatå¯¹å·¥ç¨‹ä¸­çš„c++ä»£ç è‡ªåŠ¨æ ¼å¼åŒ–ã€‚åœ¨<a href=\"https://pre-commit.com/hooks.html\">supported hooks</a>æ‰¾åˆ°äº†<a href=\"https://github.com/doublify/pre-commit-clang-format\">GitHub - doublify&#x2F;pre-commit-clang-format: ClangFormat hook for pre-commit</a></p>\n<p>å¦‚ä½•ä½¿ç”¨å‘¢?</p>\n<ol>\n<li><p>åœ¨å·¥ç¨‹ä¸­åˆ›å»º<code>.pre-commit-config.yaml</code>æ–‡ä»¶</p>\n</li>\n<li><p>é…ç½®<code>.pre-commit-config.yaml</code>æ–‡ä»¶</p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nestedtext\"><span class=\"hljs-attribute\">repos</span><span class=\"hljs-punctuation\">:</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">  repo: https://github.com/doublify/pre-commit-clang-format.git</span><br>    <span class=\"hljs-attribute\">rev</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">62302476d0da01515660132d76902359bed0f782</span><br>    <span class=\"hljs-attribute\">hooks</span><span class=\"hljs-punctuation\">:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">  id: clang-format</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>å®‰è£…git hooks è„šæœ¬</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\">$ pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span> install<br>pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span> installed <span class=\"hljs-keyword\">at</span> .git<span class=\"hljs-operator\">/</span>hooks<span class=\"hljs-operator\">/</span>pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>(å¯é€‰)æ‰‹åŠ¨è°ƒç”¨pre commitï¼Œçœ‹çœ‹æ ¼å¼åŒ–åçš„æ•ˆæœ</p>\n</li>\n</ol>\n   <figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gams\"><span class=\"hljs-symbol\">$</span> pre-commit run --<span class=\"hljs-keyword\">all</span>-<span class=\"hljs-keyword\">files</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"5\">\n<li>è°ƒç”¨<code>git commit</code>, ä¼šè§¦å‘git hookï¼Œè°ƒç”¨<code>clang-format</code>è‡ªåŠ¨åŒ–æ ¼å¼ä»£ç ã€‚</li>\n</ol>\n","excerpt":"","more":"<h2 id=\"ClangFormat\"><a href=\"#ClangFormat\" class=\"headerlink\" title=\"ClangFormat \"></a><a href=\"https://clang.llvm.org/docs/ClangFormat.html\">ClangFormat </a></h2><p>ClangFormat æè¿°äº†ä¸€ç»„æ„å»ºåœ¨ <a href=\"(https://clang.llvm.org/docs/LibFormat.html)\">LibFormat</a> ä¹‹ä¸Šçš„å·¥å…·ã€‚å®ƒå¯ä»¥ä»¥å¤šç§æ–¹å¼æ”¯æŒæ‚¨çš„å·¥ä½œæµï¼ŒåŒ…æ‹¬ç‹¬ç«‹å·¥å…·å’Œç¼–è¾‘å™¨é›†æˆã€‚</p>\n<p>å…¶ä¸­ç‹¬ç«‹çš„å·¥å…·å°±æ˜¯clang-format, å¯ç”¨äºæ ¼å¼åŒ– c&#x2F;c + +&#x2F;Java&#x2F;JavaScript&#x2F;JSON&#x2F;Objective-C&#x2F;Protobuf&#x2F;c # ä»£ç ã€‚</p>\n<p>clang-formatçš„é»˜è®¤é…ç½®æ–‡ä»¶æ˜¯<code>.clang-format</code>æˆ–<code>_clang-format</code>, ä¹Ÿå¯ä»¥é€šè¿‡<code>clang-formatÂ -style=file</code>æŒ‡å®šé…ç½®æ–‡ä»¶ã€‚</p>\n<p><code>.clang-format</code> ä½¿ç”¨yamlæ ¼å¼ï¼ŒæŒ‡å®šäº†å¦‚ä½•å¯¹æ–‡ä»¶æ ¼å¼åŒ–çš„è§„åˆ™ã€‚</p>\n<p>å¯ä»¥åŸºäºé¢„å®šä¹‰çš„æ ·å¼ï¼Œå¿«é€Ÿåˆ›å»º<code>.clang-format</code>æ–‡ä»¶ã€‚</p>\n<ul>\n<li><p><code>LLVM</code>Â A style complying with theÂ <a href=\"https://llvm.org/docs/CodingStandards.html\">LLVM coding standards</a></p>\n</li>\n<li><p><code>Google</code>Â A style complying withÂ <a href=\"https://google.github.io/styleguide/cppguide.html\">Googleâ€™s C++ style guide</a></p>\n</li>\n<li><p><code>Chromium</code>Â A style complying withÂ <a href=\"https://chromium.googlesource.com/chromium/src/+/refs/heads/main/styleguide/styleguide.md\">Chromiumâ€™s style guide</a></p>\n</li>\n<li><p><code>Mozilla</code>Â A style complying withÂ <a href=\"https://firefox-source-docs.mozilla.org/code-quality/coding-style/index.html\">Mozillaâ€™s style guide</a></p>\n</li>\n<li><p><code>WebKit</code>Â A style complying withÂ <a href=\"https://www.webkit.org/coding/coding-style.html\">WebKitâ€™s style guide</a></p>\n</li>\n<li><p><code>Microsoft</code>Â A style complying withÂ <a href=\"https://docs.microsoft.com/en-us/visualstudio/ide/editorconfig-code-style-settings-reference\">Microsoftâ€™s style guide</a></p>\n</li>\n<li><p><code>GNU</code>Â A style complying with theÂ <a href=\"https://www.gnu.org/prep/standards/standards.html\">GNU coding standards</a></p>\n</li>\n</ul>\n<p>ä¾‹å¦‚ç”Ÿæˆllvmé£æ ¼çš„ï¼š</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lua\">clang-<span class=\"hljs-built_in\">format</span> -style=llvm -<span class=\"hljs-built_in\">dump</span>-<span class=\"hljs-built_in\">config</span> &gt; .clang-<span class=\"hljs-built_in\">format</span><br></code></pre></td></tr></table></figure>\n\n<p> ç„¶åå¯ä»¥åŸºäºç”Ÿæˆçš„<code>.clang-format</code>æ–‡ä»¶ä¿®æ”¹å‚æ•°ï¼Œå®šåˆ¶è‡ªå·±çš„æ ·å¼ã€‚</p>\n<p>æ›´å¤šå‚è€ƒï¼š <a href=\"https://clang.llvm.org/docs/ClangFormatStyleOptions.html\">Clang-Format Style Options </a></p>\n<p>mac ä¸‹å®‰è£… clang-format</p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>clang-format<br></code></pre></td></tr></table></figure>\n\n<p>å°†ç”Ÿæˆçš„<code>.clang-format</code>æ”¾å…¥å·¥ç¨‹ç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤æ ¼å¼åŒ–æ–‡ä»¶</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs css\">clang-format -<span class=\"hljs-selector-tag\">i</span> xx<span class=\"hljs-selector-class\">.cpp</span><br></code></pre></td></tr></table></figure>\n\n<p><code>-i</code>æ ¼å¼åŒ–å½“å‰æ–‡ä»¶ï¼Œå¹¶å°†æ ¼å¼åŒ–åçš„å†…å®¹è¾“å‡ºåˆ°å½“å‰æ–‡ä»¶ã€‚ä¸åŠ <code>-i</code>ä¼šå°†æ ¼å¼åŒ–çš„å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚</p>\n<p>ç„¶åæˆ‘ä»¬å¸Œæœ›åœ¨æäº¤çš„æ—¶å€™æ ¹æ®æˆ‘ä»¬çš„é…ç½®ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ï¼Œå¦‚ä½•åšå‘¢ï¼Ÿ</p>\n<p>å¯ä»¥é€šè¿‡git hooks ç»“åˆclang-format åœ¨æäº¤çš„æ—¶å€™è‡ªåŠ¨æ ¼å¼åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚</p>\n<h2 id=\"pre-commit\"><a href=\"#pre-commit\" class=\"headerlink\" title=\"pre-commit\"></a><a href=\"https://pre-commit.com/\">pre-commit</a></h2><blockquote>\n<p>A framework for managing and maintaining multi-languageÂ pre-commitÂ hooks.</p>\n</blockquote>\n<p> å®‰è£…ï¼š</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\">$ brew install pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span><br># æŸ¥çœ‹ç‰ˆæœ¬<br>$ pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-comment\">--version</span><br>pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">2.17</span><span class=\"hljs-number\">.0</span><br></code></pre></td></tr></table></figure>\n\n\n\n<p>æ·»åŠ é…ç½®æ–‡ä»¶<code>.pre-commit-config.yaml</code>ï¼Œé€šè¿‡<a href=\"https://pre-commit.com/#pre-commit-sample-config\"><code>pre-commit sample-config</code></a></p>\n<p>å‘½ä»¤å¿«é€Ÿç”Ÿæˆä¸€ä¸ªåŸºæœ¬çš„é…ç½®æ–‡ä»¶ã€‚ æ›´å¤šå…³äºæ–‡ä»¶ä¸­é€‰é¡¹çš„é…ç½®ï¼Œå‚è€ƒ<a href=\"https://pre-commit.com/#plugins\">pre-commit</a></p>\n<figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs smali\">âœ  ~ pre-commit sample-config<br><span class=\"hljs-comment\"># See https://pre-commit.com for more information</span><br><span class=\"hljs-comment\"># See https://pre-commit.com/hooks.html for more hooks</span><br>repos:<br>-   repo: https://github.com/pre-commit/pre-commit-hooks<br>    rev: v3.2.0<br>    hooks:<br>    -   id: trailing-whitespace<br>    -   id: end-of-file-fixer<br>    -   id:<span class=\"hljs-built_in\"> check-yaml</span><br><span class=\"hljs-built_in\"></span>    -   id: check-added-large-files<br></code></pre></td></tr></table></figure>\n\n<p>ä¸Šé¢é…ç½®æŒ‡å®šäº†å¦‚ä½•å»æ ¼å¼åŒ–pythonä»£ç ï¼Œpre commit æ”¯æŒæ ¼å¼åŒ–å…¶ä»–çš„ç¼–ç¨‹è¯­è¨€ï¼Œå‚è€ƒ</p>\n<p><a href=\"https://pre-commit.com/hooks.html\">supported hooks</a>æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„è¯­è¨€ã€‚</p>\n<p>æƒ³ç»“åˆclang-formatå¯¹å·¥ç¨‹ä¸­çš„c++ä»£ç è‡ªåŠ¨æ ¼å¼åŒ–ã€‚åœ¨<a href=\"https://pre-commit.com/hooks.html\">supported hooks</a>æ‰¾åˆ°äº†<a href=\"https://github.com/doublify/pre-commit-clang-format\">GitHub - doublify&#x2F;pre-commit-clang-format: ClangFormat hook for pre-commit</a></p>\n<p>å¦‚ä½•ä½¿ç”¨å‘¢?</p>\n<ol>\n<li><p>åœ¨å·¥ç¨‹ä¸­åˆ›å»º<code>.pre-commit-config.yaml</code>æ–‡ä»¶</p>\n</li>\n<li><p>é…ç½®<code>.pre-commit-config.yaml</code>æ–‡ä»¶</p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nestedtext\"><span class=\"hljs-attribute\">repos</span><span class=\"hljs-punctuation\">:</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">  repo: https://github.com/doublify/pre-commit-clang-format.git</span><br>    <span class=\"hljs-attribute\">rev</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">62302476d0da01515660132d76902359bed0f782</span><br>    <span class=\"hljs-attribute\">hooks</span><span class=\"hljs-punctuation\">:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">  id: clang-format</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>å®‰è£…git hooks è„šæœ¬</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\">$ pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span> install<br>pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span> installed <span class=\"hljs-keyword\">at</span> .git<span class=\"hljs-operator\">/</span>hooks<span class=\"hljs-operator\">/</span>pre<span class=\"hljs-operator\">-</span><span class=\"hljs-keyword\">commit</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>(å¯é€‰)æ‰‹åŠ¨è°ƒç”¨pre commitï¼Œçœ‹çœ‹æ ¼å¼åŒ–åçš„æ•ˆæœ</p>\n</li>\n</ol>\n   <figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gams\"><span class=\"hljs-symbol\">$</span> pre-commit run --<span class=\"hljs-keyword\">all</span>-<span class=\"hljs-keyword\">files</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"5\">\n<li>è°ƒç”¨<code>git commit</code>, ä¼šè§¦å‘git hookï¼Œè°ƒç”¨<code>clang-format</code>è‡ªåŠ¨åŒ–æ ¼å¼ä»£ç ã€‚</li>\n</ol>\n"},{"layout":"post","title":"Xcode é…ç½® clang-format æ ¼å¼åŒ– C++ä»£ç ","date":"2022-10-28T16:00:00.000Z","_content":"\nåœ¨å‘½ä»¤è¡Œï¼Œé€šè¿‡`clang-format`å·¥å…·ï¼Œå¯ä»¥å¯¹ä»£ç è¿›è¡Œæ ¼å¼åŒ–ã€‚ä½† `clang-fromat` åªèƒ½åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è®©å®ƒåœ¨Xcodeä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨å‘¢ï¼Œè¿™æ ·å°±å¾ˆæ–¹ä¾¿çš„å¯¹å½“å‰æ–‡æ¡£è¿›è¡Œæ ¼å¼åŒ–äº†ã€‚ ç­”æ¡ˆæ˜¯ï¼š å€ŸåŠ© macOS è‡ªå¸¦çš„ Automator å·¥å…·ã€‚\n\n\n## clang-format å®‰è£…\n\n```\nbrew install clang-format\n```\n\n## æ·»åŠ  Automator æœåŠ¡\n\næ‰“å¼€ Automator é€‰æ‹©  \"Quick Action\"ã€‚\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670101357781667010134833.png)\n\n\nå·¦ä¾§ Library ä¸­æœç´¢ \"Run Shell Script\" å¹¶æ‹–åŠ¨åˆ°å³ä¾§ã€‚åœ¨è„šæœ¬ç¼–è¾‘æ¡†ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š\n```\nsource ~/.zshrc\nclang-format\n```\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670116407351667011639954.png)\n\nåŒæ—¶è®°å¾—å‹¾é€‰ä¸Š \"Output replaces selected text\"ï¼Œç„¶åä¿å­˜å¹¶è¾“å…¥ä¿å­˜çš„åç§°ï¼Œæ¯”å¦‚ clang-formatã€‚\n\nè‡³æ­¤ä¸€ä¸ªæœåŠ¡ä¾¿å·²æ·»åŠ å¥½ã€‚\n\n### Automator åœ¨ç£ç›˜ä¸Šçš„ä½ç½®\n\nThe location of the user created services is under:\n\n```\n~/Library/Services/\n```\n\nother locations you get by entering following command in Terminal:\n\n```\nmdfind .workflow\n```\n\n## ä½¿ç”¨\n\nç”¨æˆ·ä¸»ç›®å½•ï¼Œåˆ›å»º `.clang-format` æ–‡ä»¶\n\n```\nclang-format -style=google -dump-config > .clang-format\n```\næ‰“å¼€ Xcodeï¼Œ é€‰ä¸­éœ€è¦æ ¼å¼åŒ–çš„ä»£ç å¹¶å³é”®å”¤å‡ºèœå•ã€‚é€‰æ‹© Services-> clang-formatï¼Œè¿™é‡Œ Services ä¸­çš„åç§°å³ä¸ºå‰é¢æ­¥éª¤ä¸­ä¿å­˜çš„ Services åç§°ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670146406641667014640354.png)\n\n### æ·»åŠ å¿«æ·é”®\n\næ˜¾ç„¶å³é”®è¿™ç§æ–¹å¼ä¸å¤Ÿä¾¿æ·ï¼Œè¿›ä¸€æ­¥æ·»åŠ å¿«æ·é”®æ¥å®ç°æ›´åŠ æ–¹ä¾¿çš„ä»£ç æ ¼å¼åŒ–ã€‚å› ä¸º Xcode ä¸­æ ¼å¼åŒ–ä»£ç é»˜è®¤çš„å¿«æ·é”®ä¸º control + Iï¼Œä¸é˜²æˆ‘ä»¬å°±è®¾ç½® clang-format è¿™ä¸ªæœåŠ¡çš„å¿«æ·é”®ä¸ºè¿™ä¸ªæŒ‰é”®ç»„åˆã€‚\n\næ‰“å¼€ç³»ç»Ÿçš„é¦–é€‰é¡¹è®¾ç½®ï¼ˆå¯é€šè¿‡åœ¨ SpotLight ä¸­æœç´¢ \"system preference\"ï¼‰ï¼Œç„¶åæ‰“å¼€é”®ç›˜è®¾ç½® \"Kyeboard\" å¹¶åˆ‡æ¢åˆ° \"Shortcuts\" æ ‡ç­¾ã€‚\n\né€‰ä¸­å·¦ä¾§ \"App Shortcuts\" ç„¶åä¸º \"Xcode\" ç»‘å®š `control` + `I` æ‰§è¡Œ clang-formatã€‚\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670145906661667014590001.png)\n\nç„¶åä¾¿å¯é€šè¿‡å¿«æ·é”®æ–¹ä¾¿åœ°è¿›è¡Œä»£ç æ ¼å¼åŒ–äº†ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670146746631667014674463.png)\n\n**æ³¨æ„ï¼š**\nå¦‚æœä¸ç”Ÿæ•ˆï¼Œå°† Xcode ä¸­ `control` + `I` ç›¸å…³çš„å¿«æ·é”®ç½®ç©ºã€‚\n\n## å…¶ä»–å·¥å…·\n\nå­˜åœ¨ä¸€äº›å…¶ä»–ä»¥æ’ä»¶å½¢å¼çš„å·¥å…·ï¼ŒåŒæ ·èƒ½è¾¾åˆ°ä½¿ç”¨ clang-format æ ¼å¼åŒ–ä»£ç çš„ç›®çš„ï¼Œæ¯”å¦‚ [travisjeffery/ClangFormat-Xcode](https://github.com/travisjeffery/ClangFormat-Xcode)ï¼Œä½†ä¸æ”¯æŒ Xcode 9+ï¼Œå¯å®‰è£…å…¶æ›¿ä»£ç‰ˆ [V5zhou/ZZClang-format](https://github.com/V5zhou/ZZClang-format)\n\nè¯¥æ’ä»¶å®‰è£…å¥½åï¼Œæ”¯æŒåœ¨æ–‡ä»¶ä¿å­˜æ—¶è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚\n\nä½†å› ä¸ºæ˜¯æ¥è‡ªç¤¾åŒºçš„æ’ä»¶ï¼Œéœ€è¦å…ˆå°† Xcode å»æ‰ç­¾å ï¼ˆunsignï¼‰ï¼Œå‚è§ [inket/update_xcode_plugins](https://github.com/inket/update_xcode_plugins)ã€‚\n\n\nåŸæ–‡é“¾æ¥ï¼š [Xcode ä¸­é…ç½® clang-format æ ¼å¼åŒ– C++ ä»£ç ](https://www.cnblogs.com/Wayou/p/xcode_clang_setup.html)","source":"_posts/c++/2022-10-29-Xcode é…ç½® clang-format æ ¼å¼åŒ– c++ ä»£ç .md","raw":"---\n\nlayout: post\ntitle: \"Xcode é…ç½® clang-format æ ¼å¼åŒ– C++ä»£ç \"\ndate: 2022-10-29\ntag: c++\n\n---\n\nåœ¨å‘½ä»¤è¡Œï¼Œé€šè¿‡`clang-format`å·¥å…·ï¼Œå¯ä»¥å¯¹ä»£ç è¿›è¡Œæ ¼å¼åŒ–ã€‚ä½† `clang-fromat` åªèƒ½åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è®©å®ƒåœ¨Xcodeä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨å‘¢ï¼Œè¿™æ ·å°±å¾ˆæ–¹ä¾¿çš„å¯¹å½“å‰æ–‡æ¡£è¿›è¡Œæ ¼å¼åŒ–äº†ã€‚ ç­”æ¡ˆæ˜¯ï¼š å€ŸåŠ© macOS è‡ªå¸¦çš„ Automator å·¥å…·ã€‚\n\n\n## clang-format å®‰è£…\n\n```\nbrew install clang-format\n```\n\n## æ·»åŠ  Automator æœåŠ¡\n\næ‰“å¼€ Automator é€‰æ‹©  \"Quick Action\"ã€‚\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670101357781667010134833.png)\n\n\nå·¦ä¾§ Library ä¸­æœç´¢ \"Run Shell Script\" å¹¶æ‹–åŠ¨åˆ°å³ä¾§ã€‚åœ¨è„šæœ¬ç¼–è¾‘æ¡†ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š\n```\nsource ~/.zshrc\nclang-format\n```\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670116407351667011639954.png)\n\nåŒæ—¶è®°å¾—å‹¾é€‰ä¸Š \"Output replaces selected text\"ï¼Œç„¶åä¿å­˜å¹¶è¾“å…¥ä¿å­˜çš„åç§°ï¼Œæ¯”å¦‚ clang-formatã€‚\n\nè‡³æ­¤ä¸€ä¸ªæœåŠ¡ä¾¿å·²æ·»åŠ å¥½ã€‚\n\n### Automator åœ¨ç£ç›˜ä¸Šçš„ä½ç½®\n\nThe location of the user created services is under:\n\n```\n~/Library/Services/\n```\n\nother locations you get by entering following command in Terminal:\n\n```\nmdfind .workflow\n```\n\n## ä½¿ç”¨\n\nç”¨æˆ·ä¸»ç›®å½•ï¼Œåˆ›å»º `.clang-format` æ–‡ä»¶\n\n```\nclang-format -style=google -dump-config > .clang-format\n```\næ‰“å¼€ Xcodeï¼Œ é€‰ä¸­éœ€è¦æ ¼å¼åŒ–çš„ä»£ç å¹¶å³é”®å”¤å‡ºèœå•ã€‚é€‰æ‹© Services-> clang-formatï¼Œè¿™é‡Œ Services ä¸­çš„åç§°å³ä¸ºå‰é¢æ­¥éª¤ä¸­ä¿å­˜çš„ Services åç§°ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670146406641667014640354.png)\n\n### æ·»åŠ å¿«æ·é”®\n\næ˜¾ç„¶å³é”®è¿™ç§æ–¹å¼ä¸å¤Ÿä¾¿æ·ï¼Œè¿›ä¸€æ­¥æ·»åŠ å¿«æ·é”®æ¥å®ç°æ›´åŠ æ–¹ä¾¿çš„ä»£ç æ ¼å¼åŒ–ã€‚å› ä¸º Xcode ä¸­æ ¼å¼åŒ–ä»£ç é»˜è®¤çš„å¿«æ·é”®ä¸º control + Iï¼Œä¸é˜²æˆ‘ä»¬å°±è®¾ç½® clang-format è¿™ä¸ªæœåŠ¡çš„å¿«æ·é”®ä¸ºè¿™ä¸ªæŒ‰é”®ç»„åˆã€‚\n\næ‰“å¼€ç³»ç»Ÿçš„é¦–é€‰é¡¹è®¾ç½®ï¼ˆå¯é€šè¿‡åœ¨ SpotLight ä¸­æœç´¢ \"system preference\"ï¼‰ï¼Œç„¶åæ‰“å¼€é”®ç›˜è®¾ç½® \"Kyeboard\" å¹¶åˆ‡æ¢åˆ° \"Shortcuts\" æ ‡ç­¾ã€‚\n\né€‰ä¸­å·¦ä¾§ \"App Shortcuts\" ç„¶åä¸º \"Xcode\" ç»‘å®š `control` + `I` æ‰§è¡Œ clang-formatã€‚\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670145906661667014590001.png)\n\nç„¶åä¾¿å¯é€šè¿‡å¿«æ·é”®æ–¹ä¾¿åœ°è¿›è¡Œä»£ç æ ¼å¼åŒ–äº†ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670146746631667014674463.png)\n\n**æ³¨æ„ï¼š**\nå¦‚æœä¸ç”Ÿæ•ˆï¼Œå°† Xcode ä¸­ `control` + `I` ç›¸å…³çš„å¿«æ·é”®ç½®ç©ºã€‚\n\n## å…¶ä»–å·¥å…·\n\nå­˜åœ¨ä¸€äº›å…¶ä»–ä»¥æ’ä»¶å½¢å¼çš„å·¥å…·ï¼ŒåŒæ ·èƒ½è¾¾åˆ°ä½¿ç”¨ clang-format æ ¼å¼åŒ–ä»£ç çš„ç›®çš„ï¼Œæ¯”å¦‚ [travisjeffery/ClangFormat-Xcode](https://github.com/travisjeffery/ClangFormat-Xcode)ï¼Œä½†ä¸æ”¯æŒ Xcode 9+ï¼Œå¯å®‰è£…å…¶æ›¿ä»£ç‰ˆ [V5zhou/ZZClang-format](https://github.com/V5zhou/ZZClang-format)\n\nè¯¥æ’ä»¶å®‰è£…å¥½åï¼Œæ”¯æŒåœ¨æ–‡ä»¶ä¿å­˜æ—¶è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚\n\nä½†å› ä¸ºæ˜¯æ¥è‡ªç¤¾åŒºçš„æ’ä»¶ï¼Œéœ€è¦å…ˆå°† Xcode å»æ‰ç­¾å ï¼ˆunsignï¼‰ï¼Œå‚è§ [inket/update_xcode_plugins](https://github.com/inket/update_xcode_plugins)ã€‚\n\n\nåŸæ–‡é“¾æ¥ï¼š [Xcode ä¸­é…ç½® clang-format æ ¼å¼åŒ– C++ ä»£ç ](https://www.cnblogs.com/Wayou/p/xcode_clang_setup.html)","slug":"c++/2022-10-29-Xcode é…ç½® clang-format æ ¼å¼åŒ– c++ ä»£ç ","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkm001357whh03m2jle","content":"<p>åœ¨å‘½ä»¤è¡Œï¼Œé€šè¿‡<code>clang-format</code>å·¥å…·ï¼Œå¯ä»¥å¯¹ä»£ç è¿›è¡Œæ ¼å¼åŒ–ã€‚ä½† <code>clang-fromat</code> åªèƒ½åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è®©å®ƒåœ¨Xcodeä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨å‘¢ï¼Œè¿™æ ·å°±å¾ˆæ–¹ä¾¿çš„å¯¹å½“å‰æ–‡æ¡£è¿›è¡Œæ ¼å¼åŒ–äº†ã€‚ ç­”æ¡ˆæ˜¯ï¼š å€ŸåŠ© macOS è‡ªå¸¦çš„ Automator å·¥å…·ã€‚</p>\n<h2 id=\"clang-format-å®‰è£…\"><a href=\"#clang-format-å®‰è£…\" class=\"headerlink\" title=\"clang-format å®‰è£…\"></a>clang-format å®‰è£…</h2><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>clang-format<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æ·»åŠ -Automator-æœåŠ¡\"><a href=\"#æ·»åŠ -Automator-æœåŠ¡\" class=\"headerlink\" title=\"æ·»åŠ  Automator æœåŠ¡\"></a>æ·»åŠ  Automator æœåŠ¡</h2><p>æ‰“å¼€ Automator é€‰æ‹©  â€œQuick Actionâ€ã€‚<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670101357781667010134833.png\"></p>\n<p>å·¦ä¾§ Library ä¸­æœç´¢ â€œRun Shell Scriptâ€ å¹¶æ‹–åŠ¨åˆ°å³ä¾§ã€‚åœ¨è„šæœ¬ç¼–è¾‘æ¡†ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">source</span> ~/.zshrc<br>clang-format<br></code></pre></td></tr></table></figure>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670116407351667011639954.png\"></p>\n<p>åŒæ—¶è®°å¾—å‹¾é€‰ä¸Š â€œOutput replaces selected textâ€ï¼Œç„¶åä¿å­˜å¹¶è¾“å…¥ä¿å­˜çš„åç§°ï¼Œæ¯”å¦‚ clang-formatã€‚</p>\n<p>è‡³æ­¤ä¸€ä¸ªæœåŠ¡ä¾¿å·²æ·»åŠ å¥½ã€‚</p>\n<h3 id=\"Automator-åœ¨ç£ç›˜ä¸Šçš„ä½ç½®\"><a href=\"#Automator-åœ¨ç£ç›˜ä¸Šçš„ä½ç½®\" class=\"headerlink\" title=\"Automator åœ¨ç£ç›˜ä¸Šçš„ä½ç½®\"></a>Automator åœ¨ç£ç›˜ä¸Šçš„ä½ç½®</h3><p>The location of the user created services is under:</p>\n<figure class=\"highlight arcade\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arcade\">~<span class=\"hljs-regexp\">/Library/</span>Services/<br></code></pre></td></tr></table></figure>\n\n<p>other locations you get by entering following command in Terminal:</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">mdfind <span class=\"hljs-string\">.workflow</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ä½¿ç”¨\"><a href=\"#ä½¿ç”¨\" class=\"headerlink\" title=\"ä½¿ç”¨\"></a>ä½¿ç”¨</h2><p>ç”¨æˆ·ä¸»ç›®å½•ï¼Œåˆ›å»º <code>.clang-format</code> æ–‡ä»¶</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lua\">clang-<span class=\"hljs-built_in\">format</span> -style=google -<span class=\"hljs-built_in\">dump</span>-<span class=\"hljs-built_in\">config</span> &gt; .clang-<span class=\"hljs-built_in\">format</span><br></code></pre></td></tr></table></figure>\n<p>æ‰“å¼€ Xcodeï¼Œ é€‰ä¸­éœ€è¦æ ¼å¼åŒ–çš„ä»£ç å¹¶å³é”®å”¤å‡ºèœå•ã€‚é€‰æ‹© Services-&gt; clang-formatï¼Œè¿™é‡Œ Services ä¸­çš„åç§°å³ä¸ºå‰é¢æ­¥éª¤ä¸­ä¿å­˜çš„ Services åç§°ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670146406641667014640354.png\"></p>\n<h3 id=\"æ·»åŠ å¿«æ·é”®\"><a href=\"#æ·»åŠ å¿«æ·é”®\" class=\"headerlink\" title=\"æ·»åŠ å¿«æ·é”®\"></a>æ·»åŠ å¿«æ·é”®</h3><p>æ˜¾ç„¶å³é”®è¿™ç§æ–¹å¼ä¸å¤Ÿä¾¿æ·ï¼Œè¿›ä¸€æ­¥æ·»åŠ å¿«æ·é”®æ¥å®ç°æ›´åŠ æ–¹ä¾¿çš„ä»£ç æ ¼å¼åŒ–ã€‚å› ä¸º Xcode ä¸­æ ¼å¼åŒ–ä»£ç é»˜è®¤çš„å¿«æ·é”®ä¸º control + Iï¼Œä¸é˜²æˆ‘ä»¬å°±è®¾ç½® clang-format è¿™ä¸ªæœåŠ¡çš„å¿«æ·é”®ä¸ºè¿™ä¸ªæŒ‰é”®ç»„åˆã€‚</p>\n<p>æ‰“å¼€ç³»ç»Ÿçš„é¦–é€‰é¡¹è®¾ç½®ï¼ˆå¯é€šè¿‡åœ¨ SpotLight ä¸­æœç´¢ â€œsystem preferenceâ€ï¼‰ï¼Œç„¶åæ‰“å¼€é”®ç›˜è®¾ç½® â€œKyeboardâ€ å¹¶åˆ‡æ¢åˆ° â€œShortcutsâ€ æ ‡ç­¾ã€‚</p>\n<p>é€‰ä¸­å·¦ä¾§ â€œApp Shortcutsâ€ ç„¶åä¸º â€œXcodeâ€ ç»‘å®š <code>control</code> + <code>I</code> æ‰§è¡Œ clang-formatã€‚<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670145906661667014590001.png\"></p>\n<p>ç„¶åä¾¿å¯é€šè¿‡å¿«æ·é”®æ–¹ä¾¿åœ°è¿›è¡Œä»£ç æ ¼å¼åŒ–äº†ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670146746631667014674463.png\"></p>\n<p><strong>æ³¨æ„ï¼š</strong><br>å¦‚æœä¸ç”Ÿæ•ˆï¼Œå°† Xcode ä¸­ <code>control</code> + <code>I</code> ç›¸å…³çš„å¿«æ·é”®ç½®ç©ºã€‚</p>\n<h2 id=\"å…¶ä»–å·¥å…·\"><a href=\"#å…¶ä»–å·¥å…·\" class=\"headerlink\" title=\"å…¶ä»–å·¥å…·\"></a>å…¶ä»–å·¥å…·</h2><p>å­˜åœ¨ä¸€äº›å…¶ä»–ä»¥æ’ä»¶å½¢å¼çš„å·¥å…·ï¼ŒåŒæ ·èƒ½è¾¾åˆ°ä½¿ç”¨ clang-format æ ¼å¼åŒ–ä»£ç çš„ç›®çš„ï¼Œæ¯”å¦‚ <a href=\"https://github.com/travisjeffery/ClangFormat-Xcode\">travisjeffery&#x2F;ClangFormat-Xcode</a>ï¼Œä½†ä¸æ”¯æŒ Xcode 9+ï¼Œå¯å®‰è£…å…¶æ›¿ä»£ç‰ˆ <a href=\"https://github.com/V5zhou/ZZClang-format\">V5zhou&#x2F;ZZClang-format</a></p>\n<p>è¯¥æ’ä»¶å®‰è£…å¥½åï¼Œæ”¯æŒåœ¨æ–‡ä»¶ä¿å­˜æ—¶è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚</p>\n<p>ä½†å› ä¸ºæ˜¯æ¥è‡ªç¤¾åŒºçš„æ’ä»¶ï¼Œéœ€è¦å…ˆå°† Xcode å»æ‰ç­¾å ï¼ˆunsignï¼‰ï¼Œå‚è§ <a href=\"https://github.com/inket/update_xcode_plugins\">inket&#x2F;update_xcode_plugins</a>ã€‚</p>\n<p>åŸæ–‡é“¾æ¥ï¼š <a href=\"https://www.cnblogs.com/Wayou/p/xcode_clang_setup.html\">Xcode ä¸­é…ç½® clang-format æ ¼å¼åŒ– C++ ä»£ç </a></p>\n","excerpt":"","more":"<p>åœ¨å‘½ä»¤è¡Œï¼Œé€šè¿‡<code>clang-format</code>å·¥å…·ï¼Œå¯ä»¥å¯¹ä»£ç è¿›è¡Œæ ¼å¼åŒ–ã€‚ä½† <code>clang-fromat</code> åªèƒ½åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è®©å®ƒåœ¨Xcodeä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨å‘¢ï¼Œè¿™æ ·å°±å¾ˆæ–¹ä¾¿çš„å¯¹å½“å‰æ–‡æ¡£è¿›è¡Œæ ¼å¼åŒ–äº†ã€‚ ç­”æ¡ˆæ˜¯ï¼š å€ŸåŠ© macOS è‡ªå¸¦çš„ Automator å·¥å…·ã€‚</p>\n<h2 id=\"clang-format-å®‰è£…\"><a href=\"#clang-format-å®‰è£…\" class=\"headerlink\" title=\"clang-format å®‰è£…\"></a>clang-format å®‰è£…</h2><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>clang-format<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æ·»åŠ -Automator-æœåŠ¡\"><a href=\"#æ·»åŠ -Automator-æœåŠ¡\" class=\"headerlink\" title=\"æ·»åŠ  Automator æœåŠ¡\"></a>æ·»åŠ  Automator æœåŠ¡</h2><p>æ‰“å¼€ Automator é€‰æ‹©  â€œQuick Actionâ€ã€‚<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670101357781667010134833.png\"></p>\n<p>å·¦ä¾§ Library ä¸­æœç´¢ â€œRun Shell Scriptâ€ å¹¶æ‹–åŠ¨åˆ°å³ä¾§ã€‚åœ¨è„šæœ¬ç¼–è¾‘æ¡†ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">source</span> ~/.zshrc<br>clang-format<br></code></pre></td></tr></table></figure>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670116407351667011639954.png\"></p>\n<p>åŒæ—¶è®°å¾—å‹¾é€‰ä¸Š â€œOutput replaces selected textâ€ï¼Œç„¶åä¿å­˜å¹¶è¾“å…¥ä¿å­˜çš„åç§°ï¼Œæ¯”å¦‚ clang-formatã€‚</p>\n<p>è‡³æ­¤ä¸€ä¸ªæœåŠ¡ä¾¿å·²æ·»åŠ å¥½ã€‚</p>\n<h3 id=\"Automator-åœ¨ç£ç›˜ä¸Šçš„ä½ç½®\"><a href=\"#Automator-åœ¨ç£ç›˜ä¸Šçš„ä½ç½®\" class=\"headerlink\" title=\"Automator åœ¨ç£ç›˜ä¸Šçš„ä½ç½®\"></a>Automator åœ¨ç£ç›˜ä¸Šçš„ä½ç½®</h3><p>The location of the user created services is under:</p>\n<figure class=\"highlight arcade\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arcade\">~<span class=\"hljs-regexp\">/Library/</span>Services/<br></code></pre></td></tr></table></figure>\n\n<p>other locations you get by entering following command in Terminal:</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">mdfind <span class=\"hljs-string\">.workflow</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ä½¿ç”¨\"><a href=\"#ä½¿ç”¨\" class=\"headerlink\" title=\"ä½¿ç”¨\"></a>ä½¿ç”¨</h2><p>ç”¨æˆ·ä¸»ç›®å½•ï¼Œåˆ›å»º <code>.clang-format</code> æ–‡ä»¶</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lua\">clang-<span class=\"hljs-built_in\">format</span> -style=google -<span class=\"hljs-built_in\">dump</span>-<span class=\"hljs-built_in\">config</span> &gt; .clang-<span class=\"hljs-built_in\">format</span><br></code></pre></td></tr></table></figure>\n<p>æ‰“å¼€ Xcodeï¼Œ é€‰ä¸­éœ€è¦æ ¼å¼åŒ–çš„ä»£ç å¹¶å³é”®å”¤å‡ºèœå•ã€‚é€‰æ‹© Services-&gt; clang-formatï¼Œè¿™é‡Œ Services ä¸­çš„åç§°å³ä¸ºå‰é¢æ­¥éª¤ä¸­ä¿å­˜çš„ Services åç§°ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670146406641667014640354.png\"></p>\n<h3 id=\"æ·»åŠ å¿«æ·é”®\"><a href=\"#æ·»åŠ å¿«æ·é”®\" class=\"headerlink\" title=\"æ·»åŠ å¿«æ·é”®\"></a>æ·»åŠ å¿«æ·é”®</h3><p>æ˜¾ç„¶å³é”®è¿™ç§æ–¹å¼ä¸å¤Ÿä¾¿æ·ï¼Œè¿›ä¸€æ­¥æ·»åŠ å¿«æ·é”®æ¥å®ç°æ›´åŠ æ–¹ä¾¿çš„ä»£ç æ ¼å¼åŒ–ã€‚å› ä¸º Xcode ä¸­æ ¼å¼åŒ–ä»£ç é»˜è®¤çš„å¿«æ·é”®ä¸º control + Iï¼Œä¸é˜²æˆ‘ä»¬å°±è®¾ç½® clang-format è¿™ä¸ªæœåŠ¡çš„å¿«æ·é”®ä¸ºè¿™ä¸ªæŒ‰é”®ç»„åˆã€‚</p>\n<p>æ‰“å¼€ç³»ç»Ÿçš„é¦–é€‰é¡¹è®¾ç½®ï¼ˆå¯é€šè¿‡åœ¨ SpotLight ä¸­æœç´¢ â€œsystem preferenceâ€ï¼‰ï¼Œç„¶åæ‰“å¼€é”®ç›˜è®¾ç½® â€œKyeboardâ€ å¹¶åˆ‡æ¢åˆ° â€œShortcutsâ€ æ ‡ç­¾ã€‚</p>\n<p>é€‰ä¸­å·¦ä¾§ â€œApp Shortcutsâ€ ç„¶åä¸º â€œXcodeâ€ ç»‘å®š <code>control</code> + <code>I</code> æ‰§è¡Œ clang-formatã€‚<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670145906661667014590001.png\"></p>\n<p>ç„¶åä¾¿å¯é€šè¿‡å¿«æ·é”®æ–¹ä¾¿åœ°è¿›è¡Œä»£ç æ ¼å¼åŒ–äº†ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16670146746631667014674463.png\"></p>\n<p><strong>æ³¨æ„ï¼š</strong><br>å¦‚æœä¸ç”Ÿæ•ˆï¼Œå°† Xcode ä¸­ <code>control</code> + <code>I</code> ç›¸å…³çš„å¿«æ·é”®ç½®ç©ºã€‚</p>\n<h2 id=\"å…¶ä»–å·¥å…·\"><a href=\"#å…¶ä»–å·¥å…·\" class=\"headerlink\" title=\"å…¶ä»–å·¥å…·\"></a>å…¶ä»–å·¥å…·</h2><p>å­˜åœ¨ä¸€äº›å…¶ä»–ä»¥æ’ä»¶å½¢å¼çš„å·¥å…·ï¼ŒåŒæ ·èƒ½è¾¾åˆ°ä½¿ç”¨ clang-format æ ¼å¼åŒ–ä»£ç çš„ç›®çš„ï¼Œæ¯”å¦‚ <a href=\"https://github.com/travisjeffery/ClangFormat-Xcode\">travisjeffery&#x2F;ClangFormat-Xcode</a>ï¼Œä½†ä¸æ”¯æŒ Xcode 9+ï¼Œå¯å®‰è£…å…¶æ›¿ä»£ç‰ˆ <a href=\"https://github.com/V5zhou/ZZClang-format\">V5zhou&#x2F;ZZClang-format</a></p>\n<p>è¯¥æ’ä»¶å®‰è£…å¥½åï¼Œæ”¯æŒåœ¨æ–‡ä»¶ä¿å­˜æ—¶è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚</p>\n<p>ä½†å› ä¸ºæ˜¯æ¥è‡ªç¤¾åŒºçš„æ’ä»¶ï¼Œéœ€è¦å…ˆå°† Xcode å»æ‰ç­¾å ï¼ˆunsignï¼‰ï¼Œå‚è§ <a href=\"https://github.com/inket/update_xcode_plugins\">inket&#x2F;update_xcode_plugins</a>ã€‚</p>\n<p>åŸæ–‡é“¾æ¥ï¼š <a href=\"https://www.cnblogs.com/Wayou/p/xcode_clang_setup.html\">Xcode ä¸­é…ç½® clang-format æ ¼å¼åŒ– C++ ä»£ç </a></p>\n"},{"layout":"post","title":"ç»“æ„ä½“ä½åŸŸä¸­çš„é«˜ä½ä½é—®é¢˜","date":"2023-06-08T16:00:00.000Z","_content":"\n\næµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n\n```\n#include <iostream>\n\nunion Test {\n    unsigned char ch;\n    struct {\n        uint8_t a: 1;\n        uint8_t b: 3;\n        uint8_t c: 2;\n        uint8_t d: 2;\n    };\n\n};\n\nint main(int argc, const char * argv[]) {\n    Test test;\n    test.a = 1;\n    test.b = 0;\n    test.c = 0;\n    test.d = 0b11;\n\n    std::cout << test.ch << std::endl;\n    return 0;\n}\n```\n\nåœ¨ macOS ä¸Šæ–­ç‚¹æŸ¥çœ‹å†…å­˜å¦‚ä¸‹\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16863024030361686302402947.png)\n\n\n# ç»“è®ºï¼š\n\nå¯ä»¥çœ‹åˆ°ï¼Œå®šä¹‰åœ¨å‰çš„ä½åŸŸï¼Œåœ¨å­—èŠ‚çš„ä½ä½ã€‚\nä½åŸŸåœ¨å†…å­˜ä¸­å­˜å‚¨çš„é¡ºåºåˆšå¥½ä¸å®šä¹‰çš„å…ˆåç›¸åã€‚\n\n\n\n\n","source":"_posts/c++/2023-06-09-ä½åŸŸ é«˜ä½ä½.md","raw":"\n---\n\nlayout: post\ntitle: \"ç»“æ„ä½“ä½åŸŸä¸­çš„é«˜ä½ä½é—®é¢˜\"\ndate: 2023-06-09\ntag: c++\n\n---\n\n\næµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n\n```\n#include <iostream>\n\nunion Test {\n    unsigned char ch;\n    struct {\n        uint8_t a: 1;\n        uint8_t b: 3;\n        uint8_t c: 2;\n        uint8_t d: 2;\n    };\n\n};\n\nint main(int argc, const char * argv[]) {\n    Test test;\n    test.a = 1;\n    test.b = 0;\n    test.c = 0;\n    test.d = 0b11;\n\n    std::cout << test.ch << std::endl;\n    return 0;\n}\n```\n\nåœ¨ macOS ä¸Šæ–­ç‚¹æŸ¥çœ‹å†…å­˜å¦‚ä¸‹\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16863024030361686302402947.png)\n\n\n# ç»“è®ºï¼š\n\nå¯ä»¥çœ‹åˆ°ï¼Œå®šä¹‰åœ¨å‰çš„ä½åŸŸï¼Œåœ¨å­—èŠ‚çš„ä½ä½ã€‚\nä½åŸŸåœ¨å†…å­˜ä¸­å­˜å‚¨çš„é¡ºåºåˆšå¥½ä¸å®šä¹‰çš„å…ˆåç›¸åã€‚\n\n\n\n\n","slug":"c++/2023-06-09-ä½åŸŸ é«˜ä½ä½","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkn001657whe0q069hb","content":"<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;iostream&gt;</span></span><br><br><span class=\"hljs-keyword\">union</span> <span class=\"hljs-title class_\">Test</span> &#123;<br>    <span class=\"hljs-type\">unsigned</span> <span class=\"hljs-type\">char</span> ch;<br>    <span class=\"hljs-keyword\">struct</span> &#123;<br>        <span class=\"hljs-type\">uint8_t</span> a: <span class=\"hljs-number\">1</span>;<br>        <span class=\"hljs-type\">uint8_t</span> b: <span class=\"hljs-number\">3</span>;<br>        <span class=\"hljs-type\">uint8_t</span> c: <span class=\"hljs-number\">2</span>;<br>        <span class=\"hljs-type\">uint8_t</span> d: <span class=\"hljs-number\">2</span>;<br>    &#125;;<br><br>&#125;;<br><br><span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> * argv[])</span> </span>&#123;<br>    Test test;<br>    test.a = <span class=\"hljs-number\">1</span>;<br>    test.b = <span class=\"hljs-number\">0</span>;<br>    test.c = <span class=\"hljs-number\">0</span>;<br>    test.d = <span class=\"hljs-number\">0b11</span>;<br><br>    std::cout &lt;&lt; test.ch &lt;&lt; std::endl;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åœ¨ macOS ä¸Šæ–­ç‚¹æŸ¥çœ‹å†…å­˜å¦‚ä¸‹</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16863024030361686302402947.png\"></p>\n<h1 id=\"ç»“è®ºï¼š\"><a href=\"#ç»“è®ºï¼š\" class=\"headerlink\" title=\"ç»“è®ºï¼š\"></a>ç»“è®ºï¼š</h1><p>å¯ä»¥çœ‹åˆ°ï¼Œå®šä¹‰åœ¨å‰çš„ä½åŸŸï¼Œåœ¨å­—èŠ‚çš„ä½ä½ã€‚<br>ä½åŸŸåœ¨å†…å­˜ä¸­å­˜å‚¨çš„é¡ºåºåˆšå¥½ä¸å®šä¹‰çš„å…ˆåç›¸åã€‚</p>\n","excerpt":"","more":"<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;iostream&gt;</span></span><br><br><span class=\"hljs-keyword\">union</span> <span class=\"hljs-title class_\">Test</span> &#123;<br>    <span class=\"hljs-type\">unsigned</span> <span class=\"hljs-type\">char</span> ch;<br>    <span class=\"hljs-keyword\">struct</span> &#123;<br>        <span class=\"hljs-type\">uint8_t</span> a: <span class=\"hljs-number\">1</span>;<br>        <span class=\"hljs-type\">uint8_t</span> b: <span class=\"hljs-number\">3</span>;<br>        <span class=\"hljs-type\">uint8_t</span> c: <span class=\"hljs-number\">2</span>;<br>        <span class=\"hljs-type\">uint8_t</span> d: <span class=\"hljs-number\">2</span>;<br>    &#125;;<br><br>&#125;;<br><br><span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> * argv[])</span> </span>&#123;<br>    Test test;<br>    test.a = <span class=\"hljs-number\">1</span>;<br>    test.b = <span class=\"hljs-number\">0</span>;<br>    test.c = <span class=\"hljs-number\">0</span>;<br>    test.d = <span class=\"hljs-number\">0b11</span>;<br><br>    std::cout &lt;&lt; test.ch &lt;&lt; std::endl;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åœ¨ macOS ä¸Šæ–­ç‚¹æŸ¥çœ‹å†…å­˜å¦‚ä¸‹</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16863024030361686302402947.png\"></p>\n<h1 id=\"ç»“è®ºï¼š\"><a href=\"#ç»“è®ºï¼š\" class=\"headerlink\" title=\"ç»“è®ºï¼š\"></a>ç»“è®ºï¼š</h1><p>å¯ä»¥çœ‹åˆ°ï¼Œå®šä¹‰åœ¨å‰çš„ä½åŸŸï¼Œåœ¨å­—èŠ‚çš„ä½ä½ã€‚<br>ä½åŸŸåœ¨å†…å­˜ä¸­å­˜å‚¨çš„é¡ºåºåˆšå¥½ä¸å®šä¹‰çš„å…ˆåç›¸åã€‚</p>\n"},{"layout":"post","title":"cmake find_package","date":"2022-03-12T16:00:00.000Z","_content":"\nå‚è€ƒï¼š\n\n- å®˜æ–¹æ–‡æ¡£  [find_package](https://cmake.org/cmake/help/latest/command/find_package.html#id3)\n\n- [Cmakeä¹‹æ·±å…¥ç†è§£find_package()çš„ç”¨æ³•](https://zhuanlan.zhihu.com/p/97369704)\n\n## ä½¿ç”¨\n\né€šè¿‡find_packageå‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°ä¸‰æ–¹åº“å¯¹åº”çš„å¤´æ–‡ä»¶è·¯å¾„å’Œåº“æ–‡ä»¶è·¯å¾„ï¼Œä¸ç”¨æ‰‹åŠ¨ç®¡ç†è¿™äº›è·¯å¾„äº†ã€‚ä¾‹å¦‚è¦å¼•ç”¨CURLåº“ï¼Œåœ¨CMakeListsæ–‡ä»¶å¯ä»¥ç®€å•å†™æˆä¸‹é¢çš„å½¢å¼\n\n```cmake\nfind_package(CURL)\nadd_executable(curltest curltest.cc)\nif(CURL_FOUND)\n    target_include_directories(clib PRIVATE ${CURL_INCLUDE_DIR})\n    target_link_libraries(curltest ${CURL_LIBRARY})\nelse(CURL_FOUND)\n    message(FATAL_ERROR â€CURL library not foundâ€)\nendif(CURL_FOUND)\n```\n\n## åŸç†\n\nfind_package æœ‰ä¸¤ç§æœç´¢æ¨¡å¼\n\n### Module mode\n\nåœ¨[`CMAKE_MODULE_PATH`](https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html#variable:CMAKE_MODULE_PATH \"CMAKE_MODULE_PATH\")æŒ‡å®šçš„è·¯å¾„ä¸‹æœç´¢åä¸º`Find<PackageName>.cmake`çš„æ–‡ä»¶\n\nè¯¥æ–‡ä»¶æä¾›äº†åº“å¯¹åº”çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶è·¯å¾„ã€‚\n\n### Config mode\n\n- æœç´¢`<lowercasePackageName>-config.cmake`æˆ–è€…`<PackageName>Config.cmake`\n\n- æœç´¢`<lowercasePackageName>-config-version.cmake`æˆ–è€…`<PackageName>ConfigVersion.cmake`\n\nå¦‚æœæ‰¾åˆ°\n\n- `<PackageName>_FOUND` ä¸ºtrue\n\n- `<PackageName>_INCLUDE_DIR` ä¼šè¢«è®¾ç½®\n\n- `<PackageName>_LIBRARY` ä¼šè¢«è®¾ç½®\n\næ‰¾ä¸åˆ°\n\n- `<PackageName>_FOUND` ä¸ºfalse\n\n## å¦‚ä½•å†™`Find<PackageName>.cmake`\n\n[wasmint/FindSDL2.cmake at master Â· WebAssembly/wasmint Â· GitHub](https://github.com/WebAssembly/wasmint/blob/master/cmake/FindSDL2.cmake)\n\n1. è°ƒç”¨[find_path](https://cmake.org/cmake/help/latest/command/find_path.html)æ‰¾å¤´æ–‡ä»¶è·¯å¾„\n\n2. è°ƒç”¨[find_library](https://cmake.org/cmake/help/latest/command/find_library.html)æ‰¾åº“çš„è·¯å¾„\n\n3. é€šè¿‡[FindPackageHandleStandardArgs](https://cmake.org/cmake/help/latest/module/FindPackageHandleStandardArgs.html)å¯¼å‡ºå˜é‡\n\né€šè¿‡CMAKE_MODULE_PATHæŒ‡å®šè·¯å¾„ï¼Œå°±å¯ä»¥é€šè¿‡find_packageå‘½ä»¤ä½¿ç”¨è¯¥ä¸‰æ–¹åº“çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶äº†ã€‚\n","source":"_posts/cmake/2022-03-13-cmake find_package.md","raw":"---\nlayout: post\ntitle: \"cmake find_package\"\ndate: 2022-03-13\ntag: cmake\n\n---\n\nå‚è€ƒï¼š\n\n- å®˜æ–¹æ–‡æ¡£  [find_package](https://cmake.org/cmake/help/latest/command/find_package.html#id3)\n\n- [Cmakeä¹‹æ·±å…¥ç†è§£find_package()çš„ç”¨æ³•](https://zhuanlan.zhihu.com/p/97369704)\n\n## ä½¿ç”¨\n\né€šè¿‡find_packageå‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°ä¸‰æ–¹åº“å¯¹åº”çš„å¤´æ–‡ä»¶è·¯å¾„å’Œåº“æ–‡ä»¶è·¯å¾„ï¼Œä¸ç”¨æ‰‹åŠ¨ç®¡ç†è¿™äº›è·¯å¾„äº†ã€‚ä¾‹å¦‚è¦å¼•ç”¨CURLåº“ï¼Œåœ¨CMakeListsæ–‡ä»¶å¯ä»¥ç®€å•å†™æˆä¸‹é¢çš„å½¢å¼\n\n```cmake\nfind_package(CURL)\nadd_executable(curltest curltest.cc)\nif(CURL_FOUND)\n    target_include_directories(clib PRIVATE ${CURL_INCLUDE_DIR})\n    target_link_libraries(curltest ${CURL_LIBRARY})\nelse(CURL_FOUND)\n    message(FATAL_ERROR â€CURL library not foundâ€)\nendif(CURL_FOUND)\n```\n\n## åŸç†\n\nfind_package æœ‰ä¸¤ç§æœç´¢æ¨¡å¼\n\n### Module mode\n\nåœ¨[`CMAKE_MODULE_PATH`](https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html#variable:CMAKE_MODULE_PATH \"CMAKE_MODULE_PATH\")æŒ‡å®šçš„è·¯å¾„ä¸‹æœç´¢åä¸º`Find<PackageName>.cmake`çš„æ–‡ä»¶\n\nè¯¥æ–‡ä»¶æä¾›äº†åº“å¯¹åº”çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶è·¯å¾„ã€‚\n\n### Config mode\n\n- æœç´¢`<lowercasePackageName>-config.cmake`æˆ–è€…`<PackageName>Config.cmake`\n\n- æœç´¢`<lowercasePackageName>-config-version.cmake`æˆ–è€…`<PackageName>ConfigVersion.cmake`\n\nå¦‚æœæ‰¾åˆ°\n\n- `<PackageName>_FOUND` ä¸ºtrue\n\n- `<PackageName>_INCLUDE_DIR` ä¼šè¢«è®¾ç½®\n\n- `<PackageName>_LIBRARY` ä¼šè¢«è®¾ç½®\n\næ‰¾ä¸åˆ°\n\n- `<PackageName>_FOUND` ä¸ºfalse\n\n## å¦‚ä½•å†™`Find<PackageName>.cmake`\n\n[wasmint/FindSDL2.cmake at master Â· WebAssembly/wasmint Â· GitHub](https://github.com/WebAssembly/wasmint/blob/master/cmake/FindSDL2.cmake)\n\n1. è°ƒç”¨[find_path](https://cmake.org/cmake/help/latest/command/find_path.html)æ‰¾å¤´æ–‡ä»¶è·¯å¾„\n\n2. è°ƒç”¨[find_library](https://cmake.org/cmake/help/latest/command/find_library.html)æ‰¾åº“çš„è·¯å¾„\n\n3. é€šè¿‡[FindPackageHandleStandardArgs](https://cmake.org/cmake/help/latest/module/FindPackageHandleStandardArgs.html)å¯¼å‡ºå˜é‡\n\né€šè¿‡CMAKE_MODULE_PATHæŒ‡å®šè·¯å¾„ï¼Œå°±å¯ä»¥é€šè¿‡find_packageå‘½ä»¤ä½¿ç”¨è¯¥ä¸‰æ–¹åº“çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶äº†ã€‚\n","slug":"cmake/2022-03-13-cmake find_package","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkn001757wh5g4bembt","content":"<p>å‚è€ƒï¼š</p>\n<ul>\n<li><p>å®˜æ–¹æ–‡æ¡£  <a href=\"https://cmake.org/cmake/help/latest/command/find_package.html#id3\">find_package</a></p>\n</li>\n<li><p><a href=\"https://zhuanlan.zhihu.com/p/97369704\">Cmakeä¹‹æ·±å…¥ç†è§£find_package()çš„ç”¨æ³•</a></p>\n</li>\n</ul>\n<h2 id=\"ä½¿ç”¨\"><a href=\"#ä½¿ç”¨\" class=\"headerlink\" title=\"ä½¿ç”¨\"></a>ä½¿ç”¨</h2><p>é€šè¿‡find_packageå‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°ä¸‰æ–¹åº“å¯¹åº”çš„å¤´æ–‡ä»¶è·¯å¾„å’Œåº“æ–‡ä»¶è·¯å¾„ï¼Œä¸ç”¨æ‰‹åŠ¨ç®¡ç†è¿™äº›è·¯å¾„äº†ã€‚ä¾‹å¦‚è¦å¼•ç”¨CURLåº“ï¼Œåœ¨CMakeListsæ–‡ä»¶å¯ä»¥ç®€å•å†™æˆä¸‹é¢çš„å½¢å¼</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cmake\"><span class=\"hljs-keyword\">find_package</span>(CURL)<br><span class=\"hljs-keyword\">add_executable</span>(curltest curltest.cc)<br><span class=\"hljs-keyword\">if</span>(CURL_FOUND)<br>    <span class=\"hljs-keyword\">target_include_directories</span>(clib PRIVATE <span class=\"hljs-variable\">$&#123;CURL_INCLUDE_DIR&#125;</span>)<br>    <span class=\"hljs-keyword\">target_link_libraries</span>(curltest <span class=\"hljs-variable\">$&#123;CURL_LIBRARY&#125;</span>)<br><span class=\"hljs-keyword\">else</span>(CURL_FOUND)<br>    <span class=\"hljs-keyword\">message</span>(FATAL_ERROR â€CURL library <span class=\"hljs-keyword\">not</span> foundâ€)<br><span class=\"hljs-keyword\">endif</span>(CURL_FOUND)<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"åŸç†\"><a href=\"#åŸç†\" class=\"headerlink\" title=\"åŸç†\"></a>åŸç†</h2><p>find_package æœ‰ä¸¤ç§æœç´¢æ¨¡å¼</p>\n<h3 id=\"Module-mode\"><a href=\"#Module-mode\" class=\"headerlink\" title=\"Module mode\"></a>Module mode</h3><p>åœ¨<a href=\"https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html#variable:CMAKE_MODULE_PATH\" title=\"CMAKE_MODULE_PATH\"><code>CMAKE_MODULE_PATH</code></a>æŒ‡å®šçš„è·¯å¾„ä¸‹æœç´¢åä¸º<code>Find&lt;PackageName&gt;.cmake</code>çš„æ–‡ä»¶</p>\n<p>è¯¥æ–‡ä»¶æä¾›äº†åº“å¯¹åº”çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶è·¯å¾„ã€‚</p>\n<h3 id=\"Config-mode\"><a href=\"#Config-mode\" class=\"headerlink\" title=\"Config mode\"></a>Config mode</h3><ul>\n<li><p>æœç´¢<code>&lt;lowercasePackageName&gt;-config.cmake</code>æˆ–è€…<code>&lt;PackageName&gt;Config.cmake</code></p>\n</li>\n<li><p>æœç´¢<code>&lt;lowercasePackageName&gt;-config-version.cmake</code>æˆ–è€…<code>&lt;PackageName&gt;ConfigVersion.cmake</code></p>\n</li>\n</ul>\n<p>å¦‚æœæ‰¾åˆ°</p>\n<ul>\n<li><p><code>&lt;PackageName&gt;_FOUND</code> ä¸ºtrue</p>\n</li>\n<li><p><code>&lt;PackageName&gt;_INCLUDE_DIR</code> ä¼šè¢«è®¾ç½®</p>\n</li>\n<li><p><code>&lt;PackageName&gt;_LIBRARY</code> ä¼šè¢«è®¾ç½®</p>\n</li>\n</ul>\n<p>æ‰¾ä¸åˆ°</p>\n<ul>\n<li><code>&lt;PackageName&gt;_FOUND</code> ä¸ºfalse</li>\n</ul>\n<h2 id=\"å¦‚ä½•å†™Find-cmake\"><a href=\"#å¦‚ä½•å†™Find-cmake\" class=\"headerlink\" title=\"å¦‚ä½•å†™Find&lt;PackageName&gt;.cmake\"></a>å¦‚ä½•å†™<code>Find&lt;PackageName&gt;.cmake</code></h2><p><a href=\"https://github.com/WebAssembly/wasmint/blob/master/cmake/FindSDL2.cmake\">wasmint&#x2F;FindSDL2.cmake at master Â· WebAssembly&#x2F;wasmint Â· GitHub</a></p>\n<ol>\n<li><p>è°ƒç”¨<a href=\"https://cmake.org/cmake/help/latest/command/find_path.html\">find_path</a>æ‰¾å¤´æ–‡ä»¶è·¯å¾„</p>\n</li>\n<li><p>è°ƒç”¨<a href=\"https://cmake.org/cmake/help/latest/command/find_library.html\">find_library</a>æ‰¾åº“çš„è·¯å¾„</p>\n</li>\n<li><p>é€šè¿‡<a href=\"https://cmake.org/cmake/help/latest/module/FindPackageHandleStandardArgs.html\">FindPackageHandleStandardArgs</a>å¯¼å‡ºå˜é‡</p>\n</li>\n</ol>\n<p>é€šè¿‡CMAKE_MODULE_PATHæŒ‡å®šè·¯å¾„ï¼Œå°±å¯ä»¥é€šè¿‡find_packageå‘½ä»¤ä½¿ç”¨è¯¥ä¸‰æ–¹åº“çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶äº†ã€‚</p>\n","excerpt":"","more":"<p>å‚è€ƒï¼š</p>\n<ul>\n<li><p>å®˜æ–¹æ–‡æ¡£  <a href=\"https://cmake.org/cmake/help/latest/command/find_package.html#id3\">find_package</a></p>\n</li>\n<li><p><a href=\"https://zhuanlan.zhihu.com/p/97369704\">Cmakeä¹‹æ·±å…¥ç†è§£find_package()çš„ç”¨æ³•</a></p>\n</li>\n</ul>\n<h2 id=\"ä½¿ç”¨\"><a href=\"#ä½¿ç”¨\" class=\"headerlink\" title=\"ä½¿ç”¨\"></a>ä½¿ç”¨</h2><p>é€šè¿‡find_packageå‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°ä¸‰æ–¹åº“å¯¹åº”çš„å¤´æ–‡ä»¶è·¯å¾„å’Œåº“æ–‡ä»¶è·¯å¾„ï¼Œä¸ç”¨æ‰‹åŠ¨ç®¡ç†è¿™äº›è·¯å¾„äº†ã€‚ä¾‹å¦‚è¦å¼•ç”¨CURLåº“ï¼Œåœ¨CMakeListsæ–‡ä»¶å¯ä»¥ç®€å•å†™æˆä¸‹é¢çš„å½¢å¼</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cmake\"><span class=\"hljs-keyword\">find_package</span>(CURL)<br><span class=\"hljs-keyword\">add_executable</span>(curltest curltest.cc)<br><span class=\"hljs-keyword\">if</span>(CURL_FOUND)<br>    <span class=\"hljs-keyword\">target_include_directories</span>(clib PRIVATE <span class=\"hljs-variable\">$&#123;CURL_INCLUDE_DIR&#125;</span>)<br>    <span class=\"hljs-keyword\">target_link_libraries</span>(curltest <span class=\"hljs-variable\">$&#123;CURL_LIBRARY&#125;</span>)<br><span class=\"hljs-keyword\">else</span>(CURL_FOUND)<br>    <span class=\"hljs-keyword\">message</span>(FATAL_ERROR â€CURL library <span class=\"hljs-keyword\">not</span> foundâ€)<br><span class=\"hljs-keyword\">endif</span>(CURL_FOUND)<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"åŸç†\"><a href=\"#åŸç†\" class=\"headerlink\" title=\"åŸç†\"></a>åŸç†</h2><p>find_package æœ‰ä¸¤ç§æœç´¢æ¨¡å¼</p>\n<h3 id=\"Module-mode\"><a href=\"#Module-mode\" class=\"headerlink\" title=\"Module mode\"></a>Module mode</h3><p>åœ¨<a href=\"https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html#variable:CMAKE_MODULE_PATH\" title=\"CMAKE_MODULE_PATH\"><code>CMAKE_MODULE_PATH</code></a>æŒ‡å®šçš„è·¯å¾„ä¸‹æœç´¢åä¸º<code>Find&lt;PackageName&gt;.cmake</code>çš„æ–‡ä»¶</p>\n<p>è¯¥æ–‡ä»¶æä¾›äº†åº“å¯¹åº”çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶è·¯å¾„ã€‚</p>\n<h3 id=\"Config-mode\"><a href=\"#Config-mode\" class=\"headerlink\" title=\"Config mode\"></a>Config mode</h3><ul>\n<li><p>æœç´¢<code>&lt;lowercasePackageName&gt;-config.cmake</code>æˆ–è€…<code>&lt;PackageName&gt;Config.cmake</code></p>\n</li>\n<li><p>æœç´¢<code>&lt;lowercasePackageName&gt;-config-version.cmake</code>æˆ–è€…<code>&lt;PackageName&gt;ConfigVersion.cmake</code></p>\n</li>\n</ul>\n<p>å¦‚æœæ‰¾åˆ°</p>\n<ul>\n<li><p><code>&lt;PackageName&gt;_FOUND</code> ä¸ºtrue</p>\n</li>\n<li><p><code>&lt;PackageName&gt;_INCLUDE_DIR</code> ä¼šè¢«è®¾ç½®</p>\n</li>\n<li><p><code>&lt;PackageName&gt;_LIBRARY</code> ä¼šè¢«è®¾ç½®</p>\n</li>\n</ul>\n<p>æ‰¾ä¸åˆ°</p>\n<ul>\n<li><code>&lt;PackageName&gt;_FOUND</code> ä¸ºfalse</li>\n</ul>\n<h2 id=\"å¦‚ä½•å†™Find-cmake\"><a href=\"#å¦‚ä½•å†™Find-cmake\" class=\"headerlink\" title=\"å¦‚ä½•å†™Find&lt;PackageName&gt;.cmake\"></a>å¦‚ä½•å†™<code>Find&lt;PackageName&gt;.cmake</code></h2><p><a href=\"https://github.com/WebAssembly/wasmint/blob/master/cmake/FindSDL2.cmake\">wasmint&#x2F;FindSDL2.cmake at master Â· WebAssembly&#x2F;wasmint Â· GitHub</a></p>\n<ol>\n<li><p>è°ƒç”¨<a href=\"https://cmake.org/cmake/help/latest/command/find_path.html\">find_path</a>æ‰¾å¤´æ–‡ä»¶è·¯å¾„</p>\n</li>\n<li><p>è°ƒç”¨<a href=\"https://cmake.org/cmake/help/latest/command/find_library.html\">find_library</a>æ‰¾åº“çš„è·¯å¾„</p>\n</li>\n<li><p>é€šè¿‡<a href=\"https://cmake.org/cmake/help/latest/module/FindPackageHandleStandardArgs.html\">FindPackageHandleStandardArgs</a>å¯¼å‡ºå˜é‡</p>\n</li>\n</ol>\n<p>é€šè¿‡CMAKE_MODULE_PATHæŒ‡å®šè·¯å¾„ï¼Œå°±å¯ä»¥é€šè¿‡find_packageå‘½ä»¤ä½¿ç”¨è¯¥ä¸‰æ–¹åº“çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶äº†ã€‚</p>\n"},{"layout":"post","title":"cmake è¯­è¨€åˆè¯†","date":"2022-03-16T16:00:00.000Z","_content":"\n# æ–‡ä»¶ç»„ç»‡\n\nCMakeæºæ–‡ä»¶ç”¨cmakeè¯­è¨€ç¼–å†™ï¼Œå…±ä¸‰ç§ç»„ç»‡å½¢å¼\n\n- [Directories](https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#directories)Â (`CMakeLists.txt`) ç›®å½•\n\n- [Scripts](https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#scripts)Â (`<script>.cmake`) è„šæœ¬\n\n- [Modules](https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#modules)Â (`<module>.cmake`) æ¨¡å—\n\n### DirectoriesÂ ç›®å½•\n\nç”¨cmake å»ç¼–è¯‘é¡¹ç›®æ—¶å€™ï¼Œå…¥å£æ˜¯é¡¹ç›®é¡¶çº§ç›®å½•çš„`CMakeLists.txt`æ–‡ä»¶ï¼Œ`CMakeLists.txt`æè¿°äº†å½“å‰é¡¹ç›®æ„å»ºè§„åˆ™ã€‚å½“é‡åˆ°`add _ subdirectory ()`å‘½ä»¤ï¼Œcmakeä¼šå»å‘½ä»¤æŒ‡å®šçš„å­ç›®å½•ä¸­æœç´¢`CMakeLists.txt`ï¼Œå°†å…¶æ·»åŠ åˆ°æ„å»ºè¿‡ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªé€’å½’è§£æçš„è¿‡ç¨‹ã€‚å­ç›®å½•ä¸­çš„`CMakeLists.txt`æè¿°äº†å­é¡¹ç›®çš„æ„å»ºè§„åˆ™ã€‚\n\n### ScriptsÂ è„šæœ¬\n\nä¸€ä¸ªå•ç‹¬çš„`<script>.cmake`æ–‡ä»¶å¯ä»¥è¢«å½“åšè„šæœ¬æ¥å¤„ç†ï¼Œå¯ä»¥ç†è§£ä¸ºshellè„šæœ¬ï¼Œé€šè¿‡cmakeæ¥è§£æå’Œæ‰§è¡Œè„šæœ¬å®šä¹‰çš„æ“ä½œã€‚è„šæœ¬ä¸­ä¸å…è®¸å‡ºç°å®šä¹‰æ„å»ºç›®æ ‡å’Œæ„å»ºè¡Œä¸ºçš„å‘½ä»¤ï¼Œ\n\ncmake è„šæœ¬ä¸å‚ä¸æ„å»ºè¿‡ç¨‹ã€‚\n\n```\ncmake [{-D <var>=<value>}...] -P <cmake-script-file> [-- <unparsed-options>...]\n```\n\n> Process the given cmake file as a script written in the CMake language. No configure or generate step is performed and the cache is not modified. If variables are defined usingÂ `-D`, this must be done before theÂ `-P`Â argument.\n\n> Any options afterÂ `--`Â are not parsed by CMake, but they are still included in the set ofÂ [`CMAKE_ARGV<n>`](https://cmake.org/cmake/help/latest/variable/CMAKE_ARGV0.html#variable:CMAKE_ARGV0 \"CMAKE_ARGV0\")Â variables passed to the script (including theÂ `--`Â itself).\n\n### Modules æ¨¡å—\n\nå°±æ˜¯ä¸€ä¸ªcmakeçš„æºæ–‡ä»¶ï¼Œå½¢å¼`<module>.cmake`ã€‚å¯ä»¥åœ¨å½“å‰`CMakeLists.txt`æˆ–cmakeæºæ–‡ä»¶ä¸­ï¼Œé€šè¿‡`include()`å‘½ä»¤ï¼Œå¼•å…¥å…¶ä»–cmakeæ–‡ä»¶ä¸­å®šä¹‰çš„å†…å®¹ã€‚ç±»ä¼¼äºcè¯­è¨€çš„\n\n`#include<>`ã€‚\n\ncmake å†…ç½®äº†å¾ˆå¤šçš„æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡[cmake-modules](https://cmake.org/cmake/help/latest/manual/cmake-modules.7.html#manual:cmake-modules(7))æŸ¥çœ‹ã€‚é¡¹ç›®å¯ä»¥å®šä¹‰è‡ªå·±cmake modulesï¼Œé€šè¿‡[CMAKE_MODULE_PATH](https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html#variable:CMAKE_MODULE_PATH)æ¥æŒ‡å®šä»–ä»¬çš„è·¯å¾„ã€‚\n\n# cmake å˜é‡\n\n1. cmake å˜é‡çš„å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹\n\n2. Set ()å’Œ unset ()å‘½ä»¤æ˜¾å¼åœ°è®¾ç½®æˆ–å–æ¶ˆè®¾ç½®å˜é‡\n\n3. å˜é‡åæ˜¯åŒºåˆ†å¤§å°å†™çš„,å»ºè®®åªä½¿ç”¨ç”±å­—æ¯æ•°å­—å­—ç¬¦åŠ ä¸Š `_ `å’Œ`-`ç»„æˆçš„åç§°\n\n4. æ ¹æ®ä½œç”¨äºèŒƒå›´, å˜é‡çš„ç±»å‹æœ‰normal, cache, or environment variable\n\n### å˜é‡ä½œç”¨èŒƒå›´\n\nå‚è€ƒè¿™ç¯‡æ–‡ç« [cmake cacheå˜é‡_åå¤ç ”ç©¶å¥½å‡ éï¼Œæˆ‘æ‰å‘ç°å…³äº CMake å˜é‡è¿˜å¯ä»¥è¿™æ ·ç†è§£ï¼_weixin_39732534çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/weixin_39732534/article/details/110658282) å¯ä»¥æ›´å¥½çš„ç†è§£cmake å˜é‡åŠå…¶ä½œç”¨åŸŸèŒƒå›´ã€‚\n\n#### å‡½æ•°ä½œç”¨åŸŸ\n\ncmake  é€šè¿‡ [`function()`](https://cmake.org/cmake/help/latest/command/function.html#command:function \"function\")å‘½ä»¤æ¥å®šä¹‰å‡½æ•°ã€‚åœ¨å‡½æ•°ä½œç”¨åŸŸé€šè¿‡`set`å®šä¹‰çš„å˜é‡ï¼Œåªåœ¨å‡½æ•°ä½œç”¨åŸŸå†…æœ‰æ•ˆï¼Œå‡½æ•°è¿”å›åï¼Œè¯¥å˜é‡å¤±æ•ˆã€‚\n\nä½†æ˜¯é€šè¿‡`set`å‘½ä»¤æŒ‡å®š `PARENT_SCOPE`,å¯ä»¥è®¾ç½®å‡½æ•°ä¸Šçº§ä½œç”¨åŸŸå†…çš„å˜é‡ã€‚\n\n#### CMake æ–‡ä»¶ä¸­\n\næ¯ä¸ªCMakeLists.txt å’Œ `xx.cmake`æ–‡ä»¶ä¸­éƒ½å®šä¹‰ä¸€ä¸ªä½œç”¨åŸŸã€‚ä¸Šçº§CMakeLists.txtæ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¼šä¼ é€’ç»™ä¸‹çº§çš„CMakeLists.txtæ–‡ä»¶ä¸­ã€‚\n\nä¸åœ¨å‡½æ•°ç”¨é€šè¿‡`set`å’Œ`unset`å‘½ä»¤è®¾ç½®çš„å˜é‡ï¼Œä½œç”¨èŒƒå›´åœ¨å½“å‰çš„æ–‡ä»¶ä¸­ã€‚\n\nä¿®æ”¹å½“å‰CMakeLists.txtæ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ï¼Œåœ¨ä¸Šçº§CMakeLists.txtæ–‡ä»¶ä¸­ä¸ç”Ÿæ•ˆï¼Œä½†æ˜¯é€šè¿‡`set`å‘½ä»¤æŒ‡å®š `PARENT_SCOPE`,å¯ä»¥ä¿®æ”¹ä¸Šçº§ä½œç”¨åŸŸå†…çš„å˜é‡ã€‚\n\n#### cache ä¸­\n\ncache å˜é‡å­˜è¢«ä¿å­˜åœ¨`CMakeCache.txt`æ–‡ä»¶ä¸­ã€‚å…¨å±€å˜é‡ï¼Œå¤šä¸ªæ„å»ºæ„å»ºä¸­æŒç»­ç”Ÿæ•ˆã€‚\n\nåªèƒ½é€šè¿‡setå‘½ä»¤ï¼ŒæŒ‡å®š`CACHE`é€‰é¡¹æ¥æ˜¾ç¤ºä¿®æ”¹ã€‚\n\n#### ç¯å¢ƒå˜é‡\n\nç±»ä¼¼äºæ™®é€šå˜é‡ï¼Œä½†æ˜¯ä½œç”¨èŒƒå›´æ˜¯å…¨å±€ï¼Œä¸ä¼šè¢«ç¼“å­˜ã€‚\n\nå˜é‡å¼•ç”¨çš„æ ¼å¼ä¸º $ENV { < Variable > }\n\nCMake ç¯å¢ƒå˜é‡çš„åˆå§‹å€¼æ˜¯è°ƒç”¨è¿›ç¨‹çš„åˆå§‹å€¼ã€‚å¯ä»¥ä½¿ç”¨ set ()å’Œ unset ()å‘½ä»¤æ›´æ”¹å€¼ã€‚è¿™äº›å‘½ä»¤åªå½±å“æ­£åœ¨è¿è¡Œçš„ CMake è¿›ç¨‹ï¼Œè€Œä¸å½±å“æ•´ä¸ªç³»ç»Ÿç¯å¢ƒã€‚æ›´æ”¹åçš„å€¼ä¸ä¼šå†™å›è°ƒç”¨è¿›ç¨‹ï¼Œåç»­çš„æ„å»ºæˆ–æµ‹è¯•è¿›ç¨‹ä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒä»¬ã€‚\n\n### å˜é‡æ±‚å€¼çš„é¡ºåºï¼š\n\n1. å½“å‰å‡½æ•°å†…æŸ¥æ‰¾\n\n2. å½“å‰æ–‡ä»¶ä¸­æŸ¥æ‰¾\n\n3. ç¼“å­˜ä¸­æŸ¥æ‰¾\n\n4. æœ€åæ²¡æ‰¾åˆ°ï¼Œè®¡ä¸ºç©ºå­—ç¬¦ä¸²ã€‚\n\n5. å¯ä»¥é€šè¿‡`$CACHE{VAR}`è·³è¿‡å‰é¢çš„è¿‡ç¨‹ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­æŸ¥æ‰¾ã€‚\n\n### set ç»™å˜é‡èµ‹å€¼\n\n#### normal å˜é‡\n\n```\nset(<variable> <value>... [PARENT_SCOPE])\n```\n\nå¦‚æœæŒ‡å®šäº†PARENT_SCOPEï¼Œä¿®æ”¹ä¼šåœ¨ä¸Šçº§ä½œç”¨åŸŸå†…ç”Ÿæ•ˆã€‚\n\n#### Set Cache Entry\n\n```\nset(<variable> <value>... CACHE <type> <docstring> [FORCE])\n```\n\nä¸åŠ FORCEï¼Œä¿®æ”¹ä¸ä¼šè¦†ç›–ä¹‹å‰cacheä¸­çš„å€¼ã€‚Â FORCE é€‰é¡¹è¦†ç›–ç°æœ‰æ¡ç›®ã€‚\n\ntypeçš„ç±»å‹å¿…é¡»æŒ‡å®šä¸ºä»¥ä¸‹ä¸€ç§ï¼š\n\n1. BOOL\n\n2. FILEPATH\n\n3. PATH\n\n4. STRING\n\n5. INTERNAL\n\n> ä¹Ÿå¯ä»¥é€šè¿‡cmakeå‘½ä»¤ï¼Œé€šè¿‡`-D<var>=<value>`æ·»åŠ ç¼“å­˜æ¡ç›®ã€‚\n\n#### ç¯å¢ƒå˜é‡\n\n```\nset(ENV{<variable>} [<value>])\n```\n\nè®¾ç½®ç»™å®šå€¼çš„ç¯å¢ƒå˜é‡ï¼Œ`$ENV{<variable>}`çš„åç»­è°ƒç”¨å°†è¿”å›è¿™ä¸ªæ–°å€¼ã€‚\n\næ­¤å‘½ä»¤åªå½±å“å½“å‰çš„ CMake è¿›ç¨‹ï¼Œè€Œä¸å½±å“è°ƒç”¨ CMake çš„è¿›ç¨‹ï¼Œä¹Ÿä¸å½±å“æ•´ä¸ªç³»ç»Ÿç¯å¢ƒï¼Œä¹Ÿä¸å½±å“åç»­æ„å»ºæˆ–æµ‹è¯•æµç¨‹çš„ç¯å¢ƒã€‚\n\nå¦‚æœåœ¨ `ENV { < variable > }`ä¹‹åæ²¡æœ‰ç»™å‡ºå‚æ•°ï¼Œæˆ–è€…å¦‚æœ `< value >` æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™ä¸ªå‘½ä»¤å°†æ¸…é™¤ä»»ä½•å·²å­˜åœ¨çš„ç¯å¢ƒå˜é‡\n\n## list å˜é‡\n\n> Note A list in cmake is aÂ `;`Â separated group of strings. To create a list the set command can be used. For example,Â `set(varÂ aÂ bÂ cÂ dÂ e)`Â creates a list withÂ `a;b;c;d;e`, andÂ `set(varÂ \"aÂ bÂ cÂ dÂ e\")`Â creates a string or a list with one item in it. (Note macro arguments are not variables, and therefore cannot be used in LIST commands.)\n\nåˆ—è¡¨ä¸åº”è¯¥ç”¨äºå¤æ‚çš„æ•°æ®å¤„ç†ä»»åŠ¡ï¼Œå¸¸å¸¸ç”¨æ¥ä¿å­˜æºæ–‡ä»¶åˆ—è¡¨ã€‚\n\nå¤§å¤šæ•°æ„é€ åˆ—è¡¨çš„å‘½ä»¤ä¸ä¼šè½¬ä¹‰; åˆ—è¡¨å…ƒç´ ä¸­çš„å­—ç¬¦ï¼Œå› æ­¤å°†åµŒå¥—åˆ—è¡¨å±•å¼€:\n\n```\nset(srcs a.c b.c c.c) # sets \"srcs\" to \"a.c;b.c;c.c\"\nset(x a \"b;c\") # sets \"x\" to \"a;b;c\", not \"a;b\\;c\"\nset(varÂ \"aÂ bÂ cÂ dÂ e\") # sets var to \"a b c d e\"\n```\n\n[list](https://cmake.org/cmake/help/latest/command/list.html)æ“ä½œï¼Œå°±æ˜¯ä¸€äº›å¢åˆ æŸ¥æ”¹\n\n```\nReading\n  list(LENGTH <list> <out-var>)\n  list(GET <list> <element index> [<index> ...] <out-var>)\n  list(JOIN <list> <glue> <out-var>)\n  list(SUBLIST <list> <begin> <length> <out-var>)\n\nSearch\n  list(FIND <list> <value> <out-var>)\n\nModification\n  list(APPEND <list> [<element>...])\n  list(FILTER <list> {INCLUDE | EXCLUDE} REGEX <regex>)\n  list(INSERT <list> <index> [<element>...])\n  list(POP_BACK <list> [<out-var>...])\n  list(POP_FRONT <list> [<out-var>...])\n  list(PREPEND <list> [<element>...])\n  list(REMOVE_ITEM <list> <value>...)\n  list(REMOVE_AT <list> <index>...)\n  list(REMOVE_DUPLICATES <list>)\n  list(TRANSFORM <list> <ACTION> [...])\n\nOrdering\n  list(REVERSE <list>)\n  list(SORT <list> [...])\n```\n\n# [file å‘½ä»¤](https://cmake.org/cmake/help/latest/command/file.html)\n\n```\nReading\n  file(READ <filename> <out-var> [...])\n  file(STRINGS <filename> <out-var> [...])\n  file(<HASH> <filename> <out-var>)\n  file(TIMESTAMP <filename> <out-var> [...])\n  file(GET_RUNTIME_DEPENDENCIES [...])\n\nWriting\n  file({WRITE | APPEND} <filename> <content>...)\n  file({TOUCH | TOUCH_NOCREATE} [<file>...])\n  file(GENERATE OUTPUT <output-file> [...])\n  file(CONFIGURE OUTPUT <output-file> CONTENT <content> [...])\n\nFilesystem\n  file({GLOB | GLOB_RECURSE} <out-var> [...] [<globbing-expr>...])\n  file(MAKE_DIRECTORY [<dir>...])\n  file({REMOVE | REMOVE_RECURSE } [<files>...])\n  file(RENAME <oldname> <newname> [...])\n  file(COPY_FILE <oldname> <newname> [...])\n  file({COPY | INSTALL} <file>... DESTINATION <dir> [...])\n  file(SIZE <filename> <out-var>)\n  file(READ_SYMLINK <linkname> <out-var>)\n  file(CREATE_LINK <original> <linkname> [...])\n  file(CHMOD <files>... <directories>... PERMISSIONS <permissions>... [...])\n  file(CHMOD_RECURSE <files>... <directories>... PERMISSIONS <permissions>... [...])\n\nPath Conversion\n  file(REAL_PATH <path> <out-var> [BASE_DIRECTORY <dir>] [EXPAND_TILDE])\n  file(RELATIVE_PATH <out-var> <directory> <file>)\n  file({TO_CMAKE_PATH | TO_NATIVE_PATH} <path> <out-var>)\n\nTransfer\n  file(DOWNLOAD <url> [<file>] [...])\n  file(UPLOAD <file> <url> [...])\n\nLocking\n  file(LOCK <path> [...])\n\nArchiving\n  file(ARCHIVE_CREATE OUTPUT <archive> PATHS <paths>... [...])\n  file(ARCHIVE_EXTRACT INPUT <archive> [...])\n```\n\n## Filesystem\n\n```\nfile(GLOB <variable>\n     [LIST_DIRECTORIES true|false] [RELATIVE <path>] [CONFIGURE_DEPENDS]\n     [<globbing-expressions>...])\nfile(GLOB_RECURSE <variable> [FOLLOW_SYMLINKS]\n     [LIST_DIRECTORIES true|false] [RELATIVE <path>] [CONFIGURE_DEPENDS]\n     [<globbing-expressions>...])\n```\n\n> Generate a list of files that match theÂ `<globbing-expressions>`Â and store it into theÂ `<variable>`. Globbing expressions are similar to regular expressions, but much simpler. IfÂ `RELATIVE`Â flag is specified, the results will be returned as relative paths to the given path.\n> \n> On Windows and macOS, globbing is case-insensitive even if the underlying filesystem is case-sensitive (both filenames and globbing expressions are converted to lowercase before matching). On other platforms, globbing is case-sensitive\n> \n> By defaultÂ `GLOB`Â lists directories - directories are omitted in result ifÂ `LIST_DIRECTORIES`Â is set to false.\n\nExamples of globbing expressions include:\n\n```\n*.cxx      - match all files with extension cxx\n*.vt?      - match all files with extension vta,...,vtz\nf[3-5].txt - match files f3.txt, f4.txt, f5.txt\n```\n\n> TheÂ `GLOB_RECURSE`Â mode will traverse all the subdirectories of the matched directory and match the files.\n\n# cmake æ‰§è¡Œshellå‘½ä»¤\n\né€šè¿‡ execute_process  å¯ä»¥æ‰§è¡Œè°ƒç”¨shell å‘½ä»¤\n\n```\nexecute_process(COMMAND <cmd1> [<arguments>]\n                [COMMAND <cmd2> [<arguments>]]...\n                [WORKING_DIRECTORY <directory>]\n                [TIMEOUT <seconds>]\n                [RESULT_VARIABLE <variable>]\n                [RESULTS_VARIABLE <variable>]\n                [OUTPUT_VARIABLE <variable>]\n                [ERROR_VARIABLE <variable>]\n                [INPUT_FILE <file>]\n                [OUTPUT_FILE <file>]\n                [ERROR_FILE <file>]\n                [OUTPUT_QUIET]\n                [ERROR_QUIET]\n                [COMMAND_ECHO <where>]\n                [OUTPUT_STRIP_TRAILING_WHITESPACE]\n                [ERROR_STRIP_TRAILING_WHITESPACE]\n                [ENCODING <name>]\n                [ECHO_OUTPUT_VARIABLE]\n                [ECHO_ERROR_VARIABLE]\n                [COMMAND_ERROR_IS_FATAL <ANY|LAST>])\n```\n","source":"_posts/cmake/2022-03-17-cmake å…¥é—¨.md","raw":"---\nlayout: post\ntitle: \"cmake è¯­è¨€åˆè¯†\"\ndate: 2022-03-17\ntag: cmake\n\n---\n\n# æ–‡ä»¶ç»„ç»‡\n\nCMakeæºæ–‡ä»¶ç”¨cmakeè¯­è¨€ç¼–å†™ï¼Œå…±ä¸‰ç§ç»„ç»‡å½¢å¼\n\n- [Directories](https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#directories)Â (`CMakeLists.txt`) ç›®å½•\n\n- [Scripts](https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#scripts)Â (`<script>.cmake`) è„šæœ¬\n\n- [Modules](https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#modules)Â (`<module>.cmake`) æ¨¡å—\n\n### DirectoriesÂ ç›®å½•\n\nç”¨cmake å»ç¼–è¯‘é¡¹ç›®æ—¶å€™ï¼Œå…¥å£æ˜¯é¡¹ç›®é¡¶çº§ç›®å½•çš„`CMakeLists.txt`æ–‡ä»¶ï¼Œ`CMakeLists.txt`æè¿°äº†å½“å‰é¡¹ç›®æ„å»ºè§„åˆ™ã€‚å½“é‡åˆ°`add _ subdirectory ()`å‘½ä»¤ï¼Œcmakeä¼šå»å‘½ä»¤æŒ‡å®šçš„å­ç›®å½•ä¸­æœç´¢`CMakeLists.txt`ï¼Œå°†å…¶æ·»åŠ åˆ°æ„å»ºè¿‡ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªé€’å½’è§£æçš„è¿‡ç¨‹ã€‚å­ç›®å½•ä¸­çš„`CMakeLists.txt`æè¿°äº†å­é¡¹ç›®çš„æ„å»ºè§„åˆ™ã€‚\n\n### ScriptsÂ è„šæœ¬\n\nä¸€ä¸ªå•ç‹¬çš„`<script>.cmake`æ–‡ä»¶å¯ä»¥è¢«å½“åšè„šæœ¬æ¥å¤„ç†ï¼Œå¯ä»¥ç†è§£ä¸ºshellè„šæœ¬ï¼Œé€šè¿‡cmakeæ¥è§£æå’Œæ‰§è¡Œè„šæœ¬å®šä¹‰çš„æ“ä½œã€‚è„šæœ¬ä¸­ä¸å…è®¸å‡ºç°å®šä¹‰æ„å»ºç›®æ ‡å’Œæ„å»ºè¡Œä¸ºçš„å‘½ä»¤ï¼Œ\n\ncmake è„šæœ¬ä¸å‚ä¸æ„å»ºè¿‡ç¨‹ã€‚\n\n```\ncmake [{-D <var>=<value>}...] -P <cmake-script-file> [-- <unparsed-options>...]\n```\n\n> Process the given cmake file as a script written in the CMake language. No configure or generate step is performed and the cache is not modified. If variables are defined usingÂ `-D`, this must be done before theÂ `-P`Â argument.\n\n> Any options afterÂ `--`Â are not parsed by CMake, but they are still included in the set ofÂ [`CMAKE_ARGV<n>`](https://cmake.org/cmake/help/latest/variable/CMAKE_ARGV0.html#variable:CMAKE_ARGV0 \"CMAKE_ARGV0\")Â variables passed to the script (including theÂ `--`Â itself).\n\n### Modules æ¨¡å—\n\nå°±æ˜¯ä¸€ä¸ªcmakeçš„æºæ–‡ä»¶ï¼Œå½¢å¼`<module>.cmake`ã€‚å¯ä»¥åœ¨å½“å‰`CMakeLists.txt`æˆ–cmakeæºæ–‡ä»¶ä¸­ï¼Œé€šè¿‡`include()`å‘½ä»¤ï¼Œå¼•å…¥å…¶ä»–cmakeæ–‡ä»¶ä¸­å®šä¹‰çš„å†…å®¹ã€‚ç±»ä¼¼äºcè¯­è¨€çš„\n\n`#include<>`ã€‚\n\ncmake å†…ç½®äº†å¾ˆå¤šçš„æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡[cmake-modules](https://cmake.org/cmake/help/latest/manual/cmake-modules.7.html#manual:cmake-modules(7))æŸ¥çœ‹ã€‚é¡¹ç›®å¯ä»¥å®šä¹‰è‡ªå·±cmake modulesï¼Œé€šè¿‡[CMAKE_MODULE_PATH](https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html#variable:CMAKE_MODULE_PATH)æ¥æŒ‡å®šä»–ä»¬çš„è·¯å¾„ã€‚\n\n# cmake å˜é‡\n\n1. cmake å˜é‡çš„å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹\n\n2. Set ()å’Œ unset ()å‘½ä»¤æ˜¾å¼åœ°è®¾ç½®æˆ–å–æ¶ˆè®¾ç½®å˜é‡\n\n3. å˜é‡åæ˜¯åŒºåˆ†å¤§å°å†™çš„,å»ºè®®åªä½¿ç”¨ç”±å­—æ¯æ•°å­—å­—ç¬¦åŠ ä¸Š `_ `å’Œ`-`ç»„æˆçš„åç§°\n\n4. æ ¹æ®ä½œç”¨äºèŒƒå›´, å˜é‡çš„ç±»å‹æœ‰normal, cache, or environment variable\n\n### å˜é‡ä½œç”¨èŒƒå›´\n\nå‚è€ƒè¿™ç¯‡æ–‡ç« [cmake cacheå˜é‡_åå¤ç ”ç©¶å¥½å‡ éï¼Œæˆ‘æ‰å‘ç°å…³äº CMake å˜é‡è¿˜å¯ä»¥è¿™æ ·ç†è§£ï¼_weixin_39732534çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/weixin_39732534/article/details/110658282) å¯ä»¥æ›´å¥½çš„ç†è§£cmake å˜é‡åŠå…¶ä½œç”¨åŸŸèŒƒå›´ã€‚\n\n#### å‡½æ•°ä½œç”¨åŸŸ\n\ncmake  é€šè¿‡ [`function()`](https://cmake.org/cmake/help/latest/command/function.html#command:function \"function\")å‘½ä»¤æ¥å®šä¹‰å‡½æ•°ã€‚åœ¨å‡½æ•°ä½œç”¨åŸŸé€šè¿‡`set`å®šä¹‰çš„å˜é‡ï¼Œåªåœ¨å‡½æ•°ä½œç”¨åŸŸå†…æœ‰æ•ˆï¼Œå‡½æ•°è¿”å›åï¼Œè¯¥å˜é‡å¤±æ•ˆã€‚\n\nä½†æ˜¯é€šè¿‡`set`å‘½ä»¤æŒ‡å®š `PARENT_SCOPE`,å¯ä»¥è®¾ç½®å‡½æ•°ä¸Šçº§ä½œç”¨åŸŸå†…çš„å˜é‡ã€‚\n\n#### CMake æ–‡ä»¶ä¸­\n\næ¯ä¸ªCMakeLists.txt å’Œ `xx.cmake`æ–‡ä»¶ä¸­éƒ½å®šä¹‰ä¸€ä¸ªä½œç”¨åŸŸã€‚ä¸Šçº§CMakeLists.txtæ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¼šä¼ é€’ç»™ä¸‹çº§çš„CMakeLists.txtæ–‡ä»¶ä¸­ã€‚\n\nä¸åœ¨å‡½æ•°ç”¨é€šè¿‡`set`å’Œ`unset`å‘½ä»¤è®¾ç½®çš„å˜é‡ï¼Œä½œç”¨èŒƒå›´åœ¨å½“å‰çš„æ–‡ä»¶ä¸­ã€‚\n\nä¿®æ”¹å½“å‰CMakeLists.txtæ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ï¼Œåœ¨ä¸Šçº§CMakeLists.txtæ–‡ä»¶ä¸­ä¸ç”Ÿæ•ˆï¼Œä½†æ˜¯é€šè¿‡`set`å‘½ä»¤æŒ‡å®š `PARENT_SCOPE`,å¯ä»¥ä¿®æ”¹ä¸Šçº§ä½œç”¨åŸŸå†…çš„å˜é‡ã€‚\n\n#### cache ä¸­\n\ncache å˜é‡å­˜è¢«ä¿å­˜åœ¨`CMakeCache.txt`æ–‡ä»¶ä¸­ã€‚å…¨å±€å˜é‡ï¼Œå¤šä¸ªæ„å»ºæ„å»ºä¸­æŒç»­ç”Ÿæ•ˆã€‚\n\nåªèƒ½é€šè¿‡setå‘½ä»¤ï¼ŒæŒ‡å®š`CACHE`é€‰é¡¹æ¥æ˜¾ç¤ºä¿®æ”¹ã€‚\n\n#### ç¯å¢ƒå˜é‡\n\nç±»ä¼¼äºæ™®é€šå˜é‡ï¼Œä½†æ˜¯ä½œç”¨èŒƒå›´æ˜¯å…¨å±€ï¼Œä¸ä¼šè¢«ç¼“å­˜ã€‚\n\nå˜é‡å¼•ç”¨çš„æ ¼å¼ä¸º $ENV { < Variable > }\n\nCMake ç¯å¢ƒå˜é‡çš„åˆå§‹å€¼æ˜¯è°ƒç”¨è¿›ç¨‹çš„åˆå§‹å€¼ã€‚å¯ä»¥ä½¿ç”¨ set ()å’Œ unset ()å‘½ä»¤æ›´æ”¹å€¼ã€‚è¿™äº›å‘½ä»¤åªå½±å“æ­£åœ¨è¿è¡Œçš„ CMake è¿›ç¨‹ï¼Œè€Œä¸å½±å“æ•´ä¸ªç³»ç»Ÿç¯å¢ƒã€‚æ›´æ”¹åçš„å€¼ä¸ä¼šå†™å›è°ƒç”¨è¿›ç¨‹ï¼Œåç»­çš„æ„å»ºæˆ–æµ‹è¯•è¿›ç¨‹ä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒä»¬ã€‚\n\n### å˜é‡æ±‚å€¼çš„é¡ºåºï¼š\n\n1. å½“å‰å‡½æ•°å†…æŸ¥æ‰¾\n\n2. å½“å‰æ–‡ä»¶ä¸­æŸ¥æ‰¾\n\n3. ç¼“å­˜ä¸­æŸ¥æ‰¾\n\n4. æœ€åæ²¡æ‰¾åˆ°ï¼Œè®¡ä¸ºç©ºå­—ç¬¦ä¸²ã€‚\n\n5. å¯ä»¥é€šè¿‡`$CACHE{VAR}`è·³è¿‡å‰é¢çš„è¿‡ç¨‹ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­æŸ¥æ‰¾ã€‚\n\n### set ç»™å˜é‡èµ‹å€¼\n\n#### normal å˜é‡\n\n```\nset(<variable> <value>... [PARENT_SCOPE])\n```\n\nå¦‚æœæŒ‡å®šäº†PARENT_SCOPEï¼Œä¿®æ”¹ä¼šåœ¨ä¸Šçº§ä½œç”¨åŸŸå†…ç”Ÿæ•ˆã€‚\n\n#### Set Cache Entry\n\n```\nset(<variable> <value>... CACHE <type> <docstring> [FORCE])\n```\n\nä¸åŠ FORCEï¼Œä¿®æ”¹ä¸ä¼šè¦†ç›–ä¹‹å‰cacheä¸­çš„å€¼ã€‚Â FORCE é€‰é¡¹è¦†ç›–ç°æœ‰æ¡ç›®ã€‚\n\ntypeçš„ç±»å‹å¿…é¡»æŒ‡å®šä¸ºä»¥ä¸‹ä¸€ç§ï¼š\n\n1. BOOL\n\n2. FILEPATH\n\n3. PATH\n\n4. STRING\n\n5. INTERNAL\n\n> ä¹Ÿå¯ä»¥é€šè¿‡cmakeå‘½ä»¤ï¼Œé€šè¿‡`-D<var>=<value>`æ·»åŠ ç¼“å­˜æ¡ç›®ã€‚\n\n#### ç¯å¢ƒå˜é‡\n\n```\nset(ENV{<variable>} [<value>])\n```\n\nè®¾ç½®ç»™å®šå€¼çš„ç¯å¢ƒå˜é‡ï¼Œ`$ENV{<variable>}`çš„åç»­è°ƒç”¨å°†è¿”å›è¿™ä¸ªæ–°å€¼ã€‚\n\næ­¤å‘½ä»¤åªå½±å“å½“å‰çš„ CMake è¿›ç¨‹ï¼Œè€Œä¸å½±å“è°ƒç”¨ CMake çš„è¿›ç¨‹ï¼Œä¹Ÿä¸å½±å“æ•´ä¸ªç³»ç»Ÿç¯å¢ƒï¼Œä¹Ÿä¸å½±å“åç»­æ„å»ºæˆ–æµ‹è¯•æµç¨‹çš„ç¯å¢ƒã€‚\n\nå¦‚æœåœ¨ `ENV { < variable > }`ä¹‹åæ²¡æœ‰ç»™å‡ºå‚æ•°ï¼Œæˆ–è€…å¦‚æœ `< value >` æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™ä¸ªå‘½ä»¤å°†æ¸…é™¤ä»»ä½•å·²å­˜åœ¨çš„ç¯å¢ƒå˜é‡\n\n## list å˜é‡\n\n> Note A list in cmake is aÂ `;`Â separated group of strings. To create a list the set command can be used. For example,Â `set(varÂ aÂ bÂ cÂ dÂ e)`Â creates a list withÂ `a;b;c;d;e`, andÂ `set(varÂ \"aÂ bÂ cÂ dÂ e\")`Â creates a string or a list with one item in it. (Note macro arguments are not variables, and therefore cannot be used in LIST commands.)\n\nåˆ—è¡¨ä¸åº”è¯¥ç”¨äºå¤æ‚çš„æ•°æ®å¤„ç†ä»»åŠ¡ï¼Œå¸¸å¸¸ç”¨æ¥ä¿å­˜æºæ–‡ä»¶åˆ—è¡¨ã€‚\n\nå¤§å¤šæ•°æ„é€ åˆ—è¡¨çš„å‘½ä»¤ä¸ä¼šè½¬ä¹‰; åˆ—è¡¨å…ƒç´ ä¸­çš„å­—ç¬¦ï¼Œå› æ­¤å°†åµŒå¥—åˆ—è¡¨å±•å¼€:\n\n```\nset(srcs a.c b.c c.c) # sets \"srcs\" to \"a.c;b.c;c.c\"\nset(x a \"b;c\") # sets \"x\" to \"a;b;c\", not \"a;b\\;c\"\nset(varÂ \"aÂ bÂ cÂ dÂ e\") # sets var to \"a b c d e\"\n```\n\n[list](https://cmake.org/cmake/help/latest/command/list.html)æ“ä½œï¼Œå°±æ˜¯ä¸€äº›å¢åˆ æŸ¥æ”¹\n\n```\nReading\n  list(LENGTH <list> <out-var>)\n  list(GET <list> <element index> [<index> ...] <out-var>)\n  list(JOIN <list> <glue> <out-var>)\n  list(SUBLIST <list> <begin> <length> <out-var>)\n\nSearch\n  list(FIND <list> <value> <out-var>)\n\nModification\n  list(APPEND <list> [<element>...])\n  list(FILTER <list> {INCLUDE | EXCLUDE} REGEX <regex>)\n  list(INSERT <list> <index> [<element>...])\n  list(POP_BACK <list> [<out-var>...])\n  list(POP_FRONT <list> [<out-var>...])\n  list(PREPEND <list> [<element>...])\n  list(REMOVE_ITEM <list> <value>...)\n  list(REMOVE_AT <list> <index>...)\n  list(REMOVE_DUPLICATES <list>)\n  list(TRANSFORM <list> <ACTION> [...])\n\nOrdering\n  list(REVERSE <list>)\n  list(SORT <list> [...])\n```\n\n# [file å‘½ä»¤](https://cmake.org/cmake/help/latest/command/file.html)\n\n```\nReading\n  file(READ <filename> <out-var> [...])\n  file(STRINGS <filename> <out-var> [...])\n  file(<HASH> <filename> <out-var>)\n  file(TIMESTAMP <filename> <out-var> [...])\n  file(GET_RUNTIME_DEPENDENCIES [...])\n\nWriting\n  file({WRITE | APPEND} <filename> <content>...)\n  file({TOUCH | TOUCH_NOCREATE} [<file>...])\n  file(GENERATE OUTPUT <output-file> [...])\n  file(CONFIGURE OUTPUT <output-file> CONTENT <content> [...])\n\nFilesystem\n  file({GLOB | GLOB_RECURSE} <out-var> [...] [<globbing-expr>...])\n  file(MAKE_DIRECTORY [<dir>...])\n  file({REMOVE | REMOVE_RECURSE } [<files>...])\n  file(RENAME <oldname> <newname> [...])\n  file(COPY_FILE <oldname> <newname> [...])\n  file({COPY | INSTALL} <file>... DESTINATION <dir> [...])\n  file(SIZE <filename> <out-var>)\n  file(READ_SYMLINK <linkname> <out-var>)\n  file(CREATE_LINK <original> <linkname> [...])\n  file(CHMOD <files>... <directories>... PERMISSIONS <permissions>... [...])\n  file(CHMOD_RECURSE <files>... <directories>... PERMISSIONS <permissions>... [...])\n\nPath Conversion\n  file(REAL_PATH <path> <out-var> [BASE_DIRECTORY <dir>] [EXPAND_TILDE])\n  file(RELATIVE_PATH <out-var> <directory> <file>)\n  file({TO_CMAKE_PATH | TO_NATIVE_PATH} <path> <out-var>)\n\nTransfer\n  file(DOWNLOAD <url> [<file>] [...])\n  file(UPLOAD <file> <url> [...])\n\nLocking\n  file(LOCK <path> [...])\n\nArchiving\n  file(ARCHIVE_CREATE OUTPUT <archive> PATHS <paths>... [...])\n  file(ARCHIVE_EXTRACT INPUT <archive> [...])\n```\n\n## Filesystem\n\n```\nfile(GLOB <variable>\n     [LIST_DIRECTORIES true|false] [RELATIVE <path>] [CONFIGURE_DEPENDS]\n     [<globbing-expressions>...])\nfile(GLOB_RECURSE <variable> [FOLLOW_SYMLINKS]\n     [LIST_DIRECTORIES true|false] [RELATIVE <path>] [CONFIGURE_DEPENDS]\n     [<globbing-expressions>...])\n```\n\n> Generate a list of files that match theÂ `<globbing-expressions>`Â and store it into theÂ `<variable>`. Globbing expressions are similar to regular expressions, but much simpler. IfÂ `RELATIVE`Â flag is specified, the results will be returned as relative paths to the given path.\n> \n> On Windows and macOS, globbing is case-insensitive even if the underlying filesystem is case-sensitive (both filenames and globbing expressions are converted to lowercase before matching). On other platforms, globbing is case-sensitive\n> \n> By defaultÂ `GLOB`Â lists directories - directories are omitted in result ifÂ `LIST_DIRECTORIES`Â is set to false.\n\nExamples of globbing expressions include:\n\n```\n*.cxx      - match all files with extension cxx\n*.vt?      - match all files with extension vta,...,vtz\nf[3-5].txt - match files f3.txt, f4.txt, f5.txt\n```\n\n> TheÂ `GLOB_RECURSE`Â mode will traverse all the subdirectories of the matched directory and match the files.\n\n# cmake æ‰§è¡Œshellå‘½ä»¤\n\né€šè¿‡ execute_process  å¯ä»¥æ‰§è¡Œè°ƒç”¨shell å‘½ä»¤\n\n```\nexecute_process(COMMAND <cmd1> [<arguments>]\n                [COMMAND <cmd2> [<arguments>]]...\n                [WORKING_DIRECTORY <directory>]\n                [TIMEOUT <seconds>]\n                [RESULT_VARIABLE <variable>]\n                [RESULTS_VARIABLE <variable>]\n                [OUTPUT_VARIABLE <variable>]\n                [ERROR_VARIABLE <variable>]\n                [INPUT_FILE <file>]\n                [OUTPUT_FILE <file>]\n                [ERROR_FILE <file>]\n                [OUTPUT_QUIET]\n                [ERROR_QUIET]\n                [COMMAND_ECHO <where>]\n                [OUTPUT_STRIP_TRAILING_WHITESPACE]\n                [ERROR_STRIP_TRAILING_WHITESPACE]\n                [ENCODING <name>]\n                [ECHO_OUTPUT_VARIABLE]\n                [ECHO_ERROR_VARIABLE]\n                [COMMAND_ERROR_IS_FATAL <ANY|LAST>])\n```\n","slug":"cmake/2022-03-17-cmake å…¥é—¨","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkn001a57wh5gmt7zg6","content":"<h1 id=\"æ–‡ä»¶ç»„ç»‡\"><a href=\"#æ–‡ä»¶ç»„ç»‡\" class=\"headerlink\" title=\"æ–‡ä»¶ç»„ç»‡\"></a>æ–‡ä»¶ç»„ç»‡</h1><p>CMakeæºæ–‡ä»¶ç”¨cmakeè¯­è¨€ç¼–å†™ï¼Œå…±ä¸‰ç§ç»„ç»‡å½¢å¼</p>\n<ul>\n<li><p><a href=\"https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#directories\">Directories</a>Â (<code>CMakeLists.txt</code>) ç›®å½•</p>\n</li>\n<li><p><a href=\"https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#scripts\">Scripts</a>Â (<code>&lt;script&gt;.cmake</code>) è„šæœ¬</p>\n</li>\n<li><p><a href=\"https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#modules\">Modules</a>Â (<code>&lt;module&gt;.cmake</code>) æ¨¡å—</p>\n</li>\n</ul>\n<h3 id=\"Directories-ç›®å½•\"><a href=\"#Directories-ç›®å½•\" class=\"headerlink\" title=\"DirectoriesÂ ç›®å½•\"></a>DirectoriesÂ ç›®å½•</h3><p>ç”¨cmake å»ç¼–è¯‘é¡¹ç›®æ—¶å€™ï¼Œå…¥å£æ˜¯é¡¹ç›®é¡¶çº§ç›®å½•çš„<code>CMakeLists.txt</code>æ–‡ä»¶ï¼Œ<code>CMakeLists.txt</code>æè¿°äº†å½“å‰é¡¹ç›®æ„å»ºè§„åˆ™ã€‚å½“é‡åˆ°<code>add _ subdirectory ()</code>å‘½ä»¤ï¼Œcmakeä¼šå»å‘½ä»¤æŒ‡å®šçš„å­ç›®å½•ä¸­æœç´¢<code>CMakeLists.txt</code>ï¼Œå°†å…¶æ·»åŠ åˆ°æ„å»ºè¿‡ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªé€’å½’è§£æçš„è¿‡ç¨‹ã€‚å­ç›®å½•ä¸­çš„<code>CMakeLists.txt</code>æè¿°äº†å­é¡¹ç›®çš„æ„å»ºè§„åˆ™ã€‚</p>\n<h3 id=\"Scripts-è„šæœ¬\"><a href=\"#Scripts-è„šæœ¬\" class=\"headerlink\" title=\"ScriptsÂ è„šæœ¬\"></a>ScriptsÂ è„šæœ¬</h3><p>ä¸€ä¸ªå•ç‹¬çš„<code>&lt;script&gt;.cmake</code>æ–‡ä»¶å¯ä»¥è¢«å½“åšè„šæœ¬æ¥å¤„ç†ï¼Œå¯ä»¥ç†è§£ä¸ºshellè„šæœ¬ï¼Œé€šè¿‡cmakeæ¥è§£æå’Œæ‰§è¡Œè„šæœ¬å®šä¹‰çš„æ“ä½œã€‚è„šæœ¬ä¸­ä¸å…è®¸å‡ºç°å®šä¹‰æ„å»ºç›®æ ‡å’Œæ„å»ºè¡Œä¸ºçš„å‘½ä»¤ï¼Œ</p>\n<p>cmake è„šæœ¬ä¸å‚ä¸æ„å»ºè¿‡ç¨‹ã€‚</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\">cmake [&#123;-D <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">var</span>&gt;</span>=<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">value</span>&gt;</span>&#125;...] -P <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">cmake-script-file</span>&gt;</span> [-- <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">unparsed-options</span>&gt;</span>...]<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Process the given cmake file as a script written in the CMake language. No configure or generate step is performed and the cache is not modified. If variables are defined usingÂ <code>-D</code>, this must be done before theÂ <code>-P</code>Â argument.</p>\n</blockquote>\n<blockquote>\n<p>Any options afterÂ <code>--</code>Â are not parsed by CMake, but they are still included in the set ofÂ <a href=\"https://cmake.org/cmake/help/latest/variable/CMAKE_ARGV0.html#variable:CMAKE_ARGV0\" title=\"CMAKE_ARGV0\"><code>CMAKE_ARGV&lt;n&gt;</code></a>Â variables passed to the script (including theÂ <code>--</code>Â itself).</p>\n</blockquote>\n<h3 id=\"Modules-æ¨¡å—\"><a href=\"#Modules-æ¨¡å—\" class=\"headerlink\" title=\"Modules æ¨¡å—\"></a>Modules æ¨¡å—</h3><p>å°±æ˜¯ä¸€ä¸ªcmakeçš„æºæ–‡ä»¶ï¼Œå½¢å¼<code>&lt;module&gt;.cmake</code>ã€‚å¯ä»¥åœ¨å½“å‰<code>CMakeLists.txt</code>æˆ–cmakeæºæ–‡ä»¶ä¸­ï¼Œé€šè¿‡<code>include()</code>å‘½ä»¤ï¼Œå¼•å…¥å…¶ä»–cmakeæ–‡ä»¶ä¸­å®šä¹‰çš„å†…å®¹ã€‚ç±»ä¼¼äºcè¯­è¨€çš„</p>\n<p><code>#include&lt;&gt;</code>ã€‚</p>\n<p>cmake å†…ç½®äº†å¾ˆå¤šçš„æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡<a href=\"https://cmake.org/cmake/help/latest/manual/cmake-modules.7.html#manual:cmake-modules(7)\">cmake-modules</a>æŸ¥çœ‹ã€‚é¡¹ç›®å¯ä»¥å®šä¹‰è‡ªå·±cmake modulesï¼Œé€šè¿‡<a href=\"https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html#variable:CMAKE_MODULE_PATH\">CMAKE_MODULE_PATH</a>æ¥æŒ‡å®šä»–ä»¬çš„è·¯å¾„ã€‚</p>\n<h1 id=\"cmake-å˜é‡\"><a href=\"#cmake-å˜é‡\" class=\"headerlink\" title=\"cmake å˜é‡\"></a>cmake å˜é‡</h1><ol>\n<li><p>cmake å˜é‡çš„å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹</p>\n</li>\n<li><p>Set ()å’Œ unset ()å‘½ä»¤æ˜¾å¼åœ°è®¾ç½®æˆ–å–æ¶ˆè®¾ç½®å˜é‡</p>\n</li>\n<li><p>å˜é‡åæ˜¯åŒºåˆ†å¤§å°å†™çš„,å»ºè®®åªä½¿ç”¨ç”±å­—æ¯æ•°å­—å­—ç¬¦åŠ ä¸Š <code>_ </code>å’Œ<code>-</code>ç»„æˆçš„åç§°</p>\n</li>\n<li><p>æ ¹æ®ä½œç”¨äºèŒƒå›´, å˜é‡çš„ç±»å‹æœ‰normal, cache, or environment variable</p>\n</li>\n</ol>\n<h3 id=\"å˜é‡ä½œç”¨èŒƒå›´\"><a href=\"#å˜é‡ä½œç”¨èŒƒå›´\" class=\"headerlink\" title=\"å˜é‡ä½œç”¨èŒƒå›´\"></a>å˜é‡ä½œç”¨èŒƒå›´</h3><p>å‚è€ƒè¿™ç¯‡æ–‡ç« <a href=\"https://blog.csdn.net/weixin_39732534/article/details/110658282\">cmake cacheå˜é‡_åå¤ç ”ç©¶å¥½å‡ éï¼Œæˆ‘æ‰å‘ç°å…³äº CMake å˜é‡è¿˜å¯ä»¥è¿™æ ·ç†è§£ï¼_weixin_39732534çš„åšå®¢-CSDNåšå®¢</a> å¯ä»¥æ›´å¥½çš„ç†è§£cmake å˜é‡åŠå…¶ä½œç”¨åŸŸèŒƒå›´ã€‚</p>\n<h4 id=\"å‡½æ•°ä½œç”¨åŸŸ\"><a href=\"#å‡½æ•°ä½œç”¨åŸŸ\" class=\"headerlink\" title=\"å‡½æ•°ä½œç”¨åŸŸ\"></a>å‡½æ•°ä½œç”¨åŸŸ</h4><p>cmake  é€šè¿‡ <a href=\"https://cmake.org/cmake/help/latest/command/function.html#command:function\" title=\"function\"><code>function()</code></a>å‘½ä»¤æ¥å®šä¹‰å‡½æ•°ã€‚åœ¨å‡½æ•°ä½œç”¨åŸŸé€šè¿‡<code>set</code>å®šä¹‰çš„å˜é‡ï¼Œåªåœ¨å‡½æ•°ä½œç”¨åŸŸå†…æœ‰æ•ˆï¼Œå‡½æ•°è¿”å›åï¼Œè¯¥å˜é‡å¤±æ•ˆã€‚</p>\n<p>ä½†æ˜¯é€šè¿‡<code>set</code>å‘½ä»¤æŒ‡å®š <code>PARENT_SCOPE</code>,å¯ä»¥è®¾ç½®å‡½æ•°ä¸Šçº§ä½œç”¨åŸŸå†…çš„å˜é‡ã€‚</p>\n<h4 id=\"CMake-æ–‡ä»¶ä¸­\"><a href=\"#CMake-æ–‡ä»¶ä¸­\" class=\"headerlink\" title=\"CMake æ–‡ä»¶ä¸­\"></a>CMake æ–‡ä»¶ä¸­</h4><p>æ¯ä¸ªCMakeLists.txt å’Œ <code>xx.cmake</code>æ–‡ä»¶ä¸­éƒ½å®šä¹‰ä¸€ä¸ªä½œç”¨åŸŸã€‚ä¸Šçº§CMakeLists.txtæ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¼šä¼ é€’ç»™ä¸‹çº§çš„CMakeLists.txtæ–‡ä»¶ä¸­ã€‚</p>\n<p>ä¸åœ¨å‡½æ•°ç”¨é€šè¿‡<code>set</code>å’Œ<code>unset</code>å‘½ä»¤è®¾ç½®çš„å˜é‡ï¼Œä½œç”¨èŒƒå›´åœ¨å½“å‰çš„æ–‡ä»¶ä¸­ã€‚</p>\n<p>ä¿®æ”¹å½“å‰CMakeLists.txtæ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ï¼Œåœ¨ä¸Šçº§CMakeLists.txtæ–‡ä»¶ä¸­ä¸ç”Ÿæ•ˆï¼Œä½†æ˜¯é€šè¿‡<code>set</code>å‘½ä»¤æŒ‡å®š <code>PARENT_SCOPE</code>,å¯ä»¥ä¿®æ”¹ä¸Šçº§ä½œç”¨åŸŸå†…çš„å˜é‡ã€‚</p>\n<h4 id=\"cache-ä¸­\"><a href=\"#cache-ä¸­\" class=\"headerlink\" title=\"cache ä¸­\"></a>cache ä¸­</h4><p>cache å˜é‡å­˜è¢«ä¿å­˜åœ¨<code>CMakeCache.txt</code>æ–‡ä»¶ä¸­ã€‚å…¨å±€å˜é‡ï¼Œå¤šä¸ªæ„å»ºæ„å»ºä¸­æŒç»­ç”Ÿæ•ˆã€‚</p>\n<p>åªèƒ½é€šè¿‡setå‘½ä»¤ï¼ŒæŒ‡å®š<code>CACHE</code>é€‰é¡¹æ¥æ˜¾ç¤ºä¿®æ”¹ã€‚</p>\n<h4 id=\"ç¯å¢ƒå˜é‡\"><a href=\"#ç¯å¢ƒå˜é‡\" class=\"headerlink\" title=\"ç¯å¢ƒå˜é‡\"></a>ç¯å¢ƒå˜é‡</h4><p>ç±»ä¼¼äºæ™®é€šå˜é‡ï¼Œä½†æ˜¯ä½œç”¨èŒƒå›´æ˜¯å…¨å±€ï¼Œä¸ä¼šè¢«ç¼“å­˜ã€‚</p>\n<p>å˜é‡å¼•ç”¨çš„æ ¼å¼ä¸º $ENV { &lt; Variable &gt; }</p>\n<p>CMake ç¯å¢ƒå˜é‡çš„åˆå§‹å€¼æ˜¯è°ƒç”¨è¿›ç¨‹çš„åˆå§‹å€¼ã€‚å¯ä»¥ä½¿ç”¨ set ()å’Œ unset ()å‘½ä»¤æ›´æ”¹å€¼ã€‚è¿™äº›å‘½ä»¤åªå½±å“æ­£åœ¨è¿è¡Œçš„ CMake è¿›ç¨‹ï¼Œè€Œä¸å½±å“æ•´ä¸ªç³»ç»Ÿç¯å¢ƒã€‚æ›´æ”¹åçš„å€¼ä¸ä¼šå†™å›è°ƒç”¨è¿›ç¨‹ï¼Œåç»­çš„æ„å»ºæˆ–æµ‹è¯•è¿›ç¨‹ä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒä»¬ã€‚</p>\n<h3 id=\"å˜é‡æ±‚å€¼çš„é¡ºåºï¼š\"><a href=\"#å˜é‡æ±‚å€¼çš„é¡ºåºï¼š\" class=\"headerlink\" title=\"å˜é‡æ±‚å€¼çš„é¡ºåºï¼š\"></a>å˜é‡æ±‚å€¼çš„é¡ºåºï¼š</h3><ol>\n<li><p>å½“å‰å‡½æ•°å†…æŸ¥æ‰¾</p>\n</li>\n<li><p>å½“å‰æ–‡ä»¶ä¸­æŸ¥æ‰¾</p>\n</li>\n<li><p>ç¼“å­˜ä¸­æŸ¥æ‰¾</p>\n</li>\n<li><p>æœ€åæ²¡æ‰¾åˆ°ï¼Œè®¡ä¸ºç©ºå­—ç¬¦ä¸²ã€‚</p>\n</li>\n<li><p>å¯ä»¥é€šè¿‡<code>$CACHE&#123;VAR&#125;</code>è·³è¿‡å‰é¢çš„è¿‡ç¨‹ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­æŸ¥æ‰¾ã€‚</p>\n</li>\n</ol>\n<h3 id=\"set-ç»™å˜é‡èµ‹å€¼\"><a href=\"#set-ç»™å˜é‡èµ‹å€¼\" class=\"headerlink\" title=\"set ç»™å˜é‡èµ‹å€¼\"></a>set ç»™å˜é‡èµ‹å€¼</h3><h4 id=\"normal-å˜é‡\"><a href=\"#normal-å˜é‡\" class=\"headerlink\" title=\"normal å˜é‡\"></a>normal å˜é‡</h4><figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\"><span class=\"hljs-built_in\">set</span>(&lt;<span class=\"hljs-built_in\">variable</span>&gt; &lt;value&gt;<span class=\"hljs-params\">...</span> <span class=\"hljs-meta\">[</span>PARENT_SCOPE<span class=\"hljs-meta\">]</span>)<br></code></pre></td></tr></table></figure>\n\n<p>å¦‚æœæŒ‡å®šäº†PARENT_SCOPEï¼Œä¿®æ”¹ä¼šåœ¨ä¸Šçº§ä½œç”¨åŸŸå†…ç”Ÿæ•ˆã€‚</p>\n<h4 id=\"Set-Cache-Entry\"><a href=\"#Set-Cache-Entry\" class=\"headerlink\" title=\"Set Cache Entry\"></a>Set Cache Entry</h4><figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\"><span class=\"hljs-built_in\">set</span>(&lt;<span class=\"hljs-built_in\">variable</span>&gt; &lt;value&gt;<span class=\"hljs-params\">...</span> <span class=\"hljs-keyword\">CACHE</span> &lt;<span class=\"hljs-keyword\">type</span>&gt; &lt;docstring&gt; <span class=\"hljs-meta\">[</span>FORCE<span class=\"hljs-meta\">]</span>)<br></code></pre></td></tr></table></figure>\n\n<p>ä¸åŠ FORCEï¼Œä¿®æ”¹ä¸ä¼šè¦†ç›–ä¹‹å‰cacheä¸­çš„å€¼ã€‚Â FORCE é€‰é¡¹è¦†ç›–ç°æœ‰æ¡ç›®ã€‚</p>\n<p>typeçš„ç±»å‹å¿…é¡»æŒ‡å®šä¸ºä»¥ä¸‹ä¸€ç§ï¼š</p>\n<ol>\n<li><p>BOOL</p>\n</li>\n<li><p>FILEPATH</p>\n</li>\n<li><p>PATH</p>\n</li>\n<li><p>STRING</p>\n</li>\n<li><p>INTERNAL</p>\n</li>\n</ol>\n<blockquote>\n<p>ä¹Ÿå¯ä»¥é€šè¿‡cmakeå‘½ä»¤ï¼Œé€šè¿‡<code>-D&lt;var&gt;=&lt;value&gt;</code>æ·»åŠ ç¼“å­˜æ¡ç›®ã€‚</p>\n</blockquote>\n<h4 id=\"ç¯å¢ƒå˜é‡-1\"><a href=\"#ç¯å¢ƒå˜é‡-1\" class=\"headerlink\" title=\"ç¯å¢ƒå˜é‡\"></a>ç¯å¢ƒå˜é‡</h4><figure class=\"highlight fsharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs fsharp\"><span class=\"hljs-built_in\">set</span>(ENV&#123;<span class=\"hljs-operator\">&lt;</span>variable<span class=\"hljs-operator\">&gt;</span>&#125; <span class=\"hljs-meta\">[&lt;value&gt;]</span>)<br></code></pre></td></tr></table></figure>\n\n<p>è®¾ç½®ç»™å®šå€¼çš„ç¯å¢ƒå˜é‡ï¼Œ<code>$ENV&#123;&lt;variable&gt;&#125;</code>çš„åç»­è°ƒç”¨å°†è¿”å›è¿™ä¸ªæ–°å€¼ã€‚</p>\n<p>æ­¤å‘½ä»¤åªå½±å“å½“å‰çš„ CMake è¿›ç¨‹ï¼Œè€Œä¸å½±å“è°ƒç”¨ CMake çš„è¿›ç¨‹ï¼Œä¹Ÿä¸å½±å“æ•´ä¸ªç³»ç»Ÿç¯å¢ƒï¼Œä¹Ÿä¸å½±å“åç»­æ„å»ºæˆ–æµ‹è¯•æµç¨‹çš„ç¯å¢ƒã€‚</p>\n<p>å¦‚æœåœ¨ <code>ENV &#123; &lt; variable &gt; &#125;</code>ä¹‹åæ²¡æœ‰ç»™å‡ºå‚æ•°ï¼Œæˆ–è€…å¦‚æœ <code>&lt; value &gt;</code> æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™ä¸ªå‘½ä»¤å°†æ¸…é™¤ä»»ä½•å·²å­˜åœ¨çš„ç¯å¢ƒå˜é‡</p>\n<h2 id=\"list-å˜é‡\"><a href=\"#list-å˜é‡\" class=\"headerlink\" title=\"list å˜é‡\"></a>list å˜é‡</h2><blockquote>\n<p>Note A list in cmake is aÂ <code>;</code>Â separated group of strings. To create a list the set command can be used. For example,Â <code>set(varÂ aÂ bÂ cÂ dÂ e)</code>Â creates a list withÂ <code>a;b;c;d;e</code>, andÂ <code>set(varÂ &quot;aÂ bÂ cÂ dÂ e&quot;)</code>Â creates a string or a list with one item in it. (Note macro arguments are not variables, and therefore cannot be used in LIST commands.)</p>\n</blockquote>\n<p>åˆ—è¡¨ä¸åº”è¯¥ç”¨äºå¤æ‚çš„æ•°æ®å¤„ç†ä»»åŠ¡ï¼Œå¸¸å¸¸ç”¨æ¥ä¿å­˜æºæ–‡ä»¶åˆ—è¡¨ã€‚</p>\n<p>å¤§å¤šæ•°æ„é€ åˆ—è¡¨çš„å‘½ä»¤ä¸ä¼šè½¬ä¹‰; åˆ—è¡¨å…ƒç´ ä¸­çš„å­—ç¬¦ï¼Œå› æ­¤å°†åµŒå¥—åˆ—è¡¨å±•å¼€:</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs css\">set(srcs <span class=\"hljs-selector-tag\">a</span><span class=\"hljs-selector-class\">.c</span> <span class=\"hljs-selector-tag\">b</span><span class=\"hljs-selector-class\">.c</span> c<span class=\"hljs-selector-class\">.c</span>) # sets &quot;srcs&quot; <span class=\"hljs-selector-tag\">to</span> &quot;<span class=\"hljs-selector-tag\">a</span><span class=\"hljs-selector-class\">.c</span>;<span class=\"hljs-selector-tag\">b</span><span class=\"hljs-selector-class\">.c</span>;c<span class=\"hljs-selector-class\">.c</span>&quot;<br>set(x <span class=\"hljs-selector-tag\">a</span> &quot;<span class=\"hljs-selector-tag\">b</span>;c&quot;) # sets &quot;x&quot; <span class=\"hljs-selector-tag\">to</span> &quot;<span class=\"hljs-selector-tag\">a</span>;<span class=\"hljs-selector-tag\">b</span>;c&quot;, not &quot;<span class=\"hljs-selector-tag\">a</span>;<span class=\"hljs-selector-tag\">b</span>\\;c&quot;<br>set(<span class=\"hljs-selector-tag\">var</span>Â &quot;<span class=\"hljs-selector-tag\">a</span>Â <span class=\"hljs-selector-tag\">b</span>Â cÂ dÂ e&quot;) # sets <span class=\"hljs-selector-tag\">var</span> <span class=\"hljs-selector-tag\">to</span> &quot;<span class=\"hljs-selector-tag\">a</span> <span class=\"hljs-selector-tag\">b</span> c d e&quot;<br></code></pre></td></tr></table></figure>\n\n<p><a href=\"https://cmake.org/cmake/help/latest/command/list.html\">list</a>æ“ä½œï¼Œå°±æ˜¯ä¸€äº›å¢åˆ æŸ¥æ”¹</p>\n<figure class=\"highlight dust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dust\"><span class=\"language-xml\">Reading</span><br><span class=\"language-xml\">  list(LENGTH <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(GET <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">element</span> <span class=\"hljs-attr\">index</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">index</span>&gt;</span> ...] <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(JOIN <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">glue</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(SUBLIST <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">begin</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">length</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\"></span><br><span class=\"language-xml\">Search</span><br><span class=\"language-xml\">  list(FIND <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">value</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\"></span><br><span class=\"language-xml\">Modification</span><br><span class=\"language-xml\">  list(APPEND <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">element</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(FILTER <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> </span><span class=\"hljs-template-variable\">&#123;INCLUDE | EXCLUDE&#125;</span><span class=\"language-xml\"> REGEX <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">regex</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(INSERT <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">index</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">element</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(POP_BACK <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(POP_FRONT <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(PREPEND <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">element</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(REMOVE_ITEM <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">value</span>&gt;</span>...)</span><br><span class=\"language-xml\">  list(REMOVE_AT <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">index</span>&gt;</span>...)</span><br><span class=\"language-xml\">  list(REMOVE_DUPLICATES <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(TRANSFORM <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ACTION</span>&gt;</span> [...])</span><br><span class=\"language-xml\"></span><br><span class=\"language-xml\">Ordering</span><br><span class=\"language-xml\">  list(REVERSE <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(SORT <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [...])</span><br></code></pre></td></tr></table></figure>\n\n<h1 id=\"file-å‘½ä»¤\"><a href=\"#file-å‘½ä»¤\" class=\"headerlink\" title=\"file å‘½ä»¤\"></a><a href=\"https://cmake.org/cmake/help/latest/command/file.html\">file å‘½ä»¤</a></h1><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\">Reading<br>  <span class=\"hljs-keyword\">file</span>(READ <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(STRINGS <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(<span class=\"hljs-symbol\">&lt;HASH&gt;</span> <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span>)<br>  <span class=\"hljs-keyword\">file</span>(TIMESTAMP <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(GET_RUNTIME_DEPENDENCIES [...])<br><br>Writing<br>  <span class=\"hljs-keyword\">file</span>(&#123;WRITE | APPEND&#125; <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;content&gt;</span>...)<br>  <span class=\"hljs-keyword\">file</span>(&#123;TOUCH | TOUCH_NOCREATE&#125; [<span class=\"hljs-symbol\">&lt;file&gt;</span>...])<br>  <span class=\"hljs-keyword\">file</span>(GENERATE OUTPUT <span class=\"hljs-symbol\">&lt;output-file&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(CONFIGURE OUTPUT <span class=\"hljs-symbol\">&lt;output-file&gt;</span> CONTENT <span class=\"hljs-symbol\">&lt;content&gt;</span> [...])<br><br>Filesystem<br>  <span class=\"hljs-keyword\">file</span>(&#123;GLOB | GLOB_RECURSE&#125; <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [...] [<span class=\"hljs-symbol\">&lt;globbing-expr&gt;</span>...])<br>  <span class=\"hljs-keyword\">file</span>(MAKE_DIRECTORY [<span class=\"hljs-symbol\">&lt;dir&gt;</span>...])<br>  <span class=\"hljs-keyword\">file</span>(&#123;REMOVE | REMOVE_RECURSE &#125; [<span class=\"hljs-symbol\">&lt;files&gt;</span>...])<br>  <span class=\"hljs-keyword\">file</span>(RENAME <span class=\"hljs-symbol\">&lt;oldname&gt;</span> <span class=\"hljs-symbol\">&lt;newname&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(COPY_FILE <span class=\"hljs-symbol\">&lt;oldname&gt;</span> <span class=\"hljs-symbol\">&lt;newname&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(&#123;COPY | INSTALL&#125; <span class=\"hljs-symbol\">&lt;file&gt;</span>... DESTINATION <span class=\"hljs-symbol\">&lt;dir&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(SIZE <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span>)<br>  <span class=\"hljs-keyword\">file</span>(READ_SYMLINK <span class=\"hljs-symbol\">&lt;linkname&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span>)<br>  <span class=\"hljs-keyword\">file</span>(CREATE_LINK <span class=\"hljs-symbol\">&lt;original&gt;</span> <span class=\"hljs-symbol\">&lt;linkname&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(CHMOD <span class=\"hljs-symbol\">&lt;files&gt;</span>... <span class=\"hljs-symbol\">&lt;directories&gt;</span>... PERMISSIONS <span class=\"hljs-symbol\">&lt;permissions&gt;</span>... [...])<br>  <span class=\"hljs-keyword\">file</span>(CHMOD_RECURSE <span class=\"hljs-symbol\">&lt;files&gt;</span>... <span class=\"hljs-symbol\">&lt;directories&gt;</span>... PERMISSIONS <span class=\"hljs-symbol\">&lt;permissions&gt;</span>... [...])<br><br>Path Conversion<br>  <span class=\"hljs-keyword\">file</span>(REAL_PATH <span class=\"hljs-symbol\">&lt;path&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [BASE_DIRECTORY <span class=\"hljs-symbol\">&lt;dir&gt;</span>] [EXPAND_TILDE])<br>  <span class=\"hljs-keyword\">file</span>(RELATIVE_PATH <span class=\"hljs-symbol\">&lt;out-var&gt;</span> <span class=\"hljs-symbol\">&lt;directory&gt;</span> <span class=\"hljs-symbol\">&lt;file&gt;</span>)<br>  <span class=\"hljs-keyword\">file</span>(&#123;TO_CMAKE_PATH | TO_NATIVE_PATH&#125; <span class=\"hljs-symbol\">&lt;path&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span>)<br><br>Transfer<br>  <span class=\"hljs-keyword\">file</span>(DOWNLOAD <span class=\"hljs-symbol\">&lt;url&gt;</span> [<span class=\"hljs-symbol\">&lt;file&gt;</span>] [...])<br>  <span class=\"hljs-keyword\">file</span>(UPLOAD <span class=\"hljs-symbol\">&lt;file&gt;</span> <span class=\"hljs-symbol\">&lt;url&gt;</span> [...])<br><br>Locking<br>  <span class=\"hljs-keyword\">file</span>(LOCK <span class=\"hljs-symbol\">&lt;path&gt;</span> [...])<br><br>Archiving<br>  <span class=\"hljs-keyword\">file</span>(ARCHIVE_CREATE OUTPUT <span class=\"hljs-symbol\">&lt;archive&gt;</span> PATHS <span class=\"hljs-symbol\">&lt;paths&gt;</span>... [...])<br>  <span class=\"hljs-keyword\">file</span>(ARCHIVE_EXTRACT INPUT <span class=\"hljs-symbol\">&lt;archive&gt;</span> [...])<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Filesystem\"><a href=\"#Filesystem\" class=\"headerlink\" title=\"Filesystem\"></a>Filesystem</h2><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-built_in\">file</span>(GLOB &lt;variable&gt;<br>     <span class=\"hljs-selector-attr\">[LIST_DIRECTORIES true|false]</span> <span class=\"hljs-selector-attr\">[RELATIVE &lt;path&gt;]</span> <span class=\"hljs-selector-attr\">[CONFIGURE_DEPENDS]</span><br>     <span class=\"hljs-selector-attr\">[&lt;globbing-expressions&gt;...]</span>)<br><span class=\"hljs-built_in\">file</span>(GLOB_RECURSE &lt;variable&gt; <span class=\"hljs-selector-attr\">[FOLLOW_SYMLINKS]</span><br>     <span class=\"hljs-selector-attr\">[LIST_DIRECTORIES true|false]</span> <span class=\"hljs-selector-attr\">[RELATIVE &lt;path&gt;]</span> <span class=\"hljs-selector-attr\">[CONFIGURE_DEPENDS]</span><br>     <span class=\"hljs-selector-attr\">[&lt;globbing-expressions&gt;...]</span>)<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Generate a list of files that match theÂ <code>&lt;globbing-expressions&gt;</code>Â and store it into theÂ <code>&lt;variable&gt;</code>. Globbing expressions are similar to regular expressions, but much simpler. IfÂ <code>RELATIVE</code>Â flag is specified, the results will be returned as relative paths to the given path.</p>\n<p>On Windows and macOS, globbing is case-insensitive even if the underlying filesystem is case-sensitive (both filenames and globbing expressions are converted to lowercase before matching). On other platforms, globbing is case-sensitive</p>\n<p>By defaultÂ <code>GLOB</code>Â lists directories - directories are omitted in result ifÂ <code>LIST_DIRECTORIES</code>Â is set to false.</p>\n</blockquote>\n<p>Examples of globbing expressions include:</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\">*.cxx      - <span class=\"hljs-keyword\">match</span> <span class=\"hljs-keyword\">all</span> <span class=\"hljs-keyword\">files</span> with extension cxx<br>*.vt?      - <span class=\"hljs-keyword\">match</span> <span class=\"hljs-keyword\">all</span> <span class=\"hljs-keyword\">files</span> with extension vta,...,vtz<br><span class=\"hljs-keyword\">f</span>[<span class=\"hljs-number\">3</span>-<span class=\"hljs-number\">5</span>].txt - <span class=\"hljs-keyword\">match</span> <span class=\"hljs-keyword\">files</span> f3.txt, f4.txt, f5.txt<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>TheÂ <code>GLOB_RECURSE</code>Â mode will traverse all the subdirectories of the matched directory and match the files.</p>\n</blockquote>\n<h1 id=\"cmake-æ‰§è¡Œshellå‘½ä»¤\"><a href=\"#cmake-æ‰§è¡Œshellå‘½ä»¤\" class=\"headerlink\" title=\"cmake æ‰§è¡Œshellå‘½ä»¤\"></a>cmake æ‰§è¡Œshellå‘½ä»¤</h1><p>é€šè¿‡ execute_process  å¯ä»¥æ‰§è¡Œè°ƒç”¨shell å‘½ä»¤</p>\n<figure class=\"highlight inform7\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs inform7\">execute_process(COMMAND &lt;cmd1&gt; <span class=\"hljs-comment\">[&lt;arguments&gt;]</span><br>                <span class=\"hljs-comment\">[COMMAND &lt;cmd2&gt; <span class=\"hljs-comment\">[&lt;arguments&gt;]</span>]</span>...<br>                <span class=\"hljs-comment\">[WORKING_DIRECTORY &lt;directory&gt;]</span><br>                <span class=\"hljs-comment\">[TIMEOUT &lt;seconds&gt;]</span><br>                <span class=\"hljs-comment\">[RESULT_VARIABLE &lt;variable&gt;]</span><br>                <span class=\"hljs-comment\">[RESULTS_VARIABLE &lt;variable&gt;]</span><br>                <span class=\"hljs-comment\">[OUTPUT_VARIABLE &lt;variable&gt;]</span><br>                <span class=\"hljs-comment\">[ERROR_VARIABLE &lt;variable&gt;]</span><br>                <span class=\"hljs-comment\">[INPUT_FILE &lt;file&gt;]</span><br>                <span class=\"hljs-comment\">[OUTPUT_FILE &lt;file&gt;]</span><br>                <span class=\"hljs-comment\">[ERROR_FILE &lt;file&gt;]</span><br>                <span class=\"hljs-comment\">[OUTPUT_QUIET]</span><br>                <span class=\"hljs-comment\">[ERROR_QUIET]</span><br>                <span class=\"hljs-comment\">[COMMAND_ECHO &lt;where&gt;]</span><br>                <span class=\"hljs-comment\">[OUTPUT_STRIP_TRAILING_WHITESPACE]</span><br>                <span class=\"hljs-comment\">[ERROR_STRIP_TRAILING_WHITESPACE]</span><br>                <span class=\"hljs-comment\">[ENCODING &lt;name&gt;]</span><br>                <span class=\"hljs-comment\">[ECHO_OUTPUT_VARIABLE]</span><br>                <span class=\"hljs-comment\">[ECHO_ERROR_VARIABLE]</span><br>                <span class=\"hljs-comment\">[COMMAND_ERROR_IS_FATAL &lt;ANY|LAST&gt;]</span>)<br></code></pre></td></tr></table></figure>\n","excerpt":"","more":"<h1 id=\"æ–‡ä»¶ç»„ç»‡\"><a href=\"#æ–‡ä»¶ç»„ç»‡\" class=\"headerlink\" title=\"æ–‡ä»¶ç»„ç»‡\"></a>æ–‡ä»¶ç»„ç»‡</h1><p>CMakeæºæ–‡ä»¶ç”¨cmakeè¯­è¨€ç¼–å†™ï¼Œå…±ä¸‰ç§ç»„ç»‡å½¢å¼</p>\n<ul>\n<li><p><a href=\"https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#directories\">Directories</a>Â (<code>CMakeLists.txt</code>) ç›®å½•</p>\n</li>\n<li><p><a href=\"https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#scripts\">Scripts</a>Â (<code>&lt;script&gt;.cmake</code>) è„šæœ¬</p>\n</li>\n<li><p><a href=\"https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#modules\">Modules</a>Â (<code>&lt;module&gt;.cmake</code>) æ¨¡å—</p>\n</li>\n</ul>\n<h3 id=\"Directories-ç›®å½•\"><a href=\"#Directories-ç›®å½•\" class=\"headerlink\" title=\"DirectoriesÂ ç›®å½•\"></a>DirectoriesÂ ç›®å½•</h3><p>ç”¨cmake å»ç¼–è¯‘é¡¹ç›®æ—¶å€™ï¼Œå…¥å£æ˜¯é¡¹ç›®é¡¶çº§ç›®å½•çš„<code>CMakeLists.txt</code>æ–‡ä»¶ï¼Œ<code>CMakeLists.txt</code>æè¿°äº†å½“å‰é¡¹ç›®æ„å»ºè§„åˆ™ã€‚å½“é‡åˆ°<code>add _ subdirectory ()</code>å‘½ä»¤ï¼Œcmakeä¼šå»å‘½ä»¤æŒ‡å®šçš„å­ç›®å½•ä¸­æœç´¢<code>CMakeLists.txt</code>ï¼Œå°†å…¶æ·»åŠ åˆ°æ„å»ºè¿‡ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªé€’å½’è§£æçš„è¿‡ç¨‹ã€‚å­ç›®å½•ä¸­çš„<code>CMakeLists.txt</code>æè¿°äº†å­é¡¹ç›®çš„æ„å»ºè§„åˆ™ã€‚</p>\n<h3 id=\"Scripts-è„šæœ¬\"><a href=\"#Scripts-è„šæœ¬\" class=\"headerlink\" title=\"ScriptsÂ è„šæœ¬\"></a>ScriptsÂ è„šæœ¬</h3><p>ä¸€ä¸ªå•ç‹¬çš„<code>&lt;script&gt;.cmake</code>æ–‡ä»¶å¯ä»¥è¢«å½“åšè„šæœ¬æ¥å¤„ç†ï¼Œå¯ä»¥ç†è§£ä¸ºshellè„šæœ¬ï¼Œé€šè¿‡cmakeæ¥è§£æå’Œæ‰§è¡Œè„šæœ¬å®šä¹‰çš„æ“ä½œã€‚è„šæœ¬ä¸­ä¸å…è®¸å‡ºç°å®šä¹‰æ„å»ºç›®æ ‡å’Œæ„å»ºè¡Œä¸ºçš„å‘½ä»¤ï¼Œ</p>\n<p>cmake è„šæœ¬ä¸å‚ä¸æ„å»ºè¿‡ç¨‹ã€‚</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\">cmake [&#123;-D <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">var</span>&gt;</span>=<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">value</span>&gt;</span>&#125;...] -P <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">cmake-script-file</span>&gt;</span> [-- <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">unparsed-options</span>&gt;</span>...]<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Process the given cmake file as a script written in the CMake language. No configure or generate step is performed and the cache is not modified. If variables are defined usingÂ <code>-D</code>, this must be done before theÂ <code>-P</code>Â argument.</p>\n</blockquote>\n<blockquote>\n<p>Any options afterÂ <code>--</code>Â are not parsed by CMake, but they are still included in the set ofÂ <a href=\"https://cmake.org/cmake/help/latest/variable/CMAKE_ARGV0.html#variable:CMAKE_ARGV0\" title=\"CMAKE_ARGV0\"><code>CMAKE_ARGV&lt;n&gt;</code></a>Â variables passed to the script (including theÂ <code>--</code>Â itself).</p>\n</blockquote>\n<h3 id=\"Modules-æ¨¡å—\"><a href=\"#Modules-æ¨¡å—\" class=\"headerlink\" title=\"Modules æ¨¡å—\"></a>Modules æ¨¡å—</h3><p>å°±æ˜¯ä¸€ä¸ªcmakeçš„æºæ–‡ä»¶ï¼Œå½¢å¼<code>&lt;module&gt;.cmake</code>ã€‚å¯ä»¥åœ¨å½“å‰<code>CMakeLists.txt</code>æˆ–cmakeæºæ–‡ä»¶ä¸­ï¼Œé€šè¿‡<code>include()</code>å‘½ä»¤ï¼Œå¼•å…¥å…¶ä»–cmakeæ–‡ä»¶ä¸­å®šä¹‰çš„å†…å®¹ã€‚ç±»ä¼¼äºcè¯­è¨€çš„</p>\n<p><code>#include&lt;&gt;</code>ã€‚</p>\n<p>cmake å†…ç½®äº†å¾ˆå¤šçš„æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡<a href=\"https://cmake.org/cmake/help/latest/manual/cmake-modules.7.html#manual:cmake-modules(7)\">cmake-modules</a>æŸ¥çœ‹ã€‚é¡¹ç›®å¯ä»¥å®šä¹‰è‡ªå·±cmake modulesï¼Œé€šè¿‡<a href=\"https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html#variable:CMAKE_MODULE_PATH\">CMAKE_MODULE_PATH</a>æ¥æŒ‡å®šä»–ä»¬çš„è·¯å¾„ã€‚</p>\n<h1 id=\"cmake-å˜é‡\"><a href=\"#cmake-å˜é‡\" class=\"headerlink\" title=\"cmake å˜é‡\"></a>cmake å˜é‡</h1><ol>\n<li><p>cmake å˜é‡çš„å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹</p>\n</li>\n<li><p>Set ()å’Œ unset ()å‘½ä»¤æ˜¾å¼åœ°è®¾ç½®æˆ–å–æ¶ˆè®¾ç½®å˜é‡</p>\n</li>\n<li><p>å˜é‡åæ˜¯åŒºåˆ†å¤§å°å†™çš„,å»ºè®®åªä½¿ç”¨ç”±å­—æ¯æ•°å­—å­—ç¬¦åŠ ä¸Š <code>_ </code>å’Œ<code>-</code>ç»„æˆçš„åç§°</p>\n</li>\n<li><p>æ ¹æ®ä½œç”¨äºèŒƒå›´, å˜é‡çš„ç±»å‹æœ‰normal, cache, or environment variable</p>\n</li>\n</ol>\n<h3 id=\"å˜é‡ä½œç”¨èŒƒå›´\"><a href=\"#å˜é‡ä½œç”¨èŒƒå›´\" class=\"headerlink\" title=\"å˜é‡ä½œç”¨èŒƒå›´\"></a>å˜é‡ä½œç”¨èŒƒå›´</h3><p>å‚è€ƒè¿™ç¯‡æ–‡ç« <a href=\"https://blog.csdn.net/weixin_39732534/article/details/110658282\">cmake cacheå˜é‡_åå¤ç ”ç©¶å¥½å‡ éï¼Œæˆ‘æ‰å‘ç°å…³äº CMake å˜é‡è¿˜å¯ä»¥è¿™æ ·ç†è§£ï¼_weixin_39732534çš„åšå®¢-CSDNåšå®¢</a> å¯ä»¥æ›´å¥½çš„ç†è§£cmake å˜é‡åŠå…¶ä½œç”¨åŸŸèŒƒå›´ã€‚</p>\n<h4 id=\"å‡½æ•°ä½œç”¨åŸŸ\"><a href=\"#å‡½æ•°ä½œç”¨åŸŸ\" class=\"headerlink\" title=\"å‡½æ•°ä½œç”¨åŸŸ\"></a>å‡½æ•°ä½œç”¨åŸŸ</h4><p>cmake  é€šè¿‡ <a href=\"https://cmake.org/cmake/help/latest/command/function.html#command:function\" title=\"function\"><code>function()</code></a>å‘½ä»¤æ¥å®šä¹‰å‡½æ•°ã€‚åœ¨å‡½æ•°ä½œç”¨åŸŸé€šè¿‡<code>set</code>å®šä¹‰çš„å˜é‡ï¼Œåªåœ¨å‡½æ•°ä½œç”¨åŸŸå†…æœ‰æ•ˆï¼Œå‡½æ•°è¿”å›åï¼Œè¯¥å˜é‡å¤±æ•ˆã€‚</p>\n<p>ä½†æ˜¯é€šè¿‡<code>set</code>å‘½ä»¤æŒ‡å®š <code>PARENT_SCOPE</code>,å¯ä»¥è®¾ç½®å‡½æ•°ä¸Šçº§ä½œç”¨åŸŸå†…çš„å˜é‡ã€‚</p>\n<h4 id=\"CMake-æ–‡ä»¶ä¸­\"><a href=\"#CMake-æ–‡ä»¶ä¸­\" class=\"headerlink\" title=\"CMake æ–‡ä»¶ä¸­\"></a>CMake æ–‡ä»¶ä¸­</h4><p>æ¯ä¸ªCMakeLists.txt å’Œ <code>xx.cmake</code>æ–‡ä»¶ä¸­éƒ½å®šä¹‰ä¸€ä¸ªä½œç”¨åŸŸã€‚ä¸Šçº§CMakeLists.txtæ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¼šä¼ é€’ç»™ä¸‹çº§çš„CMakeLists.txtæ–‡ä»¶ä¸­ã€‚</p>\n<p>ä¸åœ¨å‡½æ•°ç”¨é€šè¿‡<code>set</code>å’Œ<code>unset</code>å‘½ä»¤è®¾ç½®çš„å˜é‡ï¼Œä½œç”¨èŒƒå›´åœ¨å½“å‰çš„æ–‡ä»¶ä¸­ã€‚</p>\n<p>ä¿®æ”¹å½“å‰CMakeLists.txtæ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ï¼Œåœ¨ä¸Šçº§CMakeLists.txtæ–‡ä»¶ä¸­ä¸ç”Ÿæ•ˆï¼Œä½†æ˜¯é€šè¿‡<code>set</code>å‘½ä»¤æŒ‡å®š <code>PARENT_SCOPE</code>,å¯ä»¥ä¿®æ”¹ä¸Šçº§ä½œç”¨åŸŸå†…çš„å˜é‡ã€‚</p>\n<h4 id=\"cache-ä¸­\"><a href=\"#cache-ä¸­\" class=\"headerlink\" title=\"cache ä¸­\"></a>cache ä¸­</h4><p>cache å˜é‡å­˜è¢«ä¿å­˜åœ¨<code>CMakeCache.txt</code>æ–‡ä»¶ä¸­ã€‚å…¨å±€å˜é‡ï¼Œå¤šä¸ªæ„å»ºæ„å»ºä¸­æŒç»­ç”Ÿæ•ˆã€‚</p>\n<p>åªèƒ½é€šè¿‡setå‘½ä»¤ï¼ŒæŒ‡å®š<code>CACHE</code>é€‰é¡¹æ¥æ˜¾ç¤ºä¿®æ”¹ã€‚</p>\n<h4 id=\"ç¯å¢ƒå˜é‡\"><a href=\"#ç¯å¢ƒå˜é‡\" class=\"headerlink\" title=\"ç¯å¢ƒå˜é‡\"></a>ç¯å¢ƒå˜é‡</h4><p>ç±»ä¼¼äºæ™®é€šå˜é‡ï¼Œä½†æ˜¯ä½œç”¨èŒƒå›´æ˜¯å…¨å±€ï¼Œä¸ä¼šè¢«ç¼“å­˜ã€‚</p>\n<p>å˜é‡å¼•ç”¨çš„æ ¼å¼ä¸º $ENV { &lt; Variable &gt; }</p>\n<p>CMake ç¯å¢ƒå˜é‡çš„åˆå§‹å€¼æ˜¯è°ƒç”¨è¿›ç¨‹çš„åˆå§‹å€¼ã€‚å¯ä»¥ä½¿ç”¨ set ()å’Œ unset ()å‘½ä»¤æ›´æ”¹å€¼ã€‚è¿™äº›å‘½ä»¤åªå½±å“æ­£åœ¨è¿è¡Œçš„ CMake è¿›ç¨‹ï¼Œè€Œä¸å½±å“æ•´ä¸ªç³»ç»Ÿç¯å¢ƒã€‚æ›´æ”¹åçš„å€¼ä¸ä¼šå†™å›è°ƒç”¨è¿›ç¨‹ï¼Œåç»­çš„æ„å»ºæˆ–æµ‹è¯•è¿›ç¨‹ä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒä»¬ã€‚</p>\n<h3 id=\"å˜é‡æ±‚å€¼çš„é¡ºåºï¼š\"><a href=\"#å˜é‡æ±‚å€¼çš„é¡ºåºï¼š\" class=\"headerlink\" title=\"å˜é‡æ±‚å€¼çš„é¡ºåºï¼š\"></a>å˜é‡æ±‚å€¼çš„é¡ºåºï¼š</h3><ol>\n<li><p>å½“å‰å‡½æ•°å†…æŸ¥æ‰¾</p>\n</li>\n<li><p>å½“å‰æ–‡ä»¶ä¸­æŸ¥æ‰¾</p>\n</li>\n<li><p>ç¼“å­˜ä¸­æŸ¥æ‰¾</p>\n</li>\n<li><p>æœ€åæ²¡æ‰¾åˆ°ï¼Œè®¡ä¸ºç©ºå­—ç¬¦ä¸²ã€‚</p>\n</li>\n<li><p>å¯ä»¥é€šè¿‡<code>$CACHE&#123;VAR&#125;</code>è·³è¿‡å‰é¢çš„è¿‡ç¨‹ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­æŸ¥æ‰¾ã€‚</p>\n</li>\n</ol>\n<h3 id=\"set-ç»™å˜é‡èµ‹å€¼\"><a href=\"#set-ç»™å˜é‡èµ‹å€¼\" class=\"headerlink\" title=\"set ç»™å˜é‡èµ‹å€¼\"></a>set ç»™å˜é‡èµ‹å€¼</h3><h4 id=\"normal-å˜é‡\"><a href=\"#normal-å˜é‡\" class=\"headerlink\" title=\"normal å˜é‡\"></a>normal å˜é‡</h4><figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\"><span class=\"hljs-built_in\">set</span>(&lt;<span class=\"hljs-built_in\">variable</span>&gt; &lt;value&gt;<span class=\"hljs-params\">...</span> <span class=\"hljs-meta\">[</span>PARENT_SCOPE<span class=\"hljs-meta\">]</span>)<br></code></pre></td></tr></table></figure>\n\n<p>å¦‚æœæŒ‡å®šäº†PARENT_SCOPEï¼Œä¿®æ”¹ä¼šåœ¨ä¸Šçº§ä½œç”¨åŸŸå†…ç”Ÿæ•ˆã€‚</p>\n<h4 id=\"Set-Cache-Entry\"><a href=\"#Set-Cache-Entry\" class=\"headerlink\" title=\"Set Cache Entry\"></a>Set Cache Entry</h4><figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\"><span class=\"hljs-built_in\">set</span>(&lt;<span class=\"hljs-built_in\">variable</span>&gt; &lt;value&gt;<span class=\"hljs-params\">...</span> <span class=\"hljs-keyword\">CACHE</span> &lt;<span class=\"hljs-keyword\">type</span>&gt; &lt;docstring&gt; <span class=\"hljs-meta\">[</span>FORCE<span class=\"hljs-meta\">]</span>)<br></code></pre></td></tr></table></figure>\n\n<p>ä¸åŠ FORCEï¼Œä¿®æ”¹ä¸ä¼šè¦†ç›–ä¹‹å‰cacheä¸­çš„å€¼ã€‚Â FORCE é€‰é¡¹è¦†ç›–ç°æœ‰æ¡ç›®ã€‚</p>\n<p>typeçš„ç±»å‹å¿…é¡»æŒ‡å®šä¸ºä»¥ä¸‹ä¸€ç§ï¼š</p>\n<ol>\n<li><p>BOOL</p>\n</li>\n<li><p>FILEPATH</p>\n</li>\n<li><p>PATH</p>\n</li>\n<li><p>STRING</p>\n</li>\n<li><p>INTERNAL</p>\n</li>\n</ol>\n<blockquote>\n<p>ä¹Ÿå¯ä»¥é€šè¿‡cmakeå‘½ä»¤ï¼Œé€šè¿‡<code>-D&lt;var&gt;=&lt;value&gt;</code>æ·»åŠ ç¼“å­˜æ¡ç›®ã€‚</p>\n</blockquote>\n<h4 id=\"ç¯å¢ƒå˜é‡-1\"><a href=\"#ç¯å¢ƒå˜é‡-1\" class=\"headerlink\" title=\"ç¯å¢ƒå˜é‡\"></a>ç¯å¢ƒå˜é‡</h4><figure class=\"highlight fsharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs fsharp\"><span class=\"hljs-built_in\">set</span>(ENV&#123;<span class=\"hljs-operator\">&lt;</span>variable<span class=\"hljs-operator\">&gt;</span>&#125; <span class=\"hljs-meta\">[&lt;value&gt;]</span>)<br></code></pre></td></tr></table></figure>\n\n<p>è®¾ç½®ç»™å®šå€¼çš„ç¯å¢ƒå˜é‡ï¼Œ<code>$ENV&#123;&lt;variable&gt;&#125;</code>çš„åç»­è°ƒç”¨å°†è¿”å›è¿™ä¸ªæ–°å€¼ã€‚</p>\n<p>æ­¤å‘½ä»¤åªå½±å“å½“å‰çš„ CMake è¿›ç¨‹ï¼Œè€Œä¸å½±å“è°ƒç”¨ CMake çš„è¿›ç¨‹ï¼Œä¹Ÿä¸å½±å“æ•´ä¸ªç³»ç»Ÿç¯å¢ƒï¼Œä¹Ÿä¸å½±å“åç»­æ„å»ºæˆ–æµ‹è¯•æµç¨‹çš„ç¯å¢ƒã€‚</p>\n<p>å¦‚æœåœ¨ <code>ENV &#123; &lt; variable &gt; &#125;</code>ä¹‹åæ²¡æœ‰ç»™å‡ºå‚æ•°ï¼Œæˆ–è€…å¦‚æœ <code>&lt; value &gt;</code> æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™ä¸ªå‘½ä»¤å°†æ¸…é™¤ä»»ä½•å·²å­˜åœ¨çš„ç¯å¢ƒå˜é‡</p>\n<h2 id=\"list-å˜é‡\"><a href=\"#list-å˜é‡\" class=\"headerlink\" title=\"list å˜é‡\"></a>list å˜é‡</h2><blockquote>\n<p>Note A list in cmake is aÂ <code>;</code>Â separated group of strings. To create a list the set command can be used. For example,Â <code>set(varÂ aÂ bÂ cÂ dÂ e)</code>Â creates a list withÂ <code>a;b;c;d;e</code>, andÂ <code>set(varÂ &quot;aÂ bÂ cÂ dÂ e&quot;)</code>Â creates a string or a list with one item in it. (Note macro arguments are not variables, and therefore cannot be used in LIST commands.)</p>\n</blockquote>\n<p>åˆ—è¡¨ä¸åº”è¯¥ç”¨äºå¤æ‚çš„æ•°æ®å¤„ç†ä»»åŠ¡ï¼Œå¸¸å¸¸ç”¨æ¥ä¿å­˜æºæ–‡ä»¶åˆ—è¡¨ã€‚</p>\n<p>å¤§å¤šæ•°æ„é€ åˆ—è¡¨çš„å‘½ä»¤ä¸ä¼šè½¬ä¹‰; åˆ—è¡¨å…ƒç´ ä¸­çš„å­—ç¬¦ï¼Œå› æ­¤å°†åµŒå¥—åˆ—è¡¨å±•å¼€:</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs css\">set(srcs <span class=\"hljs-selector-tag\">a</span><span class=\"hljs-selector-class\">.c</span> <span class=\"hljs-selector-tag\">b</span><span class=\"hljs-selector-class\">.c</span> c<span class=\"hljs-selector-class\">.c</span>) # sets &quot;srcs&quot; <span class=\"hljs-selector-tag\">to</span> &quot;<span class=\"hljs-selector-tag\">a</span><span class=\"hljs-selector-class\">.c</span>;<span class=\"hljs-selector-tag\">b</span><span class=\"hljs-selector-class\">.c</span>;c<span class=\"hljs-selector-class\">.c</span>&quot;<br>set(x <span class=\"hljs-selector-tag\">a</span> &quot;<span class=\"hljs-selector-tag\">b</span>;c&quot;) # sets &quot;x&quot; <span class=\"hljs-selector-tag\">to</span> &quot;<span class=\"hljs-selector-tag\">a</span>;<span class=\"hljs-selector-tag\">b</span>;c&quot;, not &quot;<span class=\"hljs-selector-tag\">a</span>;<span class=\"hljs-selector-tag\">b</span>\\;c&quot;<br>set(<span class=\"hljs-selector-tag\">var</span>Â &quot;<span class=\"hljs-selector-tag\">a</span>Â <span class=\"hljs-selector-tag\">b</span>Â cÂ dÂ e&quot;) # sets <span class=\"hljs-selector-tag\">var</span> <span class=\"hljs-selector-tag\">to</span> &quot;<span class=\"hljs-selector-tag\">a</span> <span class=\"hljs-selector-tag\">b</span> c d e&quot;<br></code></pre></td></tr></table></figure>\n\n<p><a href=\"https://cmake.org/cmake/help/latest/command/list.html\">list</a>æ“ä½œï¼Œå°±æ˜¯ä¸€äº›å¢åˆ æŸ¥æ”¹</p>\n<figure class=\"highlight dust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dust\"><span class=\"language-xml\">Reading</span><br><span class=\"language-xml\">  list(LENGTH <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(GET <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">element</span> <span class=\"hljs-attr\">index</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">index</span>&gt;</span> ...] <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(JOIN <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">glue</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(SUBLIST <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">begin</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">length</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\"></span><br><span class=\"language-xml\">Search</span><br><span class=\"language-xml\">  list(FIND <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">value</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>)</span><br><span class=\"language-xml\"></span><br><span class=\"language-xml\">Modification</span><br><span class=\"language-xml\">  list(APPEND <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">element</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(FILTER <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> </span><span class=\"hljs-template-variable\">&#123;INCLUDE | EXCLUDE&#125;</span><span class=\"language-xml\"> REGEX <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">regex</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(INSERT <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">index</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">element</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(POP_BACK <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(POP_FRONT <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">out-var</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(PREPEND <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">element</span>&gt;</span>...])</span><br><span class=\"language-xml\">  list(REMOVE_ITEM <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">value</span>&gt;</span>...)</span><br><span class=\"language-xml\">  list(REMOVE_AT <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">index</span>&gt;</span>...)</span><br><span class=\"language-xml\">  list(REMOVE_DUPLICATES <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(TRANSFORM <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ACTION</span>&gt;</span> [...])</span><br><span class=\"language-xml\"></span><br><span class=\"language-xml\">Ordering</span><br><span class=\"language-xml\">  list(REVERSE <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span>)</span><br><span class=\"language-xml\">  list(SORT <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">list</span>&gt;</span> [...])</span><br></code></pre></td></tr></table></figure>\n\n<h1 id=\"file-å‘½ä»¤\"><a href=\"#file-å‘½ä»¤\" class=\"headerlink\" title=\"file å‘½ä»¤\"></a><a href=\"https://cmake.org/cmake/help/latest/command/file.html\">file å‘½ä»¤</a></h1><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\">Reading<br>  <span class=\"hljs-keyword\">file</span>(READ <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(STRINGS <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(<span class=\"hljs-symbol\">&lt;HASH&gt;</span> <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span>)<br>  <span class=\"hljs-keyword\">file</span>(TIMESTAMP <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(GET_RUNTIME_DEPENDENCIES [...])<br><br>Writing<br>  <span class=\"hljs-keyword\">file</span>(&#123;WRITE | APPEND&#125; <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;content&gt;</span>...)<br>  <span class=\"hljs-keyword\">file</span>(&#123;TOUCH | TOUCH_NOCREATE&#125; [<span class=\"hljs-symbol\">&lt;file&gt;</span>...])<br>  <span class=\"hljs-keyword\">file</span>(GENERATE OUTPUT <span class=\"hljs-symbol\">&lt;output-file&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(CONFIGURE OUTPUT <span class=\"hljs-symbol\">&lt;output-file&gt;</span> CONTENT <span class=\"hljs-symbol\">&lt;content&gt;</span> [...])<br><br>Filesystem<br>  <span class=\"hljs-keyword\">file</span>(&#123;GLOB | GLOB_RECURSE&#125; <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [...] [<span class=\"hljs-symbol\">&lt;globbing-expr&gt;</span>...])<br>  <span class=\"hljs-keyword\">file</span>(MAKE_DIRECTORY [<span class=\"hljs-symbol\">&lt;dir&gt;</span>...])<br>  <span class=\"hljs-keyword\">file</span>(&#123;REMOVE | REMOVE_RECURSE &#125; [<span class=\"hljs-symbol\">&lt;files&gt;</span>...])<br>  <span class=\"hljs-keyword\">file</span>(RENAME <span class=\"hljs-symbol\">&lt;oldname&gt;</span> <span class=\"hljs-symbol\">&lt;newname&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(COPY_FILE <span class=\"hljs-symbol\">&lt;oldname&gt;</span> <span class=\"hljs-symbol\">&lt;newname&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(&#123;COPY | INSTALL&#125; <span class=\"hljs-symbol\">&lt;file&gt;</span>... DESTINATION <span class=\"hljs-symbol\">&lt;dir&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(SIZE <span class=\"hljs-symbol\">&lt;filename&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span>)<br>  <span class=\"hljs-keyword\">file</span>(READ_SYMLINK <span class=\"hljs-symbol\">&lt;linkname&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span>)<br>  <span class=\"hljs-keyword\">file</span>(CREATE_LINK <span class=\"hljs-symbol\">&lt;original&gt;</span> <span class=\"hljs-symbol\">&lt;linkname&gt;</span> [...])<br>  <span class=\"hljs-keyword\">file</span>(CHMOD <span class=\"hljs-symbol\">&lt;files&gt;</span>... <span class=\"hljs-symbol\">&lt;directories&gt;</span>... PERMISSIONS <span class=\"hljs-symbol\">&lt;permissions&gt;</span>... [...])<br>  <span class=\"hljs-keyword\">file</span>(CHMOD_RECURSE <span class=\"hljs-symbol\">&lt;files&gt;</span>... <span class=\"hljs-symbol\">&lt;directories&gt;</span>... PERMISSIONS <span class=\"hljs-symbol\">&lt;permissions&gt;</span>... [...])<br><br>Path Conversion<br>  <span class=\"hljs-keyword\">file</span>(REAL_PATH <span class=\"hljs-symbol\">&lt;path&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span> [BASE_DIRECTORY <span class=\"hljs-symbol\">&lt;dir&gt;</span>] [EXPAND_TILDE])<br>  <span class=\"hljs-keyword\">file</span>(RELATIVE_PATH <span class=\"hljs-symbol\">&lt;out-var&gt;</span> <span class=\"hljs-symbol\">&lt;directory&gt;</span> <span class=\"hljs-symbol\">&lt;file&gt;</span>)<br>  <span class=\"hljs-keyword\">file</span>(&#123;TO_CMAKE_PATH | TO_NATIVE_PATH&#125; <span class=\"hljs-symbol\">&lt;path&gt;</span> <span class=\"hljs-symbol\">&lt;out-var&gt;</span>)<br><br>Transfer<br>  <span class=\"hljs-keyword\">file</span>(DOWNLOAD <span class=\"hljs-symbol\">&lt;url&gt;</span> [<span class=\"hljs-symbol\">&lt;file&gt;</span>] [...])<br>  <span class=\"hljs-keyword\">file</span>(UPLOAD <span class=\"hljs-symbol\">&lt;file&gt;</span> <span class=\"hljs-symbol\">&lt;url&gt;</span> [...])<br><br>Locking<br>  <span class=\"hljs-keyword\">file</span>(LOCK <span class=\"hljs-symbol\">&lt;path&gt;</span> [...])<br><br>Archiving<br>  <span class=\"hljs-keyword\">file</span>(ARCHIVE_CREATE OUTPUT <span class=\"hljs-symbol\">&lt;archive&gt;</span> PATHS <span class=\"hljs-symbol\">&lt;paths&gt;</span>... [...])<br>  <span class=\"hljs-keyword\">file</span>(ARCHIVE_EXTRACT INPUT <span class=\"hljs-symbol\">&lt;archive&gt;</span> [...])<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Filesystem\"><a href=\"#Filesystem\" class=\"headerlink\" title=\"Filesystem\"></a>Filesystem</h2><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-built_in\">file</span>(GLOB &lt;variable&gt;<br>     <span class=\"hljs-selector-attr\">[LIST_DIRECTORIES true|false]</span> <span class=\"hljs-selector-attr\">[RELATIVE &lt;path&gt;]</span> <span class=\"hljs-selector-attr\">[CONFIGURE_DEPENDS]</span><br>     <span class=\"hljs-selector-attr\">[&lt;globbing-expressions&gt;...]</span>)<br><span class=\"hljs-built_in\">file</span>(GLOB_RECURSE &lt;variable&gt; <span class=\"hljs-selector-attr\">[FOLLOW_SYMLINKS]</span><br>     <span class=\"hljs-selector-attr\">[LIST_DIRECTORIES true|false]</span> <span class=\"hljs-selector-attr\">[RELATIVE &lt;path&gt;]</span> <span class=\"hljs-selector-attr\">[CONFIGURE_DEPENDS]</span><br>     <span class=\"hljs-selector-attr\">[&lt;globbing-expressions&gt;...]</span>)<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Generate a list of files that match theÂ <code>&lt;globbing-expressions&gt;</code>Â and store it into theÂ <code>&lt;variable&gt;</code>. Globbing expressions are similar to regular expressions, but much simpler. IfÂ <code>RELATIVE</code>Â flag is specified, the results will be returned as relative paths to the given path.</p>\n<p>On Windows and macOS, globbing is case-insensitive even if the underlying filesystem is case-sensitive (both filenames and globbing expressions are converted to lowercase before matching). On other platforms, globbing is case-sensitive</p>\n<p>By defaultÂ <code>GLOB</code>Â lists directories - directories are omitted in result ifÂ <code>LIST_DIRECTORIES</code>Â is set to false.</p>\n</blockquote>\n<p>Examples of globbing expressions include:</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\">*.cxx      - <span class=\"hljs-keyword\">match</span> <span class=\"hljs-keyword\">all</span> <span class=\"hljs-keyword\">files</span> with extension cxx<br>*.vt?      - <span class=\"hljs-keyword\">match</span> <span class=\"hljs-keyword\">all</span> <span class=\"hljs-keyword\">files</span> with extension vta,...,vtz<br><span class=\"hljs-keyword\">f</span>[<span class=\"hljs-number\">3</span>-<span class=\"hljs-number\">5</span>].txt - <span class=\"hljs-keyword\">match</span> <span class=\"hljs-keyword\">files</span> f3.txt, f4.txt, f5.txt<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>TheÂ <code>GLOB_RECURSE</code>Â mode will traverse all the subdirectories of the matched directory and match the files.</p>\n</blockquote>\n<h1 id=\"cmake-æ‰§è¡Œshellå‘½ä»¤\"><a href=\"#cmake-æ‰§è¡Œshellå‘½ä»¤\" class=\"headerlink\" title=\"cmake æ‰§è¡Œshellå‘½ä»¤\"></a>cmake æ‰§è¡Œshellå‘½ä»¤</h1><p>é€šè¿‡ execute_process  å¯ä»¥æ‰§è¡Œè°ƒç”¨shell å‘½ä»¤</p>\n<figure class=\"highlight inform7\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs inform7\">execute_process(COMMAND &lt;cmd1&gt; <span class=\"hljs-comment\">[&lt;arguments&gt;]</span><br>                <span class=\"hljs-comment\">[COMMAND &lt;cmd2&gt; <span class=\"hljs-comment\">[&lt;arguments&gt;]</span>]</span>...<br>                <span class=\"hljs-comment\">[WORKING_DIRECTORY &lt;directory&gt;]</span><br>                <span class=\"hljs-comment\">[TIMEOUT &lt;seconds&gt;]</span><br>                <span class=\"hljs-comment\">[RESULT_VARIABLE &lt;variable&gt;]</span><br>                <span class=\"hljs-comment\">[RESULTS_VARIABLE &lt;variable&gt;]</span><br>                <span class=\"hljs-comment\">[OUTPUT_VARIABLE &lt;variable&gt;]</span><br>                <span class=\"hljs-comment\">[ERROR_VARIABLE &lt;variable&gt;]</span><br>                <span class=\"hljs-comment\">[INPUT_FILE &lt;file&gt;]</span><br>                <span class=\"hljs-comment\">[OUTPUT_FILE &lt;file&gt;]</span><br>                <span class=\"hljs-comment\">[ERROR_FILE &lt;file&gt;]</span><br>                <span class=\"hljs-comment\">[OUTPUT_QUIET]</span><br>                <span class=\"hljs-comment\">[ERROR_QUIET]</span><br>                <span class=\"hljs-comment\">[COMMAND_ECHO &lt;where&gt;]</span><br>                <span class=\"hljs-comment\">[OUTPUT_STRIP_TRAILING_WHITESPACE]</span><br>                <span class=\"hljs-comment\">[ERROR_STRIP_TRAILING_WHITESPACE]</span><br>                <span class=\"hljs-comment\">[ENCODING &lt;name&gt;]</span><br>                <span class=\"hljs-comment\">[ECHO_OUTPUT_VARIABLE]</span><br>                <span class=\"hljs-comment\">[ECHO_ERROR_VARIABLE]</span><br>                <span class=\"hljs-comment\">[COMMAND_ERROR_IS_FATAL &lt;ANY|LAST&gt;]</span>)<br></code></pre></td></tr></table></figure>\n"},{"layout":"post","title":"cmake add_custom_command","date":"2022-10-22T16:00:00.000Z","_content":"\nç›®çš„ï¼š æ·»åŠ è‡ªå®šä¹‰çš„æ„å»ºè§„åˆ™åˆ°ç”Ÿæˆçš„æ„å»ºç³»ç»Ÿä¸­ã€‚\n\næœ‰ä¸¤ç§ç”¨æ³•ï¼š\n1. ä½¿ç”¨å¤–éƒ¨å‘½ä»¤æ¥äº§ç”Ÿä¸€ä¸ªè¾“å‡º, ä¾‹å¦‚ç”Ÿæˆæ–‡ä»¶\n2. ç›‘å¬ä¸€ä¸ªtargetçš„æ„å»ºäº‹ä»¶ï¼Œåœ¨targetæ„å»ºå‰æˆ–è€…æ„å»ºåï¼Œæ‰§è¡Œå‘½ä»¤\n\n\n# Examples: Generating Files\n\næ·»åŠ å‘½ä»¤ï¼Œæ‰§è¡Œåç”Ÿæˆæºæ–‡ä»¶\n\n```\nadd_custom_command(\n  OUTPUT out.c\n  COMMAND someTool -i ${CMAKE_CURRENT_SOURCE_DIR}/in.txt\n                   -o out.c\n  DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/in.txt\n  VERBATIM)\nadd_library(myLib out.c)\n```\n\né€šè¿‡ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼Œä¸ºæ¯ä¸ªconfigæŒ‡å®šä¸åŒçš„è¾“å‡º\n```\nadd_custom_command(\n  OUTPUT \"out-$<CONFIG>.c\"\n  COMMAND someTool -i ${CMAKE_CURRENT_SOURCE_DIR}/in.txt\n                   -o \"out-$<CONFIG>.c\"\n                   -c \"$<CONFIG>\"\n  DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/in.txt\n  VERBATIM)\nadd_library(myLib \"out-$<CONFIG>.c\")\n```\n\n# Examples: Build Events\n\nåœ¨targetè¢«æ„å»ºï¼Œé“¾æ¥ä¹‹åï¼Œæ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤\n\n```\nadd_executable(myExe myExe.c)\nadd_custom_command(\n  TARGET myExe POST_BUILD\n  COMMAND someHasher -i \"$<TARGET_FILE:myExe>\"\n                     -o \"$<TARGET_FILE:myExe>.hash\"\n  VERBATIM)\n```\n\nç›®å‰æ”¯æŒä¸¤ç§\n- PRE_LINK ç¼–è¯‘åï¼Œè¿æ¥å‰æ‰§è¡Œå‘½ä»¤\n- POST_BUILD æ„å»ºåï¼ŒæˆåŠŸé“¾æ¥åæ‰§è¡Œå‘½ä»¤\n\n","source":"_posts/cmake/2022-10-23-cmake add_custom_command.md","raw":"---\nlayout: post\ntitle: \"cmake add_custom_command\"\ndate: 2022-10-23\ntag: cmake\n---\n\nç›®çš„ï¼š æ·»åŠ è‡ªå®šä¹‰çš„æ„å»ºè§„åˆ™åˆ°ç”Ÿæˆçš„æ„å»ºç³»ç»Ÿä¸­ã€‚\n\næœ‰ä¸¤ç§ç”¨æ³•ï¼š\n1. ä½¿ç”¨å¤–éƒ¨å‘½ä»¤æ¥äº§ç”Ÿä¸€ä¸ªè¾“å‡º, ä¾‹å¦‚ç”Ÿæˆæ–‡ä»¶\n2. ç›‘å¬ä¸€ä¸ªtargetçš„æ„å»ºäº‹ä»¶ï¼Œåœ¨targetæ„å»ºå‰æˆ–è€…æ„å»ºåï¼Œæ‰§è¡Œå‘½ä»¤\n\n\n# Examples: Generating Files\n\næ·»åŠ å‘½ä»¤ï¼Œæ‰§è¡Œåç”Ÿæˆæºæ–‡ä»¶\n\n```\nadd_custom_command(\n  OUTPUT out.c\n  COMMAND someTool -i ${CMAKE_CURRENT_SOURCE_DIR}/in.txt\n                   -o out.c\n  DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/in.txt\n  VERBATIM)\nadd_library(myLib out.c)\n```\n\né€šè¿‡ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼Œä¸ºæ¯ä¸ªconfigæŒ‡å®šä¸åŒçš„è¾“å‡º\n```\nadd_custom_command(\n  OUTPUT \"out-$<CONFIG>.c\"\n  COMMAND someTool -i ${CMAKE_CURRENT_SOURCE_DIR}/in.txt\n                   -o \"out-$<CONFIG>.c\"\n                   -c \"$<CONFIG>\"\n  DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/in.txt\n  VERBATIM)\nadd_library(myLib \"out-$<CONFIG>.c\")\n```\n\n# Examples: Build Events\n\nåœ¨targetè¢«æ„å»ºï¼Œé“¾æ¥ä¹‹åï¼Œæ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤\n\n```\nadd_executable(myExe myExe.c)\nadd_custom_command(\n  TARGET myExe POST_BUILD\n  COMMAND someHasher -i \"$<TARGET_FILE:myExe>\"\n                     -o \"$<TARGET_FILE:myExe>.hash\"\n  VERBATIM)\n```\n\nç›®å‰æ”¯æŒä¸¤ç§\n- PRE_LINK ç¼–è¯‘åï¼Œè¿æ¥å‰æ‰§è¡Œå‘½ä»¤\n- POST_BUILD æ„å»ºåï¼ŒæˆåŠŸé“¾æ¥åæ‰§è¡Œå‘½ä»¤\n\n","slug":"cmake/2022-10-23-cmake add_custom_command","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkn001b57whf4eecfqb","content":"<p>ç›®çš„ï¼š æ·»åŠ è‡ªå®šä¹‰çš„æ„å»ºè§„åˆ™åˆ°ç”Ÿæˆçš„æ„å»ºç³»ç»Ÿä¸­ã€‚</p>\n<p>æœ‰ä¸¤ç§ç”¨æ³•ï¼š</p>\n<ol>\n<li>ä½¿ç”¨å¤–éƒ¨å‘½ä»¤æ¥äº§ç”Ÿä¸€ä¸ªè¾“å‡º, ä¾‹å¦‚ç”Ÿæˆæ–‡ä»¶</li>\n<li>ç›‘å¬ä¸€ä¸ªtargetçš„æ„å»ºäº‹ä»¶ï¼Œåœ¨targetæ„å»ºå‰æˆ–è€…æ„å»ºåï¼Œæ‰§è¡Œå‘½ä»¤</li>\n</ol>\n<h1 id=\"Examples-Generating-Files\"><a href=\"#Examples-Generating-Files\" class=\"headerlink\" title=\"Examples: Generating Files\"></a>Examples: Generating Files</h1><p>æ·»åŠ å‘½ä»¤ï¼Œæ‰§è¡Œåç”Ÿæˆæºæ–‡ä»¶</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-built_in\">add_custom_command</span>(<br>  OUTPUT out<span class=\"hljs-selector-class\">.c</span><br>  COMMAND someTool -<span class=\"hljs-selector-tag\">i</span> $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/<span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.txt</span><br>                   -o out<span class=\"hljs-selector-class\">.c</span><br>  DEPENDS $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/<span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.txt</span><br>  VERBATIM)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_library</span><span class=\"hljs-params\">(myLib out.c)</span></span><br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼Œä¸ºæ¯ä¸ªconfigæŒ‡å®šä¸åŒçš„è¾“å‡º</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-built_in\">add_custom_command</span>(<br>  OUTPUT <span class=\"hljs-string\">&quot;out-$&lt;CONFIG&gt;.c&quot;</span><br>  COMMAND someTool -<span class=\"hljs-selector-tag\">i</span> $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/<span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.txt</span><br>                   -o <span class=\"hljs-string\">&quot;out-$&lt;CONFIG&gt;.c&quot;</span><br>                   -c <span class=\"hljs-string\">&quot;$&lt;CONFIG&gt;&quot;</span><br>  DEPENDS $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/<span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.txt</span><br>  VERBATIM)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_library</span><span class=\"hljs-params\">(myLib <span class=\"hljs-string\">&quot;out-$&lt;CONFIG&gt;.c&quot;</span>)</span></span><br></code></pre></td></tr></table></figure>\n\n<h1 id=\"Examples-Build-Events\"><a href=\"#Examples-Build-Events\" class=\"headerlink\" title=\"Examples: Build Events\"></a>Examples: Build Events</h1><p>åœ¨targetè¢«æ„å»ºï¼Œé“¾æ¥ä¹‹åï¼Œæ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myExe myExe.c)</span></span><br><span class=\"hljs-built_in\">add_custom_command</span>(<br>  TARGET myExe POST_BUILD<br>  COMMAND someHasher -<span class=\"hljs-selector-tag\">i</span> <span class=\"hljs-string\">&quot;$&lt;TARGET_FILE:myExe&gt;&quot;</span><br>                     -o <span class=\"hljs-string\">&quot;$&lt;TARGET_FILE:myExe&gt;.hash&quot;</span><br>  VERBATIM)<br></code></pre></td></tr></table></figure>\n\n<p>ç›®å‰æ”¯æŒä¸¤ç§</p>\n<ul>\n<li>PRE_LINK ç¼–è¯‘åï¼Œè¿æ¥å‰æ‰§è¡Œå‘½ä»¤</li>\n<li>POST_BUILD æ„å»ºåï¼ŒæˆåŠŸé“¾æ¥åæ‰§è¡Œå‘½ä»¤</li>\n</ul>\n","excerpt":"","more":"<p>ç›®çš„ï¼š æ·»åŠ è‡ªå®šä¹‰çš„æ„å»ºè§„åˆ™åˆ°ç”Ÿæˆçš„æ„å»ºç³»ç»Ÿä¸­ã€‚</p>\n<p>æœ‰ä¸¤ç§ç”¨æ³•ï¼š</p>\n<ol>\n<li>ä½¿ç”¨å¤–éƒ¨å‘½ä»¤æ¥äº§ç”Ÿä¸€ä¸ªè¾“å‡º, ä¾‹å¦‚ç”Ÿæˆæ–‡ä»¶</li>\n<li>ç›‘å¬ä¸€ä¸ªtargetçš„æ„å»ºäº‹ä»¶ï¼Œåœ¨targetæ„å»ºå‰æˆ–è€…æ„å»ºåï¼Œæ‰§è¡Œå‘½ä»¤</li>\n</ol>\n<h1 id=\"Examples-Generating-Files\"><a href=\"#Examples-Generating-Files\" class=\"headerlink\" title=\"Examples: Generating Files\"></a>Examples: Generating Files</h1><p>æ·»åŠ å‘½ä»¤ï¼Œæ‰§è¡Œåç”Ÿæˆæºæ–‡ä»¶</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-built_in\">add_custom_command</span>(<br>  OUTPUT out<span class=\"hljs-selector-class\">.c</span><br>  COMMAND someTool -<span class=\"hljs-selector-tag\">i</span> $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/<span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.txt</span><br>                   -o out<span class=\"hljs-selector-class\">.c</span><br>  DEPENDS $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/<span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.txt</span><br>  VERBATIM)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_library</span><span class=\"hljs-params\">(myLib out.c)</span></span><br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼Œä¸ºæ¯ä¸ªconfigæŒ‡å®šä¸åŒçš„è¾“å‡º</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-built_in\">add_custom_command</span>(<br>  OUTPUT <span class=\"hljs-string\">&quot;out-$&lt;CONFIG&gt;.c&quot;</span><br>  COMMAND someTool -<span class=\"hljs-selector-tag\">i</span> $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/<span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.txt</span><br>                   -o <span class=\"hljs-string\">&quot;out-$&lt;CONFIG&gt;.c&quot;</span><br>                   -c <span class=\"hljs-string\">&quot;$&lt;CONFIG&gt;&quot;</span><br>  DEPENDS $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/<span class=\"hljs-keyword\">in</span><span class=\"hljs-selector-class\">.txt</span><br>  VERBATIM)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_library</span><span class=\"hljs-params\">(myLib <span class=\"hljs-string\">&quot;out-$&lt;CONFIG&gt;.c&quot;</span>)</span></span><br></code></pre></td></tr></table></figure>\n\n<h1 id=\"Examples-Build-Events\"><a href=\"#Examples-Build-Events\" class=\"headerlink\" title=\"Examples: Build Events\"></a>Examples: Build Events</h1><p>åœ¨targetè¢«æ„å»ºï¼Œé“¾æ¥ä¹‹åï¼Œæ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myExe myExe.c)</span></span><br><span class=\"hljs-built_in\">add_custom_command</span>(<br>  TARGET myExe POST_BUILD<br>  COMMAND someHasher -<span class=\"hljs-selector-tag\">i</span> <span class=\"hljs-string\">&quot;$&lt;TARGET_FILE:myExe&gt;&quot;</span><br>                     -o <span class=\"hljs-string\">&quot;$&lt;TARGET_FILE:myExe&gt;.hash&quot;</span><br>  VERBATIM)<br></code></pre></td></tr></table></figure>\n\n<p>ç›®å‰æ”¯æŒä¸¤ç§</p>\n<ul>\n<li>PRE_LINK ç¼–è¯‘åï¼Œè¿æ¥å‰æ‰§è¡Œå‘½ä»¤</li>\n<li>POST_BUILD æ„å»ºåï¼ŒæˆåŠŸé“¾æ¥åæ‰§è¡Œå‘½ä»¤</li>\n</ul>\n"},{"layout":"post","title":"cmake Importing and Exporting Guide","date":"2022-10-23T16:00:00.000Z","_content":"\nå‚è€ƒï¼šhttps://cmake.org/cmake/help/latest/guide/importing-exporting/index.html \n\n# Importing\n\nIMPORTED targets å°†cmakeå·¥ç¨‹å¤–éƒ¨çš„åº“ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¼•å…¥åˆ°å½“å‰çš„cmakeå·¥ç¨‹ä¸­ï¼Œè¢«å¼•å…¥çš„å†…å®¹ä¼šå…³è”åˆ°ä¸€ä¸ªcmake ä¸­ä¸€ä¸ª\né€»è¾‘ä¸Šçš„targetã€‚\n\nåˆ›å»ºæ–¹å¼ï¼Œè°ƒç”¨`add_executable()`,`add_library()`å‘½ä»¤åˆ›å»ºtargetï¼Œ ä½†æ˜¯è¦æ·»åŠ `IMPORTED`å‚æ•°ã€‚\n\nè¿™ä¸ªIMPORTED targetä¸äº§ç”Ÿä»»ä½•æ„å»ºæ–‡ä»¶ï¼Œå› ä¸ºä»–ä»¬å¼•å…¥çš„éƒ½æ˜¯ç°æˆçš„åº“æˆ–è€…å¯æ‰§è¡Œæ–‡ä»¶ã€‚\n\nä¸€æ—¦IMPORTED target è¢«åˆ›å»ºå¥½äº†ï¼Œå°±å¯ä»¥åƒå·¥ç¨‹ä¸­çš„å…¶ä»–targetä¸€æ ·è¢«å¼•ç”¨äº†ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå°±å¯ä»¥æ–¹ä¾¿ï¼Œçµæ´»å¼•ç”¨å¤–éƒ¨å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“äº†ã€‚\n\n## Importing Executables\n\nä½¿ç”¨ç£ç›˜ä¸Šçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚\n\n```\nadd_executable(myexe IMPORTED)\nset_property(TARGET myexe PROPERTY\n             IMPORTED_LOCATION \"../InstallMyExe/bin/myexe\")\nadd_custom_command(OUTPUT main.cc COMMAND myexe)\nadd_executable(mynewexe main.cc)\n```\n\n1. åˆ›å»ºä¸€ä¸ªIMPORTED target\n2. è®¾ç½®targetç›¸å…³å±æ€§ï¼Œè¿™é‡ŒæŒ‡å®šå…¶å…³è”çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„\n3. æ·»åŠ äº†ä¸€ä¸ªcustom commandï¼Œ ç”¨target myexeæŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶æ¥ç”Ÿæˆæ–‡ä»¶`main.cc`\n4. åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¯æ‰§è¡Œtarget, ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„`main.cc`ä½œä¸ºæºæ–‡ä»¶\n\n## Importing Libraries\n\nå¯¼å…¥å·²ç»æ„å»ºå¥½çš„åº“ä½œä¸ºä¸€ä¸ªtargetæ¥ä½¿ç”¨ã€‚\n```\nadd_library(foo STATIC IMPORTED)\nset_property(TARGET foo PROPERTY\n             IMPORTED_LOCATION \"/path/to/libfoo.a\")\nadd_executable(myexe src1.c src2.c)\ntarget_link_libraries(myexe PRIVATE foo)\n```\n\n1. åˆ›å»ºä¸€ä¸ªIMPORTED target\n2. è®¾ç½®targetç›¸å…³å±æ€§ï¼Œè¿™é‡ŒæŒ‡å®šå…¶å…³è”çš„é™æ€åº“è·¯å¾„\n3. åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¯æ‰§è¡Œtarget myexeï¼Œé“¾æ¥ä¸Šé¢åˆ›å»ºçš„target foo\n\nè€ƒè™‘åˆ°å¯èƒ½ä¼šæœ‰debugï¼Œrelease ç­‰ä¸åŒé…ç½®ï¼Œå¼•å…¥å…·æœ‰ä¸åŒé…ç½®çš„åŒä¸€ä¸ªåº“ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å½¢å¼\n```\nfind_library(math_REL NAMES m)\nfind_library(math_DBG NAMES md)\nadd_library(math STATIC IMPORTED GLOBAL)\nset_target_properties(math PROPERTIES\n  IMPORTED_LOCATION \"${math_REL}\"\n  IMPORTED_LOCATION_DEBUG \"${math_DBG}\"\n  IMPORTED_CONFIGURATIONS \"RELEASE;DEBUG\"\n)\nadd_executable(myexe src1.c src2.c)\ntarget_link_libraries(myexe PRIVATE math)\n```\n# Exporting Targets\n> While IMPORTED targets on their own are useful, they still require that the project that imports them knows the locations of the target files on disk. The real power of IMPORTED targets is when the project providing the target files also provides a CMake file to help import them. A project can be setup to produce the necessary information so that it can easily be used by other CMake projects be it from a build directory, a local install or when packaged.\n\n1. IMPORTED targets è¦æ±‚ä½¿ç”¨è¿™äº›targetçš„å·¥ç¨‹ï¼ŒçŸ¥é“ç›¸å…³æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ã€‚\n2. è¦æƒ³å±è”½è¿™äº›ç»†èŠ‚ï¼Œåº“çš„æä¾›æ–¹ï¼ŒåŒæ—¶æä¾›ä¸€ä¸ªå¯¼å…¥è¿™ä¸ªåº“çš„å¸®åŠ©æ–‡ä»¶ `xxxTargets.cmake`\n3. è¦æƒ³ç”Ÿæˆçš„åº“ï¼Œå¯ä»¥é€šè¿‡`find_package()`å‘½ä»¤æ¥ç´¢å¼•ä½¿ç”¨çš„è¯ï¼Œå¯ä»¥åœ¨cmakeå·¥ç¨‹ä¸­é…ç½®ï¼Œåœ¨æ„å»ºå·¥ç¨‹çš„æ—¶å€™ï¼ŒåŒæ—¶ç”Ÿæˆå¯¹åº”çš„å¸®åŠ©æ–‡ä»¶\n    - `xxxTargets.cmake`\n    - `xxxConfig.cmake`\n    - `xxxConfigVersion.cmake`\n\n## `xxxTargets.cmake`\n\n```\ncmake_minimum_required(VERSION 3.15)\nproject(MathFunctions)\n\n# make cache variables for install destinations\ninclude(GNUInstallDirs)\n\n# specify the C++ standard\nset(CMAKE_CXX_STANDARD 11)\nset(CMAKE_CXX_STANDARD_REQUIRED True)\n\n# create library\nadd_library(MathFunctions STATIC MathFunctions.cxx)\n\n# add include directories\ntarget_include_directories(MathFunctions\n                           PUBLIC\n                           \"$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>\"\n                           \"$<INSTALL_INTERFACE:${CMAKE_INSTALL_INCLUDEDIR}>\"\n)\n\n# install the target and create export-set\ninstall(TARGETS MathFunctions\n        EXPORT MathFunctionsTargets\n        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}\n        ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}\n        RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n        INCLUDES DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}\n)\n\n# install header file\ninstall(FILES MathFunctions.h DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})\n\n# generate and install export file\ninstall(EXPORT MathFunctionsTargets\n        FILE MathFunctionsTargets.cmake\n        NAMESPACE MathFunctions::\n        DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/MathFunctions\n)\n# create IMPORTED target, set target property\nadd_library(MathFunctions::MathFunctions STATIC IMPORTED)\nset_target_properties(MathFunctions::MathFunctions PROPERTIES\n  INTERFACE_INCLUDE_DIRECTORIES \"${_IMPORT_PREFIX}/include\"\n)\n```\n\n1. åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„é™æ€åº“\n2. è®¾ç½®é™æ€åº“å¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œåˆ†åˆ«æŒ‡å®šæ„å»ºæ—¶å’Œå®‰è£…åçš„è·¯å¾„\n3. åˆ›å»ºä¸€ä¸ªinstallå‘½ä»¤ï¼ŒæŒ‡å®šç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…è·¯å¾„ã€‚å…¶ä¸­`EXPORT MathFunctionsTargets`,æŒ‡å®šäº†å¯¼å‡ºtargetæ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶åå­—æ˜¯`MathFunctionsTargets.cmake`\n4. æŒ‡å®šå¤´æ–‡ä»¶å¦‚ä½•å®‰è£…\n5. æŒ‡å®š`MathFunctionsTargets.cmake`æ–‡ä»¶å¦‚ä½•å®‰è£…ï¼Œ`NAMESPACE MathFunctions::` ç»™å¯¼å‡ºçš„targetæ·»åŠ å‰ç¼€å‘½åç©ºé—´ï¼Œä¸€èˆ¬å¸¦æœ‰å‘½åç©ºé—´çš„targetï¼Œéƒ½æ˜¯`IMPORTED target`\n6. åˆ›å»ºä¸€ä¸ª`IMPORTED target`,åå­—æ˜¯`MathFunctions::MathFunctions`\n7. è®¾ç½®`MathFunctions::MathFunctions`çš„å±æ€§ï¼Œæ­¤å¤„æ˜¯å¤´æ–‡ä»¶è·¯å¾„\n\n\nå¦‚ä½•ä½¿ç”¨å¯¼å‡ºçš„targetæ–‡ä»¶, åœ¨`CMakeLists.txt`æ–‡ä»¶ä¸­\n```\n include(${INSTALL_PREFIX}/lib/cmake/MathFunctionTargets.cmake)\n add_executable(myexe src1.c src2.c )\n target_link_libraries(myexe PRIVATE MathFunctions::MathFunctions)\n```\n1. é¦–å…ˆåŒ…å«`/MathFunctionTargets.cmake`æ–‡ä»¶\n2. åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œç›®æ ‡myexe\n3. é“¾æ¥MathFunctions::MathFunctionsåˆ°myexe\n\n## æ”¯æŒ`find_package()`\n\nä½¿ç”¨ç¤ºä¾‹ï¼š\n\n```\nfind_package(Stats 2.6.4 REQUIRED)\ntarget_link_libraries(MathFunctions PUBLIC Stats::Types)\n```\n\nfind_package() æ”¯æŒä¸¤ç§æœç´¢æ¨¡å¼\n- module modeï¼Œ é’ˆå¯¹écmakeæ„å»ºçš„åº“ï¼Œæœç´¢`Find<PackageName>.cmake`æ–‡ä»¶\n- config modeï¼Œ é’ˆå¯¹cmakeæ„å»ºçš„åº“ï¼Œç›¸å…³æ–‡ä»¶ä¸º\n    - targetç›¸å…³ï¼š `<lowercasePackageName>-config.cmake`æˆ–è€…`<PackageName>Config.cmake`\n    - ç‰ˆæœ¬ç›¸å…³ï¼š `<lowercasePackageName>-config-version.cmake` æˆ– `<PackageName>ConfigVersion.cmake`\n\nå› æ­¤ï¼Œcmakeæ„å»ºçš„åº“ï¼Œæƒ³è¦æ”¯æŒ`find_package()`çš„configæ¨¡å¼ï¼Œéœ€è¦æä¾›\n- `xxxConfig.cmake`\n- `xxConfigVersion.cmake`\n\n\né¦–å…ˆåŒ…å«`CMakePackageConfigHelpers`æ¨¡å—\n```\ninclude(CMakePackageConfigHelpers)\n```\n\n### Creating a Package Configuration File\n\nä½¿ç”¨`CMakePackageConfigHelpers`æ¨¡å—ä¸­çš„`configure_package_config_file`å‘½ä»¤æ¥ç”Ÿæˆ`MathFunctionsConfig.cmake`æ–‡ä»¶ï¼Œè“æœ¬æ˜¯`Config.cmake.in`,åŒæ—¶æŒ‡å®šç”Ÿæˆåçš„è·¯å¾„ã€‚\n\n```\nconfigure_package_config_file(${CMAKE_CURRENT_SOURCE_DIR}/Config.cmake.in\n  \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfig.cmake\"\n  INSTALL_DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/MathFunctions\n)\n```\n\né€šè¿‡`isntall`å‘½ä»¤æŒ‡å®š`xxxConfig.cmake`å’Œ`xxxConfigVersion.cmake`æ–‡ä»¶å®‰è£…è§„åˆ™\n```\ninstall(FILES\n          \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfig.cmake\"\n          \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfigVersion.cmake\"\n        DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/MathFunctions\n)\n```\n\nå…³äº`Config.cmake.in`æ–‡ä»¶\n```\n@PACKAGE_INIT@\n\ninclude(\"${CMAKE_CURRENT_LIST_DIR}/MathFunctionsTargets.cmake\")\n\ncheck_required_components(MathFunctions)\n```\n\n`@PACKAGE_INIT@` åœ¨é…ç½®çš„æ—¶å€™ï¼Œä¼šè¢«æ›¿æ¢å’Œå±•å¼€ï¼Œå±•å¼€ååŒ…å«\n1. ä»¥`PACKAGE_`ä¸ºå‰ç¼€çš„ç›¸å¯¹è·¯å¾„\n2. `set_and_check()` å’Œ `heck_required_components()`ä¸¤ä¸ªå®å®šä¹‰ã€‚\n\n\n`check_required_components` é’ˆå¯¹æ‰€æœ‰çš„ç»„ä»¶ï¼Œç»™`<Package>_<Component>_FOUND`å˜é‡èµ‹å€¼ï¼Œ æ‰¾åˆ°ä¸º`TRUE`,æ‰¾ä¸åˆ°ä¸º`FALSE`ã€‚ åŒæ—¶ç»™`<Package>_FOUND`å˜é‡èµ‹å€¼ï¼Œ å¦‚æœç»“æœä¸º`FALSE`,è®¤ä¸ºè¯¥packageæ²¡æœ‰æ‰¾åˆ°ã€‚\n\n`set_and_check`ä¸»è¦ç»™å¯¹åº”çš„ç›®å½•å’Œæ–‡ä»¶è·¯å¾„èµ‹å€¼ï¼Œå¦‚æœå¼•ç”¨çš„æ–‡ä»¶æˆ–è·¯å¾„æ²¡æœ‰æ‰¾åˆ°ï¼Œè¯¥å®æ‰§è¡Œå¤±è´¥ã€‚\n### Creating a Package Version File\n\n`CMakePackageConfigHelpers`æ¨¡å—ï¼Œæä¾›äº†`write_basic_package_version_file()`å‘½ä»¤æ¥ç”Ÿæˆ`xxConfigVersion.cmake`æ–‡ä»¶ã€‚ å½“`find_package()`å‘½ä»¤æŒ‡å®šäº†ç‰ˆæœ¬å·çš„æ—¶å€™ï¼Œ cmake ä¼šè¯»å–è¯¥æ–‡ä»¶æ¥è·å–ç‰ˆæœ¬å·ä¿¡æ¯åšåŒ¹é…\n\n```\nset(version 3.4.1)\n\nset_property(TARGET MathFunctions PROPERTY VERSION ${version})\nset_property(TARGET MathFunctions PROPERTY SOVERSION 3)\nset_property(TARGET MathFunctions PROPERTY\n  INTERFACE_MathFunctions_MAJOR_VERSION 3)\nset_property(TARGET MathFunctions APPEND PROPERTY\n  COMPATIBLE_INTERFACE_STRING MathFunctions_MAJOR_VERSION\n)\n\n# generate the version file for the config file\nwrite_basic_package_version_file(\n  \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfigVersion.cmake\"\n  VERSION \"${version}\"\n  COMPATIBILITY AnyNewerVersion\n)\n```\n\n1. è®¾ç½®targetçš„ç‰ˆæœ¬å·ç›¸å…³çš„å˜é‡\n2. å°†ç‰ˆæœ¬å·ä¿¡æ¯ï¼Œå†™å…¥`MathFunctionsConfigVersion.cmake`æ–‡ä»¶\n\n\næ­¤æ—¶å·²ç»é…ç½®å¥½å¦‚ä½•ç”Ÿæˆ`xxxConfig.cmake`å’Œ`xxxConfigVersion.cmake`æ–‡ä»¶.\næ‰§è¡Œæ„å»ºï¼Œå®‰è£…\n```\nmkdir build \ncd build \ncmake ..\ncmake --build .\ncmake --install . --prefix `<prefix>`\n```\n\nè§‚å¯Ÿè¾“å‡º, å¯¹åº”çš„æ–‡ä»¶å·²ç»ç”Ÿæˆ\n```\nMathFunctionsConfig.cmake\nMathFunctionsConfigVersion.cmake\nMathFunctionsTargets-noconfig.cmake\nMathFunctionsTargets.cmake\n```\nä½¿ç”¨`find_package()`æ¥ä½¿ç”¨ç”Ÿæˆconfigæ–‡ä»¶, æ­¤æ—¶éœ€è¦é€šè¿‡`CMAKE_PREFIX_PATH`æ¥æŒ‡å®šconfigæ–‡ä»¶çš„æœç½—è·¯å¾„ã€‚\n\n```\ncmake_minimum_required(VERSION 3.15)\nproject(Downstream)\n\n# specify the C++ standard\nset(CMAKE_CXX_STANDARD 11)\nset(CMAKE_CXX_STANDARD_REQUIRED True)\n\nfind_package(MathFunctions 3.4.1 EXACT)\n\nadd_executable(myexe main.cc)\ntarget_link_libraries(myexe PRIVATE MathFunctions::MathFunctions)\n```\n\næ³¨æ„ï¼š\nå¯¼å‡ºé…ç½®ï¼Œä¸åº”è¯¥å¼•ç”¨ç»å¯¹è·¯å¾„ï¼Œåº”å½“å…³è”ç›¸å¯¹è·¯å¾„ï¼Œè¿™æ ·ï¼Œæ— è®ºå®‰è£…åœ¨å“ªé‡Œï¼Œéƒ½å¯ä»¥é€šè¿‡configæ–‡ä»¶æ­£ç¡®ç´¢å¼•åˆ°åº“ã€‚\n\n1. ä¸åº”å½“æ˜¾ç¤ºçš„ä¾èµ–`CMAKE_INSTALL_PREFIX`\n\n```\ntarget_include_directories(tgt INTERFACE\n  # Wrong, not relocatable:\n  $<INSTALL_INTERFACE:${CMAKE_INSTALL_PREFIX}/include/TgtName>\n)\n\ntarget_include_directories(tgt INTERFACE\n  # Ok, relocatable:\n  $<INSTALL_INTERFACE:include/TgtName>\n)\n```\n\n2. å¯ä»¥ä½¿ç”¨`$<INSTALL_PREFIX> generator expression`\n\n```\ntarget_include_directories(tgt INTERFACE\n  # Ok, relocatable:\n  $<INSTALL_INTERFACE:$<INSTALL_PREFIX>/include/TgtName>\n)\n```\n\n\n\n\n\n\n\n","source":"_posts/cmake/2022-10-24-cmake Importing and Exporting Guide.md","raw":"---\nlayout: post\ntitle: \"cmake Importing and Exporting Guide\"\ndate: 2022-10-24\ntag: cmake\n---\n\nå‚è€ƒï¼šhttps://cmake.org/cmake/help/latest/guide/importing-exporting/index.html \n\n# Importing\n\nIMPORTED targets å°†cmakeå·¥ç¨‹å¤–éƒ¨çš„åº“ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¼•å…¥åˆ°å½“å‰çš„cmakeå·¥ç¨‹ä¸­ï¼Œè¢«å¼•å…¥çš„å†…å®¹ä¼šå…³è”åˆ°ä¸€ä¸ªcmake ä¸­ä¸€ä¸ª\né€»è¾‘ä¸Šçš„targetã€‚\n\nåˆ›å»ºæ–¹å¼ï¼Œè°ƒç”¨`add_executable()`,`add_library()`å‘½ä»¤åˆ›å»ºtargetï¼Œ ä½†æ˜¯è¦æ·»åŠ `IMPORTED`å‚æ•°ã€‚\n\nè¿™ä¸ªIMPORTED targetä¸äº§ç”Ÿä»»ä½•æ„å»ºæ–‡ä»¶ï¼Œå› ä¸ºä»–ä»¬å¼•å…¥çš„éƒ½æ˜¯ç°æˆçš„åº“æˆ–è€…å¯æ‰§è¡Œæ–‡ä»¶ã€‚\n\nä¸€æ—¦IMPORTED target è¢«åˆ›å»ºå¥½äº†ï¼Œå°±å¯ä»¥åƒå·¥ç¨‹ä¸­çš„å…¶ä»–targetä¸€æ ·è¢«å¼•ç”¨äº†ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå°±å¯ä»¥æ–¹ä¾¿ï¼Œçµæ´»å¼•ç”¨å¤–éƒ¨å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“äº†ã€‚\n\n## Importing Executables\n\nä½¿ç”¨ç£ç›˜ä¸Šçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚\n\n```\nadd_executable(myexe IMPORTED)\nset_property(TARGET myexe PROPERTY\n             IMPORTED_LOCATION \"../InstallMyExe/bin/myexe\")\nadd_custom_command(OUTPUT main.cc COMMAND myexe)\nadd_executable(mynewexe main.cc)\n```\n\n1. åˆ›å»ºä¸€ä¸ªIMPORTED target\n2. è®¾ç½®targetç›¸å…³å±æ€§ï¼Œè¿™é‡ŒæŒ‡å®šå…¶å…³è”çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„\n3. æ·»åŠ äº†ä¸€ä¸ªcustom commandï¼Œ ç”¨target myexeæŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶æ¥ç”Ÿæˆæ–‡ä»¶`main.cc`\n4. åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¯æ‰§è¡Œtarget, ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„`main.cc`ä½œä¸ºæºæ–‡ä»¶\n\n## Importing Libraries\n\nå¯¼å…¥å·²ç»æ„å»ºå¥½çš„åº“ä½œä¸ºä¸€ä¸ªtargetæ¥ä½¿ç”¨ã€‚\n```\nadd_library(foo STATIC IMPORTED)\nset_property(TARGET foo PROPERTY\n             IMPORTED_LOCATION \"/path/to/libfoo.a\")\nadd_executable(myexe src1.c src2.c)\ntarget_link_libraries(myexe PRIVATE foo)\n```\n\n1. åˆ›å»ºä¸€ä¸ªIMPORTED target\n2. è®¾ç½®targetç›¸å…³å±æ€§ï¼Œè¿™é‡ŒæŒ‡å®šå…¶å…³è”çš„é™æ€åº“è·¯å¾„\n3. åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¯æ‰§è¡Œtarget myexeï¼Œé“¾æ¥ä¸Šé¢åˆ›å»ºçš„target foo\n\nè€ƒè™‘åˆ°å¯èƒ½ä¼šæœ‰debugï¼Œrelease ç­‰ä¸åŒé…ç½®ï¼Œå¼•å…¥å…·æœ‰ä¸åŒé…ç½®çš„åŒä¸€ä¸ªåº“ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å½¢å¼\n```\nfind_library(math_REL NAMES m)\nfind_library(math_DBG NAMES md)\nadd_library(math STATIC IMPORTED GLOBAL)\nset_target_properties(math PROPERTIES\n  IMPORTED_LOCATION \"${math_REL}\"\n  IMPORTED_LOCATION_DEBUG \"${math_DBG}\"\n  IMPORTED_CONFIGURATIONS \"RELEASE;DEBUG\"\n)\nadd_executable(myexe src1.c src2.c)\ntarget_link_libraries(myexe PRIVATE math)\n```\n# Exporting Targets\n> While IMPORTED targets on their own are useful, they still require that the project that imports them knows the locations of the target files on disk. The real power of IMPORTED targets is when the project providing the target files also provides a CMake file to help import them. A project can be setup to produce the necessary information so that it can easily be used by other CMake projects be it from a build directory, a local install or when packaged.\n\n1. IMPORTED targets è¦æ±‚ä½¿ç”¨è¿™äº›targetçš„å·¥ç¨‹ï¼ŒçŸ¥é“ç›¸å…³æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ã€‚\n2. è¦æƒ³å±è”½è¿™äº›ç»†èŠ‚ï¼Œåº“çš„æä¾›æ–¹ï¼ŒåŒæ—¶æä¾›ä¸€ä¸ªå¯¼å…¥è¿™ä¸ªåº“çš„å¸®åŠ©æ–‡ä»¶ `xxxTargets.cmake`\n3. è¦æƒ³ç”Ÿæˆçš„åº“ï¼Œå¯ä»¥é€šè¿‡`find_package()`å‘½ä»¤æ¥ç´¢å¼•ä½¿ç”¨çš„è¯ï¼Œå¯ä»¥åœ¨cmakeå·¥ç¨‹ä¸­é…ç½®ï¼Œåœ¨æ„å»ºå·¥ç¨‹çš„æ—¶å€™ï¼ŒåŒæ—¶ç”Ÿæˆå¯¹åº”çš„å¸®åŠ©æ–‡ä»¶\n    - `xxxTargets.cmake`\n    - `xxxConfig.cmake`\n    - `xxxConfigVersion.cmake`\n\n## `xxxTargets.cmake`\n\n```\ncmake_minimum_required(VERSION 3.15)\nproject(MathFunctions)\n\n# make cache variables for install destinations\ninclude(GNUInstallDirs)\n\n# specify the C++ standard\nset(CMAKE_CXX_STANDARD 11)\nset(CMAKE_CXX_STANDARD_REQUIRED True)\n\n# create library\nadd_library(MathFunctions STATIC MathFunctions.cxx)\n\n# add include directories\ntarget_include_directories(MathFunctions\n                           PUBLIC\n                           \"$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>\"\n                           \"$<INSTALL_INTERFACE:${CMAKE_INSTALL_INCLUDEDIR}>\"\n)\n\n# install the target and create export-set\ninstall(TARGETS MathFunctions\n        EXPORT MathFunctionsTargets\n        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}\n        ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}\n        RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n        INCLUDES DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}\n)\n\n# install header file\ninstall(FILES MathFunctions.h DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})\n\n# generate and install export file\ninstall(EXPORT MathFunctionsTargets\n        FILE MathFunctionsTargets.cmake\n        NAMESPACE MathFunctions::\n        DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/MathFunctions\n)\n# create IMPORTED target, set target property\nadd_library(MathFunctions::MathFunctions STATIC IMPORTED)\nset_target_properties(MathFunctions::MathFunctions PROPERTIES\n  INTERFACE_INCLUDE_DIRECTORIES \"${_IMPORT_PREFIX}/include\"\n)\n```\n\n1. åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„é™æ€åº“\n2. è®¾ç½®é™æ€åº“å¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œåˆ†åˆ«æŒ‡å®šæ„å»ºæ—¶å’Œå®‰è£…åçš„è·¯å¾„\n3. åˆ›å»ºä¸€ä¸ªinstallå‘½ä»¤ï¼ŒæŒ‡å®šç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…è·¯å¾„ã€‚å…¶ä¸­`EXPORT MathFunctionsTargets`,æŒ‡å®šäº†å¯¼å‡ºtargetæ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶åå­—æ˜¯`MathFunctionsTargets.cmake`\n4. æŒ‡å®šå¤´æ–‡ä»¶å¦‚ä½•å®‰è£…\n5. æŒ‡å®š`MathFunctionsTargets.cmake`æ–‡ä»¶å¦‚ä½•å®‰è£…ï¼Œ`NAMESPACE MathFunctions::` ç»™å¯¼å‡ºçš„targetæ·»åŠ å‰ç¼€å‘½åç©ºé—´ï¼Œä¸€èˆ¬å¸¦æœ‰å‘½åç©ºé—´çš„targetï¼Œéƒ½æ˜¯`IMPORTED target`\n6. åˆ›å»ºä¸€ä¸ª`IMPORTED target`,åå­—æ˜¯`MathFunctions::MathFunctions`\n7. è®¾ç½®`MathFunctions::MathFunctions`çš„å±æ€§ï¼Œæ­¤å¤„æ˜¯å¤´æ–‡ä»¶è·¯å¾„\n\n\nå¦‚ä½•ä½¿ç”¨å¯¼å‡ºçš„targetæ–‡ä»¶, åœ¨`CMakeLists.txt`æ–‡ä»¶ä¸­\n```\n include(${INSTALL_PREFIX}/lib/cmake/MathFunctionTargets.cmake)\n add_executable(myexe src1.c src2.c )\n target_link_libraries(myexe PRIVATE MathFunctions::MathFunctions)\n```\n1. é¦–å…ˆåŒ…å«`/MathFunctionTargets.cmake`æ–‡ä»¶\n2. åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œç›®æ ‡myexe\n3. é“¾æ¥MathFunctions::MathFunctionsåˆ°myexe\n\n## æ”¯æŒ`find_package()`\n\nä½¿ç”¨ç¤ºä¾‹ï¼š\n\n```\nfind_package(Stats 2.6.4 REQUIRED)\ntarget_link_libraries(MathFunctions PUBLIC Stats::Types)\n```\n\nfind_package() æ”¯æŒä¸¤ç§æœç´¢æ¨¡å¼\n- module modeï¼Œ é’ˆå¯¹écmakeæ„å»ºçš„åº“ï¼Œæœç´¢`Find<PackageName>.cmake`æ–‡ä»¶\n- config modeï¼Œ é’ˆå¯¹cmakeæ„å»ºçš„åº“ï¼Œç›¸å…³æ–‡ä»¶ä¸º\n    - targetç›¸å…³ï¼š `<lowercasePackageName>-config.cmake`æˆ–è€…`<PackageName>Config.cmake`\n    - ç‰ˆæœ¬ç›¸å…³ï¼š `<lowercasePackageName>-config-version.cmake` æˆ– `<PackageName>ConfigVersion.cmake`\n\nå› æ­¤ï¼Œcmakeæ„å»ºçš„åº“ï¼Œæƒ³è¦æ”¯æŒ`find_package()`çš„configæ¨¡å¼ï¼Œéœ€è¦æä¾›\n- `xxxConfig.cmake`\n- `xxConfigVersion.cmake`\n\n\né¦–å…ˆåŒ…å«`CMakePackageConfigHelpers`æ¨¡å—\n```\ninclude(CMakePackageConfigHelpers)\n```\n\n### Creating a Package Configuration File\n\nä½¿ç”¨`CMakePackageConfigHelpers`æ¨¡å—ä¸­çš„`configure_package_config_file`å‘½ä»¤æ¥ç”Ÿæˆ`MathFunctionsConfig.cmake`æ–‡ä»¶ï¼Œè“æœ¬æ˜¯`Config.cmake.in`,åŒæ—¶æŒ‡å®šç”Ÿæˆåçš„è·¯å¾„ã€‚\n\n```\nconfigure_package_config_file(${CMAKE_CURRENT_SOURCE_DIR}/Config.cmake.in\n  \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfig.cmake\"\n  INSTALL_DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/MathFunctions\n)\n```\n\né€šè¿‡`isntall`å‘½ä»¤æŒ‡å®š`xxxConfig.cmake`å’Œ`xxxConfigVersion.cmake`æ–‡ä»¶å®‰è£…è§„åˆ™\n```\ninstall(FILES\n          \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfig.cmake\"\n          \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfigVersion.cmake\"\n        DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/MathFunctions\n)\n```\n\nå…³äº`Config.cmake.in`æ–‡ä»¶\n```\n@PACKAGE_INIT@\n\ninclude(\"${CMAKE_CURRENT_LIST_DIR}/MathFunctionsTargets.cmake\")\n\ncheck_required_components(MathFunctions)\n```\n\n`@PACKAGE_INIT@` åœ¨é…ç½®çš„æ—¶å€™ï¼Œä¼šè¢«æ›¿æ¢å’Œå±•å¼€ï¼Œå±•å¼€ååŒ…å«\n1. ä»¥`PACKAGE_`ä¸ºå‰ç¼€çš„ç›¸å¯¹è·¯å¾„\n2. `set_and_check()` å’Œ `heck_required_components()`ä¸¤ä¸ªå®å®šä¹‰ã€‚\n\n\n`check_required_components` é’ˆå¯¹æ‰€æœ‰çš„ç»„ä»¶ï¼Œç»™`<Package>_<Component>_FOUND`å˜é‡èµ‹å€¼ï¼Œ æ‰¾åˆ°ä¸º`TRUE`,æ‰¾ä¸åˆ°ä¸º`FALSE`ã€‚ åŒæ—¶ç»™`<Package>_FOUND`å˜é‡èµ‹å€¼ï¼Œ å¦‚æœç»“æœä¸º`FALSE`,è®¤ä¸ºè¯¥packageæ²¡æœ‰æ‰¾åˆ°ã€‚\n\n`set_and_check`ä¸»è¦ç»™å¯¹åº”çš„ç›®å½•å’Œæ–‡ä»¶è·¯å¾„èµ‹å€¼ï¼Œå¦‚æœå¼•ç”¨çš„æ–‡ä»¶æˆ–è·¯å¾„æ²¡æœ‰æ‰¾åˆ°ï¼Œè¯¥å®æ‰§è¡Œå¤±è´¥ã€‚\n### Creating a Package Version File\n\n`CMakePackageConfigHelpers`æ¨¡å—ï¼Œæä¾›äº†`write_basic_package_version_file()`å‘½ä»¤æ¥ç”Ÿæˆ`xxConfigVersion.cmake`æ–‡ä»¶ã€‚ å½“`find_package()`å‘½ä»¤æŒ‡å®šäº†ç‰ˆæœ¬å·çš„æ—¶å€™ï¼Œ cmake ä¼šè¯»å–è¯¥æ–‡ä»¶æ¥è·å–ç‰ˆæœ¬å·ä¿¡æ¯åšåŒ¹é…\n\n```\nset(version 3.4.1)\n\nset_property(TARGET MathFunctions PROPERTY VERSION ${version})\nset_property(TARGET MathFunctions PROPERTY SOVERSION 3)\nset_property(TARGET MathFunctions PROPERTY\n  INTERFACE_MathFunctions_MAJOR_VERSION 3)\nset_property(TARGET MathFunctions APPEND PROPERTY\n  COMPATIBLE_INTERFACE_STRING MathFunctions_MAJOR_VERSION\n)\n\n# generate the version file for the config file\nwrite_basic_package_version_file(\n  \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfigVersion.cmake\"\n  VERSION \"${version}\"\n  COMPATIBILITY AnyNewerVersion\n)\n```\n\n1. è®¾ç½®targetçš„ç‰ˆæœ¬å·ç›¸å…³çš„å˜é‡\n2. å°†ç‰ˆæœ¬å·ä¿¡æ¯ï¼Œå†™å…¥`MathFunctionsConfigVersion.cmake`æ–‡ä»¶\n\n\næ­¤æ—¶å·²ç»é…ç½®å¥½å¦‚ä½•ç”Ÿæˆ`xxxConfig.cmake`å’Œ`xxxConfigVersion.cmake`æ–‡ä»¶.\næ‰§è¡Œæ„å»ºï¼Œå®‰è£…\n```\nmkdir build \ncd build \ncmake ..\ncmake --build .\ncmake --install . --prefix `<prefix>`\n```\n\nè§‚å¯Ÿè¾“å‡º, å¯¹åº”çš„æ–‡ä»¶å·²ç»ç”Ÿæˆ\n```\nMathFunctionsConfig.cmake\nMathFunctionsConfigVersion.cmake\nMathFunctionsTargets-noconfig.cmake\nMathFunctionsTargets.cmake\n```\nä½¿ç”¨`find_package()`æ¥ä½¿ç”¨ç”Ÿæˆconfigæ–‡ä»¶, æ­¤æ—¶éœ€è¦é€šè¿‡`CMAKE_PREFIX_PATH`æ¥æŒ‡å®šconfigæ–‡ä»¶çš„æœç½—è·¯å¾„ã€‚\n\n```\ncmake_minimum_required(VERSION 3.15)\nproject(Downstream)\n\n# specify the C++ standard\nset(CMAKE_CXX_STANDARD 11)\nset(CMAKE_CXX_STANDARD_REQUIRED True)\n\nfind_package(MathFunctions 3.4.1 EXACT)\n\nadd_executable(myexe main.cc)\ntarget_link_libraries(myexe PRIVATE MathFunctions::MathFunctions)\n```\n\næ³¨æ„ï¼š\nå¯¼å‡ºé…ç½®ï¼Œä¸åº”è¯¥å¼•ç”¨ç»å¯¹è·¯å¾„ï¼Œåº”å½“å…³è”ç›¸å¯¹è·¯å¾„ï¼Œè¿™æ ·ï¼Œæ— è®ºå®‰è£…åœ¨å“ªé‡Œï¼Œéƒ½å¯ä»¥é€šè¿‡configæ–‡ä»¶æ­£ç¡®ç´¢å¼•åˆ°åº“ã€‚\n\n1. ä¸åº”å½“æ˜¾ç¤ºçš„ä¾èµ–`CMAKE_INSTALL_PREFIX`\n\n```\ntarget_include_directories(tgt INTERFACE\n  # Wrong, not relocatable:\n  $<INSTALL_INTERFACE:${CMAKE_INSTALL_PREFIX}/include/TgtName>\n)\n\ntarget_include_directories(tgt INTERFACE\n  # Ok, relocatable:\n  $<INSTALL_INTERFACE:include/TgtName>\n)\n```\n\n2. å¯ä»¥ä½¿ç”¨`$<INSTALL_PREFIX> generator expression`\n\n```\ntarget_include_directories(tgt INTERFACE\n  # Ok, relocatable:\n  $<INSTALL_INTERFACE:$<INSTALL_PREFIX>/include/TgtName>\n)\n```\n\n\n\n\n\n\n\n","slug":"cmake/2022-10-24-cmake Importing and Exporting Guide","published":1,"updated":"2024-03-06T11:53:13.564Z","comments":1,"photos":[],"_id":"clti3glkn001d57whczziahqc","content":"<p>å‚è€ƒï¼š<a href=\"https://cmake.org/cmake/help/latest/guide/importing-exporting/index.html\">https://cmake.org/cmake/help/latest/guide/importing-exporting/index.html</a> </p>\n<h1 id=\"Importing\"><a href=\"#Importing\" class=\"headerlink\" title=\"Importing\"></a>Importing</h1><p>IMPORTED targets å°†cmakeå·¥ç¨‹å¤–éƒ¨çš„åº“ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¼•å…¥åˆ°å½“å‰çš„cmakeå·¥ç¨‹ä¸­ï¼Œè¢«å¼•å…¥çš„å†…å®¹ä¼šå…³è”åˆ°ä¸€ä¸ªcmake ä¸­ä¸€ä¸ª<br>é€»è¾‘ä¸Šçš„targetã€‚</p>\n<p>åˆ›å»ºæ–¹å¼ï¼Œè°ƒç”¨<code>add_executable()</code>,<code>add_library()</code>å‘½ä»¤åˆ›å»ºtargetï¼Œ ä½†æ˜¯è¦æ·»åŠ <code>IMPORTED</code>å‚æ•°ã€‚</p>\n<p>è¿™ä¸ªIMPORTED targetä¸äº§ç”Ÿä»»ä½•æ„å»ºæ–‡ä»¶ï¼Œå› ä¸ºä»–ä»¬å¼•å…¥çš„éƒ½æ˜¯ç°æˆçš„åº“æˆ–è€…å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>\n<p>ä¸€æ—¦IMPORTED target è¢«åˆ›å»ºå¥½äº†ï¼Œå°±å¯ä»¥åƒå·¥ç¨‹ä¸­çš„å…¶ä»–targetä¸€æ ·è¢«å¼•ç”¨äº†ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå°±å¯ä»¥æ–¹ä¾¿ï¼Œçµæ´»å¼•ç”¨å¤–éƒ¨å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“äº†ã€‚</p>\n<h2 id=\"Importing-Executables\"><a href=\"#Importing-Executables\" class=\"headerlink\" title=\"Importing Executables\"></a>Importing Executables</h2><p>ä½¿ç”¨ç£ç›˜ä¸Šçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myexe IMPORTED)</span></span><br><span class=\"hljs-built_in\">set_property</span>(TARGET myexe PROPERTY<br>             IMPORTED_LOCATION <span class=\"hljs-string\">&quot;../InstallMyExe/bin/myexe&quot;</span>)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_custom_command</span><span class=\"hljs-params\">(OUTPUT main.cc COMMAND myexe)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(mynewexe main.cc)</span></span><br></code></pre></td></tr></table></figure>\n\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªIMPORTED target</li>\n<li>è®¾ç½®targetç›¸å…³å±æ€§ï¼Œè¿™é‡ŒæŒ‡å®šå…¶å…³è”çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„</li>\n<li>æ·»åŠ äº†ä¸€ä¸ªcustom commandï¼Œ ç”¨target myexeæŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶æ¥ç”Ÿæˆæ–‡ä»¶<code>main.cc</code></li>\n<li>åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¯æ‰§è¡Œtarget, ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„<code>main.cc</code>ä½œä¸ºæºæ–‡ä»¶</li>\n</ol>\n<h2 id=\"Importing-Libraries\"><a href=\"#Importing-Libraries\" class=\"headerlink\" title=\"Importing Libraries\"></a>Importing Libraries</h2><p>å¯¼å…¥å·²ç»æ„å»ºå¥½çš„åº“ä½œä¸ºä¸€ä¸ªtargetæ¥ä½¿ç”¨ã€‚</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">add_library</span><span class=\"hljs-params\">(foo STATIC IMPORTED)</span></span><br><span class=\"hljs-built_in\">set_property</span>(TARGET foo PROPERTY<br>             IMPORTED_LOCATION <span class=\"hljs-string\">&quot;/path/to/libfoo.a&quot;</span>)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myexe src1.c src2.c)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">target_link_libraries</span><span class=\"hljs-params\">(myexe PRIVATE foo)</span></span><br></code></pre></td></tr></table></figure>\n\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªIMPORTED target</li>\n<li>è®¾ç½®targetç›¸å…³å±æ€§ï¼Œè¿™é‡ŒæŒ‡å®šå…¶å…³è”çš„é™æ€åº“è·¯å¾„</li>\n<li>åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¯æ‰§è¡Œtarget myexeï¼Œé“¾æ¥ä¸Šé¢åˆ›å»ºçš„target foo</li>\n</ol>\n<p>è€ƒè™‘åˆ°å¯èƒ½ä¼šæœ‰debugï¼Œrelease ç­‰ä¸åŒé…ç½®ï¼Œå¼•å…¥å…·æœ‰ä¸åŒé…ç½®çš„åŒä¸€ä¸ªåº“ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å½¢å¼</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">find_library</span><span class=\"hljs-params\">(math_REL NAMES m)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">find_library</span><span class=\"hljs-params\">(math_DBG NAMES md)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">add_library</span><span class=\"hljs-params\">(math STATIC IMPORTED GLOBAL)</span></span><br><span class=\"hljs-built_in\">set_target_properties</span>(math PROPERTIES<br>  IMPORTED_LOCATION <span class=\"hljs-string\">&quot;$&#123;math_REL&#125;&quot;</span><br>  IMPORTED_LOCATION_DEBUG <span class=\"hljs-string\">&quot;$&#123;math_DBG&#125;&quot;</span><br>  IMPORTED_CONFIGURATIONS <span class=\"hljs-string\">&quot;RELEASE;DEBUG&quot;</span><br>)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myexe src1.c src2.c)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">target_link_libraries</span><span class=\"hljs-params\">(myexe PRIVATE math)</span></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"Exporting-Targets\"><a href=\"#Exporting-Targets\" class=\"headerlink\" title=\"Exporting Targets\"></a>Exporting Targets</h1><blockquote>\n<p>While IMPORTED targets on their own are useful, they still require that the project that imports them knows the locations of the target files on disk. The real power of IMPORTED targets is when the project providing the target files also provides a CMake file to help import them. A project can be setup to produce the necessary information so that it can easily be used by other CMake projects be it from a build directory, a local install or when packaged.</p>\n</blockquote>\n<ol>\n<li>IMPORTED targets è¦æ±‚ä½¿ç”¨è¿™äº›targetçš„å·¥ç¨‹ï¼ŒçŸ¥é“ç›¸å…³æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ã€‚</li>\n<li>è¦æƒ³å±è”½è¿™äº›ç»†èŠ‚ï¼Œåº“çš„æä¾›æ–¹ï¼ŒåŒæ—¶æä¾›ä¸€ä¸ªå¯¼å…¥è¿™ä¸ªåº“çš„å¸®åŠ©æ–‡ä»¶ <code>xxxTargets.cmake</code></li>\n<li>è¦æƒ³ç”Ÿæˆçš„åº“ï¼Œå¯ä»¥é€šè¿‡<code>find_package()</code>å‘½ä»¤æ¥ç´¢å¼•ä½¿ç”¨çš„è¯ï¼Œå¯ä»¥åœ¨cmakeå·¥ç¨‹ä¸­é…ç½®ï¼Œåœ¨æ„å»ºå·¥ç¨‹çš„æ—¶å€™ï¼ŒåŒæ—¶ç”Ÿæˆå¯¹åº”çš„å¸®åŠ©æ–‡ä»¶<ul>\n<li><code>xxxTargets.cmake</code></li>\n<li><code>xxxConfig.cmake</code></li>\n<li><code>xxxConfigVersion.cmake</code></li>\n</ul>\n</li>\n</ol>\n<h2 id=\"xxxTargets-cmake\"><a href=\"#xxxTargets-cmake\" class=\"headerlink\" title=\"xxxTargets.cmake\"></a><code>xxxTargets.cmake</code></h2><figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cmake\"><span class=\"hljs-keyword\">cmake_minimum_required</span>(VERSION <span class=\"hljs-number\">3.15</span>)<br><span class=\"hljs-keyword\">project</span>(MathFunctions)<br><br><span class=\"hljs-comment\"># make cache variables for install destinations</span><br><span class=\"hljs-keyword\">include</span>(GNUInstallDirs)<br><br><span class=\"hljs-comment\"># specify the C++ standard</span><br><span class=\"hljs-keyword\">set</span>(CMAKE_CXX_STANDARD <span class=\"hljs-number\">11</span>)<br><span class=\"hljs-keyword\">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class=\"hljs-keyword\">True</span>)<br><br><span class=\"hljs-comment\"># create library</span><br><span class=\"hljs-keyword\">add_library</span>(MathFunctions STATIC MathFunctions.cxx)<br><br><span class=\"hljs-comment\"># add include directories</span><br><span class=\"hljs-keyword\">target_include_directories</span>(MathFunctions<br>                           PUBLIC<br>                           <span class=\"hljs-string\">&quot;$&lt;BUILD_INTERFACE:$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&gt;&quot;</span><br>                           <span class=\"hljs-string\">&quot;$&lt;INSTALL_INTERFACE:$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;&gt;&quot;</span><br>)<br><br><span class=\"hljs-comment\"># install the target and create export-set</span><br><span class=\"hljs-keyword\">install</span>(TARGETS MathFunctions<br>        <span class=\"hljs-keyword\">EXPORT</span> MathFunctionsTargets<br>        LIBRARY DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span><br>        ARCHIVE DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span><br>        RUNTIME DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_BINDIR&#125;</span><br>        INCLUDES DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;</span><br>)<br><br><span class=\"hljs-comment\"># install header file</span><br><span class=\"hljs-keyword\">install</span>(FILES MathFunctions.h DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;</span>)<br><br><span class=\"hljs-comment\"># generate and install export file</span><br><span class=\"hljs-keyword\">install</span>(<span class=\"hljs-keyword\">EXPORT</span> MathFunctionsTargets<br>        <span class=\"hljs-keyword\">FILE</span> MathFunctionsTargets.cmake<br>        NAMESPACE MathFunctions::<br>        DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/MathFunctions<br>)<br><span class=\"hljs-comment\"># create IMPORTED target, set target property</span><br><span class=\"hljs-keyword\">add_library</span>(MathFunctions::MathFunctions STATIC IMPORTED)<br><span class=\"hljs-keyword\">set_target_properties</span>(MathFunctions::MathFunctions PROPERTIES<br>  INTERFACE_INCLUDE_DIRECTORIES <span class=\"hljs-string\">&quot;$&#123;_IMPORT_PREFIX&#125;/include&quot;</span><br>)<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„é™æ€åº“</li>\n<li>è®¾ç½®é™æ€åº“å¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œåˆ†åˆ«æŒ‡å®šæ„å»ºæ—¶å’Œå®‰è£…åçš„è·¯å¾„</li>\n<li>åˆ›å»ºä¸€ä¸ªinstallå‘½ä»¤ï¼ŒæŒ‡å®šç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…è·¯å¾„ã€‚å…¶ä¸­<code>EXPORT MathFunctionsTargets</code>,æŒ‡å®šäº†å¯¼å‡ºtargetæ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶åå­—æ˜¯<code>MathFunctionsTargets.cmake</code></li>\n<li>æŒ‡å®šå¤´æ–‡ä»¶å¦‚ä½•å®‰è£…</li>\n<li>æŒ‡å®š<code>MathFunctionsTargets.cmake</code>æ–‡ä»¶å¦‚ä½•å®‰è£…ï¼Œ<code>NAMESPACE MathFunctions::</code> ç»™å¯¼å‡ºçš„targetæ·»åŠ å‰ç¼€å‘½åç©ºé—´ï¼Œä¸€èˆ¬å¸¦æœ‰å‘½åç©ºé—´çš„targetï¼Œéƒ½æ˜¯<code>IMPORTED target</code></li>\n<li>åˆ›å»ºä¸€ä¸ª<code>IMPORTED target</code>,åå­—æ˜¯<code>MathFunctions::MathFunctions</code></li>\n<li>è®¾ç½®<code>MathFunctions::MathFunctions</code>çš„å±æ€§ï¼Œæ­¤å¤„æ˜¯å¤´æ–‡ä»¶è·¯å¾„</li>\n</ol>\n<p>å¦‚ä½•ä½¿ç”¨å¯¼å‡ºçš„targetæ–‡ä»¶, åœ¨<code>CMakeLists.txt</code>æ–‡ä»¶ä¸­</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">include</span><span class=\"hljs-params\">($&#123;INSTALL_PREFIX&#125;/lib/cmake/MathFunctionTargets.cmake)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myexe src1.c src2.c )</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">target_link_libraries</span><span class=\"hljs-params\">(myexe PRIVATE MathFunctions::MathFunctions)</span></span><br></code></pre></td></tr></table></figure>\n<ol>\n<li>é¦–å…ˆåŒ…å«<code>/MathFunctionTargets.cmake</code>æ–‡ä»¶</li>\n<li>åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œç›®æ ‡myexe</li>\n<li>é“¾æ¥MathFunctions::MathFunctionsåˆ°myexe</li>\n</ol>\n<h2 id=\"æ”¯æŒfind-package\"><a href=\"#æ”¯æŒfind-package\" class=\"headerlink\" title=\"æ”¯æŒfind_package()\"></a>æ”¯æŒ<code>find_package()</code></h2><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">find_package</span><span class=\"hljs-params\">(Stats <span class=\"hljs-number\">2.6</span>.<span class=\"hljs-number\">4</span> REQUIRED)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">target_link_libraries</span><span class=\"hljs-params\">(MathFunctions PUBLIC Stats::Types)</span></span><br></code></pre></td></tr></table></figure>\n\n<p>find_package() æ”¯æŒä¸¤ç§æœç´¢æ¨¡å¼</p>\n<ul>\n<li>module modeï¼Œ é’ˆå¯¹écmakeæ„å»ºçš„åº“ï¼Œæœç´¢<code>Find&lt;PackageName&gt;.cmake</code>æ–‡ä»¶</li>\n<li>config modeï¼Œ é’ˆå¯¹cmakeæ„å»ºçš„åº“ï¼Œç›¸å…³æ–‡ä»¶ä¸º<ul>\n<li>targetç›¸å…³ï¼š <code>&lt;lowercasePackageName&gt;-config.cmake</code>æˆ–è€…<code>&lt;PackageName&gt;Config.cmake</code></li>\n<li>ç‰ˆæœ¬ç›¸å…³ï¼š <code>&lt;lowercasePackageName&gt;-config-version.cmake</code> æˆ– <code>&lt;PackageName&gt;ConfigVersion.cmake</code></li>\n</ul>\n</li>\n</ul>\n<p>å› æ­¤ï¼Œcmakeæ„å»ºçš„åº“ï¼Œæƒ³è¦æ”¯æŒ<code>find_package()</code>çš„configæ¨¡å¼ï¼Œéœ€è¦æä¾›</p>\n<ul>\n<li><code>xxxConfig.cmake</code></li>\n<li><code>xxConfigVersion.cmake</code></li>\n</ul>\n<p>é¦–å…ˆåŒ…å«<code>CMakePackageConfigHelpers</code>æ¨¡å—</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">include</span><span class=\"hljs-params\">(CMakePackageConfigHelpers)</span></span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Creating-a-Package-Configuration-File\"><a href=\"#Creating-a-Package-Configuration-File\" class=\"headerlink\" title=\"Creating a Package Configuration File\"></a>Creating a Package Configuration File</h3><p>ä½¿ç”¨<code>CMakePackageConfigHelpers</code>æ¨¡å—ä¸­çš„<code>configure_package_config_file</code>å‘½ä»¤æ¥ç”Ÿæˆ<code>MathFunctionsConfig.cmake</code>æ–‡ä»¶ï¼Œè“æœ¬æ˜¯<code>Config.cmake.in</code>,åŒæ—¶æŒ‡å®šç”Ÿæˆåçš„è·¯å¾„ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">configure_package_config_file(<span class=\"hljs-variable\">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/Config.cmake.in<br>  <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/MathFunctionsConfig.cmake&quot;</span><br>  INSTALL_DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/MathFunctions<br>)<br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡<code>isntall</code>å‘½ä»¤æŒ‡å®š<code>xxxConfig.cmake</code>å’Œ<code>xxxConfigVersion.cmake</code>æ–‡ä»¶å®‰è£…è§„åˆ™</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">install(FILES<br>          <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/MathFunctionsConfig.cmake&quot;</span><br>          <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/MathFunctionsConfigVersion.cmake&quot;</span><br>        DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/MathFunctions<br>)<br></code></pre></td></tr></table></figure>\n\n<p>å…³äº<code>Config.cmake.in</code>æ–‡ä»¶</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">@PACKAGE_INIT@<br><br><span class=\"hljs-function\"><span class=\"hljs-title\">include</span><span class=\"hljs-params\">(<span class=\"hljs-string\">&quot;$&#123;CMAKE_CURRENT_LIST_DIR&#125;/MathFunctionsTargets.cmake&quot;</span>)</span></span><br><br><span class=\"hljs-function\"><span class=\"hljs-title\">check_required_components</span><span class=\"hljs-params\">(MathFunctions)</span></span><br></code></pre></td></tr></table></figure>\n\n<p><code>@PACKAGE_INIT@</code> åœ¨é…ç½®çš„æ—¶å€™ï¼Œä¼šè¢«æ›¿æ¢å’Œå±•å¼€ï¼Œå±•å¼€ååŒ…å«</p>\n<ol>\n<li>ä»¥<code>PACKAGE_</code>ä¸ºå‰ç¼€çš„ç›¸å¯¹è·¯å¾„</li>\n<li><code>set_and_check()</code> å’Œ <code>heck_required_components()</code>ä¸¤ä¸ªå®å®šä¹‰ã€‚</li>\n</ol>\n<p><code>check_required_components</code> é’ˆå¯¹æ‰€æœ‰çš„ç»„ä»¶ï¼Œç»™<code>&lt;Package&gt;_&lt;Component&gt;_FOUND</code>å˜é‡èµ‹å€¼ï¼Œ æ‰¾åˆ°ä¸º<code>TRUE</code>,æ‰¾ä¸åˆ°ä¸º<code>FALSE</code>ã€‚ åŒæ—¶ç»™<code>&lt;Package&gt;_FOUND</code>å˜é‡èµ‹å€¼ï¼Œ å¦‚æœç»“æœä¸º<code>FALSE</code>,è®¤ä¸ºè¯¥packageæ²¡æœ‰æ‰¾åˆ°ã€‚</p>\n<p><code>set_and_check</code>ä¸»è¦ç»™å¯¹åº”çš„ç›®å½•å’Œæ–‡ä»¶è·¯å¾„èµ‹å€¼ï¼Œå¦‚æœå¼•ç”¨çš„æ–‡ä»¶æˆ–è·¯å¾„æ²¡æœ‰æ‰¾åˆ°ï¼Œè¯¥å®æ‰§è¡Œå¤±è´¥ã€‚</p>\n<h3 id=\"Creating-a-Package-Version-File\"><a href=\"#Creating-a-Package-Version-File\" class=\"headerlink\" title=\"Creating a Package Version File\"></a>Creating a Package Version File</h3><p><code>CMakePackageConfigHelpers</code>æ¨¡å—ï¼Œæä¾›äº†<code>write_basic_package_version_file()</code>å‘½ä»¤æ¥ç”Ÿæˆ<code>xxConfigVersion.cmake</code>æ–‡ä»¶ã€‚ å½“<code>find_package()</code>å‘½ä»¤æŒ‡å®šäº†ç‰ˆæœ¬å·çš„æ—¶å€™ï¼Œ cmake ä¼šè¯»å–è¯¥æ–‡ä»¶æ¥è·å–ç‰ˆæœ¬å·ä¿¡æ¯åšåŒ¹é…</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs crmsh\">set(<span class=\"hljs-keyword\">version</span> <span class=\"hljs-number\">3.4</span>.<span class=\"hljs-number\">1</span>)<br><br>set_property(TARGET MathFunctions <span class=\"hljs-keyword\">PROPERTY</span><span class=\"hljs-title\"> </span><span class=\"hljs-keyword\">VERSION</span> $&#123;<span class=\"hljs-keyword\">version</span>&#125;)<br>set_property(TARGET MathFunctions <span class=\"hljs-keyword\">PROPERTY</span><span class=\"hljs-title\"> </span>SOVERSION <span class=\"hljs-number\">3</span>)<br>set_property(TARGET MathFunctions <span class=\"hljs-keyword\">PROPERTY</span><span class=\"hljs-title\"></span><br><span class=\"hljs-title\">  </span>INTERFACE_MathFunctions_MAJOR_VERSION <span class=\"hljs-number\">3</span>)<br>set_property(TARGET MathFunctions APPEND <span class=\"hljs-keyword\">PROPERTY</span><span class=\"hljs-title\"></span><br><span class=\"hljs-title\">  </span>COMPATIBLE_INTERFACE_STRING MathFunctions_MAJOR_VERSION<br>)<br><br><span class=\"hljs-comment\"># generate the version file for the config file</span><br>write_basic_package_version_file(<br>  <span class=\"hljs-string\">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MathFunctionsConfigVersion.cmake&quot;</span><br>  <span class=\"hljs-keyword\">VERSION</span> <span class=\"hljs-string\">&quot;$&#123;version&#125;&quot;</span><br>  COMPATIBILITY AnyNewerVersion<br>)<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li>è®¾ç½®targetçš„ç‰ˆæœ¬å·ç›¸å…³çš„å˜é‡</li>\n<li>å°†ç‰ˆæœ¬å·ä¿¡æ¯ï¼Œå†™å…¥<code>MathFunctionsConfigVersion.cmake</code>æ–‡ä»¶</li>\n</ol>\n<p>æ­¤æ—¶å·²ç»é…ç½®å¥½å¦‚ä½•ç”Ÿæˆ<code>xxxConfig.cmake</code>å’Œ<code>xxxConfigVersion.cmake</code>æ–‡ä»¶.<br>æ‰§è¡Œæ„å»ºï¼Œå®‰è£…</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">mkdir build <br><span class=\"hljs-keyword\">cd</span> build <br>cmake <span class=\"hljs-string\">..</span><br>cmake <span class=\"hljs-params\">--build</span> .<br>cmake <span class=\"hljs-params\">--install</span> . <span class=\"hljs-params\">--prefix</span> `&lt;prefix&gt;`<br></code></pre></td></tr></table></figure>\n\n<p>è§‚å¯Ÿè¾“å‡º, å¯¹åº”çš„æ–‡ä»¶å·²ç»ç”Ÿæˆ</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">MathFunctionsConfig<span class=\"hljs-selector-class\">.cmake</span><br>MathFunctionsConfigVersion<span class=\"hljs-selector-class\">.cmake</span><br>MathFunctionsTargets-noconfig<span class=\"hljs-selector-class\">.cmake</span><br>MathFunctionsTargets.cmake<br></code></pre></td></tr></table></figure>\n<p>ä½¿ç”¨<code>find_package()</code>æ¥ä½¿ç”¨ç”Ÿæˆconfigæ–‡ä»¶, æ­¤æ—¶éœ€è¦é€šè¿‡<code>CMAKE_PREFIX_PATH</code>æ¥æŒ‡å®šconfigæ–‡ä»¶çš„æœç½—è·¯å¾„ã€‚</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">cmake_minimum_required</span>(VERSION <span class=\"hljs-number\">3.15</span>)<br><span class=\"hljs-built_in\">project</span>(Downstream)<br><br># specify the C++ standard<br><span class=\"hljs-built_in\">set</span>(CMAKE_CXX_STANDARD <span class=\"hljs-number\">11</span>)<br><span class=\"hljs-built_in\">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)<br><br><span class=\"hljs-built_in\">find_package</span>(MathFunctions <span class=\"hljs-number\">3.4</span>.<span class=\"hljs-number\">1</span> EXACT)<br><br><span class=\"hljs-built_in\">add_executable</span>(myexe main.cc)<br><span class=\"hljs-built_in\">target_link_libraries</span>(myexe PRIVATE MathFunctions::MathFunctions)<br></code></pre></td></tr></table></figure>\n\n<p>æ³¨æ„ï¼š<br>å¯¼å‡ºé…ç½®ï¼Œä¸åº”è¯¥å¼•ç”¨ç»å¯¹è·¯å¾„ï¼Œåº”å½“å…³è”ç›¸å¯¹è·¯å¾„ï¼Œè¿™æ ·ï¼Œæ— è®ºå®‰è£…åœ¨å“ªé‡Œï¼Œéƒ½å¯ä»¥é€šè¿‡configæ–‡ä»¶æ­£ç¡®ç´¢å¼•åˆ°åº“ã€‚</p>\n<ol>\n<li>ä¸åº”å½“æ˜¾ç¤ºçš„ä¾èµ–<code>CMAKE_INSTALL_PREFIX</code></li>\n</ol>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ruby\">target_include_directories(tgt <span class=\"hljs-variable constant_\">INTERFACE</span><br>  <span class=\"hljs-comment\"># Wrong, not relocatable:</span><br>  <span class=\"hljs-variable\">$&lt;</span><span class=\"hljs-variable constant_\">INSTALL_INTERFACE</span><span class=\"hljs-symbol\">:</span><span class=\"hljs-variable\">$&#123;</span><span class=\"hljs-variable constant_\">CMAKE_INSTALL_PREFIX</span>&#125;/<span class=\"hljs-keyword\">include</span>/<span class=\"hljs-title class_\">TgtName</span>&gt;<br>)<br><br>target_include_directories(tgt <span class=\"hljs-variable constant_\">INTERFACE</span><br>  <span class=\"hljs-comment\"># Ok, relocatable:</span><br>  <span class=\"hljs-variable\">$&lt;</span><span class=\"hljs-variable constant_\">INSTALL_INTERFACE</span><span class=\"hljs-symbol\">:include/TgtName&gt;</span><br>)<br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>å¯ä»¥ä½¿ç”¨<code>$&lt;INSTALL_PREFIX&gt; generator expression</code></li>\n</ol>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs crystal\">target_include_directories(tgt INTERFACE<br>  <span class=\"hljs-comment\"># Ok, relocatable:</span><br>  <span class=\"hljs-variable\">$&lt;</span><span class=\"hljs-symbol\">INSTALL_INTERFACE:</span><span class=\"hljs-variable\">$&lt;</span>INSTALL_PREFIX&gt;<span class=\"hljs-regexp\">/include/</span>TgtName&gt;<br>)<br></code></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n","excerpt":"","more":"<p>å‚è€ƒï¼š<a href=\"https://cmake.org/cmake/help/latest/guide/importing-exporting/index.html\">https://cmake.org/cmake/help/latest/guide/importing-exporting/index.html</a> </p>\n<h1 id=\"Importing\"><a href=\"#Importing\" class=\"headerlink\" title=\"Importing\"></a>Importing</h1><p>IMPORTED targets å°†cmakeå·¥ç¨‹å¤–éƒ¨çš„åº“ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¼•å…¥åˆ°å½“å‰çš„cmakeå·¥ç¨‹ä¸­ï¼Œè¢«å¼•å…¥çš„å†…å®¹ä¼šå…³è”åˆ°ä¸€ä¸ªcmake ä¸­ä¸€ä¸ª<br>é€»è¾‘ä¸Šçš„targetã€‚</p>\n<p>åˆ›å»ºæ–¹å¼ï¼Œè°ƒç”¨<code>add_executable()</code>,<code>add_library()</code>å‘½ä»¤åˆ›å»ºtargetï¼Œ ä½†æ˜¯è¦æ·»åŠ <code>IMPORTED</code>å‚æ•°ã€‚</p>\n<p>è¿™ä¸ªIMPORTED targetä¸äº§ç”Ÿä»»ä½•æ„å»ºæ–‡ä»¶ï¼Œå› ä¸ºä»–ä»¬å¼•å…¥çš„éƒ½æ˜¯ç°æˆçš„åº“æˆ–è€…å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>\n<p>ä¸€æ—¦IMPORTED target è¢«åˆ›å»ºå¥½äº†ï¼Œå°±å¯ä»¥åƒå·¥ç¨‹ä¸­çš„å…¶ä»–targetä¸€æ ·è¢«å¼•ç”¨äº†ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå°±å¯ä»¥æ–¹ä¾¿ï¼Œçµæ´»å¼•ç”¨å¤–éƒ¨å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“äº†ã€‚</p>\n<h2 id=\"Importing-Executables\"><a href=\"#Importing-Executables\" class=\"headerlink\" title=\"Importing Executables\"></a>Importing Executables</h2><p>ä½¿ç”¨ç£ç›˜ä¸Šçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myexe IMPORTED)</span></span><br><span class=\"hljs-built_in\">set_property</span>(TARGET myexe PROPERTY<br>             IMPORTED_LOCATION <span class=\"hljs-string\">&quot;../InstallMyExe/bin/myexe&quot;</span>)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_custom_command</span><span class=\"hljs-params\">(OUTPUT main.cc COMMAND myexe)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(mynewexe main.cc)</span></span><br></code></pre></td></tr></table></figure>\n\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªIMPORTED target</li>\n<li>è®¾ç½®targetç›¸å…³å±æ€§ï¼Œè¿™é‡ŒæŒ‡å®šå…¶å…³è”çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„</li>\n<li>æ·»åŠ äº†ä¸€ä¸ªcustom commandï¼Œ ç”¨target myexeæŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶æ¥ç”Ÿæˆæ–‡ä»¶<code>main.cc</code></li>\n<li>åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¯æ‰§è¡Œtarget, ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„<code>main.cc</code>ä½œä¸ºæºæ–‡ä»¶</li>\n</ol>\n<h2 id=\"Importing-Libraries\"><a href=\"#Importing-Libraries\" class=\"headerlink\" title=\"Importing Libraries\"></a>Importing Libraries</h2><p>å¯¼å…¥å·²ç»æ„å»ºå¥½çš„åº“ä½œä¸ºä¸€ä¸ªtargetæ¥ä½¿ç”¨ã€‚</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">add_library</span><span class=\"hljs-params\">(foo STATIC IMPORTED)</span></span><br><span class=\"hljs-built_in\">set_property</span>(TARGET foo PROPERTY<br>             IMPORTED_LOCATION <span class=\"hljs-string\">&quot;/path/to/libfoo.a&quot;</span>)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myexe src1.c src2.c)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">target_link_libraries</span><span class=\"hljs-params\">(myexe PRIVATE foo)</span></span><br></code></pre></td></tr></table></figure>\n\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªIMPORTED target</li>\n<li>è®¾ç½®targetç›¸å…³å±æ€§ï¼Œè¿™é‡ŒæŒ‡å®šå…¶å…³è”çš„é™æ€åº“è·¯å¾„</li>\n<li>åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¯æ‰§è¡Œtarget myexeï¼Œé“¾æ¥ä¸Šé¢åˆ›å»ºçš„target foo</li>\n</ol>\n<p>è€ƒè™‘åˆ°å¯èƒ½ä¼šæœ‰debugï¼Œrelease ç­‰ä¸åŒé…ç½®ï¼Œå¼•å…¥å…·æœ‰ä¸åŒé…ç½®çš„åŒä¸€ä¸ªåº“ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å½¢å¼</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">find_library</span><span class=\"hljs-params\">(math_REL NAMES m)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">find_library</span><span class=\"hljs-params\">(math_DBG NAMES md)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">add_library</span><span class=\"hljs-params\">(math STATIC IMPORTED GLOBAL)</span></span><br><span class=\"hljs-built_in\">set_target_properties</span>(math PROPERTIES<br>  IMPORTED_LOCATION <span class=\"hljs-string\">&quot;$&#123;math_REL&#125;&quot;</span><br>  IMPORTED_LOCATION_DEBUG <span class=\"hljs-string\">&quot;$&#123;math_DBG&#125;&quot;</span><br>  IMPORTED_CONFIGURATIONS <span class=\"hljs-string\">&quot;RELEASE;DEBUG&quot;</span><br>)<br><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myexe src1.c src2.c)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">target_link_libraries</span><span class=\"hljs-params\">(myexe PRIVATE math)</span></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"Exporting-Targets\"><a href=\"#Exporting-Targets\" class=\"headerlink\" title=\"Exporting Targets\"></a>Exporting Targets</h1><blockquote>\n<p>While IMPORTED targets on their own are useful, they still require that the project that imports them knows the locations of the target files on disk. The real power of IMPORTED targets is when the project providing the target files also provides a CMake file to help import them. A project can be setup to produce the necessary information so that it can easily be used by other CMake projects be it from a build directory, a local install or when packaged.</p>\n</blockquote>\n<ol>\n<li>IMPORTED targets è¦æ±‚ä½¿ç”¨è¿™äº›targetçš„å·¥ç¨‹ï¼ŒçŸ¥é“ç›¸å…³æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ã€‚</li>\n<li>è¦æƒ³å±è”½è¿™äº›ç»†èŠ‚ï¼Œåº“çš„æä¾›æ–¹ï¼ŒåŒæ—¶æä¾›ä¸€ä¸ªå¯¼å…¥è¿™ä¸ªåº“çš„å¸®åŠ©æ–‡ä»¶ <code>xxxTargets.cmake</code></li>\n<li>è¦æƒ³ç”Ÿæˆçš„åº“ï¼Œå¯ä»¥é€šè¿‡<code>find_package()</code>å‘½ä»¤æ¥ç´¢å¼•ä½¿ç”¨çš„è¯ï¼Œå¯ä»¥åœ¨cmakeå·¥ç¨‹ä¸­é…ç½®ï¼Œåœ¨æ„å»ºå·¥ç¨‹çš„æ—¶å€™ï¼ŒåŒæ—¶ç”Ÿæˆå¯¹åº”çš„å¸®åŠ©æ–‡ä»¶<ul>\n<li><code>xxxTargets.cmake</code></li>\n<li><code>xxxConfig.cmake</code></li>\n<li><code>xxxConfigVersion.cmake</code></li>\n</ul>\n</li>\n</ol>\n<h2 id=\"xxxTargets-cmake\"><a href=\"#xxxTargets-cmake\" class=\"headerlink\" title=\"xxxTargets.cmake\"></a><code>xxxTargets.cmake</code></h2><figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cmake\"><span class=\"hljs-keyword\">cmake_minimum_required</span>(VERSION <span class=\"hljs-number\">3.15</span>)<br><span class=\"hljs-keyword\">project</span>(MathFunctions)<br><br><span class=\"hljs-comment\"># make cache variables for install destinations</span><br><span class=\"hljs-keyword\">include</span>(GNUInstallDirs)<br><br><span class=\"hljs-comment\"># specify the C++ standard</span><br><span class=\"hljs-keyword\">set</span>(CMAKE_CXX_STANDARD <span class=\"hljs-number\">11</span>)<br><span class=\"hljs-keyword\">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class=\"hljs-keyword\">True</span>)<br><br><span class=\"hljs-comment\"># create library</span><br><span class=\"hljs-keyword\">add_library</span>(MathFunctions STATIC MathFunctions.cxx)<br><br><span class=\"hljs-comment\"># add include directories</span><br><span class=\"hljs-keyword\">target_include_directories</span>(MathFunctions<br>                           PUBLIC<br>                           <span class=\"hljs-string\">&quot;$&lt;BUILD_INTERFACE:$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&gt;&quot;</span><br>                           <span class=\"hljs-string\">&quot;$&lt;INSTALL_INTERFACE:$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;&gt;&quot;</span><br>)<br><br><span class=\"hljs-comment\"># install the target and create export-set</span><br><span class=\"hljs-keyword\">install</span>(TARGETS MathFunctions<br>        <span class=\"hljs-keyword\">EXPORT</span> MathFunctionsTargets<br>        LIBRARY DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span><br>        ARCHIVE DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span><br>        RUNTIME DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_BINDIR&#125;</span><br>        INCLUDES DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;</span><br>)<br><br><span class=\"hljs-comment\"># install header file</span><br><span class=\"hljs-keyword\">install</span>(FILES MathFunctions.h DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;</span>)<br><br><span class=\"hljs-comment\"># generate and install export file</span><br><span class=\"hljs-keyword\">install</span>(<span class=\"hljs-keyword\">EXPORT</span> MathFunctionsTargets<br>        <span class=\"hljs-keyword\">FILE</span> MathFunctionsTargets.cmake<br>        NAMESPACE MathFunctions::<br>        DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/MathFunctions<br>)<br><span class=\"hljs-comment\"># create IMPORTED target, set target property</span><br><span class=\"hljs-keyword\">add_library</span>(MathFunctions::MathFunctions STATIC IMPORTED)<br><span class=\"hljs-keyword\">set_target_properties</span>(MathFunctions::MathFunctions PROPERTIES<br>  INTERFACE_INCLUDE_DIRECTORIES <span class=\"hljs-string\">&quot;$&#123;_IMPORT_PREFIX&#125;/include&quot;</span><br>)<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„é™æ€åº“</li>\n<li>è®¾ç½®é™æ€åº“å¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œåˆ†åˆ«æŒ‡å®šæ„å»ºæ—¶å’Œå®‰è£…åçš„è·¯å¾„</li>\n<li>åˆ›å»ºä¸€ä¸ªinstallå‘½ä»¤ï¼ŒæŒ‡å®šç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…è·¯å¾„ã€‚å…¶ä¸­<code>EXPORT MathFunctionsTargets</code>,æŒ‡å®šäº†å¯¼å‡ºtargetæ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶åå­—æ˜¯<code>MathFunctionsTargets.cmake</code></li>\n<li>æŒ‡å®šå¤´æ–‡ä»¶å¦‚ä½•å®‰è£…</li>\n<li>æŒ‡å®š<code>MathFunctionsTargets.cmake</code>æ–‡ä»¶å¦‚ä½•å®‰è£…ï¼Œ<code>NAMESPACE MathFunctions::</code> ç»™å¯¼å‡ºçš„targetæ·»åŠ å‰ç¼€å‘½åç©ºé—´ï¼Œä¸€èˆ¬å¸¦æœ‰å‘½åç©ºé—´çš„targetï¼Œéƒ½æ˜¯<code>IMPORTED target</code></li>\n<li>åˆ›å»ºä¸€ä¸ª<code>IMPORTED target</code>,åå­—æ˜¯<code>MathFunctions::MathFunctions</code></li>\n<li>è®¾ç½®<code>MathFunctions::MathFunctions</code>çš„å±æ€§ï¼Œæ­¤å¤„æ˜¯å¤´æ–‡ä»¶è·¯å¾„</li>\n</ol>\n<p>å¦‚ä½•ä½¿ç”¨å¯¼å‡ºçš„targetæ–‡ä»¶, åœ¨<code>CMakeLists.txt</code>æ–‡ä»¶ä¸­</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">include</span><span class=\"hljs-params\">($&#123;INSTALL_PREFIX&#125;/lib/cmake/MathFunctionTargets.cmake)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">add_executable</span><span class=\"hljs-params\">(myexe src1.c src2.c )</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">target_link_libraries</span><span class=\"hljs-params\">(myexe PRIVATE MathFunctions::MathFunctions)</span></span><br></code></pre></td></tr></table></figure>\n<ol>\n<li>é¦–å…ˆåŒ…å«<code>/MathFunctionTargets.cmake</code>æ–‡ä»¶</li>\n<li>åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œç›®æ ‡myexe</li>\n<li>é“¾æ¥MathFunctions::MathFunctionsåˆ°myexe</li>\n</ol>\n<h2 id=\"æ”¯æŒfind-package\"><a href=\"#æ”¯æŒfind-package\" class=\"headerlink\" title=\"æ”¯æŒfind_package()\"></a>æ”¯æŒ<code>find_package()</code></h2><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">find_package</span><span class=\"hljs-params\">(Stats <span class=\"hljs-number\">2.6</span>.<span class=\"hljs-number\">4</span> REQUIRED)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">target_link_libraries</span><span class=\"hljs-params\">(MathFunctions PUBLIC Stats::Types)</span></span><br></code></pre></td></tr></table></figure>\n\n<p>find_package() æ”¯æŒä¸¤ç§æœç´¢æ¨¡å¼</p>\n<ul>\n<li>module modeï¼Œ é’ˆå¯¹écmakeæ„å»ºçš„åº“ï¼Œæœç´¢<code>Find&lt;PackageName&gt;.cmake</code>æ–‡ä»¶</li>\n<li>config modeï¼Œ é’ˆå¯¹cmakeæ„å»ºçš„åº“ï¼Œç›¸å…³æ–‡ä»¶ä¸º<ul>\n<li>targetç›¸å…³ï¼š <code>&lt;lowercasePackageName&gt;-config.cmake</code>æˆ–è€…<code>&lt;PackageName&gt;Config.cmake</code></li>\n<li>ç‰ˆæœ¬ç›¸å…³ï¼š <code>&lt;lowercasePackageName&gt;-config-version.cmake</code> æˆ– <code>&lt;PackageName&gt;ConfigVersion.cmake</code></li>\n</ul>\n</li>\n</ul>\n<p>å› æ­¤ï¼Œcmakeæ„å»ºçš„åº“ï¼Œæƒ³è¦æ”¯æŒ<code>find_package()</code>çš„configæ¨¡å¼ï¼Œéœ€è¦æä¾›</p>\n<ul>\n<li><code>xxxConfig.cmake</code></li>\n<li><code>xxConfigVersion.cmake</code></li>\n</ul>\n<p>é¦–å…ˆåŒ…å«<code>CMakePackageConfigHelpers</code>æ¨¡å—</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-function\"><span class=\"hljs-title\">include</span><span class=\"hljs-params\">(CMakePackageConfigHelpers)</span></span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Creating-a-Package-Configuration-File\"><a href=\"#Creating-a-Package-Configuration-File\" class=\"headerlink\" title=\"Creating a Package Configuration File\"></a>Creating a Package Configuration File</h3><p>ä½¿ç”¨<code>CMakePackageConfigHelpers</code>æ¨¡å—ä¸­çš„<code>configure_package_config_file</code>å‘½ä»¤æ¥ç”Ÿæˆ<code>MathFunctionsConfig.cmake</code>æ–‡ä»¶ï¼Œè“æœ¬æ˜¯<code>Config.cmake.in</code>,åŒæ—¶æŒ‡å®šç”Ÿæˆåçš„è·¯å¾„ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">configure_package_config_file(<span class=\"hljs-variable\">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/Config.cmake.in<br>  <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/MathFunctionsConfig.cmake&quot;</span><br>  INSTALL_DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/MathFunctions<br>)<br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡<code>isntall</code>å‘½ä»¤æŒ‡å®š<code>xxxConfig.cmake</code>å’Œ<code>xxxConfigVersion.cmake</code>æ–‡ä»¶å®‰è£…è§„åˆ™</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">install(FILES<br>          <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/MathFunctionsConfig.cmake&quot;</span><br>          <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/MathFunctionsConfigVersion.cmake&quot;</span><br>        DESTINATION <span class=\"hljs-variable\">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/MathFunctions<br>)<br></code></pre></td></tr></table></figure>\n\n<p>å…³äº<code>Config.cmake.in</code>æ–‡ä»¶</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">@PACKAGE_INIT@<br><br><span class=\"hljs-function\"><span class=\"hljs-title\">include</span><span class=\"hljs-params\">(<span class=\"hljs-string\">&quot;$&#123;CMAKE_CURRENT_LIST_DIR&#125;/MathFunctionsTargets.cmake&quot;</span>)</span></span><br><br><span class=\"hljs-function\"><span class=\"hljs-title\">check_required_components</span><span class=\"hljs-params\">(MathFunctions)</span></span><br></code></pre></td></tr></table></figure>\n\n<p><code>@PACKAGE_INIT@</code> åœ¨é…ç½®çš„æ—¶å€™ï¼Œä¼šè¢«æ›¿æ¢å’Œå±•å¼€ï¼Œå±•å¼€ååŒ…å«</p>\n<ol>\n<li>ä»¥<code>PACKAGE_</code>ä¸ºå‰ç¼€çš„ç›¸å¯¹è·¯å¾„</li>\n<li><code>set_and_check()</code> å’Œ <code>heck_required_components()</code>ä¸¤ä¸ªå®å®šä¹‰ã€‚</li>\n</ol>\n<p><code>check_required_components</code> é’ˆå¯¹æ‰€æœ‰çš„ç»„ä»¶ï¼Œç»™<code>&lt;Package&gt;_&lt;Component&gt;_FOUND</code>å˜é‡èµ‹å€¼ï¼Œ æ‰¾åˆ°ä¸º<code>TRUE</code>,æ‰¾ä¸åˆ°ä¸º<code>FALSE</code>ã€‚ åŒæ—¶ç»™<code>&lt;Package&gt;_FOUND</code>å˜é‡èµ‹å€¼ï¼Œ å¦‚æœç»“æœä¸º<code>FALSE</code>,è®¤ä¸ºè¯¥packageæ²¡æœ‰æ‰¾åˆ°ã€‚</p>\n<p><code>set_and_check</code>ä¸»è¦ç»™å¯¹åº”çš„ç›®å½•å’Œæ–‡ä»¶è·¯å¾„èµ‹å€¼ï¼Œå¦‚æœå¼•ç”¨çš„æ–‡ä»¶æˆ–è·¯å¾„æ²¡æœ‰æ‰¾åˆ°ï¼Œè¯¥å®æ‰§è¡Œå¤±è´¥ã€‚</p>\n<h3 id=\"Creating-a-Package-Version-File\"><a href=\"#Creating-a-Package-Version-File\" class=\"headerlink\" title=\"Creating a Package Version File\"></a>Creating a Package Version File</h3><p><code>CMakePackageConfigHelpers</code>æ¨¡å—ï¼Œæä¾›äº†<code>write_basic_package_version_file()</code>å‘½ä»¤æ¥ç”Ÿæˆ<code>xxConfigVersion.cmake</code>æ–‡ä»¶ã€‚ å½“<code>find_package()</code>å‘½ä»¤æŒ‡å®šäº†ç‰ˆæœ¬å·çš„æ—¶å€™ï¼Œ cmake ä¼šè¯»å–è¯¥æ–‡ä»¶æ¥è·å–ç‰ˆæœ¬å·ä¿¡æ¯åšåŒ¹é…</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs crmsh\">set(<span class=\"hljs-keyword\">version</span> <span class=\"hljs-number\">3.4</span>.<span class=\"hljs-number\">1</span>)<br><br>set_property(TARGET MathFunctions <span class=\"hljs-keyword\">PROPERTY</span><span class=\"hljs-title\"> </span><span class=\"hljs-keyword\">VERSION</span> $&#123;<span class=\"hljs-keyword\">version</span>&#125;)<br>set_property(TARGET MathFunctions <span class=\"hljs-keyword\">PROPERTY</span><span class=\"hljs-title\"> </span>SOVERSION <span class=\"hljs-number\">3</span>)<br>set_property(TARGET MathFunctions <span class=\"hljs-keyword\">PROPERTY</span><span class=\"hljs-title\"></span><br><span class=\"hljs-title\">  </span>INTERFACE_MathFunctions_MAJOR_VERSION <span class=\"hljs-number\">3</span>)<br>set_property(TARGET MathFunctions APPEND <span class=\"hljs-keyword\">PROPERTY</span><span class=\"hljs-title\"></span><br><span class=\"hljs-title\">  </span>COMPATIBLE_INTERFACE_STRING MathFunctions_MAJOR_VERSION<br>)<br><br><span class=\"hljs-comment\"># generate the version file for the config file</span><br>write_basic_package_version_file(<br>  <span class=\"hljs-string\">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MathFunctionsConfigVersion.cmake&quot;</span><br>  <span class=\"hljs-keyword\">VERSION</span> <span class=\"hljs-string\">&quot;$&#123;version&#125;&quot;</span><br>  COMPATIBILITY AnyNewerVersion<br>)<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li>è®¾ç½®targetçš„ç‰ˆæœ¬å·ç›¸å…³çš„å˜é‡</li>\n<li>å°†ç‰ˆæœ¬å·ä¿¡æ¯ï¼Œå†™å…¥<code>MathFunctionsConfigVersion.cmake</code>æ–‡ä»¶</li>\n</ol>\n<p>æ­¤æ—¶å·²ç»é…ç½®å¥½å¦‚ä½•ç”Ÿæˆ<code>xxxConfig.cmake</code>å’Œ<code>xxxConfigVersion.cmake</code>æ–‡ä»¶.<br>æ‰§è¡Œæ„å»ºï¼Œå®‰è£…</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">mkdir build <br><span class=\"hljs-keyword\">cd</span> build <br>cmake <span class=\"hljs-string\">..</span><br>cmake <span class=\"hljs-params\">--build</span> .<br>cmake <span class=\"hljs-params\">--install</span> . <span class=\"hljs-params\">--prefix</span> `&lt;prefix&gt;`<br></code></pre></td></tr></table></figure>\n\n<p>è§‚å¯Ÿè¾“å‡º, å¯¹åº”çš„æ–‡ä»¶å·²ç»ç”Ÿæˆ</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">MathFunctionsConfig<span class=\"hljs-selector-class\">.cmake</span><br>MathFunctionsConfigVersion<span class=\"hljs-selector-class\">.cmake</span><br>MathFunctionsTargets-noconfig<span class=\"hljs-selector-class\">.cmake</span><br>MathFunctionsTargets.cmake<br></code></pre></td></tr></table></figure>\n<p>ä½¿ç”¨<code>find_package()</code>æ¥ä½¿ç”¨ç”Ÿæˆconfigæ–‡ä»¶, æ­¤æ—¶éœ€è¦é€šè¿‡<code>CMAKE_PREFIX_PATH</code>æ¥æŒ‡å®šconfigæ–‡ä»¶çš„æœç½—è·¯å¾„ã€‚</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">cmake_minimum_required</span>(VERSION <span class=\"hljs-number\">3.15</span>)<br><span class=\"hljs-built_in\">project</span>(Downstream)<br><br># specify the C++ standard<br><span class=\"hljs-built_in\">set</span>(CMAKE_CXX_STANDARD <span class=\"hljs-number\">11</span>)<br><span class=\"hljs-built_in\">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)<br><br><span class=\"hljs-built_in\">find_package</span>(MathFunctions <span class=\"hljs-number\">3.4</span>.<span class=\"hljs-number\">1</span> EXACT)<br><br><span class=\"hljs-built_in\">add_executable</span>(myexe main.cc)<br><span class=\"hljs-built_in\">target_link_libraries</span>(myexe PRIVATE MathFunctions::MathFunctions)<br></code></pre></td></tr></table></figure>\n\n<p>æ³¨æ„ï¼š<br>å¯¼å‡ºé…ç½®ï¼Œä¸åº”è¯¥å¼•ç”¨ç»å¯¹è·¯å¾„ï¼Œåº”å½“å…³è”ç›¸å¯¹è·¯å¾„ï¼Œè¿™æ ·ï¼Œæ— è®ºå®‰è£…åœ¨å“ªé‡Œï¼Œéƒ½å¯ä»¥é€šè¿‡configæ–‡ä»¶æ­£ç¡®ç´¢å¼•åˆ°åº“ã€‚</p>\n<ol>\n<li>ä¸åº”å½“æ˜¾ç¤ºçš„ä¾èµ–<code>CMAKE_INSTALL_PREFIX</code></li>\n</ol>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ruby\">target_include_directories(tgt <span class=\"hljs-variable constant_\">INTERFACE</span><br>  <span class=\"hljs-comment\"># Wrong, not relocatable:</span><br>  <span class=\"hljs-variable\">$&lt;</span><span class=\"hljs-variable constant_\">INSTALL_INTERFACE</span><span class=\"hljs-symbol\">:</span><span class=\"hljs-variable\">$&#123;</span><span class=\"hljs-variable constant_\">CMAKE_INSTALL_PREFIX</span>&#125;/<span class=\"hljs-keyword\">include</span>/<span class=\"hljs-title class_\">TgtName</span>&gt;<br>)<br><br>target_include_directories(tgt <span class=\"hljs-variable constant_\">INTERFACE</span><br>  <span class=\"hljs-comment\"># Ok, relocatable:</span><br>  <span class=\"hljs-variable\">$&lt;</span><span class=\"hljs-variable constant_\">INSTALL_INTERFACE</span><span class=\"hljs-symbol\">:include/TgtName&gt;</span><br>)<br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>å¯ä»¥ä½¿ç”¨<code>$&lt;INSTALL_PREFIX&gt; generator expression</code></li>\n</ol>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs crystal\">target_include_directories(tgt INTERFACE<br>  <span class=\"hljs-comment\"># Ok, relocatable:</span><br>  <span class=\"hljs-variable\">$&lt;</span><span class=\"hljs-symbol\">INSTALL_INTERFACE:</span><span class=\"hljs-variable\">$&lt;</span>INSTALL_PREFIX&gt;<span class=\"hljs-regexp\">/include/</span>TgtName&gt;<br>)<br></code></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n"},{"layout":"post","title":"MPEG-TS æ ¼å¼åˆ†æ","date":"2022-10-11T16:00:00.000Z","_content":"\nå‚è€ƒï¼š \n[MPEG-TS æ ¼å¼è§£æ](https://blog.csdn.net/Kayson12345/article/details/81266587)\n\n[An introduction to MPEG-TS](https://tsduck.io/download/docs/mpegts-introduction.pdf)\n\n\n# èƒŒæ™¯ä»‹ç»\n\nMPEG-TSä¸€ç§æ ‡å‡†æ•°æ®å®¹å™¨æ ¼å¼ï¼Œä¼ è¾“ä¸å­˜å‚¨éŸ³è§†é¢‘ã€èŠ‚ç›®ä¸ç³»ç»Ÿä¿¡æ¯åè®®æ•°æ®ï¼Œåº”ç”¨äºæ•°å­—å¹¿æ’­ç³»ç»Ÿï¼Œè­¬å¦‚DVB,ATSCä¸IPTVã€‚ä¼ è¾“æµåœ¨MPEG-2ç¬¬1éƒ¨åˆ†ç³»ç»Ÿä¸­è§„å®šï¼Œæ­£å¼ç§°ä¸ºISO / IECæ ‡å‡†13818-1æˆ–ITU-Tå»ºè®®ä¹¦[1]ã€‚\n\nMPEG2/DVBæ˜¯ä¸€ç§å¤šåª’ä½“ä¼ è¾“ã€å¤ç”¨æŠ€æœ¯ï¼Œåœ¨æ•°å­—ç”µè§†å¹¿æ’­ä¸­å¯æä¾›æ•°ç™¾ä¸ªèŠ‚ç›®é¢‘é“ã€‚å¤ç”¨çš„å«ä¹‰æ˜¯ï¼Œå¯ä»¥åŒæ—¶ä¼ è¾“å¤šå±‚èŠ‚ç›®ã€‚\n\næ³¨æ„ï¼ŒDVBå…¨ç§°ä¸ºDigital Video Broadcastingï¼ŒåŒ…æ‹¬ä¸åŒçš„ç³»ç»Ÿï¼Œå¦‚å«æ˜Ÿæ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œæœ‰çº¿æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œåœ°é¢å¼€è·¯æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œäº¤äº’å¼æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿä»¥åŠæ•°å­—ç”µè§†åŠ æ‰°ç³»ç»Ÿã€‚DVBç³»ç»Ÿæ ‡å‡†æ˜¯ä¸€ç§å…¨çƒæ•°å­—ç”µè§†æŠ€æœ¯çš„æ ‡å‡†ã€‚å¦‚ä½•å®šä¹‰å¹¿æ’­ä¸­çš„æ¯”ç‰¹æµè¯­æ³•ä¸å¥æ³•ï¼Œä»¥å®ç°åœ¨æ¯”ç‰¹æµä¸­å¤ç”¨æ•°å­—éŸ³é¢‘ä¸è§†é¢‘ï¼Œæ¬§æ´²çš„DVBé‡‡ç”¨æ•°å­—è§†é¢‘å‹ç¼©MPEG-2æ ‡å‡†ï¼Œè¯¥æ ‡å‡†æ˜¯å®šä¹‰æ¯”ç‰¹æµçš„è¯­æ³•ä¸å¥æ³•çš„ä¸€ä¸ªISO/IECæ ‡å‡†ï¼Œå³13818-1æ ‡å‡†ã€‚DVBç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯æ˜¯é‡‡ç”¨MPEG-2æŠ€æœ¯è¿›è¡Œè§†é¢‘ã€éŸ³é¢‘çš„ç¼–ç ï¼Œä½¿ç”¨ç»Ÿä¸€çš„MPEG-2ä¼ è¾“æµï¼ˆTSæµï¼‰ã€‚\n\nMPEG-2æ ‡å‡†ä¸­ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„ç æµè¾“å‡ºåˆ°ä¿¡é“ï¼Œä¸€ç§æ˜¯èŠ‚ç›®ç æµï¼ˆPS: Program Streamï¼‰ï¼Œé€‚ç”¨äºæ²¡æœ‰ä¼ è¾“è¯¯å·®çš„åœºæ™¯ï¼›ä¸€ç§æ˜¯ä¼ é€æµï¼ˆTSï¼šTransport Stream)ï¼Œé€‚ç”¨äºæœ‰ä¿¡é“å™ªå£°çš„ä¼ è¾“åœºæ™¯ã€‚èŠ‚ç›®æµè®¾è®¡ç”¨äºåˆç†å¯é çš„åª’ä½“ï¼Œå¦‚å…‰ç›˜ï¼ˆå¦‚DVDï¼‰ï¼Œè€Œä¼ è¾“æµè®¾è®¡ç”¨äºä¸å¤ªå¯é çš„ä¼ è¾“ï¼Œå³åœ°é¢æˆ–å«æ˜Ÿå¹¿æ’­ã€‚æ­¤å¤–ï¼Œä¼ è¾“æµå¯ä»¥æºå¸¦å¤šä¸ªèŠ‚ç›®ã€‚\n\nMPEG-2 systemï¼ˆç¼–å·13818-1ï¼‰æ˜¯MPEG-2æ ‡å‡†çš„å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œè¯¥éƒ¨åˆ†æè¿°äº†å¤šä¸ªè§†é¢‘ï¼ŒéŸ³é¢‘å’Œæ•°æ®å¤šç§åŸºæœ¬æµï¼ˆESï¼‰åˆæˆä¼ è¾“æµï¼ˆTSï¼‰å’ŒèŠ‚ç›®æµï¼ˆPSï¼‰çš„æ–¹å¼ã€‚\n\n# TS ä»‹ç»\n\nä¸€è·¯TSæ¯”ç‰¹æµé€šå¸¸ç”±è¿ç»­çš„å›ºå®šå­—èŠ‚çš„TSåŒ…ç»„æˆï¼Œæ‰€åŒ…å«çš„å†…å®¹æœ‰ï¼š\n\n- ä¸€è·¯æˆ–å¤šè·¯è§†é¢‘æµï¼ˆå¤šä¸ªPESåŒ…ç»„æˆï¼Œæ¯ä¸ªPESåŒ…çš„PIDæ˜¯ä¸€è‡´çš„ï¼Œä¸€ä¸ªPESåŒ…å¯èƒ½ç”±è‹¥å¹²ä¸ªTSåŒ…ç»„æˆï¼‰\n\n- ä¸€è·¯æˆ–å¤šè·¯éŸ³é¢‘æµï¼ˆé€šå¸¸ä¸ºæœæ¯”çš„éŸ³é¢‘æ ¼å¼ï¼‰\n\n- ä¸€è·¯æˆ–å¤šè·¯å­—å¹•\n\n- PSIè¡¨æ ¼ä¿¡æ¯ï¼ˆProgram Specific Informationï¼ŒåŒ…æ‹¬PATä¸PMTè¡¨ï¼Œå³èŠ‚ç›®å…³è”è¡¨ä¸èŠ‚ç›®æ˜ å°„è¡¨ï¼‰\n\n- PES: Packetized Elementary Streamï¼Œä¸€è·¯åŸºæœ¬ç æµï¼ˆå¦‚MEPG2è§†é¢‘æµï¼‰ä¼šåœ¨ç¼–ç å™¨ç«¯è¢«æ‰“åŒ…æˆPESæµï¼Œç”±å¤šä¸ªPESåŒ…ç»„æˆï¼Œæ‰“åŒ…çš„è¿‡ç¨‹ä¸­ä¸»è¦åŠ å…¥äº†PTS/DTSä¿¡æ¯ã€‚\n\n\n\nPAT(Program Association Table)æè¿°æœ‰å¤šå°‘è·¯èŠ‚ç›®ï¼Œæ¯è·¯èŠ‚ç›®çš„PMTï¼ˆProgram Map Tableï¼‰è¡¨çš„PIDæ˜¯å¤šå°‘ï¼ŒPMTåˆ™æè¿°äº†æœ¬èŠ‚ç›®æœ‰å¤šå°‘æµï¼Œæ¯ä¸€è·¯æµçš„ç±»å‹ä¸PIDæ˜¯å¤šå°‘ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä½ æ‰¾ä¸ªä¸€ä¸ªTSåŒ…ï¼Œå®ƒçš„PIDæ˜¯0ï¼Œè¯´æ˜å®ƒçš„è´Ÿè½½å†…å®¹æ˜¯PATä¿¡æ¯ï¼Œè§£æPATä¿¡æ¯ï¼Œä½ å‘ç°èŠ‚ç›®1çš„PMTè¡¨çš„PIDæ˜¯0x10ï¼Œæ¥ç€ï¼Œä½ åœ¨æ¯”ç‰¹æµä¸­å¯»æ‰¾ä¸€ä¸ªPIDä¸º0x10çš„TSåŒ…ï¼Œå®ƒçš„è´Ÿè½½å†…å®¹æ˜¯èŠ‚ç›®1çš„PMTè¡¨ä¿¡æ¯ï¼Œè§£æè¯¥PMTä¿¡æ¯ï¼Œä½ å¯ä»¥å‘ç°ç¬¬ä¸€è·¯æµæ˜¯MPEG2éŸ³é¢‘æµï¼ŒPIDå·0x21ï¼Œç¬¬äºŒè·¯æµæ˜¯MPEG2è§†é¢‘æµï¼ŒPIDå·æ˜¯0x22ï¼Œç¬¬ä¸‰è·¯æµæ˜¯DVBå­—å¹•æµï¼ŒPIDå·æ˜¯0x23ï¼Œè§£æå®Œæ¯•ï¼Œå‡¡æ˜¯æ¯”ç‰¹æµä¸­PIDå·ä¸º0x22çš„TSåŒ…ï¼Œæ‰€è´Ÿè½½çš„å†…å®¹ä¸ºMPEG2è§†é¢‘æµï¼ŒæŠŠè¿™äº›åŒ…ä¸€ä¸ªä¸€ä¸ªæ‰¾å‡ºæ¥ï¼ŒæŠŠå…¶ä¸­çš„æœ‰æ•ˆç æµä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†çš„æ‹¼æ¥èµ·æ¥ï¼Œç„¶åé€ç»™è§£ç å™¨å»è§£ç ã€‚\n\næ³¨æ„ï¼Œå°±ä¸€èˆ¬çš„è§†é¢‘æµè€Œè¨€ï¼Œåªè¦æ‹¼æ¥æˆä¸€ä¸ªå®Œæ•´çš„PESåŒ…ï¼Œå°±å¯ä»¥é€å‡ºå»ç»™è§£ç å™¨ï¼Œç„¶åå†ç»§ç»­æ‹¼æ¥ä¸‹ä¸€ä¸ªPESåŒ…ã€‚\n\nä»€ä¹ˆæ˜¯ESæµï¼ŒPESæµï¼ŒTSæµï¼Ÿ\n\n- ESæµï¼šæœ‰ä¸‰ç§ï¼Œå›¾åƒæ•°æ®æµï¼ŒéŸ³é¢‘æ•°æ®æµï¼Œä»¥åŠå…¶ä»–ç¼–ç æ•°æ®æµã€‚\n\n- PESæµï¼šPESæµæ˜¯ESæµç»è¿‡PESæ‰“åŒ…å™¨å¤„ç†åå½¢æˆçš„æ•°æ®æµï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®Œæˆäº†å°†ESæµåˆ†ç»„ã€æ‰“åŒ…ã€åŠ å…¥åŒ…å¤´ä¿¡æ¯ç­‰æ“ä½œï¼ˆå¯¹ESæµçš„ç¬¬ä¸€æ¬¡æ‰“åŒ…ï¼‰ã€‚PESæµçš„åŸºæœ¬å•ä½æ˜¯PESåŒ…ã€‚\n\n- TSæµï¼šç”±å®šé•¿çš„TSåŒ…ç»„æˆï¼ˆ188å­—èŠ‚ï¼‰ï¼Œè€ŒTSåŒ…æ˜¯å¯¹PESåŒ…çš„ä¸€ä¸ªé‡æ–°å°è£…ï¼ˆåˆ°è¿™é‡Œï¼ŒESç»è¿‡äº†ä¸¤å±‚çš„å°è£…ï¼‰ ã€‚åº”ç”¨äºç›¸å¯¹æœ‰é”™ç¯å¢ƒä¸‹çš„ä¼ è¾“ä¸å­˜å‚¨ï¼ˆå¦‚DVBä¸­ï¼‰ï¼Œå…¶åŸºæœ¬å•ä½æ˜¯TSåŒ…ï¼Œé•¿åº¦å›ºå®š188å­—èŠ‚ã€‚æ—¥æœ¬çš„DVB-Så¹¿æ’­ç³»ç»Ÿé‡‡ç”¨192ä¸ªå­—èŠ‚çš„TSåŒ…ï¼Œç¾å›½é‡‡ç”¨204ä¸ªå­—èŠ‚çš„TSåŒ…ï¼Œå¤šåŠ äº†16ä¸ªå­—èŠ‚çš„å‰å‘çº é”™æ ¡éªŒç ï¼ˆFECï¼‰ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655696635121665569663420.png)\nFig. 1. ESæµæ‰“åŒ…æˆPESæµ\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655697239811665569723213.png)\nFig. 2. PESæµæ‰“åŒ…æˆTSæµ\n\nä»€ä¹ˆæ˜¯PSIè¡¨ï¼Ÿ\n\nPSI(Program Specific Info)ï¼ŒèŠ‚ç›®ç‰¹å®šä¿¡æ¯ï¼Œè¯¥è¡¨æ ¼ä¿¡æ¯ç”¨æ¥æè¿°ä¼ é€æµçš„ç»„æˆç»“æ„ã€‚PSIä¿¡æ¯ç”±å››ç§ç±»å‹çš„è¡¨ç»„æˆï¼ŒåŒ…æ‹¬èŠ‚ç›®å…³è”è¡¨ï¼ˆPATï¼‰ï¼ŒèŠ‚ç›®æ˜ å°„è¡¨ï¼ˆPMTï¼‰ï¼Œæ¡ä»¶æ¥æ”¶è¡¨ï¼ˆCATï¼‰ï¼Œç½‘ç»œä¿¡æ¯è¡¨ï¼ˆNITï¼‰ã€‚PATä¸PMTä¸¤å¼ è¡¨å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°è¯¥ä¼ é€æµä¸­çš„æ‰€æœ‰èŠ‚ç›®ä¸æµï¼ŒPATå‘Šè¯‰æˆ‘ä»¬ï¼Œè¯¥TSæµç”±å“ªäº›èŠ‚ç›®ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç›®çš„èŠ‚ç›®æ˜ å°„è¡¨PMTçš„PIDæ˜¯ä»€ä¹ˆï¼Œè€ŒPMTå‘Šè¯‰æˆ‘ä»¬ï¼Œè¯¥èŠ‚ç›®ç”±å“ªäº›æµç»„æˆï¼Œæ¯ä¸€è·¯æµçš„ç±»å‹ä¸PIDæ˜¯ä»€ä¹ˆã€‚CATä¸NITæš‚æ—¶ä¸è€ƒè™‘ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655698149521665569814410.png)\n\nFig. 3. PSIè¡¨\n\n# TSè§£å°è£…çš„åŸç†\n\nTSæµçš„å½¢æˆè¿‡ç¨‹ï¼š\n\n1. å°†åŸå§‹éŸ³è§†é¢‘æ•°æ®å‹ç¼©ä¹‹åï¼Œå‹ç¼©ç»“æœç»„æˆä¸€ä¸ªåŸºæœ¬ç æµï¼ˆESï¼‰ã€‚\n2. å¯¹ESï¼ˆåŸºæœ¬ç æµï¼‰è¿›è¡Œæ‰“åŒ…å½¢æˆPESã€‚\n3. åœ¨PESåŒ…ä¸­åŠ å…¥æ—¶é—´æˆ³ä¿¡æ¯(PTS/DTS)ã€‚\n4. å°†PESåŒ…å†…å®¹åˆ†é…åˆ°ä¸€ç³»åˆ—å›ºå®šé•¿åº¦çš„ä¼ è¾“åŒ…ï¼ˆTS Packetï¼‰ä¸­ã€‚\n5. åœ¨ä¼ è¾“åŒ…ä¸­åŠ å…¥å®šæ—¶ä¿¡æ¯(PCR)ã€‚\n6. åœ¨ä¼ è¾“åŒ…ä¸­åŠ å…¥èŠ‚ç›®ä¸“ç”¨ä¿¡æ¯(PSI) ã€‚\n7. è¿ç»­è¾“å‡ºä¼ è¾“åŒ…å½¢æˆå…·æœ‰æ’å®šæ¯”ç‰¹ç‡çš„MPEG-TSæµã€‚\n\nTSæµçš„è§£æè¿‡ç¨‹ï¼Œå¯ä»¥è¯´æ˜¯ç”Ÿæˆçš„é€†è¿‡ç¨‹ï¼š\n\n1. ä»å¤ç”¨çš„MPEG-TSæµä¸­è§£æå‡ºTSåŒ…ï¼›\n2. ä»TSåŒ…ä¸­è·å–PATåŠå¯¹åº”çš„PMTï¼ˆPSIä¸­çš„è¡¨æ ¼ï¼‰ï¼›\n3. ä»è€Œè·å–ç‰¹å®šèŠ‚ç›®çš„éŸ³è§†é¢‘PIDï¼›\n4. é€šè¿‡PIDç­›é€‰å‡ºç‰¹å®šéŸ³è§†é¢‘ç›¸å…³çš„TSåŒ…ï¼Œå¹¶è§£æå‡ºPESï¼›\n5. ä»PESä¸­è¯»å–åˆ°PTS/DTSï¼Œå¹¶ä»PESä¸­è§£æå‡ºåŸºæœ¬ç æµESï¼›\n6. å°†ESäº¤ç»™è§£ç å™¨ï¼Œè·å¾—å‹ç¼©å‰çš„åŸå§‹éŸ³è§†é¢‘æ•°æ®\n\n# TSæ ¼å¼è¯¦è§£\n\n## 1. TSåŒ…æ ¼å¼\nTSåŒ…ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€æ˜¯4ä¸ªå­—èŠ‚çš„åŒ…å¤´ä¿¡æ¯ï¼ŒäºŒæ˜¯æœ‰æ•ˆè½½è·ï¼Œå¦å¤–ä¸­é—´æœ‰å¯èƒ½æ’å…¥è‡ªé€‚åº”è°ƒæ•´å­—æ®µã€‚æœ‰æ•ˆè½½è·åŒ…æ‹¬èŠ‚ç›®ä¸“ç”¨ä¿¡æ¯ï¼Œæ‰“åŒ…åçš„æµæ•°æ®ï¼Œä»¥åŠä¸šåŠ¡ä¿¡æ¯ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655700779571665570077901.png)\n\nFig. 4. TSåŒ…çš„ç»„æˆç»“æ„\n\nTSçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655701129401665570112830.png)\n\nFig. 5. TSçš„è¯­æ³•ç»“æ„\n\nä¸»è¦å­—æ®µè§£æï¼š\nSync byte:åŒæ­¥å­—èŠ‚ï¼Œå€¼ä¸º0x47ï¼›\n\nTransport error indicator:ä¼ è¾“é”™è¯¯æŒ‡ç¤ºä½ï¼Œç½®1æ—¶ï¼Œè¡¨ç¤ºä¼ é€åŒ…ä¸­è‡³å°‘æœ‰ä¸€ä¸ªä¸å¯çº æ­£çš„é”™è¯¯ä½ã€‚\n\nPayload unit start indicator:è´Ÿè½½å•å…ƒèµ·å§‹æŒ‡æ ‡ä½ï¼Œè¡¨ç¤ºTSåŒ…çš„æœ‰æ•ˆå‡€è·ä»¥PES/PSIåŒ…çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªPESåŒ…å¯èƒ½ç”±å¤šä¸ªTSåŒ…æ„æˆï¼Œç¬¬ä¸€ä¸ªTSåŒ…çš„è´Ÿè½½å•å…ƒèµ·å§‹æŒ‡æ ‡ä½æ‰ä¼šè¢«ç½®ä½ã€‚\n\nTransport priority:ä¼ è¾“ä¼˜å…ˆçº§ï¼Œè¡¨æ˜è¯¥åŒ…æ¯”åŒä¸ªPIDçš„ä½†æœªç½®ä½çš„TSåŒ…æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚\n\nPID:è¯¥TSåŒ…çš„IDå·ï¼Œå¦‚æœå‡€è·æ˜¯PATåŒ…ï¼Œåˆ™PIDå›ºå®šä¸º0x00ã€‚\n\nTransport scrambling control:ä¼ è¾“åŠ æ‰°æ§åˆ¶ä½\n\nAdaption field control:è‡ªé€‚åº”è°ƒæ•´åŸŸæ§åˆ¶ä½ï¼Œç½®ä½åˆ™è¡¨æ˜è¯¥TSåŒ…å­˜åœ¨è‡ªé€‚åº”è°ƒæ•´å­—æ®µã€‚\n\nContinuity counter:è¿ç»­è®¡æ•°å™¨ï¼Œéšç€å…·æœ‰ç›¸åŒPIDçš„TSåŒ…çš„å¢åŠ è€Œå¢åŠ ï¼Œè¾¾åˆ°æœ€å¤§æ—¶æ¢å¤ä¸º0ï¼Œå¦‚æœä¸¤ä¸ªè¿ç»­ç›¸åŒPIDçš„TSåŒ…å…·æœ‰ç›¸åŒçš„è®¡æ•°ï¼Œåˆ™è¡¨æ˜è¿™ä¸¤ä¸ªåŒ…æ˜¯ä¸€æ ·çš„ï¼Œåªå–ä¸€ä¸ªè§£æå³å¯ã€‚\n\nPayload:è´Ÿè½½å†…å®¹ï¼Œå¯èƒ½ä¸ºPAT/PMT/PESã€‚data_byteä¸º1Bé•¿\nåº¦çš„æ•°æ®ï¼Œä¸ºè´Ÿè½½å­—èŠ‚ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655826274671665582627092.png)\n\nFig. 6. TSçš„è¯­æ³•ç»“æ„ä»£ç ç¤ºæ„\n\n## 2. PAT æ ¼å¼\n\nPATçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655846904131665584689570.png)\nFig. 7. PATçš„è¯­æ³•ç»“æ„ç¤ºæ„\n\nä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š\n\ntable_id: æ ‡è¯†ä¸€ä¸ªTS PSI åˆ†æ®µçš„å†…å®¹æ˜¯èŠ‚ç›®å…³è”åˆ†æ®µï¼Œæ¡ä»¶è®¿é—®åˆ†æ®µè¿˜æ˜¯èŠ‚ç›®æ˜ å°„åˆ†æ®µã€‚å¯¹äºPATï¼Œç½®ä¸º0x00ã€‚\n\nsection_syntax_indicator: å¯¹äºPATï¼Œç½®ä¸º0x01ã€‚\n\nsection_length: åˆ†æ®µé•¿åº¦å­—æ®µï¼Œå…¶å€¼ä¸ºä»section_lengthï¼ˆä¸åŒ…æ‹¬åœ¨å†…ï¼‰åˆ°CRC_32å­—æ®µçš„å­—èŠ‚æ•°ï¼Œå…¶å€¼ä¸è¶…è¿‡1021ã€‚\n\ntransport_stream_id: åŒºåˆ«ä¸å…¶ä»–å¤ç”¨æµçš„æ ‡è¯†ã€‚\n\nversion_number: PATçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœPATæœ‰å˜ï¼Œåˆ™ç‰ˆæœ¬å·åŠ 1ã€‚\n\ncurrent_next_indicator:ç½®0æ—¶ï¼Œè¡¨æ˜è¯¥ä¼ é€çš„è¡¨åˆ†æ®µä¸èƒ½ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªè¡¨åˆ†æ®µæ‰æœ‰æ•ˆã€‚\n\nsection_number: è¡¨æ˜è¯¥TSåŒ…å±äºè¯¥PATçš„ç¬¬å‡ ä¸ªåˆ†æ®µï¼Œåˆ†æ®µå·ä»0å¼€å§‹ã€‚\n\nlast_section_number: è¡¨æ˜æœ€åä¸€ä¸ªåˆ†æ®µå·ï¼ŒåŒæ—¶è¡¨æ˜è¯¥PATçš„æœ€å¤§åˆ†æ®µæ•°ç›®ã€‚ä¸€èˆ¬ï¼Œä¸€ä¸ªPATè¡¨ç”±ä¸€ä¸ªTSåŒ…ä¼ é€ã€‚\n\nprogram_number: èŠ‚ç›®çš„ç¼–å·ã€‚\n\nnetwork_PID: NITè¡¨çš„PIDå€¼ã€‚\n\nprogram_map_PID: PMTè¡¨çš„PIDå€¼ã€‚\n\nCRC_32: CRCæ ¡éªŒã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655849004091665584900226.png)\nFig. 8. PATè¯­æ³•ç»“æ„ä»£ç ç¤ºæ„\n## 3. PMT æ ¼å¼\n\nPMTçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655849504061665584950270.png)\nFig. 9. PMTè¯­æ³•ç»“æ„\n\nä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š\n\ntable_id: æ ‡è¯†ä¸€ä¸ªTS PSI åˆ†æ®µçš„å†…å®¹æ˜¯èŠ‚ç›®å…³è”åˆ†æ®µï¼Œæ¡ä»¶è®¿é—®åˆ†æ®µè¿˜æ˜¯èŠ‚ç›®æ˜ å°„åˆ†æ®µã€‚å¯¹äºPMTï¼Œç½®ä¸º0x02ã€‚\n\nsection_syntax_indicator: å¯¹äºPMTï¼Œç½®ä¸º0x01ã€‚\n\nsection_length: åˆ†æ®µé•¿åº¦å­—æ®µï¼Œå…¶å€¼ä¸ºä»section_lengthï¼ˆåŒ…æ‹¬åœ¨å†…ï¼‰åˆ°CRC_32å­—æ®µçš„å­—èŠ‚æ•°ï¼Œå…¶å€¼ä¸è¶…è¿‡1021ã€‚\n\nprogram_number: è¡¨æ˜ä¸€å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç›®ã€‚\n\nversion_number: PMTçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœå­—æ®µä¸­æœ‰å…³ä¿¡æ¯æœ‰å˜ï¼Œåˆ™ç‰ˆæœ¬å·ä»¥32ä¸ºæ¨¡åŠ 1ã€‚ç‰ˆæœ¬å·æ˜¯å¯¹ä¸€ä¸ªèŠ‚ç›®çš„å®šä¹‰ã€‚\n\ncurrent_next_indicator:ç½®0æ—¶ï¼Œè¡¨æ˜è¯¥ä¼ é€çš„è¡¨åˆ†æ®µä¸èƒ½ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªè¡¨åˆ†æ®µæ‰æœ‰æ•ˆã€‚\n\nsection_number: æ€»ä¸º0x00ã€‚\n\nlast_section_number: æ€»ä¸º0x00ã€‚\n\nPCR_PID: æŒ‡ç¤ºå«æœ‰è¯¥èŠ‚ç›®çš„PCRå­—æ®µçš„TSåŒ…çš„PIDã€‚\n\nprogram_info_length: è¡¨æ˜è·Ÿéšå…¶åçš„å¯¹èŠ‚ç›®ä¿¡æ¯æè¿°çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªN loop descriptorsçš„å­—èŠ‚æ•°ã€‚\n\nstream_type: è¡¨æ˜PESæµçš„ç±»å‹ã€‚è­¬å¦‚ï¼Œ0x01è¡¨æ˜æ˜¯MPEG-1è§†é¢‘ï¼Œ0X03è¡¨æ˜æ˜¯MPEG-1éŸ³é¢‘ã€‚\n\nelementary_PID: è¡¨æ˜è¯¥è´Ÿè½½æœ‰è¯¥PESæµçš„TSåŒ…çš„PIDå€¼ã€‚\n\nES_info_length: è¡¨æ˜è·Ÿéšå…¶åçš„æè¿°ç›¸å…³èŠ‚ç›®å…ƒç´ çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªN loop descriptorsçš„å­—èŠ‚æ•°ã€‚\n\nCRC_32: åœ¨CEDARXä»£ç ä¸­ä»…å¯¹DVBçš„åœºæ™¯ä¸‹ä½œæ ¡éªŒã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655851034681665585103423.png)\n\nFig. 10. PMTçš„è¯­æ³•ç»“æ„ä»£ç ç¤ºæ„\n\n## 4.PESæ ¼å¼\n\nPESçš„è¯­æ³•å¦‚å›¾10æ‰€ç¤ºï¼Œå®ƒæºå¸¦çš„ä¸»è¦ä¿¡æ¯åŒ…æ‹¬æµçš„IDï¼ŒPESåŒ…çš„é•¿åº¦ï¼ŒPTSä»¥åŠæµçš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯éŸ³è§†é¢‘ä¸å­—å¹•æ•°æ®ã€‚\n\nä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š\n\npacket_start_code_prefix: å›ºå®š0x000001\n\nstream_id: æŒ‡å®šåŸºæœ¬æµçš„ç±»å‹ä¸ç¼–å·\n\nPES_packet_length: è¡¨æ˜åœ¨è¯¥å­—æ®µåé¢è¿˜æœ‰å¤šå°‘ä¸ªå­—èŠ‚ã€‚0è¡¨æ˜PESåŒ…çš„é•¿åº¦æœªæŒ‡ç¤ºä¹Ÿæœªé™å®šï¼Œå¯¹äºå½“å‰çš„PESåŒ…è€Œè¨€ã€‚\n\nPES_scrambling_control: PESåŒ…çš„æœ‰æ•ˆè½½è·çš„åŠ æ‰°æ–¹å¼ã€‚\n\nPES_priority: å¤šè·¯å¤ç”¨å™¨å¯ä»¥é€šè¿‡è¯¥ä½æœ€ä¼˜åŒ–åŸºæœ¬æµå†…çš„æ•°æ®ã€‚\n\ndata_alignment_indicator:\n\ncopyright: PESåŒ…ä¸­çš„æœ‰æ•ˆè½½è·ç¡®å®šå…·æœ‰ç‰ˆæƒçš„è¯ï¼Œå°±ç½®ä½ã€‚\n\norginal_or_copy: ç½®ä½æ—¶ï¼Œè¡¨æ˜PESåŒ…çš„æœ‰æ•ˆè½½è·çš„å†…å®¹æ˜¯åŸå§‹çš„ï¼Œéå¤åˆ¶çš„ã€‚\n\nPTS_DTS_flags: 2æ¯”ç‰¹å­—èŠ‚ï¼Œè¡¨æ˜PTS/DTCçš„å­˜åœ¨æƒ…å†µã€‚\n\nES_rate_flag: ç½®ä½ï¼Œè¡¨æ˜åé¢å­˜åœ¨ES_rateå­—æ®µã€‚\n\nPES_header_data_length: è¡¨æ˜è¯¥PESåŒ…å¤´ä¸­ç”±ä»»é€‰å­—æ®µä¸å¡«å……å­—èŠ‚æ‰€å æ®çš„å­—èŠ‚æ€»æ•°ã€‚ä»»é€‰å­—æ®µè­¬å¦‚ES_rateã€‚\n\nmarker_bit: ä¸º1çš„æ¯”ç‰¹ä½ã€‚\n\nPTS: å¯¹äºéŸ³é¢‘è€Œè¨€ï¼Œå¦‚æœè¯¥PESåŒ…ä¸­å­˜åœ¨PTSå­—æ®µï¼Œåˆ™æœ‰æ•ˆè´Ÿè½½ä¸­è‚¯å®šæœ‰æ–°çš„éŸ³é¢‘å­˜å–å•å…ƒï¼ˆaccess unitï¼‰ï¼Œè¯¥PTSå¯¹åº”äºè¯¥éŸ³é¢‘å­˜å–å•å…ƒã€‚æ–°çš„éŸ³é¢‘å­˜å–å•å…ƒæŒ‡çš„æ˜¯ä¸€å¸§æ–°çš„éŸ³é¢‘å¸§ã€‚å¯¹äºè§†é¢‘è€Œè¨€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè·ŸéŸ³é¢‘ä¸€æ ·ã€‚\n\nDTS: è§£ç æ—¶é—´æ ‡å¿—ï¼Œå½“å‰CEDARXè§£ç å™¨æœªç”¨åˆ°DTSã€‚\n\nES_rate: åŸºæœ¬æµé€Ÿç‡ï¼ŒæŒ‡å®šç³»ç»Ÿç›®æ ‡è§£ç å™¨æ¥æ”¶PESåŒ…å­—èŠ‚çš„é€Ÿç‡ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655853343991665585333549.png)\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655858313871061665585632_.jpg)\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655858713891665585871171.png)\nFig. 11. PESçš„è¯­æ³•ç»“æ„ä»£ç \n# å‚è€ƒèµ„æ–™\n\n[1] ISO / IECæ ‡å‡†13818-1æˆ–ITU-Tå»ºè®®ä¹¦ http://www.itu.int/rec/T-REC-H.222.0\n\n[2] ã€Šæ•°å­—ç”µè§†ä¸šåŠ¡ä¿¡æ¯åŠå…¶ç¼–ç ã€‹ï¼Œæ–¹æ¶›ï¼Œå›½é˜²å·¥ä¸šå‡ºç‰ˆç¤¾\n\n[3] https://wenku.baidu.com/view/87f5439c2f60ddccdb38a066.html?rec_flag=default\n\n[4] TSç æµç»“æ„åˆ†æPPTï¼Œç½‘ç»œèµ„æ–™\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n\nç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€ŒKayson12345ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚\nåŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/Kayson12345/article/details/81266587\n\n\n\n\n\n\n# ä¸ªäººç†è§£\n\nä»TSæµä¸­è·å–PATï¼Œè§£æPATå¾—åˆ°èŠ‚ç›®åˆ—è¡¨ï¼Œæ¯ä¸ªèŠ‚ç›®åˆ—è¡¨å¯¹åº”ä¸€ä¸ªPMTï¼Œ ä»PMTä¸­å¾—è¯¥èŠ‚ç›®å¯¹åº”çš„éŸ³è§†é¢‘PIDï¼Œ ä»TSæµæ ¹æ®PIDæ»¤å‡ºéŸ³è§†é¢‘TSåŒ…ï¼Œå°†TSåŒ…è¿˜åŸä¸ºPESåŒ…ï¼Œè¿›è€Œè¿˜åŸä¸ºESæµï¼ˆh264, aacï¼‰é€ç»™è§£ç å™¨è§£ç ã€‚\n\nç»“åˆ[An introduction to MPEG-TS](https://tsduck.io/download/docs/mpegts-introduction.pdf)çœ‹èµ·æ¥æ›´æ˜“äºç†è§£ã€‚\n\n# åˆ†æå·¥å…·\n[easyice ](https://easyice.cn/archives/85)","source":"_posts/hls/2022-10-12-MPEG-TS æ ¼å¼åˆ†æ.md","raw":"---\nlayout: post\ntitle: \"MPEG-TS æ ¼å¼åˆ†æ\"\ndate: 2022-10-12\ntag: hls\n---\n\nå‚è€ƒï¼š \n[MPEG-TS æ ¼å¼è§£æ](https://blog.csdn.net/Kayson12345/article/details/81266587)\n\n[An introduction to MPEG-TS](https://tsduck.io/download/docs/mpegts-introduction.pdf)\n\n\n# èƒŒæ™¯ä»‹ç»\n\nMPEG-TSä¸€ç§æ ‡å‡†æ•°æ®å®¹å™¨æ ¼å¼ï¼Œä¼ è¾“ä¸å­˜å‚¨éŸ³è§†é¢‘ã€èŠ‚ç›®ä¸ç³»ç»Ÿä¿¡æ¯åè®®æ•°æ®ï¼Œåº”ç”¨äºæ•°å­—å¹¿æ’­ç³»ç»Ÿï¼Œè­¬å¦‚DVB,ATSCä¸IPTVã€‚ä¼ è¾“æµåœ¨MPEG-2ç¬¬1éƒ¨åˆ†ç³»ç»Ÿä¸­è§„å®šï¼Œæ­£å¼ç§°ä¸ºISO / IECæ ‡å‡†13818-1æˆ–ITU-Tå»ºè®®ä¹¦[1]ã€‚\n\nMPEG2/DVBæ˜¯ä¸€ç§å¤šåª’ä½“ä¼ è¾“ã€å¤ç”¨æŠ€æœ¯ï¼Œåœ¨æ•°å­—ç”µè§†å¹¿æ’­ä¸­å¯æä¾›æ•°ç™¾ä¸ªèŠ‚ç›®é¢‘é“ã€‚å¤ç”¨çš„å«ä¹‰æ˜¯ï¼Œå¯ä»¥åŒæ—¶ä¼ è¾“å¤šå±‚èŠ‚ç›®ã€‚\n\næ³¨æ„ï¼ŒDVBå…¨ç§°ä¸ºDigital Video Broadcastingï¼ŒåŒ…æ‹¬ä¸åŒçš„ç³»ç»Ÿï¼Œå¦‚å«æ˜Ÿæ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œæœ‰çº¿æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œåœ°é¢å¼€è·¯æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œäº¤äº’å¼æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿä»¥åŠæ•°å­—ç”µè§†åŠ æ‰°ç³»ç»Ÿã€‚DVBç³»ç»Ÿæ ‡å‡†æ˜¯ä¸€ç§å…¨çƒæ•°å­—ç”µè§†æŠ€æœ¯çš„æ ‡å‡†ã€‚å¦‚ä½•å®šä¹‰å¹¿æ’­ä¸­çš„æ¯”ç‰¹æµè¯­æ³•ä¸å¥æ³•ï¼Œä»¥å®ç°åœ¨æ¯”ç‰¹æµä¸­å¤ç”¨æ•°å­—éŸ³é¢‘ä¸è§†é¢‘ï¼Œæ¬§æ´²çš„DVBé‡‡ç”¨æ•°å­—è§†é¢‘å‹ç¼©MPEG-2æ ‡å‡†ï¼Œè¯¥æ ‡å‡†æ˜¯å®šä¹‰æ¯”ç‰¹æµçš„è¯­æ³•ä¸å¥æ³•çš„ä¸€ä¸ªISO/IECæ ‡å‡†ï¼Œå³13818-1æ ‡å‡†ã€‚DVBç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯æ˜¯é‡‡ç”¨MPEG-2æŠ€æœ¯è¿›è¡Œè§†é¢‘ã€éŸ³é¢‘çš„ç¼–ç ï¼Œä½¿ç”¨ç»Ÿä¸€çš„MPEG-2ä¼ è¾“æµï¼ˆTSæµï¼‰ã€‚\n\nMPEG-2æ ‡å‡†ä¸­ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„ç æµè¾“å‡ºåˆ°ä¿¡é“ï¼Œä¸€ç§æ˜¯èŠ‚ç›®ç æµï¼ˆPS: Program Streamï¼‰ï¼Œé€‚ç”¨äºæ²¡æœ‰ä¼ è¾“è¯¯å·®çš„åœºæ™¯ï¼›ä¸€ç§æ˜¯ä¼ é€æµï¼ˆTSï¼šTransport Stream)ï¼Œé€‚ç”¨äºæœ‰ä¿¡é“å™ªå£°çš„ä¼ è¾“åœºæ™¯ã€‚èŠ‚ç›®æµè®¾è®¡ç”¨äºåˆç†å¯é çš„åª’ä½“ï¼Œå¦‚å…‰ç›˜ï¼ˆå¦‚DVDï¼‰ï¼Œè€Œä¼ è¾“æµè®¾è®¡ç”¨äºä¸å¤ªå¯é çš„ä¼ è¾“ï¼Œå³åœ°é¢æˆ–å«æ˜Ÿå¹¿æ’­ã€‚æ­¤å¤–ï¼Œä¼ è¾“æµå¯ä»¥æºå¸¦å¤šä¸ªèŠ‚ç›®ã€‚\n\nMPEG-2 systemï¼ˆç¼–å·13818-1ï¼‰æ˜¯MPEG-2æ ‡å‡†çš„å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œè¯¥éƒ¨åˆ†æè¿°äº†å¤šä¸ªè§†é¢‘ï¼ŒéŸ³é¢‘å’Œæ•°æ®å¤šç§åŸºæœ¬æµï¼ˆESï¼‰åˆæˆä¼ è¾“æµï¼ˆTSï¼‰å’ŒèŠ‚ç›®æµï¼ˆPSï¼‰çš„æ–¹å¼ã€‚\n\n# TS ä»‹ç»\n\nä¸€è·¯TSæ¯”ç‰¹æµé€šå¸¸ç”±è¿ç»­çš„å›ºå®šå­—èŠ‚çš„TSåŒ…ç»„æˆï¼Œæ‰€åŒ…å«çš„å†…å®¹æœ‰ï¼š\n\n- ä¸€è·¯æˆ–å¤šè·¯è§†é¢‘æµï¼ˆå¤šä¸ªPESåŒ…ç»„æˆï¼Œæ¯ä¸ªPESåŒ…çš„PIDæ˜¯ä¸€è‡´çš„ï¼Œä¸€ä¸ªPESåŒ…å¯èƒ½ç”±è‹¥å¹²ä¸ªTSåŒ…ç»„æˆï¼‰\n\n- ä¸€è·¯æˆ–å¤šè·¯éŸ³é¢‘æµï¼ˆé€šå¸¸ä¸ºæœæ¯”çš„éŸ³é¢‘æ ¼å¼ï¼‰\n\n- ä¸€è·¯æˆ–å¤šè·¯å­—å¹•\n\n- PSIè¡¨æ ¼ä¿¡æ¯ï¼ˆProgram Specific Informationï¼ŒåŒ…æ‹¬PATä¸PMTè¡¨ï¼Œå³èŠ‚ç›®å…³è”è¡¨ä¸èŠ‚ç›®æ˜ å°„è¡¨ï¼‰\n\n- PES: Packetized Elementary Streamï¼Œä¸€è·¯åŸºæœ¬ç æµï¼ˆå¦‚MEPG2è§†é¢‘æµï¼‰ä¼šåœ¨ç¼–ç å™¨ç«¯è¢«æ‰“åŒ…æˆPESæµï¼Œç”±å¤šä¸ªPESåŒ…ç»„æˆï¼Œæ‰“åŒ…çš„è¿‡ç¨‹ä¸­ä¸»è¦åŠ å…¥äº†PTS/DTSä¿¡æ¯ã€‚\n\n\n\nPAT(Program Association Table)æè¿°æœ‰å¤šå°‘è·¯èŠ‚ç›®ï¼Œæ¯è·¯èŠ‚ç›®çš„PMTï¼ˆProgram Map Tableï¼‰è¡¨çš„PIDæ˜¯å¤šå°‘ï¼ŒPMTåˆ™æè¿°äº†æœ¬èŠ‚ç›®æœ‰å¤šå°‘æµï¼Œæ¯ä¸€è·¯æµçš„ç±»å‹ä¸PIDæ˜¯å¤šå°‘ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä½ æ‰¾ä¸ªä¸€ä¸ªTSåŒ…ï¼Œå®ƒçš„PIDæ˜¯0ï¼Œè¯´æ˜å®ƒçš„è´Ÿè½½å†…å®¹æ˜¯PATä¿¡æ¯ï¼Œè§£æPATä¿¡æ¯ï¼Œä½ å‘ç°èŠ‚ç›®1çš„PMTè¡¨çš„PIDæ˜¯0x10ï¼Œæ¥ç€ï¼Œä½ åœ¨æ¯”ç‰¹æµä¸­å¯»æ‰¾ä¸€ä¸ªPIDä¸º0x10çš„TSåŒ…ï¼Œå®ƒçš„è´Ÿè½½å†…å®¹æ˜¯èŠ‚ç›®1çš„PMTè¡¨ä¿¡æ¯ï¼Œè§£æè¯¥PMTä¿¡æ¯ï¼Œä½ å¯ä»¥å‘ç°ç¬¬ä¸€è·¯æµæ˜¯MPEG2éŸ³é¢‘æµï¼ŒPIDå·0x21ï¼Œç¬¬äºŒè·¯æµæ˜¯MPEG2è§†é¢‘æµï¼ŒPIDå·æ˜¯0x22ï¼Œç¬¬ä¸‰è·¯æµæ˜¯DVBå­—å¹•æµï¼ŒPIDå·æ˜¯0x23ï¼Œè§£æå®Œæ¯•ï¼Œå‡¡æ˜¯æ¯”ç‰¹æµä¸­PIDå·ä¸º0x22çš„TSåŒ…ï¼Œæ‰€è´Ÿè½½çš„å†…å®¹ä¸ºMPEG2è§†é¢‘æµï¼ŒæŠŠè¿™äº›åŒ…ä¸€ä¸ªä¸€ä¸ªæ‰¾å‡ºæ¥ï¼ŒæŠŠå…¶ä¸­çš„æœ‰æ•ˆç æµä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†çš„æ‹¼æ¥èµ·æ¥ï¼Œç„¶åé€ç»™è§£ç å™¨å»è§£ç ã€‚\n\næ³¨æ„ï¼Œå°±ä¸€èˆ¬çš„è§†é¢‘æµè€Œè¨€ï¼Œåªè¦æ‹¼æ¥æˆä¸€ä¸ªå®Œæ•´çš„PESåŒ…ï¼Œå°±å¯ä»¥é€å‡ºå»ç»™è§£ç å™¨ï¼Œç„¶åå†ç»§ç»­æ‹¼æ¥ä¸‹ä¸€ä¸ªPESåŒ…ã€‚\n\nä»€ä¹ˆæ˜¯ESæµï¼ŒPESæµï¼ŒTSæµï¼Ÿ\n\n- ESæµï¼šæœ‰ä¸‰ç§ï¼Œå›¾åƒæ•°æ®æµï¼ŒéŸ³é¢‘æ•°æ®æµï¼Œä»¥åŠå…¶ä»–ç¼–ç æ•°æ®æµã€‚\n\n- PESæµï¼šPESæµæ˜¯ESæµç»è¿‡PESæ‰“åŒ…å™¨å¤„ç†åå½¢æˆçš„æ•°æ®æµï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®Œæˆäº†å°†ESæµåˆ†ç»„ã€æ‰“åŒ…ã€åŠ å…¥åŒ…å¤´ä¿¡æ¯ç­‰æ“ä½œï¼ˆå¯¹ESæµçš„ç¬¬ä¸€æ¬¡æ‰“åŒ…ï¼‰ã€‚PESæµçš„åŸºæœ¬å•ä½æ˜¯PESåŒ…ã€‚\n\n- TSæµï¼šç”±å®šé•¿çš„TSåŒ…ç»„æˆï¼ˆ188å­—èŠ‚ï¼‰ï¼Œè€ŒTSåŒ…æ˜¯å¯¹PESåŒ…çš„ä¸€ä¸ªé‡æ–°å°è£…ï¼ˆåˆ°è¿™é‡Œï¼ŒESç»è¿‡äº†ä¸¤å±‚çš„å°è£…ï¼‰ ã€‚åº”ç”¨äºç›¸å¯¹æœ‰é”™ç¯å¢ƒä¸‹çš„ä¼ è¾“ä¸å­˜å‚¨ï¼ˆå¦‚DVBä¸­ï¼‰ï¼Œå…¶åŸºæœ¬å•ä½æ˜¯TSåŒ…ï¼Œé•¿åº¦å›ºå®š188å­—èŠ‚ã€‚æ—¥æœ¬çš„DVB-Så¹¿æ’­ç³»ç»Ÿé‡‡ç”¨192ä¸ªå­—èŠ‚çš„TSåŒ…ï¼Œç¾å›½é‡‡ç”¨204ä¸ªå­—èŠ‚çš„TSåŒ…ï¼Œå¤šåŠ äº†16ä¸ªå­—èŠ‚çš„å‰å‘çº é”™æ ¡éªŒç ï¼ˆFECï¼‰ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655696635121665569663420.png)\nFig. 1. ESæµæ‰“åŒ…æˆPESæµ\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655697239811665569723213.png)\nFig. 2. PESæµæ‰“åŒ…æˆTSæµ\n\nä»€ä¹ˆæ˜¯PSIè¡¨ï¼Ÿ\n\nPSI(Program Specific Info)ï¼ŒèŠ‚ç›®ç‰¹å®šä¿¡æ¯ï¼Œè¯¥è¡¨æ ¼ä¿¡æ¯ç”¨æ¥æè¿°ä¼ é€æµçš„ç»„æˆç»“æ„ã€‚PSIä¿¡æ¯ç”±å››ç§ç±»å‹çš„è¡¨ç»„æˆï¼ŒåŒ…æ‹¬èŠ‚ç›®å…³è”è¡¨ï¼ˆPATï¼‰ï¼ŒèŠ‚ç›®æ˜ å°„è¡¨ï¼ˆPMTï¼‰ï¼Œæ¡ä»¶æ¥æ”¶è¡¨ï¼ˆCATï¼‰ï¼Œç½‘ç»œä¿¡æ¯è¡¨ï¼ˆNITï¼‰ã€‚PATä¸PMTä¸¤å¼ è¡¨å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°è¯¥ä¼ é€æµä¸­çš„æ‰€æœ‰èŠ‚ç›®ä¸æµï¼ŒPATå‘Šè¯‰æˆ‘ä»¬ï¼Œè¯¥TSæµç”±å“ªäº›èŠ‚ç›®ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç›®çš„èŠ‚ç›®æ˜ å°„è¡¨PMTçš„PIDæ˜¯ä»€ä¹ˆï¼Œè€ŒPMTå‘Šè¯‰æˆ‘ä»¬ï¼Œè¯¥èŠ‚ç›®ç”±å“ªäº›æµç»„æˆï¼Œæ¯ä¸€è·¯æµçš„ç±»å‹ä¸PIDæ˜¯ä»€ä¹ˆã€‚CATä¸NITæš‚æ—¶ä¸è€ƒè™‘ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655698149521665569814410.png)\n\nFig. 3. PSIè¡¨\n\n# TSè§£å°è£…çš„åŸç†\n\nTSæµçš„å½¢æˆè¿‡ç¨‹ï¼š\n\n1. å°†åŸå§‹éŸ³è§†é¢‘æ•°æ®å‹ç¼©ä¹‹åï¼Œå‹ç¼©ç»“æœç»„æˆä¸€ä¸ªåŸºæœ¬ç æµï¼ˆESï¼‰ã€‚\n2. å¯¹ESï¼ˆåŸºæœ¬ç æµï¼‰è¿›è¡Œæ‰“åŒ…å½¢æˆPESã€‚\n3. åœ¨PESåŒ…ä¸­åŠ å…¥æ—¶é—´æˆ³ä¿¡æ¯(PTS/DTS)ã€‚\n4. å°†PESåŒ…å†…å®¹åˆ†é…åˆ°ä¸€ç³»åˆ—å›ºå®šé•¿åº¦çš„ä¼ è¾“åŒ…ï¼ˆTS Packetï¼‰ä¸­ã€‚\n5. åœ¨ä¼ è¾“åŒ…ä¸­åŠ å…¥å®šæ—¶ä¿¡æ¯(PCR)ã€‚\n6. åœ¨ä¼ è¾“åŒ…ä¸­åŠ å…¥èŠ‚ç›®ä¸“ç”¨ä¿¡æ¯(PSI) ã€‚\n7. è¿ç»­è¾“å‡ºä¼ è¾“åŒ…å½¢æˆå…·æœ‰æ’å®šæ¯”ç‰¹ç‡çš„MPEG-TSæµã€‚\n\nTSæµçš„è§£æè¿‡ç¨‹ï¼Œå¯ä»¥è¯´æ˜¯ç”Ÿæˆçš„é€†è¿‡ç¨‹ï¼š\n\n1. ä»å¤ç”¨çš„MPEG-TSæµä¸­è§£æå‡ºTSåŒ…ï¼›\n2. ä»TSåŒ…ä¸­è·å–PATåŠå¯¹åº”çš„PMTï¼ˆPSIä¸­çš„è¡¨æ ¼ï¼‰ï¼›\n3. ä»è€Œè·å–ç‰¹å®šèŠ‚ç›®çš„éŸ³è§†é¢‘PIDï¼›\n4. é€šè¿‡PIDç­›é€‰å‡ºç‰¹å®šéŸ³è§†é¢‘ç›¸å…³çš„TSåŒ…ï¼Œå¹¶è§£æå‡ºPESï¼›\n5. ä»PESä¸­è¯»å–åˆ°PTS/DTSï¼Œå¹¶ä»PESä¸­è§£æå‡ºåŸºæœ¬ç æµESï¼›\n6. å°†ESäº¤ç»™è§£ç å™¨ï¼Œè·å¾—å‹ç¼©å‰çš„åŸå§‹éŸ³è§†é¢‘æ•°æ®\n\n# TSæ ¼å¼è¯¦è§£\n\n## 1. TSåŒ…æ ¼å¼\nTSåŒ…ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€æ˜¯4ä¸ªå­—èŠ‚çš„åŒ…å¤´ä¿¡æ¯ï¼ŒäºŒæ˜¯æœ‰æ•ˆè½½è·ï¼Œå¦å¤–ä¸­é—´æœ‰å¯èƒ½æ’å…¥è‡ªé€‚åº”è°ƒæ•´å­—æ®µã€‚æœ‰æ•ˆè½½è·åŒ…æ‹¬èŠ‚ç›®ä¸“ç”¨ä¿¡æ¯ï¼Œæ‰“åŒ…åçš„æµæ•°æ®ï¼Œä»¥åŠä¸šåŠ¡ä¿¡æ¯ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655700779571665570077901.png)\n\nFig. 4. TSåŒ…çš„ç»„æˆç»“æ„\n\nTSçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655701129401665570112830.png)\n\nFig. 5. TSçš„è¯­æ³•ç»“æ„\n\nä¸»è¦å­—æ®µè§£æï¼š\nSync byte:åŒæ­¥å­—èŠ‚ï¼Œå€¼ä¸º0x47ï¼›\n\nTransport error indicator:ä¼ è¾“é”™è¯¯æŒ‡ç¤ºä½ï¼Œç½®1æ—¶ï¼Œè¡¨ç¤ºä¼ é€åŒ…ä¸­è‡³å°‘æœ‰ä¸€ä¸ªä¸å¯çº æ­£çš„é”™è¯¯ä½ã€‚\n\nPayload unit start indicator:è´Ÿè½½å•å…ƒèµ·å§‹æŒ‡æ ‡ä½ï¼Œè¡¨ç¤ºTSåŒ…çš„æœ‰æ•ˆå‡€è·ä»¥PES/PSIåŒ…çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªPESåŒ…å¯èƒ½ç”±å¤šä¸ªTSåŒ…æ„æˆï¼Œç¬¬ä¸€ä¸ªTSåŒ…çš„è´Ÿè½½å•å…ƒèµ·å§‹æŒ‡æ ‡ä½æ‰ä¼šè¢«ç½®ä½ã€‚\n\nTransport priority:ä¼ è¾“ä¼˜å…ˆçº§ï¼Œè¡¨æ˜è¯¥åŒ…æ¯”åŒä¸ªPIDçš„ä½†æœªç½®ä½çš„TSåŒ…æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚\n\nPID:è¯¥TSåŒ…çš„IDå·ï¼Œå¦‚æœå‡€è·æ˜¯PATåŒ…ï¼Œåˆ™PIDå›ºå®šä¸º0x00ã€‚\n\nTransport scrambling control:ä¼ è¾“åŠ æ‰°æ§åˆ¶ä½\n\nAdaption field control:è‡ªé€‚åº”è°ƒæ•´åŸŸæ§åˆ¶ä½ï¼Œç½®ä½åˆ™è¡¨æ˜è¯¥TSåŒ…å­˜åœ¨è‡ªé€‚åº”è°ƒæ•´å­—æ®µã€‚\n\nContinuity counter:è¿ç»­è®¡æ•°å™¨ï¼Œéšç€å…·æœ‰ç›¸åŒPIDçš„TSåŒ…çš„å¢åŠ è€Œå¢åŠ ï¼Œè¾¾åˆ°æœ€å¤§æ—¶æ¢å¤ä¸º0ï¼Œå¦‚æœä¸¤ä¸ªè¿ç»­ç›¸åŒPIDçš„TSåŒ…å…·æœ‰ç›¸åŒçš„è®¡æ•°ï¼Œåˆ™è¡¨æ˜è¿™ä¸¤ä¸ªåŒ…æ˜¯ä¸€æ ·çš„ï¼Œåªå–ä¸€ä¸ªè§£æå³å¯ã€‚\n\nPayload:è´Ÿè½½å†…å®¹ï¼Œå¯èƒ½ä¸ºPAT/PMT/PESã€‚data_byteä¸º1Bé•¿\nåº¦çš„æ•°æ®ï¼Œä¸ºè´Ÿè½½å­—èŠ‚ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655826274671665582627092.png)\n\nFig. 6. TSçš„è¯­æ³•ç»“æ„ä»£ç ç¤ºæ„\n\n## 2. PAT æ ¼å¼\n\nPATçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655846904131665584689570.png)\nFig. 7. PATçš„è¯­æ³•ç»“æ„ç¤ºæ„\n\nä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š\n\ntable_id: æ ‡è¯†ä¸€ä¸ªTS PSI åˆ†æ®µçš„å†…å®¹æ˜¯èŠ‚ç›®å…³è”åˆ†æ®µï¼Œæ¡ä»¶è®¿é—®åˆ†æ®µè¿˜æ˜¯èŠ‚ç›®æ˜ å°„åˆ†æ®µã€‚å¯¹äºPATï¼Œç½®ä¸º0x00ã€‚\n\nsection_syntax_indicator: å¯¹äºPATï¼Œç½®ä¸º0x01ã€‚\n\nsection_length: åˆ†æ®µé•¿åº¦å­—æ®µï¼Œå…¶å€¼ä¸ºä»section_lengthï¼ˆä¸åŒ…æ‹¬åœ¨å†…ï¼‰åˆ°CRC_32å­—æ®µçš„å­—èŠ‚æ•°ï¼Œå…¶å€¼ä¸è¶…è¿‡1021ã€‚\n\ntransport_stream_id: åŒºåˆ«ä¸å…¶ä»–å¤ç”¨æµçš„æ ‡è¯†ã€‚\n\nversion_number: PATçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœPATæœ‰å˜ï¼Œåˆ™ç‰ˆæœ¬å·åŠ 1ã€‚\n\ncurrent_next_indicator:ç½®0æ—¶ï¼Œè¡¨æ˜è¯¥ä¼ é€çš„è¡¨åˆ†æ®µä¸èƒ½ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªè¡¨åˆ†æ®µæ‰æœ‰æ•ˆã€‚\n\nsection_number: è¡¨æ˜è¯¥TSåŒ…å±äºè¯¥PATçš„ç¬¬å‡ ä¸ªåˆ†æ®µï¼Œåˆ†æ®µå·ä»0å¼€å§‹ã€‚\n\nlast_section_number: è¡¨æ˜æœ€åä¸€ä¸ªåˆ†æ®µå·ï¼ŒåŒæ—¶è¡¨æ˜è¯¥PATçš„æœ€å¤§åˆ†æ®µæ•°ç›®ã€‚ä¸€èˆ¬ï¼Œä¸€ä¸ªPATè¡¨ç”±ä¸€ä¸ªTSåŒ…ä¼ é€ã€‚\n\nprogram_number: èŠ‚ç›®çš„ç¼–å·ã€‚\n\nnetwork_PID: NITè¡¨çš„PIDå€¼ã€‚\n\nprogram_map_PID: PMTè¡¨çš„PIDå€¼ã€‚\n\nCRC_32: CRCæ ¡éªŒã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655849004091665584900226.png)\nFig. 8. PATè¯­æ³•ç»“æ„ä»£ç ç¤ºæ„\n## 3. PMT æ ¼å¼\n\nPMTçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655849504061665584950270.png)\nFig. 9. PMTè¯­æ³•ç»“æ„\n\nä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š\n\ntable_id: æ ‡è¯†ä¸€ä¸ªTS PSI åˆ†æ®µçš„å†…å®¹æ˜¯èŠ‚ç›®å…³è”åˆ†æ®µï¼Œæ¡ä»¶è®¿é—®åˆ†æ®µè¿˜æ˜¯èŠ‚ç›®æ˜ å°„åˆ†æ®µã€‚å¯¹äºPMTï¼Œç½®ä¸º0x02ã€‚\n\nsection_syntax_indicator: å¯¹äºPMTï¼Œç½®ä¸º0x01ã€‚\n\nsection_length: åˆ†æ®µé•¿åº¦å­—æ®µï¼Œå…¶å€¼ä¸ºä»section_lengthï¼ˆåŒ…æ‹¬åœ¨å†…ï¼‰åˆ°CRC_32å­—æ®µçš„å­—èŠ‚æ•°ï¼Œå…¶å€¼ä¸è¶…è¿‡1021ã€‚\n\nprogram_number: è¡¨æ˜ä¸€å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç›®ã€‚\n\nversion_number: PMTçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœå­—æ®µä¸­æœ‰å…³ä¿¡æ¯æœ‰å˜ï¼Œåˆ™ç‰ˆæœ¬å·ä»¥32ä¸ºæ¨¡åŠ 1ã€‚ç‰ˆæœ¬å·æ˜¯å¯¹ä¸€ä¸ªèŠ‚ç›®çš„å®šä¹‰ã€‚\n\ncurrent_next_indicator:ç½®0æ—¶ï¼Œè¡¨æ˜è¯¥ä¼ é€çš„è¡¨åˆ†æ®µä¸èƒ½ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªè¡¨åˆ†æ®µæ‰æœ‰æ•ˆã€‚\n\nsection_number: æ€»ä¸º0x00ã€‚\n\nlast_section_number: æ€»ä¸º0x00ã€‚\n\nPCR_PID: æŒ‡ç¤ºå«æœ‰è¯¥èŠ‚ç›®çš„PCRå­—æ®µçš„TSåŒ…çš„PIDã€‚\n\nprogram_info_length: è¡¨æ˜è·Ÿéšå…¶åçš„å¯¹èŠ‚ç›®ä¿¡æ¯æè¿°çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªN loop descriptorsçš„å­—èŠ‚æ•°ã€‚\n\nstream_type: è¡¨æ˜PESæµçš„ç±»å‹ã€‚è­¬å¦‚ï¼Œ0x01è¡¨æ˜æ˜¯MPEG-1è§†é¢‘ï¼Œ0X03è¡¨æ˜æ˜¯MPEG-1éŸ³é¢‘ã€‚\n\nelementary_PID: è¡¨æ˜è¯¥è´Ÿè½½æœ‰è¯¥PESæµçš„TSåŒ…çš„PIDå€¼ã€‚\n\nES_info_length: è¡¨æ˜è·Ÿéšå…¶åçš„æè¿°ç›¸å…³èŠ‚ç›®å…ƒç´ çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªN loop descriptorsçš„å­—èŠ‚æ•°ã€‚\n\nCRC_32: åœ¨CEDARXä»£ç ä¸­ä»…å¯¹DVBçš„åœºæ™¯ä¸‹ä½œæ ¡éªŒã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655851034681665585103423.png)\n\nFig. 10. PMTçš„è¯­æ³•ç»“æ„ä»£ç ç¤ºæ„\n\n## 4.PESæ ¼å¼\n\nPESçš„è¯­æ³•å¦‚å›¾10æ‰€ç¤ºï¼Œå®ƒæºå¸¦çš„ä¸»è¦ä¿¡æ¯åŒ…æ‹¬æµçš„IDï¼ŒPESåŒ…çš„é•¿åº¦ï¼ŒPTSä»¥åŠæµçš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯éŸ³è§†é¢‘ä¸å­—å¹•æ•°æ®ã€‚\n\nä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š\n\npacket_start_code_prefix: å›ºå®š0x000001\n\nstream_id: æŒ‡å®šåŸºæœ¬æµçš„ç±»å‹ä¸ç¼–å·\n\nPES_packet_length: è¡¨æ˜åœ¨è¯¥å­—æ®µåé¢è¿˜æœ‰å¤šå°‘ä¸ªå­—èŠ‚ã€‚0è¡¨æ˜PESåŒ…çš„é•¿åº¦æœªæŒ‡ç¤ºä¹Ÿæœªé™å®šï¼Œå¯¹äºå½“å‰çš„PESåŒ…è€Œè¨€ã€‚\n\nPES_scrambling_control: PESåŒ…çš„æœ‰æ•ˆè½½è·çš„åŠ æ‰°æ–¹å¼ã€‚\n\nPES_priority: å¤šè·¯å¤ç”¨å™¨å¯ä»¥é€šè¿‡è¯¥ä½æœ€ä¼˜åŒ–åŸºæœ¬æµå†…çš„æ•°æ®ã€‚\n\ndata_alignment_indicator:\n\ncopyright: PESåŒ…ä¸­çš„æœ‰æ•ˆè½½è·ç¡®å®šå…·æœ‰ç‰ˆæƒçš„è¯ï¼Œå°±ç½®ä½ã€‚\n\norginal_or_copy: ç½®ä½æ—¶ï¼Œè¡¨æ˜PESåŒ…çš„æœ‰æ•ˆè½½è·çš„å†…å®¹æ˜¯åŸå§‹çš„ï¼Œéå¤åˆ¶çš„ã€‚\n\nPTS_DTS_flags: 2æ¯”ç‰¹å­—èŠ‚ï¼Œè¡¨æ˜PTS/DTCçš„å­˜åœ¨æƒ…å†µã€‚\n\nES_rate_flag: ç½®ä½ï¼Œè¡¨æ˜åé¢å­˜åœ¨ES_rateå­—æ®µã€‚\n\nPES_header_data_length: è¡¨æ˜è¯¥PESåŒ…å¤´ä¸­ç”±ä»»é€‰å­—æ®µä¸å¡«å……å­—èŠ‚æ‰€å æ®çš„å­—èŠ‚æ€»æ•°ã€‚ä»»é€‰å­—æ®µè­¬å¦‚ES_rateã€‚\n\nmarker_bit: ä¸º1çš„æ¯”ç‰¹ä½ã€‚\n\nPTS: å¯¹äºéŸ³é¢‘è€Œè¨€ï¼Œå¦‚æœè¯¥PESåŒ…ä¸­å­˜åœ¨PTSå­—æ®µï¼Œåˆ™æœ‰æ•ˆè´Ÿè½½ä¸­è‚¯å®šæœ‰æ–°çš„éŸ³é¢‘å­˜å–å•å…ƒï¼ˆaccess unitï¼‰ï¼Œè¯¥PTSå¯¹åº”äºè¯¥éŸ³é¢‘å­˜å–å•å…ƒã€‚æ–°çš„éŸ³é¢‘å­˜å–å•å…ƒæŒ‡çš„æ˜¯ä¸€å¸§æ–°çš„éŸ³é¢‘å¸§ã€‚å¯¹äºè§†é¢‘è€Œè¨€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè·ŸéŸ³é¢‘ä¸€æ ·ã€‚\n\nDTS: è§£ç æ—¶é—´æ ‡å¿—ï¼Œå½“å‰CEDARXè§£ç å™¨æœªç”¨åˆ°DTSã€‚\n\nES_rate: åŸºæœ¬æµé€Ÿç‡ï¼ŒæŒ‡å®šç³»ç»Ÿç›®æ ‡è§£ç å™¨æ¥æ”¶PESåŒ…å­—èŠ‚çš„é€Ÿç‡ã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655853343991665585333549.png)\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655858313871061665585632_.jpg)\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655858713891665585871171.png)\nFig. 11. PESçš„è¯­æ³•ç»“æ„ä»£ç \n# å‚è€ƒèµ„æ–™\n\n[1] ISO / IECæ ‡å‡†13818-1æˆ–ITU-Tå»ºè®®ä¹¦ http://www.itu.int/rec/T-REC-H.222.0\n\n[2] ã€Šæ•°å­—ç”µè§†ä¸šåŠ¡ä¿¡æ¯åŠå…¶ç¼–ç ã€‹ï¼Œæ–¹æ¶›ï¼Œå›½é˜²å·¥ä¸šå‡ºç‰ˆç¤¾\n\n[3] https://wenku.baidu.com/view/87f5439c2f60ddccdb38a066.html?rec_flag=default\n\n[4] TSç æµç»“æ„åˆ†æPPTï¼Œç½‘ç»œèµ„æ–™\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n\nç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€ŒKayson12345ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚\nåŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/Kayson12345/article/details/81266587\n\n\n\n\n\n\n# ä¸ªäººç†è§£\n\nä»TSæµä¸­è·å–PATï¼Œè§£æPATå¾—åˆ°èŠ‚ç›®åˆ—è¡¨ï¼Œæ¯ä¸ªèŠ‚ç›®åˆ—è¡¨å¯¹åº”ä¸€ä¸ªPMTï¼Œ ä»PMTä¸­å¾—è¯¥èŠ‚ç›®å¯¹åº”çš„éŸ³è§†é¢‘PIDï¼Œ ä»TSæµæ ¹æ®PIDæ»¤å‡ºéŸ³è§†é¢‘TSåŒ…ï¼Œå°†TSåŒ…è¿˜åŸä¸ºPESåŒ…ï¼Œè¿›è€Œè¿˜åŸä¸ºESæµï¼ˆh264, aacï¼‰é€ç»™è§£ç å™¨è§£ç ã€‚\n\nç»“åˆ[An introduction to MPEG-TS](https://tsduck.io/download/docs/mpegts-introduction.pdf)çœ‹èµ·æ¥æ›´æ˜“äºç†è§£ã€‚\n\n# åˆ†æå·¥å…·\n[easyice ](https://easyice.cn/archives/85)","slug":"hls/2022-10-12-MPEG-TS æ ¼å¼åˆ†æ","published":1,"updated":"2024-03-06T11:53:13.566Z","comments":1,"photos":[],"_id":"clti3glko001f57wh8r2a9gr6","content":"<p>å‚è€ƒï¼š<br><a href=\"https://blog.csdn.net/Kayson12345/article/details/81266587\">MPEG-TS æ ¼å¼è§£æ</a></p>\n<p><a href=\"https://tsduck.io/download/docs/mpegts-introduction.pdf\">An introduction to MPEG-TS</a></p>\n<h1 id=\"èƒŒæ™¯ä»‹ç»\"><a href=\"#èƒŒæ™¯ä»‹ç»\" class=\"headerlink\" title=\"èƒŒæ™¯ä»‹ç»\"></a>èƒŒæ™¯ä»‹ç»</h1><p>MPEG-TSä¸€ç§æ ‡å‡†æ•°æ®å®¹å™¨æ ¼å¼ï¼Œä¼ è¾“ä¸å­˜å‚¨éŸ³è§†é¢‘ã€èŠ‚ç›®ä¸ç³»ç»Ÿä¿¡æ¯åè®®æ•°æ®ï¼Œåº”ç”¨äºæ•°å­—å¹¿æ’­ç³»ç»Ÿï¼Œè­¬å¦‚DVB,ATSCä¸IPTVã€‚ä¼ è¾“æµåœ¨MPEG-2ç¬¬1éƒ¨åˆ†ç³»ç»Ÿä¸­è§„å®šï¼Œæ­£å¼ç§°ä¸ºISO &#x2F; IECæ ‡å‡†13818-1æˆ–ITU-Tå»ºè®®ä¹¦[1]ã€‚</p>\n<p>MPEG2&#x2F;DVBæ˜¯ä¸€ç§å¤šåª’ä½“ä¼ è¾“ã€å¤ç”¨æŠ€æœ¯ï¼Œåœ¨æ•°å­—ç”µè§†å¹¿æ’­ä¸­å¯æä¾›æ•°ç™¾ä¸ªèŠ‚ç›®é¢‘é“ã€‚å¤ç”¨çš„å«ä¹‰æ˜¯ï¼Œå¯ä»¥åŒæ—¶ä¼ è¾“å¤šå±‚èŠ‚ç›®ã€‚</p>\n<p>æ³¨æ„ï¼ŒDVBå…¨ç§°ä¸ºDigital Video Broadcastingï¼ŒåŒ…æ‹¬ä¸åŒçš„ç³»ç»Ÿï¼Œå¦‚å«æ˜Ÿæ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œæœ‰çº¿æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œåœ°é¢å¼€è·¯æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œäº¤äº’å¼æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿä»¥åŠæ•°å­—ç”µè§†åŠ æ‰°ç³»ç»Ÿã€‚DVBç³»ç»Ÿæ ‡å‡†æ˜¯ä¸€ç§å…¨çƒæ•°å­—ç”µè§†æŠ€æœ¯çš„æ ‡å‡†ã€‚å¦‚ä½•å®šä¹‰å¹¿æ’­ä¸­çš„æ¯”ç‰¹æµè¯­æ³•ä¸å¥æ³•ï¼Œä»¥å®ç°åœ¨æ¯”ç‰¹æµä¸­å¤ç”¨æ•°å­—éŸ³é¢‘ä¸è§†é¢‘ï¼Œæ¬§æ´²çš„DVBé‡‡ç”¨æ•°å­—è§†é¢‘å‹ç¼©MPEG-2æ ‡å‡†ï¼Œè¯¥æ ‡å‡†æ˜¯å®šä¹‰æ¯”ç‰¹æµçš„è¯­æ³•ä¸å¥æ³•çš„ä¸€ä¸ªISO&#x2F;IECæ ‡å‡†ï¼Œå³13818-1æ ‡å‡†ã€‚DVBç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯æ˜¯é‡‡ç”¨MPEG-2æŠ€æœ¯è¿›è¡Œè§†é¢‘ã€éŸ³é¢‘çš„ç¼–ç ï¼Œä½¿ç”¨ç»Ÿä¸€çš„MPEG-2ä¼ è¾“æµï¼ˆTSæµï¼‰ã€‚</p>\n<p>MPEG-2æ ‡å‡†ä¸­ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„ç æµè¾“å‡ºåˆ°ä¿¡é“ï¼Œä¸€ç§æ˜¯èŠ‚ç›®ç æµï¼ˆPS: Program Streamï¼‰ï¼Œé€‚ç”¨äºæ²¡æœ‰ä¼ è¾“è¯¯å·®çš„åœºæ™¯ï¼›ä¸€ç§æ˜¯ä¼ é€æµï¼ˆTSï¼šTransport Stream)ï¼Œé€‚ç”¨äºæœ‰ä¿¡é“å™ªå£°çš„ä¼ è¾“åœºæ™¯ã€‚èŠ‚ç›®æµè®¾è®¡ç”¨äºåˆç†å¯é çš„åª’ä½“ï¼Œå¦‚å…‰ç›˜ï¼ˆå¦‚DVDï¼‰ï¼Œè€Œä¼ è¾“æµè®¾è®¡ç”¨äºä¸å¤ªå¯é çš„ä¼ è¾“ï¼Œå³åœ°é¢æˆ–å«æ˜Ÿå¹¿æ’­ã€‚æ­¤å¤–ï¼Œä¼ è¾“æµå¯ä»¥æºå¸¦å¤šä¸ªèŠ‚ç›®ã€‚</p>\n<p>MPEG-2 systemï¼ˆç¼–å·13818-1ï¼‰æ˜¯MPEG-2æ ‡å‡†çš„å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œè¯¥éƒ¨åˆ†æè¿°äº†å¤šä¸ªè§†é¢‘ï¼ŒéŸ³é¢‘å’Œæ•°æ®å¤šç§åŸºæœ¬æµï¼ˆESï¼‰åˆæˆä¼ è¾“æµï¼ˆTSï¼‰å’ŒèŠ‚ç›®æµï¼ˆPSï¼‰çš„æ–¹å¼ã€‚</p>\n<h1 id=\"TS-ä»‹ç»\"><a href=\"#TS-ä»‹ç»\" class=\"headerlink\" title=\"TS ä»‹ç»\"></a>TS ä»‹ç»</h1><p>ä¸€è·¯TSæ¯”ç‰¹æµé€šå¸¸ç”±è¿ç»­çš„å›ºå®šå­—èŠ‚çš„TSåŒ…ç»„æˆï¼Œæ‰€åŒ…å«çš„å†…å®¹æœ‰ï¼š</p>\n<ul>\n<li><p>ä¸€è·¯æˆ–å¤šè·¯è§†é¢‘æµï¼ˆå¤šä¸ªPESåŒ…ç»„æˆï¼Œæ¯ä¸ªPESåŒ…çš„PIDæ˜¯ä¸€è‡´çš„ï¼Œä¸€ä¸ªPESåŒ…å¯èƒ½ç”±è‹¥å¹²ä¸ªTSåŒ…ç»„æˆï¼‰</p>\n</li>\n<li><p>ä¸€è·¯æˆ–å¤šè·¯éŸ³é¢‘æµï¼ˆé€šå¸¸ä¸ºæœæ¯”çš„éŸ³é¢‘æ ¼å¼ï¼‰</p>\n</li>\n<li><p>ä¸€è·¯æˆ–å¤šè·¯å­—å¹•</p>\n</li>\n<li><p>PSIè¡¨æ ¼ä¿¡æ¯ï¼ˆProgram Specific Informationï¼ŒåŒ…æ‹¬PATä¸PMTè¡¨ï¼Œå³èŠ‚ç›®å…³è”è¡¨ä¸èŠ‚ç›®æ˜ å°„è¡¨ï¼‰</p>\n</li>\n<li><p>PES: Packetized Elementary Streamï¼Œä¸€è·¯åŸºæœ¬ç æµï¼ˆå¦‚MEPG2è§†é¢‘æµï¼‰ä¼šåœ¨ç¼–ç å™¨ç«¯è¢«æ‰“åŒ…æˆPESæµï¼Œç”±å¤šä¸ªPESåŒ…ç»„æˆï¼Œæ‰“åŒ…çš„è¿‡ç¨‹ä¸­ä¸»è¦åŠ å…¥äº†PTS&#x2F;DTSä¿¡æ¯ã€‚</p>\n</li>\n</ul>\n<p>PAT(Program Association Table)æè¿°æœ‰å¤šå°‘è·¯èŠ‚ç›®ï¼Œæ¯è·¯èŠ‚ç›®çš„PMTï¼ˆProgram Map Tableï¼‰è¡¨çš„PIDæ˜¯å¤šå°‘ï¼ŒPMTåˆ™æè¿°äº†æœ¬èŠ‚ç›®æœ‰å¤šå°‘æµï¼Œæ¯ä¸€è·¯æµçš„ç±»å‹ä¸PIDæ˜¯å¤šå°‘ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä½ æ‰¾ä¸ªä¸€ä¸ªTSåŒ…ï¼Œå®ƒçš„PIDæ˜¯0ï¼Œè¯´æ˜å®ƒçš„è´Ÿè½½å†…å®¹æ˜¯PATä¿¡æ¯ï¼Œè§£æPATä¿¡æ¯ï¼Œä½ å‘ç°èŠ‚ç›®1çš„PMTè¡¨çš„PIDæ˜¯0x10ï¼Œæ¥ç€ï¼Œä½ åœ¨æ¯”ç‰¹æµä¸­å¯»æ‰¾ä¸€ä¸ªPIDä¸º0x10çš„TSåŒ…ï¼Œå®ƒçš„è´Ÿè½½å†…å®¹æ˜¯èŠ‚ç›®1çš„PMTè¡¨ä¿¡æ¯ï¼Œè§£æè¯¥PMTä¿¡æ¯ï¼Œä½ å¯ä»¥å‘ç°ç¬¬ä¸€è·¯æµæ˜¯MPEG2éŸ³é¢‘æµï¼ŒPIDå·0x21ï¼Œç¬¬äºŒè·¯æµæ˜¯MPEG2è§†é¢‘æµï¼ŒPIDå·æ˜¯0x22ï¼Œç¬¬ä¸‰è·¯æµæ˜¯DVBå­—å¹•æµï¼ŒPIDå·æ˜¯0x23ï¼Œè§£æå®Œæ¯•ï¼Œå‡¡æ˜¯æ¯”ç‰¹æµä¸­PIDå·ä¸º0x22çš„TSåŒ…ï¼Œæ‰€è´Ÿè½½çš„å†…å®¹ä¸ºMPEG2è§†é¢‘æµï¼ŒæŠŠè¿™äº›åŒ…ä¸€ä¸ªä¸€ä¸ªæ‰¾å‡ºæ¥ï¼ŒæŠŠå…¶ä¸­çš„æœ‰æ•ˆç æµä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†çš„æ‹¼æ¥èµ·æ¥ï¼Œç„¶åé€ç»™è§£ç å™¨å»è§£ç ã€‚</p>\n<p>æ³¨æ„ï¼Œå°±ä¸€èˆ¬çš„è§†é¢‘æµè€Œè¨€ï¼Œåªè¦æ‹¼æ¥æˆä¸€ä¸ªå®Œæ•´çš„PESåŒ…ï¼Œå°±å¯ä»¥é€å‡ºå»ç»™è§£ç å™¨ï¼Œç„¶åå†ç»§ç»­æ‹¼æ¥ä¸‹ä¸€ä¸ªPESåŒ…ã€‚</p>\n<p>ä»€ä¹ˆæ˜¯ESæµï¼ŒPESæµï¼ŒTSæµï¼Ÿ</p>\n<ul>\n<li><p>ESæµï¼šæœ‰ä¸‰ç§ï¼Œå›¾åƒæ•°æ®æµï¼ŒéŸ³é¢‘æ•°æ®æµï¼Œä»¥åŠå…¶ä»–ç¼–ç æ•°æ®æµã€‚</p>\n</li>\n<li><p>PESæµï¼šPESæµæ˜¯ESæµç»è¿‡PESæ‰“åŒ…å™¨å¤„ç†åå½¢æˆçš„æ•°æ®æµï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®Œæˆäº†å°†ESæµåˆ†ç»„ã€æ‰“åŒ…ã€åŠ å…¥åŒ…å¤´ä¿¡æ¯ç­‰æ“ä½œï¼ˆå¯¹ESæµçš„ç¬¬ä¸€æ¬¡æ‰“åŒ…ï¼‰ã€‚PESæµçš„åŸºæœ¬å•ä½æ˜¯PESåŒ…ã€‚</p>\n</li>\n<li><p>TSæµï¼šç”±å®šé•¿çš„TSåŒ…ç»„æˆï¼ˆ188å­—èŠ‚ï¼‰ï¼Œè€ŒTSåŒ…æ˜¯å¯¹PESåŒ…çš„ä¸€ä¸ªé‡æ–°å°è£…ï¼ˆåˆ°è¿™é‡Œï¼ŒESç»è¿‡äº†ä¸¤å±‚çš„å°è£…ï¼‰ ã€‚åº”ç”¨äºç›¸å¯¹æœ‰é”™ç¯å¢ƒä¸‹çš„ä¼ è¾“ä¸å­˜å‚¨ï¼ˆå¦‚DVBä¸­ï¼‰ï¼Œå…¶åŸºæœ¬å•ä½æ˜¯TSåŒ…ï¼Œé•¿åº¦å›ºå®š188å­—èŠ‚ã€‚æ—¥æœ¬çš„DVB-Så¹¿æ’­ç³»ç»Ÿé‡‡ç”¨192ä¸ªå­—èŠ‚çš„TSåŒ…ï¼Œç¾å›½é‡‡ç”¨204ä¸ªå­—èŠ‚çš„TSåŒ…ï¼Œå¤šåŠ äº†16ä¸ªå­—èŠ‚çš„å‰å‘çº é”™æ ¡éªŒç ï¼ˆFECï¼‰ã€‚</p>\n</li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655696635121665569663420.png\"><br>Fig. 1. ESæµæ‰“åŒ…æˆPESæµ<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655697239811665569723213.png\"><br>Fig. 2. PESæµæ‰“åŒ…æˆTSæµ</p>\n<p>ä»€ä¹ˆæ˜¯PSIè¡¨ï¼Ÿ</p>\n<p>PSI(Program Specific Info)ï¼ŒèŠ‚ç›®ç‰¹å®šä¿¡æ¯ï¼Œè¯¥è¡¨æ ¼ä¿¡æ¯ç”¨æ¥æè¿°ä¼ é€æµçš„ç»„æˆç»“æ„ã€‚PSIä¿¡æ¯ç”±å››ç§ç±»å‹çš„è¡¨ç»„æˆï¼ŒåŒ…æ‹¬èŠ‚ç›®å…³è”è¡¨ï¼ˆPATï¼‰ï¼ŒèŠ‚ç›®æ˜ å°„è¡¨ï¼ˆPMTï¼‰ï¼Œæ¡ä»¶æ¥æ”¶è¡¨ï¼ˆCATï¼‰ï¼Œç½‘ç»œä¿¡æ¯è¡¨ï¼ˆNITï¼‰ã€‚PATä¸PMTä¸¤å¼ è¡¨å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°è¯¥ä¼ é€æµä¸­çš„æ‰€æœ‰èŠ‚ç›®ä¸æµï¼ŒPATå‘Šè¯‰æˆ‘ä»¬ï¼Œè¯¥TSæµç”±å“ªäº›èŠ‚ç›®ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç›®çš„èŠ‚ç›®æ˜ å°„è¡¨PMTçš„PIDæ˜¯ä»€ä¹ˆï¼Œè€ŒPMTå‘Šè¯‰æˆ‘ä»¬ï¼Œè¯¥èŠ‚ç›®ç”±å“ªäº›æµç»„æˆï¼Œæ¯ä¸€è·¯æµçš„ç±»å‹ä¸PIDæ˜¯ä»€ä¹ˆã€‚CATä¸NITæš‚æ—¶ä¸è€ƒè™‘ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655698149521665569814410.png\"></p>\n<p>Fig. 3. PSIè¡¨</p>\n<h1 id=\"TSè§£å°è£…çš„åŸç†\"><a href=\"#TSè§£å°è£…çš„åŸç†\" class=\"headerlink\" title=\"TSè§£å°è£…çš„åŸç†\"></a>TSè§£å°è£…çš„åŸç†</h1><p>TSæµçš„å½¢æˆè¿‡ç¨‹ï¼š</p>\n<ol>\n<li>å°†åŸå§‹éŸ³è§†é¢‘æ•°æ®å‹ç¼©ä¹‹åï¼Œå‹ç¼©ç»“æœç»„æˆä¸€ä¸ªåŸºæœ¬ç æµï¼ˆESï¼‰ã€‚</li>\n<li>å¯¹ESï¼ˆåŸºæœ¬ç æµï¼‰è¿›è¡Œæ‰“åŒ…å½¢æˆPESã€‚</li>\n<li>åœ¨PESåŒ…ä¸­åŠ å…¥æ—¶é—´æˆ³ä¿¡æ¯(PTS&#x2F;DTS)ã€‚</li>\n<li>å°†PESåŒ…å†…å®¹åˆ†é…åˆ°ä¸€ç³»åˆ—å›ºå®šé•¿åº¦çš„ä¼ è¾“åŒ…ï¼ˆTS Packetï¼‰ä¸­ã€‚</li>\n<li>åœ¨ä¼ è¾“åŒ…ä¸­åŠ å…¥å®šæ—¶ä¿¡æ¯(PCR)ã€‚</li>\n<li>åœ¨ä¼ è¾“åŒ…ä¸­åŠ å…¥èŠ‚ç›®ä¸“ç”¨ä¿¡æ¯(PSI) ã€‚</li>\n<li>è¿ç»­è¾“å‡ºä¼ è¾“åŒ…å½¢æˆå…·æœ‰æ’å®šæ¯”ç‰¹ç‡çš„MPEG-TSæµã€‚</li>\n</ol>\n<p>TSæµçš„è§£æè¿‡ç¨‹ï¼Œå¯ä»¥è¯´æ˜¯ç”Ÿæˆçš„é€†è¿‡ç¨‹ï¼š</p>\n<ol>\n<li>ä»å¤ç”¨çš„MPEG-TSæµä¸­è§£æå‡ºTSåŒ…ï¼›</li>\n<li>ä»TSåŒ…ä¸­è·å–PATåŠå¯¹åº”çš„PMTï¼ˆPSIä¸­çš„è¡¨æ ¼ï¼‰ï¼›</li>\n<li>ä»è€Œè·å–ç‰¹å®šèŠ‚ç›®çš„éŸ³è§†é¢‘PIDï¼›</li>\n<li>é€šè¿‡PIDç­›é€‰å‡ºç‰¹å®šéŸ³è§†é¢‘ç›¸å…³çš„TSåŒ…ï¼Œå¹¶è§£æå‡ºPESï¼›</li>\n<li>ä»PESä¸­è¯»å–åˆ°PTS&#x2F;DTSï¼Œå¹¶ä»PESä¸­è§£æå‡ºåŸºæœ¬ç æµESï¼›</li>\n<li>å°†ESäº¤ç»™è§£ç å™¨ï¼Œè·å¾—å‹ç¼©å‰çš„åŸå§‹éŸ³è§†é¢‘æ•°æ®</li>\n</ol>\n<h1 id=\"TSæ ¼å¼è¯¦è§£\"><a href=\"#TSæ ¼å¼è¯¦è§£\" class=\"headerlink\" title=\"TSæ ¼å¼è¯¦è§£\"></a>TSæ ¼å¼è¯¦è§£</h1><h2 id=\"1-TSåŒ…æ ¼å¼\"><a href=\"#1-TSåŒ…æ ¼å¼\" class=\"headerlink\" title=\"1. TSåŒ…æ ¼å¼\"></a>1. TSåŒ…æ ¼å¼</h2><p>TSåŒ…ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€æ˜¯4ä¸ªå­—èŠ‚çš„åŒ…å¤´ä¿¡æ¯ï¼ŒäºŒæ˜¯æœ‰æ•ˆè½½è·ï¼Œå¦å¤–ä¸­é—´æœ‰å¯èƒ½æ’å…¥è‡ªé€‚åº”è°ƒæ•´å­—æ®µã€‚æœ‰æ•ˆè½½è·åŒ…æ‹¬èŠ‚ç›®ä¸“ç”¨ä¿¡æ¯ï¼Œæ‰“åŒ…åçš„æµæ•°æ®ï¼Œä»¥åŠä¸šåŠ¡ä¿¡æ¯ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655700779571665570077901.png\"></p>\n<p>Fig. 4. TSåŒ…çš„ç»„æˆç»“æ„</p>\n<p>TSçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655701129401665570112830.png\"></p>\n<p>Fig. 5. TSçš„è¯­æ³•ç»“æ„</p>\n<p>ä¸»è¦å­—æ®µè§£æï¼š<br>Sync byte:åŒæ­¥å­—èŠ‚ï¼Œå€¼ä¸º0x47ï¼›</p>\n<p>Transport error indicator:ä¼ è¾“é”™è¯¯æŒ‡ç¤ºä½ï¼Œç½®1æ—¶ï¼Œè¡¨ç¤ºä¼ é€åŒ…ä¸­è‡³å°‘æœ‰ä¸€ä¸ªä¸å¯çº æ­£çš„é”™è¯¯ä½ã€‚</p>\n<p>Payload unit start indicator:è´Ÿè½½å•å…ƒèµ·å§‹æŒ‡æ ‡ä½ï¼Œè¡¨ç¤ºTSåŒ…çš„æœ‰æ•ˆå‡€è·ä»¥PES&#x2F;PSIåŒ…çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªPESåŒ…å¯èƒ½ç”±å¤šä¸ªTSåŒ…æ„æˆï¼Œç¬¬ä¸€ä¸ªTSåŒ…çš„è´Ÿè½½å•å…ƒèµ·å§‹æŒ‡æ ‡ä½æ‰ä¼šè¢«ç½®ä½ã€‚</p>\n<p>Transport priority:ä¼ è¾“ä¼˜å…ˆçº§ï¼Œè¡¨æ˜è¯¥åŒ…æ¯”åŒä¸ªPIDçš„ä½†æœªç½®ä½çš„TSåŒ…æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚</p>\n<p>PID:è¯¥TSåŒ…çš„IDå·ï¼Œå¦‚æœå‡€è·æ˜¯PATåŒ…ï¼Œåˆ™PIDå›ºå®šä¸º0x00ã€‚</p>\n<p>Transport scrambling control:ä¼ è¾“åŠ æ‰°æ§åˆ¶ä½</p>\n<p>Adaption field control:è‡ªé€‚åº”è°ƒæ•´åŸŸæ§åˆ¶ä½ï¼Œç½®ä½åˆ™è¡¨æ˜è¯¥TSåŒ…å­˜åœ¨è‡ªé€‚åº”è°ƒæ•´å­—æ®µã€‚</p>\n<p>Continuity counter:è¿ç»­è®¡æ•°å™¨ï¼Œéšç€å…·æœ‰ç›¸åŒPIDçš„TSåŒ…çš„å¢åŠ è€Œå¢åŠ ï¼Œè¾¾åˆ°æœ€å¤§æ—¶æ¢å¤ä¸º0ï¼Œå¦‚æœä¸¤ä¸ªè¿ç»­ç›¸åŒPIDçš„TSåŒ…å…·æœ‰ç›¸åŒçš„è®¡æ•°ï¼Œåˆ™è¡¨æ˜è¿™ä¸¤ä¸ªåŒ…æ˜¯ä¸€æ ·çš„ï¼Œåªå–ä¸€ä¸ªè§£æå³å¯ã€‚</p>\n<p>Payload:è´Ÿè½½å†…å®¹ï¼Œå¯èƒ½ä¸ºPAT&#x2F;PMT&#x2F;PESã€‚data_byteä¸º1Bé•¿<br>åº¦çš„æ•°æ®ï¼Œä¸ºè´Ÿè½½å­—èŠ‚ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655826274671665582627092.png\"></p>\n<p>Fig. 6. TSçš„è¯­æ³•ç»“æ„ä»£ç ç¤ºæ„</p>\n<h2 id=\"2-PAT-æ ¼å¼\"><a href=\"#2-PAT-æ ¼å¼\" class=\"headerlink\" title=\"2. PAT æ ¼å¼\"></a>2. PAT æ ¼å¼</h2><p>PATçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655846904131665584689570.png\"><br>Fig. 7. PATçš„è¯­æ³•ç»“æ„ç¤ºæ„</p>\n<p>ä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š</p>\n<p>table_id: æ ‡è¯†ä¸€ä¸ªTS PSI åˆ†æ®µçš„å†…å®¹æ˜¯èŠ‚ç›®å…³è”åˆ†æ®µï¼Œæ¡ä»¶è®¿é—®åˆ†æ®µè¿˜æ˜¯èŠ‚ç›®æ˜ å°„åˆ†æ®µã€‚å¯¹äºPATï¼Œç½®ä¸º0x00ã€‚</p>\n<p>section_syntax_indicator: å¯¹äºPATï¼Œç½®ä¸º0x01ã€‚</p>\n<p>section_length: åˆ†æ®µé•¿åº¦å­—æ®µï¼Œå…¶å€¼ä¸ºä»section_lengthï¼ˆä¸åŒ…æ‹¬åœ¨å†…ï¼‰åˆ°CRC_32å­—æ®µçš„å­—èŠ‚æ•°ï¼Œå…¶å€¼ä¸è¶…è¿‡1021ã€‚</p>\n<p>transport_stream_id: åŒºåˆ«ä¸å…¶ä»–å¤ç”¨æµçš„æ ‡è¯†ã€‚</p>\n<p>version_number: PATçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœPATæœ‰å˜ï¼Œåˆ™ç‰ˆæœ¬å·åŠ 1ã€‚</p>\n<p>current_next_indicator:ç½®0æ—¶ï¼Œè¡¨æ˜è¯¥ä¼ é€çš„è¡¨åˆ†æ®µä¸èƒ½ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªè¡¨åˆ†æ®µæ‰æœ‰æ•ˆã€‚</p>\n<p>section_number: è¡¨æ˜è¯¥TSåŒ…å±äºè¯¥PATçš„ç¬¬å‡ ä¸ªåˆ†æ®µï¼Œåˆ†æ®µå·ä»0å¼€å§‹ã€‚</p>\n<p>last_section_number: è¡¨æ˜æœ€åä¸€ä¸ªåˆ†æ®µå·ï¼ŒåŒæ—¶è¡¨æ˜è¯¥PATçš„æœ€å¤§åˆ†æ®µæ•°ç›®ã€‚ä¸€èˆ¬ï¼Œä¸€ä¸ªPATè¡¨ç”±ä¸€ä¸ªTSåŒ…ä¼ é€ã€‚</p>\n<p>program_number: èŠ‚ç›®çš„ç¼–å·ã€‚</p>\n<p>network_PID: NITè¡¨çš„PIDå€¼ã€‚</p>\n<p>program_map_PID: PMTè¡¨çš„PIDå€¼ã€‚</p>\n<p>CRC_32: CRCæ ¡éªŒã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655849004091665584900226.png\"><br>Fig. 8. PATè¯­æ³•ç»“æ„ä»£ç ç¤ºæ„</p>\n<h2 id=\"3-PMT-æ ¼å¼\"><a href=\"#3-PMT-æ ¼å¼\" class=\"headerlink\" title=\"3. PMT æ ¼å¼\"></a>3. PMT æ ¼å¼</h2><p>PMTçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655849504061665584950270.png\"><br>Fig. 9. PMTè¯­æ³•ç»“æ„</p>\n<p>ä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š</p>\n<p>table_id: æ ‡è¯†ä¸€ä¸ªTS PSI åˆ†æ®µçš„å†…å®¹æ˜¯èŠ‚ç›®å…³è”åˆ†æ®µï¼Œæ¡ä»¶è®¿é—®åˆ†æ®µè¿˜æ˜¯èŠ‚ç›®æ˜ å°„åˆ†æ®µã€‚å¯¹äºPMTï¼Œç½®ä¸º0x02ã€‚</p>\n<p>section_syntax_indicator: å¯¹äºPMTï¼Œç½®ä¸º0x01ã€‚</p>\n<p>section_length: åˆ†æ®µé•¿åº¦å­—æ®µï¼Œå…¶å€¼ä¸ºä»section_lengthï¼ˆåŒ…æ‹¬åœ¨å†…ï¼‰åˆ°CRC_32å­—æ®µçš„å­—èŠ‚æ•°ï¼Œå…¶å€¼ä¸è¶…è¿‡1021ã€‚</p>\n<p>program_number: è¡¨æ˜ä¸€å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç›®ã€‚</p>\n<p>version_number: PMTçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœå­—æ®µä¸­æœ‰å…³ä¿¡æ¯æœ‰å˜ï¼Œåˆ™ç‰ˆæœ¬å·ä»¥32ä¸ºæ¨¡åŠ 1ã€‚ç‰ˆæœ¬å·æ˜¯å¯¹ä¸€ä¸ªèŠ‚ç›®çš„å®šä¹‰ã€‚</p>\n<p>current_next_indicator:ç½®0æ—¶ï¼Œè¡¨æ˜è¯¥ä¼ é€çš„è¡¨åˆ†æ®µä¸èƒ½ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªè¡¨åˆ†æ®µæ‰æœ‰æ•ˆã€‚</p>\n<p>section_number: æ€»ä¸º0x00ã€‚</p>\n<p>last_section_number: æ€»ä¸º0x00ã€‚</p>\n<p>PCR_PID: æŒ‡ç¤ºå«æœ‰è¯¥èŠ‚ç›®çš„PCRå­—æ®µçš„TSåŒ…çš„PIDã€‚</p>\n<p>program_info_length: è¡¨æ˜è·Ÿéšå…¶åçš„å¯¹èŠ‚ç›®ä¿¡æ¯æè¿°çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªN loop descriptorsçš„å­—èŠ‚æ•°ã€‚</p>\n<p>stream_type: è¡¨æ˜PESæµçš„ç±»å‹ã€‚è­¬å¦‚ï¼Œ0x01è¡¨æ˜æ˜¯MPEG-1è§†é¢‘ï¼Œ0X03è¡¨æ˜æ˜¯MPEG-1éŸ³é¢‘ã€‚</p>\n<p>elementary_PID: è¡¨æ˜è¯¥è´Ÿè½½æœ‰è¯¥PESæµçš„TSåŒ…çš„PIDå€¼ã€‚</p>\n<p>ES_info_length: è¡¨æ˜è·Ÿéšå…¶åçš„æè¿°ç›¸å…³èŠ‚ç›®å…ƒç´ çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªN loop descriptorsçš„å­—èŠ‚æ•°ã€‚</p>\n<p>CRC_32: åœ¨CEDARXä»£ç ä¸­ä»…å¯¹DVBçš„åœºæ™¯ä¸‹ä½œæ ¡éªŒã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655851034681665585103423.png\"></p>\n<p>Fig. 10. PMTçš„è¯­æ³•ç»“æ„ä»£ç ç¤ºæ„</p>\n<h2 id=\"4-PESæ ¼å¼\"><a href=\"#4-PESæ ¼å¼\" class=\"headerlink\" title=\"4.PESæ ¼å¼\"></a>4.PESæ ¼å¼</h2><p>PESçš„è¯­æ³•å¦‚å›¾10æ‰€ç¤ºï¼Œå®ƒæºå¸¦çš„ä¸»è¦ä¿¡æ¯åŒ…æ‹¬æµçš„IDï¼ŒPESåŒ…çš„é•¿åº¦ï¼ŒPTSä»¥åŠæµçš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯éŸ³è§†é¢‘ä¸å­—å¹•æ•°æ®ã€‚</p>\n<p>ä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š</p>\n<p>packet_start_code_prefix: å›ºå®š0x000001</p>\n<p>stream_id: æŒ‡å®šåŸºæœ¬æµçš„ç±»å‹ä¸ç¼–å·</p>\n<p>PES_packet_length: è¡¨æ˜åœ¨è¯¥å­—æ®µåé¢è¿˜æœ‰å¤šå°‘ä¸ªå­—èŠ‚ã€‚0è¡¨æ˜PESåŒ…çš„é•¿åº¦æœªæŒ‡ç¤ºä¹Ÿæœªé™å®šï¼Œå¯¹äºå½“å‰çš„PESåŒ…è€Œè¨€ã€‚</p>\n<p>PES_scrambling_control: PESåŒ…çš„æœ‰æ•ˆè½½è·çš„åŠ æ‰°æ–¹å¼ã€‚</p>\n<p>PES_priority: å¤šè·¯å¤ç”¨å™¨å¯ä»¥é€šè¿‡è¯¥ä½æœ€ä¼˜åŒ–åŸºæœ¬æµå†…çš„æ•°æ®ã€‚</p>\n<p>data_alignment_indicator:</p>\n<p>copyright: PESåŒ…ä¸­çš„æœ‰æ•ˆè½½è·ç¡®å®šå…·æœ‰ç‰ˆæƒçš„è¯ï¼Œå°±ç½®ä½ã€‚</p>\n<p>orginal_or_copy: ç½®ä½æ—¶ï¼Œè¡¨æ˜PESåŒ…çš„æœ‰æ•ˆè½½è·çš„å†…å®¹æ˜¯åŸå§‹çš„ï¼Œéå¤åˆ¶çš„ã€‚</p>\n<p>PTS_DTS_flags: 2æ¯”ç‰¹å­—èŠ‚ï¼Œè¡¨æ˜PTS&#x2F;DTCçš„å­˜åœ¨æƒ…å†µã€‚</p>\n<p>ES_rate_flag: ç½®ä½ï¼Œè¡¨æ˜åé¢å­˜åœ¨ES_rateå­—æ®µã€‚</p>\n<p>PES_header_data_length: è¡¨æ˜è¯¥PESåŒ…å¤´ä¸­ç”±ä»»é€‰å­—æ®µä¸å¡«å……å­—èŠ‚æ‰€å æ®çš„å­—èŠ‚æ€»æ•°ã€‚ä»»é€‰å­—æ®µè­¬å¦‚ES_rateã€‚</p>\n<p>marker_bit: ä¸º1çš„æ¯”ç‰¹ä½ã€‚</p>\n<p>PTS: å¯¹äºéŸ³é¢‘è€Œè¨€ï¼Œå¦‚æœè¯¥PESåŒ…ä¸­å­˜åœ¨PTSå­—æ®µï¼Œåˆ™æœ‰æ•ˆè´Ÿè½½ä¸­è‚¯å®šæœ‰æ–°çš„éŸ³é¢‘å­˜å–å•å…ƒï¼ˆaccess unitï¼‰ï¼Œè¯¥PTSå¯¹åº”äºè¯¥éŸ³é¢‘å­˜å–å•å…ƒã€‚æ–°çš„éŸ³é¢‘å­˜å–å•å…ƒæŒ‡çš„æ˜¯ä¸€å¸§æ–°çš„éŸ³é¢‘å¸§ã€‚å¯¹äºè§†é¢‘è€Œè¨€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè·ŸéŸ³é¢‘ä¸€æ ·ã€‚</p>\n<p>DTS: è§£ç æ—¶é—´æ ‡å¿—ï¼Œå½“å‰CEDARXè§£ç å™¨æœªç”¨åˆ°DTSã€‚</p>\n<p>ES_rate: åŸºæœ¬æµé€Ÿç‡ï¼ŒæŒ‡å®šç³»ç»Ÿç›®æ ‡è§£ç å™¨æ¥æ”¶PESåŒ…å­—èŠ‚çš„é€Ÿç‡ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655853343991665585333549.png\"><br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655858313871061665585632_.jpg\"><br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655858713891665585871171.png\"><br>Fig. 11. PESçš„è¯­æ³•ç»“æ„ä»£ç </p>\n<h1 id=\"å‚è€ƒèµ„æ–™\"><a href=\"#å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"å‚è€ƒèµ„æ–™\"></a>å‚è€ƒèµ„æ–™</h1><p>[1] ISO &#x2F; IECæ ‡å‡†13818-1æˆ–ITU-Tå»ºè®®ä¹¦ <a href=\"http://www.itu.int/rec/T-REC-H.222.0\">http://www.itu.int/rec/T-REC-H.222.0</a></p>\n<p>[2] ã€Šæ•°å­—ç”µè§†ä¸šåŠ¡ä¿¡æ¯åŠå…¶ç¼–ç ã€‹ï¼Œæ–¹æ¶›ï¼Œå›½é˜²å·¥ä¸šå‡ºç‰ˆç¤¾</p>\n<p>[3] <a href=\"https://wenku.baidu.com/view/87f5439c2f60ddccdb38a066.html?rec_flag=default\">https://wenku.baidu.com/view/87f5439c2f60ddccdb38a066.html?rec_flag=default</a></p>\n<p>[4] TSç æµç»“æ„åˆ†æPPTï¼Œç½‘ç»œèµ„æ–™</p>\n<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>\n<p>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€ŒKayson12345ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a href=\"https://blog.csdn.net/Kayson12345/article/details/81266587\">https://blog.csdn.net/Kayson12345/article/details/81266587</a></p>\n<h1 id=\"ä¸ªäººç†è§£\"><a href=\"#ä¸ªäººç†è§£\" class=\"headerlink\" title=\"ä¸ªäººç†è§£\"></a>ä¸ªäººç†è§£</h1><p>ä»TSæµä¸­è·å–PATï¼Œè§£æPATå¾—åˆ°èŠ‚ç›®åˆ—è¡¨ï¼Œæ¯ä¸ªèŠ‚ç›®åˆ—è¡¨å¯¹åº”ä¸€ä¸ªPMTï¼Œ ä»PMTä¸­å¾—è¯¥èŠ‚ç›®å¯¹åº”çš„éŸ³è§†é¢‘PIDï¼Œ ä»TSæµæ ¹æ®PIDæ»¤å‡ºéŸ³è§†é¢‘TSåŒ…ï¼Œå°†TSåŒ…è¿˜åŸä¸ºPESåŒ…ï¼Œè¿›è€Œè¿˜åŸä¸ºESæµï¼ˆh264, aacï¼‰é€ç»™è§£ç å™¨è§£ç ã€‚</p>\n<p>ç»“åˆ<a href=\"https://tsduck.io/download/docs/mpegts-introduction.pdf\">An introduction to MPEG-TS</a>çœ‹èµ·æ¥æ›´æ˜“äºç†è§£ã€‚</p>\n<h1 id=\"åˆ†æå·¥å…·\"><a href=\"#åˆ†æå·¥å…·\" class=\"headerlink\" title=\"åˆ†æå·¥å…·\"></a>åˆ†æå·¥å…·</h1><p><a href=\"https://easyice.cn/archives/85\">easyice </a></p>\n","excerpt":"","more":"<p>å‚è€ƒï¼š<br><a href=\"https://blog.csdn.net/Kayson12345/article/details/81266587\">MPEG-TS æ ¼å¼è§£æ</a></p>\n<p><a href=\"https://tsduck.io/download/docs/mpegts-introduction.pdf\">An introduction to MPEG-TS</a></p>\n<h1 id=\"èƒŒæ™¯ä»‹ç»\"><a href=\"#èƒŒæ™¯ä»‹ç»\" class=\"headerlink\" title=\"èƒŒæ™¯ä»‹ç»\"></a>èƒŒæ™¯ä»‹ç»</h1><p>MPEG-TSä¸€ç§æ ‡å‡†æ•°æ®å®¹å™¨æ ¼å¼ï¼Œä¼ è¾“ä¸å­˜å‚¨éŸ³è§†é¢‘ã€èŠ‚ç›®ä¸ç³»ç»Ÿä¿¡æ¯åè®®æ•°æ®ï¼Œåº”ç”¨äºæ•°å­—å¹¿æ’­ç³»ç»Ÿï¼Œè­¬å¦‚DVB,ATSCä¸IPTVã€‚ä¼ è¾“æµåœ¨MPEG-2ç¬¬1éƒ¨åˆ†ç³»ç»Ÿä¸­è§„å®šï¼Œæ­£å¼ç§°ä¸ºISO &#x2F; IECæ ‡å‡†13818-1æˆ–ITU-Tå»ºè®®ä¹¦[1]ã€‚</p>\n<p>MPEG2&#x2F;DVBæ˜¯ä¸€ç§å¤šåª’ä½“ä¼ è¾“ã€å¤ç”¨æŠ€æœ¯ï¼Œåœ¨æ•°å­—ç”µè§†å¹¿æ’­ä¸­å¯æä¾›æ•°ç™¾ä¸ªèŠ‚ç›®é¢‘é“ã€‚å¤ç”¨çš„å«ä¹‰æ˜¯ï¼Œå¯ä»¥åŒæ—¶ä¼ è¾“å¤šå±‚èŠ‚ç›®ã€‚</p>\n<p>æ³¨æ„ï¼ŒDVBå…¨ç§°ä¸ºDigital Video Broadcastingï¼ŒåŒ…æ‹¬ä¸åŒçš„ç³»ç»Ÿï¼Œå¦‚å«æ˜Ÿæ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œæœ‰çº¿æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œåœ°é¢å¼€è·¯æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿï¼Œäº¤äº’å¼æ•°å­—ç”µè§†å¹¿æ’­ç³»ç»Ÿä»¥åŠæ•°å­—ç”µè§†åŠ æ‰°ç³»ç»Ÿã€‚DVBç³»ç»Ÿæ ‡å‡†æ˜¯ä¸€ç§å…¨çƒæ•°å­—ç”µè§†æŠ€æœ¯çš„æ ‡å‡†ã€‚å¦‚ä½•å®šä¹‰å¹¿æ’­ä¸­çš„æ¯”ç‰¹æµè¯­æ³•ä¸å¥æ³•ï¼Œä»¥å®ç°åœ¨æ¯”ç‰¹æµä¸­å¤ç”¨æ•°å­—éŸ³é¢‘ä¸è§†é¢‘ï¼Œæ¬§æ´²çš„DVBé‡‡ç”¨æ•°å­—è§†é¢‘å‹ç¼©MPEG-2æ ‡å‡†ï¼Œè¯¥æ ‡å‡†æ˜¯å®šä¹‰æ¯”ç‰¹æµçš„è¯­æ³•ä¸å¥æ³•çš„ä¸€ä¸ªISO&#x2F;IECæ ‡å‡†ï¼Œå³13818-1æ ‡å‡†ã€‚DVBç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯æ˜¯é‡‡ç”¨MPEG-2æŠ€æœ¯è¿›è¡Œè§†é¢‘ã€éŸ³é¢‘çš„ç¼–ç ï¼Œä½¿ç”¨ç»Ÿä¸€çš„MPEG-2ä¼ è¾“æµï¼ˆTSæµï¼‰ã€‚</p>\n<p>MPEG-2æ ‡å‡†ä¸­ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„ç æµè¾“å‡ºåˆ°ä¿¡é“ï¼Œä¸€ç§æ˜¯èŠ‚ç›®ç æµï¼ˆPS: Program Streamï¼‰ï¼Œé€‚ç”¨äºæ²¡æœ‰ä¼ è¾“è¯¯å·®çš„åœºæ™¯ï¼›ä¸€ç§æ˜¯ä¼ é€æµï¼ˆTSï¼šTransport Stream)ï¼Œé€‚ç”¨äºæœ‰ä¿¡é“å™ªå£°çš„ä¼ è¾“åœºæ™¯ã€‚èŠ‚ç›®æµè®¾è®¡ç”¨äºåˆç†å¯é çš„åª’ä½“ï¼Œå¦‚å…‰ç›˜ï¼ˆå¦‚DVDï¼‰ï¼Œè€Œä¼ è¾“æµè®¾è®¡ç”¨äºä¸å¤ªå¯é çš„ä¼ è¾“ï¼Œå³åœ°é¢æˆ–å«æ˜Ÿå¹¿æ’­ã€‚æ­¤å¤–ï¼Œä¼ è¾“æµå¯ä»¥æºå¸¦å¤šä¸ªèŠ‚ç›®ã€‚</p>\n<p>MPEG-2 systemï¼ˆç¼–å·13818-1ï¼‰æ˜¯MPEG-2æ ‡å‡†çš„å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œè¯¥éƒ¨åˆ†æè¿°äº†å¤šä¸ªè§†é¢‘ï¼ŒéŸ³é¢‘å’Œæ•°æ®å¤šç§åŸºæœ¬æµï¼ˆESï¼‰åˆæˆä¼ è¾“æµï¼ˆTSï¼‰å’ŒèŠ‚ç›®æµï¼ˆPSï¼‰çš„æ–¹å¼ã€‚</p>\n<h1 id=\"TS-ä»‹ç»\"><a href=\"#TS-ä»‹ç»\" class=\"headerlink\" title=\"TS ä»‹ç»\"></a>TS ä»‹ç»</h1><p>ä¸€è·¯TSæ¯”ç‰¹æµé€šå¸¸ç”±è¿ç»­çš„å›ºå®šå­—èŠ‚çš„TSåŒ…ç»„æˆï¼Œæ‰€åŒ…å«çš„å†…å®¹æœ‰ï¼š</p>\n<ul>\n<li><p>ä¸€è·¯æˆ–å¤šè·¯è§†é¢‘æµï¼ˆå¤šä¸ªPESåŒ…ç»„æˆï¼Œæ¯ä¸ªPESåŒ…çš„PIDæ˜¯ä¸€è‡´çš„ï¼Œä¸€ä¸ªPESåŒ…å¯èƒ½ç”±è‹¥å¹²ä¸ªTSåŒ…ç»„æˆï¼‰</p>\n</li>\n<li><p>ä¸€è·¯æˆ–å¤šè·¯éŸ³é¢‘æµï¼ˆé€šå¸¸ä¸ºæœæ¯”çš„éŸ³é¢‘æ ¼å¼ï¼‰</p>\n</li>\n<li><p>ä¸€è·¯æˆ–å¤šè·¯å­—å¹•</p>\n</li>\n<li><p>PSIè¡¨æ ¼ä¿¡æ¯ï¼ˆProgram Specific Informationï¼ŒåŒ…æ‹¬PATä¸PMTè¡¨ï¼Œå³èŠ‚ç›®å…³è”è¡¨ä¸èŠ‚ç›®æ˜ å°„è¡¨ï¼‰</p>\n</li>\n<li><p>PES: Packetized Elementary Streamï¼Œä¸€è·¯åŸºæœ¬ç æµï¼ˆå¦‚MEPG2è§†é¢‘æµï¼‰ä¼šåœ¨ç¼–ç å™¨ç«¯è¢«æ‰“åŒ…æˆPESæµï¼Œç”±å¤šä¸ªPESåŒ…ç»„æˆï¼Œæ‰“åŒ…çš„è¿‡ç¨‹ä¸­ä¸»è¦åŠ å…¥äº†PTS&#x2F;DTSä¿¡æ¯ã€‚</p>\n</li>\n</ul>\n<p>PAT(Program Association Table)æè¿°æœ‰å¤šå°‘è·¯èŠ‚ç›®ï¼Œæ¯è·¯èŠ‚ç›®çš„PMTï¼ˆProgram Map Tableï¼‰è¡¨çš„PIDæ˜¯å¤šå°‘ï¼ŒPMTåˆ™æè¿°äº†æœ¬èŠ‚ç›®æœ‰å¤šå°‘æµï¼Œæ¯ä¸€è·¯æµçš„ç±»å‹ä¸PIDæ˜¯å¤šå°‘ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä½ æ‰¾ä¸ªä¸€ä¸ªTSåŒ…ï¼Œå®ƒçš„PIDæ˜¯0ï¼Œè¯´æ˜å®ƒçš„è´Ÿè½½å†…å®¹æ˜¯PATä¿¡æ¯ï¼Œè§£æPATä¿¡æ¯ï¼Œä½ å‘ç°èŠ‚ç›®1çš„PMTè¡¨çš„PIDæ˜¯0x10ï¼Œæ¥ç€ï¼Œä½ åœ¨æ¯”ç‰¹æµä¸­å¯»æ‰¾ä¸€ä¸ªPIDä¸º0x10çš„TSåŒ…ï¼Œå®ƒçš„è´Ÿè½½å†…å®¹æ˜¯èŠ‚ç›®1çš„PMTè¡¨ä¿¡æ¯ï¼Œè§£æè¯¥PMTä¿¡æ¯ï¼Œä½ å¯ä»¥å‘ç°ç¬¬ä¸€è·¯æµæ˜¯MPEG2éŸ³é¢‘æµï¼ŒPIDå·0x21ï¼Œç¬¬äºŒè·¯æµæ˜¯MPEG2è§†é¢‘æµï¼ŒPIDå·æ˜¯0x22ï¼Œç¬¬ä¸‰è·¯æµæ˜¯DVBå­—å¹•æµï¼ŒPIDå·æ˜¯0x23ï¼Œè§£æå®Œæ¯•ï¼Œå‡¡æ˜¯æ¯”ç‰¹æµä¸­PIDå·ä¸º0x22çš„TSåŒ…ï¼Œæ‰€è´Ÿè½½çš„å†…å®¹ä¸ºMPEG2è§†é¢‘æµï¼ŒæŠŠè¿™äº›åŒ…ä¸€ä¸ªä¸€ä¸ªæ‰¾å‡ºæ¥ï¼ŒæŠŠå…¶ä¸­çš„æœ‰æ•ˆç æµä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†çš„æ‹¼æ¥èµ·æ¥ï¼Œç„¶åé€ç»™è§£ç å™¨å»è§£ç ã€‚</p>\n<p>æ³¨æ„ï¼Œå°±ä¸€èˆ¬çš„è§†é¢‘æµè€Œè¨€ï¼Œåªè¦æ‹¼æ¥æˆä¸€ä¸ªå®Œæ•´çš„PESåŒ…ï¼Œå°±å¯ä»¥é€å‡ºå»ç»™è§£ç å™¨ï¼Œç„¶åå†ç»§ç»­æ‹¼æ¥ä¸‹ä¸€ä¸ªPESåŒ…ã€‚</p>\n<p>ä»€ä¹ˆæ˜¯ESæµï¼ŒPESæµï¼ŒTSæµï¼Ÿ</p>\n<ul>\n<li><p>ESæµï¼šæœ‰ä¸‰ç§ï¼Œå›¾åƒæ•°æ®æµï¼ŒéŸ³é¢‘æ•°æ®æµï¼Œä»¥åŠå…¶ä»–ç¼–ç æ•°æ®æµã€‚</p>\n</li>\n<li><p>PESæµï¼šPESæµæ˜¯ESæµç»è¿‡PESæ‰“åŒ…å™¨å¤„ç†åå½¢æˆçš„æ•°æ®æµï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®Œæˆäº†å°†ESæµåˆ†ç»„ã€æ‰“åŒ…ã€åŠ å…¥åŒ…å¤´ä¿¡æ¯ç­‰æ“ä½œï¼ˆå¯¹ESæµçš„ç¬¬ä¸€æ¬¡æ‰“åŒ…ï¼‰ã€‚PESæµçš„åŸºæœ¬å•ä½æ˜¯PESåŒ…ã€‚</p>\n</li>\n<li><p>TSæµï¼šç”±å®šé•¿çš„TSåŒ…ç»„æˆï¼ˆ188å­—èŠ‚ï¼‰ï¼Œè€ŒTSåŒ…æ˜¯å¯¹PESåŒ…çš„ä¸€ä¸ªé‡æ–°å°è£…ï¼ˆåˆ°è¿™é‡Œï¼ŒESç»è¿‡äº†ä¸¤å±‚çš„å°è£…ï¼‰ ã€‚åº”ç”¨äºç›¸å¯¹æœ‰é”™ç¯å¢ƒä¸‹çš„ä¼ è¾“ä¸å­˜å‚¨ï¼ˆå¦‚DVBä¸­ï¼‰ï¼Œå…¶åŸºæœ¬å•ä½æ˜¯TSåŒ…ï¼Œé•¿åº¦å›ºå®š188å­—èŠ‚ã€‚æ—¥æœ¬çš„DVB-Så¹¿æ’­ç³»ç»Ÿé‡‡ç”¨192ä¸ªå­—èŠ‚çš„TSåŒ…ï¼Œç¾å›½é‡‡ç”¨204ä¸ªå­—èŠ‚çš„TSåŒ…ï¼Œå¤šåŠ äº†16ä¸ªå­—èŠ‚çš„å‰å‘çº é”™æ ¡éªŒç ï¼ˆFECï¼‰ã€‚</p>\n</li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655696635121665569663420.png\"><br>Fig. 1. ESæµæ‰“åŒ…æˆPESæµ<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655697239811665569723213.png\"><br>Fig. 2. PESæµæ‰“åŒ…æˆTSæµ</p>\n<p>ä»€ä¹ˆæ˜¯PSIè¡¨ï¼Ÿ</p>\n<p>PSI(Program Specific Info)ï¼ŒèŠ‚ç›®ç‰¹å®šä¿¡æ¯ï¼Œè¯¥è¡¨æ ¼ä¿¡æ¯ç”¨æ¥æè¿°ä¼ é€æµçš„ç»„æˆç»“æ„ã€‚PSIä¿¡æ¯ç”±å››ç§ç±»å‹çš„è¡¨ç»„æˆï¼ŒåŒ…æ‹¬èŠ‚ç›®å…³è”è¡¨ï¼ˆPATï¼‰ï¼ŒèŠ‚ç›®æ˜ å°„è¡¨ï¼ˆPMTï¼‰ï¼Œæ¡ä»¶æ¥æ”¶è¡¨ï¼ˆCATï¼‰ï¼Œç½‘ç»œä¿¡æ¯è¡¨ï¼ˆNITï¼‰ã€‚PATä¸PMTä¸¤å¼ è¡¨å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°è¯¥ä¼ é€æµä¸­çš„æ‰€æœ‰èŠ‚ç›®ä¸æµï¼ŒPATå‘Šè¯‰æˆ‘ä»¬ï¼Œè¯¥TSæµç”±å“ªäº›èŠ‚ç›®ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç›®çš„èŠ‚ç›®æ˜ å°„è¡¨PMTçš„PIDæ˜¯ä»€ä¹ˆï¼Œè€ŒPMTå‘Šè¯‰æˆ‘ä»¬ï¼Œè¯¥èŠ‚ç›®ç”±å“ªäº›æµç»„æˆï¼Œæ¯ä¸€è·¯æµçš„ç±»å‹ä¸PIDæ˜¯ä»€ä¹ˆã€‚CATä¸NITæš‚æ—¶ä¸è€ƒè™‘ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655698149521665569814410.png\"></p>\n<p>Fig. 3. PSIè¡¨</p>\n<h1 id=\"TSè§£å°è£…çš„åŸç†\"><a href=\"#TSè§£å°è£…çš„åŸç†\" class=\"headerlink\" title=\"TSè§£å°è£…çš„åŸç†\"></a>TSè§£å°è£…çš„åŸç†</h1><p>TSæµçš„å½¢æˆè¿‡ç¨‹ï¼š</p>\n<ol>\n<li>å°†åŸå§‹éŸ³è§†é¢‘æ•°æ®å‹ç¼©ä¹‹åï¼Œå‹ç¼©ç»“æœç»„æˆä¸€ä¸ªåŸºæœ¬ç æµï¼ˆESï¼‰ã€‚</li>\n<li>å¯¹ESï¼ˆåŸºæœ¬ç æµï¼‰è¿›è¡Œæ‰“åŒ…å½¢æˆPESã€‚</li>\n<li>åœ¨PESåŒ…ä¸­åŠ å…¥æ—¶é—´æˆ³ä¿¡æ¯(PTS&#x2F;DTS)ã€‚</li>\n<li>å°†PESåŒ…å†…å®¹åˆ†é…åˆ°ä¸€ç³»åˆ—å›ºå®šé•¿åº¦çš„ä¼ è¾“åŒ…ï¼ˆTS Packetï¼‰ä¸­ã€‚</li>\n<li>åœ¨ä¼ è¾“åŒ…ä¸­åŠ å…¥å®šæ—¶ä¿¡æ¯(PCR)ã€‚</li>\n<li>åœ¨ä¼ è¾“åŒ…ä¸­åŠ å…¥èŠ‚ç›®ä¸“ç”¨ä¿¡æ¯(PSI) ã€‚</li>\n<li>è¿ç»­è¾“å‡ºä¼ è¾“åŒ…å½¢æˆå…·æœ‰æ’å®šæ¯”ç‰¹ç‡çš„MPEG-TSæµã€‚</li>\n</ol>\n<p>TSæµçš„è§£æè¿‡ç¨‹ï¼Œå¯ä»¥è¯´æ˜¯ç”Ÿæˆçš„é€†è¿‡ç¨‹ï¼š</p>\n<ol>\n<li>ä»å¤ç”¨çš„MPEG-TSæµä¸­è§£æå‡ºTSåŒ…ï¼›</li>\n<li>ä»TSåŒ…ä¸­è·å–PATåŠå¯¹åº”çš„PMTï¼ˆPSIä¸­çš„è¡¨æ ¼ï¼‰ï¼›</li>\n<li>ä»è€Œè·å–ç‰¹å®šèŠ‚ç›®çš„éŸ³è§†é¢‘PIDï¼›</li>\n<li>é€šè¿‡PIDç­›é€‰å‡ºç‰¹å®šéŸ³è§†é¢‘ç›¸å…³çš„TSåŒ…ï¼Œå¹¶è§£æå‡ºPESï¼›</li>\n<li>ä»PESä¸­è¯»å–åˆ°PTS&#x2F;DTSï¼Œå¹¶ä»PESä¸­è§£æå‡ºåŸºæœ¬ç æµESï¼›</li>\n<li>å°†ESäº¤ç»™è§£ç å™¨ï¼Œè·å¾—å‹ç¼©å‰çš„åŸå§‹éŸ³è§†é¢‘æ•°æ®</li>\n</ol>\n<h1 id=\"TSæ ¼å¼è¯¦è§£\"><a href=\"#TSæ ¼å¼è¯¦è§£\" class=\"headerlink\" title=\"TSæ ¼å¼è¯¦è§£\"></a>TSæ ¼å¼è¯¦è§£</h1><h2 id=\"1-TSåŒ…æ ¼å¼\"><a href=\"#1-TSåŒ…æ ¼å¼\" class=\"headerlink\" title=\"1. TSåŒ…æ ¼å¼\"></a>1. TSåŒ…æ ¼å¼</h2><p>TSåŒ…ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€æ˜¯4ä¸ªå­—èŠ‚çš„åŒ…å¤´ä¿¡æ¯ï¼ŒäºŒæ˜¯æœ‰æ•ˆè½½è·ï¼Œå¦å¤–ä¸­é—´æœ‰å¯èƒ½æ’å…¥è‡ªé€‚åº”è°ƒæ•´å­—æ®µã€‚æœ‰æ•ˆè½½è·åŒ…æ‹¬èŠ‚ç›®ä¸“ç”¨ä¿¡æ¯ï¼Œæ‰“åŒ…åçš„æµæ•°æ®ï¼Œä»¥åŠä¸šåŠ¡ä¿¡æ¯ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655700779571665570077901.png\"></p>\n<p>Fig. 4. TSåŒ…çš„ç»„æˆç»“æ„</p>\n<p>TSçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655701129401665570112830.png\"></p>\n<p>Fig. 5. TSçš„è¯­æ³•ç»“æ„</p>\n<p>ä¸»è¦å­—æ®µè§£æï¼š<br>Sync byte:åŒæ­¥å­—èŠ‚ï¼Œå€¼ä¸º0x47ï¼›</p>\n<p>Transport error indicator:ä¼ è¾“é”™è¯¯æŒ‡ç¤ºä½ï¼Œç½®1æ—¶ï¼Œè¡¨ç¤ºä¼ é€åŒ…ä¸­è‡³å°‘æœ‰ä¸€ä¸ªä¸å¯çº æ­£çš„é”™è¯¯ä½ã€‚</p>\n<p>Payload unit start indicator:è´Ÿè½½å•å…ƒèµ·å§‹æŒ‡æ ‡ä½ï¼Œè¡¨ç¤ºTSåŒ…çš„æœ‰æ•ˆå‡€è·ä»¥PES&#x2F;PSIåŒ…çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªPESåŒ…å¯èƒ½ç”±å¤šä¸ªTSåŒ…æ„æˆï¼Œç¬¬ä¸€ä¸ªTSåŒ…çš„è´Ÿè½½å•å…ƒèµ·å§‹æŒ‡æ ‡ä½æ‰ä¼šè¢«ç½®ä½ã€‚</p>\n<p>Transport priority:ä¼ è¾“ä¼˜å…ˆçº§ï¼Œè¡¨æ˜è¯¥åŒ…æ¯”åŒä¸ªPIDçš„ä½†æœªç½®ä½çš„TSåŒ…æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚</p>\n<p>PID:è¯¥TSåŒ…çš„IDå·ï¼Œå¦‚æœå‡€è·æ˜¯PATåŒ…ï¼Œåˆ™PIDå›ºå®šä¸º0x00ã€‚</p>\n<p>Transport scrambling control:ä¼ è¾“åŠ æ‰°æ§åˆ¶ä½</p>\n<p>Adaption field control:è‡ªé€‚åº”è°ƒæ•´åŸŸæ§åˆ¶ä½ï¼Œç½®ä½åˆ™è¡¨æ˜è¯¥TSåŒ…å­˜åœ¨è‡ªé€‚åº”è°ƒæ•´å­—æ®µã€‚</p>\n<p>Continuity counter:è¿ç»­è®¡æ•°å™¨ï¼Œéšç€å…·æœ‰ç›¸åŒPIDçš„TSåŒ…çš„å¢åŠ è€Œå¢åŠ ï¼Œè¾¾åˆ°æœ€å¤§æ—¶æ¢å¤ä¸º0ï¼Œå¦‚æœä¸¤ä¸ªè¿ç»­ç›¸åŒPIDçš„TSåŒ…å…·æœ‰ç›¸åŒçš„è®¡æ•°ï¼Œåˆ™è¡¨æ˜è¿™ä¸¤ä¸ªåŒ…æ˜¯ä¸€æ ·çš„ï¼Œåªå–ä¸€ä¸ªè§£æå³å¯ã€‚</p>\n<p>Payload:è´Ÿè½½å†…å®¹ï¼Œå¯èƒ½ä¸ºPAT&#x2F;PMT&#x2F;PESã€‚data_byteä¸º1Bé•¿<br>åº¦çš„æ•°æ®ï¼Œä¸ºè´Ÿè½½å­—èŠ‚ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655826274671665582627092.png\"></p>\n<p>Fig. 6. TSçš„è¯­æ³•ç»“æ„ä»£ç ç¤ºæ„</p>\n<h2 id=\"2-PAT-æ ¼å¼\"><a href=\"#2-PAT-æ ¼å¼\" class=\"headerlink\" title=\"2. PAT æ ¼å¼\"></a>2. PAT æ ¼å¼</h2><p>PATçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655846904131665584689570.png\"><br>Fig. 7. PATçš„è¯­æ³•ç»“æ„ç¤ºæ„</p>\n<p>ä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š</p>\n<p>table_id: æ ‡è¯†ä¸€ä¸ªTS PSI åˆ†æ®µçš„å†…å®¹æ˜¯èŠ‚ç›®å…³è”åˆ†æ®µï¼Œæ¡ä»¶è®¿é—®åˆ†æ®µè¿˜æ˜¯èŠ‚ç›®æ˜ å°„åˆ†æ®µã€‚å¯¹äºPATï¼Œç½®ä¸º0x00ã€‚</p>\n<p>section_syntax_indicator: å¯¹äºPATï¼Œç½®ä¸º0x01ã€‚</p>\n<p>section_length: åˆ†æ®µé•¿åº¦å­—æ®µï¼Œå…¶å€¼ä¸ºä»section_lengthï¼ˆä¸åŒ…æ‹¬åœ¨å†…ï¼‰åˆ°CRC_32å­—æ®µçš„å­—èŠ‚æ•°ï¼Œå…¶å€¼ä¸è¶…è¿‡1021ã€‚</p>\n<p>transport_stream_id: åŒºåˆ«ä¸å…¶ä»–å¤ç”¨æµçš„æ ‡è¯†ã€‚</p>\n<p>version_number: PATçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœPATæœ‰å˜ï¼Œåˆ™ç‰ˆæœ¬å·åŠ 1ã€‚</p>\n<p>current_next_indicator:ç½®0æ—¶ï¼Œè¡¨æ˜è¯¥ä¼ é€çš„è¡¨åˆ†æ®µä¸èƒ½ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªè¡¨åˆ†æ®µæ‰æœ‰æ•ˆã€‚</p>\n<p>section_number: è¡¨æ˜è¯¥TSåŒ…å±äºè¯¥PATçš„ç¬¬å‡ ä¸ªåˆ†æ®µï¼Œåˆ†æ®µå·ä»0å¼€å§‹ã€‚</p>\n<p>last_section_number: è¡¨æ˜æœ€åä¸€ä¸ªåˆ†æ®µå·ï¼ŒåŒæ—¶è¡¨æ˜è¯¥PATçš„æœ€å¤§åˆ†æ®µæ•°ç›®ã€‚ä¸€èˆ¬ï¼Œä¸€ä¸ªPATè¡¨ç”±ä¸€ä¸ªTSåŒ…ä¼ é€ã€‚</p>\n<p>program_number: èŠ‚ç›®çš„ç¼–å·ã€‚</p>\n<p>network_PID: NITè¡¨çš„PIDå€¼ã€‚</p>\n<p>program_map_PID: PMTè¡¨çš„PIDå€¼ã€‚</p>\n<p>CRC_32: CRCæ ¡éªŒã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655849004091665584900226.png\"><br>Fig. 8. PATè¯­æ³•ç»“æ„ä»£ç ç¤ºæ„</p>\n<h2 id=\"3-PMT-æ ¼å¼\"><a href=\"#3-PMT-æ ¼å¼\" class=\"headerlink\" title=\"3. PMT æ ¼å¼\"></a>3. PMT æ ¼å¼</h2><p>PMTçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655849504061665584950270.png\"><br>Fig. 9. PMTè¯­æ³•ç»“æ„</p>\n<p>ä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š</p>\n<p>table_id: æ ‡è¯†ä¸€ä¸ªTS PSI åˆ†æ®µçš„å†…å®¹æ˜¯èŠ‚ç›®å…³è”åˆ†æ®µï¼Œæ¡ä»¶è®¿é—®åˆ†æ®µè¿˜æ˜¯èŠ‚ç›®æ˜ å°„åˆ†æ®µã€‚å¯¹äºPMTï¼Œç½®ä¸º0x02ã€‚</p>\n<p>section_syntax_indicator: å¯¹äºPMTï¼Œç½®ä¸º0x01ã€‚</p>\n<p>section_length: åˆ†æ®µé•¿åº¦å­—æ®µï¼Œå…¶å€¼ä¸ºä»section_lengthï¼ˆåŒ…æ‹¬åœ¨å†…ï¼‰åˆ°CRC_32å­—æ®µçš„å­—èŠ‚æ•°ï¼Œå…¶å€¼ä¸è¶…è¿‡1021ã€‚</p>\n<p>program_number: è¡¨æ˜ä¸€å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç›®ã€‚</p>\n<p>version_number: PMTçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœå­—æ®µä¸­æœ‰å…³ä¿¡æ¯æœ‰å˜ï¼Œåˆ™ç‰ˆæœ¬å·ä»¥32ä¸ºæ¨¡åŠ 1ã€‚ç‰ˆæœ¬å·æ˜¯å¯¹ä¸€ä¸ªèŠ‚ç›®çš„å®šä¹‰ã€‚</p>\n<p>current_next_indicator:ç½®0æ—¶ï¼Œè¡¨æ˜è¯¥ä¼ é€çš„è¡¨åˆ†æ®µä¸èƒ½ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªè¡¨åˆ†æ®µæ‰æœ‰æ•ˆã€‚</p>\n<p>section_number: æ€»ä¸º0x00ã€‚</p>\n<p>last_section_number: æ€»ä¸º0x00ã€‚</p>\n<p>PCR_PID: æŒ‡ç¤ºå«æœ‰è¯¥èŠ‚ç›®çš„PCRå­—æ®µçš„TSåŒ…çš„PIDã€‚</p>\n<p>program_info_length: è¡¨æ˜è·Ÿéšå…¶åçš„å¯¹èŠ‚ç›®ä¿¡æ¯æè¿°çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªN loop descriptorsçš„å­—èŠ‚æ•°ã€‚</p>\n<p>stream_type: è¡¨æ˜PESæµçš„ç±»å‹ã€‚è­¬å¦‚ï¼Œ0x01è¡¨æ˜æ˜¯MPEG-1è§†é¢‘ï¼Œ0X03è¡¨æ˜æ˜¯MPEG-1éŸ³é¢‘ã€‚</p>\n<p>elementary_PID: è¡¨æ˜è¯¥è´Ÿè½½æœ‰è¯¥PESæµçš„TSåŒ…çš„PIDå€¼ã€‚</p>\n<p>ES_info_length: è¡¨æ˜è·Ÿéšå…¶åçš„æè¿°ç›¸å…³èŠ‚ç›®å…ƒç´ çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªN loop descriptorsçš„å­—èŠ‚æ•°ã€‚</p>\n<p>CRC_32: åœ¨CEDARXä»£ç ä¸­ä»…å¯¹DVBçš„åœºæ™¯ä¸‹ä½œæ ¡éªŒã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655851034681665585103423.png\"></p>\n<p>Fig. 10. PMTçš„è¯­æ³•ç»“æ„ä»£ç ç¤ºæ„</p>\n<h2 id=\"4-PESæ ¼å¼\"><a href=\"#4-PESæ ¼å¼\" class=\"headerlink\" title=\"4.PESæ ¼å¼\"></a>4.PESæ ¼å¼</h2><p>PESçš„è¯­æ³•å¦‚å›¾10æ‰€ç¤ºï¼Œå®ƒæºå¸¦çš„ä¸»è¦ä¿¡æ¯åŒ…æ‹¬æµçš„IDï¼ŒPESåŒ…çš„é•¿åº¦ï¼ŒPTSä»¥åŠæµçš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯éŸ³è§†é¢‘ä¸å­—å¹•æ•°æ®ã€‚</p>\n<p>ä¸»è¦çš„å­—æ®µè§£æå¦‚ä¸‹ï¼š</p>\n<p>packet_start_code_prefix: å›ºå®š0x000001</p>\n<p>stream_id: æŒ‡å®šåŸºæœ¬æµçš„ç±»å‹ä¸ç¼–å·</p>\n<p>PES_packet_length: è¡¨æ˜åœ¨è¯¥å­—æ®µåé¢è¿˜æœ‰å¤šå°‘ä¸ªå­—èŠ‚ã€‚0è¡¨æ˜PESåŒ…çš„é•¿åº¦æœªæŒ‡ç¤ºä¹Ÿæœªé™å®šï¼Œå¯¹äºå½“å‰çš„PESåŒ…è€Œè¨€ã€‚</p>\n<p>PES_scrambling_control: PESåŒ…çš„æœ‰æ•ˆè½½è·çš„åŠ æ‰°æ–¹å¼ã€‚</p>\n<p>PES_priority: å¤šè·¯å¤ç”¨å™¨å¯ä»¥é€šè¿‡è¯¥ä½æœ€ä¼˜åŒ–åŸºæœ¬æµå†…çš„æ•°æ®ã€‚</p>\n<p>data_alignment_indicator:</p>\n<p>copyright: PESåŒ…ä¸­çš„æœ‰æ•ˆè½½è·ç¡®å®šå…·æœ‰ç‰ˆæƒçš„è¯ï¼Œå°±ç½®ä½ã€‚</p>\n<p>orginal_or_copy: ç½®ä½æ—¶ï¼Œè¡¨æ˜PESåŒ…çš„æœ‰æ•ˆè½½è·çš„å†…å®¹æ˜¯åŸå§‹çš„ï¼Œéå¤åˆ¶çš„ã€‚</p>\n<p>PTS_DTS_flags: 2æ¯”ç‰¹å­—èŠ‚ï¼Œè¡¨æ˜PTS&#x2F;DTCçš„å­˜åœ¨æƒ…å†µã€‚</p>\n<p>ES_rate_flag: ç½®ä½ï¼Œè¡¨æ˜åé¢å­˜åœ¨ES_rateå­—æ®µã€‚</p>\n<p>PES_header_data_length: è¡¨æ˜è¯¥PESåŒ…å¤´ä¸­ç”±ä»»é€‰å­—æ®µä¸å¡«å……å­—èŠ‚æ‰€å æ®çš„å­—èŠ‚æ€»æ•°ã€‚ä»»é€‰å­—æ®µè­¬å¦‚ES_rateã€‚</p>\n<p>marker_bit: ä¸º1çš„æ¯”ç‰¹ä½ã€‚</p>\n<p>PTS: å¯¹äºéŸ³é¢‘è€Œè¨€ï¼Œå¦‚æœè¯¥PESåŒ…ä¸­å­˜åœ¨PTSå­—æ®µï¼Œåˆ™æœ‰æ•ˆè´Ÿè½½ä¸­è‚¯å®šæœ‰æ–°çš„éŸ³é¢‘å­˜å–å•å…ƒï¼ˆaccess unitï¼‰ï¼Œè¯¥PTSå¯¹åº”äºè¯¥éŸ³é¢‘å­˜å–å•å…ƒã€‚æ–°çš„éŸ³é¢‘å­˜å–å•å…ƒæŒ‡çš„æ˜¯ä¸€å¸§æ–°çš„éŸ³é¢‘å¸§ã€‚å¯¹äºè§†é¢‘è€Œè¨€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè·ŸéŸ³é¢‘ä¸€æ ·ã€‚</p>\n<p>DTS: è§£ç æ—¶é—´æ ‡å¿—ï¼Œå½“å‰CEDARXè§£ç å™¨æœªç”¨åˆ°DTSã€‚</p>\n<p>ES_rate: åŸºæœ¬æµé€Ÿç‡ï¼ŒæŒ‡å®šç³»ç»Ÿç›®æ ‡è§£ç å™¨æ¥æ”¶PESåŒ…å­—èŠ‚çš„é€Ÿç‡ã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655853343991665585333549.png\"><br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655858313871061665585632_.jpg\"><br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16655858713891665585871171.png\"><br>Fig. 11. PESçš„è¯­æ³•ç»“æ„ä»£ç </p>\n<h1 id=\"å‚è€ƒèµ„æ–™\"><a href=\"#å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"å‚è€ƒèµ„æ–™\"></a>å‚è€ƒèµ„æ–™</h1><p>[1] ISO &#x2F; IECæ ‡å‡†13818-1æˆ–ITU-Tå»ºè®®ä¹¦ <a href=\"http://www.itu.int/rec/T-REC-H.222.0\">http://www.itu.int/rec/T-REC-H.222.0</a></p>\n<p>[2] ã€Šæ•°å­—ç”µè§†ä¸šåŠ¡ä¿¡æ¯åŠå…¶ç¼–ç ã€‹ï¼Œæ–¹æ¶›ï¼Œå›½é˜²å·¥ä¸šå‡ºç‰ˆç¤¾</p>\n<p>[3] <a href=\"https://wenku.baidu.com/view/87f5439c2f60ddccdb38a066.html?rec_flag=default\">https://wenku.baidu.com/view/87f5439c2f60ddccdb38a066.html?rec_flag=default</a></p>\n<p>[4] TSç æµç»“æ„åˆ†æPPTï¼Œç½‘ç»œèµ„æ–™</p>\n<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>\n<p>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€ŒKayson12345ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a href=\"https://blog.csdn.net/Kayson12345/article/details/81266587\">https://blog.csdn.net/Kayson12345/article/details/81266587</a></p>\n<h1 id=\"ä¸ªäººç†è§£\"><a href=\"#ä¸ªäººç†è§£\" class=\"headerlink\" title=\"ä¸ªäººç†è§£\"></a>ä¸ªäººç†è§£</h1><p>ä»TSæµä¸­è·å–PATï¼Œè§£æPATå¾—åˆ°èŠ‚ç›®åˆ—è¡¨ï¼Œæ¯ä¸ªèŠ‚ç›®åˆ—è¡¨å¯¹åº”ä¸€ä¸ªPMTï¼Œ ä»PMTä¸­å¾—è¯¥èŠ‚ç›®å¯¹åº”çš„éŸ³è§†é¢‘PIDï¼Œ ä»TSæµæ ¹æ®PIDæ»¤å‡ºéŸ³è§†é¢‘TSåŒ…ï¼Œå°†TSåŒ…è¿˜åŸä¸ºPESåŒ…ï¼Œè¿›è€Œè¿˜åŸä¸ºESæµï¼ˆh264, aacï¼‰é€ç»™è§£ç å™¨è§£ç ã€‚</p>\n<p>ç»“åˆ<a href=\"https://tsduck.io/download/docs/mpegts-introduction.pdf\">An introduction to MPEG-TS</a>çœ‹èµ·æ¥æ›´æ˜“äºç†è§£ã€‚</p>\n<h1 id=\"åˆ†æå·¥å…·\"><a href=\"#åˆ†æå·¥å…·\" class=\"headerlink\" title=\"åˆ†æå·¥å…·\"></a>åˆ†æå·¥å…·</h1><p><a href=\"https://easyice.cn/archives/85\">easyice </a></p>\n"},{"layout":"post","title":"HLS ä»‹ç»ï¼ŒM3U8 æ ¼å¼åˆ†æ","date":"2022-10-12T16:00:00.000Z","_content":"\n# HLS æ˜¯ä»€ä¹ˆ\n\nç»´åŸºç™¾ç§‘çš„ä»‹ç»ï¼š\n\nHTTP Live Streamingï¼Œç¼©å†™ä¸ºHLSï¼Œæ˜¯ç”±è‹¹æœå…¬å¸æå‡ºåŸºäºHTTPçš„æµåª’ä½“ç½‘ç»œä¼ è¾“åè®®ã€‚æ˜¯è‹¹æœå…¬å¸QuickTime Xå’ŒiPhoneè½¯ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯æŠŠæ•´ä¸ªæµåˆ†æˆä¸€ä¸ªä¸ªå°çš„åŸºäºHTTPçš„æ–‡ä»¶æ¥ä¸‹è½½ï¼Œæ¯æ¬¡åªä¸‹è½½ä¸€äº›ã€‚å½“åª’ä½“æµæ­£åœ¨æ’­æ”¾æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä»è®¸å¤šä¸åŒçš„å¤‡ç”¨æºä¸­ä»¥ä¸åŒçš„é€Ÿç‡ä¸‹è½½åŒæ ·çš„èµ„æºï¼Œå…è®¸æµåª’ä½“ä¼šè¯é€‚åº”ä¸åŒçš„æ•°æ®é€Ÿç‡ã€‚åœ¨å¼€å§‹ä¸€ä¸ªæµåª’ä½“ä¼šè¯æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šä¸‹è½½ä¸€ä¸ªåŒ…å«å…ƒæ•°æ®çš„æ‰©å…… M3U (m3u8) æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ï¼Œç”¨äºå¯»æ‰¾å¯ç”¨çš„åª’ä½“æµã€‚\n\nHLSåªè¯·æ±‚åŸºæœ¬çš„HTTPæŠ¥æ–‡ï¼Œä¸å®æ—¶ä¼ è¾“åè®®ï¼ˆRTPï¼‰ä¸åŒï¼ŒHLSå¯ä»¥ç©¿è¿‡ä»»ä½•å…è®¸HTTPæ•°æ®é€šè¿‡çš„é˜²ç«å¢™æˆ–è€…ä»£ç†æœåŠ¡å™¨ã€‚å®ƒä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨å†…å®¹åˆ†å‘ç½‘ç»œæ¥ä¼ è¾“åª’ä½“æµã€‚\n\nè‹¹æœå…¬å¸æŠŠHLSåè®®ä½œä¸ºä¸€ä¸ªäº’è”ç½‘è‰æ¡ˆï¼ˆé€æ­¥æäº¤ï¼‰ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µä¸­å·²ä½œä¸ºä¸€ä¸ªéæ­£å¼çš„æ ‡å‡†æäº¤åˆ°IETFã€‚2017å¹´8æœˆï¼ŒRFC 8216å‘å¸ƒï¼Œæè¿°äº†HLSåè®®ç¬¬7ç‰ˆçš„å®šä¹‰ã€‚\n\nè‹¹æœè‡ªå·±çš„ä»‹ç»ï¼š\n\n> Send live and onâ€demand audio and video to iPhone, iPad, Mac, Apple Watch, Apple TV, and PC with HTTP Live Streaming (HLS) technology from Apple. Using the same protocol that powers the web, HLS lets you deploy content using ordinary web servers and content delivery networks. HLS is designed for reliability and dynamically adapts to network conditions by optimizing playback for the available speed of wired and wireless connections.\n\næ€»ç»“ä¸€ä¸‹ï¼š\n1. åŸºäºHTTPçš„æµåª’ä½“ç½‘ç»œä¼ è¾“åè®®ï¼Œæ”¯æŒå®‰å…¨é€šä¿¡ï¼ˆé€šè¿‡https, åª’ä½“æ•°æ®åŠ å¯†ç­‰ï¼‰\n2. å·¥ä½œåŸç†æ˜¯æŠŠæ•´ä¸ªæµåˆ†æˆä¸€ä¸ªä¸ªå°çš„åŸºäºHTTPçš„æ–‡ä»¶æ¥ä¸‹è½½, ä½¿ç”¨m3u8æè¿°æ’­æ”¾åˆ—è¡¨ã€‚\n3. æ”¯æŒç›´æ’­å’Œç‚¹æ’­ï¼ˆVODï¼Œ video on demandï¼‰\n4. å½“åª’ä½“æµæ­£åœ¨æ’­æ”¾æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä»è®¸å¤šä¸åŒçš„å¤‡ç”¨æºä¸­ä»¥ä¸åŒçš„é€Ÿç‡ä¸‹è½½åŒæ ·çš„èµ„æºï¼Œå…è®¸æµåª’ä½“ä¼šè¯é€‚åº”ä¸åŒçš„æ•°æ®é€Ÿç‡\n\n\n## HLS æµåª’ä½“æ¶æ„\n\n> Conceptually, HTTP Live Streaming consists of three parts: the server component, the distribution component, and the client software.\n>\n>In a typical configuration, a hardware encoder takes audio-video input, encodes it as HEVC video and AC-3 audio, and outputs a fragmented MPEG-4 file or an MPEG-2 transport stream. A software stream segmenter then breaks the stream into a series of short media files, which are placed on a web server. The segmenter also creates and maintains an index file containing a list of the media files. The URL of the index file is published on the web server. Client software reads the index, then requests the listed media files in order and displays them without any pauses or gaps between segments.\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656504345291665650434432.png)\n\n\næ¦‚å¿µä¸Šï¼ŒHLS åŒ…å«\n- æœåŠ¡ç«¯ç»„ä»¶\n- åˆ†å‘ç»„ä»¶\n- å®¢æˆ·ç«¯è½¯ä»¶\n\n\næ­¥éª¤ï¼š\n1. æœåŠ¡ç«¯ç¡¬ä»¶ç¼–ç å™¨ï¼Œå°†éŸ³è§†é¢‘è¾“å…¥ç¼–ç (è§†é¢‘ç¼–ç æˆHEVCï¼ŒH264, éŸ³é¢‘ç¼–ç æˆAACï¼ŒAC-3)ï¼Œ è¾“å‡ºtsæµï¼ˆä¹Ÿå¯ä»¥ç”Ÿæˆåˆ†æ®µçš„mp4æ–‡ä»¶ï¼Œ å¾ˆå°‘ç”¨ï¼‰\n2. åˆ†æ®µè½¯ä»¶ä¼šå°†tsæµåˆ†å‰²ï¼Œæ‰“åŒ…æˆtsæ–‡ä»¶ï¼ŒåŒæ—¶ç”Ÿæˆç´¢å¼•æ–‡ä»¶ï¼ˆm3u8ï¼‰,ç´¢å¼•æ–‡ä»¶ä¿å­˜äº†åª’ä½“æ–‡ä»¶çš„ä¿¡æ¯ã€‚\n3. å®¢æˆ·ç«¯è¯»å–m3u8ç´¢å¼•æ–‡ä»¶ï¼Œä¸‹è½½å¯¹åº”çš„tsæ–‡ä»¶ï¼Œå°†å†…å®¹æ’­æ”¾ç»™ç”¨æˆ·\n\n\nè‹¹æœæä¾›äº†ä¸€å¥—ç”¨äºHLSçš„å·¥å…·é›†ï¼Œå‚è€ƒï¼š\n\n[Using Apple's HTTP Live Streaming (HLS) Tools](https://developer.apple.com/documentation/http_live_streaming/using_apple_s_http_live_streaming_hls_tools)\n\n- Media File Segmenter (mediafilesegmenter), åª’ä½“æ–‡ä»¶åˆ†å‰²å™¨\n- Media Subtitle Segmenter (mediasubtitlesegmenter)ï¼Œ å­—å¹•åˆ†å‰²å™¨\n- Media Stream Segmenter (mediastreamsegmenter) åª’ä½“æµåˆ†å‰²å™¨\n- Variant Playlist Creator (variantplaylistcreator) å¯å˜æ’­æ”¾åˆ—è¡¨ç”Ÿæˆå™¨\n- ...\n\n# M3U8\n\n> The Unicode version of M3U is M3U8, which uses UTF-8-encoded characters. M3U8 files are the basis for the HTTP Live Streaming (HLS) format originally developed by Apple to stream video and radio to iOS devices, and which is now a popular format for adaptive streaming in general.\n\n> M3U (MP3 URL or Moving Picture Experts Group Audio Layer 3 Uniform Resource Locator in full) is a computer file format for a multimedia playlist. One common use of the M3U file format is creating a single-entry playlist file pointing to a stream on the Internet.\n\n> Although originally designed for audio files, such as MP3, it is commonly used to point media players to audio and video sources, including online sources.\n\n\næ€»ç»“ä¸€ä¸‹ï¼š\n\n1. M3U8 æ˜¯M3Uçš„Unicodeç‰ˆæœ¬ï¼Œä½¿ç”¨ UTF-8 ç¼–ç ï¼Œ æ˜¯ HLS çš„åŸºç¡€\n2. M3U æœ€åˆæ˜¯ä¸ºéŸ³é¢‘æ–‡ä»¶è®¾è®¡çš„ï¼Œä¾‹å¦‚MP3ï¼Œ ç°åœ¨ä¸å†å±€é™äºéŸ³é¢‘æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥ç´¢å¼•éŸ³é¢‘å’Œè§†é¢‘èµ„æºï¼Œç½‘ç»œèµ„æº\n3. ä¸‹é¢åˆ†æM3U æ–‡ä»¶æ ¼å¼\n\n\n**M3U**\n\n> An M3U file is a plain text file that specifies the locations of one or more media files. The file is saved with the \"m3u\" filename extension if the text is encoded in the local system's default non-Unicode encoding (e.g., a Windows codepage), or with the \"m3u8\" extension if the text is UTF-8 encoded.\n\næ€»ç»“ä¸€ä¸‹ï¼š\n1. M3U æ–‡ä»¶æ˜¯çº¯æ–‡æœ¬æ–‡ä»¶ï¼ŒæŒ‡å®šäº†èµ„æºæ–‡ä»¶çš„ä½ç½®\n2. ä»¥`.m3u`ä¸ºæ–‡ä»¶åç¼€\n3. ä½¿ç”¨ UTF-8 ç¼–ç çš„ç‰ˆæœ¬ï¼Œä»¥ `.m3u8`ä¸ºåç¼€\n\n\n## Extended M3U\n\nçœ‹ä¸€ä¸ªä¾‹å­ï¼š\n\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceA.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceB.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceC.ts\n#EXTINF:9.0,\nhttp://example.com/movie1/fileSequenceD.ts\n#EXT-X-ENDLIST\n```\n\nè¯­æ³•ï¼š\n- Tags: begin with '#EXT'\n- Comments: only begin with '#'\n- æ ‡ç­¾åé¢å¯ä»¥æœ‰å‚æ•°ï¼Œä¾‹å¦‚`#EXTINF:10.0`\n- æ ‡ç­¾å†…å®¹å¯ä»¥æ˜¯ï¼š\n    1. an absolute local pathname\n    2. a local pathname relative to the M3U file location; e.g. Heavysets.mp3\n    3. a URL\n\n\nè¡¨æ ¼å‚è€ƒï¼š[https://en.wikipedia.org/wiki/M3U](https://en.wikipedia.org/wiki/M3U)\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656557421391665655741667.png)\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656557911381665655790476.png)\n\n## ä¾‹å­åˆ†æ\n\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceA.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceB.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceC.ts\n#EXTINF:9.0,\nhttp://example.com/movie1/fileSequenceD.ts\n#EXT-X-ENDLIST\n```\n\n**EXTM3U**\n\nè¡¨æ˜æ˜¯`extended M3U`æ–‡ä»¶ï¼Œ åŒºåˆ«äºåŸºæœ¬çš„`M3U`æ–‡ä»¶ã€‚m3u8æ–‡ä»¶å¿…é¡»ä»¥è¯¥æ ‡ç­¾å¼€å§‹ã€‚\n\n\n**EXT-X-PLAYLIST-TYPE**\n\nç±»å‹å¯ä»¥æ˜¯ï¼š\n\n- VODï¼Œ ä»£è¡¨ç‚¹æ’­ï¼Œ ç»“å°¾åŒ…å«`#EXT-X-ENDLIST`\n- EVENTï¼Œ ä»£è¡¨ç›´æ’­, ç»“å°¾ä¸åŒ…å«`#EXT-X-ENDLIST`\n\n**EXT-X-TARGETDURATION**\n\nå•ä¸ªåª’ä½“æ–‡ä»¶çš„æœ€å¤§æ—¶é•¿ã€‚æ¯ä¸€ä¸ª`#EXTINF:10.0`æ ‡ç­¾æŒ‡å®šçš„æ—¶é•¿`<=`EXT-X-TARGETDURATION\n\n**EXT-X-MEDIA-SEQUENCE**\n\n> Indicates the sequence number of the first URL that appears in a playlist file. Each media file URL in a playlist has a unique integer sequence number. The sequence number of a URL is higher by 1 than the sequence number of the URL that preceded it. The media sequence numbers have no relation to the names of the files.\n\nm3u8æ–‡ä»¶ä¸­ç¬¬ä¸€ä¸ªURLæ–‡ä»¶çš„ç¼–å·ï¼Œä¸æ–‡ä»¶åå­—æ— å…³ï¼Œæ¯æ¬¡æ¯”å‰é¢çš„+1ã€‚\n\n**EXT-X-VERSION**\n\n> The EXT-X-VERSION tag indicates the compatibility version of the Playlist file. This file, its associated media, and its server must comply with all provisions of the IETF Internet-Draft of \"HTTP Live Streaming 2nd Edition\" (or earlier specifications) describing the protocol version indicated by the tag value. A Playlist file that doesn't contain an EXT-X-VERSION tag must comply with version 1 of this protocol.\n\nè¡¨æ˜è¯¥m3u8æ–‡ä»¶çš„ç‰ˆæœ¬å…¼å®¹æ€§ã€‚è¯¥m3u8æ–‡ä»¶ï¼Œå…³è”çš„åª’ä½“ï¼ŒæœåŠ¡å™¨å¿…é¡»æœä»äºè¯¥ç‰ˆæœ¬ç‰¹æ€§ã€‚å¦‚æœä¸åŒ…å«è¯¥å­—æ®µï¼Œå¿…é¡»æœä»ä¸ç‰ˆæœ¬1çš„è§„å®šã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656577590671665657758695.png)\n\nå‚è€ƒï¼š [About the EXT-X-VERSION tag](https://developer.apple.com/documentation/http_live_streaming/about_the_ext-x-version_tag)\n\n\n**EXTINF**\n\n- æè¿°èµ„æºæ–‡ä»¶æ—¶é•¿ï¼ŒURL\n- æ—¶é•¿ï¼š ç‰ˆæœ¬å°äº3æ˜¯intï¼Œ ç‰ˆæœ¬å¤§äºç­‰äº3æ˜¯float, å•ä½ç§’\n\n**EXT-X-ENDLIST**\n\nç»“æŸæ ‡å¿—ï¼Œè¡¨æ˜æ²¡æœ‰æ›´å¤šèµ„æºäº†ã€‚vodæœ‰ï¼Œeventå¯èƒ½æ²¡æœ‰ã€‚\n\n\n### VOD Playlist ç‚¹æ’­\n\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceA.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceB.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceC.ts\n#EXTINF:9.0,\nhttp://example.com/movie1/fileSequenceD.ts\n#EXT-X-ENDLIST\n```\n### live Playlist(Sliding Window) ç›´æ’­æ»‘åŠ¨çª—å£\n\n> In live sessions, the index file is updated by removing media URIs from the file as new media files are created and made available. The EXT-X-ENDLIST tag isn't present in the live playlist, indicating that new media files will be added to the index file as they become available.\n\nç›´æ’­æµï¼Œm3u8æ–‡ä»¶ä¼šæ›´æ–°ï¼Œå‰é¢çš„èµ„æºä¼šè¢«ç§»é™¤ï¼Œåé¢çš„èµ„æºä¼šè¢«è¿½åŠ ã€‚\næ²¡æœ‰`EXT-X-ENDLIST`æ ‡ç­¾ï¼Œè¡¨ç¤ºè¿˜ä¼šæœ‰æ–°çš„èµ„æºè¢«æ·»åŠ ã€‚\n\nçœ‹ä¸€ä¸ªä¾‹å­ï¼Œå¼€å§‹æ—¶æ–‡ä»¶å†…å®¹\n```\n#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:1\n#EXTINF:10.0,\nfileSequence1.ts\n#EXTINF:10.0,\nfileSequence2.ts\n#EXTINF:10.0,\nfileSequence3.ts\n#EXTINF:10.0,\nfileSequence4.ts\n#EXTINF:10.0,\nfileSequence5.ts\n```\n\næ—§èµ„æºè¢«åˆ é™¤ï¼Œæ–°èµ„è¢«æ·»åŠ ï¼Œçœ‹åˆ°`EXT-X-MEDIA-SEQUENCE`ä¹Ÿå‘ç”Ÿäº†å˜åŒ–\n```\n#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:2\n#EXTINF:10.0,\nfileSequence2.ts\n#EXTINF:10.0,\nfileSequence3.ts\n#EXTINF:10.00,\nfileSequence4.ts\n#EXTINF:10.00,\nfileSequence5.ts\n#EXTINF:10.0,\nfileSequence6.ts\n```\n\nå†æ¬¡æ›´æ–°\n```\n#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:4\n#EXTINF:10.00,\nfileSequence4.ts\n#EXTINF:10.00,\nfileSequence5.ts\n#EXTINF:10.0,\nfileSequence6.ts,\n#EXTINF:10.0,\nfileSequence7.ts,\n#EXTINF:10.0,\nfileSequence8.ts,\n#EXTINF:10.0,\nfileSequence9.ts\n```\n\n### Event Playlist\n\n> An event playlist is specified by the EXT-X-PLAYLIST-TYPE tag with a value of EVENT. It doesn't initially have an EXT-X-ENDLIST tag, indicating that new media files will be added to the playlist as they become available.\n\n\n\n\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:EVENT\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.00,\nfileSequence0.ts\n#EXTINF:10.0,\nfileSequence1.ts\n#EXTINF:10.0,\nfileSequence2.ts\n#EXTINF:10.0,\nfileSequence3.ts\n#EXTINF:10.0,\nfileSequence4.ts\n```\n\nè§‚å¯Ÿåˆ°`#EXT-X-PLAYLIST-TYPE:EVENT`\n\n> If the tag is present and has a value of EVENT, the server must not change or delete any part of the playlist file (although it may append lines to it). If the tag is present and has a value of VOD, the playlist file must not change.\n\n> You can't remove anything from the playlist when using the EVENT tag; you may only append new segments to the end of the file. New segments are added to the end of the file until the event has concluded, at which time the EXT-X-ENDLIST tag is appended.\n\nå¦‚æœç±»å‹ä¸ºEVENTï¼Œæ›´æ–°m3u8æ–‡ä»¶ï¼Œåªèƒ½è¿½åŠ ï¼Œä¸èƒ½åˆ é™¤ã€‚\nå¦‚æœç±»å‹ä¸ºVODï¼Œä¸èƒ½æ›´æ”¹m3u8æ’­æ”¾åˆ—è¡¨ã€‚\n\næ›´æ–°å\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:EVENT\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.0,\nfileSequence0.ts\n#EXTINF:10.0,\nfileSequence1.ts\n#EXTINF:10.0,\nfileSequence2.ts\n#EXTINF:10.0,\nfileSequence3.ts\n#EXTINF:10.0,\nfileSequence4.ts\n\n// List of files between 4 and 120 go here.\n\n#EXTINF:10.0,\nfileSequence120.ts\n#EXTINF:10.0,\nfileSequence121.ts\n#EXT-X-ENDLIST\n```\n\n\n### Creating a Multivariant Playlist\n\n> Offer multiple playlist files to provide different encodings of the same content.\n\nä¸ºåŒä¸€ä»½å†…å®¹ï¼Œæä¾›å¤šä¸ªm3u8ç´¢å¼•ï¼Œæ¯ä¸ªm3u8é‡‡ç”¨ä¸åŒçš„ç¼–ç å‚æ•°ã€‚\n\n\n> The Multivariant Playlist describes all of the available variants for your content. Each variant is a version of the stream at a particular bit rate and is contained in a separate playlist. The client switches to the most appropriate variant based on the measured network bit rate. The clientâ€™s player is tuned to minimize stalling of playback, to give the user the best possible streaming experience.\n\nä¸ºåŒä¸€ä»½å†…å®¹ï¼Œæä¾›å¤šä¸ªç ç‡çš„m3u8,æ–¹ä¾¿å®¢æˆ·ç«¯æ’­æ”¾å™¨é€‰æ‹©é€‚åº”è‡ªèº«ç½‘ç»œçŠ¶å†µçš„æœ€ä½³ç ç‡èµ„æºã€‚\n\nç»“æ„å›¾ï¼š\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656676568981665667656356.png)\n\n\næ–‡ä»¶ç¤ºä¾‹\n\n```\n#EXTM3U\n#EXT-X-STREAM-INF:BANDWIDTH=150000,RESOLUTION=416x234,CODECS=\"avc1.42e00a,mp4a.40.2\"\nhttp://example.com/low/index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=240000,RESOLUTION=416x234,CODECS=\"avc1.42e00a,mp4a.40.2\"\nhttp://example.com/lo_mid/index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=440000,RESOLUTION=416x234,CODECS=\"avc1.42e00a,mp4a.40.2\"\nhttp://example.com/hi_mid/index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=640000,RESOLUTION=640x360,CODECS=\"avc1.42e00a,mp4a.40.2\"\nhttp://example.com/high/index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=64000,CODECS=\"mp4a.40.5\"\nhttp://example.com/audio/index.m3u8\n```\n\n**EXT-X-STREAM-INF**\nIndicates that the next URL in the playlist file identifies another playlist file.\n\nè¡¨æ˜å®ƒçš„URLå†…å®¹æ˜¯ä¸€ä¸ªm3u8æ–‡ä»¶ã€‚\n\nThe EXT-X-STREAM-INF tag has the following parameters:\n\n**AVERAGE-BANDWIDTH**\n\n(Optional, but recommended) An integer that represents the average bit rate for the variant stream.\n\nå¹³å‡ç ç‡ï¼Œå¯é€‰ã€‚\n\n\n**BANDWIDTH**\n\n(Required) An integer that is the upper bound of the overall bit rate for each media file, in bits per second. The upper bound value is calculated to include any container overhead that appears or will appear in the playlist.\n\nå¸¦å®½ã€‚\n\n**FRAME-RATE**\n\n(Optional, but recommended) A floating-point value that describes the maximum frame rate in a variant stream.\n\nå¸§ç‡ï¼Œå¯é€‰ï¼Œ è¡¨ç¤ºè¯¥æµçš„æœ€å¤§å¸§ç‡ã€‚\n\n**HDCP-LEVEL**\n\n(Optional) Indicates the type of encryption used. Valid values are TYPE-0 and NONE. Use TYPE-0 if the stream may not play unless the output is protected by HDCP.\n\nåŠ å¯†æ–¹å¼ï¼Œå¯é€‰ã€‚\n\n**RESOLUTION**\n\n(Optional, but recommended) The optional display size, in pixels, at which to display the video in the playlist. This parameter should be included for any stream that includes video.\n\nè§†é¢‘åˆ†è¾¨ç‡ã€‚\n\n\n**VIDEO-RANGE**\n\n(Required depending on encoding) A string with valid values of SDR or PQ. If transfer characteristic codes 1, 16, or 18 arenâ€™t specified, then this parameter must be omitted.\n\n**CODECS**\n\n(Optional, but recommended) A quoted string containing a comma-separated list of formats, where each format specifies a media sample type thatâ€™s present in a media segment in the playlist file. Valid format identifiers are those in the ISO file format name space defined by RFC 6381.\n\nç¼–ç å™¨ç›¸å…³å‚æ•°ã€‚\n\n### Adding Alternate Media to a Playlist\n\n> Specify Rendition Playlists that can override the main presentation.\n\n> Adding alternate media to a Multivariant Playlist allows a provider to specify one of a set of variant playlists as an override of the main presentation. The client plays only the override media (audio or video), and suppresses any media of the same type from the main presentation, if present. This allows a presentation to offer multiple versions of the media without requiring the provider to store duplicate media, or requiring the client to download all variants when it only needs one. It also allows additional media to be offered subsequently without remastering the original content.\n\nåœ¨ä¸»éŸ³é¢‘è§†é¢‘èµ„æºå¤–ï¼Œæä¾›å¤šè·¯å¤‡é€‰èµ„æºã€‚\né€‰æ‹©å¤‡é€‰çš„éŸ³è§†é¢‘ï¼Œå®¢æˆ·ç«¯åªä¼šæ’­æ”¾å¤‡é€‰éŸ³è§†é¢‘èµ„æºã€‚\n\n\nä¸‹é¢çš„ä¾‹å­ï¼Œæä¾›å¤‡é€‰çš„å¤šè¯­è¨€éŸ³é¢‘æ’­æ”¾åˆ—è¡¨\n\n```\n#EXTM3U\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio\",LANGUAGE=\"eng\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"eng/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio\",LANGUAGE=\"fre\",NAME=\"FranÃ§ais\",AUTOSELECT=YES, DEFAULT=NO,URI=\"fre/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio\",LANGUAGE=\"sp\",NAME=\"Espanol\",AUTOSELECT=YES, DEFAULT=NO,URI=\"sp/prog_index.m3u8\"\n\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=195023,CODECS=\"avc1.42e00a,mp4a.40.2\",AUDIO=\"audio\"\nlo/prog_index.m3u8\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=591680,CODECS=\"avc1.42e01e,mp4a.40.2\",AUDIO=\"audio\"\nhi/prog_index.m3u8\n```\n\nThe tags used in this Multivariant Playlist example include:\n\n**EXT-X-MEDIA**\nIdentifies an element of a media selection group. All the elements of a media selection group must have similar characteristics, for example, the same codecs and the same maximum bandwidth.\n\nè¡¨ç¤ºåª’ä½“é€‰é¡¹åˆ†ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼ŒåŒä¸€ä¸ªåˆ†ç»„ä¸­çš„åª’ä½“å…·æœ‰ç›¸åŒçš„ç‰¹å¾ï¼Œå¦‚ç›¸åŒçš„ç¼–è§£ç æˆ–å¸¦å®½ã€‚\n\nEXT-X-STREAM-INF\nindicates that the next URL in the Multivariant Playlist identifies a Rendition Playlist. See Creating a Multivariant Playlist for the basic parameters.\n\nè¡¨æ˜å®ƒçš„å†…å®¹æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œ æŒ‡å‘ä¸€ä¸ªm3u8æ–‡ä»¶\n\nThe EXT-X-MEDIA tag has the following parameters:\n\nTYPE\n(Required) A string indicating the type of media. Valid values are AUDIO, VIDEO, SUBTITLES, and CLOSED-CAPTIONS.\n\nåª’ä½“ç±»å‹\n- AUDIO\n- VIDEO\n- SUBTITLES\n- CLOSED-CAPTIONS\n\n\nGROUP-ID\n(Required) A string specifying the group that the media selection belongs to.\n\nåˆ†ç»„æ ‡è¯†ï¼Œå­—ç¬¦ä¸²ï¼Œå¿…é¡»æœ‰ã€‚\n\nLANGUAGE\n(Optional) A string that identifies the primary language used in the media selection.\n\nè¯¥é€‰é¡¹ä¸­åª’ä½“æ–‡ä»¶å¯¹åº”çš„è¯­è¨€ï¼Œå¯é€‰ã€‚\n\nNAME\n(Required) A string that describes the primary language used in the media selection.\n\nè¯¥é€‰é¡¹ä¸­åª’ä½“æ–‡ä»¶å¯¹åº”çš„è¯­è¨€çš„å­—ç¬¦ä¸²æ ‡è¯†ï¼Œå¿…é¡»ã€‚\n\nAUTOSELECT\n(Optional) A string that indicates that the client may play the media selection in the absence of explicit user preference. Valid values are YES and NO. If the value of DEFAULT is YES, this value must also be YES.\n\næ˜¯å¦è‡ªåŠ¨é€‰æ‹©ï¼Œå¯é€‰ã€‚åœ¨ç”¨æˆ·åå¥½ç¼ºçœçš„æ—¶å€™ï¼ŒæŒ‡ç¤ºå®¢æˆ·ç«¯æ˜¯å¦åº”è¯¥è‡ªåŠ¨é€‰æ‹©è¯¥é€‰é¡¹ã€‚åˆæ³•çš„å€¼æ˜¯YESå’ŒNOï¼Œ\nå¦‚æœ`DEFAULT`æ˜¯YESï¼Œ è¯¥å­—æ®µçš„å€¼å¿…é¡»ä¹Ÿæ˜¯YES.\n\nDEFAULT\n(Optional) A string indicating that the media selection should be played if the user hasnâ€™t selected another option. Valid values are YES and NO.\n\næ˜¯å¦é»˜è®¤æ’­æ”¾è¯¥é€‰é¡¹ï¼Œå¯é€‰ã€‚ç”¨æˆ·æ²¡æœ‰é€‰æ‹©å…¶ä»–é€‰é¡¹çš„æ—¶å€™ï¼Œæ˜¯å¦é»˜è®¤æ’­æ”¾è¯¥é€‰é¡¹ã€‚\n\nINSTREAM-ID\n(Required for closed captions) A string that specifies a rendition within the segments in the media playlist. When the TYPE attribute is CLOSED-CAPTIONS, the INSTREAM-ID must have one of the following values: CC1, CC3, CC3, CC4, or SERVICEn, where n is between 1 and 63.\n\n\nASSOC-LANGUAGE\n(Optional) A string containing a language tag for the rendition. An associated language is often different from the language specified in the LANGUAGE attribute.\n\nå…³è”çš„è¯­è¨€ï¼Œå¯é€‰ã€‚\n\nCHANNELS\n(Required when two renditions have the same codec but a different number of channels) An ordered string that indicates the maximum number of independent, simultaneous audio channels present in a media segment.\n\nè¡¨æ˜è¯¥éŸ³é¢‘æ–‡ä»¶æœ‰å‡ ä¸ªå£°é“\n\nURI\n(Optional) A string containing a URI that identifies the media playlist file. If the TYPE is CLOSED-CAPTIONS, this attribute must be omitted. When this attribute is omitted, the media content is in the original variant.\n\nåª’ä½“æ–‡ä»¶åœ°å€ï¼Œå¯é€‰ã€‚\n\nWhen its URI attribute is omitted, the EXT-X-MEDIA tag can indicate that the media described is included in the URI of the EXT-X-STREAM-INF tag.\n\nå¦‚æœURIå­—æ®µä¸å­˜åœ¨ï¼Œ`EXT-X-MEDIA`æè¿°çš„çš„åª’ä½“æ–‡ä»¶å­˜åœ¨äº`EXT-X-STREAM-INF`æ ‡ç­¾ä¸­ã€‚\n\nThe EXT-X-STREAM-INF tag has the following parameters:\n\nAUDIO\n(Optional) A quoted string that indicates the set of audio streams that may be used when playing the presentation. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is AUDIO.\n\n\nVIDEO\n(Optional) A quoted string that indicates the set of video streams that may be used when playing the presentation. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is VIDEO.\n\nSUBTITLES\n(Optional) A quoted string that indicates the set of subtitle renditions that can be used. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is SUBTITLE.\n\nCLOSED-CAPTIONS\n(Optional) Either a quoted string that indicates the set of closed captions that can be used or an enumerated string with the value of NONE. When this value is a quoted string, it must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is CLOSED-CAPTIONS. If the enumerated value is NONE, all EXT-X-STREAM-INF tags must have this attribute with a value of NONE.\n\n\næ€»ç»“ä¸€ä¸‹ï¼š\n\né€šè¿‡`EXT-X-MEDIA`å¯ä»¥å®šä¹‰èµ„æºç»„ï¼Œå¯ä»¥æœ‰å¤šä¸ªç»„ï¼Œç”¨GROUP-IDæ¥åŒºåˆ†ï¼Œ æœ‰å››ç§ç»„ç±»å‹\n- AUDIO\n- VIDEO\n- SUBTITLES\n- CLOSED-CAPTIONS\n\næ¯ä¸ªåˆ†ç»„ä¸­æµå±æ€§æ˜¯ç›¸åŒï¼Œå…¶å‚æ•°å¯ä»¥é€šè¿‡å…³è”çš„`EXT-X-STREAM-INF`æŒ‡å®š\né€šè¿‡`EXT-X-STREAM-INF`å®šä¹‰èµ„æºç»„çš„æµå‚æ•°ï¼Œå¸¦å®½ï¼Œç¼–è§£ç å™¨ä¿¡æ¯ã€‚ å®ƒå…³è”ä¸€ä¸ªç»„IDï¼Œè¿™ä¸ªç»„å†…çš„æ‰€æœ‰å¤‡é€‰åª’ä½“éƒ½å…·æœ‰ç›¸åŒçš„æ€§è´¨ã€‚\n\n\nYou can have multiple audio groups to allow changes in codes or bit rate. However, each audio group in a variant must have the same alternates in it. For example, you canâ€™t have English in one audio group and leave it out of the other group. The following example defines two audio groups, one for low bit rates and one for high bit rates. Both audio groups define the same set of languages but are called based on the available bandwidth.\n\næ¯ä¸ªç»„å¯ä»¥æä¾›å¤šä¸ªç ç‡çš„åª’ä½“æ–‡ä»¶ï¼Œå…¶ç ç‡å¯ä»¥é€šè¿‡`EXT-X-STREAM-INF`æŒ‡å®šï¼Œè™½ç„¶`GROUP-ID`ç›¸åŒï¼Œä½†æ˜¯ç ç‡æ˜¯ä¸åŒçš„ã€‚\n\n```\n#EXTM3U\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-lo\",LANGUAGE=\"eng\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"englo/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-lo\",LANGUAGE=\"fre\",NAME=\"FranÃ§ais\",AUTOSELECT=YES, DEFAULT=NO,URI=\"frelo/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-lo\",LANGUAGE=\"es\",NAME=\"Espanol\",AUTOSELECT=YES, DEFAULT=NO,URI=\"splo/prog_index.m3u8\"\n \n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-hi\",LANGUAGE=\"eng\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"eng/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-hi\",LANGUAGE=\"fre\",NAME=\"FranÃ§ais\",AUTOSELECT=YES, DEFAULT=NO,URI=\"fre/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-hi\",LANGUAGE=\"es\",NAME=\"Espanol\",AUTOSELECT=YES, DEFAULT=NO,URI=\"sp/prog_index.m3u8\"\n \n#EXT-X-STREAM-INF:BANDWIDTH=195023,CODECS=\"mp4a.40.5\", AUDIO=\"audio-lo\"\nlo/prog_index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=260000,CODECS=\"avc1.42e01e,mp4a.40.2\", AUDIO=\"audio-lo\"\nhi/prog_index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=591680,CODECS=\"mp4a.40.2, avc1.64001e\", AUDIO=\"audio-hi\"\nlo/prog_index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=650000,CODECS=\"avc1.42e01e,mp4a.40.2\", AUDIO=\"audio-hi\"\nhi/prog_index.m3u8\n\n```\n\nYou can have both a group and a single stream in a playlist. This is often done when you have multiple camera angles that all use the same audio. Create a group for the video streams and then declare the single audio stream. The following example shows a playlist with three camera angles and a single audio stream:\n\nä¸€ä¸ªè§†é¢‘ç»„å…³è”å•ä¸ªéŸ³é¢‘çš„æƒ…å†µã€‚\n\n```\n#EXTM3U\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle1\",AUTOSELECT=YES,DEFAULT=YES\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle2\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle2/500kbs/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle3\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle3/500kbs/prog_index.m3u8\"\n\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"aac\",LANGUAGE=\"en\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"eng/prog_index.m3u8\"\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=754857,CODECS=\"mp4a.40.2,avc1.4d401e\", VIDEO=\"500kbs\",AUDIO=\"aac\"\nAngle1/500kbs/prog_index.m3u8\n```\n\nTo provide different streams for different bit rates, a different video group ID is needed for each bit rate.\n\n```\n#EXTM3U\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"200kbs\",NAME=\"Angle1\",AUTOSELECT=YES,DEFAULT=YES\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"200kbs\",NAME=\"Angle2\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle2/200kbs/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"200kbs\",NAME=\"Angle3\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle3/200kbs/prog_index.m3u8\"\n\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle1\",AUTOSELECT=YES,DEFAULT=YES\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle2\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle2/500kbs/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle3\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle3/500kbs/prog_index.m3u8\"\n\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"aac\",LANGUAGE=\"en\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"eng/prog_index.m3u8\"\n\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=300000,CODECS=\"mp4a.40.2,avc1.4d401e\", VIDEO=\"200kbs\",AUDIO=\"aac\"\nAngle1/200kbs/prog_index.m3u\n\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=754857,CODECS=\"mp4a.40.2,avc1.4d401e\", VIDEO=\"500kbs\",AUDIO=\"aac\"\nAngle1/500kbs/prog_index.m3u8\n```\n\nå‚è€ƒï¼š\nhttps://developer.apple.com/documentation/http_live_streaming\nhttps://aleen42.gitbooks.io/wiki/content/summary/m3u8/m3u8.html","source":"_posts/hls/2022-10-13-HLS-ä»‹ç».md","raw":"---\nlayout: post\ntitle: \"HLS ä»‹ç»ï¼ŒM3U8 æ ¼å¼åˆ†æ\"\ndate: 2022-10-13\ntag: hls,m3u8\n---\n\n# HLS æ˜¯ä»€ä¹ˆ\n\nç»´åŸºç™¾ç§‘çš„ä»‹ç»ï¼š\n\nHTTP Live Streamingï¼Œç¼©å†™ä¸ºHLSï¼Œæ˜¯ç”±è‹¹æœå…¬å¸æå‡ºåŸºäºHTTPçš„æµåª’ä½“ç½‘ç»œä¼ è¾“åè®®ã€‚æ˜¯è‹¹æœå…¬å¸QuickTime Xå’ŒiPhoneè½¯ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯æŠŠæ•´ä¸ªæµåˆ†æˆä¸€ä¸ªä¸ªå°çš„åŸºäºHTTPçš„æ–‡ä»¶æ¥ä¸‹è½½ï¼Œæ¯æ¬¡åªä¸‹è½½ä¸€äº›ã€‚å½“åª’ä½“æµæ­£åœ¨æ’­æ”¾æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä»è®¸å¤šä¸åŒçš„å¤‡ç”¨æºä¸­ä»¥ä¸åŒçš„é€Ÿç‡ä¸‹è½½åŒæ ·çš„èµ„æºï¼Œå…è®¸æµåª’ä½“ä¼šè¯é€‚åº”ä¸åŒçš„æ•°æ®é€Ÿç‡ã€‚åœ¨å¼€å§‹ä¸€ä¸ªæµåª’ä½“ä¼šè¯æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šä¸‹è½½ä¸€ä¸ªåŒ…å«å…ƒæ•°æ®çš„æ‰©å…… M3U (m3u8) æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ï¼Œç”¨äºå¯»æ‰¾å¯ç”¨çš„åª’ä½“æµã€‚\n\nHLSåªè¯·æ±‚åŸºæœ¬çš„HTTPæŠ¥æ–‡ï¼Œä¸å®æ—¶ä¼ è¾“åè®®ï¼ˆRTPï¼‰ä¸åŒï¼ŒHLSå¯ä»¥ç©¿è¿‡ä»»ä½•å…è®¸HTTPæ•°æ®é€šè¿‡çš„é˜²ç«å¢™æˆ–è€…ä»£ç†æœåŠ¡å™¨ã€‚å®ƒä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨å†…å®¹åˆ†å‘ç½‘ç»œæ¥ä¼ è¾“åª’ä½“æµã€‚\n\nè‹¹æœå…¬å¸æŠŠHLSåè®®ä½œä¸ºä¸€ä¸ªäº’è”ç½‘è‰æ¡ˆï¼ˆé€æ­¥æäº¤ï¼‰ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µä¸­å·²ä½œä¸ºä¸€ä¸ªéæ­£å¼çš„æ ‡å‡†æäº¤åˆ°IETFã€‚2017å¹´8æœˆï¼ŒRFC 8216å‘å¸ƒï¼Œæè¿°äº†HLSåè®®ç¬¬7ç‰ˆçš„å®šä¹‰ã€‚\n\nè‹¹æœè‡ªå·±çš„ä»‹ç»ï¼š\n\n> Send live and onâ€demand audio and video to iPhone, iPad, Mac, Apple Watch, Apple TV, and PC with HTTP Live Streaming (HLS) technology from Apple. Using the same protocol that powers the web, HLS lets you deploy content using ordinary web servers and content delivery networks. HLS is designed for reliability and dynamically adapts to network conditions by optimizing playback for the available speed of wired and wireless connections.\n\næ€»ç»“ä¸€ä¸‹ï¼š\n1. åŸºäºHTTPçš„æµåª’ä½“ç½‘ç»œä¼ è¾“åè®®ï¼Œæ”¯æŒå®‰å…¨é€šä¿¡ï¼ˆé€šè¿‡https, åª’ä½“æ•°æ®åŠ å¯†ç­‰ï¼‰\n2. å·¥ä½œåŸç†æ˜¯æŠŠæ•´ä¸ªæµåˆ†æˆä¸€ä¸ªä¸ªå°çš„åŸºäºHTTPçš„æ–‡ä»¶æ¥ä¸‹è½½, ä½¿ç”¨m3u8æè¿°æ’­æ”¾åˆ—è¡¨ã€‚\n3. æ”¯æŒç›´æ’­å’Œç‚¹æ’­ï¼ˆVODï¼Œ video on demandï¼‰\n4. å½“åª’ä½“æµæ­£åœ¨æ’­æ”¾æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä»è®¸å¤šä¸åŒçš„å¤‡ç”¨æºä¸­ä»¥ä¸åŒçš„é€Ÿç‡ä¸‹è½½åŒæ ·çš„èµ„æºï¼Œå…è®¸æµåª’ä½“ä¼šè¯é€‚åº”ä¸åŒçš„æ•°æ®é€Ÿç‡\n\n\n## HLS æµåª’ä½“æ¶æ„\n\n> Conceptually, HTTP Live Streaming consists of three parts: the server component, the distribution component, and the client software.\n>\n>In a typical configuration, a hardware encoder takes audio-video input, encodes it as HEVC video and AC-3 audio, and outputs a fragmented MPEG-4 file or an MPEG-2 transport stream. A software stream segmenter then breaks the stream into a series of short media files, which are placed on a web server. The segmenter also creates and maintains an index file containing a list of the media files. The URL of the index file is published on the web server. Client software reads the index, then requests the listed media files in order and displays them without any pauses or gaps between segments.\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656504345291665650434432.png)\n\n\næ¦‚å¿µä¸Šï¼ŒHLS åŒ…å«\n- æœåŠ¡ç«¯ç»„ä»¶\n- åˆ†å‘ç»„ä»¶\n- å®¢æˆ·ç«¯è½¯ä»¶\n\n\næ­¥éª¤ï¼š\n1. æœåŠ¡ç«¯ç¡¬ä»¶ç¼–ç å™¨ï¼Œå°†éŸ³è§†é¢‘è¾“å…¥ç¼–ç (è§†é¢‘ç¼–ç æˆHEVCï¼ŒH264, éŸ³é¢‘ç¼–ç æˆAACï¼ŒAC-3)ï¼Œ è¾“å‡ºtsæµï¼ˆä¹Ÿå¯ä»¥ç”Ÿæˆåˆ†æ®µçš„mp4æ–‡ä»¶ï¼Œ å¾ˆå°‘ç”¨ï¼‰\n2. åˆ†æ®µè½¯ä»¶ä¼šå°†tsæµåˆ†å‰²ï¼Œæ‰“åŒ…æˆtsæ–‡ä»¶ï¼ŒåŒæ—¶ç”Ÿæˆç´¢å¼•æ–‡ä»¶ï¼ˆm3u8ï¼‰,ç´¢å¼•æ–‡ä»¶ä¿å­˜äº†åª’ä½“æ–‡ä»¶çš„ä¿¡æ¯ã€‚\n3. å®¢æˆ·ç«¯è¯»å–m3u8ç´¢å¼•æ–‡ä»¶ï¼Œä¸‹è½½å¯¹åº”çš„tsæ–‡ä»¶ï¼Œå°†å†…å®¹æ’­æ”¾ç»™ç”¨æˆ·\n\n\nè‹¹æœæä¾›äº†ä¸€å¥—ç”¨äºHLSçš„å·¥å…·é›†ï¼Œå‚è€ƒï¼š\n\n[Using Apple's HTTP Live Streaming (HLS) Tools](https://developer.apple.com/documentation/http_live_streaming/using_apple_s_http_live_streaming_hls_tools)\n\n- Media File Segmenter (mediafilesegmenter), åª’ä½“æ–‡ä»¶åˆ†å‰²å™¨\n- Media Subtitle Segmenter (mediasubtitlesegmenter)ï¼Œ å­—å¹•åˆ†å‰²å™¨\n- Media Stream Segmenter (mediastreamsegmenter) åª’ä½“æµåˆ†å‰²å™¨\n- Variant Playlist Creator (variantplaylistcreator) å¯å˜æ’­æ”¾åˆ—è¡¨ç”Ÿæˆå™¨\n- ...\n\n# M3U8\n\n> The Unicode version of M3U is M3U8, which uses UTF-8-encoded characters. M3U8 files are the basis for the HTTP Live Streaming (HLS) format originally developed by Apple to stream video and radio to iOS devices, and which is now a popular format for adaptive streaming in general.\n\n> M3U (MP3 URL or Moving Picture Experts Group Audio Layer 3 Uniform Resource Locator in full) is a computer file format for a multimedia playlist. One common use of the M3U file format is creating a single-entry playlist file pointing to a stream on the Internet.\n\n> Although originally designed for audio files, such as MP3, it is commonly used to point media players to audio and video sources, including online sources.\n\n\næ€»ç»“ä¸€ä¸‹ï¼š\n\n1. M3U8 æ˜¯M3Uçš„Unicodeç‰ˆæœ¬ï¼Œä½¿ç”¨ UTF-8 ç¼–ç ï¼Œ æ˜¯ HLS çš„åŸºç¡€\n2. M3U æœ€åˆæ˜¯ä¸ºéŸ³é¢‘æ–‡ä»¶è®¾è®¡çš„ï¼Œä¾‹å¦‚MP3ï¼Œ ç°åœ¨ä¸å†å±€é™äºéŸ³é¢‘æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥ç´¢å¼•éŸ³é¢‘å’Œè§†é¢‘èµ„æºï¼Œç½‘ç»œèµ„æº\n3. ä¸‹é¢åˆ†æM3U æ–‡ä»¶æ ¼å¼\n\n\n**M3U**\n\n> An M3U file is a plain text file that specifies the locations of one or more media files. The file is saved with the \"m3u\" filename extension if the text is encoded in the local system's default non-Unicode encoding (e.g., a Windows codepage), or with the \"m3u8\" extension if the text is UTF-8 encoded.\n\næ€»ç»“ä¸€ä¸‹ï¼š\n1. M3U æ–‡ä»¶æ˜¯çº¯æ–‡æœ¬æ–‡ä»¶ï¼ŒæŒ‡å®šäº†èµ„æºæ–‡ä»¶çš„ä½ç½®\n2. ä»¥`.m3u`ä¸ºæ–‡ä»¶åç¼€\n3. ä½¿ç”¨ UTF-8 ç¼–ç çš„ç‰ˆæœ¬ï¼Œä»¥ `.m3u8`ä¸ºåç¼€\n\n\n## Extended M3U\n\nçœ‹ä¸€ä¸ªä¾‹å­ï¼š\n\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceA.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceB.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceC.ts\n#EXTINF:9.0,\nhttp://example.com/movie1/fileSequenceD.ts\n#EXT-X-ENDLIST\n```\n\nè¯­æ³•ï¼š\n- Tags: begin with '#EXT'\n- Comments: only begin with '#'\n- æ ‡ç­¾åé¢å¯ä»¥æœ‰å‚æ•°ï¼Œä¾‹å¦‚`#EXTINF:10.0`\n- æ ‡ç­¾å†…å®¹å¯ä»¥æ˜¯ï¼š\n    1. an absolute local pathname\n    2. a local pathname relative to the M3U file location; e.g. Heavysets.mp3\n    3. a URL\n\n\nè¡¨æ ¼å‚è€ƒï¼š[https://en.wikipedia.org/wiki/M3U](https://en.wikipedia.org/wiki/M3U)\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656557421391665655741667.png)\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656557911381665655790476.png)\n\n## ä¾‹å­åˆ†æ\n\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceA.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceB.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceC.ts\n#EXTINF:9.0,\nhttp://example.com/movie1/fileSequenceD.ts\n#EXT-X-ENDLIST\n```\n\n**EXTM3U**\n\nè¡¨æ˜æ˜¯`extended M3U`æ–‡ä»¶ï¼Œ åŒºåˆ«äºåŸºæœ¬çš„`M3U`æ–‡ä»¶ã€‚m3u8æ–‡ä»¶å¿…é¡»ä»¥è¯¥æ ‡ç­¾å¼€å§‹ã€‚\n\n\n**EXT-X-PLAYLIST-TYPE**\n\nç±»å‹å¯ä»¥æ˜¯ï¼š\n\n- VODï¼Œ ä»£è¡¨ç‚¹æ’­ï¼Œ ç»“å°¾åŒ…å«`#EXT-X-ENDLIST`\n- EVENTï¼Œ ä»£è¡¨ç›´æ’­, ç»“å°¾ä¸åŒ…å«`#EXT-X-ENDLIST`\n\n**EXT-X-TARGETDURATION**\n\nå•ä¸ªåª’ä½“æ–‡ä»¶çš„æœ€å¤§æ—¶é•¿ã€‚æ¯ä¸€ä¸ª`#EXTINF:10.0`æ ‡ç­¾æŒ‡å®šçš„æ—¶é•¿`<=`EXT-X-TARGETDURATION\n\n**EXT-X-MEDIA-SEQUENCE**\n\n> Indicates the sequence number of the first URL that appears in a playlist file. Each media file URL in a playlist has a unique integer sequence number. The sequence number of a URL is higher by 1 than the sequence number of the URL that preceded it. The media sequence numbers have no relation to the names of the files.\n\nm3u8æ–‡ä»¶ä¸­ç¬¬ä¸€ä¸ªURLæ–‡ä»¶çš„ç¼–å·ï¼Œä¸æ–‡ä»¶åå­—æ— å…³ï¼Œæ¯æ¬¡æ¯”å‰é¢çš„+1ã€‚\n\n**EXT-X-VERSION**\n\n> The EXT-X-VERSION tag indicates the compatibility version of the Playlist file. This file, its associated media, and its server must comply with all provisions of the IETF Internet-Draft of \"HTTP Live Streaming 2nd Edition\" (or earlier specifications) describing the protocol version indicated by the tag value. A Playlist file that doesn't contain an EXT-X-VERSION tag must comply with version 1 of this protocol.\n\nè¡¨æ˜è¯¥m3u8æ–‡ä»¶çš„ç‰ˆæœ¬å…¼å®¹æ€§ã€‚è¯¥m3u8æ–‡ä»¶ï¼Œå…³è”çš„åª’ä½“ï¼ŒæœåŠ¡å™¨å¿…é¡»æœä»äºè¯¥ç‰ˆæœ¬ç‰¹æ€§ã€‚å¦‚æœä¸åŒ…å«è¯¥å­—æ®µï¼Œå¿…é¡»æœä»ä¸ç‰ˆæœ¬1çš„è§„å®šã€‚\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656577590671665657758695.png)\n\nå‚è€ƒï¼š [About the EXT-X-VERSION tag](https://developer.apple.com/documentation/http_live_streaming/about_the_ext-x-version_tag)\n\n\n**EXTINF**\n\n- æè¿°èµ„æºæ–‡ä»¶æ—¶é•¿ï¼ŒURL\n- æ—¶é•¿ï¼š ç‰ˆæœ¬å°äº3æ˜¯intï¼Œ ç‰ˆæœ¬å¤§äºç­‰äº3æ˜¯float, å•ä½ç§’\n\n**EXT-X-ENDLIST**\n\nç»“æŸæ ‡å¿—ï¼Œè¡¨æ˜æ²¡æœ‰æ›´å¤šèµ„æºäº†ã€‚vodæœ‰ï¼Œeventå¯èƒ½æ²¡æœ‰ã€‚\n\n\n### VOD Playlist ç‚¹æ’­\n\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceA.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceB.ts\n#EXTINF:10.0,\nhttp://example.com/movie1/fileSequenceC.ts\n#EXTINF:9.0,\nhttp://example.com/movie1/fileSequenceD.ts\n#EXT-X-ENDLIST\n```\n### live Playlist(Sliding Window) ç›´æ’­æ»‘åŠ¨çª—å£\n\n> In live sessions, the index file is updated by removing media URIs from the file as new media files are created and made available. The EXT-X-ENDLIST tag isn't present in the live playlist, indicating that new media files will be added to the index file as they become available.\n\nç›´æ’­æµï¼Œm3u8æ–‡ä»¶ä¼šæ›´æ–°ï¼Œå‰é¢çš„èµ„æºä¼šè¢«ç§»é™¤ï¼Œåé¢çš„èµ„æºä¼šè¢«è¿½åŠ ã€‚\næ²¡æœ‰`EXT-X-ENDLIST`æ ‡ç­¾ï¼Œè¡¨ç¤ºè¿˜ä¼šæœ‰æ–°çš„èµ„æºè¢«æ·»åŠ ã€‚\n\nçœ‹ä¸€ä¸ªä¾‹å­ï¼Œå¼€å§‹æ—¶æ–‡ä»¶å†…å®¹\n```\n#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:1\n#EXTINF:10.0,\nfileSequence1.ts\n#EXTINF:10.0,\nfileSequence2.ts\n#EXTINF:10.0,\nfileSequence3.ts\n#EXTINF:10.0,\nfileSequence4.ts\n#EXTINF:10.0,\nfileSequence5.ts\n```\n\næ—§èµ„æºè¢«åˆ é™¤ï¼Œæ–°èµ„è¢«æ·»åŠ ï¼Œçœ‹åˆ°`EXT-X-MEDIA-SEQUENCE`ä¹Ÿå‘ç”Ÿäº†å˜åŒ–\n```\n#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:2\n#EXTINF:10.0,\nfileSequence2.ts\n#EXTINF:10.0,\nfileSequence3.ts\n#EXTINF:10.00,\nfileSequence4.ts\n#EXTINF:10.00,\nfileSequence5.ts\n#EXTINF:10.0,\nfileSequence6.ts\n```\n\nå†æ¬¡æ›´æ–°\n```\n#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:4\n#EXTINF:10.00,\nfileSequence4.ts\n#EXTINF:10.00,\nfileSequence5.ts\n#EXTINF:10.0,\nfileSequence6.ts,\n#EXTINF:10.0,\nfileSequence7.ts,\n#EXTINF:10.0,\nfileSequence8.ts,\n#EXTINF:10.0,\nfileSequence9.ts\n```\n\n### Event Playlist\n\n> An event playlist is specified by the EXT-X-PLAYLIST-TYPE tag with a value of EVENT. It doesn't initially have an EXT-X-ENDLIST tag, indicating that new media files will be added to the playlist as they become available.\n\n\n\n\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:EVENT\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.00,\nfileSequence0.ts\n#EXTINF:10.0,\nfileSequence1.ts\n#EXTINF:10.0,\nfileSequence2.ts\n#EXTINF:10.0,\nfileSequence3.ts\n#EXTINF:10.0,\nfileSequence4.ts\n```\n\nè§‚å¯Ÿåˆ°`#EXT-X-PLAYLIST-TYPE:EVENT`\n\n> If the tag is present and has a value of EVENT, the server must not change or delete any part of the playlist file (although it may append lines to it). If the tag is present and has a value of VOD, the playlist file must not change.\n\n> You can't remove anything from the playlist when using the EVENT tag; you may only append new segments to the end of the file. New segments are added to the end of the file until the event has concluded, at which time the EXT-X-ENDLIST tag is appended.\n\nå¦‚æœç±»å‹ä¸ºEVENTï¼Œæ›´æ–°m3u8æ–‡ä»¶ï¼Œåªèƒ½è¿½åŠ ï¼Œä¸èƒ½åˆ é™¤ã€‚\nå¦‚æœç±»å‹ä¸ºVODï¼Œä¸èƒ½æ›´æ”¹m3u8æ’­æ”¾åˆ—è¡¨ã€‚\n\næ›´æ–°å\n```\n#EXTM3U\n#EXT-X-PLAYLIST-TYPE:EVENT\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:4\n#EXT-X-MEDIA-SEQUENCE:0\n#EXTINF:10.0,\nfileSequence0.ts\n#EXTINF:10.0,\nfileSequence1.ts\n#EXTINF:10.0,\nfileSequence2.ts\n#EXTINF:10.0,\nfileSequence3.ts\n#EXTINF:10.0,\nfileSequence4.ts\n\n// List of files between 4 and 120 go here.\n\n#EXTINF:10.0,\nfileSequence120.ts\n#EXTINF:10.0,\nfileSequence121.ts\n#EXT-X-ENDLIST\n```\n\n\n### Creating a Multivariant Playlist\n\n> Offer multiple playlist files to provide different encodings of the same content.\n\nä¸ºåŒä¸€ä»½å†…å®¹ï¼Œæä¾›å¤šä¸ªm3u8ç´¢å¼•ï¼Œæ¯ä¸ªm3u8é‡‡ç”¨ä¸åŒçš„ç¼–ç å‚æ•°ã€‚\n\n\n> The Multivariant Playlist describes all of the available variants for your content. Each variant is a version of the stream at a particular bit rate and is contained in a separate playlist. The client switches to the most appropriate variant based on the measured network bit rate. The clientâ€™s player is tuned to minimize stalling of playback, to give the user the best possible streaming experience.\n\nä¸ºåŒä¸€ä»½å†…å®¹ï¼Œæä¾›å¤šä¸ªç ç‡çš„m3u8,æ–¹ä¾¿å®¢æˆ·ç«¯æ’­æ”¾å™¨é€‰æ‹©é€‚åº”è‡ªèº«ç½‘ç»œçŠ¶å†µçš„æœ€ä½³ç ç‡èµ„æºã€‚\n\nç»“æ„å›¾ï¼š\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656676568981665667656356.png)\n\n\næ–‡ä»¶ç¤ºä¾‹\n\n```\n#EXTM3U\n#EXT-X-STREAM-INF:BANDWIDTH=150000,RESOLUTION=416x234,CODECS=\"avc1.42e00a,mp4a.40.2\"\nhttp://example.com/low/index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=240000,RESOLUTION=416x234,CODECS=\"avc1.42e00a,mp4a.40.2\"\nhttp://example.com/lo_mid/index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=440000,RESOLUTION=416x234,CODECS=\"avc1.42e00a,mp4a.40.2\"\nhttp://example.com/hi_mid/index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=640000,RESOLUTION=640x360,CODECS=\"avc1.42e00a,mp4a.40.2\"\nhttp://example.com/high/index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=64000,CODECS=\"mp4a.40.5\"\nhttp://example.com/audio/index.m3u8\n```\n\n**EXT-X-STREAM-INF**\nIndicates that the next URL in the playlist file identifies another playlist file.\n\nè¡¨æ˜å®ƒçš„URLå†…å®¹æ˜¯ä¸€ä¸ªm3u8æ–‡ä»¶ã€‚\n\nThe EXT-X-STREAM-INF tag has the following parameters:\n\n**AVERAGE-BANDWIDTH**\n\n(Optional, but recommended) An integer that represents the average bit rate for the variant stream.\n\nå¹³å‡ç ç‡ï¼Œå¯é€‰ã€‚\n\n\n**BANDWIDTH**\n\n(Required) An integer that is the upper bound of the overall bit rate for each media file, in bits per second. The upper bound value is calculated to include any container overhead that appears or will appear in the playlist.\n\nå¸¦å®½ã€‚\n\n**FRAME-RATE**\n\n(Optional, but recommended) A floating-point value that describes the maximum frame rate in a variant stream.\n\nå¸§ç‡ï¼Œå¯é€‰ï¼Œ è¡¨ç¤ºè¯¥æµçš„æœ€å¤§å¸§ç‡ã€‚\n\n**HDCP-LEVEL**\n\n(Optional) Indicates the type of encryption used. Valid values are TYPE-0 and NONE. Use TYPE-0 if the stream may not play unless the output is protected by HDCP.\n\nåŠ å¯†æ–¹å¼ï¼Œå¯é€‰ã€‚\n\n**RESOLUTION**\n\n(Optional, but recommended) The optional display size, in pixels, at which to display the video in the playlist. This parameter should be included for any stream that includes video.\n\nè§†é¢‘åˆ†è¾¨ç‡ã€‚\n\n\n**VIDEO-RANGE**\n\n(Required depending on encoding) A string with valid values of SDR or PQ. If transfer characteristic codes 1, 16, or 18 arenâ€™t specified, then this parameter must be omitted.\n\n**CODECS**\n\n(Optional, but recommended) A quoted string containing a comma-separated list of formats, where each format specifies a media sample type thatâ€™s present in a media segment in the playlist file. Valid format identifiers are those in the ISO file format name space defined by RFC 6381.\n\nç¼–ç å™¨ç›¸å…³å‚æ•°ã€‚\n\n### Adding Alternate Media to a Playlist\n\n> Specify Rendition Playlists that can override the main presentation.\n\n> Adding alternate media to a Multivariant Playlist allows a provider to specify one of a set of variant playlists as an override of the main presentation. The client plays only the override media (audio or video), and suppresses any media of the same type from the main presentation, if present. This allows a presentation to offer multiple versions of the media without requiring the provider to store duplicate media, or requiring the client to download all variants when it only needs one. It also allows additional media to be offered subsequently without remastering the original content.\n\nåœ¨ä¸»éŸ³é¢‘è§†é¢‘èµ„æºå¤–ï¼Œæä¾›å¤šè·¯å¤‡é€‰èµ„æºã€‚\né€‰æ‹©å¤‡é€‰çš„éŸ³è§†é¢‘ï¼Œå®¢æˆ·ç«¯åªä¼šæ’­æ”¾å¤‡é€‰éŸ³è§†é¢‘èµ„æºã€‚\n\n\nä¸‹é¢çš„ä¾‹å­ï¼Œæä¾›å¤‡é€‰çš„å¤šè¯­è¨€éŸ³é¢‘æ’­æ”¾åˆ—è¡¨\n\n```\n#EXTM3U\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio\",LANGUAGE=\"eng\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"eng/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio\",LANGUAGE=\"fre\",NAME=\"FranÃ§ais\",AUTOSELECT=YES, DEFAULT=NO,URI=\"fre/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio\",LANGUAGE=\"sp\",NAME=\"Espanol\",AUTOSELECT=YES, DEFAULT=NO,URI=\"sp/prog_index.m3u8\"\n\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=195023,CODECS=\"avc1.42e00a,mp4a.40.2\",AUDIO=\"audio\"\nlo/prog_index.m3u8\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=591680,CODECS=\"avc1.42e01e,mp4a.40.2\",AUDIO=\"audio\"\nhi/prog_index.m3u8\n```\n\nThe tags used in this Multivariant Playlist example include:\n\n**EXT-X-MEDIA**\nIdentifies an element of a media selection group. All the elements of a media selection group must have similar characteristics, for example, the same codecs and the same maximum bandwidth.\n\nè¡¨ç¤ºåª’ä½“é€‰é¡¹åˆ†ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼ŒåŒä¸€ä¸ªåˆ†ç»„ä¸­çš„åª’ä½“å…·æœ‰ç›¸åŒçš„ç‰¹å¾ï¼Œå¦‚ç›¸åŒçš„ç¼–è§£ç æˆ–å¸¦å®½ã€‚\n\nEXT-X-STREAM-INF\nindicates that the next URL in the Multivariant Playlist identifies a Rendition Playlist. See Creating a Multivariant Playlist for the basic parameters.\n\nè¡¨æ˜å®ƒçš„å†…å®¹æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œ æŒ‡å‘ä¸€ä¸ªm3u8æ–‡ä»¶\n\nThe EXT-X-MEDIA tag has the following parameters:\n\nTYPE\n(Required) A string indicating the type of media. Valid values are AUDIO, VIDEO, SUBTITLES, and CLOSED-CAPTIONS.\n\nåª’ä½“ç±»å‹\n- AUDIO\n- VIDEO\n- SUBTITLES\n- CLOSED-CAPTIONS\n\n\nGROUP-ID\n(Required) A string specifying the group that the media selection belongs to.\n\nåˆ†ç»„æ ‡è¯†ï¼Œå­—ç¬¦ä¸²ï¼Œå¿…é¡»æœ‰ã€‚\n\nLANGUAGE\n(Optional) A string that identifies the primary language used in the media selection.\n\nè¯¥é€‰é¡¹ä¸­åª’ä½“æ–‡ä»¶å¯¹åº”çš„è¯­è¨€ï¼Œå¯é€‰ã€‚\n\nNAME\n(Required) A string that describes the primary language used in the media selection.\n\nè¯¥é€‰é¡¹ä¸­åª’ä½“æ–‡ä»¶å¯¹åº”çš„è¯­è¨€çš„å­—ç¬¦ä¸²æ ‡è¯†ï¼Œå¿…é¡»ã€‚\n\nAUTOSELECT\n(Optional) A string that indicates that the client may play the media selection in the absence of explicit user preference. Valid values are YES and NO. If the value of DEFAULT is YES, this value must also be YES.\n\næ˜¯å¦è‡ªåŠ¨é€‰æ‹©ï¼Œå¯é€‰ã€‚åœ¨ç”¨æˆ·åå¥½ç¼ºçœçš„æ—¶å€™ï¼ŒæŒ‡ç¤ºå®¢æˆ·ç«¯æ˜¯å¦åº”è¯¥è‡ªåŠ¨é€‰æ‹©è¯¥é€‰é¡¹ã€‚åˆæ³•çš„å€¼æ˜¯YESå’ŒNOï¼Œ\nå¦‚æœ`DEFAULT`æ˜¯YESï¼Œ è¯¥å­—æ®µçš„å€¼å¿…é¡»ä¹Ÿæ˜¯YES.\n\nDEFAULT\n(Optional) A string indicating that the media selection should be played if the user hasnâ€™t selected another option. Valid values are YES and NO.\n\næ˜¯å¦é»˜è®¤æ’­æ”¾è¯¥é€‰é¡¹ï¼Œå¯é€‰ã€‚ç”¨æˆ·æ²¡æœ‰é€‰æ‹©å…¶ä»–é€‰é¡¹çš„æ—¶å€™ï¼Œæ˜¯å¦é»˜è®¤æ’­æ”¾è¯¥é€‰é¡¹ã€‚\n\nINSTREAM-ID\n(Required for closed captions) A string that specifies a rendition within the segments in the media playlist. When the TYPE attribute is CLOSED-CAPTIONS, the INSTREAM-ID must have one of the following values: CC1, CC3, CC3, CC4, or SERVICEn, where n is between 1 and 63.\n\n\nASSOC-LANGUAGE\n(Optional) A string containing a language tag for the rendition. An associated language is often different from the language specified in the LANGUAGE attribute.\n\nå…³è”çš„è¯­è¨€ï¼Œå¯é€‰ã€‚\n\nCHANNELS\n(Required when two renditions have the same codec but a different number of channels) An ordered string that indicates the maximum number of independent, simultaneous audio channels present in a media segment.\n\nè¡¨æ˜è¯¥éŸ³é¢‘æ–‡ä»¶æœ‰å‡ ä¸ªå£°é“\n\nURI\n(Optional) A string containing a URI that identifies the media playlist file. If the TYPE is CLOSED-CAPTIONS, this attribute must be omitted. When this attribute is omitted, the media content is in the original variant.\n\nåª’ä½“æ–‡ä»¶åœ°å€ï¼Œå¯é€‰ã€‚\n\nWhen its URI attribute is omitted, the EXT-X-MEDIA tag can indicate that the media described is included in the URI of the EXT-X-STREAM-INF tag.\n\nå¦‚æœURIå­—æ®µä¸å­˜åœ¨ï¼Œ`EXT-X-MEDIA`æè¿°çš„çš„åª’ä½“æ–‡ä»¶å­˜åœ¨äº`EXT-X-STREAM-INF`æ ‡ç­¾ä¸­ã€‚\n\nThe EXT-X-STREAM-INF tag has the following parameters:\n\nAUDIO\n(Optional) A quoted string that indicates the set of audio streams that may be used when playing the presentation. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is AUDIO.\n\n\nVIDEO\n(Optional) A quoted string that indicates the set of video streams that may be used when playing the presentation. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is VIDEO.\n\nSUBTITLES\n(Optional) A quoted string that indicates the set of subtitle renditions that can be used. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is SUBTITLE.\n\nCLOSED-CAPTIONS\n(Optional) Either a quoted string that indicates the set of closed captions that can be used or an enumerated string with the value of NONE. When this value is a quoted string, it must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is CLOSED-CAPTIONS. If the enumerated value is NONE, all EXT-X-STREAM-INF tags must have this attribute with a value of NONE.\n\n\næ€»ç»“ä¸€ä¸‹ï¼š\n\né€šè¿‡`EXT-X-MEDIA`å¯ä»¥å®šä¹‰èµ„æºç»„ï¼Œå¯ä»¥æœ‰å¤šä¸ªç»„ï¼Œç”¨GROUP-IDæ¥åŒºåˆ†ï¼Œ æœ‰å››ç§ç»„ç±»å‹\n- AUDIO\n- VIDEO\n- SUBTITLES\n- CLOSED-CAPTIONS\n\næ¯ä¸ªåˆ†ç»„ä¸­æµå±æ€§æ˜¯ç›¸åŒï¼Œå…¶å‚æ•°å¯ä»¥é€šè¿‡å…³è”çš„`EXT-X-STREAM-INF`æŒ‡å®š\né€šè¿‡`EXT-X-STREAM-INF`å®šä¹‰èµ„æºç»„çš„æµå‚æ•°ï¼Œå¸¦å®½ï¼Œç¼–è§£ç å™¨ä¿¡æ¯ã€‚ å®ƒå…³è”ä¸€ä¸ªç»„IDï¼Œè¿™ä¸ªç»„å†…çš„æ‰€æœ‰å¤‡é€‰åª’ä½“éƒ½å…·æœ‰ç›¸åŒçš„æ€§è´¨ã€‚\n\n\nYou can have multiple audio groups to allow changes in codes or bit rate. However, each audio group in a variant must have the same alternates in it. For example, you canâ€™t have English in one audio group and leave it out of the other group. The following example defines two audio groups, one for low bit rates and one for high bit rates. Both audio groups define the same set of languages but are called based on the available bandwidth.\n\næ¯ä¸ªç»„å¯ä»¥æä¾›å¤šä¸ªç ç‡çš„åª’ä½“æ–‡ä»¶ï¼Œå…¶ç ç‡å¯ä»¥é€šè¿‡`EXT-X-STREAM-INF`æŒ‡å®šï¼Œè™½ç„¶`GROUP-ID`ç›¸åŒï¼Œä½†æ˜¯ç ç‡æ˜¯ä¸åŒçš„ã€‚\n\n```\n#EXTM3U\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-lo\",LANGUAGE=\"eng\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"englo/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-lo\",LANGUAGE=\"fre\",NAME=\"FranÃ§ais\",AUTOSELECT=YES, DEFAULT=NO,URI=\"frelo/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-lo\",LANGUAGE=\"es\",NAME=\"Espanol\",AUTOSELECT=YES, DEFAULT=NO,URI=\"splo/prog_index.m3u8\"\n \n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-hi\",LANGUAGE=\"eng\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"eng/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-hi\",LANGUAGE=\"fre\",NAME=\"FranÃ§ais\",AUTOSELECT=YES, DEFAULT=NO,URI=\"fre/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"audio-hi\",LANGUAGE=\"es\",NAME=\"Espanol\",AUTOSELECT=YES, DEFAULT=NO,URI=\"sp/prog_index.m3u8\"\n \n#EXT-X-STREAM-INF:BANDWIDTH=195023,CODECS=\"mp4a.40.5\", AUDIO=\"audio-lo\"\nlo/prog_index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=260000,CODECS=\"avc1.42e01e,mp4a.40.2\", AUDIO=\"audio-lo\"\nhi/prog_index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=591680,CODECS=\"mp4a.40.2, avc1.64001e\", AUDIO=\"audio-hi\"\nlo/prog_index.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=650000,CODECS=\"avc1.42e01e,mp4a.40.2\", AUDIO=\"audio-hi\"\nhi/prog_index.m3u8\n\n```\n\nYou can have both a group and a single stream in a playlist. This is often done when you have multiple camera angles that all use the same audio. Create a group for the video streams and then declare the single audio stream. The following example shows a playlist with three camera angles and a single audio stream:\n\nä¸€ä¸ªè§†é¢‘ç»„å…³è”å•ä¸ªéŸ³é¢‘çš„æƒ…å†µã€‚\n\n```\n#EXTM3U\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle1\",AUTOSELECT=YES,DEFAULT=YES\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle2\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle2/500kbs/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle3\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle3/500kbs/prog_index.m3u8\"\n\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"aac\",LANGUAGE=\"en\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"eng/prog_index.m3u8\"\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=754857,CODECS=\"mp4a.40.2,avc1.4d401e\", VIDEO=\"500kbs\",AUDIO=\"aac\"\nAngle1/500kbs/prog_index.m3u8\n```\n\nTo provide different streams for different bit rates, a different video group ID is needed for each bit rate.\n\n```\n#EXTM3U\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"200kbs\",NAME=\"Angle1\",AUTOSELECT=YES,DEFAULT=YES\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"200kbs\",NAME=\"Angle2\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle2/200kbs/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"200kbs\",NAME=\"Angle3\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle3/200kbs/prog_index.m3u8\"\n\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle1\",AUTOSELECT=YES,DEFAULT=YES\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle2\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle2/500kbs/prog_index.m3u8\"\n#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID=\"500kbs\",NAME=\"Angle3\",AUTOSELECT=YES,DEFAULT=NO, URI=\"Angle3/500kbs/prog_index.m3u8\"\n\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"aac\",LANGUAGE=\"en\",NAME=\"English\",AUTOSELECT=YES, DEFAULT=YES,URI=\"eng/prog_index.m3u8\"\n\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=300000,CODECS=\"mp4a.40.2,avc1.4d401e\", VIDEO=\"200kbs\",AUDIO=\"aac\"\nAngle1/200kbs/prog_index.m3u\n\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=754857,CODECS=\"mp4a.40.2,avc1.4d401e\", VIDEO=\"500kbs\",AUDIO=\"aac\"\nAngle1/500kbs/prog_index.m3u8\n```\n\nå‚è€ƒï¼š\nhttps://developer.apple.com/documentation/http_live_streaming\nhttps://aleen42.gitbooks.io/wiki/content/summary/m3u8/m3u8.html","slug":"hls/2022-10-13-HLS-ä»‹ç»","published":1,"updated":"2024-03-06T11:53:13.567Z","comments":1,"photos":[],"_id":"clti3glko001h57wh2ayt3hwf","content":"<h1 id=\"HLS-æ˜¯ä»€ä¹ˆ\"><a href=\"#HLS-æ˜¯ä»€ä¹ˆ\" class=\"headerlink\" title=\"HLS æ˜¯ä»€ä¹ˆ\"></a>HLS æ˜¯ä»€ä¹ˆ</h1><p>ç»´åŸºç™¾ç§‘çš„ä»‹ç»ï¼š</p>\n<p>HTTP Live Streamingï¼Œç¼©å†™ä¸ºHLSï¼Œæ˜¯ç”±è‹¹æœå…¬å¸æå‡ºåŸºäºHTTPçš„æµåª’ä½“ç½‘ç»œä¼ è¾“åè®®ã€‚æ˜¯è‹¹æœå…¬å¸QuickTime Xå’ŒiPhoneè½¯ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯æŠŠæ•´ä¸ªæµåˆ†æˆä¸€ä¸ªä¸ªå°çš„åŸºäºHTTPçš„æ–‡ä»¶æ¥ä¸‹è½½ï¼Œæ¯æ¬¡åªä¸‹è½½ä¸€äº›ã€‚å½“åª’ä½“æµæ­£åœ¨æ’­æ”¾æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä»è®¸å¤šä¸åŒçš„å¤‡ç”¨æºä¸­ä»¥ä¸åŒçš„é€Ÿç‡ä¸‹è½½åŒæ ·çš„èµ„æºï¼Œå…è®¸æµåª’ä½“ä¼šè¯é€‚åº”ä¸åŒçš„æ•°æ®é€Ÿç‡ã€‚åœ¨å¼€å§‹ä¸€ä¸ªæµåª’ä½“ä¼šè¯æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šä¸‹è½½ä¸€ä¸ªåŒ…å«å…ƒæ•°æ®çš„æ‰©å…… M3U (m3u8) æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ï¼Œç”¨äºå¯»æ‰¾å¯ç”¨çš„åª’ä½“æµã€‚</p>\n<p>HLSåªè¯·æ±‚åŸºæœ¬çš„HTTPæŠ¥æ–‡ï¼Œä¸å®æ—¶ä¼ è¾“åè®®ï¼ˆRTPï¼‰ä¸åŒï¼ŒHLSå¯ä»¥ç©¿è¿‡ä»»ä½•å…è®¸HTTPæ•°æ®é€šè¿‡çš„é˜²ç«å¢™æˆ–è€…ä»£ç†æœåŠ¡å™¨ã€‚å®ƒä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨å†…å®¹åˆ†å‘ç½‘ç»œæ¥ä¼ è¾“åª’ä½“æµã€‚</p>\n<p>è‹¹æœå…¬å¸æŠŠHLSåè®®ä½œä¸ºä¸€ä¸ªäº’è”ç½‘è‰æ¡ˆï¼ˆé€æ­¥æäº¤ï¼‰ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µä¸­å·²ä½œä¸ºä¸€ä¸ªéæ­£å¼çš„æ ‡å‡†æäº¤åˆ°IETFã€‚2017å¹´8æœˆï¼ŒRFC 8216å‘å¸ƒï¼Œæè¿°äº†HLSåè®®ç¬¬7ç‰ˆçš„å®šä¹‰ã€‚</p>\n<p>è‹¹æœè‡ªå·±çš„ä»‹ç»ï¼š</p>\n<blockquote>\n<p>Send live and onâ€demand audio and video to iPhone, iPad, Mac, Apple Watch, Apple TV, and PC with HTTP Live Streaming (HLS) technology from Apple. Using the same protocol that powers the web, HLS lets you deploy content using ordinary web servers and content delivery networks. HLS is designed for reliability and dynamically adapts to network conditions by optimizing playback for the available speed of wired and wireless connections.</p>\n</blockquote>\n<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>\n<ol>\n<li>åŸºäºHTTPçš„æµåª’ä½“ç½‘ç»œä¼ è¾“åè®®ï¼Œæ”¯æŒå®‰å…¨é€šä¿¡ï¼ˆé€šè¿‡https, åª’ä½“æ•°æ®åŠ å¯†ç­‰ï¼‰</li>\n<li>å·¥ä½œåŸç†æ˜¯æŠŠæ•´ä¸ªæµåˆ†æˆä¸€ä¸ªä¸ªå°çš„åŸºäºHTTPçš„æ–‡ä»¶æ¥ä¸‹è½½, ä½¿ç”¨m3u8æè¿°æ’­æ”¾åˆ—è¡¨ã€‚</li>\n<li>æ”¯æŒç›´æ’­å’Œç‚¹æ’­ï¼ˆVODï¼Œ video on demandï¼‰</li>\n<li>å½“åª’ä½“æµæ­£åœ¨æ’­æ”¾æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä»è®¸å¤šä¸åŒçš„å¤‡ç”¨æºä¸­ä»¥ä¸åŒçš„é€Ÿç‡ä¸‹è½½åŒæ ·çš„èµ„æºï¼Œå…è®¸æµåª’ä½“ä¼šè¯é€‚åº”ä¸åŒçš„æ•°æ®é€Ÿç‡</li>\n</ol>\n<h2 id=\"HLS-æµåª’ä½“æ¶æ„\"><a href=\"#HLS-æµåª’ä½“æ¶æ„\" class=\"headerlink\" title=\"HLS æµåª’ä½“æ¶æ„\"></a>HLS æµåª’ä½“æ¶æ„</h2><blockquote>\n<p>Conceptually, HTTP Live Streaming consists of three parts: the server component, the distribution component, and the client software.</p>\n<p>In a typical configuration, a hardware encoder takes audio-video input, encodes it as HEVC video and AC-3 audio, and outputs a fragmented MPEG-4 file or an MPEG-2 transport stream. A software stream segmenter then breaks the stream into a series of short media files, which are placed on a web server. The segmenter also creates and maintains an index file containing a list of the media files. The URL of the index file is published on the web server. Client software reads the index, then requests the listed media files in order and displays them without any pauses or gaps between segments.</p>\n</blockquote>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656504345291665650434432.png\"></p>\n<p>æ¦‚å¿µä¸Šï¼ŒHLS åŒ…å«</p>\n<ul>\n<li>æœåŠ¡ç«¯ç»„ä»¶</li>\n<li>åˆ†å‘ç»„ä»¶</li>\n<li>å®¢æˆ·ç«¯è½¯ä»¶</li>\n</ul>\n<p>æ­¥éª¤ï¼š</p>\n<ol>\n<li>æœåŠ¡ç«¯ç¡¬ä»¶ç¼–ç å™¨ï¼Œå°†éŸ³è§†é¢‘è¾“å…¥ç¼–ç (è§†é¢‘ç¼–ç æˆHEVCï¼ŒH264, éŸ³é¢‘ç¼–ç æˆAACï¼ŒAC-3)ï¼Œ è¾“å‡ºtsæµï¼ˆä¹Ÿå¯ä»¥ç”Ÿæˆåˆ†æ®µçš„mp4æ–‡ä»¶ï¼Œ å¾ˆå°‘ç”¨ï¼‰</li>\n<li>åˆ†æ®µè½¯ä»¶ä¼šå°†tsæµåˆ†å‰²ï¼Œæ‰“åŒ…æˆtsæ–‡ä»¶ï¼ŒåŒæ—¶ç”Ÿæˆç´¢å¼•æ–‡ä»¶ï¼ˆm3u8ï¼‰,ç´¢å¼•æ–‡ä»¶ä¿å­˜äº†åª’ä½“æ–‡ä»¶çš„ä¿¡æ¯ã€‚</li>\n<li>å®¢æˆ·ç«¯è¯»å–m3u8ç´¢å¼•æ–‡ä»¶ï¼Œä¸‹è½½å¯¹åº”çš„tsæ–‡ä»¶ï¼Œå°†å†…å®¹æ’­æ”¾ç»™ç”¨æˆ·</li>\n</ol>\n<p>è‹¹æœæä¾›äº†ä¸€å¥—ç”¨äºHLSçš„å·¥å…·é›†ï¼Œå‚è€ƒï¼š</p>\n<p><a href=\"https://developer.apple.com/documentation/http_live_streaming/using_apple_s_http_live_streaming_hls_tools\">Using Appleâ€™s HTTP Live Streaming (HLS) Tools</a></p>\n<ul>\n<li>Media File Segmenter (mediafilesegmenter), åª’ä½“æ–‡ä»¶åˆ†å‰²å™¨</li>\n<li>Media Subtitle Segmenter (mediasubtitlesegmenter)ï¼Œ å­—å¹•åˆ†å‰²å™¨</li>\n<li>Media Stream Segmenter (mediastreamsegmenter) åª’ä½“æµåˆ†å‰²å™¨</li>\n<li>Variant Playlist Creator (variantplaylistcreator) å¯å˜æ’­æ”¾åˆ—è¡¨ç”Ÿæˆå™¨</li>\n<li>â€¦</li>\n</ul>\n<h1 id=\"M3U8\"><a href=\"#M3U8\" class=\"headerlink\" title=\"M3U8\"></a>M3U8</h1><blockquote>\n<p>The Unicode version of M3U is M3U8, which uses UTF-8-encoded characters. M3U8 files are the basis for the HTTP Live Streaming (HLS) format originally developed by Apple to stream video and radio to iOS devices, and which is now a popular format for adaptive streaming in general.</p>\n</blockquote>\n<blockquote>\n<p>M3U (MP3 URL or Moving Picture Experts Group Audio Layer 3 Uniform Resource Locator in full) is a computer file format for a multimedia playlist. One common use of the M3U file format is creating a single-entry playlist file pointing to a stream on the Internet.</p>\n</blockquote>\n<blockquote>\n<p>Although originally designed for audio files, such as MP3, it is commonly used to point media players to audio and video sources, including online sources.</p>\n</blockquote>\n<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>\n<ol>\n<li>M3U8 æ˜¯M3Uçš„Unicodeç‰ˆæœ¬ï¼Œä½¿ç”¨ UTF-8 ç¼–ç ï¼Œ æ˜¯ HLS çš„åŸºç¡€</li>\n<li>M3U æœ€åˆæ˜¯ä¸ºéŸ³é¢‘æ–‡ä»¶è®¾è®¡çš„ï¼Œä¾‹å¦‚MP3ï¼Œ ç°åœ¨ä¸å†å±€é™äºéŸ³é¢‘æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥ç´¢å¼•éŸ³é¢‘å’Œè§†é¢‘èµ„æºï¼Œç½‘ç»œèµ„æº</li>\n<li>ä¸‹é¢åˆ†æM3U æ–‡ä»¶æ ¼å¼</li>\n</ol>\n<p><strong>M3U</strong></p>\n<blockquote>\n<p>An M3U file is a plain text file that specifies the locations of one or more media files. The file is saved with the â€œm3uâ€ filename extension if the text is encoded in the local systemâ€™s default non-Unicode encoding (e.g., a Windows codepage), or with the â€œm3u8â€ extension if the text is UTF-8 encoded.</p>\n</blockquote>\n<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>\n<ol>\n<li>M3U æ–‡ä»¶æ˜¯çº¯æ–‡æœ¬æ–‡ä»¶ï¼ŒæŒ‡å®šäº†èµ„æºæ–‡ä»¶çš„ä½ç½®</li>\n<li>ä»¥<code>.m3u</code>ä¸ºæ–‡ä»¶åç¼€</li>\n<li>ä½¿ç”¨ UTF-8 ç¼–ç çš„ç‰ˆæœ¬ï¼Œä»¥ <code>.m3u8</code>ä¸ºåç¼€</li>\n</ol>\n<h2 id=\"Extended-M3U\"><a href=\"#Extended-M3U\" class=\"headerlink\" title=\"Extended M3U\"></a>Extended M3U</h2><p>çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#EXTM3U</span><br><span class=\"hljs-comment\">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class=\"hljs-comment\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-comment\">#EXT-X-VERSION:4</span><br><span class=\"hljs-comment\">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceA.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceB.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceC.ts<br><span class=\"hljs-comment\">#EXTINF:9.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceD.ts<br><span class=\"hljs-comment\">#EXT-X-ENDLIST</span><br></code></pre></td></tr></table></figure>\n\n<p>è¯­æ³•ï¼š</p>\n<ul>\n<li>Tags: begin with â€˜#EXTâ€™</li>\n<li>Comments: only begin with â€˜#â€™</li>\n<li>æ ‡ç­¾åé¢å¯ä»¥æœ‰å‚æ•°ï¼Œä¾‹å¦‚<code>#EXTINF:10.0</code></li>\n<li>æ ‡ç­¾å†…å®¹å¯ä»¥æ˜¯ï¼š<ol>\n<li>an absolute local pathname</li>\n<li>a local pathname relative to the M3U file location; e.g. Heavysets.mp3</li>\n<li>a URL</li>\n</ol>\n</li>\n</ul>\n<p>è¡¨æ ¼å‚è€ƒï¼š<a href=\"https://en.wikipedia.org/wiki/M3U\">https://en.wikipedia.org/wiki/M3U</a></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656557421391665655741667.png\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656557911381665655790476.png\"></p>\n<h2 id=\"ä¾‹å­åˆ†æ\"><a href=\"#ä¾‹å­åˆ†æ\" class=\"headerlink\" title=\"ä¾‹å­åˆ†æ\"></a>ä¾‹å­åˆ†æ</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#EXTM3U</span><br><span class=\"hljs-comment\">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class=\"hljs-comment\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-comment\">#EXT-X-VERSION:4</span><br><span class=\"hljs-comment\">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceA.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceB.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceC.ts<br><span class=\"hljs-comment\">#EXTINF:9.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceD.ts<br><span class=\"hljs-comment\">#EXT-X-ENDLIST</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>EXTM3U</strong></p>\n<p>è¡¨æ˜æ˜¯<code>extended M3U</code>æ–‡ä»¶ï¼Œ åŒºåˆ«äºåŸºæœ¬çš„<code>M3U</code>æ–‡ä»¶ã€‚m3u8æ–‡ä»¶å¿…é¡»ä»¥è¯¥æ ‡ç­¾å¼€å§‹ã€‚</p>\n<p><strong>EXT-X-PLAYLIST-TYPE</strong></p>\n<p>ç±»å‹å¯ä»¥æ˜¯ï¼š</p>\n<ul>\n<li>VODï¼Œ ä»£è¡¨ç‚¹æ’­ï¼Œ ç»“å°¾åŒ…å«<code>#EXT-X-ENDLIST</code></li>\n<li>EVENTï¼Œ ä»£è¡¨ç›´æ’­, ç»“å°¾ä¸åŒ…å«<code>#EXT-X-ENDLIST</code></li>\n</ul>\n<p><strong>EXT-X-TARGETDURATION</strong></p>\n<p>å•ä¸ªåª’ä½“æ–‡ä»¶çš„æœ€å¤§æ—¶é•¿ã€‚æ¯ä¸€ä¸ª<code>#EXTINF:10.0</code>æ ‡ç­¾æŒ‡å®šçš„æ—¶é•¿<code>&lt;=</code>EXT-X-TARGETDURATION</p>\n<p><strong>EXT-X-MEDIA-SEQUENCE</strong></p>\n<blockquote>\n<p>Indicates the sequence number of the first URL that appears in a playlist file. Each media file URL in a playlist has a unique integer sequence number. The sequence number of a URL is higher by 1 than the sequence number of the URL that preceded it. The media sequence numbers have no relation to the names of the files.</p>\n</blockquote>\n<p>m3u8æ–‡ä»¶ä¸­ç¬¬ä¸€ä¸ªURLæ–‡ä»¶çš„ç¼–å·ï¼Œä¸æ–‡ä»¶åå­—æ— å…³ï¼Œæ¯æ¬¡æ¯”å‰é¢çš„+1ã€‚</p>\n<p><strong>EXT-X-VERSION</strong></p>\n<blockquote>\n<p>The EXT-X-VERSION tag indicates the compatibility version of the Playlist file. This file, its associated media, and its server must comply with all provisions of the IETF Internet-Draft of â€œHTTP Live Streaming 2nd Editionâ€ (or earlier specifications) describing the protocol version indicated by the tag value. A Playlist file that doesnâ€™t contain an EXT-X-VERSION tag must comply with version 1 of this protocol.</p>\n</blockquote>\n<p>è¡¨æ˜è¯¥m3u8æ–‡ä»¶çš„ç‰ˆæœ¬å…¼å®¹æ€§ã€‚è¯¥m3u8æ–‡ä»¶ï¼Œå…³è”çš„åª’ä½“ï¼ŒæœåŠ¡å™¨å¿…é¡»æœä»äºè¯¥ç‰ˆæœ¬ç‰¹æ€§ã€‚å¦‚æœä¸åŒ…å«è¯¥å­—æ®µï¼Œå¿…é¡»æœä»ä¸ç‰ˆæœ¬1çš„è§„å®šã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656577590671665657758695.png\"></p>\n<p>å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/http_live_streaming/about_the_ext-x-version_tag\">About the EXT-X-VERSION tag</a></p>\n<p><strong>EXTINF</strong></p>\n<ul>\n<li>æè¿°èµ„æºæ–‡ä»¶æ—¶é•¿ï¼ŒURL</li>\n<li>æ—¶é•¿ï¼š ç‰ˆæœ¬å°äº3æ˜¯intï¼Œ ç‰ˆæœ¬å¤§äºç­‰äº3æ˜¯float, å•ä½ç§’</li>\n</ul>\n<p><strong>EXT-X-ENDLIST</strong></p>\n<p>ç»“æŸæ ‡å¿—ï¼Œè¡¨æ˜æ²¡æœ‰æ›´å¤šèµ„æºäº†ã€‚vodæœ‰ï¼Œeventå¯èƒ½æ²¡æœ‰ã€‚</p>\n<h3 id=\"VOD-Playlist-ç‚¹æ’­\"><a href=\"#VOD-Playlist-ç‚¹æ’­\" class=\"headerlink\" title=\"VOD Playlist ç‚¹æ’­\"></a>VOD Playlist ç‚¹æ’­</h3><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#EXTM3U</span><br><span class=\"hljs-comment\">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class=\"hljs-comment\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-comment\">#EXT-X-VERSION:4</span><br><span class=\"hljs-comment\">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceA.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceB.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceC.ts<br><span class=\"hljs-comment\">#EXTINF:9.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceD.ts<br><span class=\"hljs-comment\">#EXT-X-ENDLIST</span><br></code></pre></td></tr></table></figure>\n<h3 id=\"live-Playlist-Sliding-Window-ç›´æ’­æ»‘åŠ¨çª—å£\"><a href=\"#live-Playlist-Sliding-Window-ç›´æ’­æ»‘åŠ¨çª—å£\" class=\"headerlink\" title=\"live Playlist(Sliding Window) ç›´æ’­æ»‘åŠ¨çª—å£\"></a>live Playlist(Sliding Window) ç›´æ’­æ»‘åŠ¨çª—å£</h3><blockquote>\n<p>In live sessions, the index file is updated by removing media URIs from the file as new media files are created and made available. The EXT-X-ENDLIST tag isnâ€™t present in the live playlist, indicating that new media files will be added to the index file as they become available.</p>\n</blockquote>\n<p>ç›´æ’­æµï¼Œm3u8æ–‡ä»¶ä¼šæ›´æ–°ï¼Œå‰é¢çš„èµ„æºä¼šè¢«ç§»é™¤ï¼Œåé¢çš„èµ„æºä¼šè¢«è¿½åŠ ã€‚<br>æ²¡æœ‰<code>EXT-X-ENDLIST</code>æ ‡ç­¾ï¼Œè¡¨ç¤ºè¿˜ä¼šæœ‰æ–°çš„èµ„æºè¢«æ·»åŠ ã€‚</p>\n<p>çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå¼€å§‹æ—¶æ–‡ä»¶å†…å®¹</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\"><span class=\"hljs-attr\">#EXTM3</span>U<br><span class=\"hljs-attr\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-attr\">#EXT-X-VERSION:4</span><br><span class=\"hljs-attr\">#EXT-X-MEDIA-SEQUENCE:1</span><br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce1</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce2</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce3</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce4</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce5</span>.ts<br></code></pre></td></tr></table></figure>\n\n<p>æ—§èµ„æºè¢«åˆ é™¤ï¼Œæ–°èµ„è¢«æ·»åŠ ï¼Œçœ‹åˆ°<code>EXT-X-MEDIA-SEQUENCE</code>ä¹Ÿå‘ç”Ÿäº†å˜åŒ–</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\"><span class=\"hljs-attr\">#EXTM3</span>U<br><span class=\"hljs-attr\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-attr\">#EXT-X-VERSION:4</span><br><span class=\"hljs-attr\">#EXT-X-MEDIA-SEQUENCE:2</span><br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce2</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce3</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce4</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce5</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce6</span>.ts<br></code></pre></td></tr></table></figure>\n\n<p>å†æ¬¡æ›´æ–°</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\"><span class=\"hljs-attr\">#EXTM3</span>U<br><span class=\"hljs-attr\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-attr\">#EXT-X-VERSION:4</span><br><span class=\"hljs-attr\">#EXT-X-MEDIA-SEQUENCE:4</span><br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce4</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce5</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce6</span>.ts,<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce7</span>.ts,<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce8</span>.ts,<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce9</span>.ts<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Event-Playlist\"><a href=\"#Event-Playlist\" class=\"headerlink\" title=\"Event Playlist\"></a>Event Playlist</h3><blockquote>\n<p>An event playlist is specified by the EXT-X-PLAYLIST-TYPE tag with a value of EVENT. It doesnâ€™t initially have an EXT-X-ENDLIST tag, indicating that new media files will be added to the playlist as they become available.</p>\n</blockquote>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\"><span class=\"hljs-attr\">#EXTM3</span>U<br><span class=\"hljs-attr\">#EXT-X-PLAYLIST-TYPE:EVENT</span><br><span class=\"hljs-attr\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-attr\">#EXT-X-VERSION:4</span><br><span class=\"hljs-attr\">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce0</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce1</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce2</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce3</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce4</span>.ts<br></code></pre></td></tr></table></figure>\n\n<p>è§‚å¯Ÿåˆ°<code>#EXT-X-PLAYLIST-TYPE:EVENT</code></p>\n<blockquote>\n<p>If the tag is present and has a value of EVENT, the server must not change or delete any part of the playlist file (although it may append lines to it). If the tag is present and has a value of VOD, the playlist file must not change.</p>\n</blockquote>\n<blockquote>\n<p>You canâ€™t remove anything from the playlist when using the EVENT tag; you may only append new segments to the end of the file. New segments are added to the end of the file until the event has concluded, at which time the EXT-X-ENDLIST tag is appended.</p>\n</blockquote>\n<p>å¦‚æœç±»å‹ä¸ºEVENTï¼Œæ›´æ–°m3u8æ–‡ä»¶ï¼Œåªèƒ½è¿½åŠ ï¼Œä¸èƒ½åˆ é™¤ã€‚<br>å¦‚æœç±»å‹ä¸ºVODï¼Œä¸èƒ½æ›´æ”¹m3u8æ’­æ”¾åˆ—è¡¨ã€‚</p>\n<p>æ›´æ–°å</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-selector-id\">#EXTM3U</span><br><span class=\"hljs-selector-id\">#EXT-X-PLAYLIST-TYPE</span>:EVENT<br><span class=\"hljs-selector-id\">#EXT-X-TARGETDURATION</span>:<span class=\"hljs-number\">10</span><br><span class=\"hljs-selector-id\">#EXT-X-VERSION</span>:<span class=\"hljs-number\">4</span><br><span class=\"hljs-selector-id\">#EXT-X-MEDIA-SEQUENCE</span>:<span class=\"hljs-number\">0</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence0<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence1<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence2<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence3<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence4<span class=\"hljs-selector-class\">.ts</span><br><br><span class=\"hljs-comment\">// List of files between 4 and 120 go here.</span><br><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence120<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence121<span class=\"hljs-selector-class\">.ts</span><br>#EXT-X-ENDLIST<br></code></pre></td></tr></table></figure>\n\n\n<h3 id=\"Creating-a-Multivariant-Playlist\"><a href=\"#Creating-a-Multivariant-Playlist\" class=\"headerlink\" title=\"Creating a Multivariant Playlist\"></a>Creating a Multivariant Playlist</h3><blockquote>\n<p>Offer multiple playlist files to provide different encodings of the same content.</p>\n</blockquote>\n<p>ä¸ºåŒä¸€ä»½å†…å®¹ï¼Œæä¾›å¤šä¸ªm3u8ç´¢å¼•ï¼Œæ¯ä¸ªm3u8é‡‡ç”¨ä¸åŒçš„ç¼–ç å‚æ•°ã€‚</p>\n<blockquote>\n<p>The Multivariant Playlist describes all of the available variants for your content. Each variant is a version of the stream at a particular bit rate and is contained in a separate playlist. The client switches to the most appropriate variant based on the measured network bit rate. The clientâ€™s player is tuned to minimize stalling of playback, to give the user the best possible streaming experience.</p>\n</blockquote>\n<p>ä¸ºåŒä¸€ä»½å†…å®¹ï¼Œæä¾›å¤šä¸ªç ç‡çš„m3u8,æ–¹ä¾¿å®¢æˆ·ç«¯æ’­æ”¾å™¨é€‰æ‹©é€‚åº”è‡ªèº«ç½‘ç»œçŠ¶å†µçš„æœ€ä½³ç ç‡èµ„æºã€‚</p>\n<p>ç»“æ„å›¾ï¼š</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656676568981665667656356.png\"></p>\n<p>æ–‡ä»¶ç¤ºä¾‹</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dts\"><span class=\"hljs-meta\">#EXTM3U</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=150000,RESOLUTION=416x234,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/low/index.m3u8</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=240000,RESOLUTION=416x234,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/lo_mid/index.m3u8</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=440000,RESOLUTION=416x234,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/hi_mid/index.m3u8</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=640000,RESOLUTION=640x360,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/high/index.m3u8</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=64000,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.5&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/audio/index.m3u8</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>EXT-X-STREAM-INF</strong><br>Indicates that the next URL in the playlist file identifies another playlist file.</p>\n<p>è¡¨æ˜å®ƒçš„URLå†…å®¹æ˜¯ä¸€ä¸ªm3u8æ–‡ä»¶ã€‚</p>\n<p>The EXT-X-STREAM-INF tag has the following parameters:</p>\n<p><strong>AVERAGE-BANDWIDTH</strong></p>\n<p>(Optional, but recommended) An integer that represents the average bit rate for the variant stream.</p>\n<p>å¹³å‡ç ç‡ï¼Œå¯é€‰ã€‚</p>\n<p><strong>BANDWIDTH</strong></p>\n<p>(Required) An integer that is the upper bound of the overall bit rate for each media file, in bits per second. The upper bound value is calculated to include any container overhead that appears or will appear in the playlist.</p>\n<p>å¸¦å®½ã€‚</p>\n<p><strong>FRAME-RATE</strong></p>\n<p>(Optional, but recommended) A floating-point value that describes the maximum frame rate in a variant stream.</p>\n<p>å¸§ç‡ï¼Œå¯é€‰ï¼Œ è¡¨ç¤ºè¯¥æµçš„æœ€å¤§å¸§ç‡ã€‚</p>\n<p><strong>HDCP-LEVEL</strong></p>\n<p>(Optional) Indicates the type of encryption used. Valid values are TYPE-0 and NONE. Use TYPE-0 if the stream may not play unless the output is protected by HDCP.</p>\n<p>åŠ å¯†æ–¹å¼ï¼Œå¯é€‰ã€‚</p>\n<p><strong>RESOLUTION</strong></p>\n<p>(Optional, but recommended) The optional display size, in pixels, at which to display the video in the playlist. This parameter should be included for any stream that includes video.</p>\n<p>è§†é¢‘åˆ†è¾¨ç‡ã€‚</p>\n<p><strong>VIDEO-RANGE</strong></p>\n<p>(Required depending on encoding) A string with valid values of SDR or PQ. If transfer characteristic codes 1, 16, or 18 arenâ€™t specified, then this parameter must be omitted.</p>\n<p><strong>CODECS</strong></p>\n<p>(Optional, but recommended) A quoted string containing a comma-separated list of formats, where each format specifies a media sample type thatâ€™s present in a media segment in the playlist file. Valid format identifiers are those in the ISO file format name space defined by RFC 6381.</p>\n<p>ç¼–ç å™¨ç›¸å…³å‚æ•°ã€‚</p>\n<h3 id=\"Adding-Alternate-Media-to-a-Playlist\"><a href=\"#Adding-Alternate-Media-to-a-Playlist\" class=\"headerlink\" title=\"Adding Alternate Media to a Playlist\"></a>Adding Alternate Media to a Playlist</h3><blockquote>\n<p>Specify Rendition Playlists that can override the main presentation.</p>\n</blockquote>\n<blockquote>\n<p>Adding alternate media to a Multivariant Playlist allows a provider to specify one of a set of variant playlists as an override of the main presentation. The client plays only the override media (audio or video), and suppresses any media of the same type from the main presentation, if present. This allows a presentation to offer multiple versions of the media without requiring the provider to store duplicate media, or requiring the client to download all variants when it only needs one. It also allows additional media to be offered subsequently without remastering the original content.</p>\n</blockquote>\n<p>åœ¨ä¸»éŸ³é¢‘è§†é¢‘èµ„æºå¤–ï¼Œæä¾›å¤šè·¯å¤‡é€‰èµ„æºã€‚<br>é€‰æ‹©å¤‡é€‰çš„éŸ³è§†é¢‘ï¼Œå®¢æˆ·ç«¯åªä¼šæ’­æ”¾å¤‡é€‰éŸ³è§†é¢‘èµ„æºã€‚</p>\n<p>ä¸‹é¢çš„ä¾‹å­ï¼Œæä¾›å¤‡é€‰çš„å¤šè¯­è¨€éŸ³é¢‘æ’­æ”¾åˆ—è¡¨</p>\n<figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\">#EXTM3U<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;eng&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;eng/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;fre&quot;</span>,NAME=<span class=\"hljs-string\">&quot;FranÃ§ais&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;fre/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;sp&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Espanol&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;sp/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">195023</span>,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;audio&quot;</span><br>lo/prog_index.m3u8<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">591680</span>,CODECS=<span class=\"hljs-string\">&quot;avc1.42e01e,mp4a.40.2&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;audio&quot;</span><br>hi/prog_index.m3u8<br></code></pre></td></tr></table></figure>\n\n<p>The tags used in this Multivariant Playlist example include:</p>\n<p><strong>EXT-X-MEDIA</strong><br>Identifies an element of a media selection group. All the elements of a media selection group must have similar characteristics, for example, the same codecs and the same maximum bandwidth.</p>\n<p>è¡¨ç¤ºåª’ä½“é€‰é¡¹åˆ†ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼ŒåŒä¸€ä¸ªåˆ†ç»„ä¸­çš„åª’ä½“å…·æœ‰ç›¸åŒçš„ç‰¹å¾ï¼Œå¦‚ç›¸åŒçš„ç¼–è§£ç æˆ–å¸¦å®½ã€‚</p>\n<p>EXT-X-STREAM-INF<br>indicates that the next URL in the Multivariant Playlist identifies a Rendition Playlist. See Creating a Multivariant Playlist for the basic parameters.</p>\n<p>è¡¨æ˜å®ƒçš„å†…å®¹æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œ æŒ‡å‘ä¸€ä¸ªm3u8æ–‡ä»¶</p>\n<p>The EXT-X-MEDIA tag has the following parameters:</p>\n<p>TYPE<br>(Required) A string indicating the type of media. Valid values are AUDIO, VIDEO, SUBTITLES, and CLOSED-CAPTIONS.</p>\n<p>åª’ä½“ç±»å‹</p>\n<ul>\n<li>AUDIO</li>\n<li>VIDEO</li>\n<li>SUBTITLES</li>\n<li>CLOSED-CAPTIONS</li>\n</ul>\n<p>GROUP-ID<br>(Required) A string specifying the group that the media selection belongs to.</p>\n<p>åˆ†ç»„æ ‡è¯†ï¼Œå­—ç¬¦ä¸²ï¼Œå¿…é¡»æœ‰ã€‚</p>\n<p>LANGUAGE<br>(Optional) A string that identifies the primary language used in the media selection.</p>\n<p>è¯¥é€‰é¡¹ä¸­åª’ä½“æ–‡ä»¶å¯¹åº”çš„è¯­è¨€ï¼Œå¯é€‰ã€‚</p>\n<p>NAME<br>(Required) A string that describes the primary language used in the media selection.</p>\n<p>è¯¥é€‰é¡¹ä¸­åª’ä½“æ–‡ä»¶å¯¹åº”çš„è¯­è¨€çš„å­—ç¬¦ä¸²æ ‡è¯†ï¼Œå¿…é¡»ã€‚</p>\n<p>AUTOSELECT<br>(Optional) A string that indicates that the client may play the media selection in the absence of explicit user preference. Valid values are YES and NO. If the value of DEFAULT is YES, this value must also be YES.</p>\n<p>æ˜¯å¦è‡ªåŠ¨é€‰æ‹©ï¼Œå¯é€‰ã€‚åœ¨ç”¨æˆ·åå¥½ç¼ºçœçš„æ—¶å€™ï¼ŒæŒ‡ç¤ºå®¢æˆ·ç«¯æ˜¯å¦åº”è¯¥è‡ªåŠ¨é€‰æ‹©è¯¥é€‰é¡¹ã€‚åˆæ³•çš„å€¼æ˜¯YESå’ŒNOï¼Œ<br>å¦‚æœ<code>DEFAULT</code>æ˜¯YESï¼Œ è¯¥å­—æ®µçš„å€¼å¿…é¡»ä¹Ÿæ˜¯YES.</p>\n<p>DEFAULT<br>(Optional) A string indicating that the media selection should be played if the user hasnâ€™t selected another option. Valid values are YES and NO.</p>\n<p>æ˜¯å¦é»˜è®¤æ’­æ”¾è¯¥é€‰é¡¹ï¼Œå¯é€‰ã€‚ç”¨æˆ·æ²¡æœ‰é€‰æ‹©å…¶ä»–é€‰é¡¹çš„æ—¶å€™ï¼Œæ˜¯å¦é»˜è®¤æ’­æ”¾è¯¥é€‰é¡¹ã€‚</p>\n<p>INSTREAM-ID<br>(Required for closed captions) A string that specifies a rendition within the segments in the media playlist. When the TYPE attribute is CLOSED-CAPTIONS, the INSTREAM-ID must have one of the following values: CC1, CC3, CC3, CC4, or SERVICEn, where n is between 1 and 63.</p>\n<p>ASSOC-LANGUAGE<br>(Optional) A string containing a language tag for the rendition. An associated language is often different from the language specified in the LANGUAGE attribute.</p>\n<p>å…³è”çš„è¯­è¨€ï¼Œå¯é€‰ã€‚</p>\n<p>CHANNELS<br>(Required when two renditions have the same codec but a different number of channels) An ordered string that indicates the maximum number of independent, simultaneous audio channels present in a media segment.</p>\n<p>è¡¨æ˜è¯¥éŸ³é¢‘æ–‡ä»¶æœ‰å‡ ä¸ªå£°é“</p>\n<p>URI<br>(Optional) A string containing a URI that identifies the media playlist file. If the TYPE is CLOSED-CAPTIONS, this attribute must be omitted. When this attribute is omitted, the media content is in the original variant.</p>\n<p>åª’ä½“æ–‡ä»¶åœ°å€ï¼Œå¯é€‰ã€‚</p>\n<p>When its URI attribute is omitted, the EXT-X-MEDIA tag can indicate that the media described is included in the URI of the EXT-X-STREAM-INF tag.</p>\n<p>å¦‚æœURIå­—æ®µä¸å­˜åœ¨ï¼Œ<code>EXT-X-MEDIA</code>æè¿°çš„çš„åª’ä½“æ–‡ä»¶å­˜åœ¨äº<code>EXT-X-STREAM-INF</code>æ ‡ç­¾ä¸­ã€‚</p>\n<p>The EXT-X-STREAM-INF tag has the following parameters:</p>\n<p>AUDIO<br>(Optional) A quoted string that indicates the set of audio streams that may be used when playing the presentation. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is AUDIO.</p>\n<p>VIDEO<br>(Optional) A quoted string that indicates the set of video streams that may be used when playing the presentation. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is VIDEO.</p>\n<p>SUBTITLES<br>(Optional) A quoted string that indicates the set of subtitle renditions that can be used. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is SUBTITLE.</p>\n<p>CLOSED-CAPTIONS<br>(Optional) Either a quoted string that indicates the set of closed captions that can be used or an enumerated string with the value of NONE. When this value is a quoted string, it must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is CLOSED-CAPTIONS. If the enumerated value is NONE, all EXT-X-STREAM-INF tags must have this attribute with a value of NONE.</p>\n<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>\n<p>é€šè¿‡<code>EXT-X-MEDIA</code>å¯ä»¥å®šä¹‰èµ„æºç»„ï¼Œå¯ä»¥æœ‰å¤šä¸ªç»„ï¼Œç”¨GROUP-IDæ¥åŒºåˆ†ï¼Œ æœ‰å››ç§ç»„ç±»å‹</p>\n<ul>\n<li>AUDIO</li>\n<li>VIDEO</li>\n<li>SUBTITLES</li>\n<li>CLOSED-CAPTIONS</li>\n</ul>\n<p>æ¯ä¸ªåˆ†ç»„ä¸­æµå±æ€§æ˜¯ç›¸åŒï¼Œå…¶å‚æ•°å¯ä»¥é€šè¿‡å…³è”çš„<code>EXT-X-STREAM-INF</code>æŒ‡å®š<br>é€šè¿‡<code>EXT-X-STREAM-INF</code>å®šä¹‰èµ„æºç»„çš„æµå‚æ•°ï¼Œå¸¦å®½ï¼Œç¼–è§£ç å™¨ä¿¡æ¯ã€‚ å®ƒå…³è”ä¸€ä¸ªç»„IDï¼Œè¿™ä¸ªç»„å†…çš„æ‰€æœ‰å¤‡é€‰åª’ä½“éƒ½å…·æœ‰ç›¸åŒçš„æ€§è´¨ã€‚</p>\n<p>You can have multiple audio groups to allow changes in codes or bit rate. However, each audio group in a variant must have the same alternates in it. For example, you canâ€™t have English in one audio group and leave it out of the other group. The following example defines two audio groups, one for low bit rates and one for high bit rates. Both audio groups define the same set of languages but are called based on the available bandwidth.</p>\n<p>æ¯ä¸ªç»„å¯ä»¥æä¾›å¤šä¸ªç ç‡çš„åª’ä½“æ–‡ä»¶ï¼Œå…¶ç ç‡å¯ä»¥é€šè¿‡<code>EXT-X-STREAM-INF</code>æŒ‡å®šï¼Œè™½ç„¶<code>GROUP-ID</code>ç›¸åŒï¼Œä½†æ˜¯ç ç‡æ˜¯ä¸åŒçš„ã€‚</p>\n<figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\">#EXTM3U<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-lo&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;eng&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;englo/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-lo&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;fre&quot;</span>,NAME=<span class=\"hljs-string\">&quot;FranÃ§ais&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;frelo/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-lo&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;es&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Espanol&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;splo/prog_index.m3u8&quot;</span><br> <br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-hi&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;eng&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;eng/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-hi&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;fre&quot;</span>,NAME=<span class=\"hljs-string\">&quot;FranÃ§ais&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;fre/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-hi&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;es&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Espanol&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;sp/prog_index.m3u8&quot;</span><br> <br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:BANDWIDTH=<span class=\"hljs-number\">195023</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.5&quot;</span>, AUDIO=<span class=\"hljs-string\">&quot;audio-lo&quot;</span><br>lo/prog_index.m3u8<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:BANDWIDTH=<span class=\"hljs-number\">260000</span>,CODECS=<span class=\"hljs-string\">&quot;avc1.42e01e,mp4a.40.2&quot;</span>, AUDIO=<span class=\"hljs-string\">&quot;audio-lo&quot;</span><br>hi/prog_index.m3u8<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:BANDWIDTH=<span class=\"hljs-number\">591680</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.2, avc1.64001e&quot;</span>, AUDIO=<span class=\"hljs-string\">&quot;audio-hi&quot;</span><br>lo/prog_index.m3u8<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:BANDWIDTH=<span class=\"hljs-number\">650000</span>,CODECS=<span class=\"hljs-string\">&quot;avc1.42e01e,mp4a.40.2&quot;</span>, AUDIO=<span class=\"hljs-string\">&quot;audio-hi&quot;</span><br>hi/prog_index.m3u8<br><br></code></pre></td></tr></table></figure>\n\n<p>You can have both a group and a single stream in a playlist. This is often done when you have multiple camera angles that all use the same audio. Create a group for the video streams and then declare the single audio stream. The following example shows a playlist with three camera angles and a single audio stream:</p>\n<p>ä¸€ä¸ªè§†é¢‘ç»„å…³è”å•ä¸ªéŸ³é¢‘çš„æƒ…å†µã€‚</p>\n<figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\">#EXTM3U<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle1&quot;</span>,AUTOSELECT=YES,DEFAULT=YES<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle2&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle2/500kbs/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle3&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle3/500kbs/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;aac&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;en&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;eng/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">754857</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.2,avc1.4d401e&quot;</span>, VIDEO=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;aac&quot;</span><br>Angle1/<span class=\"hljs-number\">500</span>kbs/prog_index.m3u8<br></code></pre></td></tr></table></figure>\n\n<p>To provide different streams for different bit rates, a different video group ID is needed for each bit rate.</p>\n<figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\">#EXTM3U<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;200kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle1&quot;</span>,AUTOSELECT=YES,DEFAULT=YES<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;200kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle2&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle2/200kbs/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;200kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle3&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle3/200kbs/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle1&quot;</span>,AUTOSELECT=YES,DEFAULT=YES<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle2&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle2/500kbs/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle3&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle3/500kbs/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;aac&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;en&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;eng/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">300000</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.2,avc1.4d401e&quot;</span>, VIDEO=<span class=\"hljs-string\">&quot;200kbs&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;aac&quot;</span><br>Angle1/<span class=\"hljs-number\">200</span>kbs/prog_index.m3u<br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">754857</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.2,avc1.4d401e&quot;</span>, VIDEO=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;aac&quot;</span><br>Angle1/<span class=\"hljs-number\">500</span>kbs/prog_index.m3u8<br></code></pre></td></tr></table></figure>\n\n<p>å‚è€ƒï¼š<br><a href=\"https://developer.apple.com/documentation/http_live_streaming\">https://developer.apple.com/documentation/http_live_streaming</a><br><a href=\"https://aleen42.gitbooks.io/wiki/content/summary/m3u8/m3u8.html\">https://aleen42.gitbooks.io/wiki/content/summary/m3u8/m3u8.html</a></p>\n","excerpt":"","more":"<h1 id=\"HLS-æ˜¯ä»€ä¹ˆ\"><a href=\"#HLS-æ˜¯ä»€ä¹ˆ\" class=\"headerlink\" title=\"HLS æ˜¯ä»€ä¹ˆ\"></a>HLS æ˜¯ä»€ä¹ˆ</h1><p>ç»´åŸºç™¾ç§‘çš„ä»‹ç»ï¼š</p>\n<p>HTTP Live Streamingï¼Œç¼©å†™ä¸ºHLSï¼Œæ˜¯ç”±è‹¹æœå…¬å¸æå‡ºåŸºäºHTTPçš„æµåª’ä½“ç½‘ç»œä¼ è¾“åè®®ã€‚æ˜¯è‹¹æœå…¬å¸QuickTime Xå’ŒiPhoneè½¯ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯æŠŠæ•´ä¸ªæµåˆ†æˆä¸€ä¸ªä¸ªå°çš„åŸºäºHTTPçš„æ–‡ä»¶æ¥ä¸‹è½½ï¼Œæ¯æ¬¡åªä¸‹è½½ä¸€äº›ã€‚å½“åª’ä½“æµæ­£åœ¨æ’­æ”¾æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä»è®¸å¤šä¸åŒçš„å¤‡ç”¨æºä¸­ä»¥ä¸åŒçš„é€Ÿç‡ä¸‹è½½åŒæ ·çš„èµ„æºï¼Œå…è®¸æµåª’ä½“ä¼šè¯é€‚åº”ä¸åŒçš„æ•°æ®é€Ÿç‡ã€‚åœ¨å¼€å§‹ä¸€ä¸ªæµåª’ä½“ä¼šè¯æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šä¸‹è½½ä¸€ä¸ªåŒ…å«å…ƒæ•°æ®çš„æ‰©å…… M3U (m3u8) æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ï¼Œç”¨äºå¯»æ‰¾å¯ç”¨çš„åª’ä½“æµã€‚</p>\n<p>HLSåªè¯·æ±‚åŸºæœ¬çš„HTTPæŠ¥æ–‡ï¼Œä¸å®æ—¶ä¼ è¾“åè®®ï¼ˆRTPï¼‰ä¸åŒï¼ŒHLSå¯ä»¥ç©¿è¿‡ä»»ä½•å…è®¸HTTPæ•°æ®é€šè¿‡çš„é˜²ç«å¢™æˆ–è€…ä»£ç†æœåŠ¡å™¨ã€‚å®ƒä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨å†…å®¹åˆ†å‘ç½‘ç»œæ¥ä¼ è¾“åª’ä½“æµã€‚</p>\n<p>è‹¹æœå…¬å¸æŠŠHLSåè®®ä½œä¸ºä¸€ä¸ªäº’è”ç½‘è‰æ¡ˆï¼ˆé€æ­¥æäº¤ï¼‰ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µä¸­å·²ä½œä¸ºä¸€ä¸ªéæ­£å¼çš„æ ‡å‡†æäº¤åˆ°IETFã€‚2017å¹´8æœˆï¼ŒRFC 8216å‘å¸ƒï¼Œæè¿°äº†HLSåè®®ç¬¬7ç‰ˆçš„å®šä¹‰ã€‚</p>\n<p>è‹¹æœè‡ªå·±çš„ä»‹ç»ï¼š</p>\n<blockquote>\n<p>Send live and onâ€demand audio and video to iPhone, iPad, Mac, Apple Watch, Apple TV, and PC with HTTP Live Streaming (HLS) technology from Apple. Using the same protocol that powers the web, HLS lets you deploy content using ordinary web servers and content delivery networks. HLS is designed for reliability and dynamically adapts to network conditions by optimizing playback for the available speed of wired and wireless connections.</p>\n</blockquote>\n<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>\n<ol>\n<li>åŸºäºHTTPçš„æµåª’ä½“ç½‘ç»œä¼ è¾“åè®®ï¼Œæ”¯æŒå®‰å…¨é€šä¿¡ï¼ˆé€šè¿‡https, åª’ä½“æ•°æ®åŠ å¯†ç­‰ï¼‰</li>\n<li>å·¥ä½œåŸç†æ˜¯æŠŠæ•´ä¸ªæµåˆ†æˆä¸€ä¸ªä¸ªå°çš„åŸºäºHTTPçš„æ–‡ä»¶æ¥ä¸‹è½½, ä½¿ç”¨m3u8æè¿°æ’­æ”¾åˆ—è¡¨ã€‚</li>\n<li>æ”¯æŒç›´æ’­å’Œç‚¹æ’­ï¼ˆVODï¼Œ video on demandï¼‰</li>\n<li>å½“åª’ä½“æµæ­£åœ¨æ’­æ”¾æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä»è®¸å¤šä¸åŒçš„å¤‡ç”¨æºä¸­ä»¥ä¸åŒçš„é€Ÿç‡ä¸‹è½½åŒæ ·çš„èµ„æºï¼Œå…è®¸æµåª’ä½“ä¼šè¯é€‚åº”ä¸åŒçš„æ•°æ®é€Ÿç‡</li>\n</ol>\n<h2 id=\"HLS-æµåª’ä½“æ¶æ„\"><a href=\"#HLS-æµåª’ä½“æ¶æ„\" class=\"headerlink\" title=\"HLS æµåª’ä½“æ¶æ„\"></a>HLS æµåª’ä½“æ¶æ„</h2><blockquote>\n<p>Conceptually, HTTP Live Streaming consists of three parts: the server component, the distribution component, and the client software.</p>\n<p>In a typical configuration, a hardware encoder takes audio-video input, encodes it as HEVC video and AC-3 audio, and outputs a fragmented MPEG-4 file or an MPEG-2 transport stream. A software stream segmenter then breaks the stream into a series of short media files, which are placed on a web server. The segmenter also creates and maintains an index file containing a list of the media files. The URL of the index file is published on the web server. Client software reads the index, then requests the listed media files in order and displays them without any pauses or gaps between segments.</p>\n</blockquote>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656504345291665650434432.png\"></p>\n<p>æ¦‚å¿µä¸Šï¼ŒHLS åŒ…å«</p>\n<ul>\n<li>æœåŠ¡ç«¯ç»„ä»¶</li>\n<li>åˆ†å‘ç»„ä»¶</li>\n<li>å®¢æˆ·ç«¯è½¯ä»¶</li>\n</ul>\n<p>æ­¥éª¤ï¼š</p>\n<ol>\n<li>æœåŠ¡ç«¯ç¡¬ä»¶ç¼–ç å™¨ï¼Œå°†éŸ³è§†é¢‘è¾“å…¥ç¼–ç (è§†é¢‘ç¼–ç æˆHEVCï¼ŒH264, éŸ³é¢‘ç¼–ç æˆAACï¼ŒAC-3)ï¼Œ è¾“å‡ºtsæµï¼ˆä¹Ÿå¯ä»¥ç”Ÿæˆåˆ†æ®µçš„mp4æ–‡ä»¶ï¼Œ å¾ˆå°‘ç”¨ï¼‰</li>\n<li>åˆ†æ®µè½¯ä»¶ä¼šå°†tsæµåˆ†å‰²ï¼Œæ‰“åŒ…æˆtsæ–‡ä»¶ï¼ŒåŒæ—¶ç”Ÿæˆç´¢å¼•æ–‡ä»¶ï¼ˆm3u8ï¼‰,ç´¢å¼•æ–‡ä»¶ä¿å­˜äº†åª’ä½“æ–‡ä»¶çš„ä¿¡æ¯ã€‚</li>\n<li>å®¢æˆ·ç«¯è¯»å–m3u8ç´¢å¼•æ–‡ä»¶ï¼Œä¸‹è½½å¯¹åº”çš„tsæ–‡ä»¶ï¼Œå°†å†…å®¹æ’­æ”¾ç»™ç”¨æˆ·</li>\n</ol>\n<p>è‹¹æœæä¾›äº†ä¸€å¥—ç”¨äºHLSçš„å·¥å…·é›†ï¼Œå‚è€ƒï¼š</p>\n<p><a href=\"https://developer.apple.com/documentation/http_live_streaming/using_apple_s_http_live_streaming_hls_tools\">Using Appleâ€™s HTTP Live Streaming (HLS) Tools</a></p>\n<ul>\n<li>Media File Segmenter (mediafilesegmenter), åª’ä½“æ–‡ä»¶åˆ†å‰²å™¨</li>\n<li>Media Subtitle Segmenter (mediasubtitlesegmenter)ï¼Œ å­—å¹•åˆ†å‰²å™¨</li>\n<li>Media Stream Segmenter (mediastreamsegmenter) åª’ä½“æµåˆ†å‰²å™¨</li>\n<li>Variant Playlist Creator (variantplaylistcreator) å¯å˜æ’­æ”¾åˆ—è¡¨ç”Ÿæˆå™¨</li>\n<li>â€¦</li>\n</ul>\n<h1 id=\"M3U8\"><a href=\"#M3U8\" class=\"headerlink\" title=\"M3U8\"></a>M3U8</h1><blockquote>\n<p>The Unicode version of M3U is M3U8, which uses UTF-8-encoded characters. M3U8 files are the basis for the HTTP Live Streaming (HLS) format originally developed by Apple to stream video and radio to iOS devices, and which is now a popular format for adaptive streaming in general.</p>\n</blockquote>\n<blockquote>\n<p>M3U (MP3 URL or Moving Picture Experts Group Audio Layer 3 Uniform Resource Locator in full) is a computer file format for a multimedia playlist. One common use of the M3U file format is creating a single-entry playlist file pointing to a stream on the Internet.</p>\n</blockquote>\n<blockquote>\n<p>Although originally designed for audio files, such as MP3, it is commonly used to point media players to audio and video sources, including online sources.</p>\n</blockquote>\n<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>\n<ol>\n<li>M3U8 æ˜¯M3Uçš„Unicodeç‰ˆæœ¬ï¼Œä½¿ç”¨ UTF-8 ç¼–ç ï¼Œ æ˜¯ HLS çš„åŸºç¡€</li>\n<li>M3U æœ€åˆæ˜¯ä¸ºéŸ³é¢‘æ–‡ä»¶è®¾è®¡çš„ï¼Œä¾‹å¦‚MP3ï¼Œ ç°åœ¨ä¸å†å±€é™äºéŸ³é¢‘æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥ç´¢å¼•éŸ³é¢‘å’Œè§†é¢‘èµ„æºï¼Œç½‘ç»œèµ„æº</li>\n<li>ä¸‹é¢åˆ†æM3U æ–‡ä»¶æ ¼å¼</li>\n</ol>\n<p><strong>M3U</strong></p>\n<blockquote>\n<p>An M3U file is a plain text file that specifies the locations of one or more media files. The file is saved with the â€œm3uâ€ filename extension if the text is encoded in the local systemâ€™s default non-Unicode encoding (e.g., a Windows codepage), or with the â€œm3u8â€ extension if the text is UTF-8 encoded.</p>\n</blockquote>\n<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>\n<ol>\n<li>M3U æ–‡ä»¶æ˜¯çº¯æ–‡æœ¬æ–‡ä»¶ï¼ŒæŒ‡å®šäº†èµ„æºæ–‡ä»¶çš„ä½ç½®</li>\n<li>ä»¥<code>.m3u</code>ä¸ºæ–‡ä»¶åç¼€</li>\n<li>ä½¿ç”¨ UTF-8 ç¼–ç çš„ç‰ˆæœ¬ï¼Œä»¥ <code>.m3u8</code>ä¸ºåç¼€</li>\n</ol>\n<h2 id=\"Extended-M3U\"><a href=\"#Extended-M3U\" class=\"headerlink\" title=\"Extended M3U\"></a>Extended M3U</h2><p>çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#EXTM3U</span><br><span class=\"hljs-comment\">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class=\"hljs-comment\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-comment\">#EXT-X-VERSION:4</span><br><span class=\"hljs-comment\">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceA.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceB.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceC.ts<br><span class=\"hljs-comment\">#EXTINF:9.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceD.ts<br><span class=\"hljs-comment\">#EXT-X-ENDLIST</span><br></code></pre></td></tr></table></figure>\n\n<p>è¯­æ³•ï¼š</p>\n<ul>\n<li>Tags: begin with â€˜#EXTâ€™</li>\n<li>Comments: only begin with â€˜#â€™</li>\n<li>æ ‡ç­¾åé¢å¯ä»¥æœ‰å‚æ•°ï¼Œä¾‹å¦‚<code>#EXTINF:10.0</code></li>\n<li>æ ‡ç­¾å†…å®¹å¯ä»¥æ˜¯ï¼š<ol>\n<li>an absolute local pathname</li>\n<li>a local pathname relative to the M3U file location; e.g. Heavysets.mp3</li>\n<li>a URL</li>\n</ol>\n</li>\n</ul>\n<p>è¡¨æ ¼å‚è€ƒï¼š<a href=\"https://en.wikipedia.org/wiki/M3U\">https://en.wikipedia.org/wiki/M3U</a></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656557421391665655741667.png\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656557911381665655790476.png\"></p>\n<h2 id=\"ä¾‹å­åˆ†æ\"><a href=\"#ä¾‹å­åˆ†æ\" class=\"headerlink\" title=\"ä¾‹å­åˆ†æ\"></a>ä¾‹å­åˆ†æ</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#EXTM3U</span><br><span class=\"hljs-comment\">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class=\"hljs-comment\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-comment\">#EXT-X-VERSION:4</span><br><span class=\"hljs-comment\">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceA.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceB.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceC.ts<br><span class=\"hljs-comment\">#EXTINF:9.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceD.ts<br><span class=\"hljs-comment\">#EXT-X-ENDLIST</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>EXTM3U</strong></p>\n<p>è¡¨æ˜æ˜¯<code>extended M3U</code>æ–‡ä»¶ï¼Œ åŒºåˆ«äºåŸºæœ¬çš„<code>M3U</code>æ–‡ä»¶ã€‚m3u8æ–‡ä»¶å¿…é¡»ä»¥è¯¥æ ‡ç­¾å¼€å§‹ã€‚</p>\n<p><strong>EXT-X-PLAYLIST-TYPE</strong></p>\n<p>ç±»å‹å¯ä»¥æ˜¯ï¼š</p>\n<ul>\n<li>VODï¼Œ ä»£è¡¨ç‚¹æ’­ï¼Œ ç»“å°¾åŒ…å«<code>#EXT-X-ENDLIST</code></li>\n<li>EVENTï¼Œ ä»£è¡¨ç›´æ’­, ç»“å°¾ä¸åŒ…å«<code>#EXT-X-ENDLIST</code></li>\n</ul>\n<p><strong>EXT-X-TARGETDURATION</strong></p>\n<p>å•ä¸ªåª’ä½“æ–‡ä»¶çš„æœ€å¤§æ—¶é•¿ã€‚æ¯ä¸€ä¸ª<code>#EXTINF:10.0</code>æ ‡ç­¾æŒ‡å®šçš„æ—¶é•¿<code>&lt;=</code>EXT-X-TARGETDURATION</p>\n<p><strong>EXT-X-MEDIA-SEQUENCE</strong></p>\n<blockquote>\n<p>Indicates the sequence number of the first URL that appears in a playlist file. Each media file URL in a playlist has a unique integer sequence number. The sequence number of a URL is higher by 1 than the sequence number of the URL that preceded it. The media sequence numbers have no relation to the names of the files.</p>\n</blockquote>\n<p>m3u8æ–‡ä»¶ä¸­ç¬¬ä¸€ä¸ªURLæ–‡ä»¶çš„ç¼–å·ï¼Œä¸æ–‡ä»¶åå­—æ— å…³ï¼Œæ¯æ¬¡æ¯”å‰é¢çš„+1ã€‚</p>\n<p><strong>EXT-X-VERSION</strong></p>\n<blockquote>\n<p>The EXT-X-VERSION tag indicates the compatibility version of the Playlist file. This file, its associated media, and its server must comply with all provisions of the IETF Internet-Draft of â€œHTTP Live Streaming 2nd Editionâ€ (or earlier specifications) describing the protocol version indicated by the tag value. A Playlist file that doesnâ€™t contain an EXT-X-VERSION tag must comply with version 1 of this protocol.</p>\n</blockquote>\n<p>è¡¨æ˜è¯¥m3u8æ–‡ä»¶çš„ç‰ˆæœ¬å…¼å®¹æ€§ã€‚è¯¥m3u8æ–‡ä»¶ï¼Œå…³è”çš„åª’ä½“ï¼ŒæœåŠ¡å™¨å¿…é¡»æœä»äºè¯¥ç‰ˆæœ¬ç‰¹æ€§ã€‚å¦‚æœä¸åŒ…å«è¯¥å­—æ®µï¼Œå¿…é¡»æœä»ä¸ç‰ˆæœ¬1çš„è§„å®šã€‚</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656577590671665657758695.png\"></p>\n<p>å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/http_live_streaming/about_the_ext-x-version_tag\">About the EXT-X-VERSION tag</a></p>\n<p><strong>EXTINF</strong></p>\n<ul>\n<li>æè¿°èµ„æºæ–‡ä»¶æ—¶é•¿ï¼ŒURL</li>\n<li>æ—¶é•¿ï¼š ç‰ˆæœ¬å°äº3æ˜¯intï¼Œ ç‰ˆæœ¬å¤§äºç­‰äº3æ˜¯float, å•ä½ç§’</li>\n</ul>\n<p><strong>EXT-X-ENDLIST</strong></p>\n<p>ç»“æŸæ ‡å¿—ï¼Œè¡¨æ˜æ²¡æœ‰æ›´å¤šèµ„æºäº†ã€‚vodæœ‰ï¼Œeventå¯èƒ½æ²¡æœ‰ã€‚</p>\n<h3 id=\"VOD-Playlist-ç‚¹æ’­\"><a href=\"#VOD-Playlist-ç‚¹æ’­\" class=\"headerlink\" title=\"VOD Playlist ç‚¹æ’­\"></a>VOD Playlist ç‚¹æ’­</h3><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#EXTM3U</span><br><span class=\"hljs-comment\">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class=\"hljs-comment\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-comment\">#EXT-X-VERSION:4</span><br><span class=\"hljs-comment\">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceA.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceB.ts<br><span class=\"hljs-comment\">#EXTINF:10.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceC.ts<br><span class=\"hljs-comment\">#EXTINF:9.0,</span><br>http:<span class=\"hljs-regexp\">//</span>example.com<span class=\"hljs-regexp\">/movie1/</span>fileSequenceD.ts<br><span class=\"hljs-comment\">#EXT-X-ENDLIST</span><br></code></pre></td></tr></table></figure>\n<h3 id=\"live-Playlist-Sliding-Window-ç›´æ’­æ»‘åŠ¨çª—å£\"><a href=\"#live-Playlist-Sliding-Window-ç›´æ’­æ»‘åŠ¨çª—å£\" class=\"headerlink\" title=\"live Playlist(Sliding Window) ç›´æ’­æ»‘åŠ¨çª—å£\"></a>live Playlist(Sliding Window) ç›´æ’­æ»‘åŠ¨çª—å£</h3><blockquote>\n<p>In live sessions, the index file is updated by removing media URIs from the file as new media files are created and made available. The EXT-X-ENDLIST tag isnâ€™t present in the live playlist, indicating that new media files will be added to the index file as they become available.</p>\n</blockquote>\n<p>ç›´æ’­æµï¼Œm3u8æ–‡ä»¶ä¼šæ›´æ–°ï¼Œå‰é¢çš„èµ„æºä¼šè¢«ç§»é™¤ï¼Œåé¢çš„èµ„æºä¼šè¢«è¿½åŠ ã€‚<br>æ²¡æœ‰<code>EXT-X-ENDLIST</code>æ ‡ç­¾ï¼Œè¡¨ç¤ºè¿˜ä¼šæœ‰æ–°çš„èµ„æºè¢«æ·»åŠ ã€‚</p>\n<p>çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå¼€å§‹æ—¶æ–‡ä»¶å†…å®¹</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\"><span class=\"hljs-attr\">#EXTM3</span>U<br><span class=\"hljs-attr\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-attr\">#EXT-X-VERSION:4</span><br><span class=\"hljs-attr\">#EXT-X-MEDIA-SEQUENCE:1</span><br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce1</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce2</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce3</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce4</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce5</span>.ts<br></code></pre></td></tr></table></figure>\n\n<p>æ—§èµ„æºè¢«åˆ é™¤ï¼Œæ–°èµ„è¢«æ·»åŠ ï¼Œçœ‹åˆ°<code>EXT-X-MEDIA-SEQUENCE</code>ä¹Ÿå‘ç”Ÿäº†å˜åŒ–</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\"><span class=\"hljs-attr\">#EXTM3</span>U<br><span class=\"hljs-attr\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-attr\">#EXT-X-VERSION:4</span><br><span class=\"hljs-attr\">#EXT-X-MEDIA-SEQUENCE:2</span><br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce2</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce3</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce4</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce5</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce6</span>.ts<br></code></pre></td></tr></table></figure>\n\n<p>å†æ¬¡æ›´æ–°</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\"><span class=\"hljs-attr\">#EXTM3</span>U<br><span class=\"hljs-attr\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-attr\">#EXT-X-VERSION:4</span><br><span class=\"hljs-attr\">#EXT-X-MEDIA-SEQUENCE:4</span><br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce4</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce5</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce6</span>.ts,<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce7</span>.ts,<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce8</span>.ts,<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce9</span>.ts<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Event-Playlist\"><a href=\"#Event-Playlist\" class=\"headerlink\" title=\"Event Playlist\"></a>Event Playlist</h3><blockquote>\n<p>An event playlist is specified by the EXT-X-PLAYLIST-TYPE tag with a value of EVENT. It doesnâ€™t initially have an EXT-X-ENDLIST tag, indicating that new media files will be added to the playlist as they become available.</p>\n</blockquote>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\"><span class=\"hljs-attr\">#EXTM3</span>U<br><span class=\"hljs-attr\">#EXT-X-PLAYLIST-TYPE:EVENT</span><br><span class=\"hljs-attr\">#EXT-X-TARGETDURATION:10</span><br><span class=\"hljs-attr\">#EXT-X-VERSION:4</span><br><span class=\"hljs-attr\">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.00</span>,<br>fileSeque<span class=\"hljs-symbol\">nce0</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce1</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce2</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce3</span>.ts<br><span class=\"hljs-attr\">#EXTINF:10</span><span class=\"hljs-number\">.0</span>,<br>fileSeque<span class=\"hljs-symbol\">nce4</span>.ts<br></code></pre></td></tr></table></figure>\n\n<p>è§‚å¯Ÿåˆ°<code>#EXT-X-PLAYLIST-TYPE:EVENT</code></p>\n<blockquote>\n<p>If the tag is present and has a value of EVENT, the server must not change or delete any part of the playlist file (although it may append lines to it). If the tag is present and has a value of VOD, the playlist file must not change.</p>\n</blockquote>\n<blockquote>\n<p>You canâ€™t remove anything from the playlist when using the EVENT tag; you may only append new segments to the end of the file. New segments are added to the end of the file until the event has concluded, at which time the EXT-X-ENDLIST tag is appended.</p>\n</blockquote>\n<p>å¦‚æœç±»å‹ä¸ºEVENTï¼Œæ›´æ–°m3u8æ–‡ä»¶ï¼Œåªèƒ½è¿½åŠ ï¼Œä¸èƒ½åˆ é™¤ã€‚<br>å¦‚æœç±»å‹ä¸ºVODï¼Œä¸èƒ½æ›´æ”¹m3u8æ’­æ”¾åˆ—è¡¨ã€‚</p>\n<p>æ›´æ–°å</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-selector-id\">#EXTM3U</span><br><span class=\"hljs-selector-id\">#EXT-X-PLAYLIST-TYPE</span>:EVENT<br><span class=\"hljs-selector-id\">#EXT-X-TARGETDURATION</span>:<span class=\"hljs-number\">10</span><br><span class=\"hljs-selector-id\">#EXT-X-VERSION</span>:<span class=\"hljs-number\">4</span><br><span class=\"hljs-selector-id\">#EXT-X-MEDIA-SEQUENCE</span>:<span class=\"hljs-number\">0</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence0<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence1<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence2<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence3<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence4<span class=\"hljs-selector-class\">.ts</span><br><br><span class=\"hljs-comment\">// List of files between 4 and 120 go here.</span><br><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence120<span class=\"hljs-selector-class\">.ts</span><br><span class=\"hljs-selector-id\">#EXTINF</span>:<span class=\"hljs-number\">10.0</span>,<br>fileSequence121<span class=\"hljs-selector-class\">.ts</span><br>#EXT-X-ENDLIST<br></code></pre></td></tr></table></figure>\n\n\n<h3 id=\"Creating-a-Multivariant-Playlist\"><a href=\"#Creating-a-Multivariant-Playlist\" class=\"headerlink\" title=\"Creating a Multivariant Playlist\"></a>Creating a Multivariant Playlist</h3><blockquote>\n<p>Offer multiple playlist files to provide different encodings of the same content.</p>\n</blockquote>\n<p>ä¸ºåŒä¸€ä»½å†…å®¹ï¼Œæä¾›å¤šä¸ªm3u8ç´¢å¼•ï¼Œæ¯ä¸ªm3u8é‡‡ç”¨ä¸åŒçš„ç¼–ç å‚æ•°ã€‚</p>\n<blockquote>\n<p>The Multivariant Playlist describes all of the available variants for your content. Each variant is a version of the stream at a particular bit rate and is contained in a separate playlist. The client switches to the most appropriate variant based on the measured network bit rate. The clientâ€™s player is tuned to minimize stalling of playback, to give the user the best possible streaming experience.</p>\n</blockquote>\n<p>ä¸ºåŒä¸€ä»½å†…å®¹ï¼Œæä¾›å¤šä¸ªç ç‡çš„m3u8,æ–¹ä¾¿å®¢æˆ·ç«¯æ’­æ”¾å™¨é€‰æ‹©é€‚åº”è‡ªèº«ç½‘ç»œçŠ¶å†µçš„æœ€ä½³ç ç‡èµ„æºã€‚</p>\n<p>ç»“æ„å›¾ï¼š</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16656676568981665667656356.png\"></p>\n<p>æ–‡ä»¶ç¤ºä¾‹</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dts\"><span class=\"hljs-meta\">#EXTM3U</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=150000,RESOLUTION=416x234,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/low/index.m3u8</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=240000,RESOLUTION=416x234,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/lo_mid/index.m3u8</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=440000,RESOLUTION=416x234,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/hi_mid/index.m3u8</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=640000,RESOLUTION=640x360,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/high/index.m3u8</span><br><span class=\"hljs-meta\">#EXT-X-STREAM-INF:BANDWIDTH=64000,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.5&quot;</span></span><br><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//example.com/audio/index.m3u8</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>EXT-X-STREAM-INF</strong><br>Indicates that the next URL in the playlist file identifies another playlist file.</p>\n<p>è¡¨æ˜å®ƒçš„URLå†…å®¹æ˜¯ä¸€ä¸ªm3u8æ–‡ä»¶ã€‚</p>\n<p>The EXT-X-STREAM-INF tag has the following parameters:</p>\n<p><strong>AVERAGE-BANDWIDTH</strong></p>\n<p>(Optional, but recommended) An integer that represents the average bit rate for the variant stream.</p>\n<p>å¹³å‡ç ç‡ï¼Œå¯é€‰ã€‚</p>\n<p><strong>BANDWIDTH</strong></p>\n<p>(Required) An integer that is the upper bound of the overall bit rate for each media file, in bits per second. The upper bound value is calculated to include any container overhead that appears or will appear in the playlist.</p>\n<p>å¸¦å®½ã€‚</p>\n<p><strong>FRAME-RATE</strong></p>\n<p>(Optional, but recommended) A floating-point value that describes the maximum frame rate in a variant stream.</p>\n<p>å¸§ç‡ï¼Œå¯é€‰ï¼Œ è¡¨ç¤ºè¯¥æµçš„æœ€å¤§å¸§ç‡ã€‚</p>\n<p><strong>HDCP-LEVEL</strong></p>\n<p>(Optional) Indicates the type of encryption used. Valid values are TYPE-0 and NONE. Use TYPE-0 if the stream may not play unless the output is protected by HDCP.</p>\n<p>åŠ å¯†æ–¹å¼ï¼Œå¯é€‰ã€‚</p>\n<p><strong>RESOLUTION</strong></p>\n<p>(Optional, but recommended) The optional display size, in pixels, at which to display the video in the playlist. This parameter should be included for any stream that includes video.</p>\n<p>è§†é¢‘åˆ†è¾¨ç‡ã€‚</p>\n<p><strong>VIDEO-RANGE</strong></p>\n<p>(Required depending on encoding) A string with valid values of SDR or PQ. If transfer characteristic codes 1, 16, or 18 arenâ€™t specified, then this parameter must be omitted.</p>\n<p><strong>CODECS</strong></p>\n<p>(Optional, but recommended) A quoted string containing a comma-separated list of formats, where each format specifies a media sample type thatâ€™s present in a media segment in the playlist file. Valid format identifiers are those in the ISO file format name space defined by RFC 6381.</p>\n<p>ç¼–ç å™¨ç›¸å…³å‚æ•°ã€‚</p>\n<h3 id=\"Adding-Alternate-Media-to-a-Playlist\"><a href=\"#Adding-Alternate-Media-to-a-Playlist\" class=\"headerlink\" title=\"Adding Alternate Media to a Playlist\"></a>Adding Alternate Media to a Playlist</h3><blockquote>\n<p>Specify Rendition Playlists that can override the main presentation.</p>\n</blockquote>\n<blockquote>\n<p>Adding alternate media to a Multivariant Playlist allows a provider to specify one of a set of variant playlists as an override of the main presentation. The client plays only the override media (audio or video), and suppresses any media of the same type from the main presentation, if present. This allows a presentation to offer multiple versions of the media without requiring the provider to store duplicate media, or requiring the client to download all variants when it only needs one. It also allows additional media to be offered subsequently without remastering the original content.</p>\n</blockquote>\n<p>åœ¨ä¸»éŸ³é¢‘è§†é¢‘èµ„æºå¤–ï¼Œæä¾›å¤šè·¯å¤‡é€‰èµ„æºã€‚<br>é€‰æ‹©å¤‡é€‰çš„éŸ³è§†é¢‘ï¼Œå®¢æˆ·ç«¯åªä¼šæ’­æ”¾å¤‡é€‰éŸ³è§†é¢‘èµ„æºã€‚</p>\n<p>ä¸‹é¢çš„ä¾‹å­ï¼Œæä¾›å¤‡é€‰çš„å¤šè¯­è¨€éŸ³é¢‘æ’­æ”¾åˆ—è¡¨</p>\n<figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\">#EXTM3U<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;eng&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;eng/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;fre&quot;</span>,NAME=<span class=\"hljs-string\">&quot;FranÃ§ais&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;fre/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;sp&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Espanol&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;sp/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">195023</span>,CODECS=<span class=\"hljs-string\">&quot;avc1.42e00a,mp4a.40.2&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;audio&quot;</span><br>lo/prog_index.m3u8<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">591680</span>,CODECS=<span class=\"hljs-string\">&quot;avc1.42e01e,mp4a.40.2&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;audio&quot;</span><br>hi/prog_index.m3u8<br></code></pre></td></tr></table></figure>\n\n<p>The tags used in this Multivariant Playlist example include:</p>\n<p><strong>EXT-X-MEDIA</strong><br>Identifies an element of a media selection group. All the elements of a media selection group must have similar characteristics, for example, the same codecs and the same maximum bandwidth.</p>\n<p>è¡¨ç¤ºåª’ä½“é€‰é¡¹åˆ†ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼ŒåŒä¸€ä¸ªåˆ†ç»„ä¸­çš„åª’ä½“å…·æœ‰ç›¸åŒçš„ç‰¹å¾ï¼Œå¦‚ç›¸åŒçš„ç¼–è§£ç æˆ–å¸¦å®½ã€‚</p>\n<p>EXT-X-STREAM-INF<br>indicates that the next URL in the Multivariant Playlist identifies a Rendition Playlist. See Creating a Multivariant Playlist for the basic parameters.</p>\n<p>è¡¨æ˜å®ƒçš„å†…å®¹æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œ æŒ‡å‘ä¸€ä¸ªm3u8æ–‡ä»¶</p>\n<p>The EXT-X-MEDIA tag has the following parameters:</p>\n<p>TYPE<br>(Required) A string indicating the type of media. Valid values are AUDIO, VIDEO, SUBTITLES, and CLOSED-CAPTIONS.</p>\n<p>åª’ä½“ç±»å‹</p>\n<ul>\n<li>AUDIO</li>\n<li>VIDEO</li>\n<li>SUBTITLES</li>\n<li>CLOSED-CAPTIONS</li>\n</ul>\n<p>GROUP-ID<br>(Required) A string specifying the group that the media selection belongs to.</p>\n<p>åˆ†ç»„æ ‡è¯†ï¼Œå­—ç¬¦ä¸²ï¼Œå¿…é¡»æœ‰ã€‚</p>\n<p>LANGUAGE<br>(Optional) A string that identifies the primary language used in the media selection.</p>\n<p>è¯¥é€‰é¡¹ä¸­åª’ä½“æ–‡ä»¶å¯¹åº”çš„è¯­è¨€ï¼Œå¯é€‰ã€‚</p>\n<p>NAME<br>(Required) A string that describes the primary language used in the media selection.</p>\n<p>è¯¥é€‰é¡¹ä¸­åª’ä½“æ–‡ä»¶å¯¹åº”çš„è¯­è¨€çš„å­—ç¬¦ä¸²æ ‡è¯†ï¼Œå¿…é¡»ã€‚</p>\n<p>AUTOSELECT<br>(Optional) A string that indicates that the client may play the media selection in the absence of explicit user preference. Valid values are YES and NO. If the value of DEFAULT is YES, this value must also be YES.</p>\n<p>æ˜¯å¦è‡ªåŠ¨é€‰æ‹©ï¼Œå¯é€‰ã€‚åœ¨ç”¨æˆ·åå¥½ç¼ºçœçš„æ—¶å€™ï¼ŒæŒ‡ç¤ºå®¢æˆ·ç«¯æ˜¯å¦åº”è¯¥è‡ªåŠ¨é€‰æ‹©è¯¥é€‰é¡¹ã€‚åˆæ³•çš„å€¼æ˜¯YESå’ŒNOï¼Œ<br>å¦‚æœ<code>DEFAULT</code>æ˜¯YESï¼Œ è¯¥å­—æ®µçš„å€¼å¿…é¡»ä¹Ÿæ˜¯YES.</p>\n<p>DEFAULT<br>(Optional) A string indicating that the media selection should be played if the user hasnâ€™t selected another option. Valid values are YES and NO.</p>\n<p>æ˜¯å¦é»˜è®¤æ’­æ”¾è¯¥é€‰é¡¹ï¼Œå¯é€‰ã€‚ç”¨æˆ·æ²¡æœ‰é€‰æ‹©å…¶ä»–é€‰é¡¹çš„æ—¶å€™ï¼Œæ˜¯å¦é»˜è®¤æ’­æ”¾è¯¥é€‰é¡¹ã€‚</p>\n<p>INSTREAM-ID<br>(Required for closed captions) A string that specifies a rendition within the segments in the media playlist. When the TYPE attribute is CLOSED-CAPTIONS, the INSTREAM-ID must have one of the following values: CC1, CC3, CC3, CC4, or SERVICEn, where n is between 1 and 63.</p>\n<p>ASSOC-LANGUAGE<br>(Optional) A string containing a language tag for the rendition. An associated language is often different from the language specified in the LANGUAGE attribute.</p>\n<p>å…³è”çš„è¯­è¨€ï¼Œå¯é€‰ã€‚</p>\n<p>CHANNELS<br>(Required when two renditions have the same codec but a different number of channels) An ordered string that indicates the maximum number of independent, simultaneous audio channels present in a media segment.</p>\n<p>è¡¨æ˜è¯¥éŸ³é¢‘æ–‡ä»¶æœ‰å‡ ä¸ªå£°é“</p>\n<p>URI<br>(Optional) A string containing a URI that identifies the media playlist file. If the TYPE is CLOSED-CAPTIONS, this attribute must be omitted. When this attribute is omitted, the media content is in the original variant.</p>\n<p>åª’ä½“æ–‡ä»¶åœ°å€ï¼Œå¯é€‰ã€‚</p>\n<p>When its URI attribute is omitted, the EXT-X-MEDIA tag can indicate that the media described is included in the URI of the EXT-X-STREAM-INF tag.</p>\n<p>å¦‚æœURIå­—æ®µä¸å­˜åœ¨ï¼Œ<code>EXT-X-MEDIA</code>æè¿°çš„çš„åª’ä½“æ–‡ä»¶å­˜åœ¨äº<code>EXT-X-STREAM-INF</code>æ ‡ç­¾ä¸­ã€‚</p>\n<p>The EXT-X-STREAM-INF tag has the following parameters:</p>\n<p>AUDIO<br>(Optional) A quoted string that indicates the set of audio streams that may be used when playing the presentation. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is AUDIO.</p>\n<p>VIDEO<br>(Optional) A quoted string that indicates the set of video streams that may be used when playing the presentation. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is VIDEO.</p>\n<p>SUBTITLES<br>(Optional) A quoted string that indicates the set of subtitle renditions that can be used. This value must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is SUBTITLE.</p>\n<p>CLOSED-CAPTIONS<br>(Optional) Either a quoted string that indicates the set of closed captions that can be used or an enumerated string with the value of NONE. When this value is a quoted string, it must match the value of the GROUP-ID attribute of an EXT-X-MEDIA tag elsewhere in the Multivariant Playlist whose TYPE attribute is CLOSED-CAPTIONS. If the enumerated value is NONE, all EXT-X-STREAM-INF tags must have this attribute with a value of NONE.</p>\n<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>\n<p>é€šè¿‡<code>EXT-X-MEDIA</code>å¯ä»¥å®šä¹‰èµ„æºç»„ï¼Œå¯ä»¥æœ‰å¤šä¸ªç»„ï¼Œç”¨GROUP-IDæ¥åŒºåˆ†ï¼Œ æœ‰å››ç§ç»„ç±»å‹</p>\n<ul>\n<li>AUDIO</li>\n<li>VIDEO</li>\n<li>SUBTITLES</li>\n<li>CLOSED-CAPTIONS</li>\n</ul>\n<p>æ¯ä¸ªåˆ†ç»„ä¸­æµå±æ€§æ˜¯ç›¸åŒï¼Œå…¶å‚æ•°å¯ä»¥é€šè¿‡å…³è”çš„<code>EXT-X-STREAM-INF</code>æŒ‡å®š<br>é€šè¿‡<code>EXT-X-STREAM-INF</code>å®šä¹‰èµ„æºç»„çš„æµå‚æ•°ï¼Œå¸¦å®½ï¼Œç¼–è§£ç å™¨ä¿¡æ¯ã€‚ å®ƒå…³è”ä¸€ä¸ªç»„IDï¼Œè¿™ä¸ªç»„å†…çš„æ‰€æœ‰å¤‡é€‰åª’ä½“éƒ½å…·æœ‰ç›¸åŒçš„æ€§è´¨ã€‚</p>\n<p>You can have multiple audio groups to allow changes in codes or bit rate. However, each audio group in a variant must have the same alternates in it. For example, you canâ€™t have English in one audio group and leave it out of the other group. The following example defines two audio groups, one for low bit rates and one for high bit rates. Both audio groups define the same set of languages but are called based on the available bandwidth.</p>\n<p>æ¯ä¸ªç»„å¯ä»¥æä¾›å¤šä¸ªç ç‡çš„åª’ä½“æ–‡ä»¶ï¼Œå…¶ç ç‡å¯ä»¥é€šè¿‡<code>EXT-X-STREAM-INF</code>æŒ‡å®šï¼Œè™½ç„¶<code>GROUP-ID</code>ç›¸åŒï¼Œä½†æ˜¯ç ç‡æ˜¯ä¸åŒçš„ã€‚</p>\n<figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\">#EXTM3U<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-lo&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;eng&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;englo/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-lo&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;fre&quot;</span>,NAME=<span class=\"hljs-string\">&quot;FranÃ§ais&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;frelo/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-lo&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;es&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Espanol&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;splo/prog_index.m3u8&quot;</span><br> <br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-hi&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;eng&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;eng/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-hi&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;fre&quot;</span>,NAME=<span class=\"hljs-string\">&quot;FranÃ§ais&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;fre/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;audio-hi&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;es&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Espanol&quot;</span>,AUTOSELECT=YES, DEFAULT=NO,URI=<span class=\"hljs-string\">&quot;sp/prog_index.m3u8&quot;</span><br> <br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:BANDWIDTH=<span class=\"hljs-number\">195023</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.5&quot;</span>, AUDIO=<span class=\"hljs-string\">&quot;audio-lo&quot;</span><br>lo/prog_index.m3u8<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:BANDWIDTH=<span class=\"hljs-number\">260000</span>,CODECS=<span class=\"hljs-string\">&quot;avc1.42e01e,mp4a.40.2&quot;</span>, AUDIO=<span class=\"hljs-string\">&quot;audio-lo&quot;</span><br>hi/prog_index.m3u8<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:BANDWIDTH=<span class=\"hljs-number\">591680</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.2, avc1.64001e&quot;</span>, AUDIO=<span class=\"hljs-string\">&quot;audio-hi&quot;</span><br>lo/prog_index.m3u8<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:BANDWIDTH=<span class=\"hljs-number\">650000</span>,CODECS=<span class=\"hljs-string\">&quot;avc1.42e01e,mp4a.40.2&quot;</span>, AUDIO=<span class=\"hljs-string\">&quot;audio-hi&quot;</span><br>hi/prog_index.m3u8<br><br></code></pre></td></tr></table></figure>\n\n<p>You can have both a group and a single stream in a playlist. This is often done when you have multiple camera angles that all use the same audio. Create a group for the video streams and then declare the single audio stream. The following example shows a playlist with three camera angles and a single audio stream:</p>\n<p>ä¸€ä¸ªè§†é¢‘ç»„å…³è”å•ä¸ªéŸ³é¢‘çš„æƒ…å†µã€‚</p>\n<figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\">#EXTM3U<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle1&quot;</span>,AUTOSELECT=YES,DEFAULT=YES<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle2&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle2/500kbs/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle3&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle3/500kbs/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;aac&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;en&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;eng/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">754857</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.2,avc1.4d401e&quot;</span>, VIDEO=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;aac&quot;</span><br>Angle1/<span class=\"hljs-number\">500</span>kbs/prog_index.m3u8<br></code></pre></td></tr></table></figure>\n\n<p>To provide different streams for different bit rates, a different video group ID is needed for each bit rate.</p>\n<figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lasso\">#EXTM3U<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;200kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle1&quot;</span>,AUTOSELECT=YES,DEFAULT=YES<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;200kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle2&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle2/200kbs/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;200kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle3&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle3/200kbs/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle1&quot;</span>,AUTOSELECT=YES,DEFAULT=YES<br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle2&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle2/500kbs/prog_index.m3u8&quot;</span><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=VIDEO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,NAME=<span class=\"hljs-string\">&quot;Angle3&quot;</span>,AUTOSELECT=YES,DEFAULT=NO, URI=<span class=\"hljs-string\">&quot;Angle3/500kbs/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-MEDIA</span>:<span class=\"hljs-keyword\">TYPE</span>=AUDIO,<span class=\"hljs-keyword\">GROUP</span><span class=\"hljs-params\">-ID</span>=<span class=\"hljs-string\">&quot;aac&quot;</span>,LANGUAGE=<span class=\"hljs-string\">&quot;en&quot;</span>,NAME=<span class=\"hljs-string\">&quot;English&quot;</span>,AUTOSELECT=YES, DEFAULT=YES,URI=<span class=\"hljs-string\">&quot;eng/prog_index.m3u8&quot;</span><br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">300000</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.2,avc1.4d401e&quot;</span>, VIDEO=<span class=\"hljs-string\">&quot;200kbs&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;aac&quot;</span><br>Angle1/<span class=\"hljs-number\">200</span>kbs/prog_index.m3u<br><br>#EXT<span class=\"hljs-params\">-X</span><span class=\"hljs-params\">-STREAM</span><span class=\"hljs-params\">-INF</span>:PROGRAM<span class=\"hljs-params\">-ID</span>=<span class=\"hljs-number\">1</span>,BANDWIDTH=<span class=\"hljs-number\">754857</span>,CODECS=<span class=\"hljs-string\">&quot;mp4a.40.2,avc1.4d401e&quot;</span>, VIDEO=<span class=\"hljs-string\">&quot;500kbs&quot;</span>,AUDIO=<span class=\"hljs-string\">&quot;aac&quot;</span><br>Angle1/<span class=\"hljs-number\">500</span>kbs/prog_index.m3u8<br></code></pre></td></tr></table></figure>\n\n<p>å‚è€ƒï¼š<br><a href=\"https://developer.apple.com/documentation/http_live_streaming\">https://developer.apple.com/documentation/http_live_streaming</a><br><a href=\"https://aleen42.gitbooks.io/wiki/content/summary/m3u8/m3u8.html\">https://aleen42.gitbooks.io/wiki/content/summary/m3u8/m3u8.html</a></p>\n"},{"layout":"post","title":"ios keychain æ€»ç»“","date":"2022-11-25T16:00:00.000Z","_content":"\n\n# Keychain  æ˜¯ä»€ä¹ˆ\n\nä¸€ä¸ªåŠ å¯†çš„æ•°æ®åº“ï¼Œ å¯ä»¥ç”¨æ¥å­˜å‚¨å°çš„ç”¨æˆ·æ•°æ®ï¼Œ åŒ…æ‹¬\n- kSecClassGenericPasswordï¼šé€šç”¨å¯†ç ï¼ˆå¯ä»¥ç”¨æ¥å­˜è‡ªå®šä¹‰æ•°æ®ï¼‰\n- kSecClassInternetPasswordï¼šäº’è”ç½‘å¯†ç \n- kSecClassCertificateï¼šè¯ä¹¦\n- kSecClassKeyï¼šç§˜é’¥\n- kSecClassIdentityï¼šè¯ä¹¦+ç§˜é’¥\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16692950150511669295014987.png)\nFigure 1 Securing the user's secrets in a keychain\n\næ‰“å¼€ mac ç³»ç»Ÿçš„ keychain è§‚å¯Ÿä¸€ä¸‹ï¼Œ å‘ç°ç³»ç»Ÿæœ‰å¤šä¸ªkeychainï¼Œæ¯ä¸ªkeychainéƒ½æœ‰ä¸Šå›¾å¯¹åº”çš„é¡¹ç›®\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694375672261669437566402.png)\n\n\n# å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16692963470741669296346746.png)\nFigure 1 Putting data and attributes into a keychain\n\n\nkeychain å°†è¦å­˜å‚¨çš„æ•°æ®å°è£…ä¸º SecKeychainItemRefï¼Œé€šè¿‡å­˜å– SecKeychainItem æ¥è¾¾åˆ°å¯¹æ•°æ®çš„ç®¡ç†ã€‚\n\nSecKeychainItemRef åŒ…å«\n- dataï¼Œ CFDataï¼Œ è¦å­˜å–çš„æ•°æ®\n- attributes, è¯¥æ¡ç›®çš„å±æ€§ï¼Œå­˜å–æƒé™ï¼ŒæŸ¥è¯¢æ ‡ç­¾ç­‰\n\næä¾›çš„api\n\n```\n//æ·»åŠ \nOSStatus SecItemAdd(CFDictionaryRef attributes, CFTypeRef  _Nullable *result);\n//æŸ¥è¯¢\nOSStatus SecItemCopyMatching(CFDictionaryRef query, CFTypeRef  _Nullable *result);\n//æ›´æ–°\nOSStatus SecItemUpdate(CFDictionaryRef query, CFDictionaryRef attributesToUpdate);\n//åˆ é™¤\nOSStatus SecItemDelete(CFDictionaryRef query);\n\n```\n\n## SecItemAdd\n\n```\nOSStatus SecItemAdd(CFDictionaryRef attributes, CFTypeRef  _Nullable *result);\n```\n\n### å‚æ•°\n**attributes**\n\nä¸€ä¸ªå­—å…¸ï¼Œæè¿°è¦æ·»åŠ çš„æ•°æ®ï¼š\n- è¦æ·»åŠ æ•°æ®ç±»å‹ï¼Œå¯¹åº”çš„ key ä¸º`kSecClass`, value å¯ä»¥æ˜¯\n\t- kSecClassGenericPasswordï¼šé€šç”¨å¯†ç ï¼ˆå¯ä»¥ç”¨æ¥å­˜è‡ªå®šä¹‰æ•°æ®ï¼‰\n\t- kSecClassInternetPasswordï¼šäº’è”ç½‘å¯†ç \n\t- kSecClassCertificateï¼šè¯ä¹¦\n\t- kSecClassKeyï¼šç§˜é’¥\n\t- kSecClassIdentityï¼šè¯ä¹¦+ç§˜é’¥\n- æ•°æ·»åŠ çš„æ•°æ®æœ¬èº«, key ä¸º ` kSecValueData`, value ä¸º `CFDataRef` ç±»å‹\n- å…³è”çš„å±æ€§, å‚è€ƒï¼š[Item Attribute Keys and Values](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values?language=objc)\n\t- æ¯ç§ç±»å‹å…³è”çš„å±æ€§å¯ä»¥ä¸åŒï¼Œä¾‹å¦‚ kSecClassInternetPassword å¯ä»¥å…³è” `kSecAttrServer`, `kSecAttrPort`, `kSecAttrProtocol`ï¼Œ è€Œ `kSecClassGenericPassword`å°±æ²¡æœ‰è¿™äº›é€‰é¡¹\n\t-  `kSecAttrAccessGroup` å¯ä»¥æŒ‡å®šå­˜å…¥çš„keychain groupï¼Œè¿™ä¸ªä¼šå½±å“åˆ°æŸ¥è¯¢èŒƒå›´\n- æ·»åŠ åï¼Œè¿”å›æ·»åŠ ç»“æœçš„ç±»å‹ï¼ŒæŒ‡å®šç±»å‹çš„æ•°æ®ä¼šå­˜å…¥ result å­—æ®µã€‚å‚è€ƒï¼š[ Item Return Result Keys](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc)\n\n**result**\n\næ·»åŠ ç»“æŸï¼Œå‡½æ•°è¿”å›ï¼ŒæŒ‡å‘æ–°æ·»åŠ çš„æ¡ç›®ã€‚æ ¹æ® attributes ä¸­æŒ‡å®šçš„ç±»å‹ï¼Œè¿”å›å¯¹åº”çš„å€¼ã€‚å‚è€ƒï¼š [ Item Return Result Keys](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc)\n\nä¸€èˆ¬æ·»åŠ ä¸å…³å¿ƒæ–°æ¡ç›®ï¼Œä¼ nil\n\n### è¿”å›å€¼\n\næˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š[Security Framework Result Codes](https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc)\n\n### æ³¨æ„\n\n1. kSecAttrAccessGroup å¯ä»¥æŒ‡å®šæ·»åŠ åˆ° é’¥åŒ™ä¸²åˆ†ç»„ï¼Œè¯¥åˆ†ç»„ä¸­çš„æˆå‘˜å…±äº«è¯¥æ¡ç›®\n2. ä¸€æ¬¡æ·»åŠ å¤šæ¡ï¼Œå¯ä»¥ä½¿ç”¨`kSecUseItemList `ä¼ å…¥å­—å…¸æ•°ç»„ï¼Œä½†æ˜¯ä¸èƒ½ç”¨äºå¯†ç ç±»å‹\n3. æ·»åŠ æ˜¯åŒæ­¥æ‰§è¡Œï¼Œæ”¾åˆ°ä¸»çº¿ç¨‹å¯èƒ½ä¼šå¡ç•Œé¢ï¼Œå¯ä»¥ç”¨å¼‚æ­¥æ–¹å¼\n\n```\n- (void)addKeychainItemWithAttributes:(CFDictionaryRef)attrs completion:(void(^)(OSStatus status, CFTypeRef item))completion {\n    dispatch_async(backgroundQueue, ^{\n        CFTypeRef item = NULL;\n        OSStatus addResult = SecItemAdd(attrs, &item);\n        completion(addResult, item);\n        if (item) {\n            CFRelease(item);\n        }\n    });\n}\n```\n\n## SecItemCopyMatching\n\n```\nOSStatus SecItemCopyMatching(CFDictionaryRef query, CFTypeRef  _Nullable *result);\n```\n\né€šè¿‡ query æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ï¼Œå°†æŸ¥è¯¢ç»“æœå­˜å…¥ result ä¸­ã€‚\n\n### å‚æ•°\n\n**query**\nç”¨äºæŒ‡å®šæŸ¥è¯¢æ¡ä»¶\n- æŸ¥è¯¢çš„æ•°æ®ç±»å‹ï¼Œé€šè¿‡ `kSecClass` æŒ‡å®š\n- å…³è”çš„å±æ€§ï¼Œ ç”¨äºç¼©å°æŸ¥è¯¢èŒƒå›´\n- æŸ¥è¯¢å‚æ•°ï¼Œè¿”å›ä¸€æ¡è¿˜æ˜¯å¤šæ¡åŒ¹é…é¡¹ï¼Œæ˜¯å¦å¤§æ¶ˆæ¯æ•æ„Ÿï¼Œæˆ–è€…ä»ç‰¹å®šé¡¹ä¸­æœç´¢ã€‚å‚è€ƒï¼š [ Search Attribute Keys and Values](https://developer.apple.com/documentation/security/keychain_services/keychain_items/search_attribute_keys_and_values?language=objc)\n- æŒ‡å®šè¿”å›ç±»å‹ï¼ŒæŒ‡å®šçš„ç±»å‹ä¸åŒï¼Œresult ä¸­è¿”å›çš„ç±»å‹å°±ä¸åŒã€‚ å‚è€ƒï¼š [Item Return Result Keys ](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc)\n\n**result **\n\nä¿å­˜æŸ¥è¯¢ç»“æœã€‚\nä¾‹å¦‚ï¼š æŒ‡å®š  `kSecReturnData: kCFBooleanTrue`  ï¼Œresult ä¸­å­˜çš„å°±æ˜¯`CFDataRef `ç±»å‹çš„æ•°æ®ã€‚å‚è€ƒï¼š [Item Return Result Keys](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc)\n\n### è¿”å›å€¼\n\næˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š[Security Framework Result Codes](https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc)\n\n### æ³¨æ„\n\n1. é»˜è®¤è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œå¦‚æœæƒ³æŸ¥è¯¢å¤šæ¡åŒ¹é…ï¼ŒæŒ‡å®š `kSecMatchLimit`  å¤§äº1ï¼Œ æ­¤æ—¶ result ä¸º `CFArrayRef`  ç±»å‹\n2. å½“ç±»å‹ä¸º`kSecInternetPasswordItemClass` æˆ– `kSecGenericPasswordItemClass`æ—¶ï¼Œ ä¸èƒ½åŒæ—¶æŒ‡å®š`kSecReturnData` å’Œ `kSecMatchLimitAll`, åŸå› æ˜¯æ‹·è´æ¯ä¸ªå¯†ç æ—¶ï¼Œéœ€è¦é¢å¤–çš„æˆæƒéªŒè¯ã€‚\n3. é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šæœç´¢å½“å‰keychain ä»¥åŠæ‰€æœ‰åŠ å…¥çš„ keychain groupï¼Œ é€šè¿‡ `kSecAttrAccessGroup` å¯ä»¥æŒ‡å®šè¦åœ¨å“ªä¸ª keychain group æŸ¥è¯¢\n4. ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ\n\n```\n- (void)findKeychainItemWithAttributes:(NSDictionary *)attributes completion:(void(^)(OSStatus status, CFTypeRef item))completion {\n    dispatch_async(backgroundQueue, ^{\n        CFDictionaryRef attrs = (__bridge CFDictionaryRef)attributes;\n        CFTypeRef item = NULL;\n        OSStatus result = SecItemCopyMatching(attrs, &item);\n        completion(result, item);\n        CFRelease(item);\n    });\n}\n```\n\n\n## SecItemUpdate\n\n```\nOSStatus SecItemUpdate(CFDictionaryRef query, CFDictionaryRef attributesToUpdate);\n```\n\n### å‚æ•°\n\n**query**\n\nç”¨æ¥æŒ‡å®šè¦æ›´æ–°çš„æ¡ç›®, æ‰§è¡Œæ›´æ–°ï¼Œéœ€è¦å…ˆæŸ¥è¯¢åˆ°è¦æ›´æ–°çš„æ¡ç›®ã€‚\nå‚è€ƒ SecItemCopyMatching å¦‚ä½•æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ã€‚\n\n**attributesToUpdate**\n\næŒ‡å®šéœ€è¦æ›´æ–°çš„å±æ€§ã€‚\n\n### è¿”å›å€¼\n\næˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š[Security Framework Result Codes](https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc)\n\n### æ³¨æ„\n\nä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ\n```\n- (void)updateKeyChainItemWithAttributes:(CFDictionaryRef)attrs update:(CFDictionaryRef)update completion:(void(^)(OSStatus status))completion {\n    dispatch_async(backgroundQueue, ^{\n        OSStatus updateResult = SecItemUpdate(attrs, update);\n        completion(updateResult);\n    });\n}\n```\n\n## SecItemDelete\n\n```\nOSStatus SecItemDelete(CFDictionaryRef query);\n```\n\n### å‚æ•°\n\n**query**\n\nç”¨æ¥æŒ‡å®šè¦åˆ é™¤çš„çš„æ¡ç›®ï¼Œ å‚è€ƒSecItemCopyMatching å¦‚ä½•æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ã€‚\n\n### è¿”å›å€¼\n\næˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š[Security Framework Result Codes](https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc)\n\n### æ³¨æ„\n\n1. é»˜è®¤åˆ é™¤æ‰€æœ‰çš„åŒ¹é…é¡¹ï¼Œ\n2. å¯ä»¥é€šè¿‡æŒ‡å®š`kSecMatchItemList `æ¥é™å®šåˆ é™¤èŒƒå›´ï¼Œ `kSecMatchItemList`å¯¹åº”çš„å€¼çš„ç±»å‹ä¸º`CFArrayRef `, æ•°ç»„ä¸­æ¯ä¸€é¡¹çš„ç±»å‹å¿…é¡»ç›¸åŒï¼Œ\n\t- é’ˆå¯¹ä¸´æ—¶å¼•ç”¨ï¼Œæ¯ä¸€é¡¹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¼•ç”¨çš„ç±»å‹å¯ä»¥æ˜¯\n\t\t- SecKeychainItemRef,\n\t\t-  SecKeyRef\n\t\t-   SecCertificateRef\n\t\t-   SecIdentityRef\n\t\t-   CFDataRef\n\t- é’ˆå¯¹æŒä¹…åŒ–å¼•ç”¨, å¼•ç”¨çš„å¿…é¡»æ˜¯ç±»å‹æ˜¯ `CFDataRef`\n3. ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ\n\n```\n- (void)deleteKeychainItemWithAttributes:(CFDictionaryRef)attrs completion:(void(^)(OSStatus status))completion {\n    dispatch_async(backgroundQueue, ^{\n        OSStatus deleteResult = SecItemDelete(attrs);\n        completion(deleteResult);\n    });\n}\n```\n\n### ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\n\n**ä¸´æ—¶å¼•ç”¨**\n\nå¯¹åº”çš„ key  å€¼æ˜¯`kSecReturnRef`\n\n> The corresponding value is of type `CFBooleanRef`. A value of `kCFBooleanTrue` indicates that a reference should be returned. Depending on the item class requested, the returned references may be of type `SecKeychainItemRef`, `SecKeyRef`, `SecCertificateRef`, `SecIdentityRef`, or `CFDataRef`.\n\n\nç¤ºä¾‹ ï¼šSecCertificateRef è¯ä¹¦å¯¹è±¡çš„å¼•ç”¨åœ¨keychainä¸­å­˜å–\n\nåˆ›å»ºSecCertificateRef\n\n```\nSecCertificateRef certificate =\n    SecCertificateCreateWithData(NULL, (__bridge CFDataRef)certData);\n\t\t \nif (certificate)  { CFRelease(certificate); } // After you are done with it\n```\n\nå°†è¯ä¹¦å­˜å…¥keychain\n```\nNSDictionary* addquery = @{ (id)kSecValueRef:   (__bridge id)certificate,\n                            (id)kSecClass:      (id)kSecClassCertificate,\n                            (id)kSecAttrLabel:  @\"My Certificate\",\n                           };\n\t\t\t\t\t\t   \n\t\t\t\t\t\t   \nOSStatus status = SecItemAdd((__bridge CFDictionaryRef)addquery, NULL);\nif (status != errSecSuccess) {\n    // Handle the error\n}\t\t\t\t\t\t   \n```\n\nä»keychainè¯»å–è¯ä¹¦\n```\nNSDictionary *getquery = @{ (id)kSecClass:     (id)kSecClassCertificate,\n                            (id)kSecAttrLabel: @\"My Certificate\",\n                            (id)kSecReturnRef: @YES,\n                            };\nSecCertificateRef certificate = NULL;\nOSStatus status = SecItemCopyMatching((__bridge CFDictionaryRef)getquery,\n                                      (CFTypeRef *)&certificate);\nif (status != errSecSuccess) { <# Handle error #> }\nelse                         { <# Use certificate #> }\n \nif (certificate) { CFRelease(certificate); } // After you are done with it\n```\n\nè§‚å¯Ÿåˆ°è¿™é‡Œç”¨çš„å°±æ˜¯ `kSecReturnRef`, ä»£è¡¨ä¸´æ—¶å¼•ç”¨ã€‚\n\n- SecKeychainItemRef,\n- SecKeyRef\n-  SecCertificateRef\n-  SecIdentityRef\n-  CFDataRef\n\n**æŒä¹…åŒ–å¼•ç”¨**\n\nkey ä¸º kSecReturnPersistentRefã€‚\n> The corresponding value is of type `CFBooleanRef`. A value of kCFBooleanTrue indicates that a persistent reference to an item should be returned as a `CFDataRef` object. Unlike normal references, a persistent reference may be stored on disk or passed between processes.\n\n1. ä¸€ä¸ªæŒä¹…åŒ–å¼•ç”¨ï¼Œå¼•ç”¨çš„å¯¹è±¡å¿…é¡»æ˜¯`CFDataRef`\n2. æŒä¹…åŒ–å¼•ç”¨å¯ä»¥å­˜å‚¨åœ¨ç£ç›˜ï¼Œå¯ä»¥è·¨è¿›ç¨‹ä¼ é€’\n\n\n# ç¤ºä¾‹\n\n##  [Adding a Password to the Keychain](https://developer.apple.com/documentation/security/keychain_services/keychain_items/adding_a_password_to_the_keychain?language=objc)\n\n```\nstruct Credentials {\n    var username: String\n    var password: String\n}\n\nenum KeychainError: Error {\n    case noPassword\n    case unexpectedPasswordData\n    case unhandledError(status: OSStatus)\n}\n\nstatic let server = \"www.example.com\"\n\nlet account = credentials.username\nlet password = credentials.password.data(using: String.Encoding.utf8)!\nvar query: [String: Any] = [kSecClass as String: kSecClassInternetPassword,\n                            kSecAttrAccount as String: account,\n                            kSecAttrServer as String: server,\n                            kSecValueData as String: password]\nlet status = SecItemAdd(query as CFDictionary, nil)\nguard status == errSecSuccess else { throw KeychainError.unhandledError(status: status) }\n\n```\n\n## [Searching for Keychain Items](https://developer.apple.com/documentation/security/keychain_services/keychain_items/searching_for_keychain_items?language=objc)\n\n```\nlet query: [String: Any] = [kSecClass as String: kSecClassInternetPassword,\n                            kSecAttrServer as String: server,\n                            kSecMatchLimit as String: kSecMatchLimitOne,\n                            kSecReturnAttributes as String: true,\n                            kSecReturnData as String: true]\n\nvar item: CFTypeRef?\nlet status = SecItemCopyMatching(query as CFDictionary, &item)\nguard status != errSecItemNotFound else { throw KeychainError.noPassword }\nguard status == errSecSuccess else { throw KeychainError.unhandledError(status: status) }\n\nguard let existingItem = item as? [String : Any],\n    let passwordData = existingItem[kSecValueData as String] as? Data,\n    let password = String(data: passwordData, encoding: String.Encoding.utf8),\n    let account = existingItem[kSecAttrAccount as String] as? String\nelse {\n    throw KeychainError.unexpectedPasswordData\n}\nlet credentials = Credentials(username: account, password: password)\n\n```\n\n## [Updating and Deleting Keychain Items](https://developer.apple.com/documentation/security/keychain_services/keychain_items/updating_and_deleting_keychain_items?language=objc)\n\n```\nlet query: [String: Any] = [kSecClass as String: kSecClassInternetPassword,\n                            kSecAttrServer as String: server]\n\t\t\t\t\t\t\t\nlet account = credentials.username\nlet password = credentials.password.data(using: String.Encoding.utf8)!\nlet attributes: [String: Any] = [kSecAttrAccount as String: account,\n                                 kSecValueData as String: password]\n\n//update\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t \nlet status = SecItemUpdate(query as CFDictionary, attributes as CFDictionary)\nguard status != errSecItemNotFound else { throw KeychainError.noPassword }\nguard status == errSecSuccess else { throw KeychainError.unhandledError(status: status) }\t\n\n//delete\nlet status = SecItemDelete(query as CFDictionary)\nguard status == errSecSuccess || status == errSecItemNotFound else { throw KeychainError.unhandledError(status: status) }\n```\n\n# keychain group & app group\n\nå‚è€ƒï¼š[Sharing Access to Keychain Items Among a Collection of Apps](https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps?language=objc)\n\n\n> Enable apps to share keychain items with each other by adding the apps to an access group.\n\né€šè¿‡keychain group å¯ä»¥åœ¨ app é—´å…±äº«keychain itemã€‚\n\n> An access group is a logical collection of apps tagged with a particular group name string. Any app in a given group can share keychain items with all the other apps in the same group. You can add an app to any number of groups, but the app is always part of at least one group that contains only itself. That is, an app can always store and retrieve private keychain items, regardless of whether it also participates in any other groups. Keychain items, on the other hand, are always part of exactly one group.\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œapp åŠ å…¥äº†ä»¥è‡ªèº«id ä¸ºæ ‡è®°çš„åˆ†ç»„ä¸­ï¼Œè¿™ä¸ªåˆ†ç»„ä¸­çš„æ‰€æœ‰ keychain item ä»…é™app è‡ªèº«è®¿é—®ã€‚\n\né€šè¿‡åŠ å…¥å…¶ä»–åˆ†ç»„ï¼Œapp é—´å¯ä»¥é€šè¿‡ keychain group å…±äº« keychain itemã€‚\n\n ## keychain group ç±»å‹\n\nYou control the groups that your app belongs to by manipulating its entitlements. In particular, an app belongs to all the groups named in a virtual array of strings that the system forms for each app as the concatenation of the following items, evaluated in this order:\n\n**Keychain access groups**\nThe optional Keychain Access Groups Entitlement holds an array of strings, each of which names an access group.\n\n\næ˜¾ç¤ºæŒ‡å®šåŠ å…¥çš„ keychain groupï¼Œ group idä¸º `[$(teamID).$(keychain group id)]`\n\n**Application identifier**\nXcode automatically adds the application-identifier entitlement (or the com.apple.application-identifier entitlement in macOS) to every app during code signing, formed as the team identifier (team ID) plus the bundle identifier (bundle ID).\n\néšå¼çš„åŠ å…¥äº†ä»¥è‡ªèº«ä¸ºç»„çš„ keychain group,  group idä¸º `[$(teamID).$(bundle ID)]`\n\n**Application groups**\nWhen you collect related apps into an application group using the App Groups Entitlement, they share access to a group container, and gain the ability to message each other in certain ways. Starting in iOS 8, the array of strings given by this entitlement also extends the list of keychain access groups.\n\nç”±äºåŠ å…¥äº†app groupï¼Œ éšå¼çš„åŠ å…¥äº†ä»¥ app group ä¸ºç»„çš„ keychain group,  group idä¸º `[$(app group id)]`\n\nXcode handles the application identifier (app ID) for you when you set the bundle ID. You set the others by manipulating capabilities in Xcode.\n\næ·»åŠ keychain group å’Œ app group å¯ä»¥åœ¨xcode ä¸­é€šè¿‡æ“ä½œcapabilitiesæ¥å®ç°ã€‚\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694538450341669453844996.png)\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694538730181669453872352.png)\n\n## app group å’Œ keychain group åŒºåˆ«\nApp groups and keychain access groups arenâ€™t mutually exclusiveâ€”you can use both in the same appâ€”but they do differ in several important ways that may help you decide which to use for a given situation.\n\nä¸¤è€…ä¸æ˜¯äº’ç›¸æ’æ–¥çš„ï¼Œ ä¸€ä¸ªappå¯ä»¥åŒæ—¶åŠ å…¥keychain group å’Œ app groupã€‚\n\n\nFirst, as described above, using an app group enables additional data sharing beyond keychain items. You might want this extra sharing, or might already be using an app group for this purpose, and thus not need to add keychain access groups. On the other hand, you might not want to enable this additional sharing at all, and prefer keychain access groups instead.\n\napp group é™¤äº†å…±äº« keychain item ä¹‹å¤–ï¼Œè¿˜èƒ½å…±äº«å…¶ä»–å†…å®¹ï¼Œä¾‹å¦‚å…±äº«åå¥½è®¾ç½®\n```\nlet userDefualts = UserDefaults.init(suiteName: \"$(group_Id)\")\nuserDefualts?.setValue(data, forKey: key)\nuserDefualts?.synchronize()\n```\n\n\nSecond, order matters. The system considers the first item in the list of access groups to be the appâ€™s default access group. This is the access group that keychain services assumes if you donâ€™t otherwise specify one when adding keychain items. An app group canâ€™t ever be the default, because the app ID is always present and appears earlier in the list. However, a keychain access group can be the default, because it appears before the app ID. In particular, the first keychain access group, if any, that you specify in the corresponding capability becomes the appâ€™s default access group. If you donâ€™t specify any keychain access groups, then the app ID is the default.\n\n\nå…³äºé»˜è®¤ groupï¼Œ å½“æ·»åŠ ï¼ŒæŸ¥è¯¢ï¼Œæ›´æ–°ï¼Œåˆ é™¤ keychain item æ—¶ï¼Œä¸æŒ‡å®š`kSecAttrAccessGroup `æ—¶ï¼Œé»˜è®¤æ“ä½œçš„æ˜¯å“ªä¸ªgroup ï¼Ÿ\n\n1.  ç³»ç»Ÿä»¥ group list æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªä¸ºé»˜è®¤ group\n2.  é»˜è®¤group ä¸ä¼šæ˜¯app groupï¼Œ å› ä¸ºå®ƒä¸ä¼šæ˜¯ç¬¬ä¸€ä¸ª\n3.  å¦‚æœåŠ å…¥keychain groupï¼Œ è¯¥ keychain group å¯èƒ½ä¸ºé»˜è®¤çš„ keychain group\n4.  æƒ³é™å®škeychain item åªåœ¨ app å†…è®¿é—®ï¼Œä¸èƒ½è¢«keychain group è®¿é—®ï¼Œéœ€è¦å°† bundle id æ‰€åœ¨çš„keychain group ç½®é¡¶ï¼Œæˆ–è€…æ˜ç¡®æŒ‡å®šä½¿ç”¨ bundle id æ ‡è®°çš„keychain group\n","source":"_posts/ios/2022-11-26-ios keychain æ€»ç»“.md","raw":"\n---\n\nlayout: post\ntitle: \"ios keychain æ€»ç»“\"\ndate: 2022-11-26 \ntag: iOS\n\n---\n\n\n# Keychain  æ˜¯ä»€ä¹ˆ\n\nä¸€ä¸ªåŠ å¯†çš„æ•°æ®åº“ï¼Œ å¯ä»¥ç”¨æ¥å­˜å‚¨å°çš„ç”¨æˆ·æ•°æ®ï¼Œ åŒ…æ‹¬\n- kSecClassGenericPasswordï¼šé€šç”¨å¯†ç ï¼ˆå¯ä»¥ç”¨æ¥å­˜è‡ªå®šä¹‰æ•°æ®ï¼‰\n- kSecClassInternetPasswordï¼šäº’è”ç½‘å¯†ç \n- kSecClassCertificateï¼šè¯ä¹¦\n- kSecClassKeyï¼šç§˜é’¥\n- kSecClassIdentityï¼šè¯ä¹¦+ç§˜é’¥\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16692950150511669295014987.png)\nFigure 1 Securing the user's secrets in a keychain\n\næ‰“å¼€ mac ç³»ç»Ÿçš„ keychain è§‚å¯Ÿä¸€ä¸‹ï¼Œ å‘ç°ç³»ç»Ÿæœ‰å¤šä¸ªkeychainï¼Œæ¯ä¸ªkeychainéƒ½æœ‰ä¸Šå›¾å¯¹åº”çš„é¡¹ç›®\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694375672261669437566402.png)\n\n\n# å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16692963470741669296346746.png)\nFigure 1 Putting data and attributes into a keychain\n\n\nkeychain å°†è¦å­˜å‚¨çš„æ•°æ®å°è£…ä¸º SecKeychainItemRefï¼Œé€šè¿‡å­˜å– SecKeychainItem æ¥è¾¾åˆ°å¯¹æ•°æ®çš„ç®¡ç†ã€‚\n\nSecKeychainItemRef åŒ…å«\n- dataï¼Œ CFDataï¼Œ è¦å­˜å–çš„æ•°æ®\n- attributes, è¯¥æ¡ç›®çš„å±æ€§ï¼Œå­˜å–æƒé™ï¼ŒæŸ¥è¯¢æ ‡ç­¾ç­‰\n\næä¾›çš„api\n\n```\n//æ·»åŠ \nOSStatus SecItemAdd(CFDictionaryRef attributes, CFTypeRef  _Nullable *result);\n//æŸ¥è¯¢\nOSStatus SecItemCopyMatching(CFDictionaryRef query, CFTypeRef  _Nullable *result);\n//æ›´æ–°\nOSStatus SecItemUpdate(CFDictionaryRef query, CFDictionaryRef attributesToUpdate);\n//åˆ é™¤\nOSStatus SecItemDelete(CFDictionaryRef query);\n\n```\n\n## SecItemAdd\n\n```\nOSStatus SecItemAdd(CFDictionaryRef attributes, CFTypeRef  _Nullable *result);\n```\n\n### å‚æ•°\n**attributes**\n\nä¸€ä¸ªå­—å…¸ï¼Œæè¿°è¦æ·»åŠ çš„æ•°æ®ï¼š\n- è¦æ·»åŠ æ•°æ®ç±»å‹ï¼Œå¯¹åº”çš„ key ä¸º`kSecClass`, value å¯ä»¥æ˜¯\n\t- kSecClassGenericPasswordï¼šé€šç”¨å¯†ç ï¼ˆå¯ä»¥ç”¨æ¥å­˜è‡ªå®šä¹‰æ•°æ®ï¼‰\n\t- kSecClassInternetPasswordï¼šäº’è”ç½‘å¯†ç \n\t- kSecClassCertificateï¼šè¯ä¹¦\n\t- kSecClassKeyï¼šç§˜é’¥\n\t- kSecClassIdentityï¼šè¯ä¹¦+ç§˜é’¥\n- æ•°æ·»åŠ çš„æ•°æ®æœ¬èº«, key ä¸º ` kSecValueData`, value ä¸º `CFDataRef` ç±»å‹\n- å…³è”çš„å±æ€§, å‚è€ƒï¼š[Item Attribute Keys and Values](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values?language=objc)\n\t- æ¯ç§ç±»å‹å…³è”çš„å±æ€§å¯ä»¥ä¸åŒï¼Œä¾‹å¦‚ kSecClassInternetPassword å¯ä»¥å…³è” `kSecAttrServer`, `kSecAttrPort`, `kSecAttrProtocol`ï¼Œ è€Œ `kSecClassGenericPassword`å°±æ²¡æœ‰è¿™äº›é€‰é¡¹\n\t-  `kSecAttrAccessGroup` å¯ä»¥æŒ‡å®šå­˜å…¥çš„keychain groupï¼Œè¿™ä¸ªä¼šå½±å“åˆ°æŸ¥è¯¢èŒƒå›´\n- æ·»åŠ åï¼Œè¿”å›æ·»åŠ ç»“æœçš„ç±»å‹ï¼ŒæŒ‡å®šç±»å‹çš„æ•°æ®ä¼šå­˜å…¥ result å­—æ®µã€‚å‚è€ƒï¼š[ Item Return Result Keys](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc)\n\n**result**\n\næ·»åŠ ç»“æŸï¼Œå‡½æ•°è¿”å›ï¼ŒæŒ‡å‘æ–°æ·»åŠ çš„æ¡ç›®ã€‚æ ¹æ® attributes ä¸­æŒ‡å®šçš„ç±»å‹ï¼Œè¿”å›å¯¹åº”çš„å€¼ã€‚å‚è€ƒï¼š [ Item Return Result Keys](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc)\n\nä¸€èˆ¬æ·»åŠ ä¸å…³å¿ƒæ–°æ¡ç›®ï¼Œä¼ nil\n\n### è¿”å›å€¼\n\næˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š[Security Framework Result Codes](https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc)\n\n### æ³¨æ„\n\n1. kSecAttrAccessGroup å¯ä»¥æŒ‡å®šæ·»åŠ åˆ° é’¥åŒ™ä¸²åˆ†ç»„ï¼Œè¯¥åˆ†ç»„ä¸­çš„æˆå‘˜å…±äº«è¯¥æ¡ç›®\n2. ä¸€æ¬¡æ·»åŠ å¤šæ¡ï¼Œå¯ä»¥ä½¿ç”¨`kSecUseItemList `ä¼ å…¥å­—å…¸æ•°ç»„ï¼Œä½†æ˜¯ä¸èƒ½ç”¨äºå¯†ç ç±»å‹\n3. æ·»åŠ æ˜¯åŒæ­¥æ‰§è¡Œï¼Œæ”¾åˆ°ä¸»çº¿ç¨‹å¯èƒ½ä¼šå¡ç•Œé¢ï¼Œå¯ä»¥ç”¨å¼‚æ­¥æ–¹å¼\n\n```\n- (void)addKeychainItemWithAttributes:(CFDictionaryRef)attrs completion:(void(^)(OSStatus status, CFTypeRef item))completion {\n    dispatch_async(backgroundQueue, ^{\n        CFTypeRef item = NULL;\n        OSStatus addResult = SecItemAdd(attrs, &item);\n        completion(addResult, item);\n        if (item) {\n            CFRelease(item);\n        }\n    });\n}\n```\n\n## SecItemCopyMatching\n\n```\nOSStatus SecItemCopyMatching(CFDictionaryRef query, CFTypeRef  _Nullable *result);\n```\n\né€šè¿‡ query æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ï¼Œå°†æŸ¥è¯¢ç»“æœå­˜å…¥ result ä¸­ã€‚\n\n### å‚æ•°\n\n**query**\nç”¨äºæŒ‡å®šæŸ¥è¯¢æ¡ä»¶\n- æŸ¥è¯¢çš„æ•°æ®ç±»å‹ï¼Œé€šè¿‡ `kSecClass` æŒ‡å®š\n- å…³è”çš„å±æ€§ï¼Œ ç”¨äºç¼©å°æŸ¥è¯¢èŒƒå›´\n- æŸ¥è¯¢å‚æ•°ï¼Œè¿”å›ä¸€æ¡è¿˜æ˜¯å¤šæ¡åŒ¹é…é¡¹ï¼Œæ˜¯å¦å¤§æ¶ˆæ¯æ•æ„Ÿï¼Œæˆ–è€…ä»ç‰¹å®šé¡¹ä¸­æœç´¢ã€‚å‚è€ƒï¼š [ Search Attribute Keys and Values](https://developer.apple.com/documentation/security/keychain_services/keychain_items/search_attribute_keys_and_values?language=objc)\n- æŒ‡å®šè¿”å›ç±»å‹ï¼ŒæŒ‡å®šçš„ç±»å‹ä¸åŒï¼Œresult ä¸­è¿”å›çš„ç±»å‹å°±ä¸åŒã€‚ å‚è€ƒï¼š [Item Return Result Keys ](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc)\n\n**result **\n\nä¿å­˜æŸ¥è¯¢ç»“æœã€‚\nä¾‹å¦‚ï¼š æŒ‡å®š  `kSecReturnData: kCFBooleanTrue`  ï¼Œresult ä¸­å­˜çš„å°±æ˜¯`CFDataRef `ç±»å‹çš„æ•°æ®ã€‚å‚è€ƒï¼š [Item Return Result Keys](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc)\n\n### è¿”å›å€¼\n\næˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š[Security Framework Result Codes](https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc)\n\n### æ³¨æ„\n\n1. é»˜è®¤è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œå¦‚æœæƒ³æŸ¥è¯¢å¤šæ¡åŒ¹é…ï¼ŒæŒ‡å®š `kSecMatchLimit`  å¤§äº1ï¼Œ æ­¤æ—¶ result ä¸º `CFArrayRef`  ç±»å‹\n2. å½“ç±»å‹ä¸º`kSecInternetPasswordItemClass` æˆ– `kSecGenericPasswordItemClass`æ—¶ï¼Œ ä¸èƒ½åŒæ—¶æŒ‡å®š`kSecReturnData` å’Œ `kSecMatchLimitAll`, åŸå› æ˜¯æ‹·è´æ¯ä¸ªå¯†ç æ—¶ï¼Œéœ€è¦é¢å¤–çš„æˆæƒéªŒè¯ã€‚\n3. é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šæœç´¢å½“å‰keychain ä»¥åŠæ‰€æœ‰åŠ å…¥çš„ keychain groupï¼Œ é€šè¿‡ `kSecAttrAccessGroup` å¯ä»¥æŒ‡å®šè¦åœ¨å“ªä¸ª keychain group æŸ¥è¯¢\n4. ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ\n\n```\n- (void)findKeychainItemWithAttributes:(NSDictionary *)attributes completion:(void(^)(OSStatus status, CFTypeRef item))completion {\n    dispatch_async(backgroundQueue, ^{\n        CFDictionaryRef attrs = (__bridge CFDictionaryRef)attributes;\n        CFTypeRef item = NULL;\n        OSStatus result = SecItemCopyMatching(attrs, &item);\n        completion(result, item);\n        CFRelease(item);\n    });\n}\n```\n\n\n## SecItemUpdate\n\n```\nOSStatus SecItemUpdate(CFDictionaryRef query, CFDictionaryRef attributesToUpdate);\n```\n\n### å‚æ•°\n\n**query**\n\nç”¨æ¥æŒ‡å®šè¦æ›´æ–°çš„æ¡ç›®, æ‰§è¡Œæ›´æ–°ï¼Œéœ€è¦å…ˆæŸ¥è¯¢åˆ°è¦æ›´æ–°çš„æ¡ç›®ã€‚\nå‚è€ƒ SecItemCopyMatching å¦‚ä½•æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ã€‚\n\n**attributesToUpdate**\n\næŒ‡å®šéœ€è¦æ›´æ–°çš„å±æ€§ã€‚\n\n### è¿”å›å€¼\n\næˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š[Security Framework Result Codes](https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc)\n\n### æ³¨æ„\n\nä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ\n```\n- (void)updateKeyChainItemWithAttributes:(CFDictionaryRef)attrs update:(CFDictionaryRef)update completion:(void(^)(OSStatus status))completion {\n    dispatch_async(backgroundQueue, ^{\n        OSStatus updateResult = SecItemUpdate(attrs, update);\n        completion(updateResult);\n    });\n}\n```\n\n## SecItemDelete\n\n```\nOSStatus SecItemDelete(CFDictionaryRef query);\n```\n\n### å‚æ•°\n\n**query**\n\nç”¨æ¥æŒ‡å®šè¦åˆ é™¤çš„çš„æ¡ç›®ï¼Œ å‚è€ƒSecItemCopyMatching å¦‚ä½•æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ã€‚\n\n### è¿”å›å€¼\n\næˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š[Security Framework Result Codes](https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc)\n\n### æ³¨æ„\n\n1. é»˜è®¤åˆ é™¤æ‰€æœ‰çš„åŒ¹é…é¡¹ï¼Œ\n2. å¯ä»¥é€šè¿‡æŒ‡å®š`kSecMatchItemList `æ¥é™å®šåˆ é™¤èŒƒå›´ï¼Œ `kSecMatchItemList`å¯¹åº”çš„å€¼çš„ç±»å‹ä¸º`CFArrayRef `, æ•°ç»„ä¸­æ¯ä¸€é¡¹çš„ç±»å‹å¿…é¡»ç›¸åŒï¼Œ\n\t- é’ˆå¯¹ä¸´æ—¶å¼•ç”¨ï¼Œæ¯ä¸€é¡¹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¼•ç”¨çš„ç±»å‹å¯ä»¥æ˜¯\n\t\t- SecKeychainItemRef,\n\t\t-  SecKeyRef\n\t\t-   SecCertificateRef\n\t\t-   SecIdentityRef\n\t\t-   CFDataRef\n\t- é’ˆå¯¹æŒä¹…åŒ–å¼•ç”¨, å¼•ç”¨çš„å¿…é¡»æ˜¯ç±»å‹æ˜¯ `CFDataRef`\n3. ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ\n\n```\n- (void)deleteKeychainItemWithAttributes:(CFDictionaryRef)attrs completion:(void(^)(OSStatus status))completion {\n    dispatch_async(backgroundQueue, ^{\n        OSStatus deleteResult = SecItemDelete(attrs);\n        completion(deleteResult);\n    });\n}\n```\n\n### ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\n\n**ä¸´æ—¶å¼•ç”¨**\n\nå¯¹åº”çš„ key  å€¼æ˜¯`kSecReturnRef`\n\n> The corresponding value is of type `CFBooleanRef`. A value of `kCFBooleanTrue` indicates that a reference should be returned. Depending on the item class requested, the returned references may be of type `SecKeychainItemRef`, `SecKeyRef`, `SecCertificateRef`, `SecIdentityRef`, or `CFDataRef`.\n\n\nç¤ºä¾‹ ï¼šSecCertificateRef è¯ä¹¦å¯¹è±¡çš„å¼•ç”¨åœ¨keychainä¸­å­˜å–\n\nåˆ›å»ºSecCertificateRef\n\n```\nSecCertificateRef certificate =\n    SecCertificateCreateWithData(NULL, (__bridge CFDataRef)certData);\n\t\t \nif (certificate)  { CFRelease(certificate); } // After you are done with it\n```\n\nå°†è¯ä¹¦å­˜å…¥keychain\n```\nNSDictionary* addquery = @{ (id)kSecValueRef:   (__bridge id)certificate,\n                            (id)kSecClass:      (id)kSecClassCertificate,\n                            (id)kSecAttrLabel:  @\"My Certificate\",\n                           };\n\t\t\t\t\t\t   \n\t\t\t\t\t\t   \nOSStatus status = SecItemAdd((__bridge CFDictionaryRef)addquery, NULL);\nif (status != errSecSuccess) {\n    // Handle the error\n}\t\t\t\t\t\t   \n```\n\nä»keychainè¯»å–è¯ä¹¦\n```\nNSDictionary *getquery = @{ (id)kSecClass:     (id)kSecClassCertificate,\n                            (id)kSecAttrLabel: @\"My Certificate\",\n                            (id)kSecReturnRef: @YES,\n                            };\nSecCertificateRef certificate = NULL;\nOSStatus status = SecItemCopyMatching((__bridge CFDictionaryRef)getquery,\n                                      (CFTypeRef *)&certificate);\nif (status != errSecSuccess) { <# Handle error #> }\nelse                         { <# Use certificate #> }\n \nif (certificate) { CFRelease(certificate); } // After you are done with it\n```\n\nè§‚å¯Ÿåˆ°è¿™é‡Œç”¨çš„å°±æ˜¯ `kSecReturnRef`, ä»£è¡¨ä¸´æ—¶å¼•ç”¨ã€‚\n\n- SecKeychainItemRef,\n- SecKeyRef\n-  SecCertificateRef\n-  SecIdentityRef\n-  CFDataRef\n\n**æŒä¹…åŒ–å¼•ç”¨**\n\nkey ä¸º kSecReturnPersistentRefã€‚\n> The corresponding value is of type `CFBooleanRef`. A value of kCFBooleanTrue indicates that a persistent reference to an item should be returned as a `CFDataRef` object. Unlike normal references, a persistent reference may be stored on disk or passed between processes.\n\n1. ä¸€ä¸ªæŒä¹…åŒ–å¼•ç”¨ï¼Œå¼•ç”¨çš„å¯¹è±¡å¿…é¡»æ˜¯`CFDataRef`\n2. æŒä¹…åŒ–å¼•ç”¨å¯ä»¥å­˜å‚¨åœ¨ç£ç›˜ï¼Œå¯ä»¥è·¨è¿›ç¨‹ä¼ é€’\n\n\n# ç¤ºä¾‹\n\n##  [Adding a Password to the Keychain](https://developer.apple.com/documentation/security/keychain_services/keychain_items/adding_a_password_to_the_keychain?language=objc)\n\n```\nstruct Credentials {\n    var username: String\n    var password: String\n}\n\nenum KeychainError: Error {\n    case noPassword\n    case unexpectedPasswordData\n    case unhandledError(status: OSStatus)\n}\n\nstatic let server = \"www.example.com\"\n\nlet account = credentials.username\nlet password = credentials.password.data(using: String.Encoding.utf8)!\nvar query: [String: Any] = [kSecClass as String: kSecClassInternetPassword,\n                            kSecAttrAccount as String: account,\n                            kSecAttrServer as String: server,\n                            kSecValueData as String: password]\nlet status = SecItemAdd(query as CFDictionary, nil)\nguard status == errSecSuccess else { throw KeychainError.unhandledError(status: status) }\n\n```\n\n## [Searching for Keychain Items](https://developer.apple.com/documentation/security/keychain_services/keychain_items/searching_for_keychain_items?language=objc)\n\n```\nlet query: [String: Any] = [kSecClass as String: kSecClassInternetPassword,\n                            kSecAttrServer as String: server,\n                            kSecMatchLimit as String: kSecMatchLimitOne,\n                            kSecReturnAttributes as String: true,\n                            kSecReturnData as String: true]\n\nvar item: CFTypeRef?\nlet status = SecItemCopyMatching(query as CFDictionary, &item)\nguard status != errSecItemNotFound else { throw KeychainError.noPassword }\nguard status == errSecSuccess else { throw KeychainError.unhandledError(status: status) }\n\nguard let existingItem = item as? [String : Any],\n    let passwordData = existingItem[kSecValueData as String] as? Data,\n    let password = String(data: passwordData, encoding: String.Encoding.utf8),\n    let account = existingItem[kSecAttrAccount as String] as? String\nelse {\n    throw KeychainError.unexpectedPasswordData\n}\nlet credentials = Credentials(username: account, password: password)\n\n```\n\n## [Updating and Deleting Keychain Items](https://developer.apple.com/documentation/security/keychain_services/keychain_items/updating_and_deleting_keychain_items?language=objc)\n\n```\nlet query: [String: Any] = [kSecClass as String: kSecClassInternetPassword,\n                            kSecAttrServer as String: server]\n\t\t\t\t\t\t\t\nlet account = credentials.username\nlet password = credentials.password.data(using: String.Encoding.utf8)!\nlet attributes: [String: Any] = [kSecAttrAccount as String: account,\n                                 kSecValueData as String: password]\n\n//update\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t \nlet status = SecItemUpdate(query as CFDictionary, attributes as CFDictionary)\nguard status != errSecItemNotFound else { throw KeychainError.noPassword }\nguard status == errSecSuccess else { throw KeychainError.unhandledError(status: status) }\t\n\n//delete\nlet status = SecItemDelete(query as CFDictionary)\nguard status == errSecSuccess || status == errSecItemNotFound else { throw KeychainError.unhandledError(status: status) }\n```\n\n# keychain group & app group\n\nå‚è€ƒï¼š[Sharing Access to Keychain Items Among a Collection of Apps](https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps?language=objc)\n\n\n> Enable apps to share keychain items with each other by adding the apps to an access group.\n\né€šè¿‡keychain group å¯ä»¥åœ¨ app é—´å…±äº«keychain itemã€‚\n\n> An access group is a logical collection of apps tagged with a particular group name string. Any app in a given group can share keychain items with all the other apps in the same group. You can add an app to any number of groups, but the app is always part of at least one group that contains only itself. That is, an app can always store and retrieve private keychain items, regardless of whether it also participates in any other groups. Keychain items, on the other hand, are always part of exactly one group.\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œapp åŠ å…¥äº†ä»¥è‡ªèº«id ä¸ºæ ‡è®°çš„åˆ†ç»„ä¸­ï¼Œè¿™ä¸ªåˆ†ç»„ä¸­çš„æ‰€æœ‰ keychain item ä»…é™app è‡ªèº«è®¿é—®ã€‚\n\né€šè¿‡åŠ å…¥å…¶ä»–åˆ†ç»„ï¼Œapp é—´å¯ä»¥é€šè¿‡ keychain group å…±äº« keychain itemã€‚\n\n ## keychain group ç±»å‹\n\nYou control the groups that your app belongs to by manipulating its entitlements. In particular, an app belongs to all the groups named in a virtual array of strings that the system forms for each app as the concatenation of the following items, evaluated in this order:\n\n**Keychain access groups**\nThe optional Keychain Access Groups Entitlement holds an array of strings, each of which names an access group.\n\n\næ˜¾ç¤ºæŒ‡å®šåŠ å…¥çš„ keychain groupï¼Œ group idä¸º `[$(teamID).$(keychain group id)]`\n\n**Application identifier**\nXcode automatically adds the application-identifier entitlement (or the com.apple.application-identifier entitlement in macOS) to every app during code signing, formed as the team identifier (team ID) plus the bundle identifier (bundle ID).\n\néšå¼çš„åŠ å…¥äº†ä»¥è‡ªèº«ä¸ºç»„çš„ keychain group,  group idä¸º `[$(teamID).$(bundle ID)]`\n\n**Application groups**\nWhen you collect related apps into an application group using the App Groups Entitlement, they share access to a group container, and gain the ability to message each other in certain ways. Starting in iOS 8, the array of strings given by this entitlement also extends the list of keychain access groups.\n\nç”±äºåŠ å…¥äº†app groupï¼Œ éšå¼çš„åŠ å…¥äº†ä»¥ app group ä¸ºç»„çš„ keychain group,  group idä¸º `[$(app group id)]`\n\nXcode handles the application identifier (app ID) for you when you set the bundle ID. You set the others by manipulating capabilities in Xcode.\n\næ·»åŠ keychain group å’Œ app group å¯ä»¥åœ¨xcode ä¸­é€šè¿‡æ“ä½œcapabilitiesæ¥å®ç°ã€‚\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694538450341669453844996.png)\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694538730181669453872352.png)\n\n## app group å’Œ keychain group åŒºåˆ«\nApp groups and keychain access groups arenâ€™t mutually exclusiveâ€”you can use both in the same appâ€”but they do differ in several important ways that may help you decide which to use for a given situation.\n\nä¸¤è€…ä¸æ˜¯äº’ç›¸æ’æ–¥çš„ï¼Œ ä¸€ä¸ªappå¯ä»¥åŒæ—¶åŠ å…¥keychain group å’Œ app groupã€‚\n\n\nFirst, as described above, using an app group enables additional data sharing beyond keychain items. You might want this extra sharing, or might already be using an app group for this purpose, and thus not need to add keychain access groups. On the other hand, you might not want to enable this additional sharing at all, and prefer keychain access groups instead.\n\napp group é™¤äº†å…±äº« keychain item ä¹‹å¤–ï¼Œè¿˜èƒ½å…±äº«å…¶ä»–å†…å®¹ï¼Œä¾‹å¦‚å…±äº«åå¥½è®¾ç½®\n```\nlet userDefualts = UserDefaults.init(suiteName: \"$(group_Id)\")\nuserDefualts?.setValue(data, forKey: key)\nuserDefualts?.synchronize()\n```\n\n\nSecond, order matters. The system considers the first item in the list of access groups to be the appâ€™s default access group. This is the access group that keychain services assumes if you donâ€™t otherwise specify one when adding keychain items. An app group canâ€™t ever be the default, because the app ID is always present and appears earlier in the list. However, a keychain access group can be the default, because it appears before the app ID. In particular, the first keychain access group, if any, that you specify in the corresponding capability becomes the appâ€™s default access group. If you donâ€™t specify any keychain access groups, then the app ID is the default.\n\n\nå…³äºé»˜è®¤ groupï¼Œ å½“æ·»åŠ ï¼ŒæŸ¥è¯¢ï¼Œæ›´æ–°ï¼Œåˆ é™¤ keychain item æ—¶ï¼Œä¸æŒ‡å®š`kSecAttrAccessGroup `æ—¶ï¼Œé»˜è®¤æ“ä½œçš„æ˜¯å“ªä¸ªgroup ï¼Ÿ\n\n1.  ç³»ç»Ÿä»¥ group list æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªä¸ºé»˜è®¤ group\n2.  é»˜è®¤group ä¸ä¼šæ˜¯app groupï¼Œ å› ä¸ºå®ƒä¸ä¼šæ˜¯ç¬¬ä¸€ä¸ª\n3.  å¦‚æœåŠ å…¥keychain groupï¼Œ è¯¥ keychain group å¯èƒ½ä¸ºé»˜è®¤çš„ keychain group\n4.  æƒ³é™å®škeychain item åªåœ¨ app å†…è®¿é—®ï¼Œä¸èƒ½è¢«keychain group è®¿é—®ï¼Œéœ€è¦å°† bundle id æ‰€åœ¨çš„keychain group ç½®é¡¶ï¼Œæˆ–è€…æ˜ç¡®æŒ‡å®šä½¿ç”¨ bundle id æ ‡è®°çš„keychain group\n","slug":"ios/2022-11-26-ios keychain æ€»ç»“","published":1,"updated":"2024-03-06T11:53:13.567Z","comments":1,"photos":[],"_id":"clti3glko001j57whh72i1pfn","content":"<h1 id=\"Keychain-æ˜¯ä»€ä¹ˆ\"><a href=\"#Keychain-æ˜¯ä»€ä¹ˆ\" class=\"headerlink\" title=\"Keychain  æ˜¯ä»€ä¹ˆ\"></a>Keychain  æ˜¯ä»€ä¹ˆ</h1><p>ä¸€ä¸ªåŠ å¯†çš„æ•°æ®åº“ï¼Œ å¯ä»¥ç”¨æ¥å­˜å‚¨å°çš„ç”¨æˆ·æ•°æ®ï¼Œ åŒ…æ‹¬</p>\n<ul>\n<li>kSecClassGenericPasswordï¼šé€šç”¨å¯†ç ï¼ˆå¯ä»¥ç”¨æ¥å­˜è‡ªå®šä¹‰æ•°æ®ï¼‰</li>\n<li>kSecClassInternetPasswordï¼šäº’è”ç½‘å¯†ç </li>\n<li>kSecClassCertificateï¼šè¯ä¹¦</li>\n<li>kSecClassKeyï¼šç§˜é’¥</li>\n<li>kSecClassIdentityï¼šè¯ä¹¦+ç§˜é’¥</li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16692950150511669295014987.png\"><br>Figure 1 Securing the userâ€™s secrets in a keychain</p>\n<p>æ‰“å¼€ mac ç³»ç»Ÿçš„ keychain è§‚å¯Ÿä¸€ä¸‹ï¼Œ å‘ç°ç³»ç»Ÿæœ‰å¤šä¸ªkeychainï¼Œæ¯ä¸ªkeychainéƒ½æœ‰ä¸Šå›¾å¯¹åº”çš„é¡¹ç›®<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694375672261669437566402.png\"></p>\n<h1 id=\"å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹\"><a href=\"#å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹\" class=\"headerlink\" title=\"å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹\"></a>å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹</h1><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16692963470741669296346746.png\"><br>Figure 1 Putting data and attributes into a keychain</p>\n<p>keychain å°†è¦å­˜å‚¨çš„æ•°æ®å°è£…ä¸º SecKeychainItemRefï¼Œé€šè¿‡å­˜å– SecKeychainItem æ¥è¾¾åˆ°å¯¹æ•°æ®çš„ç®¡ç†ã€‚</p>\n<p>SecKeychainItemRef åŒ…å«</p>\n<ul>\n<li>dataï¼Œ CFDataï¼Œ è¦å­˜å–çš„æ•°æ®</li>\n<li>attributes, è¯¥æ¡ç›®çš„å±æ€§ï¼Œå­˜å–æƒé™ï¼ŒæŸ¥è¯¢æ ‡ç­¾ç­‰</li>\n</ul>\n<p>æä¾›çš„api</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-comment\">//æ·»åŠ </span><br>OSStatus <span class=\"hljs-built_in\">SecItemAdd</span>(CFDictionaryRef attributes, CFTypeRef  _Nullable *result);<br><span class=\"hljs-comment\">//æŸ¥è¯¢</span><br>OSStatus <span class=\"hljs-built_in\">SecItemCopyMatching</span>(CFDictionaryRef query, CFTypeRef  _Nullable *result);<br><span class=\"hljs-comment\">//æ›´æ–°</span><br>OSStatus <span class=\"hljs-built_in\">SecItemUpdate</span>(CFDictionaryRef query, CFDictionaryRef attributesToUpdate);<br><span class=\"hljs-comment\">//åˆ é™¤</span><br>OSStatus <span class=\"hljs-built_in\">SecItemDelete</span>(CFDictionaryRef query);<br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"SecItemAdd\"><a href=\"#SecItemAdd\" class=\"headerlink\" title=\"SecItemAdd\"></a>SecItemAdd</h2><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\">OSStatus SecItemAdd(<span class=\"hljs-built_in\">CFDictionaryRef</span> attributes, <span class=\"hljs-built_in\">CFTypeRef</span>  _Nullable *result);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"å‚æ•°\"><a href=\"#å‚æ•°\" class=\"headerlink\" title=\"å‚æ•°\"></a>å‚æ•°</h3><p><strong>attributes</strong></p>\n<p>ä¸€ä¸ªå­—å…¸ï¼Œæè¿°è¦æ·»åŠ çš„æ•°æ®ï¼š</p>\n<ul>\n<li>è¦æ·»åŠ æ•°æ®ç±»å‹ï¼Œå¯¹åº”çš„ key ä¸º<code>kSecClass</code>, value å¯ä»¥æ˜¯<ul>\n<li>kSecClassGenericPasswordï¼šé€šç”¨å¯†ç ï¼ˆå¯ä»¥ç”¨æ¥å­˜è‡ªå®šä¹‰æ•°æ®ï¼‰</li>\n<li>kSecClassInternetPasswordï¼šäº’è”ç½‘å¯†ç </li>\n<li>kSecClassCertificateï¼šè¯ä¹¦</li>\n<li>kSecClassKeyï¼šç§˜é’¥</li>\n<li>kSecClassIdentityï¼šè¯ä¹¦+ç§˜é’¥</li>\n</ul>\n</li>\n<li>æ•°æ·»åŠ çš„æ•°æ®æœ¬èº«, key ä¸º <code> kSecValueData</code>, value ä¸º <code>CFDataRef</code> ç±»å‹</li>\n<li>å…³è”çš„å±æ€§, å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values?language=objc\">Item Attribute Keys and Values</a><ul>\n<li>æ¯ç§ç±»å‹å…³è”çš„å±æ€§å¯ä»¥ä¸åŒï¼Œä¾‹å¦‚ kSecClassInternetPassword å¯ä»¥å…³è” <code>kSecAttrServer</code>, <code>kSecAttrPort</code>, <code>kSecAttrProtocol</code>ï¼Œ è€Œ <code>kSecClassGenericPassword</code>å°±æ²¡æœ‰è¿™äº›é€‰é¡¹</li>\n<li><code>kSecAttrAccessGroup</code> å¯ä»¥æŒ‡å®šå­˜å…¥çš„keychain groupï¼Œè¿™ä¸ªä¼šå½±å“åˆ°æŸ¥è¯¢èŒƒå›´</li>\n</ul>\n</li>\n<li>æ·»åŠ åï¼Œè¿”å›æ·»åŠ ç»“æœçš„ç±»å‹ï¼ŒæŒ‡å®šç±»å‹çš„æ•°æ®ä¼šå­˜å…¥ result å­—æ®µã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc\"> Item Return Result Keys</a></li>\n</ul>\n<p><strong>result</strong></p>\n<p>æ·»åŠ ç»“æŸï¼Œå‡½æ•°è¿”å›ï¼ŒæŒ‡å‘æ–°æ·»åŠ çš„æ¡ç›®ã€‚æ ¹æ® attributes ä¸­æŒ‡å®šçš„ç±»å‹ï¼Œè¿”å›å¯¹åº”çš„å€¼ã€‚å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc\"> Item Return Result Keys</a></p>\n<p>ä¸€èˆ¬æ·»åŠ ä¸å…³å¿ƒæ–°æ¡ç›®ï¼Œä¼ nil</p>\n<h3 id=\"è¿”å›å€¼\"><a href=\"#è¿”å›å€¼\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h3><p>æˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc\">Security Framework Result Codes</a></p>\n<h3 id=\"æ³¨æ„\"><a href=\"#æ³¨æ„\" class=\"headerlink\" title=\"æ³¨æ„\"></a>æ³¨æ„</h3><ol>\n<li>kSecAttrAccessGroup å¯ä»¥æŒ‡å®šæ·»åŠ åˆ° é’¥åŒ™ä¸²åˆ†ç»„ï¼Œè¯¥åˆ†ç»„ä¸­çš„æˆå‘˜å…±äº«è¯¥æ¡ç›®</li>\n<li>ä¸€æ¬¡æ·»åŠ å¤šæ¡ï¼Œå¯ä»¥ä½¿ç”¨<code>kSecUseItemList </code>ä¼ å…¥å­—å…¸æ•°ç»„ï¼Œä½†æ˜¯ä¸èƒ½ç”¨äºå¯†ç ç±»å‹</li>\n<li>æ·»åŠ æ˜¯åŒæ­¥æ‰§è¡Œï¼Œæ”¾åˆ°ä¸»çº¿ç¨‹å¯èƒ½ä¼šå¡ç•Œé¢ï¼Œå¯ä»¥ç”¨å¼‚æ­¥æ–¹å¼</li>\n</ol>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">- (void)addKeychainItemWithAttributes:(CFDictionaryRef)attrs completion:(<span class=\"hljs-built_in\">void</span>(^)(OSStatus status, CFTypeRef item))completion &#123;<br>    <span class=\"hljs-built_in\">dispatch_async</span>(backgroundQueue, ^&#123;<br>        CFTypeRef item = NULL;<br>        OSStatus addResult = SecItemAdd(attrs, &amp;item);<br>        <span class=\"hljs-built_in\">completion</span>(addResult, item);<br>        if (item) &#123;<br>            <span class=\"hljs-built_in\">CFRelease</span>(item);<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"SecItemCopyMatching\"><a href=\"#SecItemCopyMatching\" class=\"headerlink\" title=\"SecItemCopyMatching\"></a>SecItemCopyMatching</h2><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\">OSStatus SecItemCopyMatching(<span class=\"hljs-built_in\">CFDictionaryRef</span> query, <span class=\"hljs-built_in\">CFTypeRef</span>  _Nullable *result);<br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡ query æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ï¼Œå°†æŸ¥è¯¢ç»“æœå­˜å…¥ result ä¸­ã€‚</p>\n<h3 id=\"å‚æ•°-1\"><a href=\"#å‚æ•°-1\" class=\"headerlink\" title=\"å‚æ•°\"></a>å‚æ•°</h3><p><strong>query</strong><br>ç”¨äºæŒ‡å®šæŸ¥è¯¢æ¡ä»¶</p>\n<ul>\n<li>æŸ¥è¯¢çš„æ•°æ®ç±»å‹ï¼Œé€šè¿‡ <code>kSecClass</code> æŒ‡å®š</li>\n<li>å…³è”çš„å±æ€§ï¼Œ ç”¨äºç¼©å°æŸ¥è¯¢èŒƒå›´</li>\n<li>æŸ¥è¯¢å‚æ•°ï¼Œè¿”å›ä¸€æ¡è¿˜æ˜¯å¤šæ¡åŒ¹é…é¡¹ï¼Œæ˜¯å¦å¤§æ¶ˆæ¯æ•æ„Ÿï¼Œæˆ–è€…ä»ç‰¹å®šé¡¹ä¸­æœç´¢ã€‚å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/search_attribute_keys_and_values?language=objc\"> Search Attribute Keys and Values</a></li>\n<li>æŒ‡å®šè¿”å›ç±»å‹ï¼ŒæŒ‡å®šçš„ç±»å‹ä¸åŒï¼Œresult ä¸­è¿”å›çš„ç±»å‹å°±ä¸åŒã€‚ å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc\">Item Return Result Keys </a></li>\n</ul>\n<p>**result **</p>\n<p>ä¿å­˜æŸ¥è¯¢ç»“æœã€‚<br>ä¾‹å¦‚ï¼š æŒ‡å®š  <code>kSecReturnData: kCFBooleanTrue</code>  ï¼Œresult ä¸­å­˜çš„å°±æ˜¯<code>CFDataRef </code>ç±»å‹çš„æ•°æ®ã€‚å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc\">Item Return Result Keys</a></p>\n<h3 id=\"è¿”å›å€¼-1\"><a href=\"#è¿”å›å€¼-1\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h3><p>æˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc\">Security Framework Result Codes</a></p>\n<h3 id=\"æ³¨æ„-1\"><a href=\"#æ³¨æ„-1\" class=\"headerlink\" title=\"æ³¨æ„\"></a>æ³¨æ„</h3><ol>\n<li>é»˜è®¤è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œå¦‚æœæƒ³æŸ¥è¯¢å¤šæ¡åŒ¹é…ï¼ŒæŒ‡å®š <code>kSecMatchLimit</code>  å¤§äº1ï¼Œ æ­¤æ—¶ result ä¸º <code>CFArrayRef</code>  ç±»å‹</li>\n<li>å½“ç±»å‹ä¸º<code>kSecInternetPasswordItemClass</code> æˆ– <code>kSecGenericPasswordItemClass</code>æ—¶ï¼Œ ä¸èƒ½åŒæ—¶æŒ‡å®š<code>kSecReturnData</code> å’Œ <code>kSecMatchLimitAll</code>, åŸå› æ˜¯æ‹·è´æ¯ä¸ªå¯†ç æ—¶ï¼Œéœ€è¦é¢å¤–çš„æˆæƒéªŒè¯ã€‚</li>\n<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šæœç´¢å½“å‰keychain ä»¥åŠæ‰€æœ‰åŠ å…¥çš„ keychain groupï¼Œ é€šè¿‡ <code>kSecAttrAccessGroup</code> å¯ä»¥æŒ‡å®šè¦åœ¨å“ªä¸ª keychain group æŸ¥è¯¢</li>\n<li>ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ</li>\n</ol>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\">- (<span class=\"hljs-type\">void</span>)findKeychainItemWithAttributes:(<span class=\"hljs-built_in\">NSDictionary</span> *)attributes completion:(<span class=\"hljs-type\">void</span>(^)(OSStatus status, <span class=\"hljs-built_in\">CFTypeRef</span> item))completion &#123;<br>    <span class=\"hljs-built_in\">dispatch_async</span>(backgroundQueue, ^&#123;<br>        <span class=\"hljs-built_in\">CFDictionaryRef</span> attrs = (__bridge <span class=\"hljs-built_in\">CFDictionaryRef</span>)attributes;<br>        <span class=\"hljs-built_in\">CFTypeRef</span> item = <span class=\"hljs-literal\">NULL</span>;<br>        OSStatus result = SecItemCopyMatching(attrs, &amp;item);<br>        completion(result, item);<br>        <span class=\"hljs-built_in\">CFRelease</span>(item);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n\n<h2 id=\"SecItemUpdate\"><a href=\"#SecItemUpdate\" class=\"headerlink\" title=\"SecItemUpdate\"></a>SecItemUpdate</h2><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\">OSStatus SecItemUpdate(<span class=\"hljs-built_in\">CFDictionaryRef</span> query, <span class=\"hljs-built_in\">CFDictionaryRef</span> attributesToUpdate);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"å‚æ•°-2\"><a href=\"#å‚æ•°-2\" class=\"headerlink\" title=\"å‚æ•°\"></a>å‚æ•°</h3><p><strong>query</strong></p>\n<p>ç”¨æ¥æŒ‡å®šè¦æ›´æ–°çš„æ¡ç›®, æ‰§è¡Œæ›´æ–°ï¼Œéœ€è¦å…ˆæŸ¥è¯¢åˆ°è¦æ›´æ–°çš„æ¡ç›®ã€‚<br>å‚è€ƒ SecItemCopyMatching å¦‚ä½•æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ã€‚</p>\n<p><strong>attributesToUpdate</strong></p>\n<p>æŒ‡å®šéœ€è¦æ›´æ–°çš„å±æ€§ã€‚</p>\n<h3 id=\"è¿”å›å€¼-2\"><a href=\"#è¿”å›å€¼-2\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h3><p>æˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc\">Security Framework Result Codes</a></p>\n<h3 id=\"æ³¨æ„-2\"><a href=\"#æ³¨æ„-2\" class=\"headerlink\" title=\"æ³¨æ„\"></a>æ³¨æ„</h3><p>ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">- (void)updateKeyChainItemWithAttributes:(CFDictionaryRef)attrs update:(CFDictionaryRef)update completion:(<span class=\"hljs-built_in\">void</span>(^)(OSStatus status))completion &#123;<br>    <span class=\"hljs-built_in\">dispatch_async</span>(backgroundQueue, ^&#123;<br>        OSStatus updateResult = SecItemUpdate(attrs, update);<br>        <span class=\"hljs-built_in\">completion</span>(updateResult);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"SecItemDelete\"><a href=\"#SecItemDelete\" class=\"headerlink\" title=\"SecItemDelete\"></a>SecItemDelete</h2><figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">OSStatus <span class=\"hljs-built_in\">SecItemDelete</span>(CFDictionaryRef query);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"å‚æ•°-3\"><a href=\"#å‚æ•°-3\" class=\"headerlink\" title=\"å‚æ•°\"></a>å‚æ•°</h3><p><strong>query</strong></p>\n<p>ç”¨æ¥æŒ‡å®šè¦åˆ é™¤çš„çš„æ¡ç›®ï¼Œ å‚è€ƒSecItemCopyMatching å¦‚ä½•æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ã€‚</p>\n<h3 id=\"è¿”å›å€¼-3\"><a href=\"#è¿”å›å€¼-3\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h3><p>æˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc\">Security Framework Result Codes</a></p>\n<h3 id=\"æ³¨æ„-3\"><a href=\"#æ³¨æ„-3\" class=\"headerlink\" title=\"æ³¨æ„\"></a>æ³¨æ„</h3><ol>\n<li>é»˜è®¤åˆ é™¤æ‰€æœ‰çš„åŒ¹é…é¡¹ï¼Œ</li>\n<li>å¯ä»¥é€šè¿‡æŒ‡å®š<code>kSecMatchItemList </code>æ¥é™å®šåˆ é™¤èŒƒå›´ï¼Œ <code>kSecMatchItemList</code>å¯¹åº”çš„å€¼çš„ç±»å‹ä¸º<code>CFArrayRef </code>, æ•°ç»„ä¸­æ¯ä¸€é¡¹çš„ç±»å‹å¿…é¡»ç›¸åŒï¼Œ<ul>\n<li>é’ˆå¯¹ä¸´æ—¶å¼•ç”¨ï¼Œæ¯ä¸€é¡¹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¼•ç”¨çš„ç±»å‹å¯ä»¥æ˜¯<ul>\n<li>SecKeychainItemRef,</li>\n<li>SecKeyRef</li>\n<li>SecCertificateRef</li>\n<li>SecIdentityRef</li>\n<li>CFDataRef</li>\n</ul>\n</li>\n<li>é’ˆå¯¹æŒä¹…åŒ–å¼•ç”¨, å¼•ç”¨çš„å¿…é¡»æ˜¯ç±»å‹æ˜¯ <code>CFDataRef</code></li>\n</ul>\n</li>\n<li>ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ</li>\n</ol>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">- (void)deleteKeychainItemWithAttributes:(CFDictionaryRef)attrs completion:(<span class=\"hljs-built_in\">void</span>(^)(OSStatus status))completion &#123;<br>    <span class=\"hljs-built_in\">dispatch_async</span>(backgroundQueue, ^&#123;<br>        OSStatus deleteResult = SecItemDelete(attrs);<br>        <span class=\"hljs-built_in\">completion</span>(deleteResult);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\"><a href=\"#ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\" class=\"headerlink\" title=\"ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\"></a>ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p><strong>ä¸´æ—¶å¼•ç”¨</strong></p>\n<p>å¯¹åº”çš„ key  å€¼æ˜¯<code>kSecReturnRef</code></p>\n<blockquote>\n<p>The corresponding value is of type <code>CFBooleanRef</code>. A value of <code>kCFBooleanTrue</code> indicates that a reference should be returned. Depending on the item class requested, the returned references may be of type <code>SecKeychainItemRef</code>, <code>SecKeyRef</code>, <code>SecCertificateRef</code>, <code>SecIdentityRef</code>, or <code>CFDataRef</code>.</p>\n</blockquote>\n<p>ç¤ºä¾‹ ï¼šSecCertificateRef è¯ä¹¦å¯¹è±¡çš„å¼•ç”¨åœ¨keychainä¸­å­˜å–</p>\n<p>åˆ›å»ºSecCertificateRef</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\">SecCertificateRef certificate =<br>    SecCertificateCreateWithData<span class=\"hljs-comment\">(NULL, (__bridge CFDataRef)</span>certData);<br>\t\t <br><span class=\"hljs-keyword\">if</span> <span class=\"hljs-comment\">(certificate)</span>  &#123; CFRelease<span class=\"hljs-comment\">(certificate)</span>; &#125; <span class=\"hljs-comment\">// After you are done with it</span><br></code></pre></td></tr></table></figure>\n\n<p>å°†è¯ä¹¦å­˜å…¥keychain</p>\n<figure class=\"highlight fsharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs fsharp\">NSDictionary<span class=\"hljs-operator\">*</span> addquery <span class=\"hljs-operator\">=</span> <span class=\"hljs-operator\">@</span>&#123; (<span class=\"hljs-built_in\">id</span>)kSecValueRef<span class=\"hljs-operator\">:</span>   (__bridge <span class=\"hljs-built_in\">id</span>)certificate,<br>                            (<span class=\"hljs-built_in\">id</span>)kSecClass<span class=\"hljs-operator\">:</span>      (<span class=\"hljs-built_in\">id</span>)kSecClassCertificate,<br>                            (<span class=\"hljs-built_in\">id</span>)kSecAttrLabel<span class=\"hljs-operator\">:</span>  <span class=\"hljs-string\">@&quot;My Certificate&quot;</span>,<br>                           &#125;;<br>\t\t\t\t\t\t   <br>\t\t\t\t\t\t   <br>OSStatus status <span class=\"hljs-operator\">=</span> SecItemAdd((__bridge CFDictionaryRef)addquery, NULL);<br><span class=\"hljs-keyword\">if</span> (status <span class=\"hljs-operator\">!=</span> errSecSuccess) &#123;<br>    <span class=\"hljs-comment\">// Handle the error</span><br>&#125;\t\t\t\t\t\t   <br></code></pre></td></tr></table></figure>\n\n<p>ä»keychainè¯»å–è¯ä¹¦</p>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-built_in\">NSDictionary</span> *getquery = @&#123; (<span class=\"hljs-type\">id</span>)kSecClass:     (<span class=\"hljs-type\">id</span>)kSecClassCertificate,<br>                            (<span class=\"hljs-type\">id</span>)kSecAttrLabel: <span class=\"hljs-string\">@&quot;My Certificate&quot;</span>,<br>                            (<span class=\"hljs-type\">id</span>)kSecReturnRef: @YES,<br>                            &#125;;<br>SecCertificateRef certificate = <span class=\"hljs-literal\">NULL</span>;<br>OSStatus status = SecItemCopyMatching((__bridge <span class=\"hljs-built_in\">CFDictionaryRef</span>)getquery,<br>                                      (<span class=\"hljs-built_in\">CFTypeRef</span> *)&amp;certificate);<br><span class=\"hljs-keyword\">if</span> (status != errSecSuccess) &#123; &lt;# Handle error #&gt; &#125;<br><span class=\"hljs-keyword\">else</span>                         &#123; &lt;# Use certificate #&gt; &#125;<br> <br><span class=\"hljs-keyword\">if</span> (certificate) &#123; <span class=\"hljs-built_in\">CFRelease</span>(certificate); &#125; <span class=\"hljs-comment\">// After you are done with it</span><br></code></pre></td></tr></table></figure>\n\n<p>è§‚å¯Ÿåˆ°è¿™é‡Œç”¨çš„å°±æ˜¯ <code>kSecReturnRef</code>, ä»£è¡¨ä¸´æ—¶å¼•ç”¨ã€‚</p>\n<ul>\n<li>SecKeychainItemRef,</li>\n<li>SecKeyRef</li>\n<li>SecCertificateRef</li>\n<li>SecIdentityRef</li>\n<li>CFDataRef</li>\n</ul>\n<p><strong>æŒä¹…åŒ–å¼•ç”¨</strong></p>\n<p>key ä¸º kSecReturnPersistentRefã€‚</p>\n<blockquote>\n<p>The corresponding value is of type <code>CFBooleanRef</code>. A value of kCFBooleanTrue indicates that a persistent reference to an item should be returned as a <code>CFDataRef</code> object. Unlike normal references, a persistent reference may be stored on disk or passed between processes.</p>\n</blockquote>\n<ol>\n<li>ä¸€ä¸ªæŒä¹…åŒ–å¼•ç”¨ï¼Œå¼•ç”¨çš„å¯¹è±¡å¿…é¡»æ˜¯<code>CFDataRef</code></li>\n<li>æŒä¹…åŒ–å¼•ç”¨å¯ä»¥å­˜å‚¨åœ¨ç£ç›˜ï¼Œå¯ä»¥è·¨è¿›ç¨‹ä¼ é€’</li>\n</ol>\n<h1 id=\"ç¤ºä¾‹\"><a href=\"#ç¤ºä¾‹\" class=\"headerlink\" title=\"ç¤ºä¾‹\"></a>ç¤ºä¾‹</h1><h2 id=\"Adding-a-Password-to-the-Keychain\"><a href=\"#Adding-a-Password-to-the-Keychain\" class=\"headerlink\" title=\"Adding a Password to the Keychain\"></a><a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/adding_a_password_to_the_keychain?language=objc\">Adding a Password to the Keychain</a></h2><figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs typescript\">struct <span class=\"hljs-title class_\">Credentials</span> &#123;<br>    <span class=\"hljs-keyword\">var</span> <span class=\"hljs-attr\">username</span>: <span class=\"hljs-title class_\">String</span><br>    <span class=\"hljs-keyword\">var</span> <span class=\"hljs-attr\">password</span>: <span class=\"hljs-title class_\">String</span><br>&#125;<br><br><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title class_\">KeychainError</span>: <span class=\"hljs-title class_\">Error</span> &#123;<br>    <span class=\"hljs-keyword\">case</span> noPassword<br>    <span class=\"hljs-keyword\">case</span> unexpectedPasswordData<br>    <span class=\"hljs-keyword\">case</span> <span class=\"hljs-title function_\">unhandledError</span>(<span class=\"hljs-attr\">status</span>: <span class=\"hljs-title class_\">OSStatus</span>)<br>&#125;<br><br><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">let</span> server = <span class=\"hljs-string\">&quot;www.example.com&quot;</span><br><br><span class=\"hljs-keyword\">let</span> account = credentials.<span class=\"hljs-property\">username</span><br><span class=\"hljs-keyword\">let</span> password = credentials.<span class=\"hljs-property\">password</span>.<span class=\"hljs-title function_\">data</span>(<span class=\"hljs-attr\">using</span>: <span class=\"hljs-title class_\">String</span>.<span class=\"hljs-property\">Encoding</span>.<span class=\"hljs-property\">utf8</span>)!<br><span class=\"hljs-keyword\">var</span> <span class=\"hljs-attr\">query</span>: [<span class=\"hljs-title class_\">String</span>: <span class=\"hljs-title class_\">Any</span>] = [kSecClass <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">String</span>: kSecClassInternetPassword,<br>                            kSecAttrAccount <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">String</span>: account,<br>                            kSecAttrServer <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">String</span>: server,<br>                            kSecValueData <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">String</span>: password]<br><span class=\"hljs-keyword\">let</span> status = <span class=\"hljs-title class_\">SecItemAdd</span>(query <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">CFDictionary</span>, nil)<br>guard status == errSecSuccess <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-title class_\">KeychainError</span>.<span class=\"hljs-title function_\">unhandledError</span>(<span class=\"hljs-attr\">status</span>: status) &#125;<br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Searching-for-Keychain-Items\"><a href=\"#Searching-for-Keychain-Items\" class=\"headerlink\" title=\"Searching for Keychain Items\"></a><a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/searching_for_keychain_items?language=objc\">Searching for Keychain Items</a></h2><figure class=\"highlight swift\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs swift\"><span class=\"hljs-keyword\">let</span> query: [<span class=\"hljs-type\">String</span>: <span class=\"hljs-keyword\">Any</span>] <span class=\"hljs-operator\">=</span> [kSecClass <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: kSecClassInternetPassword,<br>                            kSecAttrServer <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: server,<br>                            kSecMatchLimit <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: kSecMatchLimitOne,<br>                            kSecReturnAttributes <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: <span class=\"hljs-literal\">true</span>,<br>                            kSecReturnData <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: <span class=\"hljs-literal\">true</span>]<br><br><span class=\"hljs-keyword\">var</span> item: <span class=\"hljs-type\">CFTypeRef</span>?<br><span class=\"hljs-keyword\">let</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">SecItemCopyMatching</span>(query <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">CFDictionary</span>, <span class=\"hljs-operator\">&amp;</span>item)<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">!=</span> errSecItemNotFound <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.noPassword &#125;<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">==</span> errSecSuccess <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.unhandledError(status: status) &#125;<br><br><span class=\"hljs-keyword\">guard</span> <span class=\"hljs-keyword\">let</span> existingItem <span class=\"hljs-operator\">=</span> item <span class=\"hljs-keyword\">as?</span> [<span class=\"hljs-type\">String</span> : <span class=\"hljs-keyword\">Any</span>],<br>    <span class=\"hljs-keyword\">let</span> passwordData <span class=\"hljs-operator\">=</span> existingItem[kSecValueData <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>] <span class=\"hljs-keyword\">as?</span> <span class=\"hljs-type\">Data</span>,<br>    <span class=\"hljs-keyword\">let</span> password <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">String</span>(data: passwordData, encoding: <span class=\"hljs-type\">String</span>.<span class=\"hljs-type\">Encoding</span>.utf8),<br>    <span class=\"hljs-keyword\">let</span> account <span class=\"hljs-operator\">=</span> existingItem[kSecAttrAccount <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>] <span class=\"hljs-keyword\">as?</span> <span class=\"hljs-type\">String</span><br><span class=\"hljs-keyword\">else</span> &#123;<br>    <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.unexpectedPasswordData<br>&#125;<br><span class=\"hljs-keyword\">let</span> credentials <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">Credentials</span>(username: account, password: password)<br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Updating-and-Deleting-Keychain-Items\"><a href=\"#Updating-and-Deleting-Keychain-Items\" class=\"headerlink\" title=\"Updating and Deleting Keychain Items\"></a><a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/updating_and_deleting_keychain_items?language=objc\">Updating and Deleting Keychain Items</a></h2><figure class=\"highlight swift\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs swift\"><span class=\"hljs-keyword\">let</span> query: [<span class=\"hljs-type\">String</span>: <span class=\"hljs-keyword\">Any</span>] <span class=\"hljs-operator\">=</span> [kSecClass <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: kSecClassInternetPassword,<br>                            kSecAttrServer <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: server]<br>\t\t\t\t\t\t\t<br><span class=\"hljs-keyword\">let</span> account <span class=\"hljs-operator\">=</span> credentials.username<br><span class=\"hljs-keyword\">let</span> password <span class=\"hljs-operator\">=</span> credentials.password.data(using: <span class=\"hljs-type\">String</span>.<span class=\"hljs-type\">Encoding</span>.utf8)<span class=\"hljs-operator\">!</span><br><span class=\"hljs-keyword\">let</span> attributes: [<span class=\"hljs-type\">String</span>: <span class=\"hljs-keyword\">Any</span>] <span class=\"hljs-operator\">=</span> [kSecAttrAccount <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: account,<br>                                 kSecValueData <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: password]<br><br><span class=\"hljs-comment\">//update\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t </span><br><span class=\"hljs-keyword\">let</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">SecItemUpdate</span>(query <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">CFDictionary</span>, attributes <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">CFDictionary</span>)<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">!=</span> errSecItemNotFound <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.noPassword &#125;<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">==</span> errSecSuccess <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.unhandledError(status: status) &#125;\t<br><br><span class=\"hljs-comment\">//delete</span><br><span class=\"hljs-keyword\">let</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">SecItemDelete</span>(query <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">CFDictionary</span>)<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">==</span> errSecSuccess <span class=\"hljs-operator\">||</span> status <span class=\"hljs-operator\">==</span> errSecItemNotFound <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.unhandledError(status: status) &#125;<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"keychain-group-app-group\"><a href=\"#keychain-group-app-group\" class=\"headerlink\" title=\"keychain group &amp; app group\"></a>keychain group &amp; app group</h1><p>å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps?language=objc\">Sharing Access to Keychain Items Among a Collection of Apps</a></p>\n<blockquote>\n<p>Enable apps to share keychain items with each other by adding the apps to an access group.</p>\n</blockquote>\n<p>é€šè¿‡keychain group å¯ä»¥åœ¨ app é—´å…±äº«keychain itemã€‚</p>\n<blockquote>\n<p>An access group is a logical collection of apps tagged with a particular group name string. Any app in a given group can share keychain items with all the other apps in the same group. You can add an app to any number of groups, but the app is always part of at least one group that contains only itself. That is, an app can always store and retrieve private keychain items, regardless of whether it also participates in any other groups. Keychain items, on the other hand, are always part of exactly one group.</p>\n</blockquote>\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œapp åŠ å…¥äº†ä»¥è‡ªèº«id ä¸ºæ ‡è®°çš„åˆ†ç»„ä¸­ï¼Œè¿™ä¸ªåˆ†ç»„ä¸­çš„æ‰€æœ‰ keychain item ä»…é™app è‡ªèº«è®¿é—®ã€‚</p>\n<p>é€šè¿‡åŠ å…¥å…¶ä»–åˆ†ç»„ï¼Œapp é—´å¯ä»¥é€šè¿‡ keychain group å…±äº« keychain itemã€‚</p>\n<h2 id=\"keychain-group-ç±»å‹\"><a href=\"#keychain-group-ç±»å‹\" class=\"headerlink\" title=\"keychain group ç±»å‹\"></a>keychain group ç±»å‹</h2><p>You control the groups that your app belongs to by manipulating its entitlements. In particular, an app belongs to all the groups named in a virtual array of strings that the system forms for each app as the concatenation of the following items, evaluated in this order:</p>\n<p><strong>Keychain access groups</strong><br>The optional Keychain Access Groups Entitlement holds an array of strings, each of which names an access group.</p>\n<p>æ˜¾ç¤ºæŒ‡å®šåŠ å…¥çš„ keychain groupï¼Œ group idä¸º <code>[$(teamID).$(keychain group id)]</code></p>\n<p><strong>Application identifier</strong><br>Xcode automatically adds the application-identifier entitlement (or the com.apple.application-identifier entitlement in macOS) to every app during code signing, formed as the team identifier (team ID) plus the bundle identifier (bundle ID).</p>\n<p>éšå¼çš„åŠ å…¥äº†ä»¥è‡ªèº«ä¸ºç»„çš„ keychain group,  group idä¸º <code>[$(teamID).$(bundle ID)]</code></p>\n<p><strong>Application groups</strong><br>When you collect related apps into an application group using the App Groups Entitlement, they share access to a group container, and gain the ability to message each other in certain ways. Starting in iOS 8, the array of strings given by this entitlement also extends the list of keychain access groups.</p>\n<p>ç”±äºåŠ å…¥äº†app groupï¼Œ éšå¼çš„åŠ å…¥äº†ä»¥ app group ä¸ºç»„çš„ keychain group,  group idä¸º <code>[$(app group id)]</code></p>\n<p>Xcode handles the application identifier (app ID) for you when you set the bundle ID. You set the others by manipulating capabilities in Xcode.</p>\n<p>æ·»åŠ keychain group å’Œ app group å¯ä»¥åœ¨xcode ä¸­é€šè¿‡æ“ä½œcapabilitiesæ¥å®ç°ã€‚<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694538450341669453844996.png\"><br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694538730181669453872352.png\"></p>\n<h2 id=\"app-group-å’Œ-keychain-group-åŒºåˆ«\"><a href=\"#app-group-å’Œ-keychain-group-åŒºåˆ«\" class=\"headerlink\" title=\"app group å’Œ keychain group åŒºåˆ«\"></a>app group å’Œ keychain group åŒºåˆ«</h2><p>App groups and keychain access groups arenâ€™t mutually exclusiveâ€”you can use both in the same appâ€”but they do differ in several important ways that may help you decide which to use for a given situation.</p>\n<p>ä¸¤è€…ä¸æ˜¯äº’ç›¸æ’æ–¥çš„ï¼Œ ä¸€ä¸ªappå¯ä»¥åŒæ—¶åŠ å…¥keychain group å’Œ app groupã€‚</p>\n<p>First, as described above, using an app group enables additional data sharing beyond keychain items. You might want this extra sharing, or might already be using an app group for this purpose, and thus not need to add keychain access groups. On the other hand, you might not want to enable this additional sharing at all, and prefer keychain access groups instead.</p>\n<p>app group é™¤äº†å…±äº« keychain item ä¹‹å¤–ï¼Œè¿˜èƒ½å…±äº«å…¶ä»–å†…å®¹ï¼Œä¾‹å¦‚å…±äº«åå¥½è®¾ç½®</p>\n<figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pf\">let <span class=\"hljs-keyword\">user</span>Defualts = UserDefaults.init(suiteName: <span class=\"hljs-string\">&quot;$(group_Id)&quot;</span>)<br><span class=\"hljs-keyword\">user</span>Defualts?.<span class=\"hljs-built_in\">set</span>Value(data, <span class=\"hljs-keyword\">for</span>Key: key)<br><span class=\"hljs-keyword\">user</span>Defualts?.synchronize()<br></code></pre></td></tr></table></figure>\n\n\n<p>Second, order matters. The system considers the first item in the list of access groups to be the appâ€™s default access group. This is the access group that keychain services assumes if you donâ€™t otherwise specify one when adding keychain items. An app group canâ€™t ever be the default, because the app ID is always present and appears earlier in the list. However, a keychain access group can be the default, because it appears before the app ID. In particular, the first keychain access group, if any, that you specify in the corresponding capability becomes the appâ€™s default access group. If you donâ€™t specify any keychain access groups, then the app ID is the default.</p>\n<p>å…³äºé»˜è®¤ groupï¼Œ å½“æ·»åŠ ï¼ŒæŸ¥è¯¢ï¼Œæ›´æ–°ï¼Œåˆ é™¤ keychain item æ—¶ï¼Œä¸æŒ‡å®š<code>kSecAttrAccessGroup </code>æ—¶ï¼Œé»˜è®¤æ“ä½œçš„æ˜¯å“ªä¸ªgroup ï¼Ÿ</p>\n<ol>\n<li>ç³»ç»Ÿä»¥ group list æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªä¸ºé»˜è®¤ group</li>\n<li>é»˜è®¤group ä¸ä¼šæ˜¯app groupï¼Œ å› ä¸ºå®ƒä¸ä¼šæ˜¯ç¬¬ä¸€ä¸ª</li>\n<li>å¦‚æœåŠ å…¥keychain groupï¼Œ è¯¥ keychain group å¯èƒ½ä¸ºé»˜è®¤çš„ keychain group</li>\n<li>æƒ³é™å®škeychain item åªåœ¨ app å†…è®¿é—®ï¼Œä¸èƒ½è¢«keychain group è®¿é—®ï¼Œéœ€è¦å°† bundle id æ‰€åœ¨çš„keychain group ç½®é¡¶ï¼Œæˆ–è€…æ˜ç¡®æŒ‡å®šä½¿ç”¨ bundle id æ ‡è®°çš„keychain group</li>\n</ol>\n","excerpt":"","more":"<h1 id=\"Keychain-æ˜¯ä»€ä¹ˆ\"><a href=\"#Keychain-æ˜¯ä»€ä¹ˆ\" class=\"headerlink\" title=\"Keychain  æ˜¯ä»€ä¹ˆ\"></a>Keychain  æ˜¯ä»€ä¹ˆ</h1><p>ä¸€ä¸ªåŠ å¯†çš„æ•°æ®åº“ï¼Œ å¯ä»¥ç”¨æ¥å­˜å‚¨å°çš„ç”¨æˆ·æ•°æ®ï¼Œ åŒ…æ‹¬</p>\n<ul>\n<li>kSecClassGenericPasswordï¼šé€šç”¨å¯†ç ï¼ˆå¯ä»¥ç”¨æ¥å­˜è‡ªå®šä¹‰æ•°æ®ï¼‰</li>\n<li>kSecClassInternetPasswordï¼šäº’è”ç½‘å¯†ç </li>\n<li>kSecClassCertificateï¼šè¯ä¹¦</li>\n<li>kSecClassKeyï¼šç§˜é’¥</li>\n<li>kSecClassIdentityï¼šè¯ä¹¦+ç§˜é’¥</li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16692950150511669295014987.png\"><br>Figure 1 Securing the userâ€™s secrets in a keychain</p>\n<p>æ‰“å¼€ mac ç³»ç»Ÿçš„ keychain è§‚å¯Ÿä¸€ä¸‹ï¼Œ å‘ç°ç³»ç»Ÿæœ‰å¤šä¸ªkeychainï¼Œæ¯ä¸ªkeychainéƒ½æœ‰ä¸Šå›¾å¯¹åº”çš„é¡¹ç›®<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694375672261669437566402.png\"></p>\n<h1 id=\"å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹\"><a href=\"#å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹\" class=\"headerlink\" title=\"å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹\"></a>å¦‚ä½•ç®¡ç†æ•°æ®ï¼Œå¢åˆ æŸ¥æ”¹</h1><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16692963470741669296346746.png\"><br>Figure 1 Putting data and attributes into a keychain</p>\n<p>keychain å°†è¦å­˜å‚¨çš„æ•°æ®å°è£…ä¸º SecKeychainItemRefï¼Œé€šè¿‡å­˜å– SecKeychainItem æ¥è¾¾åˆ°å¯¹æ•°æ®çš„ç®¡ç†ã€‚</p>\n<p>SecKeychainItemRef åŒ…å«</p>\n<ul>\n<li>dataï¼Œ CFDataï¼Œ è¦å­˜å–çš„æ•°æ®</li>\n<li>attributes, è¯¥æ¡ç›®çš„å±æ€§ï¼Œå­˜å–æƒé™ï¼ŒæŸ¥è¯¢æ ‡ç­¾ç­‰</li>\n</ul>\n<p>æä¾›çš„api</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-comment\">//æ·»åŠ </span><br>OSStatus <span class=\"hljs-built_in\">SecItemAdd</span>(CFDictionaryRef attributes, CFTypeRef  _Nullable *result);<br><span class=\"hljs-comment\">//æŸ¥è¯¢</span><br>OSStatus <span class=\"hljs-built_in\">SecItemCopyMatching</span>(CFDictionaryRef query, CFTypeRef  _Nullable *result);<br><span class=\"hljs-comment\">//æ›´æ–°</span><br>OSStatus <span class=\"hljs-built_in\">SecItemUpdate</span>(CFDictionaryRef query, CFDictionaryRef attributesToUpdate);<br><span class=\"hljs-comment\">//åˆ é™¤</span><br>OSStatus <span class=\"hljs-built_in\">SecItemDelete</span>(CFDictionaryRef query);<br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"SecItemAdd\"><a href=\"#SecItemAdd\" class=\"headerlink\" title=\"SecItemAdd\"></a>SecItemAdd</h2><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\">OSStatus SecItemAdd(<span class=\"hljs-built_in\">CFDictionaryRef</span> attributes, <span class=\"hljs-built_in\">CFTypeRef</span>  _Nullable *result);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"å‚æ•°\"><a href=\"#å‚æ•°\" class=\"headerlink\" title=\"å‚æ•°\"></a>å‚æ•°</h3><p><strong>attributes</strong></p>\n<p>ä¸€ä¸ªå­—å…¸ï¼Œæè¿°è¦æ·»åŠ çš„æ•°æ®ï¼š</p>\n<ul>\n<li>è¦æ·»åŠ æ•°æ®ç±»å‹ï¼Œå¯¹åº”çš„ key ä¸º<code>kSecClass</code>, value å¯ä»¥æ˜¯<ul>\n<li>kSecClassGenericPasswordï¼šé€šç”¨å¯†ç ï¼ˆå¯ä»¥ç”¨æ¥å­˜è‡ªå®šä¹‰æ•°æ®ï¼‰</li>\n<li>kSecClassInternetPasswordï¼šäº’è”ç½‘å¯†ç </li>\n<li>kSecClassCertificateï¼šè¯ä¹¦</li>\n<li>kSecClassKeyï¼šç§˜é’¥</li>\n<li>kSecClassIdentityï¼šè¯ä¹¦+ç§˜é’¥</li>\n</ul>\n</li>\n<li>æ•°æ·»åŠ çš„æ•°æ®æœ¬èº«, key ä¸º <code> kSecValueData</code>, value ä¸º <code>CFDataRef</code> ç±»å‹</li>\n<li>å…³è”çš„å±æ€§, å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values?language=objc\">Item Attribute Keys and Values</a><ul>\n<li>æ¯ç§ç±»å‹å…³è”çš„å±æ€§å¯ä»¥ä¸åŒï¼Œä¾‹å¦‚ kSecClassInternetPassword å¯ä»¥å…³è” <code>kSecAttrServer</code>, <code>kSecAttrPort</code>, <code>kSecAttrProtocol</code>ï¼Œ è€Œ <code>kSecClassGenericPassword</code>å°±æ²¡æœ‰è¿™äº›é€‰é¡¹</li>\n<li><code>kSecAttrAccessGroup</code> å¯ä»¥æŒ‡å®šå­˜å…¥çš„keychain groupï¼Œè¿™ä¸ªä¼šå½±å“åˆ°æŸ¥è¯¢èŒƒå›´</li>\n</ul>\n</li>\n<li>æ·»åŠ åï¼Œè¿”å›æ·»åŠ ç»“æœçš„ç±»å‹ï¼ŒæŒ‡å®šç±»å‹çš„æ•°æ®ä¼šå­˜å…¥ result å­—æ®µã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc\"> Item Return Result Keys</a></li>\n</ul>\n<p><strong>result</strong></p>\n<p>æ·»åŠ ç»“æŸï¼Œå‡½æ•°è¿”å›ï¼ŒæŒ‡å‘æ–°æ·»åŠ çš„æ¡ç›®ã€‚æ ¹æ® attributes ä¸­æŒ‡å®šçš„ç±»å‹ï¼Œè¿”å›å¯¹åº”çš„å€¼ã€‚å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc\"> Item Return Result Keys</a></p>\n<p>ä¸€èˆ¬æ·»åŠ ä¸å…³å¿ƒæ–°æ¡ç›®ï¼Œä¼ nil</p>\n<h3 id=\"è¿”å›å€¼\"><a href=\"#è¿”å›å€¼\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h3><p>æˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc\">Security Framework Result Codes</a></p>\n<h3 id=\"æ³¨æ„\"><a href=\"#æ³¨æ„\" class=\"headerlink\" title=\"æ³¨æ„\"></a>æ³¨æ„</h3><ol>\n<li>kSecAttrAccessGroup å¯ä»¥æŒ‡å®šæ·»åŠ åˆ° é’¥åŒ™ä¸²åˆ†ç»„ï¼Œè¯¥åˆ†ç»„ä¸­çš„æˆå‘˜å…±äº«è¯¥æ¡ç›®</li>\n<li>ä¸€æ¬¡æ·»åŠ å¤šæ¡ï¼Œå¯ä»¥ä½¿ç”¨<code>kSecUseItemList </code>ä¼ å…¥å­—å…¸æ•°ç»„ï¼Œä½†æ˜¯ä¸èƒ½ç”¨äºå¯†ç ç±»å‹</li>\n<li>æ·»åŠ æ˜¯åŒæ­¥æ‰§è¡Œï¼Œæ”¾åˆ°ä¸»çº¿ç¨‹å¯èƒ½ä¼šå¡ç•Œé¢ï¼Œå¯ä»¥ç”¨å¼‚æ­¥æ–¹å¼</li>\n</ol>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">- (void)addKeychainItemWithAttributes:(CFDictionaryRef)attrs completion:(<span class=\"hljs-built_in\">void</span>(^)(OSStatus status, CFTypeRef item))completion &#123;<br>    <span class=\"hljs-built_in\">dispatch_async</span>(backgroundQueue, ^&#123;<br>        CFTypeRef item = NULL;<br>        OSStatus addResult = SecItemAdd(attrs, &amp;item);<br>        <span class=\"hljs-built_in\">completion</span>(addResult, item);<br>        if (item) &#123;<br>            <span class=\"hljs-built_in\">CFRelease</span>(item);<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"SecItemCopyMatching\"><a href=\"#SecItemCopyMatching\" class=\"headerlink\" title=\"SecItemCopyMatching\"></a>SecItemCopyMatching</h2><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\">OSStatus SecItemCopyMatching(<span class=\"hljs-built_in\">CFDictionaryRef</span> query, <span class=\"hljs-built_in\">CFTypeRef</span>  _Nullable *result);<br></code></pre></td></tr></table></figure>\n\n<p>é€šè¿‡ query æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ï¼Œå°†æŸ¥è¯¢ç»“æœå­˜å…¥ result ä¸­ã€‚</p>\n<h3 id=\"å‚æ•°-1\"><a href=\"#å‚æ•°-1\" class=\"headerlink\" title=\"å‚æ•°\"></a>å‚æ•°</h3><p><strong>query</strong><br>ç”¨äºæŒ‡å®šæŸ¥è¯¢æ¡ä»¶</p>\n<ul>\n<li>æŸ¥è¯¢çš„æ•°æ®ç±»å‹ï¼Œé€šè¿‡ <code>kSecClass</code> æŒ‡å®š</li>\n<li>å…³è”çš„å±æ€§ï¼Œ ç”¨äºç¼©å°æŸ¥è¯¢èŒƒå›´</li>\n<li>æŸ¥è¯¢å‚æ•°ï¼Œè¿”å›ä¸€æ¡è¿˜æ˜¯å¤šæ¡åŒ¹é…é¡¹ï¼Œæ˜¯å¦å¤§æ¶ˆæ¯æ•æ„Ÿï¼Œæˆ–è€…ä»ç‰¹å®šé¡¹ä¸­æœç´¢ã€‚å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/search_attribute_keys_and_values?language=objc\"> Search Attribute Keys and Values</a></li>\n<li>æŒ‡å®šè¿”å›ç±»å‹ï¼ŒæŒ‡å®šçš„ç±»å‹ä¸åŒï¼Œresult ä¸­è¿”å›çš„ç±»å‹å°±ä¸åŒã€‚ å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc\">Item Return Result Keys </a></li>\n</ul>\n<p>**result **</p>\n<p>ä¿å­˜æŸ¥è¯¢ç»“æœã€‚<br>ä¾‹å¦‚ï¼š æŒ‡å®š  <code>kSecReturnData: kCFBooleanTrue</code>  ï¼Œresult ä¸­å­˜çš„å°±æ˜¯<code>CFDataRef </code>ç±»å‹çš„æ•°æ®ã€‚å‚è€ƒï¼š <a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_return_result_keys?language=objc\">Item Return Result Keys</a></p>\n<h3 id=\"è¿”å›å€¼-1\"><a href=\"#è¿”å›å€¼-1\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h3><p>æˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc\">Security Framework Result Codes</a></p>\n<h3 id=\"æ³¨æ„-1\"><a href=\"#æ³¨æ„-1\" class=\"headerlink\" title=\"æ³¨æ„\"></a>æ³¨æ„</h3><ol>\n<li>é»˜è®¤è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œå¦‚æœæƒ³æŸ¥è¯¢å¤šæ¡åŒ¹é…ï¼ŒæŒ‡å®š <code>kSecMatchLimit</code>  å¤§äº1ï¼Œ æ­¤æ—¶ result ä¸º <code>CFArrayRef</code>  ç±»å‹</li>\n<li>å½“ç±»å‹ä¸º<code>kSecInternetPasswordItemClass</code> æˆ– <code>kSecGenericPasswordItemClass</code>æ—¶ï¼Œ ä¸èƒ½åŒæ—¶æŒ‡å®š<code>kSecReturnData</code> å’Œ <code>kSecMatchLimitAll</code>, åŸå› æ˜¯æ‹·è´æ¯ä¸ªå¯†ç æ—¶ï¼Œéœ€è¦é¢å¤–çš„æˆæƒéªŒè¯ã€‚</li>\n<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šæœç´¢å½“å‰keychain ä»¥åŠæ‰€æœ‰åŠ å…¥çš„ keychain groupï¼Œ é€šè¿‡ <code>kSecAttrAccessGroup</code> å¯ä»¥æŒ‡å®šè¦åœ¨å“ªä¸ª keychain group æŸ¥è¯¢</li>\n<li>ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ</li>\n</ol>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\">- (<span class=\"hljs-type\">void</span>)findKeychainItemWithAttributes:(<span class=\"hljs-built_in\">NSDictionary</span> *)attributes completion:(<span class=\"hljs-type\">void</span>(^)(OSStatus status, <span class=\"hljs-built_in\">CFTypeRef</span> item))completion &#123;<br>    <span class=\"hljs-built_in\">dispatch_async</span>(backgroundQueue, ^&#123;<br>        <span class=\"hljs-built_in\">CFDictionaryRef</span> attrs = (__bridge <span class=\"hljs-built_in\">CFDictionaryRef</span>)attributes;<br>        <span class=\"hljs-built_in\">CFTypeRef</span> item = <span class=\"hljs-literal\">NULL</span>;<br>        OSStatus result = SecItemCopyMatching(attrs, &amp;item);<br>        completion(result, item);<br>        <span class=\"hljs-built_in\">CFRelease</span>(item);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n\n<h2 id=\"SecItemUpdate\"><a href=\"#SecItemUpdate\" class=\"headerlink\" title=\"SecItemUpdate\"></a>SecItemUpdate</h2><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\">OSStatus SecItemUpdate(<span class=\"hljs-built_in\">CFDictionaryRef</span> query, <span class=\"hljs-built_in\">CFDictionaryRef</span> attributesToUpdate);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"å‚æ•°-2\"><a href=\"#å‚æ•°-2\" class=\"headerlink\" title=\"å‚æ•°\"></a>å‚æ•°</h3><p><strong>query</strong></p>\n<p>ç”¨æ¥æŒ‡å®šè¦æ›´æ–°çš„æ¡ç›®, æ‰§è¡Œæ›´æ–°ï¼Œéœ€è¦å…ˆæŸ¥è¯¢åˆ°è¦æ›´æ–°çš„æ¡ç›®ã€‚<br>å‚è€ƒ SecItemCopyMatching å¦‚ä½•æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ã€‚</p>\n<p><strong>attributesToUpdate</strong></p>\n<p>æŒ‡å®šéœ€è¦æ›´æ–°çš„å±æ€§ã€‚</p>\n<h3 id=\"è¿”å›å€¼-2\"><a href=\"#è¿”å›å€¼-2\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h3><p>æˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc\">Security Framework Result Codes</a></p>\n<h3 id=\"æ³¨æ„-2\"><a href=\"#æ³¨æ„-2\" class=\"headerlink\" title=\"æ³¨æ„\"></a>æ³¨æ„</h3><p>ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">- (void)updateKeyChainItemWithAttributes:(CFDictionaryRef)attrs update:(CFDictionaryRef)update completion:(<span class=\"hljs-built_in\">void</span>(^)(OSStatus status))completion &#123;<br>    <span class=\"hljs-built_in\">dispatch_async</span>(backgroundQueue, ^&#123;<br>        OSStatus updateResult = SecItemUpdate(attrs, update);<br>        <span class=\"hljs-built_in\">completion</span>(updateResult);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"SecItemDelete\"><a href=\"#SecItemDelete\" class=\"headerlink\" title=\"SecItemDelete\"></a>SecItemDelete</h2><figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">OSStatus <span class=\"hljs-built_in\">SecItemDelete</span>(CFDictionaryRef query);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"å‚æ•°-3\"><a href=\"#å‚æ•°-3\" class=\"headerlink\" title=\"å‚æ•°\"></a>å‚æ•°</h3><p><strong>query</strong></p>\n<p>ç”¨æ¥æŒ‡å®šè¦åˆ é™¤çš„çš„æ¡ç›®ï¼Œ å‚è€ƒSecItemCopyMatching å¦‚ä½•æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ã€‚</p>\n<h3 id=\"è¿”å›å€¼-3\"><a href=\"#è¿”å›å€¼-3\" class=\"headerlink\" title=\"è¿”å›å€¼\"></a>è¿”å›å€¼</h3><p>æˆåŠŸæˆ–è€…é”™è¯¯ç ã€‚å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/1542001-security_framework_result_codes?language=objc\">Security Framework Result Codes</a></p>\n<h3 id=\"æ³¨æ„-3\"><a href=\"#æ³¨æ„-3\" class=\"headerlink\" title=\"æ³¨æ„\"></a>æ³¨æ„</h3><ol>\n<li>é»˜è®¤åˆ é™¤æ‰€æœ‰çš„åŒ¹é…é¡¹ï¼Œ</li>\n<li>å¯ä»¥é€šè¿‡æŒ‡å®š<code>kSecMatchItemList </code>æ¥é™å®šåˆ é™¤èŒƒå›´ï¼Œ <code>kSecMatchItemList</code>å¯¹åº”çš„å€¼çš„ç±»å‹ä¸º<code>CFArrayRef </code>, æ•°ç»„ä¸­æ¯ä¸€é¡¹çš„ç±»å‹å¿…é¡»ç›¸åŒï¼Œ<ul>\n<li>é’ˆå¯¹ä¸´æ—¶å¼•ç”¨ï¼Œæ¯ä¸€é¡¹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¼•ç”¨çš„ç±»å‹å¯ä»¥æ˜¯<ul>\n<li>SecKeychainItemRef,</li>\n<li>SecKeyRef</li>\n<li>SecCertificateRef</li>\n<li>SecIdentityRef</li>\n<li>CFDataRef</li>\n</ul>\n</li>\n<li>é’ˆå¯¹æŒä¹…åŒ–å¼•ç”¨, å¼•ç”¨çš„å¿…é¡»æ˜¯ç±»å‹æ˜¯ <code>CFDataRef</code></li>\n</ul>\n</li>\n<li>ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œä¼šå¡UIï¼Œ å¯ä»¥å¼‚æ­¥æ‰§è¡Œ</li>\n</ol>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">- (void)deleteKeychainItemWithAttributes:(CFDictionaryRef)attrs completion:(<span class=\"hljs-built_in\">void</span>(^)(OSStatus status))completion &#123;<br>    <span class=\"hljs-built_in\">dispatch_async</span>(backgroundQueue, ^&#123;<br>        OSStatus deleteResult = SecItemDelete(attrs);<br>        <span class=\"hljs-built_in\">completion</span>(deleteResult);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\"><a href=\"#ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\" class=\"headerlink\" title=\"ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\"></a>ä»€ä¹ˆæ˜¯ä¸´æ—¶å¼•ç”¨ï¼ŒæŒä¹…åŒ–å¼•ç”¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p><strong>ä¸´æ—¶å¼•ç”¨</strong></p>\n<p>å¯¹åº”çš„ key  å€¼æ˜¯<code>kSecReturnRef</code></p>\n<blockquote>\n<p>The corresponding value is of type <code>CFBooleanRef</code>. A value of <code>kCFBooleanTrue</code> indicates that a reference should be returned. Depending on the item class requested, the returned references may be of type <code>SecKeychainItemRef</code>, <code>SecKeyRef</code>, <code>SecCertificateRef</code>, <code>SecIdentityRef</code>, or <code>CFDataRef</code>.</p>\n</blockquote>\n<p>ç¤ºä¾‹ ï¼šSecCertificateRef è¯ä¹¦å¯¹è±¡çš„å¼•ç”¨åœ¨keychainä¸­å­˜å–</p>\n<p>åˆ›å»ºSecCertificateRef</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\">SecCertificateRef certificate =<br>    SecCertificateCreateWithData<span class=\"hljs-comment\">(NULL, (__bridge CFDataRef)</span>certData);<br>\t\t <br><span class=\"hljs-keyword\">if</span> <span class=\"hljs-comment\">(certificate)</span>  &#123; CFRelease<span class=\"hljs-comment\">(certificate)</span>; &#125; <span class=\"hljs-comment\">// After you are done with it</span><br></code></pre></td></tr></table></figure>\n\n<p>å°†è¯ä¹¦å­˜å…¥keychain</p>\n<figure class=\"highlight fsharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs fsharp\">NSDictionary<span class=\"hljs-operator\">*</span> addquery <span class=\"hljs-operator\">=</span> <span class=\"hljs-operator\">@</span>&#123; (<span class=\"hljs-built_in\">id</span>)kSecValueRef<span class=\"hljs-operator\">:</span>   (__bridge <span class=\"hljs-built_in\">id</span>)certificate,<br>                            (<span class=\"hljs-built_in\">id</span>)kSecClass<span class=\"hljs-operator\">:</span>      (<span class=\"hljs-built_in\">id</span>)kSecClassCertificate,<br>                            (<span class=\"hljs-built_in\">id</span>)kSecAttrLabel<span class=\"hljs-operator\">:</span>  <span class=\"hljs-string\">@&quot;My Certificate&quot;</span>,<br>                           &#125;;<br>\t\t\t\t\t\t   <br>\t\t\t\t\t\t   <br>OSStatus status <span class=\"hljs-operator\">=</span> SecItemAdd((__bridge CFDictionaryRef)addquery, NULL);<br><span class=\"hljs-keyword\">if</span> (status <span class=\"hljs-operator\">!=</span> errSecSuccess) &#123;<br>    <span class=\"hljs-comment\">// Handle the error</span><br>&#125;\t\t\t\t\t\t   <br></code></pre></td></tr></table></figure>\n\n<p>ä»keychainè¯»å–è¯ä¹¦</p>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-built_in\">NSDictionary</span> *getquery = @&#123; (<span class=\"hljs-type\">id</span>)kSecClass:     (<span class=\"hljs-type\">id</span>)kSecClassCertificate,<br>                            (<span class=\"hljs-type\">id</span>)kSecAttrLabel: <span class=\"hljs-string\">@&quot;My Certificate&quot;</span>,<br>                            (<span class=\"hljs-type\">id</span>)kSecReturnRef: @YES,<br>                            &#125;;<br>SecCertificateRef certificate = <span class=\"hljs-literal\">NULL</span>;<br>OSStatus status = SecItemCopyMatching((__bridge <span class=\"hljs-built_in\">CFDictionaryRef</span>)getquery,<br>                                      (<span class=\"hljs-built_in\">CFTypeRef</span> *)&amp;certificate);<br><span class=\"hljs-keyword\">if</span> (status != errSecSuccess) &#123; &lt;# Handle error #&gt; &#125;<br><span class=\"hljs-keyword\">else</span>                         &#123; &lt;# Use certificate #&gt; &#125;<br> <br><span class=\"hljs-keyword\">if</span> (certificate) &#123; <span class=\"hljs-built_in\">CFRelease</span>(certificate); &#125; <span class=\"hljs-comment\">// After you are done with it</span><br></code></pre></td></tr></table></figure>\n\n<p>è§‚å¯Ÿåˆ°è¿™é‡Œç”¨çš„å°±æ˜¯ <code>kSecReturnRef</code>, ä»£è¡¨ä¸´æ—¶å¼•ç”¨ã€‚</p>\n<ul>\n<li>SecKeychainItemRef,</li>\n<li>SecKeyRef</li>\n<li>SecCertificateRef</li>\n<li>SecIdentityRef</li>\n<li>CFDataRef</li>\n</ul>\n<p><strong>æŒä¹…åŒ–å¼•ç”¨</strong></p>\n<p>key ä¸º kSecReturnPersistentRefã€‚</p>\n<blockquote>\n<p>The corresponding value is of type <code>CFBooleanRef</code>. A value of kCFBooleanTrue indicates that a persistent reference to an item should be returned as a <code>CFDataRef</code> object. Unlike normal references, a persistent reference may be stored on disk or passed between processes.</p>\n</blockquote>\n<ol>\n<li>ä¸€ä¸ªæŒä¹…åŒ–å¼•ç”¨ï¼Œå¼•ç”¨çš„å¯¹è±¡å¿…é¡»æ˜¯<code>CFDataRef</code></li>\n<li>æŒä¹…åŒ–å¼•ç”¨å¯ä»¥å­˜å‚¨åœ¨ç£ç›˜ï¼Œå¯ä»¥è·¨è¿›ç¨‹ä¼ é€’</li>\n</ol>\n<h1 id=\"ç¤ºä¾‹\"><a href=\"#ç¤ºä¾‹\" class=\"headerlink\" title=\"ç¤ºä¾‹\"></a>ç¤ºä¾‹</h1><h2 id=\"Adding-a-Password-to-the-Keychain\"><a href=\"#Adding-a-Password-to-the-Keychain\" class=\"headerlink\" title=\"Adding a Password to the Keychain\"></a><a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/adding_a_password_to_the_keychain?language=objc\">Adding a Password to the Keychain</a></h2><figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs typescript\">struct <span class=\"hljs-title class_\">Credentials</span> &#123;<br>    <span class=\"hljs-keyword\">var</span> <span class=\"hljs-attr\">username</span>: <span class=\"hljs-title class_\">String</span><br>    <span class=\"hljs-keyword\">var</span> <span class=\"hljs-attr\">password</span>: <span class=\"hljs-title class_\">String</span><br>&#125;<br><br><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title class_\">KeychainError</span>: <span class=\"hljs-title class_\">Error</span> &#123;<br>    <span class=\"hljs-keyword\">case</span> noPassword<br>    <span class=\"hljs-keyword\">case</span> unexpectedPasswordData<br>    <span class=\"hljs-keyword\">case</span> <span class=\"hljs-title function_\">unhandledError</span>(<span class=\"hljs-attr\">status</span>: <span class=\"hljs-title class_\">OSStatus</span>)<br>&#125;<br><br><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">let</span> server = <span class=\"hljs-string\">&quot;www.example.com&quot;</span><br><br><span class=\"hljs-keyword\">let</span> account = credentials.<span class=\"hljs-property\">username</span><br><span class=\"hljs-keyword\">let</span> password = credentials.<span class=\"hljs-property\">password</span>.<span class=\"hljs-title function_\">data</span>(<span class=\"hljs-attr\">using</span>: <span class=\"hljs-title class_\">String</span>.<span class=\"hljs-property\">Encoding</span>.<span class=\"hljs-property\">utf8</span>)!<br><span class=\"hljs-keyword\">var</span> <span class=\"hljs-attr\">query</span>: [<span class=\"hljs-title class_\">String</span>: <span class=\"hljs-title class_\">Any</span>] = [kSecClass <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">String</span>: kSecClassInternetPassword,<br>                            kSecAttrAccount <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">String</span>: account,<br>                            kSecAttrServer <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">String</span>: server,<br>                            kSecValueData <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">String</span>: password]<br><span class=\"hljs-keyword\">let</span> status = <span class=\"hljs-title class_\">SecItemAdd</span>(query <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">CFDictionary</span>, nil)<br>guard status == errSecSuccess <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-title class_\">KeychainError</span>.<span class=\"hljs-title function_\">unhandledError</span>(<span class=\"hljs-attr\">status</span>: status) &#125;<br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Searching-for-Keychain-Items\"><a href=\"#Searching-for-Keychain-Items\" class=\"headerlink\" title=\"Searching for Keychain Items\"></a><a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/searching_for_keychain_items?language=objc\">Searching for Keychain Items</a></h2><figure class=\"highlight swift\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs swift\"><span class=\"hljs-keyword\">let</span> query: [<span class=\"hljs-type\">String</span>: <span class=\"hljs-keyword\">Any</span>] <span class=\"hljs-operator\">=</span> [kSecClass <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: kSecClassInternetPassword,<br>                            kSecAttrServer <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: server,<br>                            kSecMatchLimit <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: kSecMatchLimitOne,<br>                            kSecReturnAttributes <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: <span class=\"hljs-literal\">true</span>,<br>                            kSecReturnData <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: <span class=\"hljs-literal\">true</span>]<br><br><span class=\"hljs-keyword\">var</span> item: <span class=\"hljs-type\">CFTypeRef</span>?<br><span class=\"hljs-keyword\">let</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">SecItemCopyMatching</span>(query <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">CFDictionary</span>, <span class=\"hljs-operator\">&amp;</span>item)<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">!=</span> errSecItemNotFound <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.noPassword &#125;<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">==</span> errSecSuccess <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.unhandledError(status: status) &#125;<br><br><span class=\"hljs-keyword\">guard</span> <span class=\"hljs-keyword\">let</span> existingItem <span class=\"hljs-operator\">=</span> item <span class=\"hljs-keyword\">as?</span> [<span class=\"hljs-type\">String</span> : <span class=\"hljs-keyword\">Any</span>],<br>    <span class=\"hljs-keyword\">let</span> passwordData <span class=\"hljs-operator\">=</span> existingItem[kSecValueData <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>] <span class=\"hljs-keyword\">as?</span> <span class=\"hljs-type\">Data</span>,<br>    <span class=\"hljs-keyword\">let</span> password <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">String</span>(data: passwordData, encoding: <span class=\"hljs-type\">String</span>.<span class=\"hljs-type\">Encoding</span>.utf8),<br>    <span class=\"hljs-keyword\">let</span> account <span class=\"hljs-operator\">=</span> existingItem[kSecAttrAccount <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>] <span class=\"hljs-keyword\">as?</span> <span class=\"hljs-type\">String</span><br><span class=\"hljs-keyword\">else</span> &#123;<br>    <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.unexpectedPasswordData<br>&#125;<br><span class=\"hljs-keyword\">let</span> credentials <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">Credentials</span>(username: account, password: password)<br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Updating-and-Deleting-Keychain-Items\"><a href=\"#Updating-and-Deleting-Keychain-Items\" class=\"headerlink\" title=\"Updating and Deleting Keychain Items\"></a><a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/updating_and_deleting_keychain_items?language=objc\">Updating and Deleting Keychain Items</a></h2><figure class=\"highlight swift\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs swift\"><span class=\"hljs-keyword\">let</span> query: [<span class=\"hljs-type\">String</span>: <span class=\"hljs-keyword\">Any</span>] <span class=\"hljs-operator\">=</span> [kSecClass <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: kSecClassInternetPassword,<br>                            kSecAttrServer <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: server]<br>\t\t\t\t\t\t\t<br><span class=\"hljs-keyword\">let</span> account <span class=\"hljs-operator\">=</span> credentials.username<br><span class=\"hljs-keyword\">let</span> password <span class=\"hljs-operator\">=</span> credentials.password.data(using: <span class=\"hljs-type\">String</span>.<span class=\"hljs-type\">Encoding</span>.utf8)<span class=\"hljs-operator\">!</span><br><span class=\"hljs-keyword\">let</span> attributes: [<span class=\"hljs-type\">String</span>: <span class=\"hljs-keyword\">Any</span>] <span class=\"hljs-operator\">=</span> [kSecAttrAccount <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: account,<br>                                 kSecValueData <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">String</span>: password]<br><br><span class=\"hljs-comment\">//update\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t </span><br><span class=\"hljs-keyword\">let</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">SecItemUpdate</span>(query <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">CFDictionary</span>, attributes <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">CFDictionary</span>)<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">!=</span> errSecItemNotFound <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.noPassword &#125;<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">==</span> errSecSuccess <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.unhandledError(status: status) &#125;\t<br><br><span class=\"hljs-comment\">//delete</span><br><span class=\"hljs-keyword\">let</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">SecItemDelete</span>(query <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">CFDictionary</span>)<br><span class=\"hljs-keyword\">guard</span> status <span class=\"hljs-operator\">==</span> errSecSuccess <span class=\"hljs-operator\">||</span> status <span class=\"hljs-operator\">==</span> errSecItemNotFound <span class=\"hljs-keyword\">else</span> &#123; <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-type\">KeychainError</span>.unhandledError(status: status) &#125;<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"keychain-group-app-group\"><a href=\"#keychain-group-app-group\" class=\"headerlink\" title=\"keychain group &amp; app group\"></a>keychain group &amp; app group</h1><p>å‚è€ƒï¼š<a href=\"https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps?language=objc\">Sharing Access to Keychain Items Among a Collection of Apps</a></p>\n<blockquote>\n<p>Enable apps to share keychain items with each other by adding the apps to an access group.</p>\n</blockquote>\n<p>é€šè¿‡keychain group å¯ä»¥åœ¨ app é—´å…±äº«keychain itemã€‚</p>\n<blockquote>\n<p>An access group is a logical collection of apps tagged with a particular group name string. Any app in a given group can share keychain items with all the other apps in the same group. You can add an app to any number of groups, but the app is always part of at least one group that contains only itself. That is, an app can always store and retrieve private keychain items, regardless of whether it also participates in any other groups. Keychain items, on the other hand, are always part of exactly one group.</p>\n</blockquote>\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œapp åŠ å…¥äº†ä»¥è‡ªèº«id ä¸ºæ ‡è®°çš„åˆ†ç»„ä¸­ï¼Œè¿™ä¸ªåˆ†ç»„ä¸­çš„æ‰€æœ‰ keychain item ä»…é™app è‡ªèº«è®¿é—®ã€‚</p>\n<p>é€šè¿‡åŠ å…¥å…¶ä»–åˆ†ç»„ï¼Œapp é—´å¯ä»¥é€šè¿‡ keychain group å…±äº« keychain itemã€‚</p>\n<h2 id=\"keychain-group-ç±»å‹\"><a href=\"#keychain-group-ç±»å‹\" class=\"headerlink\" title=\"keychain group ç±»å‹\"></a>keychain group ç±»å‹</h2><p>You control the groups that your app belongs to by manipulating its entitlements. In particular, an app belongs to all the groups named in a virtual array of strings that the system forms for each app as the concatenation of the following items, evaluated in this order:</p>\n<p><strong>Keychain access groups</strong><br>The optional Keychain Access Groups Entitlement holds an array of strings, each of which names an access group.</p>\n<p>æ˜¾ç¤ºæŒ‡å®šåŠ å…¥çš„ keychain groupï¼Œ group idä¸º <code>[$(teamID).$(keychain group id)]</code></p>\n<p><strong>Application identifier</strong><br>Xcode automatically adds the application-identifier entitlement (or the com.apple.application-identifier entitlement in macOS) to every app during code signing, formed as the team identifier (team ID) plus the bundle identifier (bundle ID).</p>\n<p>éšå¼çš„åŠ å…¥äº†ä»¥è‡ªèº«ä¸ºç»„çš„ keychain group,  group idä¸º <code>[$(teamID).$(bundle ID)]</code></p>\n<p><strong>Application groups</strong><br>When you collect related apps into an application group using the App Groups Entitlement, they share access to a group container, and gain the ability to message each other in certain ways. Starting in iOS 8, the array of strings given by this entitlement also extends the list of keychain access groups.</p>\n<p>ç”±äºåŠ å…¥äº†app groupï¼Œ éšå¼çš„åŠ å…¥äº†ä»¥ app group ä¸ºç»„çš„ keychain group,  group idä¸º <code>[$(app group id)]</code></p>\n<p>Xcode handles the application identifier (app ID) for you when you set the bundle ID. You set the others by manipulating capabilities in Xcode.</p>\n<p>æ·»åŠ keychain group å’Œ app group å¯ä»¥åœ¨xcode ä¸­é€šè¿‡æ“ä½œcapabilitiesæ¥å®ç°ã€‚<br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694538450341669453844996.png\"><br><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16694538730181669453872352.png\"></p>\n<h2 id=\"app-group-å’Œ-keychain-group-åŒºåˆ«\"><a href=\"#app-group-å’Œ-keychain-group-åŒºåˆ«\" class=\"headerlink\" title=\"app group å’Œ keychain group åŒºåˆ«\"></a>app group å’Œ keychain group åŒºåˆ«</h2><p>App groups and keychain access groups arenâ€™t mutually exclusiveâ€”you can use both in the same appâ€”but they do differ in several important ways that may help you decide which to use for a given situation.</p>\n<p>ä¸¤è€…ä¸æ˜¯äº’ç›¸æ’æ–¥çš„ï¼Œ ä¸€ä¸ªappå¯ä»¥åŒæ—¶åŠ å…¥keychain group å’Œ app groupã€‚</p>\n<p>First, as described above, using an app group enables additional data sharing beyond keychain items. You might want this extra sharing, or might already be using an app group for this purpose, and thus not need to add keychain access groups. On the other hand, you might not want to enable this additional sharing at all, and prefer keychain access groups instead.</p>\n<p>app group é™¤äº†å…±äº« keychain item ä¹‹å¤–ï¼Œè¿˜èƒ½å…±äº«å…¶ä»–å†…å®¹ï¼Œä¾‹å¦‚å…±äº«åå¥½è®¾ç½®</p>\n<figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pf\">let <span class=\"hljs-keyword\">user</span>Defualts = UserDefaults.init(suiteName: <span class=\"hljs-string\">&quot;$(group_Id)&quot;</span>)<br><span class=\"hljs-keyword\">user</span>Defualts?.<span class=\"hljs-built_in\">set</span>Value(data, <span class=\"hljs-keyword\">for</span>Key: key)<br><span class=\"hljs-keyword\">user</span>Defualts?.synchronize()<br></code></pre></td></tr></table></figure>\n\n\n<p>Second, order matters. The system considers the first item in the list of access groups to be the appâ€™s default access group. This is the access group that keychain services assumes if you donâ€™t otherwise specify one when adding keychain items. An app group canâ€™t ever be the default, because the app ID is always present and appears earlier in the list. However, a keychain access group can be the default, because it appears before the app ID. In particular, the first keychain access group, if any, that you specify in the corresponding capability becomes the appâ€™s default access group. If you donâ€™t specify any keychain access groups, then the app ID is the default.</p>\n<p>å…³äºé»˜è®¤ groupï¼Œ å½“æ·»åŠ ï¼ŒæŸ¥è¯¢ï¼Œæ›´æ–°ï¼Œåˆ é™¤ keychain item æ—¶ï¼Œä¸æŒ‡å®š<code>kSecAttrAccessGroup </code>æ—¶ï¼Œé»˜è®¤æ“ä½œçš„æ˜¯å“ªä¸ªgroup ï¼Ÿ</p>\n<ol>\n<li>ç³»ç»Ÿä»¥ group list æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªä¸ºé»˜è®¤ group</li>\n<li>é»˜è®¤group ä¸ä¼šæ˜¯app groupï¼Œ å› ä¸ºå®ƒä¸ä¼šæ˜¯ç¬¬ä¸€ä¸ª</li>\n<li>å¦‚æœåŠ å…¥keychain groupï¼Œ è¯¥ keychain group å¯èƒ½ä¸ºé»˜è®¤çš„ keychain group</li>\n<li>æƒ³é™å®škeychain item åªåœ¨ app å†…è®¿é—®ï¼Œä¸èƒ½è¢«keychain group è®¿é—®ï¼Œéœ€è¦å°† bundle id æ‰€åœ¨çš„keychain group ç½®é¡¶ï¼Œæˆ–è€…æ˜ç¡®æŒ‡å®šä½¿ç”¨ bundle id æ ‡è®°çš„keychain group</li>\n</ol>\n"},{"layout":"post","title":"ä½¿ç”¨ Apple Configurator è·å– ipa æ–‡ä»¶","date":"2023-03-13T16:00:00.000Z","_content":"\n\nå‚è€ƒï¼š[Apple Configuration 2 è·å–ipaæ–‡ä»¶](https://www.jianshu.com/p/86f35a6a64a7)\n\n\n# å·¥å…· Apple Configurator\n\nå¯ä»¥åœ¨ Mac çš„ App Store ä¸­ä¸‹è½½\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787776997821678777699715.png)\n\n\n\n# æ“ä½œ\n\n1. è¿æ¥æ‰‹æœº\n\n2. ç‚¹å‡» Add -> Apps -> è¾“å…¥ app åå­— -> ç‚¹å‡»æ·»åŠ \n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787779407831678777940467.png)\n\n3. ç­‰å¾…ä¸‹è½½å®Œæˆ, ä¸è¦æ“ä½œ\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787783759431678778375920.png)\n\n4. å»ç›®å½•é‡Œæ‰¾ ipa æ–‡ä»¶\n\n```\n~/Library/Group Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/Assets/TemporaryItems/MobileApps/36244314-7400-420B-BC2A-AC3C4988F115/414478124/WeChat 8.0.33.ipa\n```\n\n","source":"_posts/ios/2023-03-14-ä½¿ç”¨Apple Configurator è·å– ipa æ–‡ä»¶.md","raw":"\n---\n\nlayout: post\ntitle: \"ä½¿ç”¨ Apple Configurator è·å– ipa æ–‡ä»¶\"\ndate: 2023-03-14\ntag: iOS\n\n---\n\n\nå‚è€ƒï¼š[Apple Configuration 2 è·å–ipaæ–‡ä»¶](https://www.jianshu.com/p/86f35a6a64a7)\n\n\n# å·¥å…· Apple Configurator\n\nå¯ä»¥åœ¨ Mac çš„ App Store ä¸­ä¸‹è½½\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787776997821678777699715.png)\n\n\n\n# æ“ä½œ\n\n1. è¿æ¥æ‰‹æœº\n\n2. ç‚¹å‡» Add -> Apps -> è¾“å…¥ app åå­— -> ç‚¹å‡»æ·»åŠ \n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787779407831678777940467.png)\n\n3. ç­‰å¾…ä¸‹è½½å®Œæˆ, ä¸è¦æ“ä½œ\n\n![](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787783759431678778375920.png)\n\n4. å»ç›®å½•é‡Œæ‰¾ ipa æ–‡ä»¶\n\n```\n~/Library/Group Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/Assets/TemporaryItems/MobileApps/36244314-7400-420B-BC2A-AC3C4988F115/414478124/WeChat 8.0.33.ipa\n```\n\n","slug":"ios/2023-03-14-ä½¿ç”¨Apple Configurator è·å– ipa æ–‡ä»¶","published":1,"updated":"2024-03-06T11:53:13.567Z","comments":1,"photos":[],"_id":"clti3glkp001l57whbilu1h7m","content":"<p>å‚è€ƒï¼š<a href=\"https://www.jianshu.com/p/86f35a6a64a7\">Apple Configuration 2 è·å–ipaæ–‡ä»¶</a></p>\n<h1 id=\"å·¥å…·-Apple-Configurator\"><a href=\"#å·¥å…·-Apple-Configurator\" class=\"headerlink\" title=\"å·¥å…· Apple Configurator\"></a>å·¥å…· Apple Configurator</h1><p>å¯ä»¥åœ¨ Mac çš„ App Store ä¸­ä¸‹è½½</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787776997821678777699715.png\"></p>\n<h1 id=\"æ“ä½œ\"><a href=\"#æ“ä½œ\" class=\"headerlink\" title=\"æ“ä½œ\"></a>æ“ä½œ</h1><ol>\n<li><p>è¿æ¥æ‰‹æœº</p>\n</li>\n<li><p>ç‚¹å‡» Add -&gt; Apps -&gt; è¾“å…¥ app åå­— -&gt; ç‚¹å‡»æ·»åŠ </p>\n</li>\n</ol>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787779407831678777940467.png\"></p>\n<ol start=\"3\">\n<li>ç­‰å¾…ä¸‹è½½å®Œæˆ, ä¸è¦æ“ä½œ</li>\n</ol>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787783759431678778375920.png\"></p>\n<ol start=\"4\">\n<li>å»ç›®å½•é‡Œæ‰¾ ipa æ–‡ä»¶</li>\n</ol>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">~<span class=\"hljs-regexp\">/Library/</span>Group Containers<span class=\"hljs-regexp\">/K36BKF7T3D.group.com.apple.configurator/</span>Library<span class=\"hljs-regexp\">/Caches/</span>Assets<span class=\"hljs-regexp\">/TemporaryItems/</span>MobileApps<span class=\"hljs-regexp\">/36244314-7400-420B-BC2A-AC3C4988F115/</span><span class=\"hljs-number\">414478124</span>/WeChat <span class=\"hljs-number\">8.0</span>.<span class=\"hljs-number\">33</span>.ipa<br></code></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<p>å‚è€ƒï¼š<a href=\"https://www.jianshu.com/p/86f35a6a64a7\">Apple Configuration 2 è·å–ipaæ–‡ä»¶</a></p>\n<h1 id=\"å·¥å…·-Apple-Configurator\"><a href=\"#å·¥å…·-Apple-Configurator\" class=\"headerlink\" title=\"å·¥å…· Apple Configurator\"></a>å·¥å…· Apple Configurator</h1><p>å¯ä»¥åœ¨ Mac çš„ App Store ä¸­ä¸‹è½½</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787776997821678777699715.png\"></p>\n<h1 id=\"æ“ä½œ\"><a href=\"#æ“ä½œ\" class=\"headerlink\" title=\"æ“ä½œ\"></a>æ“ä½œ</h1><ol>\n<li><p>è¿æ¥æ‰‹æœº</p>\n</li>\n<li><p>ç‚¹å‡» Add -&gt; Apps -&gt; è¾“å…¥ app åå­— -&gt; ç‚¹å‡»æ·»åŠ </p>\n</li>\n</ol>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787779407831678777940467.png\"></p>\n<ol start=\"3\">\n<li>ç­‰å¾…ä¸‹è½½å®Œæˆ, ä¸è¦æ“ä½œ</li>\n</ol>\n<p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16787783759431678778375920.png\"></p>\n<ol start=\"4\">\n<li>å»ç›®å½•é‡Œæ‰¾ ipa æ–‡ä»¶</li>\n</ol>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">~<span class=\"hljs-regexp\">/Library/</span>Group Containers<span class=\"hljs-regexp\">/K36BKF7T3D.group.com.apple.configurator/</span>Library<span class=\"hljs-regexp\">/Caches/</span>Assets<span class=\"hljs-regexp\">/TemporaryItems/</span>MobileApps<span class=\"hljs-regexp\">/36244314-7400-420B-BC2A-AC3C4988F115/</span><span class=\"hljs-number\">414478124</span>/WeChat <span class=\"hljs-number\">8.0</span>.<span class=\"hljs-number\">33</span>.ipa<br></code></pre></td></tr></table></figure>\n\n"},{"layout":"post","title":"ä½¿ç”¨Xcodeè°ƒè¯•ffmpeg","date":"2022-03-08T16:00:00.000Z","_content":"\nffmpeg æºç  https://github.com/FFmpeg/FFmpeg.git\n\n## ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•\n\n```bash\n./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc\nmake -j `nproc`\n```\n\n![image20210422182014703png](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798696028ceaddb1d1dd2473496faad4c1883ba1d.png) \n\nä»¥`_g`ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„ç¨‹åº`ffmpeg_g, ffplay_g, ffprobe_g`\n\n## Xcode é…ç½®\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468770121471646877011522.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468770571461646877056550.png)\n\næŠŠ ffmpeg ç›®å½•æ‹–è¿›å·¥ç¨‹ï¼Œç­‰å¾…æ·»åŠ å®Œæˆï¼Œå¯èƒ½æ—¶é—´è¾ƒä¹…\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468356217741646835620857.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468772051421646877204301.png)ç­‰å¾…åŠ è½½å®Œæ¯•\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468780312171646878030941.png)\n\n\n\næ·»åŠ targetï¼Œ æ¯”å¦‚è¯´è°ƒè¯•`ffplay_g`\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468360299171646836029894.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468360897771646836089376.png)\n\nä¿®æ”¹å¯¹åº”çš„è·¯å¾„\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468361877781646836187409.png)\n\nä¿®æ”¹schemeï¼Œé€‰æ‹©`ffplay_g`ä¸ºå¯æ‰§è¡Œç›®æ ‡\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468363477791646836347004.png)\n\nç»™`ffplay_g`ä¼ é€’å‚æ•°\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468366427811646836642007.png)\n\nå¼€å§‹æ‰“æ–­ç‚¹è°ƒè¯•å§\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468367127821646836712289.png)\n\n## è°ƒè¯• ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äº`ffmpeg/doc/examples`è·¯å¾„ä¸‹é¢\n\n```shell\ncd ffmpeg\nmake examples\n```\n\nåç¼€å¸¦`_g`çš„éƒ½æ˜¯å¯ä»¥è°ƒè¯•çš„\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468370517811646837051618.png)\n\nä¸è°ƒè¯•ffplay_gä¸€æ ·ï¼Œæ·»åŠ targetï¼Œé…ç½®è·¯å¾„ï¼Œé…ç½®å¯æ‰§è¡Œç›®æ ‡ï¼Œæ·»åŠ å‚æ•°ï¼Œæ„‰å¿«åœ°è°ƒè¯•å§ï¼\n\n---\n\nå‚è€ƒï¼š [Xcodeè°ƒè¯•ffmpegæºç (åäº”) - ç®€ä¹¦](https://www.jianshu.com/p/27a90b113413)\n","source":"_posts/ffmpeg/2022-03-09-ä½¿ç”¨Xcodeè°ƒè¯•ffmpeg.md","raw":"---\nlayout: post\ntitle: \"ä½¿ç”¨Xcodeè°ƒè¯•ffmpeg\"\ndate: 2022-03-09 \ntag: ffmpeg\n\n---\n\nffmpeg æºç  https://github.com/FFmpeg/FFmpeg.git\n\n## ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•\n\n```bash\n./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc\nmake -j `nproc`\n```\n\n![image20210422182014703png](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798696028ceaddb1d1dd2473496faad4c1883ba1d.png) \n\nä»¥`_g`ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„ç¨‹åº`ffmpeg_g, ffplay_g, ffprobe_g`\n\n## Xcode é…ç½®\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468770121471646877011522.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468770571461646877056550.png)\n\næŠŠ ffmpeg ç›®å½•æ‹–è¿›å·¥ç¨‹ï¼Œç­‰å¾…æ·»åŠ å®Œæˆï¼Œå¯èƒ½æ—¶é—´è¾ƒä¹…\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468356217741646835620857.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468772051421646877204301.png)ç­‰å¾…åŠ è½½å®Œæ¯•\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468780312171646878030941.png)\n\n\n\næ·»åŠ targetï¼Œ æ¯”å¦‚è¯´è°ƒè¯•`ffplay_g`\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468360299171646836029894.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468360897771646836089376.png)\n\nä¿®æ”¹å¯¹åº”çš„è·¯å¾„\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468361877781646836187409.png)\n\nä¿®æ”¹schemeï¼Œé€‰æ‹©`ffplay_g`ä¸ºå¯æ‰§è¡Œç›®æ ‡\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468363477791646836347004.png)\n\nç»™`ffplay_g`ä¼ é€’å‚æ•°\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468366427811646836642007.png)\n\nå¼€å§‹æ‰“æ–­ç‚¹è°ƒè¯•å§\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468367127821646836712289.png)\n\n## è°ƒè¯• ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äº`ffmpeg/doc/examples`è·¯å¾„ä¸‹é¢\n\n```shell\ncd ffmpeg\nmake examples\n```\n\nåç¼€å¸¦`_g`çš„éƒ½æ˜¯å¯ä»¥è°ƒè¯•çš„\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468370517811646837051618.png)\n\nä¸è°ƒè¯•ffplay_gä¸€æ ·ï¼Œæ·»åŠ targetï¼Œé…ç½®è·¯å¾„ï¼Œé…ç½®å¯æ‰§è¡Œç›®æ ‡ï¼Œæ·»åŠ å‚æ•°ï¼Œæ„‰å¿«åœ°è°ƒè¯•å§ï¼\n\n---\n\nå‚è€ƒï¼š [Xcodeè°ƒè¯•ffmpegæºç (åäº”) - ç®€ä¹¦](https://www.jianshu.com/p/27a90b113413)\n","slug":"ffmpeg/2022-03-09-ä½¿ç”¨Xcodeè°ƒè¯•ffmpeg","published":1,"updated":"2024-03-06T11:53:13.565Z","comments":1,"photos":[],"_id":"clti3glkp001n57wh550e3qun","content":"<p>ffmpeg æºç  <a href=\"https://github.com/FFmpeg/FFmpeg.git\">https://github.com/FFmpeg/FFmpeg.git</a></p>\n<h2 id=\"ffmpeg-é…ç½®-ä½¿å…¶æ”¯æŒè°ƒè¯•\"><a href=\"#ffmpeg-é…ç½®-ä½¿å…¶æ”¯æŒè°ƒè¯•\" class=\"headerlink\" title=\"ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•\"></a>ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc<br>make -j `<span class=\"hljs-built_in\">nproc</span>`<br></code></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798696028ceaddb1d1dd2473496faad4c1883ba1d.png\" alt=\"image20210422182014703png\"> </p>\n<p>ä»¥<code>_g</code>ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„ç¨‹åº<code>ffmpeg_g, ffplay_g, ffprobe_g</code></p>\n<h2 id=\"Xcode-é…ç½®\"><a href=\"#Xcode-é…ç½®\" class=\"headerlink\" title=\"Xcode é…ç½®\"></a>Xcode é…ç½®</h2><p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468770121471646877011522.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468770571461646877056550.png\"></p>\n<p>æŠŠ ffmpeg ç›®å½•æ‹–è¿›å·¥ç¨‹ï¼Œç­‰å¾…æ·»åŠ å®Œæˆï¼Œå¯èƒ½æ—¶é—´è¾ƒä¹…</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468356217741646835620857.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468772051421646877204301.png\">ç­‰å¾…åŠ è½½å®Œæ¯•</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468780312171646878030941.png\"></p>\n<p>æ·»åŠ targetï¼Œ æ¯”å¦‚è¯´è°ƒè¯•<code>ffplay_g</code></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468360299171646836029894.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468360897771646836089376.png\"></p>\n<p>ä¿®æ”¹å¯¹åº”çš„è·¯å¾„</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468361877781646836187409.png\"></p>\n<p>ä¿®æ”¹schemeï¼Œé€‰æ‹©<code>ffplay_g</code>ä¸ºå¯æ‰§è¡Œç›®æ ‡</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468363477791646836347004.png\"></p>\n<p>ç»™<code>ffplay_g</code>ä¼ é€’å‚æ•°</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468366427811646836642007.png\"></p>\n<p>å¼€å§‹æ‰“æ–­ç‚¹è°ƒè¯•å§</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468367127821646836712289.png\"></p>\n<h2 id=\"è°ƒè¯•-ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äºffmpeg-doc-examplesè·¯å¾„ä¸‹é¢\"><a href=\"#è°ƒè¯•-ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äºffmpeg-doc-examplesè·¯å¾„ä¸‹é¢\" class=\"headerlink\" title=\"è°ƒè¯• ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äºffmpeg/doc/examplesè·¯å¾„ä¸‹é¢\"></a>è°ƒè¯• ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äº<code>ffmpeg/doc/examples</code>è·¯å¾„ä¸‹é¢</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">cd ffmpeg<br>make examples<br></code></pre></td></tr></table></figure>\n\n<p>åç¼€å¸¦<code>_g</code>çš„éƒ½æ˜¯å¯ä»¥è°ƒè¯•çš„</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468370517811646837051618.png\"></p>\n<p>ä¸è°ƒè¯•ffplay_gä¸€æ ·ï¼Œæ·»åŠ targetï¼Œé…ç½®è·¯å¾„ï¼Œé…ç½®å¯æ‰§è¡Œç›®æ ‡ï¼Œæ·»åŠ å‚æ•°ï¼Œæ„‰å¿«åœ°è°ƒè¯•å§ï¼</p>\n<hr>\n<p>å‚è€ƒï¼š <a href=\"https://www.jianshu.com/p/27a90b113413\">Xcodeè°ƒè¯•ffmpegæºç (åäº”) - ç®€ä¹¦</a></p>\n","excerpt":"","more":"<p>ffmpeg æºç  <a href=\"https://github.com/FFmpeg/FFmpeg.git\">https://github.com/FFmpeg/FFmpeg.git</a></p>\n<h2 id=\"ffmpeg-é…ç½®-ä½¿å…¶æ”¯æŒè°ƒè¯•\"><a href=\"#ffmpeg-é…ç½®-ä½¿å…¶æ”¯æŒè°ƒè¯•\" class=\"headerlink\" title=\"ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•\"></a>ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc<br>make -j `<span class=\"hljs-built_in\">nproc</span>`<br></code></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798696028ceaddb1d1dd2473496faad4c1883ba1d.png\" alt=\"image20210422182014703png\"> </p>\n<p>ä»¥<code>_g</code>ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„ç¨‹åº<code>ffmpeg_g, ffplay_g, ffprobe_g</code></p>\n<h2 id=\"Xcode-é…ç½®\"><a href=\"#Xcode-é…ç½®\" class=\"headerlink\" title=\"Xcode é…ç½®\"></a>Xcode é…ç½®</h2><p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468770121471646877011522.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468770571461646877056550.png\"></p>\n<p>æŠŠ ffmpeg ç›®å½•æ‹–è¿›å·¥ç¨‹ï¼Œç­‰å¾…æ·»åŠ å®Œæˆï¼Œå¯èƒ½æ—¶é—´è¾ƒä¹…</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468356217741646835620857.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468772051421646877204301.png\">ç­‰å¾…åŠ è½½å®Œæ¯•</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468780312171646878030941.png\"></p>\n<p>æ·»åŠ targetï¼Œ æ¯”å¦‚è¯´è°ƒè¯•<code>ffplay_g</code></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468360299171646836029894.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468360897771646836089376.png\"></p>\n<p>ä¿®æ”¹å¯¹åº”çš„è·¯å¾„</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468361877781646836187409.png\"></p>\n<p>ä¿®æ”¹schemeï¼Œé€‰æ‹©<code>ffplay_g</code>ä¸ºå¯æ‰§è¡Œç›®æ ‡</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468363477791646836347004.png\"></p>\n<p>ç»™<code>ffplay_g</code>ä¼ é€’å‚æ•°</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468366427811646836642007.png\"></p>\n<p>å¼€å§‹æ‰“æ–­ç‚¹è°ƒè¯•å§</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468367127821646836712289.png\"></p>\n<h2 id=\"è°ƒè¯•-ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äºffmpeg-doc-examplesè·¯å¾„ä¸‹é¢\"><a href=\"#è°ƒè¯•-ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äºffmpeg-doc-examplesè·¯å¾„ä¸‹é¢\" class=\"headerlink\" title=\"è°ƒè¯• ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äºffmpeg/doc/examplesè·¯å¾„ä¸‹é¢\"></a>è°ƒè¯• ffmpegå®˜æ–¹çš„ç¤ºä¾‹ç¨‹åºï¼Œç¤ºä¾‹ä½äº<code>ffmpeg/doc/examples</code>è·¯å¾„ä¸‹é¢</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">cd ffmpeg<br>make examples<br></code></pre></td></tr></table></figure>\n\n<p>åç¼€å¸¦<code>_g</code>çš„éƒ½æ˜¯å¯ä»¥è°ƒè¯•çš„</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468370517811646837051618.png\"></p>\n<p>ä¸è°ƒè¯•ffplay_gä¸€æ ·ï¼Œæ·»åŠ targetï¼Œé…ç½®è·¯å¾„ï¼Œé…ç½®å¯æ‰§è¡Œç›®æ ‡ï¼Œæ·»åŠ å‚æ•°ï¼Œæ„‰å¿«åœ°è°ƒè¯•å§ï¼</p>\n<hr>\n<p>å‚è€ƒï¼š <a href=\"https://www.jianshu.com/p/27a90b113413\">Xcodeè°ƒè¯•ffmpegæºç (åäº”) - ç®€ä¹¦</a></p>\n"},{"layout":"post","title":"å¦‚ä½•ä½¿ç”¨vscodeåœ¨macOSå¹³å°è°ƒè¯•ffmpeg","date":"2022-03-08T16:00:00.000Z","_content":"\n# ä½¿ç”¨vscodeè°ƒè¯•ffmpeg\n\nå‡†å¤‡çŸ¥è¯†ï¼š[Debug C++ in Visual Studio Code](https://code.visualstudio.com/docs/cpp/cpp-debug)\n\nffmpeg æºç  https://github.com/FFmpeg/FFmpeg.git\n\n## ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•\n\nå…³äº`-g3`ç›¸å…³çŸ¥è¯†[gcc-g-vs-g3-gdb-flag-what-is-the-difference](https://stackoverflow.com/questions/10475040/gcc-g-vs-g3-gdb-flag-what-is-the-difference)\n\n```bash\n./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc\nmake -j `nproc`\n```\n\n![image-20210422182014703.png](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798696028ceaddb1d1dd2473496faad4c1883ba1d.png)\nä»¥`_g`ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„ç¨‹åº`ffmpeg_g, ffplay_g, ffprobe_g`\n\n## vscodeé…ç½®\n\n![image-20210422181630503.png](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798890870e47d61888a5e4095b6b1fd9c30246471.png)\n\nå¦‚ä¸‹å‘½ä»¤ï¼š\n\n```\n# macOSä¸Šåˆ—å‡ºæ‰€æœ‰çš„éŸ³è§†é¢‘è®¾å¤‡\nffmpeg -f avfoundation -list_devices true -i \"\"\n```\n\n> launch.json å¯¹åº”çš„é…ç½®\n\n```\n{\n    // Use IntelliSense to learn about possible attributes.\n    // Hover to view descriptions of existing attributes.\n    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387\n    \"version\": \"0.2.0\",\n    \"configurations\": [\n        {\n            \"name\": \"(lldb) Launch\",\n            \"type\": \"cppdbg\",\n            \"request\": \"launch\",\n            \"program\": \"${workspaceFolder}/ffmpeg_g\",\n            \"args\": [\"-f\", \"avfoundation\", \"-list_devices\", \"true\", \"-i\", \"\\\"\\\"\"],\n            \"stopAtEntry\": false,\n            \"cwd\": \"${workspaceFolder}\",\n            \"environment\": [],\n            \"externalConsole\": false,\n            \"MIMode\": \"lldb\"\n        }\n    ]\n}\n```\n\næ‰“ä¸Šæ–­ç‚¹ï¼Œç‚¹å‡»è¿è¡Œï¼Œå°±å¯ä»¥æ„‰å¿«çš„è°ƒè¯•äº†\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/164679893487073e861799f104c449a57f809f7e7c1e1.png)\n\né™„ä¸Šé“¾æ¥ï¼šlldb ä½¿ç”¨æ•™ç¨‹ [Tutorial](https://lldb.llvm.org/use/tutorial.html)\n\n# è°ƒè¯•ffmpeg/doc/example\n\n```shell\nmake examples \n```\n\nåœ¨ffmpeg/doc/exampleç›®å½•ä¸‹, ä»¥`_g`ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468208261531646820825284.png)\n\né…ç½®launch.json\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468210321531646821031535.png)\n\nå¼€å§‹è°ƒè¯•å§\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468211571521646821156644.png)\n\n## ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘\n\n ä¾‹å¦‚ä½ åœ¨è°ƒè¯•çš„æ—¶å€™ï¼Œä¿®æ”¹äº†ffmpegçš„æºç ï¼Œæƒ³è°ƒè¯•ä¸€ä¸‹æ›´æ”¹åçš„ä»£ç ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ç”Ÿæˆã€‚\n\n```\ncd ffmpeg\nmake -j 16\nmake examples\n```\n\nä½ æƒ³è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Œåœ¨è°ƒè¯•ä¹‹å‰è‡ªåŠ¨ç¼–è¯‘ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ\n\n#### é…ç½® `prelaunchTask`\n\n1. åœ¨tasks.jsonä¸­æ·»åŠ ä¸€ä¸ªtask\n   \n   ```\n   {\n       // See https://go.microsoft.com/fwlink/?LinkId=733558\n       // for the documentation about the tasks.json format\n       \"version\": \"2.0.0\",\n       \"tasks\": [\n           {\n               \"label\": \"make\",\n               \"type\": \"shell\",\n               \"command\": \"make -j 16; make examples\",\n               \"problemMatcher\": [],\n               \"group\": {\n                   \"kind\": \"build\",\n                   \"isDefault\": true\n               },\n               \"options\": {\n                   \"cwd\": \"${workspaceFolder}\"\n               }\n           }\n       ]\n   }\n   ```\n\n2. åœ¨launch.jsonä¸­é…ç½®prelaunchTask\n   \n   ![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16472372959411647237295151.png)\n\nç„¶åä¿®æ”¹ä»£ç ï¼Œç‚¹å‡»è°ƒè¯•ï¼Œ vscode è‡ªåŠ¨æ‰§è¡Œmakeï¼Œç¼–è¯‘ä¿®æ”¹åçš„æ–‡ä»¶ï¼Œé‡æ–°ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºã€‚ç„¶åå°±å¯ä»¥æ„‰å¿«åœ°ä¿®æ”¹ä»£ç ï¼Œè°ƒè¯•ï¼Œä¿®æ”¹ä¹Ÿä¼šå³æ—¶ç”Ÿæ•ˆã€‚\n\n## å¤‡æ³¨ï¼šm1 èŠ¯ç‰‡çš„mac å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜\n\n[ ERROR: Unable to start debugging. Unexpected LLDB output from command \"-exec-run\". process exited with status -1 (attach failed ((os/kern) invalid argument))Â ](https://github.com/microsoft/vscode-cpptools/issues/6779)\n\nè§£å†³åŠæ³•ï¼š\n\nä½¿ç”¨ `CodeLLDB debugger`æ’ä»¶ï¼Œè€Œä¸æ˜¯vc code åŸç”Ÿçš„è°ƒè¯•æ’ä»¶\n\n> I would suggest you to use CodeLLDB debugger (vadimcn.vscode-lldb). It's an extension in VSCode and works exactly like the native debugger in VSCode. For its setup, you just need to change the configuration of your launch.json file with the one provided by the extension. And that should do the trick.\n\n> Now if you would try to debug then, VSCode will make use of that extension and should be able to debug your programs as it was to be done by the native debugger.\n\n> I am personally using it on my M1 chip MacBook Air, and it works perfectly fine. According to me, It's much easier to implement than other workarounds present at the moment.\n","source":"_posts/ffmpeg/2022-03-09-å¦‚ä½•ä½¿ç”¨vscodeåœ¨macOSå¹³å°è°ƒè¯•ffmpeg.md","raw":"---\nlayout: post\ntitle: \"å¦‚ä½•ä½¿ç”¨vscodeåœ¨macOSå¹³å°è°ƒè¯•ffmpeg\"\ndate: 2022-03-09 \ntag: ffmpeg\n\n---\n\n# ä½¿ç”¨vscodeè°ƒè¯•ffmpeg\n\nå‡†å¤‡çŸ¥è¯†ï¼š[Debug C++ in Visual Studio Code](https://code.visualstudio.com/docs/cpp/cpp-debug)\n\nffmpeg æºç  https://github.com/FFmpeg/FFmpeg.git\n\n## ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•\n\nå…³äº`-g3`ç›¸å…³çŸ¥è¯†[gcc-g-vs-g3-gdb-flag-what-is-the-difference](https://stackoverflow.com/questions/10475040/gcc-g-vs-g3-gdb-flag-what-is-the-difference)\n\n```bash\n./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc\nmake -j `nproc`\n```\n\n![image-20210422182014703.png](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798696028ceaddb1d1dd2473496faad4c1883ba1d.png)\nä»¥`_g`ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„ç¨‹åº`ffmpeg_g, ffplay_g, ffprobe_g`\n\n## vscodeé…ç½®\n\n![image-20210422181630503.png](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798890870e47d61888a5e4095b6b1fd9c30246471.png)\n\nå¦‚ä¸‹å‘½ä»¤ï¼š\n\n```\n# macOSä¸Šåˆ—å‡ºæ‰€æœ‰çš„éŸ³è§†é¢‘è®¾å¤‡\nffmpeg -f avfoundation -list_devices true -i \"\"\n```\n\n> launch.json å¯¹åº”çš„é…ç½®\n\n```\n{\n    // Use IntelliSense to learn about possible attributes.\n    // Hover to view descriptions of existing attributes.\n    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387\n    \"version\": \"0.2.0\",\n    \"configurations\": [\n        {\n            \"name\": \"(lldb) Launch\",\n            \"type\": \"cppdbg\",\n            \"request\": \"launch\",\n            \"program\": \"${workspaceFolder}/ffmpeg_g\",\n            \"args\": [\"-f\", \"avfoundation\", \"-list_devices\", \"true\", \"-i\", \"\\\"\\\"\"],\n            \"stopAtEntry\": false,\n            \"cwd\": \"${workspaceFolder}\",\n            \"environment\": [],\n            \"externalConsole\": false,\n            \"MIMode\": \"lldb\"\n        }\n    ]\n}\n```\n\næ‰“ä¸Šæ–­ç‚¹ï¼Œç‚¹å‡»è¿è¡Œï¼Œå°±å¯ä»¥æ„‰å¿«çš„è°ƒè¯•äº†\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/164679893487073e861799f104c449a57f809f7e7c1e1.png)\n\né™„ä¸Šé“¾æ¥ï¼šlldb ä½¿ç”¨æ•™ç¨‹ [Tutorial](https://lldb.llvm.org/use/tutorial.html)\n\n# è°ƒè¯•ffmpeg/doc/example\n\n```shell\nmake examples \n```\n\nåœ¨ffmpeg/doc/exampleç›®å½•ä¸‹, ä»¥`_g`ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468208261531646820825284.png)\n\né…ç½®launch.json\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468210321531646821031535.png)\n\nå¼€å§‹è°ƒè¯•å§\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468211571521646821156644.png)\n\n## ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘\n\n ä¾‹å¦‚ä½ åœ¨è°ƒè¯•çš„æ—¶å€™ï¼Œä¿®æ”¹äº†ffmpegçš„æºç ï¼Œæƒ³è°ƒè¯•ä¸€ä¸‹æ›´æ”¹åçš„ä»£ç ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ç”Ÿæˆã€‚\n\n```\ncd ffmpeg\nmake -j 16\nmake examples\n```\n\nä½ æƒ³è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Œåœ¨è°ƒè¯•ä¹‹å‰è‡ªåŠ¨ç¼–è¯‘ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ\n\n#### é…ç½® `prelaunchTask`\n\n1. åœ¨tasks.jsonä¸­æ·»åŠ ä¸€ä¸ªtask\n   \n   ```\n   {\n       // See https://go.microsoft.com/fwlink/?LinkId=733558\n       // for the documentation about the tasks.json format\n       \"version\": \"2.0.0\",\n       \"tasks\": [\n           {\n               \"label\": \"make\",\n               \"type\": \"shell\",\n               \"command\": \"make -j 16; make examples\",\n               \"problemMatcher\": [],\n               \"group\": {\n                   \"kind\": \"build\",\n                   \"isDefault\": true\n               },\n               \"options\": {\n                   \"cwd\": \"${workspaceFolder}\"\n               }\n           }\n       ]\n   }\n   ```\n\n2. åœ¨launch.jsonä¸­é…ç½®prelaunchTask\n   \n   ![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16472372959411647237295151.png)\n\nç„¶åä¿®æ”¹ä»£ç ï¼Œç‚¹å‡»è°ƒè¯•ï¼Œ vscode è‡ªåŠ¨æ‰§è¡Œmakeï¼Œç¼–è¯‘ä¿®æ”¹åçš„æ–‡ä»¶ï¼Œé‡æ–°ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºã€‚ç„¶åå°±å¯ä»¥æ„‰å¿«åœ°ä¿®æ”¹ä»£ç ï¼Œè°ƒè¯•ï¼Œä¿®æ”¹ä¹Ÿä¼šå³æ—¶ç”Ÿæ•ˆã€‚\n\n## å¤‡æ³¨ï¼šm1 èŠ¯ç‰‡çš„mac å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜\n\n[ ERROR: Unable to start debugging. Unexpected LLDB output from command \"-exec-run\". process exited with status -1 (attach failed ((os/kern) invalid argument))Â ](https://github.com/microsoft/vscode-cpptools/issues/6779)\n\nè§£å†³åŠæ³•ï¼š\n\nä½¿ç”¨ `CodeLLDB debugger`æ’ä»¶ï¼Œè€Œä¸æ˜¯vc code åŸç”Ÿçš„è°ƒè¯•æ’ä»¶\n\n> I would suggest you to use CodeLLDB debugger (vadimcn.vscode-lldb). It's an extension in VSCode and works exactly like the native debugger in VSCode. For its setup, you just need to change the configuration of your launch.json file with the one provided by the extension. And that should do the trick.\n\n> Now if you would try to debug then, VSCode will make use of that extension and should be able to debug your programs as it was to be done by the native debugger.\n\n> I am personally using it on my M1 chip MacBook Air, and it works perfectly fine. According to me, It's much easier to implement than other workarounds present at the moment.\n","slug":"ffmpeg/2022-03-09-å¦‚ä½•ä½¿ç”¨vscodeåœ¨macOSå¹³å°è°ƒè¯•ffmpeg","published":1,"updated":"2024-03-06T11:53:13.565Z","comments":1,"photos":[],"_id":"clti3glkp001p57whhtrdfqkm","content":"<h1 id=\"ä½¿ç”¨vscodeè°ƒè¯•ffmpeg\"><a href=\"#ä½¿ç”¨vscodeè°ƒè¯•ffmpeg\" class=\"headerlink\" title=\"ä½¿ç”¨vscodeè°ƒè¯•ffmpeg\"></a>ä½¿ç”¨vscodeè°ƒè¯•ffmpeg</h1><p>å‡†å¤‡çŸ¥è¯†ï¼š<a href=\"https://code.visualstudio.com/docs/cpp/cpp-debug\">Debug C++ in Visual Studio Code</a></p>\n<p>ffmpeg æºç  <a href=\"https://github.com/FFmpeg/FFmpeg.git\">https://github.com/FFmpeg/FFmpeg.git</a></p>\n<h2 id=\"ffmpeg-é…ç½®-ä½¿å…¶æ”¯æŒè°ƒè¯•\"><a href=\"#ffmpeg-é…ç½®-ä½¿å…¶æ”¯æŒè°ƒè¯•\" class=\"headerlink\" title=\"ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•\"></a>ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•</h2><p>å…³äº<code>-g3</code>ç›¸å…³çŸ¥è¯†<a href=\"https://stackoverflow.com/questions/10475040/gcc-g-vs-g3-gdb-flag-what-is-the-difference\">gcc-g-vs-g3-gdb-flag-what-is-the-difference</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc<br>make -j `<span class=\"hljs-built_in\">nproc</span>`<br></code></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798696028ceaddb1d1dd2473496faad4c1883ba1d.png\" alt=\"image-20210422182014703.png\"><br>ä»¥<code>_g</code>ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„ç¨‹åº<code>ffmpeg_g, ffplay_g, ffprobe_g</code></p>\n<h2 id=\"vscodeé…ç½®\"><a href=\"#vscodeé…ç½®\" class=\"headerlink\" title=\"vscodeé…ç½®\"></a>vscodeé…ç½®</h2><p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798890870e47d61888a5e4095b6b1fd9c30246471.png\" alt=\"image-20210422181630503.png\"></p>\n<p>å¦‚ä¸‹å‘½ä»¤ï¼š</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-comment\"># macOSä¸Šåˆ—å‡ºæ‰€æœ‰çš„éŸ³è§†é¢‘è®¾å¤‡</span><br><span class=\"hljs-attribute\">ffmpeg</span> -f avfoundation -list_devices <span class=\"hljs-literal\">true</span> -i <span class=\"hljs-string\">&quot;&quot;</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>launch.json å¯¹åº”çš„é…ç½®</p>\n</blockquote>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dart\">&#123;<br>    <span class=\"hljs-comment\">// Use IntelliSense to learn about possible attributes.</span><br>    <span class=\"hljs-comment\">// Hover to view descriptions of existing attributes.</span><br>    <span class=\"hljs-comment\">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span><br>    <span class=\"hljs-string\">&quot;version&quot;</span>: <span class=\"hljs-string\">&quot;0.2.0&quot;</span>,<br>    <span class=\"hljs-string\">&quot;configurations&quot;</span>: [<br>        &#123;<br>            <span class=\"hljs-string\">&quot;name&quot;</span>: <span class=\"hljs-string\">&quot;(lldb) Launch&quot;</span>,<br>            <span class=\"hljs-string\">&quot;type&quot;</span>: <span class=\"hljs-string\">&quot;cppdbg&quot;</span>,<br>            <span class=\"hljs-string\">&quot;request&quot;</span>: <span class=\"hljs-string\">&quot;launch&quot;</span>,<br>            <span class=\"hljs-string\">&quot;program&quot;</span>: <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$&#123;workspaceFolder&#125;</span>/ffmpeg_g&quot;</span>,<br>            <span class=\"hljs-string\">&quot;args&quot;</span>: [<span class=\"hljs-string\">&quot;-f&quot;</span>, <span class=\"hljs-string\">&quot;avfoundation&quot;</span>, <span class=\"hljs-string\">&quot;-list_devices&quot;</span>, <span class=\"hljs-string\">&quot;true&quot;</span>, <span class=\"hljs-string\">&quot;-i&quot;</span>, <span class=\"hljs-string\">&quot;\\&quot;\\&quot;&quot;</span>],<br>            <span class=\"hljs-string\">&quot;stopAtEntry&quot;</span>: <span class=\"hljs-keyword\">false</span>,<br>            <span class=\"hljs-string\">&quot;cwd&quot;</span>: <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$&#123;workspaceFolder&#125;</span>&quot;</span>,<br>            <span class=\"hljs-string\">&quot;environment&quot;</span>: [],<br>            <span class=\"hljs-string\">&quot;externalConsole&quot;</span>: <span class=\"hljs-keyword\">false</span>,<br>            <span class=\"hljs-string\">&quot;MIMode&quot;</span>: <span class=\"hljs-string\">&quot;lldb&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ‰“ä¸Šæ–­ç‚¹ï¼Œç‚¹å‡»è¿è¡Œï¼Œå°±å¯ä»¥æ„‰å¿«çš„è°ƒè¯•äº†<br><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/164679893487073e861799f104c449a57f809f7e7c1e1.png\"></p>\n<p>é™„ä¸Šé“¾æ¥ï¼šlldb ä½¿ç”¨æ•™ç¨‹ <a href=\"https://lldb.llvm.org/use/tutorial.html\">Tutorial</a></p>\n<h1 id=\"è°ƒè¯•ffmpeg-doc-example\"><a href=\"#è°ƒè¯•ffmpeg-doc-example\" class=\"headerlink\" title=\"è°ƒè¯•ffmpeg&#x2F;doc&#x2F;example\"></a>è°ƒè¯•ffmpeg&#x2F;doc&#x2F;example</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">make examples <br></code></pre></td></tr></table></figure>\n\n<p>åœ¨ffmpeg&#x2F;doc&#x2F;exampleç›®å½•ä¸‹, ä»¥<code>_g</code>ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468208261531646820825284.png\"></p>\n<p>é…ç½®launch.json</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468210321531646821031535.png\"></p>\n<p>å¼€å§‹è°ƒè¯•å§</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468211571521646821156644.png\"></p>\n<h2 id=\"ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘\"><a href=\"#ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘\" class=\"headerlink\" title=\"ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘\"></a>ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘</h2><p> ä¾‹å¦‚ä½ åœ¨è°ƒè¯•çš„æ—¶å€™ï¼Œä¿®æ”¹äº†ffmpegçš„æºç ï¼Œæƒ³è°ƒè¯•ä¸€ä¸‹æ›´æ”¹åçš„ä»£ç ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ç”Ÿæˆã€‚</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">cd</span> ffmpeg<br><span class=\"hljs-keyword\">make</span> -<span class=\"hljs-keyword\">j</span> <span class=\"hljs-number\">16</span><br><span class=\"hljs-keyword\">make</span> examples<br></code></pre></td></tr></table></figure>\n\n<p>ä½ æƒ³è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Œåœ¨è°ƒè¯•ä¹‹å‰è‡ªåŠ¨ç¼–è¯‘ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ</p>\n<h4 id=\"é…ç½®-prelaunchTask\"><a href=\"#é…ç½®-prelaunchTask\" class=\"headerlink\" title=\"é…ç½® prelaunchTask\"></a>é…ç½® <code>prelaunchTask</code></h4><ol>\n<li><p>åœ¨tasks.jsonä¸­æ·»åŠ ä¸€ä¸ªtask</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dart\">&#123;<br>    <span class=\"hljs-comment\">// See https://go.microsoft.com/fwlink/?LinkId=733558</span><br>    <span class=\"hljs-comment\">// for the documentation about the tasks.json format</span><br>    <span class=\"hljs-string\">&quot;version&quot;</span>: <span class=\"hljs-string\">&quot;2.0.0&quot;</span>,<br>    <span class=\"hljs-string\">&quot;tasks&quot;</span>: [<br>        &#123;<br>            <span class=\"hljs-string\">&quot;label&quot;</span>: <span class=\"hljs-string\">&quot;make&quot;</span>,<br>            <span class=\"hljs-string\">&quot;type&quot;</span>: <span class=\"hljs-string\">&quot;shell&quot;</span>,<br>            <span class=\"hljs-string\">&quot;command&quot;</span>: <span class=\"hljs-string\">&quot;make -j 16; make examples&quot;</span>,<br>            <span class=\"hljs-string\">&quot;problemMatcher&quot;</span>: [],<br>            <span class=\"hljs-string\">&quot;group&quot;</span>: &#123;<br>                <span class=\"hljs-string\">&quot;kind&quot;</span>: <span class=\"hljs-string\">&quot;build&quot;</span>,<br>                <span class=\"hljs-string\">&quot;isDefault&quot;</span>: <span class=\"hljs-keyword\">true</span><br>            &#125;,<br>            <span class=\"hljs-string\">&quot;options&quot;</span>: &#123;<br>                <span class=\"hljs-string\">&quot;cwd&quot;</span>: <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$&#123;workspaceFolder&#125;</span>&quot;</span><br>            &#125;<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>åœ¨launch.jsonä¸­é…ç½®prelaunchTask</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16472372959411647237295151.png\"></p>\n</li>\n</ol>\n<p>ç„¶åä¿®æ”¹ä»£ç ï¼Œç‚¹å‡»è°ƒè¯•ï¼Œ vscode è‡ªåŠ¨æ‰§è¡Œmakeï¼Œç¼–è¯‘ä¿®æ”¹åçš„æ–‡ä»¶ï¼Œé‡æ–°ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºã€‚ç„¶åå°±å¯ä»¥æ„‰å¿«åœ°ä¿®æ”¹ä»£ç ï¼Œè°ƒè¯•ï¼Œä¿®æ”¹ä¹Ÿä¼šå³æ—¶ç”Ÿæ•ˆã€‚</p>\n<h2 id=\"å¤‡æ³¨ï¼šm1-èŠ¯ç‰‡çš„mac-å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜\"><a href=\"#å¤‡æ³¨ï¼šm1-èŠ¯ç‰‡çš„mac-å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜\" class=\"headerlink\" title=\"å¤‡æ³¨ï¼šm1 èŠ¯ç‰‡çš„mac å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜\"></a>å¤‡æ³¨ï¼šm1 èŠ¯ç‰‡çš„mac å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜</h2><p><a href=\"https://github.com/microsoft/vscode-cpptools/issues/6779\"> ERROR: Unable to start debugging. Unexpected LLDB output from command â€œ-exec-runâ€. process exited with status -1 (attach failed ((os&#x2F;kern) invalid argument))Â </a></p>\n<p>è§£å†³åŠæ³•ï¼š</p>\n<p>ä½¿ç”¨ <code>CodeLLDB debugger</code>æ’ä»¶ï¼Œè€Œä¸æ˜¯vc code åŸç”Ÿçš„è°ƒè¯•æ’ä»¶</p>\n<blockquote>\n<p>I would suggest you to use CodeLLDB debugger (vadimcn.vscode-lldb). Itâ€™s an extension in VSCode and works exactly like the native debugger in VSCode. For its setup, you just need to change the configuration of your launch.json file with the one provided by the extension. And that should do the trick.</p>\n</blockquote>\n<blockquote>\n<p>Now if you would try to debug then, VSCode will make use of that extension and should be able to debug your programs as it was to be done by the native debugger.</p>\n</blockquote>\n<blockquote>\n<p>I am personally using it on my M1 chip MacBook Air, and it works perfectly fine. According to me, Itâ€™s much easier to implement than other workarounds present at the moment.</p>\n</blockquote>\n","excerpt":"","more":"<h1 id=\"ä½¿ç”¨vscodeè°ƒè¯•ffmpeg\"><a href=\"#ä½¿ç”¨vscodeè°ƒè¯•ffmpeg\" class=\"headerlink\" title=\"ä½¿ç”¨vscodeè°ƒè¯•ffmpeg\"></a>ä½¿ç”¨vscodeè°ƒè¯•ffmpeg</h1><p>å‡†å¤‡çŸ¥è¯†ï¼š<a href=\"https://code.visualstudio.com/docs/cpp/cpp-debug\">Debug C++ in Visual Studio Code</a></p>\n<p>ffmpeg æºç  <a href=\"https://github.com/FFmpeg/FFmpeg.git\">https://github.com/FFmpeg/FFmpeg.git</a></p>\n<h2 id=\"ffmpeg-é…ç½®-ä½¿å…¶æ”¯æŒè°ƒè¯•\"><a href=\"#ffmpeg-é…ç½®-ä½¿å…¶æ”¯æŒè°ƒè¯•\" class=\"headerlink\" title=\"ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•\"></a>ffmpeg é…ç½®, ä½¿å…¶æ”¯æŒè°ƒè¯•</h2><p>å…³äº<code>-g3</code>ç›¸å…³çŸ¥è¯†<a href=\"https://stackoverflow.com/questions/10475040/gcc-g-vs-g3-gdb-flag-what-is-the-difference\">gcc-g-vs-g3-gdb-flag-what-is-the-difference</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc<br>make -j `<span class=\"hljs-built_in\">nproc</span>`<br></code></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798696028ceaddb1d1dd2473496faad4c1883ba1d.png\" alt=\"image-20210422182014703.png\"><br>ä»¥<code>_g</code>ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„ç¨‹åº<code>ffmpeg_g, ffplay_g, ffprobe_g</code></p>\n<h2 id=\"vscodeé…ç½®\"><a href=\"#vscodeé…ç½®\" class=\"headerlink\" title=\"vscodeé…ç½®\"></a>vscodeé…ç½®</h2><p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1646798890870e47d61888a5e4095b6b1fd9c30246471.png\" alt=\"image-20210422181630503.png\"></p>\n<p>å¦‚ä¸‹å‘½ä»¤ï¼š</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-comment\"># macOSä¸Šåˆ—å‡ºæ‰€æœ‰çš„éŸ³è§†é¢‘è®¾å¤‡</span><br><span class=\"hljs-attribute\">ffmpeg</span> -f avfoundation -list_devices <span class=\"hljs-literal\">true</span> -i <span class=\"hljs-string\">&quot;&quot;</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>launch.json å¯¹åº”çš„é…ç½®</p>\n</blockquote>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dart\">&#123;<br>    <span class=\"hljs-comment\">// Use IntelliSense to learn about possible attributes.</span><br>    <span class=\"hljs-comment\">// Hover to view descriptions of existing attributes.</span><br>    <span class=\"hljs-comment\">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span><br>    <span class=\"hljs-string\">&quot;version&quot;</span>: <span class=\"hljs-string\">&quot;0.2.0&quot;</span>,<br>    <span class=\"hljs-string\">&quot;configurations&quot;</span>: [<br>        &#123;<br>            <span class=\"hljs-string\">&quot;name&quot;</span>: <span class=\"hljs-string\">&quot;(lldb) Launch&quot;</span>,<br>            <span class=\"hljs-string\">&quot;type&quot;</span>: <span class=\"hljs-string\">&quot;cppdbg&quot;</span>,<br>            <span class=\"hljs-string\">&quot;request&quot;</span>: <span class=\"hljs-string\">&quot;launch&quot;</span>,<br>            <span class=\"hljs-string\">&quot;program&quot;</span>: <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$&#123;workspaceFolder&#125;</span>/ffmpeg_g&quot;</span>,<br>            <span class=\"hljs-string\">&quot;args&quot;</span>: [<span class=\"hljs-string\">&quot;-f&quot;</span>, <span class=\"hljs-string\">&quot;avfoundation&quot;</span>, <span class=\"hljs-string\">&quot;-list_devices&quot;</span>, <span class=\"hljs-string\">&quot;true&quot;</span>, <span class=\"hljs-string\">&quot;-i&quot;</span>, <span class=\"hljs-string\">&quot;\\&quot;\\&quot;&quot;</span>],<br>            <span class=\"hljs-string\">&quot;stopAtEntry&quot;</span>: <span class=\"hljs-keyword\">false</span>,<br>            <span class=\"hljs-string\">&quot;cwd&quot;</span>: <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$&#123;workspaceFolder&#125;</span>&quot;</span>,<br>            <span class=\"hljs-string\">&quot;environment&quot;</span>: [],<br>            <span class=\"hljs-string\">&quot;externalConsole&quot;</span>: <span class=\"hljs-keyword\">false</span>,<br>            <span class=\"hljs-string\">&quot;MIMode&quot;</span>: <span class=\"hljs-string\">&quot;lldb&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ‰“ä¸Šæ–­ç‚¹ï¼Œç‚¹å‡»è¿è¡Œï¼Œå°±å¯ä»¥æ„‰å¿«çš„è°ƒè¯•äº†<br><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/164679893487073e861799f104c449a57f809f7e7c1e1.png\"></p>\n<p>é™„ä¸Šé“¾æ¥ï¼šlldb ä½¿ç”¨æ•™ç¨‹ <a href=\"https://lldb.llvm.org/use/tutorial.html\">Tutorial</a></p>\n<h1 id=\"è°ƒè¯•ffmpeg-doc-example\"><a href=\"#è°ƒè¯•ffmpeg-doc-example\" class=\"headerlink\" title=\"è°ƒè¯•ffmpeg&#x2F;doc&#x2F;example\"></a>è°ƒè¯•ffmpeg&#x2F;doc&#x2F;example</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">make examples <br></code></pre></td></tr></table></figure>\n\n<p>åœ¨ffmpeg&#x2F;doc&#x2F;exampleç›®å½•ä¸‹, ä»¥<code>_g</code>ç»“å°¾çš„å°±æ˜¯å¯ä»¥è°ƒè¯•çš„</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468208261531646820825284.png\"></p>\n<p>é…ç½®launch.json</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468210321531646821031535.png\"></p>\n<p>å¼€å§‹è°ƒè¯•å§</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468211571521646821156644.png\"></p>\n<h2 id=\"ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘\"><a href=\"#ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘\" class=\"headerlink\" title=\"ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘\"></a>ä¿®æ”¹ä»£ç é‡æ–°ç¼–è¯‘</h2><p> ä¾‹å¦‚ä½ åœ¨è°ƒè¯•çš„æ—¶å€™ï¼Œä¿®æ”¹äº†ffmpegçš„æºç ï¼Œæƒ³è°ƒè¯•ä¸€ä¸‹æ›´æ”¹åçš„ä»£ç ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ç”Ÿæˆã€‚</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">cd</span> ffmpeg<br><span class=\"hljs-keyword\">make</span> -<span class=\"hljs-keyword\">j</span> <span class=\"hljs-number\">16</span><br><span class=\"hljs-keyword\">make</span> examples<br></code></pre></td></tr></table></figure>\n\n<p>ä½ æƒ³è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Œåœ¨è°ƒè¯•ä¹‹å‰è‡ªåŠ¨ç¼–è¯‘ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ</p>\n<h4 id=\"é…ç½®-prelaunchTask\"><a href=\"#é…ç½®-prelaunchTask\" class=\"headerlink\" title=\"é…ç½® prelaunchTask\"></a>é…ç½® <code>prelaunchTask</code></h4><ol>\n<li><p>åœ¨tasks.jsonä¸­æ·»åŠ ä¸€ä¸ªtask</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dart\">&#123;<br>    <span class=\"hljs-comment\">// See https://go.microsoft.com/fwlink/?LinkId=733558</span><br>    <span class=\"hljs-comment\">// for the documentation about the tasks.json format</span><br>    <span class=\"hljs-string\">&quot;version&quot;</span>: <span class=\"hljs-string\">&quot;2.0.0&quot;</span>,<br>    <span class=\"hljs-string\">&quot;tasks&quot;</span>: [<br>        &#123;<br>            <span class=\"hljs-string\">&quot;label&quot;</span>: <span class=\"hljs-string\">&quot;make&quot;</span>,<br>            <span class=\"hljs-string\">&quot;type&quot;</span>: <span class=\"hljs-string\">&quot;shell&quot;</span>,<br>            <span class=\"hljs-string\">&quot;command&quot;</span>: <span class=\"hljs-string\">&quot;make -j 16; make examples&quot;</span>,<br>            <span class=\"hljs-string\">&quot;problemMatcher&quot;</span>: [],<br>            <span class=\"hljs-string\">&quot;group&quot;</span>: &#123;<br>                <span class=\"hljs-string\">&quot;kind&quot;</span>: <span class=\"hljs-string\">&quot;build&quot;</span>,<br>                <span class=\"hljs-string\">&quot;isDefault&quot;</span>: <span class=\"hljs-keyword\">true</span><br>            &#125;,<br>            <span class=\"hljs-string\">&quot;options&quot;</span>: &#123;<br>                <span class=\"hljs-string\">&quot;cwd&quot;</span>: <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$&#123;workspaceFolder&#125;</span>&quot;</span><br>            &#125;<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>åœ¨launch.jsonä¸­é…ç½®prelaunchTask</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16472372959411647237295151.png\"></p>\n</li>\n</ol>\n<p>ç„¶åä¿®æ”¹ä»£ç ï¼Œç‚¹å‡»è°ƒè¯•ï¼Œ vscode è‡ªåŠ¨æ‰§è¡Œmakeï¼Œç¼–è¯‘ä¿®æ”¹åçš„æ–‡ä»¶ï¼Œé‡æ–°ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºã€‚ç„¶åå°±å¯ä»¥æ„‰å¿«åœ°ä¿®æ”¹ä»£ç ï¼Œè°ƒè¯•ï¼Œä¿®æ”¹ä¹Ÿä¼šå³æ—¶ç”Ÿæ•ˆã€‚</p>\n<h2 id=\"å¤‡æ³¨ï¼šm1-èŠ¯ç‰‡çš„mac-å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜\"><a href=\"#å¤‡æ³¨ï¼šm1-èŠ¯ç‰‡çš„mac-å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜\" class=\"headerlink\" title=\"å¤‡æ³¨ï¼šm1 èŠ¯ç‰‡çš„mac å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜\"></a>å¤‡æ³¨ï¼šm1 èŠ¯ç‰‡çš„mac å¦‚æœé‡åˆ°è°ƒè¯•é—®é¢˜</h2><p><a href=\"https://github.com/microsoft/vscode-cpptools/issues/6779\"> ERROR: Unable to start debugging. Unexpected LLDB output from command â€œ-exec-runâ€. process exited with status -1 (attach failed ((os&#x2F;kern) invalid argument))Â </a></p>\n<p>è§£å†³åŠæ³•ï¼š</p>\n<p>ä½¿ç”¨ <code>CodeLLDB debugger</code>æ’ä»¶ï¼Œè€Œä¸æ˜¯vc code åŸç”Ÿçš„è°ƒè¯•æ’ä»¶</p>\n<blockquote>\n<p>I would suggest you to use CodeLLDB debugger (vadimcn.vscode-lldb). Itâ€™s an extension in VSCode and works exactly like the native debugger in VSCode. For its setup, you just need to change the configuration of your launch.json file with the one provided by the extension. And that should do the trick.</p>\n</blockquote>\n<blockquote>\n<p>Now if you would try to debug then, VSCode will make use of that extension and should be able to debug your programs as it was to be done by the native debugger.</p>\n</blockquote>\n<blockquote>\n<p>I am personally using it on my M1 chip MacBook Air, and it works perfectly fine. According to me, Itâ€™s much easier to implement than other workarounds present at the moment.</p>\n</blockquote>\n"},{"layout":"post","title":"ffmpeg example 1.è§£å°è£…ï¼Œè§£ç å­¦ä¹ ","date":"2022-03-09T16:00:00.000Z","_content":"\n\n\n## èƒŒæ™¯\n\nå­¦ä¹ ffmpegï¼Œæ‰“ç®—ä»æºç å…¥æ‰‹ï¼Œæºç åˆå¤ªå¤šå¤ªå¤æ‚ã€‚å¥½åœ¨ffmpegæä¾›äº†ç¤ºä¾‹ä»£ç ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ffmpegçš„apiï¼Œ ç¤ºä¾‹ä»£ç ä½äº`ffmpeg/doc/examples`ç›®å½•ä¸‹ï¼Œå¯ä»¥[é€šè¿‡vscode æ¥è°ƒè¯•](https://yxibng.github.io/2022/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8vscode%E5%9C%A8macOS%E5%B9%B3%E5%8F%B0%E8%B0%83%E8%AF%95ffmpeg/)è¿™äº›ç¤ºä¾‹ä»£ç ï¼Œç†è§£ffmpegçš„è°ƒç”¨æ–¹å¼ã€‚\n\n\n\nè¯¥ç›®å½•ä¸‹çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468967433771646896743076.png)\n\n- decode_audio.c  æ¼”ç¤ºå¦‚ä½•è§£ç éŸ³é¢‘\n\n- decode_video.c  æ¼”ç¤ºå¦‚ä½•è§£ç è§†é¢‘\n\n- demuxing_decoding.c  æ¼”ç¤ºå¦‚ä½•è§£å°è£…æ–‡ä»¶ï¼Œå’Œè§£ç éŸ³è§†é¢‘\n\nä»Šå¤©æ¥åˆ†æ `demuxing_decoding.c`\n\n\n\n## æµç¨‹\n\n\n\n\nä½¿ç”¨çš„æ¨¡å—`libavutil`,`libavcodec`,`libavformat`\n\n- libavutil  åŒ…å«ä¸€äº›å…¬å…±çš„å·¥å…·å‡½æ•°\n\n- libavcodec ç”¨äºå„ç§ç±»å‹å£°éŸ³/å›¾åƒç¼–è§£ç \n\n- libavformat ç”¨äºå„ç§éŸ³è§†é¢‘å°è£…æ ¼å¼çš„ç”Ÿæˆå’Œè§£æï¼ŒåŒ…æ‹¬è·å–è§£ç æ‰€éœ€ä¿¡æ¯ä»¥ç”Ÿæˆè§£ç ä¸Šä¸‹æ–‡ç»“æ„å’Œè¯»å–éŸ³è§†é¢‘å¸§ç­‰åŠŸèƒ½ï¼ŒåŒ…å«demuxerså’Œmuxeråº“\n\n### 1.è§£å°è£…\n\n1. æ‰“å¼€æ–‡ä»¶ã€è·å–å°è£…ä¿¡æ¯ä¸Šä¸‹æ–‡AVFormatContextï¼ˆavformat_open_inputï¼‰\n\n2. è·å–åª’ä½“æ–‡ä»¶éŸ³è§†é¢‘ä¿¡æ¯ï¼Œè¿™ä¸€æ­¥ä¼šå°†AVFormatContextå†…éƒ¨å˜é‡å¡«å……ï¼ˆavformat_find_stream_infoï¼‰\n\n3. è·å–éŸ³è§†é¢‘æµIDã€‚ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n   \n   1. éå†AVFormatContextå†…éƒ¨æ‰€æœ‰çš„streamï¼Œå¦‚æœstreamçš„codec_typeå¯¹åº”ä¸ºaudio/videoï¼Œè¿™è®°å½•å½“å‰streamçš„IDï¼›\n   \n   2. FFmpegæä¾›av_find_best_streamæ¥å£ï¼Œå¯ä»¥ç›´æ¥è·å–ç›¸åº”ç±»å‹ï¼ˆaudio or videoï¼‰çš„æµID\n\n4. è·å–æµçš„æ¯ä¸€å¸§æ•°æ®ï¼ˆav_read_frameï¼‰  \n\n5. å…³é—­æ–‡ä»¶\n\n### 2.è§£ç \n\nè§£ç åœ¨è§£å°è£…çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸€å¸§æ•°æ®è¿›è¡Œè§£ç ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š\n\n1. ç”³è¯·è§£ç å™¨ä¸Šä¸‹æ–‡AVCodecContextï¼ˆavcodec_alloc_context3ï¼‰\n\n2. åˆå§‹åŒ–AVCodecContextå‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨å°†è§£å°è£…å¾—åˆ°çš„æµçš„è§£ç å™¨å‚æ•°è®¾ç½®è¿›æ¥ï¼ˆavcodec_parameters_to_contextï¼‰\n\n3. æ‰“å¼€è§£ç å™¨ï¼ˆavcodec_open2ï¼‰\n\n4. è§£ç æ¯ä¸€å¸§æ•°æ®ã€‚åªéœ€è¦å°†è§£å°è£…è·å–çš„å¸§ä¼ é€’ç»™è§£ç å™¨ï¼ˆavcodec_send_packetï¼‰ï¼Œå†æ¥æ”¶å³å¯ï¼ˆavcodec_receive_frameï¼‰\n\n5. å…³é—­æ–‡ä»¶å’Œè§£ç å™¨\n   \n   \n   \n\n## æºç åˆ†æ\n\n#### main å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ\n\n```c\nint main (int argc, char **argv)\n{\n    /*\n     æ‰“å¼€è¾“å…¥æ–‡ä»¶ï¼Œåˆ›å»ºAVFormatContext\n    */\n    if (avformat_open_input(&fmt_ctx, src_filename, NULL, NULL) < 0) {\n        fprintf(stderr, \"Could not open source file %s\\n\", src_filename);\n        exit(1);\n    }\n\n    /* è·å–å°è£…æ ¼å¼ä¸­çš„éŸ³è§†é¢‘ä¿¡æ¯ï¼Œå¡«å……åœ¨AVFormatContextä¸­ */\n    if (avformat_find_stream_info(fmt_ctx, NULL) < 0) {\n        fprintf(stderr, \"Could not find stream information\\n\");\n        exit(1);\n    }\n    /*\n    1. ä» fmt_ctx è¯»å–è§†é¢‘å¯¹åº”çš„AVStream\n    2. ä» AVStream è¯»å–è§£ç ç›¸å…³çš„ AVCodec\n    3. æ ¹æ® AVCodec åˆ›å»º AVCodecContextï¼Œæ ¹æ® AVStream ç»™ AVCodecContext å¡«å……è§£ç å‚æ•°\n    4. æ‰“å¼€è§£ç å™¨\n    */\n    if (open_codec_context(&video_stream_idx, &video_dec_ctx, fmt_ctx, AVMEDIA_TYPE_VIDEO) >= 0) {\n        video_stream = fmt_ctx->streams[video_stream_idx];\n    }\n    /*\n    1. ä» fmt_ctx è¯»å–éŸ³é¢‘å¯¹åº”çš„AVStream\n    2. ä» AVStream è¯»å–è§£ç ç›¸å…³çš„ AVCodec\n    3. æ ¹æ® AVCodec åˆ›å»º AVCodecContextï¼Œæ ¹æ® AVStream ç»™ AVCodecContext å¡«å……è§£ç å‚æ•°\n    4. æ‰“å¼€è§£ç å™¨\n    */\n    if (open_codec_context(&audio_stream_idx, &audio_dec_ctx, fmt_ctx, AVMEDIA_TYPE_AUDIO) >= 0) {\n        audio_stream = fmt_ctx->streams[audio_stream_idx];\n    }\n\n    //åˆ›å»ºframe, ç”¨äºå­˜å‚¨è§£ç åçš„æ•°æ®\n    frame = av_frame_alloc();\n    //åˆ›å»ºpktï¼Œç”¨äºå­˜å‚¨è§£å°è£…åä»æ–‡ä»¶ä¸­è¯»å–çš„éŸ³è§†é¢‘åŒ…\n    pkt = av_packet_alloc();\n    /*\n    ä»æ–‡ä»¶ä¸­å¾ªç¯è¯»å–éŸ³è§†é¢‘å¸§ï¼Œå­˜å…¥pkt\n    æ ¹æ®ç±»å‹åŒºåˆ†éŸ³é¢‘å¸§è¿˜æ˜¯è§†é¢‘å¸§ï¼Œåˆ†åˆ«é€ç»™å¯¹åº”çš„è§£ç å™¨å»è§£ç \n    */\n    while (av_read_frame(fmt_ctx, pkt) >= 0) {\n        // check if the packet belongs to a stream we are interested in, otherwise\n        // skip it\n        if (pkt->stream_index == video_stream_idx)\n            ret = decode_packet(video_dec_ctx, pkt);\n        else if (pkt->stream_index == audio_stream_idx)\n            ret = decode_packet(audio_dec_ctx, pkt);\n        av_packet_unref(pkt);\n        if (ret < 0)\n            break;\n    }\n\n    /* å†²æ´—éŸ³è§†é¢‘è§£ç å™¨ï¼Œå°†å‰©ä½™çš„è§£ç æ•°æ®è¯»å‡ºæ¥ */\n    if (video_dec_ctx)\n        decode_packet(video_dec_ctx, NULL);\n    if (audio_dec_ctx)\n        decode_packet(audio_dec_ctx, NULL);\nend:\n    //èµ„æºé‡Šæ”¾å’Œé€€å‡º\n    avcodec_free_context(&video_dec_ctx);\n    avcodec_free_context(&audio_dec_ctx);\n    avformat_close_input(&fmt_ctx);\n    if (video_dst_file)\n        fclose(video_dst_file);\n    if (audio_dst_file)\n        fclose(audio_dst_file);\n    av_packet_free(&pkt);\n    av_frame_free(&frame);\n    av_free(video_dst_data[0]);\n\n    return ret < 0;\n}\n\n```\n\n1. éªŒè¯è¾“å…¥å‚æ•°æ˜¯å¦æ­£ç¡®\n\n2. æ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–å°è£…ä¿¡æ¯\n\n3. æ ¹æ®å°è£…ä¿¡æ¯ï¼Œåˆ†åˆ«åˆ›å»ºè§†é¢‘è§£ç å™¨å’ŒéŸ³é¢‘è§£ç å™¨\n\n4. å¾ªç¯ä»æ–‡ä»¶ä¸­è¯»å–pkt\n   \n   1. å¦‚æœæ˜¯è§†é¢‘æ•°æ®ï¼Œé€åˆ°è§†é¢‘è§£ç å™¨ï¼Œè§£ç åå†™å…¥è§†é¢‘æ–‡ä»¶\n   \n   2. å¦‚æœæ˜¯éŸ³é¢‘æ•°æ®ï¼Œé€åˆ°éŸ³é¢‘è§£ç å™¨ï¼Œè§£ç åå†™å…¥éŸ³é¢‘æ–‡ä»¶\n\n5. å†²æ´—éŸ³é¢‘è§†é¢‘è§£ç å™¨ï¼Œè¯»å–å‰©ä½™æ•°æ®\n\n6. æ¸…ç†èµ„æºé€€å‡º\n\n# \n\n#### open_codec_context\n\n```c\nstatic int open_codec_context(int *stream_idx,\n                              AVCodecContext **dec_ctx, AVFormatContext *fmt_ctx, enum AVMediaType type)\n{\n    int ret, stream_index;\n    AVStream *st;\n    const AVCodec *dec = NULL;\n    //æ‰¾åˆ°éŸ³é¢‘/è§†é¢‘å¯¹åº”çš„stream_index\n    ret = av_find_best_stream(fmt_ctx, type, -1, -1, NULL, 0);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not find %s stream in input file '%s'\\n\",\n                av_get_media_type_string(type), src_filename);\n        return ret;\n    } else {\n        stream_index = ret;\n        //è·å–éŸ³é¢‘/è§†é¢‘å¯¹åº”çš„AVStream\n        st = fmt_ctx->streams[stream_index];\n\n        /* è·å–è§£ç å¯¹åº”çš„AVCodec */\n        dec = avcodec_find_decoder(st->codecpar->codec_id);\n        if (!dec) {\n            fprintf(stderr, \"Failed to find %s codec\\n\",\n                    av_get_media_type_string(type));\n            return AVERROR(EINVAL);\n        }\n\n        /* æ ¹æ®AVCodec åˆ›å»º AVCodecContext */\n        *dec_ctx = avcodec_alloc_context3(dec);\n        if (!*dec_ctx) {\n            fprintf(stderr, \"Failed to allocate the %s codec context\\n\",\n                    av_get_media_type_string(type));\n            return AVERROR(ENOMEM);\n        }\n        /* å°†AVStreamçš„codecparä¸­ä¿å­˜çš„è§£ç ç›¸å…³çš„å‚æ•°ï¼Œå¡«å……åˆ°AVCodecContextä¸­ */\n        if ((ret = avcodec_parameters_to_context(*dec_ctx, st->codecpar)) < 0) {\n            fprintf(stderr, \"Failed to copy %s codec parameters to decoder context\\n\",\n                    av_get_media_type_string(type));\n            return ret;\n        }\n\n        /* æ‰“å¼€è§£ç å™¨ */\n        if ((ret = avcodec_open2(*dec_ctx, dec, NULL)) < 0) {\n            fprintf(stderr, \"Failed to open %s codec\\n\",\n                    av_get_media_type_string(type));\n            return ret;\n        }\n        //stream_indexå›ä¼ \n        *stream_idx = stream_index;\n    }\n\n    return 0;\n}\n```\n\n1. è·å–AVStream\n\n2. ä»AVStreamè¯»å–è§£ç ä¿¡æ¯ï¼Œåˆ›å»ºAVCodecContext\n\n3. ç»™AVCodecContexté…ç½®å‚æ•°\n\n4. æ‰“å¼€è§£ç å™¨\n\n#### decode_packet\n\n```c\nstatic int decode_packet(AVCodecContext *dec, const AVPacket *pkt)\n{\n    int ret = 0;\n\n    // submit the packet to the decoder\n    ret = avcodec_send_packet(dec, pkt);\n    if (ret < 0) {\n        fprintf(stderr, \"Error submitting a packet for decoding (%s)\\n\", av_err2str(ret));\n        return ret;\n    }\n\n    // get all the available frames from the decoder\n    while (ret >= 0) {\n        ret = avcodec_receive_frame(dec, frame);\n        if (ret < 0) {\n            // those two return values are special and mean there is no output\n            // frame available, but there were no errors during decoding\n            if (ret == AVERROR_EOF || ret == AVERROR(EAGAIN))\n                return 0;\n\n            fprintf(stderr, \"Error during decoding (%s)\\n\", av_err2str(ret));\n            return ret;\n        }\n\n        // write the frame data to output file\n        if (dec->codec->type == AVMEDIA_TYPE_VIDEO)\n            ret = output_video_frame(frame);\n        else\n            ret = output_audio_frame(frame);\n\n        av_frame_unref(frame);\n        if (ret < 0)\n            return ret;\n    }\n\n    return 0;\n}\n```\n\n1. è°ƒç”¨avcodec_send_packetç»™è§£ç å™¨é€pkt\n\n2. è°ƒç”¨avcodec_receive_frameä»è§£ç å™¨è¯»frame\n\n3. è°ƒç”¨output_video_frameå°†è§£ç åè§†é¢‘å†™æ–‡ä»¶ï¼Œè°ƒç”¨output_audio_frameå°†è§£ç åéŸ³é¢‘å†™æ–‡ä»¶\n\n#### output_video_frame\n\n```c\nstatic int output_video_frame(AVFrame *frame)\n{\n    //è§£ç ä¸­ï¼Œå‘ç°å®½é«˜æˆ–è€…æ ¼å¼å˜äº†ï¼ŒæŠ¥é”™\n    if (frame->width != width || frame->height != height ||\n        frame->format != pix_fmt) {\n        /* To handle this change, one could call av_image_alloc again and\n         * decode the following frames into another rawvideo file. */\n        fprintf(stderr, \"Error: Width, height and pixel format have to be \"\n                \"constant in a rawvideo file, but the width, height or \"\n                \"pixel format of the input video changed:\\n\"\n                \"old: width = %d, height = %d, format = %s\\n\"\n                \"new: width = %d, height = %d, format = %s\\n\",\n                width, height, av_get_pix_fmt_name(pix_fmt),\n                frame->width, frame->height,\n                av_get_pix_fmt_name(frame->format));\n        return -1;\n    }\n    printf(\"video_frame n:%d coded_n:%d\\n\",\n           video_frame_count++, frame->coded_picture_number);\n    /*\n     ä»frameä¸­è¯»å–è§£ç åçš„æ•°æ®ï¼Œæ‹·è´åˆ°ä¹‹å‰ç”³è¯·çš„bufferä¸­\n     è°ƒç”¨av_image_copyæ˜¯ä¸ºäº†å»é™¤frameä¸­å¯èƒ½çš„å­—èŠ‚å¯¹é½çš„æ•°æ®\n     å†™å…¥æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè¦æ±‚ä¸å«æœ‰å­—èŠ‚å¯¹é½çš„æ•°æ®\n    */\n\n    av_image_copy(video_dst_data, video_dst_linesize,\n                  (const uint8_t **)(frame->data), frame->linesize,\n                  pix_fmt, width, height);\n\n    /* write to rawvideo file */\n    fwrite(video_dst_data[0], 1, video_dst_bufsize, video_dst_file);\n    return 0;\n}\n```\n\n1. åˆ¤æ–­è§£ç åçš„å®½é«˜ï¼Œæ ¼å¼æ˜¯å¦å˜æ›´ï¼Œå†™å…¥æ–‡ä»¶çš„å®½é«˜ï¼Œæ ¼å¼åº”è¯¥æ˜¯ä¸€è‡´çš„ï¼Œå¦‚æœå˜æ›´å°±æŠ¥é”™\n\n2. å°†frameä¸­çš„æ•°æ®æ‹·è´åˆ°ä¹‹å‰ç”³è¯·çš„bufferä¸­ï¼Œæ‹·è´çš„æ—¶å€™ï¼Œå»é™¤å­—èŠ‚å¯¹é½æ•°æ®\n\n3. å°†bufferä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶\n\n#### output_audio_frame\n\n```c\nstatic int output_audio_frame(AVFrame *frame)\n{\n    size_t unpadded_linesize = frame->nb_samples * av_get_bytes_per_sample(frame->format);\n    printf(\"audio_frame n:%d nb_samples:%d pts:%s\\n\",\n           audio_frame_count++, frame->nb_samples,\n           av_ts2timestr(frame->pts, &audio_dec_ctx->time_base));\n\n    /* Write the raw audio data samples of the first plane. This works\n     * fine for packed formats (e.g. AV_SAMPLE_FMT_S16). However,\n     * most audio decoders output planar audio, which uses a separate\n     * plane of audio samples for each channel (e.g. AV_SAMPLE_FMT_S16P).\n     * In other words, this code will write only the first audio channel\n     * in these cases.\n     * You should use libswresample or libavfilter to convert the frame\n     * to packed data. */\n\n    /*\n    åªå†™äº†ç¬¬ä¸€ä¸ªå£°é“çš„æ•°æ®ï¼Œå¦‚æœæ˜¯å¹³é¢å¤šå£°é“ï¼Œä½¿ç”¨libswresampleæˆ–libavfilterå°†å…¶è½¬åŒ–ä¸ºäº¤é”™ç±»å‹çš„éŸ³é¢‘å†å†™å…¥æ–‡ä»¶\n    */\n    fwrite(frame->extended_data[0], 1, unpadded_linesize, audio_dst_file);\n\n    return 0;\n}\n```\n\n1. å°†frameä¸­çš„éŸ³é¢‘çš„ç¬¬ä¸€ä¸ªå£°é“æ•°æ®å†™å…¥æ–‡ä»¶\n\n2. å¦‚æœæƒ³å†™å…¥å¤šå£°é“ï¼Œéœ€è¦é€šè¿‡libswresampleæˆ–libavfilterè½¬ä¸ºäº¤é”™å‹çš„å†å†™å…¥æ–‡ä»¶\n   \n   \n   \n   ---\n\nå‚è€ƒäº†ï¼š [FFmpeg å°è£…ã€è§£å°è£…åŠè§£ç çš„æµç¨‹ç®€ä»‹_myvestçš„ä¸“æ -CSDNåšå®¢_ffmpeg å°è£…æµç¨‹](https://blog.csdn.net/myvest/article/details/89254452)\n\n\n","source":"_posts/ffmpeg/2022-03-10-ffmpeg example å­¦ä¹  1.md","raw":"---\nlayout: post\ntitle: \"ffmpeg example 1.è§£å°è£…ï¼Œè§£ç å­¦ä¹ \"\ndate: 2022-03-10 \ntag: ffmpeg\n\n---\n\n\n\n## èƒŒæ™¯\n\nå­¦ä¹ ffmpegï¼Œæ‰“ç®—ä»æºç å…¥æ‰‹ï¼Œæºç åˆå¤ªå¤šå¤ªå¤æ‚ã€‚å¥½åœ¨ffmpegæä¾›äº†ç¤ºä¾‹ä»£ç ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ffmpegçš„apiï¼Œ ç¤ºä¾‹ä»£ç ä½äº`ffmpeg/doc/examples`ç›®å½•ä¸‹ï¼Œå¯ä»¥[é€šè¿‡vscode æ¥è°ƒè¯•](https://yxibng.github.io/2022/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8vscode%E5%9C%A8macOS%E5%B9%B3%E5%8F%B0%E8%B0%83%E8%AF%95ffmpeg/)è¿™äº›ç¤ºä¾‹ä»£ç ï¼Œç†è§£ffmpegçš„è°ƒç”¨æ–¹å¼ã€‚\n\n\n\nè¯¥ç›®å½•ä¸‹çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468967433771646896743076.png)\n\n- decode_audio.c  æ¼”ç¤ºå¦‚ä½•è§£ç éŸ³é¢‘\n\n- decode_video.c  æ¼”ç¤ºå¦‚ä½•è§£ç è§†é¢‘\n\n- demuxing_decoding.c  æ¼”ç¤ºå¦‚ä½•è§£å°è£…æ–‡ä»¶ï¼Œå’Œè§£ç éŸ³è§†é¢‘\n\nä»Šå¤©æ¥åˆ†æ `demuxing_decoding.c`\n\n\n\n## æµç¨‹\n\n\n\n\nä½¿ç”¨çš„æ¨¡å—`libavutil`,`libavcodec`,`libavformat`\n\n- libavutil  åŒ…å«ä¸€äº›å…¬å…±çš„å·¥å…·å‡½æ•°\n\n- libavcodec ç”¨äºå„ç§ç±»å‹å£°éŸ³/å›¾åƒç¼–è§£ç \n\n- libavformat ç”¨äºå„ç§éŸ³è§†é¢‘å°è£…æ ¼å¼çš„ç”Ÿæˆå’Œè§£æï¼ŒåŒ…æ‹¬è·å–è§£ç æ‰€éœ€ä¿¡æ¯ä»¥ç”Ÿæˆè§£ç ä¸Šä¸‹æ–‡ç»“æ„å’Œè¯»å–éŸ³è§†é¢‘å¸§ç­‰åŠŸèƒ½ï¼ŒåŒ…å«demuxerså’Œmuxeråº“\n\n### 1.è§£å°è£…\n\n1. æ‰“å¼€æ–‡ä»¶ã€è·å–å°è£…ä¿¡æ¯ä¸Šä¸‹æ–‡AVFormatContextï¼ˆavformat_open_inputï¼‰\n\n2. è·å–åª’ä½“æ–‡ä»¶éŸ³è§†é¢‘ä¿¡æ¯ï¼Œè¿™ä¸€æ­¥ä¼šå°†AVFormatContextå†…éƒ¨å˜é‡å¡«å……ï¼ˆavformat_find_stream_infoï¼‰\n\n3. è·å–éŸ³è§†é¢‘æµIDã€‚ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n   \n   1. éå†AVFormatContextå†…éƒ¨æ‰€æœ‰çš„streamï¼Œå¦‚æœstreamçš„codec_typeå¯¹åº”ä¸ºaudio/videoï¼Œè¿™è®°å½•å½“å‰streamçš„IDï¼›\n   \n   2. FFmpegæä¾›av_find_best_streamæ¥å£ï¼Œå¯ä»¥ç›´æ¥è·å–ç›¸åº”ç±»å‹ï¼ˆaudio or videoï¼‰çš„æµID\n\n4. è·å–æµçš„æ¯ä¸€å¸§æ•°æ®ï¼ˆav_read_frameï¼‰  \n\n5. å…³é—­æ–‡ä»¶\n\n### 2.è§£ç \n\nè§£ç åœ¨è§£å°è£…çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸€å¸§æ•°æ®è¿›è¡Œè§£ç ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š\n\n1. ç”³è¯·è§£ç å™¨ä¸Šä¸‹æ–‡AVCodecContextï¼ˆavcodec_alloc_context3ï¼‰\n\n2. åˆå§‹åŒ–AVCodecContextå‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨å°†è§£å°è£…å¾—åˆ°çš„æµçš„è§£ç å™¨å‚æ•°è®¾ç½®è¿›æ¥ï¼ˆavcodec_parameters_to_contextï¼‰\n\n3. æ‰“å¼€è§£ç å™¨ï¼ˆavcodec_open2ï¼‰\n\n4. è§£ç æ¯ä¸€å¸§æ•°æ®ã€‚åªéœ€è¦å°†è§£å°è£…è·å–çš„å¸§ä¼ é€’ç»™è§£ç å™¨ï¼ˆavcodec_send_packetï¼‰ï¼Œå†æ¥æ”¶å³å¯ï¼ˆavcodec_receive_frameï¼‰\n\n5. å…³é—­æ–‡ä»¶å’Œè§£ç å™¨\n   \n   \n   \n\n## æºç åˆ†æ\n\n#### main å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ\n\n```c\nint main (int argc, char **argv)\n{\n    /*\n     æ‰“å¼€è¾“å…¥æ–‡ä»¶ï¼Œåˆ›å»ºAVFormatContext\n    */\n    if (avformat_open_input(&fmt_ctx, src_filename, NULL, NULL) < 0) {\n        fprintf(stderr, \"Could not open source file %s\\n\", src_filename);\n        exit(1);\n    }\n\n    /* è·å–å°è£…æ ¼å¼ä¸­çš„éŸ³è§†é¢‘ä¿¡æ¯ï¼Œå¡«å……åœ¨AVFormatContextä¸­ */\n    if (avformat_find_stream_info(fmt_ctx, NULL) < 0) {\n        fprintf(stderr, \"Could not find stream information\\n\");\n        exit(1);\n    }\n    /*\n    1. ä» fmt_ctx è¯»å–è§†é¢‘å¯¹åº”çš„AVStream\n    2. ä» AVStream è¯»å–è§£ç ç›¸å…³çš„ AVCodec\n    3. æ ¹æ® AVCodec åˆ›å»º AVCodecContextï¼Œæ ¹æ® AVStream ç»™ AVCodecContext å¡«å……è§£ç å‚æ•°\n    4. æ‰“å¼€è§£ç å™¨\n    */\n    if (open_codec_context(&video_stream_idx, &video_dec_ctx, fmt_ctx, AVMEDIA_TYPE_VIDEO) >= 0) {\n        video_stream = fmt_ctx->streams[video_stream_idx];\n    }\n    /*\n    1. ä» fmt_ctx è¯»å–éŸ³é¢‘å¯¹åº”çš„AVStream\n    2. ä» AVStream è¯»å–è§£ç ç›¸å…³çš„ AVCodec\n    3. æ ¹æ® AVCodec åˆ›å»º AVCodecContextï¼Œæ ¹æ® AVStream ç»™ AVCodecContext å¡«å……è§£ç å‚æ•°\n    4. æ‰“å¼€è§£ç å™¨\n    */\n    if (open_codec_context(&audio_stream_idx, &audio_dec_ctx, fmt_ctx, AVMEDIA_TYPE_AUDIO) >= 0) {\n        audio_stream = fmt_ctx->streams[audio_stream_idx];\n    }\n\n    //åˆ›å»ºframe, ç”¨äºå­˜å‚¨è§£ç åçš„æ•°æ®\n    frame = av_frame_alloc();\n    //åˆ›å»ºpktï¼Œç”¨äºå­˜å‚¨è§£å°è£…åä»æ–‡ä»¶ä¸­è¯»å–çš„éŸ³è§†é¢‘åŒ…\n    pkt = av_packet_alloc();\n    /*\n    ä»æ–‡ä»¶ä¸­å¾ªç¯è¯»å–éŸ³è§†é¢‘å¸§ï¼Œå­˜å…¥pkt\n    æ ¹æ®ç±»å‹åŒºåˆ†éŸ³é¢‘å¸§è¿˜æ˜¯è§†é¢‘å¸§ï¼Œåˆ†åˆ«é€ç»™å¯¹åº”çš„è§£ç å™¨å»è§£ç \n    */\n    while (av_read_frame(fmt_ctx, pkt) >= 0) {\n        // check if the packet belongs to a stream we are interested in, otherwise\n        // skip it\n        if (pkt->stream_index == video_stream_idx)\n            ret = decode_packet(video_dec_ctx, pkt);\n        else if (pkt->stream_index == audio_stream_idx)\n            ret = decode_packet(audio_dec_ctx, pkt);\n        av_packet_unref(pkt);\n        if (ret < 0)\n            break;\n    }\n\n    /* å†²æ´—éŸ³è§†é¢‘è§£ç å™¨ï¼Œå°†å‰©ä½™çš„è§£ç æ•°æ®è¯»å‡ºæ¥ */\n    if (video_dec_ctx)\n        decode_packet(video_dec_ctx, NULL);\n    if (audio_dec_ctx)\n        decode_packet(audio_dec_ctx, NULL);\nend:\n    //èµ„æºé‡Šæ”¾å’Œé€€å‡º\n    avcodec_free_context(&video_dec_ctx);\n    avcodec_free_context(&audio_dec_ctx);\n    avformat_close_input(&fmt_ctx);\n    if (video_dst_file)\n        fclose(video_dst_file);\n    if (audio_dst_file)\n        fclose(audio_dst_file);\n    av_packet_free(&pkt);\n    av_frame_free(&frame);\n    av_free(video_dst_data[0]);\n\n    return ret < 0;\n}\n\n```\n\n1. éªŒè¯è¾“å…¥å‚æ•°æ˜¯å¦æ­£ç¡®\n\n2. æ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–å°è£…ä¿¡æ¯\n\n3. æ ¹æ®å°è£…ä¿¡æ¯ï¼Œåˆ†åˆ«åˆ›å»ºè§†é¢‘è§£ç å™¨å’ŒéŸ³é¢‘è§£ç å™¨\n\n4. å¾ªç¯ä»æ–‡ä»¶ä¸­è¯»å–pkt\n   \n   1. å¦‚æœæ˜¯è§†é¢‘æ•°æ®ï¼Œé€åˆ°è§†é¢‘è§£ç å™¨ï¼Œè§£ç åå†™å…¥è§†é¢‘æ–‡ä»¶\n   \n   2. å¦‚æœæ˜¯éŸ³é¢‘æ•°æ®ï¼Œé€åˆ°éŸ³é¢‘è§£ç å™¨ï¼Œè§£ç åå†™å…¥éŸ³é¢‘æ–‡ä»¶\n\n5. å†²æ´—éŸ³é¢‘è§†é¢‘è§£ç å™¨ï¼Œè¯»å–å‰©ä½™æ•°æ®\n\n6. æ¸…ç†èµ„æºé€€å‡º\n\n# \n\n#### open_codec_context\n\n```c\nstatic int open_codec_context(int *stream_idx,\n                              AVCodecContext **dec_ctx, AVFormatContext *fmt_ctx, enum AVMediaType type)\n{\n    int ret, stream_index;\n    AVStream *st;\n    const AVCodec *dec = NULL;\n    //æ‰¾åˆ°éŸ³é¢‘/è§†é¢‘å¯¹åº”çš„stream_index\n    ret = av_find_best_stream(fmt_ctx, type, -1, -1, NULL, 0);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not find %s stream in input file '%s'\\n\",\n                av_get_media_type_string(type), src_filename);\n        return ret;\n    } else {\n        stream_index = ret;\n        //è·å–éŸ³é¢‘/è§†é¢‘å¯¹åº”çš„AVStream\n        st = fmt_ctx->streams[stream_index];\n\n        /* è·å–è§£ç å¯¹åº”çš„AVCodec */\n        dec = avcodec_find_decoder(st->codecpar->codec_id);\n        if (!dec) {\n            fprintf(stderr, \"Failed to find %s codec\\n\",\n                    av_get_media_type_string(type));\n            return AVERROR(EINVAL);\n        }\n\n        /* æ ¹æ®AVCodec åˆ›å»º AVCodecContext */\n        *dec_ctx = avcodec_alloc_context3(dec);\n        if (!*dec_ctx) {\n            fprintf(stderr, \"Failed to allocate the %s codec context\\n\",\n                    av_get_media_type_string(type));\n            return AVERROR(ENOMEM);\n        }\n        /* å°†AVStreamçš„codecparä¸­ä¿å­˜çš„è§£ç ç›¸å…³çš„å‚æ•°ï¼Œå¡«å……åˆ°AVCodecContextä¸­ */\n        if ((ret = avcodec_parameters_to_context(*dec_ctx, st->codecpar)) < 0) {\n            fprintf(stderr, \"Failed to copy %s codec parameters to decoder context\\n\",\n                    av_get_media_type_string(type));\n            return ret;\n        }\n\n        /* æ‰“å¼€è§£ç å™¨ */\n        if ((ret = avcodec_open2(*dec_ctx, dec, NULL)) < 0) {\n            fprintf(stderr, \"Failed to open %s codec\\n\",\n                    av_get_media_type_string(type));\n            return ret;\n        }\n        //stream_indexå›ä¼ \n        *stream_idx = stream_index;\n    }\n\n    return 0;\n}\n```\n\n1. è·å–AVStream\n\n2. ä»AVStreamè¯»å–è§£ç ä¿¡æ¯ï¼Œåˆ›å»ºAVCodecContext\n\n3. ç»™AVCodecContexté…ç½®å‚æ•°\n\n4. æ‰“å¼€è§£ç å™¨\n\n#### decode_packet\n\n```c\nstatic int decode_packet(AVCodecContext *dec, const AVPacket *pkt)\n{\n    int ret = 0;\n\n    // submit the packet to the decoder\n    ret = avcodec_send_packet(dec, pkt);\n    if (ret < 0) {\n        fprintf(stderr, \"Error submitting a packet for decoding (%s)\\n\", av_err2str(ret));\n        return ret;\n    }\n\n    // get all the available frames from the decoder\n    while (ret >= 0) {\n        ret = avcodec_receive_frame(dec, frame);\n        if (ret < 0) {\n            // those two return values are special and mean there is no output\n            // frame available, but there were no errors during decoding\n            if (ret == AVERROR_EOF || ret == AVERROR(EAGAIN))\n                return 0;\n\n            fprintf(stderr, \"Error during decoding (%s)\\n\", av_err2str(ret));\n            return ret;\n        }\n\n        // write the frame data to output file\n        if (dec->codec->type == AVMEDIA_TYPE_VIDEO)\n            ret = output_video_frame(frame);\n        else\n            ret = output_audio_frame(frame);\n\n        av_frame_unref(frame);\n        if (ret < 0)\n            return ret;\n    }\n\n    return 0;\n}\n```\n\n1. è°ƒç”¨avcodec_send_packetç»™è§£ç å™¨é€pkt\n\n2. è°ƒç”¨avcodec_receive_frameä»è§£ç å™¨è¯»frame\n\n3. è°ƒç”¨output_video_frameå°†è§£ç åè§†é¢‘å†™æ–‡ä»¶ï¼Œè°ƒç”¨output_audio_frameå°†è§£ç åéŸ³é¢‘å†™æ–‡ä»¶\n\n#### output_video_frame\n\n```c\nstatic int output_video_frame(AVFrame *frame)\n{\n    //è§£ç ä¸­ï¼Œå‘ç°å®½é«˜æˆ–è€…æ ¼å¼å˜äº†ï¼ŒæŠ¥é”™\n    if (frame->width != width || frame->height != height ||\n        frame->format != pix_fmt) {\n        /* To handle this change, one could call av_image_alloc again and\n         * decode the following frames into another rawvideo file. */\n        fprintf(stderr, \"Error: Width, height and pixel format have to be \"\n                \"constant in a rawvideo file, but the width, height or \"\n                \"pixel format of the input video changed:\\n\"\n                \"old: width = %d, height = %d, format = %s\\n\"\n                \"new: width = %d, height = %d, format = %s\\n\",\n                width, height, av_get_pix_fmt_name(pix_fmt),\n                frame->width, frame->height,\n                av_get_pix_fmt_name(frame->format));\n        return -1;\n    }\n    printf(\"video_frame n:%d coded_n:%d\\n\",\n           video_frame_count++, frame->coded_picture_number);\n    /*\n     ä»frameä¸­è¯»å–è§£ç åçš„æ•°æ®ï¼Œæ‹·è´åˆ°ä¹‹å‰ç”³è¯·çš„bufferä¸­\n     è°ƒç”¨av_image_copyæ˜¯ä¸ºäº†å»é™¤frameä¸­å¯èƒ½çš„å­—èŠ‚å¯¹é½çš„æ•°æ®\n     å†™å…¥æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè¦æ±‚ä¸å«æœ‰å­—èŠ‚å¯¹é½çš„æ•°æ®\n    */\n\n    av_image_copy(video_dst_data, video_dst_linesize,\n                  (const uint8_t **)(frame->data), frame->linesize,\n                  pix_fmt, width, height);\n\n    /* write to rawvideo file */\n    fwrite(video_dst_data[0], 1, video_dst_bufsize, video_dst_file);\n    return 0;\n}\n```\n\n1. åˆ¤æ–­è§£ç åçš„å®½é«˜ï¼Œæ ¼å¼æ˜¯å¦å˜æ›´ï¼Œå†™å…¥æ–‡ä»¶çš„å®½é«˜ï¼Œæ ¼å¼åº”è¯¥æ˜¯ä¸€è‡´çš„ï¼Œå¦‚æœå˜æ›´å°±æŠ¥é”™\n\n2. å°†frameä¸­çš„æ•°æ®æ‹·è´åˆ°ä¹‹å‰ç”³è¯·çš„bufferä¸­ï¼Œæ‹·è´çš„æ—¶å€™ï¼Œå»é™¤å­—èŠ‚å¯¹é½æ•°æ®\n\n3. å°†bufferä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶\n\n#### output_audio_frame\n\n```c\nstatic int output_audio_frame(AVFrame *frame)\n{\n    size_t unpadded_linesize = frame->nb_samples * av_get_bytes_per_sample(frame->format);\n    printf(\"audio_frame n:%d nb_samples:%d pts:%s\\n\",\n           audio_frame_count++, frame->nb_samples,\n           av_ts2timestr(frame->pts, &audio_dec_ctx->time_base));\n\n    /* Write the raw audio data samples of the first plane. This works\n     * fine for packed formats (e.g. AV_SAMPLE_FMT_S16). However,\n     * most audio decoders output planar audio, which uses a separate\n     * plane of audio samples for each channel (e.g. AV_SAMPLE_FMT_S16P).\n     * In other words, this code will write only the first audio channel\n     * in these cases.\n     * You should use libswresample or libavfilter to convert the frame\n     * to packed data. */\n\n    /*\n    åªå†™äº†ç¬¬ä¸€ä¸ªå£°é“çš„æ•°æ®ï¼Œå¦‚æœæ˜¯å¹³é¢å¤šå£°é“ï¼Œä½¿ç”¨libswresampleæˆ–libavfilterå°†å…¶è½¬åŒ–ä¸ºäº¤é”™ç±»å‹çš„éŸ³é¢‘å†å†™å…¥æ–‡ä»¶\n    */\n    fwrite(frame->extended_data[0], 1, unpadded_linesize, audio_dst_file);\n\n    return 0;\n}\n```\n\n1. å°†frameä¸­çš„éŸ³é¢‘çš„ç¬¬ä¸€ä¸ªå£°é“æ•°æ®å†™å…¥æ–‡ä»¶\n\n2. å¦‚æœæƒ³å†™å…¥å¤šå£°é“ï¼Œéœ€è¦é€šè¿‡libswresampleæˆ–libavfilterè½¬ä¸ºäº¤é”™å‹çš„å†å†™å…¥æ–‡ä»¶\n   \n   \n   \n   ---\n\nå‚è€ƒäº†ï¼š [FFmpeg å°è£…ã€è§£å°è£…åŠè§£ç çš„æµç¨‹ç®€ä»‹_myvestçš„ä¸“æ -CSDNåšå®¢_ffmpeg å°è£…æµç¨‹](https://blog.csdn.net/myvest/article/details/89254452)\n\n\n","slug":"ffmpeg/2022-03-10-ffmpeg example å­¦ä¹  1","published":1,"updated":"2024-03-06T11:53:13.565Z","comments":1,"photos":[],"_id":"clti3glkp001r57whh8ah3xvn","content":"<h2 id=\"èƒŒæ™¯\"><a href=\"#èƒŒæ™¯\" class=\"headerlink\" title=\"èƒŒæ™¯\"></a>èƒŒæ™¯</h2><p>å­¦ä¹ ffmpegï¼Œæ‰“ç®—ä»æºç å…¥æ‰‹ï¼Œæºç åˆå¤ªå¤šå¤ªå¤æ‚ã€‚å¥½åœ¨ffmpegæä¾›äº†ç¤ºä¾‹ä»£ç ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ffmpegçš„apiï¼Œ ç¤ºä¾‹ä»£ç ä½äº<code>ffmpeg/doc/examples</code>ç›®å½•ä¸‹ï¼Œå¯ä»¥<a href=\"https://yxibng.github.io/2022/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8vscode%E5%9C%A8macOS%E5%B9%B3%E5%8F%B0%E8%B0%83%E8%AF%95ffmpeg/\">é€šè¿‡vscode æ¥è°ƒè¯•</a>è¿™äº›ç¤ºä¾‹ä»£ç ï¼Œç†è§£ffmpegçš„è°ƒç”¨æ–¹å¼ã€‚</p>\n<p>è¯¥ç›®å½•ä¸‹çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468967433771646896743076.png\"></p>\n<ul>\n<li><p>decode_audio.c  æ¼”ç¤ºå¦‚ä½•è§£ç éŸ³é¢‘</p>\n</li>\n<li><p>decode_video.c  æ¼”ç¤ºå¦‚ä½•è§£ç è§†é¢‘</p>\n</li>\n<li><p>demuxing_decoding.c  æ¼”ç¤ºå¦‚ä½•è§£å°è£…æ–‡ä»¶ï¼Œå’Œè§£ç éŸ³è§†é¢‘</p>\n</li>\n</ul>\n<p>ä»Šå¤©æ¥åˆ†æ <code>demuxing_decoding.c</code></p>\n<h2 id=\"æµç¨‹\"><a href=\"#æµç¨‹\" class=\"headerlink\" title=\"æµç¨‹\"></a>æµç¨‹</h2><p>ä½¿ç”¨çš„æ¨¡å—<code>libavutil</code>,<code>libavcodec</code>,<code>libavformat</code></p>\n<ul>\n<li><p>libavutil  åŒ…å«ä¸€äº›å…¬å…±çš„å·¥å…·å‡½æ•°</p>\n</li>\n<li><p>libavcodec ç”¨äºå„ç§ç±»å‹å£°éŸ³&#x2F;å›¾åƒç¼–è§£ç </p>\n</li>\n<li><p>libavformat ç”¨äºå„ç§éŸ³è§†é¢‘å°è£…æ ¼å¼çš„ç”Ÿæˆå’Œè§£æï¼ŒåŒ…æ‹¬è·å–è§£ç æ‰€éœ€ä¿¡æ¯ä»¥ç”Ÿæˆè§£ç ä¸Šä¸‹æ–‡ç»“æ„å’Œè¯»å–éŸ³è§†é¢‘å¸§ç­‰åŠŸèƒ½ï¼ŒåŒ…å«demuxerså’Œmuxeråº“</p>\n</li>\n</ul>\n<h3 id=\"1-è§£å°è£…\"><a href=\"#1-è§£å°è£…\" class=\"headerlink\" title=\"1.è§£å°è£…\"></a>1.è§£å°è£…</h3><ol>\n<li><p>æ‰“å¼€æ–‡ä»¶ã€è·å–å°è£…ä¿¡æ¯ä¸Šä¸‹æ–‡AVFormatContextï¼ˆavformat_open_inputï¼‰</p>\n</li>\n<li><p>è·å–åª’ä½“æ–‡ä»¶éŸ³è§†é¢‘ä¿¡æ¯ï¼Œè¿™ä¸€æ­¥ä¼šå°†AVFormatContextå†…éƒ¨å˜é‡å¡«å……ï¼ˆavformat_find_stream_infoï¼‰</p>\n</li>\n<li><p>è·å–éŸ³è§†é¢‘æµIDã€‚ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>\n<ol>\n<li><p>éå†AVFormatContextå†…éƒ¨æ‰€æœ‰çš„streamï¼Œå¦‚æœstreamçš„codec_typeå¯¹åº”ä¸ºaudio&#x2F;videoï¼Œè¿™è®°å½•å½“å‰streamçš„IDï¼›</p>\n</li>\n<li><p>FFmpegæä¾›av_find_best_streamæ¥å£ï¼Œå¯ä»¥ç›´æ¥è·å–ç›¸åº”ç±»å‹ï¼ˆaudio or videoï¼‰çš„æµID</p>\n</li>\n</ol>\n</li>\n<li><p>è·å–æµçš„æ¯ä¸€å¸§æ•°æ®ï¼ˆav_read_frameï¼‰  </p>\n</li>\n<li><p>å…³é—­æ–‡ä»¶</p>\n</li>\n</ol>\n<h3 id=\"2-è§£ç \"><a href=\"#2-è§£ç \" class=\"headerlink\" title=\"2.è§£ç \"></a>2.è§£ç </h3><p>è§£ç åœ¨è§£å°è£…çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸€å¸§æ•°æ®è¿›è¡Œè§£ç ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<ol>\n<li><p>ç”³è¯·è§£ç å™¨ä¸Šä¸‹æ–‡AVCodecContextï¼ˆavcodec_alloc_context3ï¼‰</p>\n</li>\n<li><p>åˆå§‹åŒ–AVCodecContextå‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨å°†è§£å°è£…å¾—åˆ°çš„æµçš„è§£ç å™¨å‚æ•°è®¾ç½®è¿›æ¥ï¼ˆavcodec_parameters_to_contextï¼‰</p>\n</li>\n<li><p>æ‰“å¼€è§£ç å™¨ï¼ˆavcodec_open2ï¼‰</p>\n</li>\n<li><p>è§£ç æ¯ä¸€å¸§æ•°æ®ã€‚åªéœ€è¦å°†è§£å°è£…è·å–çš„å¸§ä¼ é€’ç»™è§£ç å™¨ï¼ˆavcodec_send_packetï¼‰ï¼Œå†æ¥æ”¶å³å¯ï¼ˆavcodec_receive_frameï¼‰</p>\n</li>\n<li><p>å…³é—­æ–‡ä»¶å’Œè§£ç å™¨</p>\n</li>\n</ol>\n<h2 id=\"æºç åˆ†æ\"><a href=\"#æºç åˆ†æ\" class=\"headerlink\" title=\"æºç åˆ†æ\"></a>æºç åˆ†æ</h2><h4 id=\"main-å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ\"><a href=\"#main-å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ\" class=\"headerlink\" title=\"main å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ\"></a>main å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">main</span> <span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">char</span> **argv)</span><br>&#123;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     æ‰“å¼€è¾“å…¥æ–‡ä»¶ï¼Œåˆ›å»ºAVFormatContext</span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">if</span> (avformat_open_input(&amp;fmt_ctx, src_filename, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open source file %s\\n&quot;</span>, src_filename);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* è·å–å°è£…æ ¼å¼ä¸­çš„éŸ³è§†é¢‘ä¿¡æ¯ï¼Œå¡«å……åœ¨AVFormatContextä¸­ */</span><br>    <span class=\"hljs-keyword\">if</span> (avformat_find_stream_info(fmt_ctx, <span class=\"hljs-literal\">NULL</span>) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not find stream information\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">    1. ä» fmt_ctx è¯»å–è§†é¢‘å¯¹åº”çš„AVStream</span><br><span class=\"hljs-comment\">    2. ä» AVStream è¯»å–è§£ç ç›¸å…³çš„ AVCodec</span><br><span class=\"hljs-comment\">    3. æ ¹æ® AVCodec åˆ›å»º AVCodecContextï¼Œæ ¹æ® AVStream ç»™ AVCodecContext å¡«å……è§£ç å‚æ•°</span><br><span class=\"hljs-comment\">    4. æ‰“å¼€è§£ç å™¨</span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">if</span> (open_codec_context(&amp;video_stream_idx, &amp;video_dec_ctx, fmt_ctx, AVMEDIA_TYPE_VIDEO) &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        video_stream = fmt_ctx-&gt;streams[video_stream_idx];<br>    &#125;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">    1. ä» fmt_ctx è¯»å–éŸ³é¢‘å¯¹åº”çš„AVStream</span><br><span class=\"hljs-comment\">    2. ä» AVStream è¯»å–è§£ç ç›¸å…³çš„ AVCodec</span><br><span class=\"hljs-comment\">    3. æ ¹æ® AVCodec åˆ›å»º AVCodecContextï¼Œæ ¹æ® AVStream ç»™ AVCodecContext å¡«å……è§£ç å‚æ•°</span><br><span class=\"hljs-comment\">    4. æ‰“å¼€è§£ç å™¨</span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">if</span> (open_codec_context(&amp;audio_stream_idx, &amp;audio_dec_ctx, fmt_ctx, AVMEDIA_TYPE_AUDIO) &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        audio_stream = fmt_ctx-&gt;streams[audio_stream_idx];<br>    &#125;<br><br>    <span class=\"hljs-comment\">//åˆ›å»ºframe, ç”¨äºå­˜å‚¨è§£ç åçš„æ•°æ®</span><br>    frame = av_frame_alloc();<br>    <span class=\"hljs-comment\">//åˆ›å»ºpktï¼Œç”¨äºå­˜å‚¨è§£å°è£…åä»æ–‡ä»¶ä¸­è¯»å–çš„éŸ³è§†é¢‘åŒ…</span><br>    pkt = av_packet_alloc();<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">    ä»æ–‡ä»¶ä¸­å¾ªç¯è¯»å–éŸ³è§†é¢‘å¸§ï¼Œå­˜å…¥pkt</span><br><span class=\"hljs-comment\">    æ ¹æ®ç±»å‹åŒºåˆ†éŸ³é¢‘å¸§è¿˜æ˜¯è§†é¢‘å¸§ï¼Œåˆ†åˆ«é€ç»™å¯¹åº”çš„è§£ç å™¨å»è§£ç </span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">while</span> (av_read_frame(fmt_ctx, pkt) &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">// check if the packet belongs to a stream we are interested in, otherwise</span><br>        <span class=\"hljs-comment\">// skip it</span><br>        <span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == video_stream_idx)<br>            ret = decode_packet(video_dec_ctx, pkt);<br>        <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == audio_stream_idx)<br>            ret = decode_packet(audio_dec_ctx, pkt);<br>        av_packet_unref(pkt);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">break</span>;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* å†²æ´—éŸ³è§†é¢‘è§£ç å™¨ï¼Œå°†å‰©ä½™çš„è§£ç æ•°æ®è¯»å‡ºæ¥ */</span><br>    <span class=\"hljs-keyword\">if</span> (video_dec_ctx)<br>        decode_packet(video_dec_ctx, <span class=\"hljs-literal\">NULL</span>);<br>    <span class=\"hljs-keyword\">if</span> (audio_dec_ctx)<br>        decode_packet(audio_dec_ctx, <span class=\"hljs-literal\">NULL</span>);<br>end:<br>    <span class=\"hljs-comment\">//èµ„æºé‡Šæ”¾å’Œé€€å‡º</span><br>    avcodec_free_context(&amp;video_dec_ctx);<br>    avcodec_free_context(&amp;audio_dec_ctx);<br>    avformat_close_input(&amp;fmt_ctx);<br>    <span class=\"hljs-keyword\">if</span> (video_dst_file)<br>        fclose(video_dst_file);<br>    <span class=\"hljs-keyword\">if</span> (audio_dst_file)<br>        fclose(audio_dst_file);<br>    av_packet_free(&amp;pkt);<br>    av_frame_free(&amp;frame);<br>    av_free(video_dst_data[<span class=\"hljs-number\">0</span>]);<br><br>    <span class=\"hljs-keyword\">return</span> ret &lt; <span class=\"hljs-number\">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>éªŒè¯è¾“å…¥å‚æ•°æ˜¯å¦æ­£ç¡®</p>\n</li>\n<li><p>æ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–å°è£…ä¿¡æ¯</p>\n</li>\n<li><p>æ ¹æ®å°è£…ä¿¡æ¯ï¼Œåˆ†åˆ«åˆ›å»ºè§†é¢‘è§£ç å™¨å’ŒéŸ³é¢‘è§£ç å™¨</p>\n</li>\n<li><p>å¾ªç¯ä»æ–‡ä»¶ä¸­è¯»å–pkt</p>\n<ol>\n<li><p>å¦‚æœæ˜¯è§†é¢‘æ•°æ®ï¼Œé€åˆ°è§†é¢‘è§£ç å™¨ï¼Œè§£ç åå†™å…¥è§†é¢‘æ–‡ä»¶</p>\n</li>\n<li><p>å¦‚æœæ˜¯éŸ³é¢‘æ•°æ®ï¼Œé€åˆ°éŸ³é¢‘è§£ç å™¨ï¼Œè§£ç åå†™å…¥éŸ³é¢‘æ–‡ä»¶</p>\n</li>\n</ol>\n</li>\n<li><p>å†²æ´—éŸ³é¢‘è§†é¢‘è§£ç å™¨ï¼Œè¯»å–å‰©ä½™æ•°æ®</p>\n</li>\n<li><p>æ¸…ç†èµ„æºé€€å‡º</p>\n</li>\n</ol>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><h4 id=\"open-codec-context\"><a href=\"#open-codec-context\" class=\"headerlink\" title=\"open_codec_context\"></a>open_codec_context</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">open_codec_context</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> *stream_idx,</span><br><span class=\"hljs-params\">                              AVCodecContext **dec_ctx, AVFormatContext *fmt_ctx, <span class=\"hljs-keyword\">enum</span> AVMediaType type)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret, stream_index;<br>    AVStream *st;<br>    <span class=\"hljs-type\">const</span> AVCodec *dec = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-comment\">//æ‰¾åˆ°éŸ³é¢‘/è§†é¢‘å¯¹åº”çš„stream_index</span><br>    ret = av_find_best_stream(fmt_ctx, type, <span class=\"hljs-number\">-1</span>, <span class=\"hljs-number\">-1</span>, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not find %s stream in input file &#x27;%s&#x27;\\n&quot;</span>,<br>                av_get_media_type_string(type), src_filename);<br>        <span class=\"hljs-keyword\">return</span> ret;<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        stream_index = ret;<br>        <span class=\"hljs-comment\">//è·å–éŸ³é¢‘/è§†é¢‘å¯¹åº”çš„AVStream</span><br>        st = fmt_ctx-&gt;streams[stream_index];<br><br>        <span class=\"hljs-comment\">/* è·å–è§£ç å¯¹åº”çš„AVCodec */</span><br>        dec = avcodec_find_decoder(st-&gt;codecpar-&gt;codec_id);<br>        <span class=\"hljs-keyword\">if</span> (!dec) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Failed to find %s codec\\n&quot;</span>,<br>                    av_get_media_type_string(type));<br>            <span class=\"hljs-keyword\">return</span> AVERROR(EINVAL);<br>        &#125;<br><br>        <span class=\"hljs-comment\">/* æ ¹æ®AVCodec åˆ›å»º AVCodecContext */</span><br>        *dec_ctx = avcodec_alloc_context3(dec);<br>        <span class=\"hljs-keyword\">if</span> (!*dec_ctx) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Failed to allocate the %s codec context\\n&quot;</span>,<br>                    av_get_media_type_string(type));<br>            <span class=\"hljs-keyword\">return</span> AVERROR(ENOMEM);<br>        &#125;<br>        <span class=\"hljs-comment\">/* å°†AVStreamçš„codecparä¸­ä¿å­˜çš„è§£ç ç›¸å…³çš„å‚æ•°ï¼Œå¡«å……åˆ°AVCodecContextä¸­ */</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = avcodec_parameters_to_context(*dec_ctx, st-&gt;codecpar)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Failed to copy %s codec parameters to decoder context\\n&quot;</span>,<br>                    av_get_media_type_string(type));<br>            <span class=\"hljs-keyword\">return</span> ret;<br>        &#125;<br><br>        <span class=\"hljs-comment\">/* æ‰“å¼€è§£ç å™¨ */</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = avcodec_open2(*dec_ctx, dec, <span class=\"hljs-literal\">NULL</span>)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Failed to open %s codec\\n&quot;</span>,<br>                    av_get_media_type_string(type));<br>            <span class=\"hljs-keyword\">return</span> ret;<br>        &#125;<br>        <span class=\"hljs-comment\">//stream_indexå›ä¼ </span><br>        *stream_idx = stream_index;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è·å–AVStream</p>\n</li>\n<li><p>ä»AVStreamè¯»å–è§£ç ä¿¡æ¯ï¼Œåˆ›å»ºAVCodecContext</p>\n</li>\n<li><p>ç»™AVCodecContexté…ç½®å‚æ•°</p>\n</li>\n<li><p>æ‰“å¼€è§£ç å™¨</p>\n</li>\n</ol>\n<h4 id=\"decode-packet\"><a href=\"#decode-packet\" class=\"headerlink\" title=\"decode_packet\"></a>decode_packet</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">decode_packet</span><span class=\"hljs-params\">(AVCodecContext *dec, <span class=\"hljs-type\">const</span> AVPacket *pkt)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret = <span class=\"hljs-number\">0</span>;<br><br>    <span class=\"hljs-comment\">// submit the packet to the decoder</span><br>    ret = avcodec_send_packet(dec, pkt);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error submitting a packet for decoding (%s)\\n&quot;</span>, av_err2str(ret));<br>        <span class=\"hljs-keyword\">return</span> ret;<br>    &#125;<br><br>    <span class=\"hljs-comment\">// get all the available frames from the decoder</span><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        ret = avcodec_receive_frame(dec, frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-comment\">// those two return values are special and mean there is no output</span><br>            <span class=\"hljs-comment\">// frame available, but there were no errors during decoding</span><br>            <span class=\"hljs-keyword\">if</span> (ret == AVERROR_EOF || ret == AVERROR(EAGAIN))<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br><br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error during decoding (%s)\\n&quot;</span>, av_err2str(ret));<br>            <span class=\"hljs-keyword\">return</span> ret;<br>        &#125;<br><br>        <span class=\"hljs-comment\">// write the frame data to output file</span><br>        <span class=\"hljs-keyword\">if</span> (dec-&gt;codec-&gt;type == AVMEDIA_TYPE_VIDEO)<br>            ret = output_video_frame(frame);<br>        <span class=\"hljs-keyword\">else</span><br>            ret = output_audio_frame(frame);<br><br>        av_frame_unref(frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">return</span> ret;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è°ƒç”¨avcodec_send_packetç»™è§£ç å™¨é€pkt</p>\n</li>\n<li><p>è°ƒç”¨avcodec_receive_frameä»è§£ç å™¨è¯»frame</p>\n</li>\n<li><p>è°ƒç”¨output_video_frameå°†è§£ç åè§†é¢‘å†™æ–‡ä»¶ï¼Œè°ƒç”¨output_audio_frameå°†è§£ç åéŸ³é¢‘å†™æ–‡ä»¶</p>\n</li>\n</ol>\n<h4 id=\"output-video-frame\"><a href=\"#output-video-frame\" class=\"headerlink\" title=\"output_video_frame\"></a>output_video_frame</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">output_video_frame</span><span class=\"hljs-params\">(AVFrame *frame)</span><br>&#123;<br>    <span class=\"hljs-comment\">//è§£ç ä¸­ï¼Œå‘ç°å®½é«˜æˆ–è€…æ ¼å¼å˜äº†ï¼ŒæŠ¥é”™</span><br>    <span class=\"hljs-keyword\">if</span> (frame-&gt;width != width || frame-&gt;height != height ||<br>        frame-&gt;format != pix_fmt) &#123;<br>        <span class=\"hljs-comment\">/* To handle this change, one could call av_image_alloc again and</span><br><span class=\"hljs-comment\">         * decode the following frames into another rawvideo file. */</span><br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error: Width, height and pixel format have to be &quot;</span><br>                <span class=\"hljs-string\">&quot;constant in a rawvideo file, but the width, height or &quot;</span><br>                <span class=\"hljs-string\">&quot;pixel format of the input video changed:\\n&quot;</span><br>                <span class=\"hljs-string\">&quot;old: width = %d, height = %d, format = %s\\n&quot;</span><br>                <span class=\"hljs-string\">&quot;new: width = %d, height = %d, format = %s\\n&quot;</span>,<br>                width, height, av_get_pix_fmt_name(pix_fmt),<br>                frame-&gt;width, frame-&gt;height,<br>                av_get_pix_fmt_name(frame-&gt;format));<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;video_frame n:%d coded_n:%d\\n&quot;</span>,<br>           video_frame_count++, frame-&gt;coded_picture_number);<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     ä»frameä¸­è¯»å–è§£ç åçš„æ•°æ®ï¼Œæ‹·è´åˆ°ä¹‹å‰ç”³è¯·çš„bufferä¸­</span><br><span class=\"hljs-comment\">     è°ƒç”¨av_image_copyæ˜¯ä¸ºäº†å»é™¤frameä¸­å¯èƒ½çš„å­—èŠ‚å¯¹é½çš„æ•°æ®</span><br><span class=\"hljs-comment\">     å†™å…¥æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè¦æ±‚ä¸å«æœ‰å­—èŠ‚å¯¹é½çš„æ•°æ®</span><br><span class=\"hljs-comment\">    */</span><br><br>    av_image_copy(video_dst_data, video_dst_linesize,<br>                  (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint8_t</span> **)(frame-&gt;data), frame-&gt;linesize,<br>                  pix_fmt, width, height);<br><br>    <span class=\"hljs-comment\">/* write to rawvideo file */</span><br>    fwrite(video_dst_data[<span class=\"hljs-number\">0</span>], <span class=\"hljs-number\">1</span>, video_dst_bufsize, video_dst_file);<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>åˆ¤æ–­è§£ç åçš„å®½é«˜ï¼Œæ ¼å¼æ˜¯å¦å˜æ›´ï¼Œå†™å…¥æ–‡ä»¶çš„å®½é«˜ï¼Œæ ¼å¼åº”è¯¥æ˜¯ä¸€è‡´çš„ï¼Œå¦‚æœå˜æ›´å°±æŠ¥é”™</p>\n</li>\n<li><p>å°†frameä¸­çš„æ•°æ®æ‹·è´åˆ°ä¹‹å‰ç”³è¯·çš„bufferä¸­ï¼Œæ‹·è´çš„æ—¶å€™ï¼Œå»é™¤å­—èŠ‚å¯¹é½æ•°æ®</p>\n</li>\n<li><p>å°†bufferä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶</p>\n</li>\n</ol>\n<h4 id=\"output-audio-frame\"><a href=\"#output-audio-frame\" class=\"headerlink\" title=\"output_audio_frame\"></a>output_audio_frame</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">output_audio_frame</span><span class=\"hljs-params\">(AVFrame *frame)</span><br>&#123;<br>    <span class=\"hljs-type\">size_t</span> unpadded_linesize = frame-&gt;nb_samples * av_get_bytes_per_sample(frame-&gt;format);<br>    <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;audio_frame n:%d nb_samples:%d pts:%s\\n&quot;</span>,<br>           audio_frame_count++, frame-&gt;nb_samples,<br>           av_ts2timestr(frame-&gt;pts, &amp;audio_dec_ctx-&gt;time_base));<br><br>    <span class=\"hljs-comment\">/* Write the raw audio data samples of the first plane. This works</span><br><span class=\"hljs-comment\">     * fine for packed formats (e.g. AV_SAMPLE_FMT_S16). However,</span><br><span class=\"hljs-comment\">     * most audio decoders output planar audio, which uses a separate</span><br><span class=\"hljs-comment\">     * plane of audio samples for each channel (e.g. AV_SAMPLE_FMT_S16P).</span><br><span class=\"hljs-comment\">     * In other words, this code will write only the first audio channel</span><br><span class=\"hljs-comment\">     * in these cases.</span><br><span class=\"hljs-comment\">     * You should use libswresample or libavfilter to convert the frame</span><br><span class=\"hljs-comment\">     * to packed data. */</span><br><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">    åªå†™äº†ç¬¬ä¸€ä¸ªå£°é“çš„æ•°æ®ï¼Œå¦‚æœæ˜¯å¹³é¢å¤šå£°é“ï¼Œä½¿ç”¨libswresampleæˆ–libavfilterå°†å…¶è½¬åŒ–ä¸ºäº¤é”™ç±»å‹çš„éŸ³é¢‘å†å†™å…¥æ–‡ä»¶</span><br><span class=\"hljs-comment\">    */</span><br>    fwrite(frame-&gt;extended_data[<span class=\"hljs-number\">0</span>], <span class=\"hljs-number\">1</span>, unpadded_linesize, audio_dst_file);<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å°†frameä¸­çš„éŸ³é¢‘çš„ç¬¬ä¸€ä¸ªå£°é“æ•°æ®å†™å…¥æ–‡ä»¶</p>\n</li>\n<li><p>å¦‚æœæƒ³å†™å…¥å¤šå£°é“ï¼Œéœ€è¦é€šè¿‡libswresampleæˆ–libavfilterè½¬ä¸ºäº¤é”™å‹çš„å†å†™å…¥æ–‡ä»¶</p>\n<hr>\n</li>\n</ol>\n<p>å‚è€ƒäº†ï¼š <a href=\"https://blog.csdn.net/myvest/article/details/89254452\">FFmpeg å°è£…ã€è§£å°è£…åŠè§£ç çš„æµç¨‹ç®€ä»‹_myvestçš„ä¸“æ -CSDNåšå®¢_ffmpeg å°è£…æµç¨‹</a></p>\n","excerpt":"","more":"<h2 id=\"èƒŒæ™¯\"><a href=\"#èƒŒæ™¯\" class=\"headerlink\" title=\"èƒŒæ™¯\"></a>èƒŒæ™¯</h2><p>å­¦ä¹ ffmpegï¼Œæ‰“ç®—ä»æºç å…¥æ‰‹ï¼Œæºç åˆå¤ªå¤šå¤ªå¤æ‚ã€‚å¥½åœ¨ffmpegæä¾›äº†ç¤ºä¾‹ä»£ç ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ffmpegçš„apiï¼Œ ç¤ºä¾‹ä»£ç ä½äº<code>ffmpeg/doc/examples</code>ç›®å½•ä¸‹ï¼Œå¯ä»¥<a href=\"https://yxibng.github.io/2022/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8vscode%E5%9C%A8macOS%E5%B9%B3%E5%8F%B0%E8%B0%83%E8%AF%95ffmpeg/\">é€šè¿‡vscode æ¥è°ƒè¯•</a>è¿™äº›ç¤ºä¾‹ä»£ç ï¼Œç†è§£ffmpegçš„è°ƒç”¨æ–¹å¼ã€‚</p>\n<p>è¯¥ç›®å½•ä¸‹çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16468967433771646896743076.png\"></p>\n<ul>\n<li><p>decode_audio.c  æ¼”ç¤ºå¦‚ä½•è§£ç éŸ³é¢‘</p>\n</li>\n<li><p>decode_video.c  æ¼”ç¤ºå¦‚ä½•è§£ç è§†é¢‘</p>\n</li>\n<li><p>demuxing_decoding.c  æ¼”ç¤ºå¦‚ä½•è§£å°è£…æ–‡ä»¶ï¼Œå’Œè§£ç éŸ³è§†é¢‘</p>\n</li>\n</ul>\n<p>ä»Šå¤©æ¥åˆ†æ <code>demuxing_decoding.c</code></p>\n<h2 id=\"æµç¨‹\"><a href=\"#æµç¨‹\" class=\"headerlink\" title=\"æµç¨‹\"></a>æµç¨‹</h2><p>ä½¿ç”¨çš„æ¨¡å—<code>libavutil</code>,<code>libavcodec</code>,<code>libavformat</code></p>\n<ul>\n<li><p>libavutil  åŒ…å«ä¸€äº›å…¬å…±çš„å·¥å…·å‡½æ•°</p>\n</li>\n<li><p>libavcodec ç”¨äºå„ç§ç±»å‹å£°éŸ³&#x2F;å›¾åƒç¼–è§£ç </p>\n</li>\n<li><p>libavformat ç”¨äºå„ç§éŸ³è§†é¢‘å°è£…æ ¼å¼çš„ç”Ÿæˆå’Œè§£æï¼ŒåŒ…æ‹¬è·å–è§£ç æ‰€éœ€ä¿¡æ¯ä»¥ç”Ÿæˆè§£ç ä¸Šä¸‹æ–‡ç»“æ„å’Œè¯»å–éŸ³è§†é¢‘å¸§ç­‰åŠŸèƒ½ï¼ŒåŒ…å«demuxerså’Œmuxeråº“</p>\n</li>\n</ul>\n<h3 id=\"1-è§£å°è£…\"><a href=\"#1-è§£å°è£…\" class=\"headerlink\" title=\"1.è§£å°è£…\"></a>1.è§£å°è£…</h3><ol>\n<li><p>æ‰“å¼€æ–‡ä»¶ã€è·å–å°è£…ä¿¡æ¯ä¸Šä¸‹æ–‡AVFormatContextï¼ˆavformat_open_inputï¼‰</p>\n</li>\n<li><p>è·å–åª’ä½“æ–‡ä»¶éŸ³è§†é¢‘ä¿¡æ¯ï¼Œè¿™ä¸€æ­¥ä¼šå°†AVFormatContextå†…éƒ¨å˜é‡å¡«å……ï¼ˆavformat_find_stream_infoï¼‰</p>\n</li>\n<li><p>è·å–éŸ³è§†é¢‘æµIDã€‚ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>\n<ol>\n<li><p>éå†AVFormatContextå†…éƒ¨æ‰€æœ‰çš„streamï¼Œå¦‚æœstreamçš„codec_typeå¯¹åº”ä¸ºaudio&#x2F;videoï¼Œè¿™è®°å½•å½“å‰streamçš„IDï¼›</p>\n</li>\n<li><p>FFmpegæä¾›av_find_best_streamæ¥å£ï¼Œå¯ä»¥ç›´æ¥è·å–ç›¸åº”ç±»å‹ï¼ˆaudio or videoï¼‰çš„æµID</p>\n</li>\n</ol>\n</li>\n<li><p>è·å–æµçš„æ¯ä¸€å¸§æ•°æ®ï¼ˆav_read_frameï¼‰  </p>\n</li>\n<li><p>å…³é—­æ–‡ä»¶</p>\n</li>\n</ol>\n<h3 id=\"2-è§£ç \"><a href=\"#2-è§£ç \" class=\"headerlink\" title=\"2.è§£ç \"></a>2.è§£ç </h3><p>è§£ç åœ¨è§£å°è£…çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸€å¸§æ•°æ®è¿›è¡Œè§£ç ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<ol>\n<li><p>ç”³è¯·è§£ç å™¨ä¸Šä¸‹æ–‡AVCodecContextï¼ˆavcodec_alloc_context3ï¼‰</p>\n</li>\n<li><p>åˆå§‹åŒ–AVCodecContextå‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨å°†è§£å°è£…å¾—åˆ°çš„æµçš„è§£ç å™¨å‚æ•°è®¾ç½®è¿›æ¥ï¼ˆavcodec_parameters_to_contextï¼‰</p>\n</li>\n<li><p>æ‰“å¼€è§£ç å™¨ï¼ˆavcodec_open2ï¼‰</p>\n</li>\n<li><p>è§£ç æ¯ä¸€å¸§æ•°æ®ã€‚åªéœ€è¦å°†è§£å°è£…è·å–çš„å¸§ä¼ é€’ç»™è§£ç å™¨ï¼ˆavcodec_send_packetï¼‰ï¼Œå†æ¥æ”¶å³å¯ï¼ˆavcodec_receive_frameï¼‰</p>\n</li>\n<li><p>å…³é—­æ–‡ä»¶å’Œè§£ç å™¨</p>\n</li>\n</ol>\n<h2 id=\"æºç åˆ†æ\"><a href=\"#æºç åˆ†æ\" class=\"headerlink\" title=\"æºç åˆ†æ\"></a>æºç åˆ†æ</h2><h4 id=\"main-å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ\"><a href=\"#main-å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ\" class=\"headerlink\" title=\"main å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ\"></a>main å‡½æ•°ï¼Œç®€åŒ–ç‰ˆ</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">main</span> <span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">char</span> **argv)</span><br>&#123;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     æ‰“å¼€è¾“å…¥æ–‡ä»¶ï¼Œåˆ›å»ºAVFormatContext</span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">if</span> (avformat_open_input(&amp;fmt_ctx, src_filename, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open source file %s\\n&quot;</span>, src_filename);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* è·å–å°è£…æ ¼å¼ä¸­çš„éŸ³è§†é¢‘ä¿¡æ¯ï¼Œå¡«å……åœ¨AVFormatContextä¸­ */</span><br>    <span class=\"hljs-keyword\">if</span> (avformat_find_stream_info(fmt_ctx, <span class=\"hljs-literal\">NULL</span>) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not find stream information\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">    1. ä» fmt_ctx è¯»å–è§†é¢‘å¯¹åº”çš„AVStream</span><br><span class=\"hljs-comment\">    2. ä» AVStream è¯»å–è§£ç ç›¸å…³çš„ AVCodec</span><br><span class=\"hljs-comment\">    3. æ ¹æ® AVCodec åˆ›å»º AVCodecContextï¼Œæ ¹æ® AVStream ç»™ AVCodecContext å¡«å……è§£ç å‚æ•°</span><br><span class=\"hljs-comment\">    4. æ‰“å¼€è§£ç å™¨</span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">if</span> (open_codec_context(&amp;video_stream_idx, &amp;video_dec_ctx, fmt_ctx, AVMEDIA_TYPE_VIDEO) &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        video_stream = fmt_ctx-&gt;streams[video_stream_idx];<br>    &#125;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">    1. ä» fmt_ctx è¯»å–éŸ³é¢‘å¯¹åº”çš„AVStream</span><br><span class=\"hljs-comment\">    2. ä» AVStream è¯»å–è§£ç ç›¸å…³çš„ AVCodec</span><br><span class=\"hljs-comment\">    3. æ ¹æ® AVCodec åˆ›å»º AVCodecContextï¼Œæ ¹æ® AVStream ç»™ AVCodecContext å¡«å……è§£ç å‚æ•°</span><br><span class=\"hljs-comment\">    4. æ‰“å¼€è§£ç å™¨</span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">if</span> (open_codec_context(&amp;audio_stream_idx, &amp;audio_dec_ctx, fmt_ctx, AVMEDIA_TYPE_AUDIO) &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        audio_stream = fmt_ctx-&gt;streams[audio_stream_idx];<br>    &#125;<br><br>    <span class=\"hljs-comment\">//åˆ›å»ºframe, ç”¨äºå­˜å‚¨è§£ç åçš„æ•°æ®</span><br>    frame = av_frame_alloc();<br>    <span class=\"hljs-comment\">//åˆ›å»ºpktï¼Œç”¨äºå­˜å‚¨è§£å°è£…åä»æ–‡ä»¶ä¸­è¯»å–çš„éŸ³è§†é¢‘åŒ…</span><br>    pkt = av_packet_alloc();<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">    ä»æ–‡ä»¶ä¸­å¾ªç¯è¯»å–éŸ³è§†é¢‘å¸§ï¼Œå­˜å…¥pkt</span><br><span class=\"hljs-comment\">    æ ¹æ®ç±»å‹åŒºåˆ†éŸ³é¢‘å¸§è¿˜æ˜¯è§†é¢‘å¸§ï¼Œåˆ†åˆ«é€ç»™å¯¹åº”çš„è§£ç å™¨å»è§£ç </span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">while</span> (av_read_frame(fmt_ctx, pkt) &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">// check if the packet belongs to a stream we are interested in, otherwise</span><br>        <span class=\"hljs-comment\">// skip it</span><br>        <span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == video_stream_idx)<br>            ret = decode_packet(video_dec_ctx, pkt);<br>        <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == audio_stream_idx)<br>            ret = decode_packet(audio_dec_ctx, pkt);<br>        av_packet_unref(pkt);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">break</span>;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* å†²æ´—éŸ³è§†é¢‘è§£ç å™¨ï¼Œå°†å‰©ä½™çš„è§£ç æ•°æ®è¯»å‡ºæ¥ */</span><br>    <span class=\"hljs-keyword\">if</span> (video_dec_ctx)<br>        decode_packet(video_dec_ctx, <span class=\"hljs-literal\">NULL</span>);<br>    <span class=\"hljs-keyword\">if</span> (audio_dec_ctx)<br>        decode_packet(audio_dec_ctx, <span class=\"hljs-literal\">NULL</span>);<br>end:<br>    <span class=\"hljs-comment\">//èµ„æºé‡Šæ”¾å’Œé€€å‡º</span><br>    avcodec_free_context(&amp;video_dec_ctx);<br>    avcodec_free_context(&amp;audio_dec_ctx);<br>    avformat_close_input(&amp;fmt_ctx);<br>    <span class=\"hljs-keyword\">if</span> (video_dst_file)<br>        fclose(video_dst_file);<br>    <span class=\"hljs-keyword\">if</span> (audio_dst_file)<br>        fclose(audio_dst_file);<br>    av_packet_free(&amp;pkt);<br>    av_frame_free(&amp;frame);<br>    av_free(video_dst_data[<span class=\"hljs-number\">0</span>]);<br><br>    <span class=\"hljs-keyword\">return</span> ret &lt; <span class=\"hljs-number\">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>éªŒè¯è¾“å…¥å‚æ•°æ˜¯å¦æ­£ç¡®</p>\n</li>\n<li><p>æ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–å°è£…ä¿¡æ¯</p>\n</li>\n<li><p>æ ¹æ®å°è£…ä¿¡æ¯ï¼Œåˆ†åˆ«åˆ›å»ºè§†é¢‘è§£ç å™¨å’ŒéŸ³é¢‘è§£ç å™¨</p>\n</li>\n<li><p>å¾ªç¯ä»æ–‡ä»¶ä¸­è¯»å–pkt</p>\n<ol>\n<li><p>å¦‚æœæ˜¯è§†é¢‘æ•°æ®ï¼Œé€åˆ°è§†é¢‘è§£ç å™¨ï¼Œè§£ç åå†™å…¥è§†é¢‘æ–‡ä»¶</p>\n</li>\n<li><p>å¦‚æœæ˜¯éŸ³é¢‘æ•°æ®ï¼Œé€åˆ°éŸ³é¢‘è§£ç å™¨ï¼Œè§£ç åå†™å…¥éŸ³é¢‘æ–‡ä»¶</p>\n</li>\n</ol>\n</li>\n<li><p>å†²æ´—éŸ³é¢‘è§†é¢‘è§£ç å™¨ï¼Œè¯»å–å‰©ä½™æ•°æ®</p>\n</li>\n<li><p>æ¸…ç†èµ„æºé€€å‡º</p>\n</li>\n</ol>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><h4 id=\"open-codec-context\"><a href=\"#open-codec-context\" class=\"headerlink\" title=\"open_codec_context\"></a>open_codec_context</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">open_codec_context</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> *stream_idx,</span><br><span class=\"hljs-params\">                              AVCodecContext **dec_ctx, AVFormatContext *fmt_ctx, <span class=\"hljs-keyword\">enum</span> AVMediaType type)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret, stream_index;<br>    AVStream *st;<br>    <span class=\"hljs-type\">const</span> AVCodec *dec = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-comment\">//æ‰¾åˆ°éŸ³é¢‘/è§†é¢‘å¯¹åº”çš„stream_index</span><br>    ret = av_find_best_stream(fmt_ctx, type, <span class=\"hljs-number\">-1</span>, <span class=\"hljs-number\">-1</span>, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not find %s stream in input file &#x27;%s&#x27;\\n&quot;</span>,<br>                av_get_media_type_string(type), src_filename);<br>        <span class=\"hljs-keyword\">return</span> ret;<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        stream_index = ret;<br>        <span class=\"hljs-comment\">//è·å–éŸ³é¢‘/è§†é¢‘å¯¹åº”çš„AVStream</span><br>        st = fmt_ctx-&gt;streams[stream_index];<br><br>        <span class=\"hljs-comment\">/* è·å–è§£ç å¯¹åº”çš„AVCodec */</span><br>        dec = avcodec_find_decoder(st-&gt;codecpar-&gt;codec_id);<br>        <span class=\"hljs-keyword\">if</span> (!dec) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Failed to find %s codec\\n&quot;</span>,<br>                    av_get_media_type_string(type));<br>            <span class=\"hljs-keyword\">return</span> AVERROR(EINVAL);<br>        &#125;<br><br>        <span class=\"hljs-comment\">/* æ ¹æ®AVCodec åˆ›å»º AVCodecContext */</span><br>        *dec_ctx = avcodec_alloc_context3(dec);<br>        <span class=\"hljs-keyword\">if</span> (!*dec_ctx) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Failed to allocate the %s codec context\\n&quot;</span>,<br>                    av_get_media_type_string(type));<br>            <span class=\"hljs-keyword\">return</span> AVERROR(ENOMEM);<br>        &#125;<br>        <span class=\"hljs-comment\">/* å°†AVStreamçš„codecparä¸­ä¿å­˜çš„è§£ç ç›¸å…³çš„å‚æ•°ï¼Œå¡«å……åˆ°AVCodecContextä¸­ */</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = avcodec_parameters_to_context(*dec_ctx, st-&gt;codecpar)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Failed to copy %s codec parameters to decoder context\\n&quot;</span>,<br>                    av_get_media_type_string(type));<br>            <span class=\"hljs-keyword\">return</span> ret;<br>        &#125;<br><br>        <span class=\"hljs-comment\">/* æ‰“å¼€è§£ç å™¨ */</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = avcodec_open2(*dec_ctx, dec, <span class=\"hljs-literal\">NULL</span>)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Failed to open %s codec\\n&quot;</span>,<br>                    av_get_media_type_string(type));<br>            <span class=\"hljs-keyword\">return</span> ret;<br>        &#125;<br>        <span class=\"hljs-comment\">//stream_indexå›ä¼ </span><br>        *stream_idx = stream_index;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è·å–AVStream</p>\n</li>\n<li><p>ä»AVStreamè¯»å–è§£ç ä¿¡æ¯ï¼Œåˆ›å»ºAVCodecContext</p>\n</li>\n<li><p>ç»™AVCodecContexté…ç½®å‚æ•°</p>\n</li>\n<li><p>æ‰“å¼€è§£ç å™¨</p>\n</li>\n</ol>\n<h4 id=\"decode-packet\"><a href=\"#decode-packet\" class=\"headerlink\" title=\"decode_packet\"></a>decode_packet</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">decode_packet</span><span class=\"hljs-params\">(AVCodecContext *dec, <span class=\"hljs-type\">const</span> AVPacket *pkt)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret = <span class=\"hljs-number\">0</span>;<br><br>    <span class=\"hljs-comment\">// submit the packet to the decoder</span><br>    ret = avcodec_send_packet(dec, pkt);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error submitting a packet for decoding (%s)\\n&quot;</span>, av_err2str(ret));<br>        <span class=\"hljs-keyword\">return</span> ret;<br>    &#125;<br><br>    <span class=\"hljs-comment\">// get all the available frames from the decoder</span><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        ret = avcodec_receive_frame(dec, frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-comment\">// those two return values are special and mean there is no output</span><br>            <span class=\"hljs-comment\">// frame available, but there were no errors during decoding</span><br>            <span class=\"hljs-keyword\">if</span> (ret == AVERROR_EOF || ret == AVERROR(EAGAIN))<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br><br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error during decoding (%s)\\n&quot;</span>, av_err2str(ret));<br>            <span class=\"hljs-keyword\">return</span> ret;<br>        &#125;<br><br>        <span class=\"hljs-comment\">// write the frame data to output file</span><br>        <span class=\"hljs-keyword\">if</span> (dec-&gt;codec-&gt;type == AVMEDIA_TYPE_VIDEO)<br>            ret = output_video_frame(frame);<br>        <span class=\"hljs-keyword\">else</span><br>            ret = output_audio_frame(frame);<br><br>        av_frame_unref(frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">return</span> ret;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è°ƒç”¨avcodec_send_packetç»™è§£ç å™¨é€pkt</p>\n</li>\n<li><p>è°ƒç”¨avcodec_receive_frameä»è§£ç å™¨è¯»frame</p>\n</li>\n<li><p>è°ƒç”¨output_video_frameå°†è§£ç åè§†é¢‘å†™æ–‡ä»¶ï¼Œè°ƒç”¨output_audio_frameå°†è§£ç åéŸ³é¢‘å†™æ–‡ä»¶</p>\n</li>\n</ol>\n<h4 id=\"output-video-frame\"><a href=\"#output-video-frame\" class=\"headerlink\" title=\"output_video_frame\"></a>output_video_frame</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">output_video_frame</span><span class=\"hljs-params\">(AVFrame *frame)</span><br>&#123;<br>    <span class=\"hljs-comment\">//è§£ç ä¸­ï¼Œå‘ç°å®½é«˜æˆ–è€…æ ¼å¼å˜äº†ï¼ŒæŠ¥é”™</span><br>    <span class=\"hljs-keyword\">if</span> (frame-&gt;width != width || frame-&gt;height != height ||<br>        frame-&gt;format != pix_fmt) &#123;<br>        <span class=\"hljs-comment\">/* To handle this change, one could call av_image_alloc again and</span><br><span class=\"hljs-comment\">         * decode the following frames into another rawvideo file. */</span><br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error: Width, height and pixel format have to be &quot;</span><br>                <span class=\"hljs-string\">&quot;constant in a rawvideo file, but the width, height or &quot;</span><br>                <span class=\"hljs-string\">&quot;pixel format of the input video changed:\\n&quot;</span><br>                <span class=\"hljs-string\">&quot;old: width = %d, height = %d, format = %s\\n&quot;</span><br>                <span class=\"hljs-string\">&quot;new: width = %d, height = %d, format = %s\\n&quot;</span>,<br>                width, height, av_get_pix_fmt_name(pix_fmt),<br>                frame-&gt;width, frame-&gt;height,<br>                av_get_pix_fmt_name(frame-&gt;format));<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;video_frame n:%d coded_n:%d\\n&quot;</span>,<br>           video_frame_count++, frame-&gt;coded_picture_number);<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     ä»frameä¸­è¯»å–è§£ç åçš„æ•°æ®ï¼Œæ‹·è´åˆ°ä¹‹å‰ç”³è¯·çš„bufferä¸­</span><br><span class=\"hljs-comment\">     è°ƒç”¨av_image_copyæ˜¯ä¸ºäº†å»é™¤frameä¸­å¯èƒ½çš„å­—èŠ‚å¯¹é½çš„æ•°æ®</span><br><span class=\"hljs-comment\">     å†™å…¥æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè¦æ±‚ä¸å«æœ‰å­—èŠ‚å¯¹é½çš„æ•°æ®</span><br><span class=\"hljs-comment\">    */</span><br><br>    av_image_copy(video_dst_data, video_dst_linesize,<br>                  (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint8_t</span> **)(frame-&gt;data), frame-&gt;linesize,<br>                  pix_fmt, width, height);<br><br>    <span class=\"hljs-comment\">/* write to rawvideo file */</span><br>    fwrite(video_dst_data[<span class=\"hljs-number\">0</span>], <span class=\"hljs-number\">1</span>, video_dst_bufsize, video_dst_file);<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>åˆ¤æ–­è§£ç åçš„å®½é«˜ï¼Œæ ¼å¼æ˜¯å¦å˜æ›´ï¼Œå†™å…¥æ–‡ä»¶çš„å®½é«˜ï¼Œæ ¼å¼åº”è¯¥æ˜¯ä¸€è‡´çš„ï¼Œå¦‚æœå˜æ›´å°±æŠ¥é”™</p>\n</li>\n<li><p>å°†frameä¸­çš„æ•°æ®æ‹·è´åˆ°ä¹‹å‰ç”³è¯·çš„bufferä¸­ï¼Œæ‹·è´çš„æ—¶å€™ï¼Œå»é™¤å­—èŠ‚å¯¹é½æ•°æ®</p>\n</li>\n<li><p>å°†bufferä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶</p>\n</li>\n</ol>\n<h4 id=\"output-audio-frame\"><a href=\"#output-audio-frame\" class=\"headerlink\" title=\"output_audio_frame\"></a>output_audio_frame</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">output_audio_frame</span><span class=\"hljs-params\">(AVFrame *frame)</span><br>&#123;<br>    <span class=\"hljs-type\">size_t</span> unpadded_linesize = frame-&gt;nb_samples * av_get_bytes_per_sample(frame-&gt;format);<br>    <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;audio_frame n:%d nb_samples:%d pts:%s\\n&quot;</span>,<br>           audio_frame_count++, frame-&gt;nb_samples,<br>           av_ts2timestr(frame-&gt;pts, &amp;audio_dec_ctx-&gt;time_base));<br><br>    <span class=\"hljs-comment\">/* Write the raw audio data samples of the first plane. This works</span><br><span class=\"hljs-comment\">     * fine for packed formats (e.g. AV_SAMPLE_FMT_S16). However,</span><br><span class=\"hljs-comment\">     * most audio decoders output planar audio, which uses a separate</span><br><span class=\"hljs-comment\">     * plane of audio samples for each channel (e.g. AV_SAMPLE_FMT_S16P).</span><br><span class=\"hljs-comment\">     * In other words, this code will write only the first audio channel</span><br><span class=\"hljs-comment\">     * in these cases.</span><br><span class=\"hljs-comment\">     * You should use libswresample or libavfilter to convert the frame</span><br><span class=\"hljs-comment\">     * to packed data. */</span><br><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">    åªå†™äº†ç¬¬ä¸€ä¸ªå£°é“çš„æ•°æ®ï¼Œå¦‚æœæ˜¯å¹³é¢å¤šå£°é“ï¼Œä½¿ç”¨libswresampleæˆ–libavfilterå°†å…¶è½¬åŒ–ä¸ºäº¤é”™ç±»å‹çš„éŸ³é¢‘å†å†™å…¥æ–‡ä»¶</span><br><span class=\"hljs-comment\">    */</span><br>    fwrite(frame-&gt;extended_data[<span class=\"hljs-number\">0</span>], <span class=\"hljs-number\">1</span>, unpadded_linesize, audio_dst_file);<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å°†frameä¸­çš„éŸ³é¢‘çš„ç¬¬ä¸€ä¸ªå£°é“æ•°æ®å†™å…¥æ–‡ä»¶</p>\n</li>\n<li><p>å¦‚æœæƒ³å†™å…¥å¤šå£°é“ï¼Œéœ€è¦é€šè¿‡libswresampleæˆ–libavfilterè½¬ä¸ºäº¤é”™å‹çš„å†å†™å…¥æ–‡ä»¶</p>\n<hr>\n</li>\n</ol>\n<p>å‚è€ƒäº†ï¼š <a href=\"https://blog.csdn.net/myvest/article/details/89254452\">FFmpeg å°è£…ã€è§£å°è£…åŠè§£ç çš„æµç¨‹ç®€ä»‹_myvestçš„ä¸“æ -CSDNåšå®¢_ffmpeg å°è£…æµç¨‹</a></p>\n"},{"layout":"post","title":"ffmpeg example 2.è§†é¢‘ç¼–ç ","date":"2022-03-10T16:00:00.000Z","_content":"\nè°ƒè¯•ffmpegæºç æ•™ç¨‹\n\n- [å¦‚ä½•ä½¿ç”¨vscodeåœ¨macOSå¹³å°è°ƒè¯•ffmpeg](https://yxibng.github.io/2022/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8vscode%E5%9C%A8macOS%E5%B9%B3%E5%8F%B0%E8%B0%83%E8%AF%95ffmpeg/)\n\n- [ä½¿ç”¨Xcodeè°ƒè¯•ffmpeg](https://yxibng.github.io/2022/03/%E4%BD%BF%E7%94%A8Xcode%E8%B0%83%E8%AF%95ffmpeg/)\n  \n  Â Â Â Â \n\nä»Šå¤©ç”¨Xcodeè°ƒè¯•åˆ†æ `encode_video.c`\n\n## é…ç½®ffmpeg æ”¯æŒlibx264å’Œh264_videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç \n\n```shell\ncd ffmpeg\n./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc --enable-libx264 --enable-gpl --enable-videotoolboxm\nmake -j 16\nmake examples\n```\n\nå¦‚æœæ²¡æœ‰libx264ï¼Œ é€šè¿‡ [Homebrew](https://brew.sh/) å®‰è£…ä¸€ä¸‹\n\n```shell\nbrew install x264\n```\n\nffmpeg  é€šè¿‡[pkg-config](https://www.freedesktop.org/wiki/Software/pkg-config/)å¯ä»¥æ‰¾åˆ°x264å¯¹åº”çš„å¤´æ–‡ä»¶å’Œåº“çš„è·¯å¾„\n\n```shell\nâœ  ffmpeg git:(master) âœ— pkg-config --libs --cflags x264\n-DX264_API_IMPORTS -I/opt/homebrew/Cellar/x264/r3060/include -L/opt/homebrew/Cellar/x264/r3060/lib -lx264\n```\n\n## é…ç½®Xcode\n\næ·»åŠ targetï¼Œé…ç½®è·¯å¾„\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469917993141646991798582.png)\n\né…ç½®å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨å‚æ•°\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469918543121646991854240.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469918963141646991895699.png)\n\nencode_video_g æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œ\n\n1. è§†é¢‘ç¼–ç æ•°æ®çš„å†™å…¥è·¯å¾„\n\n2. ç¼–ç å™¨åå­—ï¼ˆlibx264 libx264rgb h264_videotoolboxï¼‰\n\næˆ‘ä»¬ä½¿ç”¨h264ç¼–ç å™¨ï¼ŒæŸ¥çœ‹ffmpeg æ”¯æŒçš„h264ç¼–ç å™¨\n\n```shell\nffmpeg -codecs | grep 264\nDEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (encoders: libx264 libx264rgb h264_videotoolbox )\n```\n\n## æºç åˆ†æ\n\n### mainå‡½æ•°\n\n```c\nint main(int argc, char **argv)\n{\n    const char *filename, *codec_name;\n    const AVCodec *codec;\n    AVCodecContext *c= NULL;\n    int i, ret, x, y;\n    FILE *f;\n    AVFrame *frame;\n    AVPacket *pkt;\n    uint8_t endcode[] = { 0, 0, 1, 0xb7 };\n\n    if (argc <= 2) {\n        fprintf(stderr, \"Usage: %s <output file> <codec name>\\n\", argv[0]);\n        exit(0);\n    }\n    filename = argv[1];\n    codec_name = argv[2];\n\n    /* æ ¹æ®ç¼–ç å™¨åå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨ï¼Œç¼–ç å™¨çš„åå­—å¦‚libx264,h264_videotoolbox */\n    codec = avcodec_find_encoder_by_name(codec_name);\n    if (!codec) {\n        fprintf(stderr, \"Codec '%s' not found\\n\", codec_name);\n        exit(1);\n    }\n    /* åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡ */\n    c = avcodec_alloc_context3(codec);\n    if (!c) {\n        fprintf(stderr, \"Could not allocate video codec context\\n\");\n        exit(1);\n    }\n    /* åˆ›å»º pkt ç”¨äºä¿å­˜ç¼–ç åçš„æ•°æ® */\n    pkt = av_packet_alloc();\n    if (!pkt)\n        exit(1);\n    /* é…ç½®ç¼–ç å‚æ•° */\n    //ç ç‡400000\n    c->bit_rate = 400000;\n    //ç¼–ç åˆ†è¾¨ç‡ï¼Œå®½é«˜å¿…é¡»èƒ½è¢«2æ•´é™¤\n    c->width = 352;\n    c->height = 288;\n    /*\n     ç¼–ç çš„æ—¶é—´åŸº,å¯ä»¥ç†è§£ä¸ºåˆ»åº¦ï¼Œä¸ pts æœ‰å…³\n     (AVRational){1, 25} å°†1ç§’é’Ÿåˆ†æˆ25ä»½ï¼Œæ¯ä¸€ä»½ä»£è¡¨ 1/25 ç§’\n     */\n    c->time_base = (AVRational){1, 25};\n    /* ç¼–ç å¸§ç‡ 25 å¸§ */\n    c->framerate = (AVRational){25, 1};\n\n    /* å…³é”®å¸§é—´éš”ï¼Œæ¯10å¸§äº§ç”Ÿä¸€ä¸ªå…³é”®å¸§, å¦‚æœframe->pict_type è¢«è®¾ç½®ä¸ºAV_PICTURE_TYPE_I\n     gop_sizeçš„å€¼ä¼šè¢«å¿½ç•¥ï¼Œç¼–ç å™¨ä¸äº§å‡ºBå¸§å’ŒPå¸§ï¼Œåªä¼šç¼–ç Iå¸§\n     */\n    c->gop_size = 10;\n    /* bå¸§çš„ä¸ªæ•°ï¼Œå®æ—¶é€šä¿¡ä¸€èˆ¬è®¾ç½®ä¸º0 */\n    c->max_b_frames = 1;\n    /* ç¼–ç çš„æ•°æ®æºçš„æ ¼å¼ï¼Œyuv420p */\n    c->pix_fmt = AV_PIX_FMT_YUV420P;\n    /* å¦‚æœä½¿ç”¨h264ç¼–ç å™¨ï¼Œè®¾ç½®preset ä¸ºslow */\n    if (codec->id == AV_CODEC_ID_H264)\n        av_opt_set(c->priv_data, \"preset\", \"slow\", 0);\n\n    /*\n     æ‰“å¼€ç¼–ç å™¨\n     */\n    ret = avcodec_open2(c, codec, NULL);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not open codec: %s\\n\", av_err2str(ret));\n        exit(1);\n    }\n    /* æ‰“å¼€è¾“å‡ºæ–‡ä»¶ */\n    f = fopen(filename, \"wb\");\n    if (!f) {\n        fprintf(stderr, \"Could not open %s\\n\", filename);\n        exit(1);\n    }\n    /* åˆ›å»ºAVFrameç”¨äºå­˜æ”¾å¾…ç¼–ç çš„æ•°æ®ï¼Œyuv */\n    frame = av_frame_alloc();\n    if (!frame) {\n        fprintf(stderr, \"Could not allocate video frame\\n\");\n        exit(1);\n    }\n    /* è®¾ç½®frame çš„é¢œè‰²æ ¼å¼ï¼Œå®½é«˜ */\n    frame->format = c->pix_fmt;\n    frame->width  = c->width;\n    frame->height = c->height;\n    /* æ ¹æ®ä¸Šé¢è®¾ç½®çš„å‚æ•°ï¼Œç»™frame å†…éƒ¨çš„ buf åˆ†é…å†…å­˜ */\n    ret = av_frame_get_buffer(frame, 0);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not allocate the video frame data\\n\");\n        exit(1);\n    }\n\n    /* ç¼–ç 1ç§’é’Ÿçš„æ•°æ®ï¼Œä¸Šé¢è®¾ç½®çš„ç¼–ç å¸§ç‡æ˜¯ 25 å¸§  */\n    for (i = 0; i < 25; i++) {\n        fflush(stdout);\n        /*\n         ç¡®ä¿frameä¸­çš„æ•°æ®æ˜¯å¯å†™çš„ã€‚\n         åˆšå¼€å§‹è°ƒç”¨ av_frame_get_buffer()ï¼Œframeä¸­çš„æ•°æ®æ˜¯å¯å†™çš„ã€‚\n         åé¢å°†frameé€ç»™ç¼–ç å™¨å»ç¼–ç ï¼Œå¯èƒ½è¢«ç¼–ç å™¨å¼•ç”¨ï¼Œæ­¤æ—¶frameæ˜¯ä¸å¯å†™çš„ã€‚\n         è°ƒç”¨av_frame_make_writable()ä¼šæ£€æŸ¥frame æ˜¯å¦å¯å†™ï¼Œ\n         å¦‚æœä¸å¯å†™ï¼Œä¼šç»™frameå†…éƒ¨é‡æ–°åˆ›å»ºæ–°çš„bufferã€‚\n         */\n        ret = av_frame_make_writable(frame);\n        if (ret < 0)\n            exit(1);\n\n        /* ç»™frameå¡«å……æ•°æ®ï¼Œæˆ‘ä»¬è®¾ç½®çš„æ˜¯yuv420ï¼Œè¿™é‡Œå¡«å……å‡æ•°æ® */\n        /* Y */\n        for (y = 0; y < c->height; y++) {\n            for (x = 0; x < c->width; x++) {\n                frame->data[0][y * frame->linesize[0] + x] = x + y + i * 3;\n            }\n        }\n        /* Cb and Cr */\n        for (y = 0; y < c->height/2; y++) {\n            for (x = 0; x < c->width/2; x++) {\n                frame->data[1][y * frame->linesize[1] + x] = 128 + y + i * 2;\n                frame->data[2][y * frame->linesize[2] + x] = 64 + x + i * 5;\n            }\n        }\n\n        /*\n         è®¾ç½®frameçš„pts\n         æˆ‘ä»¬è®¾ç½®çš„æ˜¯æ¯ç§’25å¸§\n         å¯¹åº”çš„æ—¶é—´è½¬æˆç§’æ˜¯ pts * av_q2d(c->time_base)\n         */\n        frame->pts = i;\n\n        /*\n         å°†frame é€ç»™ç¼–ç å™¨ç¼–ç ï¼Œå°†ç¼–ç åçš„æ•°æ®å†™å…¥æ–‡ä»¶\n         */\n        encode(c, frame, pkt, f);\n    }\n\n    /*\n     å†²æ´—ç¼–ç å™¨ï¼Œå°†å‰©ä½™çš„ç¼–ç åçš„æ•°æ®è¯»å‡ºæ¥ï¼Œå†™å…¥æ–‡ä»¶\n     */\n    encode(c, NULL, pkt, f);\n\n    /* Add sequence end code to have a real MPEG file.\n       It makes only sense because this tiny examples writes packets\n       directly. This is called \"elementary stream\" and only works for some\n       codecs. To create a valid file, you usually need to write packets\n       into a proper file format or protocol; see muxing.c.\n     */\n    if (codec->id == AV_CODEC_ID_MPEG1VIDEO || codec->id == AV_CODEC_ID_MPEG2VIDEO)\n        fwrite(endcode, 1, sizeof(endcode), f);\n\n    //å…³é—­æ–‡ä»¶\n    fclose(f);\n    //é‡Šæ”¾èµ„æº\n    avcodec_free_context(&c);\n    av_frame_free(&frame);\n    av_packet_free(&pkt);\n\n    return 0;\n}\n```\n\n1. ä»å‘½ä»¤è¡Œä¸­è¾“å‡ºæ–‡ä»¶çš„è·¯å¾„ï¼Œ ä½¿ç”¨çš„ç¼–ç å™¨åå­—\n\n2. æ ¹æ®åå­—æ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨\n\n3. åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡ï¼Œè®¾ç½®ç¼–ç å™¨çš„å‚æ•°ï¼ˆç ç‡ï¼Œæ—¶é—´åŸºï¼Œå¸§ç‡ï¼Œå®½é«˜ï¼Œé¢œè‰²æ ¼å¼ï¼Œbå¸§ä¸ªæ•°ï¼‰\n\n4. æ‰“å¼€ç¼–ç å™¨\n\n5. åˆ›å»ºAVFrame ä¿å­˜å¾…ç¼–ç çš„æ•°æ®\n\n6. åˆ›å»ºAVPacketä¿å­˜ç¼–ç åçš„æ•°æ®\n\n7. ç¼–ç 1ç§’é’Ÿçš„æ•°æ®\n\n8. å†²æ´—ç¼–ç å™¨ï¼Œå°†å‰©ä½™æ•°æ®è¯»å‡º\n\n9. å…³é—­æ–‡ä»¶ï¼Œé‡Šæ”¾èµ„æº\n\n### encode\n\n```c\nstatic void encode(AVCodecContext *enc_ctx, AVFrame *frame, AVPacket *pkt,\n                   FILE *outfile)\n{\n    int ret;\n\n    /* send the frame to the encoder */\n    if (frame)\n        printf(\"Send frame %3\"PRId64\"\\n\", frame->pts);\n\n    //ç»™ç¼–ç å™¨é€frame\n    ret = avcodec_send_frame(enc_ctx, frame);\n    if (ret < 0) {\n        fprintf(stderr, \"Error sending a frame for encoding\\n\");\n        exit(1);\n    }\n\n    while (ret >= 0) {\n        //ä»ç¼–ç å™¨è¯»pkt\n        ret = avcodec_receive_packet(enc_ctx, pkt);\n        if (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)\n        {\n            //EAGAIN ä»£è¡¨éœ€è¦ç»§ç»­é€å…¥ frame æ‰å¯ä»¥å¼€å§‹è¯»å–\n            //AVERROR_EOF ä»£è¡¨ç¼–ç å™¨å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¯»äº†\n            return;\n        }\n        else if (ret < 0) {\n            fprintf(stderr, \"Error during encoding\\n\");\n            exit(1);\n        }\n\n        printf(\"Write packet %3\"PRId64\" (size=%5d)\\n\", pkt->pts, pkt->size);\n        //å°†ç¼–ç åçš„æ•°æ®å†™å…¥æ–‡ä»¶\n        fwrite(pkt->data, 1, pkt->size, outfile);\n        //å–æ¶ˆå¼•ç”¨pkt\n        av_packet_unref(pkt);\n    }\n}\n```\n\n1. è°ƒç”¨Â Â Â avcodec_send_frame ç»™ç¼–ç å™¨é€frame\n\n2. å¾ªç¯è°ƒç”¨avcodec_receive_packet ä»ç¼–ç å™¨è¯»pkt\n   \n   - EAGAIN ä»£è¡¨éœ€è¦ç»§ç»­é€å…¥ frame æ‰å¯ä»¥å¼€å§‹è¯»å–\n   \n   - AVERROR_EOF ä»£è¡¨ç¼–ç å™¨å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¯»äº†,ä¾‹å¦‚ä¼ å…¥ç©ºçš„frameï¼Œå¯¹ç¼–ç å™¨è¿›è¡Œäº†flushæ“ä½œ\n\n3. å°†ç¼–ç åæ•°æ®å†™å…¥æ–‡ä»¶\n\n4. å–æ¶ˆå¼•ç”¨pkt\n\næœ€åè¾“å‡ºçš„æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ffplay è¿›è¡Œæ’­æ”¾\n\n```\nâœ  /tmp ffplay -i encode_video.h264\n```\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469965503041646996550013.png)\n","source":"_posts/ffmpeg/2022-03-11-ffmpeg example å­¦ä¹  2.md","raw":"---\nlayout: post\ntitle: \"ffmpeg example 2.è§†é¢‘ç¼–ç \"\ndate: 2022-03-11 \ntag: ffmpeg\n---\n\nè°ƒè¯•ffmpegæºç æ•™ç¨‹\n\n- [å¦‚ä½•ä½¿ç”¨vscodeåœ¨macOSå¹³å°è°ƒè¯•ffmpeg](https://yxibng.github.io/2022/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8vscode%E5%9C%A8macOS%E5%B9%B3%E5%8F%B0%E8%B0%83%E8%AF%95ffmpeg/)\n\n- [ä½¿ç”¨Xcodeè°ƒè¯•ffmpeg](https://yxibng.github.io/2022/03/%E4%BD%BF%E7%94%A8Xcode%E8%B0%83%E8%AF%95ffmpeg/)\n  \n  Â Â Â Â \n\nä»Šå¤©ç”¨Xcodeè°ƒè¯•åˆ†æ `encode_video.c`\n\n## é…ç½®ffmpeg æ”¯æŒlibx264å’Œh264_videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç \n\n```shell\ncd ffmpeg\n./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc --enable-libx264 --enable-gpl --enable-videotoolboxm\nmake -j 16\nmake examples\n```\n\nå¦‚æœæ²¡æœ‰libx264ï¼Œ é€šè¿‡ [Homebrew](https://brew.sh/) å®‰è£…ä¸€ä¸‹\n\n```shell\nbrew install x264\n```\n\nffmpeg  é€šè¿‡[pkg-config](https://www.freedesktop.org/wiki/Software/pkg-config/)å¯ä»¥æ‰¾åˆ°x264å¯¹åº”çš„å¤´æ–‡ä»¶å’Œåº“çš„è·¯å¾„\n\n```shell\nâœ  ffmpeg git:(master) âœ— pkg-config --libs --cflags x264\n-DX264_API_IMPORTS -I/opt/homebrew/Cellar/x264/r3060/include -L/opt/homebrew/Cellar/x264/r3060/lib -lx264\n```\n\n## é…ç½®Xcode\n\næ·»åŠ targetï¼Œé…ç½®è·¯å¾„\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469917993141646991798582.png)\n\né…ç½®å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨å‚æ•°\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469918543121646991854240.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469918963141646991895699.png)\n\nencode_video_g æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œ\n\n1. è§†é¢‘ç¼–ç æ•°æ®çš„å†™å…¥è·¯å¾„\n\n2. ç¼–ç å™¨åå­—ï¼ˆlibx264 libx264rgb h264_videotoolboxï¼‰\n\næˆ‘ä»¬ä½¿ç”¨h264ç¼–ç å™¨ï¼ŒæŸ¥çœ‹ffmpeg æ”¯æŒçš„h264ç¼–ç å™¨\n\n```shell\nffmpeg -codecs | grep 264\nDEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (encoders: libx264 libx264rgb h264_videotoolbox )\n```\n\n## æºç åˆ†æ\n\n### mainå‡½æ•°\n\n```c\nint main(int argc, char **argv)\n{\n    const char *filename, *codec_name;\n    const AVCodec *codec;\n    AVCodecContext *c= NULL;\n    int i, ret, x, y;\n    FILE *f;\n    AVFrame *frame;\n    AVPacket *pkt;\n    uint8_t endcode[] = { 0, 0, 1, 0xb7 };\n\n    if (argc <= 2) {\n        fprintf(stderr, \"Usage: %s <output file> <codec name>\\n\", argv[0]);\n        exit(0);\n    }\n    filename = argv[1];\n    codec_name = argv[2];\n\n    /* æ ¹æ®ç¼–ç å™¨åå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨ï¼Œç¼–ç å™¨çš„åå­—å¦‚libx264,h264_videotoolbox */\n    codec = avcodec_find_encoder_by_name(codec_name);\n    if (!codec) {\n        fprintf(stderr, \"Codec '%s' not found\\n\", codec_name);\n        exit(1);\n    }\n    /* åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡ */\n    c = avcodec_alloc_context3(codec);\n    if (!c) {\n        fprintf(stderr, \"Could not allocate video codec context\\n\");\n        exit(1);\n    }\n    /* åˆ›å»º pkt ç”¨äºä¿å­˜ç¼–ç åçš„æ•°æ® */\n    pkt = av_packet_alloc();\n    if (!pkt)\n        exit(1);\n    /* é…ç½®ç¼–ç å‚æ•° */\n    //ç ç‡400000\n    c->bit_rate = 400000;\n    //ç¼–ç åˆ†è¾¨ç‡ï¼Œå®½é«˜å¿…é¡»èƒ½è¢«2æ•´é™¤\n    c->width = 352;\n    c->height = 288;\n    /*\n     ç¼–ç çš„æ—¶é—´åŸº,å¯ä»¥ç†è§£ä¸ºåˆ»åº¦ï¼Œä¸ pts æœ‰å…³\n     (AVRational){1, 25} å°†1ç§’é’Ÿåˆ†æˆ25ä»½ï¼Œæ¯ä¸€ä»½ä»£è¡¨ 1/25 ç§’\n     */\n    c->time_base = (AVRational){1, 25};\n    /* ç¼–ç å¸§ç‡ 25 å¸§ */\n    c->framerate = (AVRational){25, 1};\n\n    /* å…³é”®å¸§é—´éš”ï¼Œæ¯10å¸§äº§ç”Ÿä¸€ä¸ªå…³é”®å¸§, å¦‚æœframe->pict_type è¢«è®¾ç½®ä¸ºAV_PICTURE_TYPE_I\n     gop_sizeçš„å€¼ä¼šè¢«å¿½ç•¥ï¼Œç¼–ç å™¨ä¸äº§å‡ºBå¸§å’ŒPå¸§ï¼Œåªä¼šç¼–ç Iå¸§\n     */\n    c->gop_size = 10;\n    /* bå¸§çš„ä¸ªæ•°ï¼Œå®æ—¶é€šä¿¡ä¸€èˆ¬è®¾ç½®ä¸º0 */\n    c->max_b_frames = 1;\n    /* ç¼–ç çš„æ•°æ®æºçš„æ ¼å¼ï¼Œyuv420p */\n    c->pix_fmt = AV_PIX_FMT_YUV420P;\n    /* å¦‚æœä½¿ç”¨h264ç¼–ç å™¨ï¼Œè®¾ç½®preset ä¸ºslow */\n    if (codec->id == AV_CODEC_ID_H264)\n        av_opt_set(c->priv_data, \"preset\", \"slow\", 0);\n\n    /*\n     æ‰“å¼€ç¼–ç å™¨\n     */\n    ret = avcodec_open2(c, codec, NULL);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not open codec: %s\\n\", av_err2str(ret));\n        exit(1);\n    }\n    /* æ‰“å¼€è¾“å‡ºæ–‡ä»¶ */\n    f = fopen(filename, \"wb\");\n    if (!f) {\n        fprintf(stderr, \"Could not open %s\\n\", filename);\n        exit(1);\n    }\n    /* åˆ›å»ºAVFrameç”¨äºå­˜æ”¾å¾…ç¼–ç çš„æ•°æ®ï¼Œyuv */\n    frame = av_frame_alloc();\n    if (!frame) {\n        fprintf(stderr, \"Could not allocate video frame\\n\");\n        exit(1);\n    }\n    /* è®¾ç½®frame çš„é¢œè‰²æ ¼å¼ï¼Œå®½é«˜ */\n    frame->format = c->pix_fmt;\n    frame->width  = c->width;\n    frame->height = c->height;\n    /* æ ¹æ®ä¸Šé¢è®¾ç½®çš„å‚æ•°ï¼Œç»™frame å†…éƒ¨çš„ buf åˆ†é…å†…å­˜ */\n    ret = av_frame_get_buffer(frame, 0);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not allocate the video frame data\\n\");\n        exit(1);\n    }\n\n    /* ç¼–ç 1ç§’é’Ÿçš„æ•°æ®ï¼Œä¸Šé¢è®¾ç½®çš„ç¼–ç å¸§ç‡æ˜¯ 25 å¸§  */\n    for (i = 0; i < 25; i++) {\n        fflush(stdout);\n        /*\n         ç¡®ä¿frameä¸­çš„æ•°æ®æ˜¯å¯å†™çš„ã€‚\n         åˆšå¼€å§‹è°ƒç”¨ av_frame_get_buffer()ï¼Œframeä¸­çš„æ•°æ®æ˜¯å¯å†™çš„ã€‚\n         åé¢å°†frameé€ç»™ç¼–ç å™¨å»ç¼–ç ï¼Œå¯èƒ½è¢«ç¼–ç å™¨å¼•ç”¨ï¼Œæ­¤æ—¶frameæ˜¯ä¸å¯å†™çš„ã€‚\n         è°ƒç”¨av_frame_make_writable()ä¼šæ£€æŸ¥frame æ˜¯å¦å¯å†™ï¼Œ\n         å¦‚æœä¸å¯å†™ï¼Œä¼šç»™frameå†…éƒ¨é‡æ–°åˆ›å»ºæ–°çš„bufferã€‚\n         */\n        ret = av_frame_make_writable(frame);\n        if (ret < 0)\n            exit(1);\n\n        /* ç»™frameå¡«å……æ•°æ®ï¼Œæˆ‘ä»¬è®¾ç½®çš„æ˜¯yuv420ï¼Œè¿™é‡Œå¡«å……å‡æ•°æ® */\n        /* Y */\n        for (y = 0; y < c->height; y++) {\n            for (x = 0; x < c->width; x++) {\n                frame->data[0][y * frame->linesize[0] + x] = x + y + i * 3;\n            }\n        }\n        /* Cb and Cr */\n        for (y = 0; y < c->height/2; y++) {\n            for (x = 0; x < c->width/2; x++) {\n                frame->data[1][y * frame->linesize[1] + x] = 128 + y + i * 2;\n                frame->data[2][y * frame->linesize[2] + x] = 64 + x + i * 5;\n            }\n        }\n\n        /*\n         è®¾ç½®frameçš„pts\n         æˆ‘ä»¬è®¾ç½®çš„æ˜¯æ¯ç§’25å¸§\n         å¯¹åº”çš„æ—¶é—´è½¬æˆç§’æ˜¯ pts * av_q2d(c->time_base)\n         */\n        frame->pts = i;\n\n        /*\n         å°†frame é€ç»™ç¼–ç å™¨ç¼–ç ï¼Œå°†ç¼–ç åçš„æ•°æ®å†™å…¥æ–‡ä»¶\n         */\n        encode(c, frame, pkt, f);\n    }\n\n    /*\n     å†²æ´—ç¼–ç å™¨ï¼Œå°†å‰©ä½™çš„ç¼–ç åçš„æ•°æ®è¯»å‡ºæ¥ï¼Œå†™å…¥æ–‡ä»¶\n     */\n    encode(c, NULL, pkt, f);\n\n    /* Add sequence end code to have a real MPEG file.\n       It makes only sense because this tiny examples writes packets\n       directly. This is called \"elementary stream\" and only works for some\n       codecs. To create a valid file, you usually need to write packets\n       into a proper file format or protocol; see muxing.c.\n     */\n    if (codec->id == AV_CODEC_ID_MPEG1VIDEO || codec->id == AV_CODEC_ID_MPEG2VIDEO)\n        fwrite(endcode, 1, sizeof(endcode), f);\n\n    //å…³é—­æ–‡ä»¶\n    fclose(f);\n    //é‡Šæ”¾èµ„æº\n    avcodec_free_context(&c);\n    av_frame_free(&frame);\n    av_packet_free(&pkt);\n\n    return 0;\n}\n```\n\n1. ä»å‘½ä»¤è¡Œä¸­è¾“å‡ºæ–‡ä»¶çš„è·¯å¾„ï¼Œ ä½¿ç”¨çš„ç¼–ç å™¨åå­—\n\n2. æ ¹æ®åå­—æ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨\n\n3. åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡ï¼Œè®¾ç½®ç¼–ç å™¨çš„å‚æ•°ï¼ˆç ç‡ï¼Œæ—¶é—´åŸºï¼Œå¸§ç‡ï¼Œå®½é«˜ï¼Œé¢œè‰²æ ¼å¼ï¼Œbå¸§ä¸ªæ•°ï¼‰\n\n4. æ‰“å¼€ç¼–ç å™¨\n\n5. åˆ›å»ºAVFrame ä¿å­˜å¾…ç¼–ç çš„æ•°æ®\n\n6. åˆ›å»ºAVPacketä¿å­˜ç¼–ç åçš„æ•°æ®\n\n7. ç¼–ç 1ç§’é’Ÿçš„æ•°æ®\n\n8. å†²æ´—ç¼–ç å™¨ï¼Œå°†å‰©ä½™æ•°æ®è¯»å‡º\n\n9. å…³é—­æ–‡ä»¶ï¼Œé‡Šæ”¾èµ„æº\n\n### encode\n\n```c\nstatic void encode(AVCodecContext *enc_ctx, AVFrame *frame, AVPacket *pkt,\n                   FILE *outfile)\n{\n    int ret;\n\n    /* send the frame to the encoder */\n    if (frame)\n        printf(\"Send frame %3\"PRId64\"\\n\", frame->pts);\n\n    //ç»™ç¼–ç å™¨é€frame\n    ret = avcodec_send_frame(enc_ctx, frame);\n    if (ret < 0) {\n        fprintf(stderr, \"Error sending a frame for encoding\\n\");\n        exit(1);\n    }\n\n    while (ret >= 0) {\n        //ä»ç¼–ç å™¨è¯»pkt\n        ret = avcodec_receive_packet(enc_ctx, pkt);\n        if (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)\n        {\n            //EAGAIN ä»£è¡¨éœ€è¦ç»§ç»­é€å…¥ frame æ‰å¯ä»¥å¼€å§‹è¯»å–\n            //AVERROR_EOF ä»£è¡¨ç¼–ç å™¨å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¯»äº†\n            return;\n        }\n        else if (ret < 0) {\n            fprintf(stderr, \"Error during encoding\\n\");\n            exit(1);\n        }\n\n        printf(\"Write packet %3\"PRId64\" (size=%5d)\\n\", pkt->pts, pkt->size);\n        //å°†ç¼–ç åçš„æ•°æ®å†™å…¥æ–‡ä»¶\n        fwrite(pkt->data, 1, pkt->size, outfile);\n        //å–æ¶ˆå¼•ç”¨pkt\n        av_packet_unref(pkt);\n    }\n}\n```\n\n1. è°ƒç”¨Â Â Â avcodec_send_frame ç»™ç¼–ç å™¨é€frame\n\n2. å¾ªç¯è°ƒç”¨avcodec_receive_packet ä»ç¼–ç å™¨è¯»pkt\n   \n   - EAGAIN ä»£è¡¨éœ€è¦ç»§ç»­é€å…¥ frame æ‰å¯ä»¥å¼€å§‹è¯»å–\n   \n   - AVERROR_EOF ä»£è¡¨ç¼–ç å™¨å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¯»äº†,ä¾‹å¦‚ä¼ å…¥ç©ºçš„frameï¼Œå¯¹ç¼–ç å™¨è¿›è¡Œäº†flushæ“ä½œ\n\n3. å°†ç¼–ç åæ•°æ®å†™å…¥æ–‡ä»¶\n\n4. å–æ¶ˆå¼•ç”¨pkt\n\næœ€åè¾“å‡ºçš„æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ffplay è¿›è¡Œæ’­æ”¾\n\n```\nâœ  /tmp ffplay -i encode_video.h264\n```\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469965503041646996550013.png)\n","slug":"ffmpeg/2022-03-11-ffmpeg example å­¦ä¹  2","published":1,"updated":"2024-03-06T11:53:13.565Z","comments":1,"photos":[],"_id":"clti3glkp001t57wh1wfjdy42","content":"<p>è°ƒè¯•ffmpegæºç æ•™ç¨‹</p>\n<ul>\n<li><p><a href=\"https://yxibng.github.io/2022/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8vscode%E5%9C%A8macOS%E5%B9%B3%E5%8F%B0%E8%B0%83%E8%AF%95ffmpeg/\">å¦‚ä½•ä½¿ç”¨vscodeåœ¨macOSå¹³å°è°ƒè¯•ffmpeg</a></p>\n</li>\n<li><p><a href=\"https://yxibng.github.io/2022/03/%E4%BD%BF%E7%94%A8Xcode%E8%B0%83%E8%AF%95ffmpeg/\">ä½¿ç”¨Xcodeè°ƒè¯•ffmpeg</a></p>\n</li>\n</ul>\n<p>  Â Â Â Â </p>\n<p>ä»Šå¤©ç”¨Xcodeè°ƒè¯•åˆ†æ <code>encode_video.c</code></p>\n<h2 id=\"é…ç½®ffmpeg-æ”¯æŒlibx264å’Œh264-videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç \"><a href=\"#é…ç½®ffmpeg-æ”¯æŒlibx264å’Œh264-videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç \" class=\"headerlink\" title=\"é…ç½®ffmpeg æ”¯æŒlibx264å’Œh264_videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç \"></a>é…ç½®ffmpeg æ”¯æŒlibx264å’Œh264_videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç </h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">cd ffmpeg<br>./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc --enable-libx264 --enable-gpl --enable-videotoolboxm<br>make -j 16<br>make examples<br></code></pre></td></tr></table></figure>\n\n<p>å¦‚æœæ²¡æœ‰libx264ï¼Œ é€šè¿‡ <a href=\"https://brew.sh/\">Homebrew</a> å®‰è£…ä¸€ä¸‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">brew install x264<br></code></pre></td></tr></table></figure>\n\n<p>ffmpeg  é€šè¿‡<a href=\"https://www.freedesktop.org/wiki/Software/pkg-config/\">pkg-config</a>å¯ä»¥æ‰¾åˆ°x264å¯¹åº”çš„å¤´æ–‡ä»¶å’Œåº“çš„è·¯å¾„</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">âœ  ffmpeg git:(master) âœ— pkg-config --libs --cflags x264<br>-DX264_API_IMPORTS -I/opt/homebrew/Cellar/x264/r3060/include -L/opt/homebrew/Cellar/x264/r3060/lib -lx264<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"é…ç½®Xcode\"><a href=\"#é…ç½®Xcode\" class=\"headerlink\" title=\"é…ç½®Xcode\"></a>é…ç½®Xcode</h2><p>æ·»åŠ targetï¼Œé…ç½®è·¯å¾„</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469917993141646991798582.png\"></p>\n<p>é…ç½®å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨å‚æ•°</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469918543121646991854240.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469918963141646991895699.png\"></p>\n<p>encode_video_g æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œ</p>\n<ol>\n<li><p>è§†é¢‘ç¼–ç æ•°æ®çš„å†™å…¥è·¯å¾„</p>\n</li>\n<li><p>ç¼–ç å™¨åå­—ï¼ˆlibx264 libx264rgb h264_videotoolboxï¼‰</p>\n</li>\n</ol>\n<p>æˆ‘ä»¬ä½¿ç”¨h264ç¼–ç å™¨ï¼ŒæŸ¥çœ‹ffmpeg æ”¯æŒçš„h264ç¼–ç å™¨</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">ffmpeg -codecs | grep 264<br>DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (encoders: libx264 libx264rgb h264_videotoolbox )<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æºç åˆ†æ\"><a href=\"#æºç åˆ†æ\" class=\"headerlink\" title=\"æºç åˆ†æ\"></a>æºç åˆ†æ</h2><h3 id=\"mainå‡½æ•°\"><a href=\"#mainå‡½æ•°\" class=\"headerlink\" title=\"mainå‡½æ•°\"></a>mainå‡½æ•°</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">main</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">char</span> **argv)</span><br>&#123;<br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> *filename, *codec_name;<br>    <span class=\"hljs-type\">const</span> AVCodec *codec;<br>    AVCodecContext *c= <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">int</span> i, ret, x, y;<br>    FILE *f;<br>    AVFrame *frame;<br>    AVPacket *pkt;<br>    <span class=\"hljs-type\">uint8_t</span> endcode[] = &#123; <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0xb7</span> &#125;;<br><br>    <span class=\"hljs-keyword\">if</span> (argc &lt;= <span class=\"hljs-number\">2</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Usage: %s &lt;output file&gt; &lt;codec name&gt;\\n&quot;</span>, argv[<span class=\"hljs-number\">0</span>]);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">0</span>);<br>    &#125;<br>    filename = argv[<span class=\"hljs-number\">1</span>];<br>    codec_name = argv[<span class=\"hljs-number\">2</span>];<br><br>    <span class=\"hljs-comment\">/* æ ¹æ®ç¼–ç å™¨åå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨ï¼Œç¼–ç å™¨çš„åå­—å¦‚libx264,h264_videotoolbox */</span><br>    codec = avcodec_find_encoder_by_name(codec_name);<br>    <span class=\"hljs-keyword\">if</span> (!codec) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Codec &#x27;%s&#x27; not found\\n&quot;</span>, codec_name);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡ */</span><br>    c = avcodec_alloc_context3(codec);<br>    <span class=\"hljs-keyword\">if</span> (!c) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate video codec context\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* åˆ›å»º pkt ç”¨äºä¿å­˜ç¼–ç åçš„æ•°æ® */</span><br>    pkt = av_packet_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!pkt)<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    <span class=\"hljs-comment\">/* é…ç½®ç¼–ç å‚æ•° */</span><br>    <span class=\"hljs-comment\">//ç ç‡400000</span><br>    c-&gt;bit_rate = <span class=\"hljs-number\">400000</span>;<br>    <span class=\"hljs-comment\">//ç¼–ç åˆ†è¾¨ç‡ï¼Œå®½é«˜å¿…é¡»èƒ½è¢«2æ•´é™¤</span><br>    c-&gt;width = <span class=\"hljs-number\">352</span>;<br>    c-&gt;height = <span class=\"hljs-number\">288</span>;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     ç¼–ç çš„æ—¶é—´åŸº,å¯ä»¥ç†è§£ä¸ºåˆ»åº¦ï¼Œä¸ pts æœ‰å…³</span><br><span class=\"hljs-comment\">     (AVRational)&#123;1, 25&#125; å°†1ç§’é’Ÿåˆ†æˆ25ä»½ï¼Œæ¯ä¸€ä»½ä»£è¡¨ 1/25 ç§’</span><br><span class=\"hljs-comment\">     */</span><br>    c-&gt;time_base = (AVRational)&#123;<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">25</span>&#125;;<br>    <span class=\"hljs-comment\">/* ç¼–ç å¸§ç‡ 25 å¸§ */</span><br>    c-&gt;framerate = (AVRational)&#123;<span class=\"hljs-number\">25</span>, <span class=\"hljs-number\">1</span>&#125;;<br><br>    <span class=\"hljs-comment\">/* å…³é”®å¸§é—´éš”ï¼Œæ¯10å¸§äº§ç”Ÿä¸€ä¸ªå…³é”®å¸§, å¦‚æœframe-&gt;pict_type è¢«è®¾ç½®ä¸ºAV_PICTURE_TYPE_I</span><br><span class=\"hljs-comment\">     gop_sizeçš„å€¼ä¼šè¢«å¿½ç•¥ï¼Œç¼–ç å™¨ä¸äº§å‡ºBå¸§å’ŒPå¸§ï¼Œåªä¼šç¼–ç Iå¸§</span><br><span class=\"hljs-comment\">     */</span><br>    c-&gt;gop_size = <span class=\"hljs-number\">10</span>;<br>    <span class=\"hljs-comment\">/* bå¸§çš„ä¸ªæ•°ï¼Œå®æ—¶é€šä¿¡ä¸€èˆ¬è®¾ç½®ä¸º0 */</span><br>    c-&gt;max_b_frames = <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-comment\">/* ç¼–ç çš„æ•°æ®æºçš„æ ¼å¼ï¼Œyuv420p */</span><br>    c-&gt;pix_fmt = AV_PIX_FMT_YUV420P;<br>    <span class=\"hljs-comment\">/* å¦‚æœä½¿ç”¨h264ç¼–ç å™¨ï¼Œè®¾ç½®preset ä¸ºslow */</span><br>    <span class=\"hljs-keyword\">if</span> (codec-&gt;id == AV_CODEC_ID_H264)<br>        av_opt_set(c-&gt;priv_data, <span class=\"hljs-string\">&quot;preset&quot;</span>, <span class=\"hljs-string\">&quot;slow&quot;</span>, <span class=\"hljs-number\">0</span>);<br><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     æ‰“å¼€ç¼–ç å™¨</span><br><span class=\"hljs-comment\">     */</span><br>    ret = avcodec_open2(c, codec, <span class=\"hljs-literal\">NULL</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open codec: %s\\n&quot;</span>, av_err2str(ret));<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* æ‰“å¼€è¾“å‡ºæ–‡ä»¶ */</span><br>    f = fopen(filename, <span class=\"hljs-string\">&quot;wb&quot;</span>);<br>    <span class=\"hljs-keyword\">if</span> (!f) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open %s\\n&quot;</span>, filename);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* åˆ›å»ºAVFrameç”¨äºå­˜æ”¾å¾…ç¼–ç çš„æ•°æ®ï¼Œyuv */</span><br>    frame = av_frame_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!frame) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate video frame\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* è®¾ç½®frame çš„é¢œè‰²æ ¼å¼ï¼Œå®½é«˜ */</span><br>    frame-&gt;format = c-&gt;pix_fmt;<br>    frame-&gt;width  = c-&gt;width;<br>    frame-&gt;height = c-&gt;height;<br>    <span class=\"hljs-comment\">/* æ ¹æ®ä¸Šé¢è®¾ç½®çš„å‚æ•°ï¼Œç»™frame å†…éƒ¨çš„ buf åˆ†é…å†…å­˜ */</span><br>    ret = av_frame_get_buffer(frame, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate the video frame data\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* ç¼–ç 1ç§’é’Ÿçš„æ•°æ®ï¼Œä¸Šé¢è®¾ç½®çš„ç¼–ç å¸§ç‡æ˜¯ 25 å¸§  */</span><br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">25</span>; i++) &#123;<br>        fflush(<span class=\"hljs-built_in\">stdout</span>);<br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         ç¡®ä¿frameä¸­çš„æ•°æ®æ˜¯å¯å†™çš„ã€‚</span><br><span class=\"hljs-comment\">         åˆšå¼€å§‹è°ƒç”¨ av_frame_get_buffer()ï¼Œframeä¸­çš„æ•°æ®æ˜¯å¯å†™çš„ã€‚</span><br><span class=\"hljs-comment\">         åé¢å°†frameé€ç»™ç¼–ç å™¨å»ç¼–ç ï¼Œå¯èƒ½è¢«ç¼–ç å™¨å¼•ç”¨ï¼Œæ­¤æ—¶frameæ˜¯ä¸å¯å†™çš„ã€‚</span><br><span class=\"hljs-comment\">         è°ƒç”¨av_frame_make_writable()ä¼šæ£€æŸ¥frame æ˜¯å¦å¯å†™ï¼Œ</span><br><span class=\"hljs-comment\">         å¦‚æœä¸å¯å†™ï¼Œä¼šç»™frameå†…éƒ¨é‡æ–°åˆ›å»ºæ–°çš„bufferã€‚</span><br><span class=\"hljs-comment\">         */</span><br>        ret = av_frame_make_writable(frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br><br>        <span class=\"hljs-comment\">/* ç»™frameå¡«å……æ•°æ®ï¼Œæˆ‘ä»¬è®¾ç½®çš„æ˜¯yuv420ï¼Œè¿™é‡Œå¡«å……å‡æ•°æ® */</span><br>        <span class=\"hljs-comment\">/* Y */</span><br>        <span class=\"hljs-keyword\">for</span> (y = <span class=\"hljs-number\">0</span>; y &lt; c-&gt;height; y++) &#123;<br>            <span class=\"hljs-keyword\">for</span> (x = <span class=\"hljs-number\">0</span>; x &lt; c-&gt;width; x++) &#123;<br>                frame-&gt;data[<span class=\"hljs-number\">0</span>][y * frame-&gt;linesize[<span class=\"hljs-number\">0</span>] + x] = x + y + i * <span class=\"hljs-number\">3</span>;<br>            &#125;<br>        &#125;<br>        <span class=\"hljs-comment\">/* Cb and Cr */</span><br>        <span class=\"hljs-keyword\">for</span> (y = <span class=\"hljs-number\">0</span>; y &lt; c-&gt;height/<span class=\"hljs-number\">2</span>; y++) &#123;<br>            <span class=\"hljs-keyword\">for</span> (x = <span class=\"hljs-number\">0</span>; x &lt; c-&gt;width/<span class=\"hljs-number\">2</span>; x++) &#123;<br>                frame-&gt;data[<span class=\"hljs-number\">1</span>][y * frame-&gt;linesize[<span class=\"hljs-number\">1</span>] + x] = <span class=\"hljs-number\">128</span> + y + i * <span class=\"hljs-number\">2</span>;<br>                frame-&gt;data[<span class=\"hljs-number\">2</span>][y * frame-&gt;linesize[<span class=\"hljs-number\">2</span>] + x] = <span class=\"hljs-number\">64</span> + x + i * <span class=\"hljs-number\">5</span>;<br>            &#125;<br>        &#125;<br><br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         è®¾ç½®frameçš„pts</span><br><span class=\"hljs-comment\">         æˆ‘ä»¬è®¾ç½®çš„æ˜¯æ¯ç§’25å¸§</span><br><span class=\"hljs-comment\">         å¯¹åº”çš„æ—¶é—´è½¬æˆç§’æ˜¯ pts * av_q2d(c-&gt;time_base)</span><br><span class=\"hljs-comment\">         */</span><br>        frame-&gt;pts = i;<br><br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         å°†frame é€ç»™ç¼–ç å™¨ç¼–ç ï¼Œå°†ç¼–ç åçš„æ•°æ®å†™å…¥æ–‡ä»¶</span><br><span class=\"hljs-comment\">         */</span><br>        encode(c, frame, pkt, f);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     å†²æ´—ç¼–ç å™¨ï¼Œå°†å‰©ä½™çš„ç¼–ç åçš„æ•°æ®è¯»å‡ºæ¥ï¼Œå†™å…¥æ–‡ä»¶</span><br><span class=\"hljs-comment\">     */</span><br>    encode(c, <span class=\"hljs-literal\">NULL</span>, pkt, f);<br><br>    <span class=\"hljs-comment\">/* Add sequence end code to have a real MPEG file.</span><br><span class=\"hljs-comment\">       It makes only sense because this tiny examples writes packets</span><br><span class=\"hljs-comment\">       directly. This is called &quot;elementary stream&quot; and only works for some</span><br><span class=\"hljs-comment\">       codecs. To create a valid file, you usually need to write packets</span><br><span class=\"hljs-comment\">       into a proper file format or protocol; see muxing.c.</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-keyword\">if</span> (codec-&gt;id == AV_CODEC_ID_MPEG1VIDEO || codec-&gt;id == AV_CODEC_ID_MPEG2VIDEO)<br>        fwrite(endcode, <span class=\"hljs-number\">1</span>, <span class=\"hljs-keyword\">sizeof</span>(endcode), f);<br><br>    <span class=\"hljs-comment\">//å…³é—­æ–‡ä»¶</span><br>    fclose(f);<br>    <span class=\"hljs-comment\">//é‡Šæ”¾èµ„æº</span><br>    avcodec_free_context(&amp;c);<br>    av_frame_free(&amp;frame);<br>    av_packet_free(&amp;pkt);<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>ä»å‘½ä»¤è¡Œä¸­è¾“å‡ºæ–‡ä»¶çš„è·¯å¾„ï¼Œ ä½¿ç”¨çš„ç¼–ç å™¨åå­—</p>\n</li>\n<li><p>æ ¹æ®åå­—æ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨</p>\n</li>\n<li><p>åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡ï¼Œè®¾ç½®ç¼–ç å™¨çš„å‚æ•°ï¼ˆç ç‡ï¼Œæ—¶é—´åŸºï¼Œå¸§ç‡ï¼Œå®½é«˜ï¼Œé¢œè‰²æ ¼å¼ï¼Œbå¸§ä¸ªæ•°ï¼‰</p>\n</li>\n<li><p>æ‰“å¼€ç¼–ç å™¨</p>\n</li>\n<li><p>åˆ›å»ºAVFrame ä¿å­˜å¾…ç¼–ç çš„æ•°æ®</p>\n</li>\n<li><p>åˆ›å»ºAVPacketä¿å­˜ç¼–ç åçš„æ•°æ®</p>\n</li>\n<li><p>ç¼–ç 1ç§’é’Ÿçš„æ•°æ®</p>\n</li>\n<li><p>å†²æ´—ç¼–ç å™¨ï¼Œå°†å‰©ä½™æ•°æ®è¯»å‡º</p>\n</li>\n<li><p>å…³é—­æ–‡ä»¶ï¼Œé‡Šæ”¾èµ„æº</p>\n</li>\n</ol>\n<h3 id=\"encode\"><a href=\"#encode\" class=\"headerlink\" title=\"encode\"></a>encode</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">encode</span><span class=\"hljs-params\">(AVCodecContext *enc_ctx, AVFrame *frame, AVPacket *pkt,</span><br><span class=\"hljs-params\">                   FILE *outfile)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret;<br><br>    <span class=\"hljs-comment\">/* send the frame to the encoder */</span><br>    <span class=\"hljs-keyword\">if</span> (frame)<br>        <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;Send frame %3&quot;</span>PRId64<span class=\"hljs-string\">&quot;\\n&quot;</span>, frame-&gt;pts);<br><br>    <span class=\"hljs-comment\">//ç»™ç¼–ç å™¨é€frame</span><br>    ret = avcodec_send_frame(enc_ctx, frame);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error sending a frame for encoding\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//ä»ç¼–ç å™¨è¯»pkt</span><br>        ret = avcodec_receive_packet(enc_ctx, pkt);<br>        <span class=\"hljs-keyword\">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)<br>        &#123;<br>            <span class=\"hljs-comment\">//EAGAIN ä»£è¡¨éœ€è¦ç»§ç»­é€å…¥ frame æ‰å¯ä»¥å¼€å§‹è¯»å–</span><br>            <span class=\"hljs-comment\">//AVERROR_EOF ä»£è¡¨ç¼–ç å™¨å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¯»äº†</span><br>            <span class=\"hljs-keyword\">return</span>;<br>        &#125;<br>        <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error during encoding\\n&quot;</span>);<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br><br>        <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;Write packet %3&quot;</span>PRId64<span class=\"hljs-string\">&quot; (size=%5d)\\n&quot;</span>, pkt-&gt;pts, pkt-&gt;size);<br>        <span class=\"hljs-comment\">//å°†ç¼–ç åçš„æ•°æ®å†™å…¥æ–‡ä»¶</span><br>        fwrite(pkt-&gt;data, <span class=\"hljs-number\">1</span>, pkt-&gt;size, outfile);<br>        <span class=\"hljs-comment\">//å–æ¶ˆå¼•ç”¨pkt</span><br>        av_packet_unref(pkt);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è°ƒç”¨Â Â Â avcodec_send_frame ç»™ç¼–ç å™¨é€frame</p>\n</li>\n<li><p>å¾ªç¯è°ƒç”¨avcodec_receive_packet ä»ç¼–ç å™¨è¯»pkt</p>\n<ul>\n<li><p>EAGAIN ä»£è¡¨éœ€è¦ç»§ç»­é€å…¥ frame æ‰å¯ä»¥å¼€å§‹è¯»å–</p>\n</li>\n<li><p>AVERROR_EOF ä»£è¡¨ç¼–ç å™¨å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¯»äº†,ä¾‹å¦‚ä¼ å…¥ç©ºçš„frameï¼Œå¯¹ç¼–ç å™¨è¿›è¡Œäº†flushæ“ä½œ</p>\n</li>\n</ul>\n</li>\n<li><p>å°†ç¼–ç åæ•°æ®å†™å…¥æ–‡ä»¶</p>\n</li>\n<li><p>å–æ¶ˆå¼•ç”¨pkt</p>\n</li>\n</ol>\n<p>æœ€åè¾“å‡ºçš„æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ffplay è¿›è¡Œæ’­æ”¾</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">âœ  /tmp ffplay -i encode_video.h264<br></code></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469965503041646996550013.png\"></p>\n","excerpt":"","more":"<p>è°ƒè¯•ffmpegæºç æ•™ç¨‹</p>\n<ul>\n<li><p><a href=\"https://yxibng.github.io/2022/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8vscode%E5%9C%A8macOS%E5%B9%B3%E5%8F%B0%E8%B0%83%E8%AF%95ffmpeg/\">å¦‚ä½•ä½¿ç”¨vscodeåœ¨macOSå¹³å°è°ƒè¯•ffmpeg</a></p>\n</li>\n<li><p><a href=\"https://yxibng.github.io/2022/03/%E4%BD%BF%E7%94%A8Xcode%E8%B0%83%E8%AF%95ffmpeg/\">ä½¿ç”¨Xcodeè°ƒè¯•ffmpeg</a></p>\n</li>\n</ul>\n<p>  Â Â Â Â </p>\n<p>ä»Šå¤©ç”¨Xcodeè°ƒè¯•åˆ†æ <code>encode_video.c</code></p>\n<h2 id=\"é…ç½®ffmpeg-æ”¯æŒlibx264å’Œh264-videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç \"><a href=\"#é…ç½®ffmpeg-æ”¯æŒlibx264å’Œh264-videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç \" class=\"headerlink\" title=\"é…ç½®ffmpeg æ”¯æŒlibx264å’Œh264_videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç \"></a>é…ç½®ffmpeg æ”¯æŒlibx264å’Œh264_videotoolboxæ¥è¿›è¡Œè§†é¢‘ç¼–ç </h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">cd ffmpeg<br>./configure  --disable-optimizations --disable-stripping --enable-debug=3 --disable-doc --enable-libx264 --enable-gpl --enable-videotoolboxm<br>make -j 16<br>make examples<br></code></pre></td></tr></table></figure>\n\n<p>å¦‚æœæ²¡æœ‰libx264ï¼Œ é€šè¿‡ <a href=\"https://brew.sh/\">Homebrew</a> å®‰è£…ä¸€ä¸‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">brew install x264<br></code></pre></td></tr></table></figure>\n\n<p>ffmpeg  é€šè¿‡<a href=\"https://www.freedesktop.org/wiki/Software/pkg-config/\">pkg-config</a>å¯ä»¥æ‰¾åˆ°x264å¯¹åº”çš„å¤´æ–‡ä»¶å’Œåº“çš„è·¯å¾„</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">âœ  ffmpeg git:(master) âœ— pkg-config --libs --cflags x264<br>-DX264_API_IMPORTS -I/opt/homebrew/Cellar/x264/r3060/include -L/opt/homebrew/Cellar/x264/r3060/lib -lx264<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"é…ç½®Xcode\"><a href=\"#é…ç½®Xcode\" class=\"headerlink\" title=\"é…ç½®Xcode\"></a>é…ç½®Xcode</h2><p>æ·»åŠ targetï¼Œé…ç½®è·¯å¾„</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469917993141646991798582.png\"></p>\n<p>é…ç½®å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨å‚æ•°</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469918543121646991854240.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469918963141646991895699.png\"></p>\n<p>encode_video_g æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œ</p>\n<ol>\n<li><p>è§†é¢‘ç¼–ç æ•°æ®çš„å†™å…¥è·¯å¾„</p>\n</li>\n<li><p>ç¼–ç å™¨åå­—ï¼ˆlibx264 libx264rgb h264_videotoolboxï¼‰</p>\n</li>\n</ol>\n<p>æˆ‘ä»¬ä½¿ç”¨h264ç¼–ç å™¨ï¼ŒæŸ¥çœ‹ffmpeg æ”¯æŒçš„h264ç¼–ç å™¨</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">ffmpeg -codecs | grep 264<br>DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (encoders: libx264 libx264rgb h264_videotoolbox )<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æºç åˆ†æ\"><a href=\"#æºç åˆ†æ\" class=\"headerlink\" title=\"æºç åˆ†æ\"></a>æºç åˆ†æ</h2><h3 id=\"mainå‡½æ•°\"><a href=\"#mainå‡½æ•°\" class=\"headerlink\" title=\"mainå‡½æ•°\"></a>mainå‡½æ•°</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">main</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">char</span> **argv)</span><br>&#123;<br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> *filename, *codec_name;<br>    <span class=\"hljs-type\">const</span> AVCodec *codec;<br>    AVCodecContext *c= <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">int</span> i, ret, x, y;<br>    FILE *f;<br>    AVFrame *frame;<br>    AVPacket *pkt;<br>    <span class=\"hljs-type\">uint8_t</span> endcode[] = &#123; <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0xb7</span> &#125;;<br><br>    <span class=\"hljs-keyword\">if</span> (argc &lt;= <span class=\"hljs-number\">2</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Usage: %s &lt;output file&gt; &lt;codec name&gt;\\n&quot;</span>, argv[<span class=\"hljs-number\">0</span>]);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">0</span>);<br>    &#125;<br>    filename = argv[<span class=\"hljs-number\">1</span>];<br>    codec_name = argv[<span class=\"hljs-number\">2</span>];<br><br>    <span class=\"hljs-comment\">/* æ ¹æ®ç¼–ç å™¨åå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨ï¼Œç¼–ç å™¨çš„åå­—å¦‚libx264,h264_videotoolbox */</span><br>    codec = avcodec_find_encoder_by_name(codec_name);<br>    <span class=\"hljs-keyword\">if</span> (!codec) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Codec &#x27;%s&#x27; not found\\n&quot;</span>, codec_name);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡ */</span><br>    c = avcodec_alloc_context3(codec);<br>    <span class=\"hljs-keyword\">if</span> (!c) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate video codec context\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* åˆ›å»º pkt ç”¨äºä¿å­˜ç¼–ç åçš„æ•°æ® */</span><br>    pkt = av_packet_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!pkt)<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    <span class=\"hljs-comment\">/* é…ç½®ç¼–ç å‚æ•° */</span><br>    <span class=\"hljs-comment\">//ç ç‡400000</span><br>    c-&gt;bit_rate = <span class=\"hljs-number\">400000</span>;<br>    <span class=\"hljs-comment\">//ç¼–ç åˆ†è¾¨ç‡ï¼Œå®½é«˜å¿…é¡»èƒ½è¢«2æ•´é™¤</span><br>    c-&gt;width = <span class=\"hljs-number\">352</span>;<br>    c-&gt;height = <span class=\"hljs-number\">288</span>;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     ç¼–ç çš„æ—¶é—´åŸº,å¯ä»¥ç†è§£ä¸ºåˆ»åº¦ï¼Œä¸ pts æœ‰å…³</span><br><span class=\"hljs-comment\">     (AVRational)&#123;1, 25&#125; å°†1ç§’é’Ÿåˆ†æˆ25ä»½ï¼Œæ¯ä¸€ä»½ä»£è¡¨ 1/25 ç§’</span><br><span class=\"hljs-comment\">     */</span><br>    c-&gt;time_base = (AVRational)&#123;<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">25</span>&#125;;<br>    <span class=\"hljs-comment\">/* ç¼–ç å¸§ç‡ 25 å¸§ */</span><br>    c-&gt;framerate = (AVRational)&#123;<span class=\"hljs-number\">25</span>, <span class=\"hljs-number\">1</span>&#125;;<br><br>    <span class=\"hljs-comment\">/* å…³é”®å¸§é—´éš”ï¼Œæ¯10å¸§äº§ç”Ÿä¸€ä¸ªå…³é”®å¸§, å¦‚æœframe-&gt;pict_type è¢«è®¾ç½®ä¸ºAV_PICTURE_TYPE_I</span><br><span class=\"hljs-comment\">     gop_sizeçš„å€¼ä¼šè¢«å¿½ç•¥ï¼Œç¼–ç å™¨ä¸äº§å‡ºBå¸§å’ŒPå¸§ï¼Œåªä¼šç¼–ç Iå¸§</span><br><span class=\"hljs-comment\">     */</span><br>    c-&gt;gop_size = <span class=\"hljs-number\">10</span>;<br>    <span class=\"hljs-comment\">/* bå¸§çš„ä¸ªæ•°ï¼Œå®æ—¶é€šä¿¡ä¸€èˆ¬è®¾ç½®ä¸º0 */</span><br>    c-&gt;max_b_frames = <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-comment\">/* ç¼–ç çš„æ•°æ®æºçš„æ ¼å¼ï¼Œyuv420p */</span><br>    c-&gt;pix_fmt = AV_PIX_FMT_YUV420P;<br>    <span class=\"hljs-comment\">/* å¦‚æœä½¿ç”¨h264ç¼–ç å™¨ï¼Œè®¾ç½®preset ä¸ºslow */</span><br>    <span class=\"hljs-keyword\">if</span> (codec-&gt;id == AV_CODEC_ID_H264)<br>        av_opt_set(c-&gt;priv_data, <span class=\"hljs-string\">&quot;preset&quot;</span>, <span class=\"hljs-string\">&quot;slow&quot;</span>, <span class=\"hljs-number\">0</span>);<br><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     æ‰“å¼€ç¼–ç å™¨</span><br><span class=\"hljs-comment\">     */</span><br>    ret = avcodec_open2(c, codec, <span class=\"hljs-literal\">NULL</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open codec: %s\\n&quot;</span>, av_err2str(ret));<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* æ‰“å¼€è¾“å‡ºæ–‡ä»¶ */</span><br>    f = fopen(filename, <span class=\"hljs-string\">&quot;wb&quot;</span>);<br>    <span class=\"hljs-keyword\">if</span> (!f) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open %s\\n&quot;</span>, filename);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* åˆ›å»ºAVFrameç”¨äºå­˜æ”¾å¾…ç¼–ç çš„æ•°æ®ï¼Œyuv */</span><br>    frame = av_frame_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!frame) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate video frame\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* è®¾ç½®frame çš„é¢œè‰²æ ¼å¼ï¼Œå®½é«˜ */</span><br>    frame-&gt;format = c-&gt;pix_fmt;<br>    frame-&gt;width  = c-&gt;width;<br>    frame-&gt;height = c-&gt;height;<br>    <span class=\"hljs-comment\">/* æ ¹æ®ä¸Šé¢è®¾ç½®çš„å‚æ•°ï¼Œç»™frame å†…éƒ¨çš„ buf åˆ†é…å†…å­˜ */</span><br>    ret = av_frame_get_buffer(frame, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate the video frame data\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* ç¼–ç 1ç§’é’Ÿçš„æ•°æ®ï¼Œä¸Šé¢è®¾ç½®çš„ç¼–ç å¸§ç‡æ˜¯ 25 å¸§  */</span><br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">25</span>; i++) &#123;<br>        fflush(<span class=\"hljs-built_in\">stdout</span>);<br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         ç¡®ä¿frameä¸­çš„æ•°æ®æ˜¯å¯å†™çš„ã€‚</span><br><span class=\"hljs-comment\">         åˆšå¼€å§‹è°ƒç”¨ av_frame_get_buffer()ï¼Œframeä¸­çš„æ•°æ®æ˜¯å¯å†™çš„ã€‚</span><br><span class=\"hljs-comment\">         åé¢å°†frameé€ç»™ç¼–ç å™¨å»ç¼–ç ï¼Œå¯èƒ½è¢«ç¼–ç å™¨å¼•ç”¨ï¼Œæ­¤æ—¶frameæ˜¯ä¸å¯å†™çš„ã€‚</span><br><span class=\"hljs-comment\">         è°ƒç”¨av_frame_make_writable()ä¼šæ£€æŸ¥frame æ˜¯å¦å¯å†™ï¼Œ</span><br><span class=\"hljs-comment\">         å¦‚æœä¸å¯å†™ï¼Œä¼šç»™frameå†…éƒ¨é‡æ–°åˆ›å»ºæ–°çš„bufferã€‚</span><br><span class=\"hljs-comment\">         */</span><br>        ret = av_frame_make_writable(frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br><br>        <span class=\"hljs-comment\">/* ç»™frameå¡«å……æ•°æ®ï¼Œæˆ‘ä»¬è®¾ç½®çš„æ˜¯yuv420ï¼Œè¿™é‡Œå¡«å……å‡æ•°æ® */</span><br>        <span class=\"hljs-comment\">/* Y */</span><br>        <span class=\"hljs-keyword\">for</span> (y = <span class=\"hljs-number\">0</span>; y &lt; c-&gt;height; y++) &#123;<br>            <span class=\"hljs-keyword\">for</span> (x = <span class=\"hljs-number\">0</span>; x &lt; c-&gt;width; x++) &#123;<br>                frame-&gt;data[<span class=\"hljs-number\">0</span>][y * frame-&gt;linesize[<span class=\"hljs-number\">0</span>] + x] = x + y + i * <span class=\"hljs-number\">3</span>;<br>            &#125;<br>        &#125;<br>        <span class=\"hljs-comment\">/* Cb and Cr */</span><br>        <span class=\"hljs-keyword\">for</span> (y = <span class=\"hljs-number\">0</span>; y &lt; c-&gt;height/<span class=\"hljs-number\">2</span>; y++) &#123;<br>            <span class=\"hljs-keyword\">for</span> (x = <span class=\"hljs-number\">0</span>; x &lt; c-&gt;width/<span class=\"hljs-number\">2</span>; x++) &#123;<br>                frame-&gt;data[<span class=\"hljs-number\">1</span>][y * frame-&gt;linesize[<span class=\"hljs-number\">1</span>] + x] = <span class=\"hljs-number\">128</span> + y + i * <span class=\"hljs-number\">2</span>;<br>                frame-&gt;data[<span class=\"hljs-number\">2</span>][y * frame-&gt;linesize[<span class=\"hljs-number\">2</span>] + x] = <span class=\"hljs-number\">64</span> + x + i * <span class=\"hljs-number\">5</span>;<br>            &#125;<br>        &#125;<br><br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         è®¾ç½®frameçš„pts</span><br><span class=\"hljs-comment\">         æˆ‘ä»¬è®¾ç½®çš„æ˜¯æ¯ç§’25å¸§</span><br><span class=\"hljs-comment\">         å¯¹åº”çš„æ—¶é—´è½¬æˆç§’æ˜¯ pts * av_q2d(c-&gt;time_base)</span><br><span class=\"hljs-comment\">         */</span><br>        frame-&gt;pts = i;<br><br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         å°†frame é€ç»™ç¼–ç å™¨ç¼–ç ï¼Œå°†ç¼–ç åçš„æ•°æ®å†™å…¥æ–‡ä»¶</span><br><span class=\"hljs-comment\">         */</span><br>        encode(c, frame, pkt, f);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     å†²æ´—ç¼–ç å™¨ï¼Œå°†å‰©ä½™çš„ç¼–ç åçš„æ•°æ®è¯»å‡ºæ¥ï¼Œå†™å…¥æ–‡ä»¶</span><br><span class=\"hljs-comment\">     */</span><br>    encode(c, <span class=\"hljs-literal\">NULL</span>, pkt, f);<br><br>    <span class=\"hljs-comment\">/* Add sequence end code to have a real MPEG file.</span><br><span class=\"hljs-comment\">       It makes only sense because this tiny examples writes packets</span><br><span class=\"hljs-comment\">       directly. This is called &quot;elementary stream&quot; and only works for some</span><br><span class=\"hljs-comment\">       codecs. To create a valid file, you usually need to write packets</span><br><span class=\"hljs-comment\">       into a proper file format or protocol; see muxing.c.</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-keyword\">if</span> (codec-&gt;id == AV_CODEC_ID_MPEG1VIDEO || codec-&gt;id == AV_CODEC_ID_MPEG2VIDEO)<br>        fwrite(endcode, <span class=\"hljs-number\">1</span>, <span class=\"hljs-keyword\">sizeof</span>(endcode), f);<br><br>    <span class=\"hljs-comment\">//å…³é—­æ–‡ä»¶</span><br>    fclose(f);<br>    <span class=\"hljs-comment\">//é‡Šæ”¾èµ„æº</span><br>    avcodec_free_context(&amp;c);<br>    av_frame_free(&amp;frame);<br>    av_packet_free(&amp;pkt);<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>ä»å‘½ä»¤è¡Œä¸­è¾“å‡ºæ–‡ä»¶çš„è·¯å¾„ï¼Œ ä½¿ç”¨çš„ç¼–ç å™¨åå­—</p>\n</li>\n<li><p>æ ¹æ®åå­—æ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨</p>\n</li>\n<li><p>åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡ï¼Œè®¾ç½®ç¼–ç å™¨çš„å‚æ•°ï¼ˆç ç‡ï¼Œæ—¶é—´åŸºï¼Œå¸§ç‡ï¼Œå®½é«˜ï¼Œé¢œè‰²æ ¼å¼ï¼Œbå¸§ä¸ªæ•°ï¼‰</p>\n</li>\n<li><p>æ‰“å¼€ç¼–ç å™¨</p>\n</li>\n<li><p>åˆ›å»ºAVFrame ä¿å­˜å¾…ç¼–ç çš„æ•°æ®</p>\n</li>\n<li><p>åˆ›å»ºAVPacketä¿å­˜ç¼–ç åçš„æ•°æ®</p>\n</li>\n<li><p>ç¼–ç 1ç§’é’Ÿçš„æ•°æ®</p>\n</li>\n<li><p>å†²æ´—ç¼–ç å™¨ï¼Œå°†å‰©ä½™æ•°æ®è¯»å‡º</p>\n</li>\n<li><p>å…³é—­æ–‡ä»¶ï¼Œé‡Šæ”¾èµ„æº</p>\n</li>\n</ol>\n<h3 id=\"encode\"><a href=\"#encode\" class=\"headerlink\" title=\"encode\"></a>encode</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">encode</span><span class=\"hljs-params\">(AVCodecContext *enc_ctx, AVFrame *frame, AVPacket *pkt,</span><br><span class=\"hljs-params\">                   FILE *outfile)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret;<br><br>    <span class=\"hljs-comment\">/* send the frame to the encoder */</span><br>    <span class=\"hljs-keyword\">if</span> (frame)<br>        <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;Send frame %3&quot;</span>PRId64<span class=\"hljs-string\">&quot;\\n&quot;</span>, frame-&gt;pts);<br><br>    <span class=\"hljs-comment\">//ç»™ç¼–ç å™¨é€frame</span><br>    ret = avcodec_send_frame(enc_ctx, frame);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error sending a frame for encoding\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//ä»ç¼–ç å™¨è¯»pkt</span><br>        ret = avcodec_receive_packet(enc_ctx, pkt);<br>        <span class=\"hljs-keyword\">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)<br>        &#123;<br>            <span class=\"hljs-comment\">//EAGAIN ä»£è¡¨éœ€è¦ç»§ç»­é€å…¥ frame æ‰å¯ä»¥å¼€å§‹è¯»å–</span><br>            <span class=\"hljs-comment\">//AVERROR_EOF ä»£è¡¨ç¼–ç å™¨å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¯»äº†</span><br>            <span class=\"hljs-keyword\">return</span>;<br>        &#125;<br>        <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error during encoding\\n&quot;</span>);<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br><br>        <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;Write packet %3&quot;</span>PRId64<span class=\"hljs-string\">&quot; (size=%5d)\\n&quot;</span>, pkt-&gt;pts, pkt-&gt;size);<br>        <span class=\"hljs-comment\">//å°†ç¼–ç åçš„æ•°æ®å†™å…¥æ–‡ä»¶</span><br>        fwrite(pkt-&gt;data, <span class=\"hljs-number\">1</span>, pkt-&gt;size, outfile);<br>        <span class=\"hljs-comment\">//å–æ¶ˆå¼•ç”¨pkt</span><br>        av_packet_unref(pkt);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è°ƒç”¨Â Â Â avcodec_send_frame ç»™ç¼–ç å™¨é€frame</p>\n</li>\n<li><p>å¾ªç¯è°ƒç”¨avcodec_receive_packet ä»ç¼–ç å™¨è¯»pkt</p>\n<ul>\n<li><p>EAGAIN ä»£è¡¨éœ€è¦ç»§ç»­é€å…¥ frame æ‰å¯ä»¥å¼€å§‹è¯»å–</p>\n</li>\n<li><p>AVERROR_EOF ä»£è¡¨ç¼–ç å™¨å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¯»äº†,ä¾‹å¦‚ä¼ å…¥ç©ºçš„frameï¼Œå¯¹ç¼–ç å™¨è¿›è¡Œäº†flushæ“ä½œ</p>\n</li>\n</ul>\n</li>\n<li><p>å°†ç¼–ç åæ•°æ®å†™å…¥æ–‡ä»¶</p>\n</li>\n<li><p>å–æ¶ˆå¼•ç”¨pkt</p>\n</li>\n</ol>\n<p>æœ€åè¾“å‡ºçš„æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ffplay è¿›è¡Œæ’­æ”¾</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">âœ  /tmp ffplay -i encode_video.h264<br></code></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16469965503041646996550013.png\"></p>\n"},{"layout":"post","title":"ffmpeg example 3.éŸ³é¢‘ç¼–ç ","date":"2022-03-11T16:00:00.000Z","_content":"\nå…³äºå¦‚ä½•æºç è°ƒè¯•ï¼Œå‚è€ƒå‰é¢çš„æ–‡ç« [ffmpeg example è§†é¢‘ç¼–ç  - æ˜é‡‘](https://juejin.cn/post/7073796134912655367)\n\nä»Šå¤©åˆ†æ`encode_audio.c`å­¦ä¹ ffmpegå¦‚ä½•ç¼–ç éŸ³é¢‘æ•°æ®ï¼Œç”±äºå¤ªç®€å•äº†ï¼Œç›´æ¥è´´ä»£ç \n\n##mainå‡½æ•°\n\n```c\nint main(int argc, char **argv)\n{\n    const char *filename;\n    const AVCodec *codec;\n    AVCodecContext *c= NULL;\n    AVFrame *frame;\n    AVPacket *pkt;\n    int i, j, k, ret;\n    FILE *f;\n    uint16_t *samples;\n    float t, tincr;\n\n    if (argc <= 1) {\n        fprintf(stderr, \"Usage: %s <output file>\\n\", argv[0]);\n        return 0;\n    }\n    filename = argv[1];\n\n    /* æ ¹æ®codec_id æ‰¾åˆ°å¯¹åº”çš„éŸ³é¢‘ç¼–ç å™¨ */\n    codec = avcodec_find_encoder(AV_CODEC_ID_MP2);\n    if (!codec) {\n        fprintf(stderr, \"Codec not found\\n\");\n        exit(1);\n    }\n    /* åˆ›å»ºç¼–ç å™¨AVCodecContextä¸Šä¸‹æ–‡ */\n    c = avcodec_alloc_context3(codec);\n    if (!c) {\n        fprintf(stderr, \"Could not allocate audio codec context\\n\");\n        exit(1);\n    }\n\n    /* è®¾ç½®ç ç‡ */\n    c->bit_rate = 64000;\n\n    /* é‡‡æ ·æ ¼å¼ */\n    c->sample_fmt = AV_SAMPLE_FMT_S16;\n    /* æ£€æŸ¥ç¼–ç å™¨æ˜¯å¦æ”¯æŒè¯¥é‡‡æ ·æ ¼å¼ */\n    if (!check_sample_fmt(codec, c->sample_fmt)) {\n        fprintf(stderr, \"Encoder does not support sample format %s\",\n                av_get_sample_fmt_name(c->sample_fmt));\n        exit(1);\n    }\n\n    /* select other audio parameters supported by the encoder */\n    /* è®¾ç½®é‡‡æ ·ç‡ */\n    c->sample_rate    = select_sample_rate(codec);\n    /* å£°é“å¸ƒå±€ */\n    c->channel_layout = select_channel_layout(codec);\n    /* å£°é“æ•°é‡ */\n    c->channels       = av_get_channel_layout_nb_channels(c->channel_layout);\n\n    /* æ‰“å¼€ç¼–ç å™¨ */\n    if (avcodec_open2(c, codec, NULL) < 0) {\n        fprintf(stderr, \"Could not open codec\\n\");\n        exit(1);\n    }\n    /* æ‰“å¼€å†™æ–‡ä»¶ */\n    f = fopen(filename, \"wb\");\n    if (!f) {\n        fprintf(stderr, \"Could not open %s\\n\", filename);\n        exit(1);\n    }\n\n    /* åˆ›å»ºpktï¼Œä¿å­˜ç¼–ç åçš„æ•°æ® */\n    pkt = av_packet_alloc();\n    if (!pkt) {\n        fprintf(stderr, \"could not allocate the packet\\n\");\n        exit(1);\n    }\n\n    /* åˆ›å»ºframeï¼Œ ä¿å­˜ç¼–ç å‰çš„æ•°æ® */\n    frame = av_frame_alloc();\n    if (!frame) {\n        fprintf(stderr, \"Could not allocate audio frame\\n\");\n        exit(1);\n    }\n    /* ç»™frame è®¾ç½®å‚æ•° */\n    // æ¯ä¸ªå£°é“æœ‰å¤šå°‘ä¸ªé‡‡æ ·\n    frame->nb_samples     = c->frame_size;\n    // é‡‡æ ·çš„æ ¼å¼\n    frame->format         = c->sample_fmt;\n    // å£°é“å¸ƒå±€\n    frame->channel_layout = c->channel_layout;\n\n    /* ç»™ frame å†…éƒ¨åˆ†é…å†…å­˜ */\n    ret = av_frame_get_buffer(frame, 0);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not allocate audio data buffers\\n\");\n        exit(1);\n    }\n\n    /* ç»™frameå¡«å……æ•°æ®ï¼Œç¼–ç ï¼Œå†™å…¥æ–‡ä»¶ */\n    t = 0;\n    tincr = 2 * M_PI * 440.0 / c->sample_rate;\n    for (i = 0; i < 200; i++) {\n        /* make sure the frame is writable -- makes a copy if the encoder\n         * kept a reference internally */\n\n        /*ç¡®å®šframeæ˜¯å¯å†™çš„ï¼Œå¦‚æœframeè¢«ç¼–ç å™¨å†…éƒ¨å¼•ç”¨ï¼Œä¼šå˜æˆä¸å¯å†™ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ï¼Œç»™frameå†…éƒ¨çš„bufæŒ‡å‘æ–°åˆ†é…çš„ç©ºé—´ï¼Œä½¿å…¶å˜ä¸ºå¯å†™ã€‚ */\n        ret = av_frame_make_writable(frame);\n        if (ret < 0)\n            exit(1);\n        //è·å¾—å†™å…¥çš„æŒ‡é’ˆï¼Œç”±äºè®¾ç½®çš„æ˜¯AV_SAMPLE_FMT_S16ï¼Œéå¹³é¢ç±»å‹ï¼Œdata[0]ä¿å­˜äº†å†™å…¥åœ°å€ã€‚\n        samples = (uint16_t*)frame->data[0];\n\n        for (j = 0; j < c->frame_size; j++) {\n            samples[2*j] = (int)(sin(t) * 10000);\n            //å¤šä¸ªå£°é“ï¼Œäº¤é”™å†™æ•°æ®\n            for (k = 1; k < c->channels; k++)\n                samples[2*j + k] = samples[2*j];\n            t += tincr;\n        }\n        //ç¼–ç ï¼Œå†™æ–‡ä»¶\n        encode(c, frame, pkt, f);\n    }\n\n    /* å†²æ´—ç¼–ç å™¨ï¼Œè¯»å‡ºå‰©ä½™æ•°æ®ï¼Œå†™å…¥æ–‡ä»¶ */\n    encode(c, NULL, pkt, f);\n\n    //å…³é—­æ–‡ä»¶\n    fclose(f);\n    //é‡Šæ”¾èµ„æº\n    av_frame_free(&frame);\n    av_packet_free(&pkt);\n    avcodec_free_context(&c);\n\n    return 0;\n}\n```\n\n## éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°\n\n```c\n/* check that a given sample format is supported by the encoder */\nstatic int check_sample_fmt(const AVCodec *codec, enum AVSampleFormat sample_fmt)\n{\n    //sample_fmts: array of supported sample formats, or NULL if unknown, array is terminated by -1\n    //æ”¯æŒçš„é‡‡æ ·æ ¼å¼æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥-1ç»“å°¾\n    const enum AVSampleFormat *p = codec->sample_fmts;\n    //åˆ¤æ–­è®¾ç½®çš„é‡‡æ ·æ ¼å¼æ˜¯å¦æ”¯æŒï¼Œ1 æ”¯æŒ 0 ä¸æ”¯æŒ\n    while (*p != AV_SAMPLE_FMT_NONE) {\n        if (*p == sample_fmt)\n            return 1;\n        p++;\n    }\n    return 0;\n}\n\n/* just pick the highest supported samplerate */\nstatic int select_sample_rate(const AVCodec *codec)\n{\n    const int *p;\n    int best_samplerate = 0;\n    //supported_samplerates: array of supported audio samplerates, or NULL if unknown, array is terminated by 0\n    //supported_samplerates ä¿å­˜äº†æ”¯æŒçš„é‡‡æ ·ç‡çš„æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥ 0 ç»“å°¾\n    if (!codec->supported_samplerates)\n        //ä¸ºç©ºï¼Œè¿”å›44100\n        return 44100;\n\n    p = codec->supported_samplerates;\n    //æ‰¾åˆ°æ”¯æŒçš„é‡‡æ ·ç‡çš„æœ€å¤§å€¼\n    while (*p) {\n        if (!best_samplerate || abs(44100 - *p) < abs(44100 - best_samplerate))\n            best_samplerate = *p;\n        p++;\n    }\n    return best_samplerate;\n}\n\n/* select layout with the highest channel count */\nstatic int select_channel_layout(const AVCodec *codec)\n{\n    const uint64_t *p;\n    uint64_t best_ch_layout = 0;\n    int best_nb_channels   = 0;\n    //channel_layouts: array of support channel layouts, or NULL if unknown. array is terminated by 0\n    //channel_layouts ä¿å­˜äº†æ”¯æŒçš„æ‰€æœ‰å£°é“å¸ƒå±€æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥ 0 ç»“å°¾\n    if (!codec->channel_layouts)\n        //ä¸ºç©ºï¼Œè¿”å›AV_CH_LAYOUT_STEREO\n        return AV_CH_LAYOUT_STEREO;\n\n    //æ‰¾å£°é“æ•°æœ€å¤šçš„é‚£ä¸ª\n    p = codec->channel_layouts;\n    while (*p) {\n        int nb_channels = av_get_channel_layout_nb_channels(*p);\n\n        if (nb_channels > best_nb_channels) {\n            best_ch_layout    = *p;\n            best_nb_channels = nb_channels;\n        }\n        p++;\n    }\n    return best_ch_layout;\n}\n```\n\n## encode\n\n```c\nstatic void encode(AVCodecContext *ctx, AVFrame *frame, AVPacket *pkt,\n                   FILE *output)\n{\n    int ret;\n\n    /* ç»™ç¼–ç å™¨å‘é€frame */\n    ret = avcodec_send_frame(ctx, frame);\n    if (ret < 0) {\n        fprintf(stderr, \"Error sending the frame to the encoder\\n\");\n        exit(1);\n    }\n\n    /* read all the available output packets (in general there may be any\n     * number of them */\n    while (ret >= 0) {\n        //ä»ç¼–ç å™¨ä¸­è¯»pktï¼Œpkté‡Œé¢ä¿å­˜äº†ç¼–ç åçš„æ•°æ®\n        ret = avcodec_receive_packet(ctx, pkt);\n        if (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)\n            //EAGAINç¼–ç å™¨è¿˜éœ€è¦æ›´å¤šçš„frameæ‰èƒ½ç»§ç»­è¾“å‡ºpkt\n            //AVERROR_EOFç¼–ç å™¨æ²¡æœ‰æ›´å¤šæ•°æ®å¯ä»¥è¯»å–äº†ï¼Œä¾‹å¦‚è¢«å†²æ´—äº†\n            return;\n        else if (ret < 0) {\n            fprintf(stderr, \"Error encoding audio frame\\n\");\n            exit(1);\n        }\n        //å†™å…¥æ–‡ä»¶\n        fwrite(pkt->data, 1, pkt->size, output);\n        //å–æ¶ˆå¼•ç”¨pkt\n        av_packet_unref(pkt);\n    }\n}\n```\n\n## å¤‡æ³¨\n\n### ffmpeg æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨\n\n```\nffmpeg -codecs | grep encoder | grep -i audio\n DEAIL. aac                  AAC (Advanced Audio Coding) (decoders: aac aac_fixed aac_at ) (encoders: aac aac_at )\n DEAI.S alac                 ALAC (Apple Lossless Audio Codec) (decoders: alac alac_at ) (encoders: alac alac_at )\n DEAIL. mp2                  MP2 (MPEG audio layer 2) (decoders: mp2 mp2float mp2_at ) (encoders: mp2 mp2fixed )\n DEAIL. mp3                  MP3 (MPEG audio layer 3) (decoders: mp3float mp3 mp3_at ) (encoders: libmp3lame )\n DEAIL. opus                 Opus (Opus Interactive Audio Codec) (decoders: opus libopus ) (encoders: opus libopus )\n DEAIL. ra_144               RealAudio 1.0 (14.4K) (decoders: real_144 ) (encoders: real_144 )\n```\n\nç¤ºä¾‹ä¸­é€‰æ‹©çš„æ˜¯AV_CODEC_ID_MP2\n\né€šè¿‡avcodec_find_encoder(AV_CODEC_ID_MP2)æ¥æ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨\n\nä½ ä¹Ÿå¯ä»¥å°è¯•mp3ï¼Œaac ï¼Œopus ä¹‹ç±»çš„ã€‚\n\n### é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹\n\n```\nenum AVSampleFormat {\n    AV_SAMPLE_FMT_NONE = -1,\n    AV_SAMPLE_FMT_U8,          ///< unsigned 8 bits\n    AV_SAMPLE_FMT_S16,         ///< signed 16 bits\n    AV_SAMPLE_FMT_S32,         ///< signed 32 bits\n    AV_SAMPLE_FMT_FLT,         ///< float\n    AV_SAMPLE_FMT_DBL,         ///< double\n\n    AV_SAMPLE_FMT_U8P,         ///< unsigned 8 bits, planar\n    AV_SAMPLE_FMT_S16P,        ///< signed 16 bits, planar\n    AV_SAMPLE_FMT_S32P,        ///< signed 32 bits, planar\n    AV_SAMPLE_FMT_FLTP,        ///< float, planar\n    AV_SAMPLE_FMT_DBLP,        ///< double, planar\n    AV_SAMPLE_FMT_S64,         ///< signed 64 bits\n    AV_SAMPLE_FMT_S64P,        ///< signed 64 bits, planar\n\n    AV_SAMPLE_FMT_NB           ///< Number of sample formats. DO NOT USE if linking dynamically\n};\n```\n\nåç¼€å¸¦Pçš„å°±æ˜¯å¹³é¢å‹çš„ï¼Œä¸å¸¦Pçš„å°±æ˜¯äº¤é”™å‹çš„ã€‚\n\nå‚è€ƒ[éŸ³é¢‘æ ¼å¼è§£æï¼šäº¤é”™æ¨¡å¼ vs Planeæ¨¡å¼_lyy901135çš„åšå®¢-CSDNåšå®¢_planeæ¨¡å¼](https://blog.csdn.net/lyy901135/article/details/103061967)\n\n### æ—¶é—´æˆ³\n\nåœ¨h264è§†é¢‘ç¼–ç çš„æ—¶å€™ï¼Œæœ‰æ‰“æ—¶é—´æˆ³ï¼ŒéŸ³é¢‘ç¼–ç æ²¡æœ‰çœ‹åˆ°æ‰“æ—¶é—´æˆ³çš„ç¯èŠ‚ï¼Œä¹‹åå†æ¢ç©¶ã€‚\n","source":"_posts/ffmpeg/2022-03-12-ffmpeg example å­¦ä¹  3.md","raw":"---\nlayout: post\ntitle: \"ffmpeg example 3.éŸ³é¢‘ç¼–ç \"\ndate: 2022-03-12 \ntag: ffmpeg\n---\n\nå…³äºå¦‚ä½•æºç è°ƒè¯•ï¼Œå‚è€ƒå‰é¢çš„æ–‡ç« [ffmpeg example è§†é¢‘ç¼–ç  - æ˜é‡‘](https://juejin.cn/post/7073796134912655367)\n\nä»Šå¤©åˆ†æ`encode_audio.c`å­¦ä¹ ffmpegå¦‚ä½•ç¼–ç éŸ³é¢‘æ•°æ®ï¼Œç”±äºå¤ªç®€å•äº†ï¼Œç›´æ¥è´´ä»£ç \n\n##mainå‡½æ•°\n\n```c\nint main(int argc, char **argv)\n{\n    const char *filename;\n    const AVCodec *codec;\n    AVCodecContext *c= NULL;\n    AVFrame *frame;\n    AVPacket *pkt;\n    int i, j, k, ret;\n    FILE *f;\n    uint16_t *samples;\n    float t, tincr;\n\n    if (argc <= 1) {\n        fprintf(stderr, \"Usage: %s <output file>\\n\", argv[0]);\n        return 0;\n    }\n    filename = argv[1];\n\n    /* æ ¹æ®codec_id æ‰¾åˆ°å¯¹åº”çš„éŸ³é¢‘ç¼–ç å™¨ */\n    codec = avcodec_find_encoder(AV_CODEC_ID_MP2);\n    if (!codec) {\n        fprintf(stderr, \"Codec not found\\n\");\n        exit(1);\n    }\n    /* åˆ›å»ºç¼–ç å™¨AVCodecContextä¸Šä¸‹æ–‡ */\n    c = avcodec_alloc_context3(codec);\n    if (!c) {\n        fprintf(stderr, \"Could not allocate audio codec context\\n\");\n        exit(1);\n    }\n\n    /* è®¾ç½®ç ç‡ */\n    c->bit_rate = 64000;\n\n    /* é‡‡æ ·æ ¼å¼ */\n    c->sample_fmt = AV_SAMPLE_FMT_S16;\n    /* æ£€æŸ¥ç¼–ç å™¨æ˜¯å¦æ”¯æŒè¯¥é‡‡æ ·æ ¼å¼ */\n    if (!check_sample_fmt(codec, c->sample_fmt)) {\n        fprintf(stderr, \"Encoder does not support sample format %s\",\n                av_get_sample_fmt_name(c->sample_fmt));\n        exit(1);\n    }\n\n    /* select other audio parameters supported by the encoder */\n    /* è®¾ç½®é‡‡æ ·ç‡ */\n    c->sample_rate    = select_sample_rate(codec);\n    /* å£°é“å¸ƒå±€ */\n    c->channel_layout = select_channel_layout(codec);\n    /* å£°é“æ•°é‡ */\n    c->channels       = av_get_channel_layout_nb_channels(c->channel_layout);\n\n    /* æ‰“å¼€ç¼–ç å™¨ */\n    if (avcodec_open2(c, codec, NULL) < 0) {\n        fprintf(stderr, \"Could not open codec\\n\");\n        exit(1);\n    }\n    /* æ‰“å¼€å†™æ–‡ä»¶ */\n    f = fopen(filename, \"wb\");\n    if (!f) {\n        fprintf(stderr, \"Could not open %s\\n\", filename);\n        exit(1);\n    }\n\n    /* åˆ›å»ºpktï¼Œä¿å­˜ç¼–ç åçš„æ•°æ® */\n    pkt = av_packet_alloc();\n    if (!pkt) {\n        fprintf(stderr, \"could not allocate the packet\\n\");\n        exit(1);\n    }\n\n    /* åˆ›å»ºframeï¼Œ ä¿å­˜ç¼–ç å‰çš„æ•°æ® */\n    frame = av_frame_alloc();\n    if (!frame) {\n        fprintf(stderr, \"Could not allocate audio frame\\n\");\n        exit(1);\n    }\n    /* ç»™frame è®¾ç½®å‚æ•° */\n    // æ¯ä¸ªå£°é“æœ‰å¤šå°‘ä¸ªé‡‡æ ·\n    frame->nb_samples     = c->frame_size;\n    // é‡‡æ ·çš„æ ¼å¼\n    frame->format         = c->sample_fmt;\n    // å£°é“å¸ƒå±€\n    frame->channel_layout = c->channel_layout;\n\n    /* ç»™ frame å†…éƒ¨åˆ†é…å†…å­˜ */\n    ret = av_frame_get_buffer(frame, 0);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not allocate audio data buffers\\n\");\n        exit(1);\n    }\n\n    /* ç»™frameå¡«å……æ•°æ®ï¼Œç¼–ç ï¼Œå†™å…¥æ–‡ä»¶ */\n    t = 0;\n    tincr = 2 * M_PI * 440.0 / c->sample_rate;\n    for (i = 0; i < 200; i++) {\n        /* make sure the frame is writable -- makes a copy if the encoder\n         * kept a reference internally */\n\n        /*ç¡®å®šframeæ˜¯å¯å†™çš„ï¼Œå¦‚æœframeè¢«ç¼–ç å™¨å†…éƒ¨å¼•ç”¨ï¼Œä¼šå˜æˆä¸å¯å†™ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ï¼Œç»™frameå†…éƒ¨çš„bufæŒ‡å‘æ–°åˆ†é…çš„ç©ºé—´ï¼Œä½¿å…¶å˜ä¸ºå¯å†™ã€‚ */\n        ret = av_frame_make_writable(frame);\n        if (ret < 0)\n            exit(1);\n        //è·å¾—å†™å…¥çš„æŒ‡é’ˆï¼Œç”±äºè®¾ç½®çš„æ˜¯AV_SAMPLE_FMT_S16ï¼Œéå¹³é¢ç±»å‹ï¼Œdata[0]ä¿å­˜äº†å†™å…¥åœ°å€ã€‚\n        samples = (uint16_t*)frame->data[0];\n\n        for (j = 0; j < c->frame_size; j++) {\n            samples[2*j] = (int)(sin(t) * 10000);\n            //å¤šä¸ªå£°é“ï¼Œäº¤é”™å†™æ•°æ®\n            for (k = 1; k < c->channels; k++)\n                samples[2*j + k] = samples[2*j];\n            t += tincr;\n        }\n        //ç¼–ç ï¼Œå†™æ–‡ä»¶\n        encode(c, frame, pkt, f);\n    }\n\n    /* å†²æ´—ç¼–ç å™¨ï¼Œè¯»å‡ºå‰©ä½™æ•°æ®ï¼Œå†™å…¥æ–‡ä»¶ */\n    encode(c, NULL, pkt, f);\n\n    //å…³é—­æ–‡ä»¶\n    fclose(f);\n    //é‡Šæ”¾èµ„æº\n    av_frame_free(&frame);\n    av_packet_free(&pkt);\n    avcodec_free_context(&c);\n\n    return 0;\n}\n```\n\n## éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°\n\n```c\n/* check that a given sample format is supported by the encoder */\nstatic int check_sample_fmt(const AVCodec *codec, enum AVSampleFormat sample_fmt)\n{\n    //sample_fmts: array of supported sample formats, or NULL if unknown, array is terminated by -1\n    //æ”¯æŒçš„é‡‡æ ·æ ¼å¼æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥-1ç»“å°¾\n    const enum AVSampleFormat *p = codec->sample_fmts;\n    //åˆ¤æ–­è®¾ç½®çš„é‡‡æ ·æ ¼å¼æ˜¯å¦æ”¯æŒï¼Œ1 æ”¯æŒ 0 ä¸æ”¯æŒ\n    while (*p != AV_SAMPLE_FMT_NONE) {\n        if (*p == sample_fmt)\n            return 1;\n        p++;\n    }\n    return 0;\n}\n\n/* just pick the highest supported samplerate */\nstatic int select_sample_rate(const AVCodec *codec)\n{\n    const int *p;\n    int best_samplerate = 0;\n    //supported_samplerates: array of supported audio samplerates, or NULL if unknown, array is terminated by 0\n    //supported_samplerates ä¿å­˜äº†æ”¯æŒçš„é‡‡æ ·ç‡çš„æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥ 0 ç»“å°¾\n    if (!codec->supported_samplerates)\n        //ä¸ºç©ºï¼Œè¿”å›44100\n        return 44100;\n\n    p = codec->supported_samplerates;\n    //æ‰¾åˆ°æ”¯æŒçš„é‡‡æ ·ç‡çš„æœ€å¤§å€¼\n    while (*p) {\n        if (!best_samplerate || abs(44100 - *p) < abs(44100 - best_samplerate))\n            best_samplerate = *p;\n        p++;\n    }\n    return best_samplerate;\n}\n\n/* select layout with the highest channel count */\nstatic int select_channel_layout(const AVCodec *codec)\n{\n    const uint64_t *p;\n    uint64_t best_ch_layout = 0;\n    int best_nb_channels   = 0;\n    //channel_layouts: array of support channel layouts, or NULL if unknown. array is terminated by 0\n    //channel_layouts ä¿å­˜äº†æ”¯æŒçš„æ‰€æœ‰å£°é“å¸ƒå±€æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥ 0 ç»“å°¾\n    if (!codec->channel_layouts)\n        //ä¸ºç©ºï¼Œè¿”å›AV_CH_LAYOUT_STEREO\n        return AV_CH_LAYOUT_STEREO;\n\n    //æ‰¾å£°é“æ•°æœ€å¤šçš„é‚£ä¸ª\n    p = codec->channel_layouts;\n    while (*p) {\n        int nb_channels = av_get_channel_layout_nb_channels(*p);\n\n        if (nb_channels > best_nb_channels) {\n            best_ch_layout    = *p;\n            best_nb_channels = nb_channels;\n        }\n        p++;\n    }\n    return best_ch_layout;\n}\n```\n\n## encode\n\n```c\nstatic void encode(AVCodecContext *ctx, AVFrame *frame, AVPacket *pkt,\n                   FILE *output)\n{\n    int ret;\n\n    /* ç»™ç¼–ç å™¨å‘é€frame */\n    ret = avcodec_send_frame(ctx, frame);\n    if (ret < 0) {\n        fprintf(stderr, \"Error sending the frame to the encoder\\n\");\n        exit(1);\n    }\n\n    /* read all the available output packets (in general there may be any\n     * number of them */\n    while (ret >= 0) {\n        //ä»ç¼–ç å™¨ä¸­è¯»pktï¼Œpkté‡Œé¢ä¿å­˜äº†ç¼–ç åçš„æ•°æ®\n        ret = avcodec_receive_packet(ctx, pkt);\n        if (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)\n            //EAGAINç¼–ç å™¨è¿˜éœ€è¦æ›´å¤šçš„frameæ‰èƒ½ç»§ç»­è¾“å‡ºpkt\n            //AVERROR_EOFç¼–ç å™¨æ²¡æœ‰æ›´å¤šæ•°æ®å¯ä»¥è¯»å–äº†ï¼Œä¾‹å¦‚è¢«å†²æ´—äº†\n            return;\n        else if (ret < 0) {\n            fprintf(stderr, \"Error encoding audio frame\\n\");\n            exit(1);\n        }\n        //å†™å…¥æ–‡ä»¶\n        fwrite(pkt->data, 1, pkt->size, output);\n        //å–æ¶ˆå¼•ç”¨pkt\n        av_packet_unref(pkt);\n    }\n}\n```\n\n## å¤‡æ³¨\n\n### ffmpeg æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨\n\n```\nffmpeg -codecs | grep encoder | grep -i audio\n DEAIL. aac                  AAC (Advanced Audio Coding) (decoders: aac aac_fixed aac_at ) (encoders: aac aac_at )\n DEAI.S alac                 ALAC (Apple Lossless Audio Codec) (decoders: alac alac_at ) (encoders: alac alac_at )\n DEAIL. mp2                  MP2 (MPEG audio layer 2) (decoders: mp2 mp2float mp2_at ) (encoders: mp2 mp2fixed )\n DEAIL. mp3                  MP3 (MPEG audio layer 3) (decoders: mp3float mp3 mp3_at ) (encoders: libmp3lame )\n DEAIL. opus                 Opus (Opus Interactive Audio Codec) (decoders: opus libopus ) (encoders: opus libopus )\n DEAIL. ra_144               RealAudio 1.0 (14.4K) (decoders: real_144 ) (encoders: real_144 )\n```\n\nç¤ºä¾‹ä¸­é€‰æ‹©çš„æ˜¯AV_CODEC_ID_MP2\n\né€šè¿‡avcodec_find_encoder(AV_CODEC_ID_MP2)æ¥æ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨\n\nä½ ä¹Ÿå¯ä»¥å°è¯•mp3ï¼Œaac ï¼Œopus ä¹‹ç±»çš„ã€‚\n\n### é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹\n\n```\nenum AVSampleFormat {\n    AV_SAMPLE_FMT_NONE = -1,\n    AV_SAMPLE_FMT_U8,          ///< unsigned 8 bits\n    AV_SAMPLE_FMT_S16,         ///< signed 16 bits\n    AV_SAMPLE_FMT_S32,         ///< signed 32 bits\n    AV_SAMPLE_FMT_FLT,         ///< float\n    AV_SAMPLE_FMT_DBL,         ///< double\n\n    AV_SAMPLE_FMT_U8P,         ///< unsigned 8 bits, planar\n    AV_SAMPLE_FMT_S16P,        ///< signed 16 bits, planar\n    AV_SAMPLE_FMT_S32P,        ///< signed 32 bits, planar\n    AV_SAMPLE_FMT_FLTP,        ///< float, planar\n    AV_SAMPLE_FMT_DBLP,        ///< double, planar\n    AV_SAMPLE_FMT_S64,         ///< signed 64 bits\n    AV_SAMPLE_FMT_S64P,        ///< signed 64 bits, planar\n\n    AV_SAMPLE_FMT_NB           ///< Number of sample formats. DO NOT USE if linking dynamically\n};\n```\n\nåç¼€å¸¦Pçš„å°±æ˜¯å¹³é¢å‹çš„ï¼Œä¸å¸¦Pçš„å°±æ˜¯äº¤é”™å‹çš„ã€‚\n\nå‚è€ƒ[éŸ³é¢‘æ ¼å¼è§£æï¼šäº¤é”™æ¨¡å¼ vs Planeæ¨¡å¼_lyy901135çš„åšå®¢-CSDNåšå®¢_planeæ¨¡å¼](https://blog.csdn.net/lyy901135/article/details/103061967)\n\n### æ—¶é—´æˆ³\n\nåœ¨h264è§†é¢‘ç¼–ç çš„æ—¶å€™ï¼Œæœ‰æ‰“æ—¶é—´æˆ³ï¼ŒéŸ³é¢‘ç¼–ç æ²¡æœ‰çœ‹åˆ°æ‰“æ—¶é—´æˆ³çš„ç¯èŠ‚ï¼Œä¹‹åå†æ¢ç©¶ã€‚\n","slug":"ffmpeg/2022-03-12-ffmpeg example å­¦ä¹  3","published":1,"updated":"2024-03-06T11:53:13.565Z","comments":1,"photos":[],"_id":"clti3glkq001v57wh7gux142p","content":"<p>å…³äºå¦‚ä½•æºç è°ƒè¯•ï¼Œå‚è€ƒå‰é¢çš„æ–‡ç« <a href=\"https://juejin.cn/post/7073796134912655367\">ffmpeg example è§†é¢‘ç¼–ç  - æ˜é‡‘</a></p>\n<p>ä»Šå¤©åˆ†æ<code>encode_audio.c</code>å­¦ä¹ ffmpegå¦‚ä½•ç¼–ç éŸ³é¢‘æ•°æ®ï¼Œç”±äºå¤ªç®€å•äº†ï¼Œç›´æ¥è´´ä»£ç </p>\n<p>##mainå‡½æ•°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">main</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">char</span> **argv)</span><br>&#123;<br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> *filename;<br>    <span class=\"hljs-type\">const</span> AVCodec *codec;<br>    AVCodecContext *c= <span class=\"hljs-literal\">NULL</span>;<br>    AVFrame *frame;<br>    AVPacket *pkt;<br>    <span class=\"hljs-type\">int</span> i, j, k, ret;<br>    FILE *f;<br>    <span class=\"hljs-type\">uint16_t</span> *samples;<br>    <span class=\"hljs-type\">float</span> t, tincr;<br><br>    <span class=\"hljs-keyword\">if</span> (argc &lt;= <span class=\"hljs-number\">1</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Usage: %s &lt;output file&gt;\\n&quot;</span>, argv[<span class=\"hljs-number\">0</span>]);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>    &#125;<br>    filename = argv[<span class=\"hljs-number\">1</span>];<br><br>    <span class=\"hljs-comment\">/* æ ¹æ®codec_id æ‰¾åˆ°å¯¹åº”çš„éŸ³é¢‘ç¼–ç å™¨ */</span><br>    codec = avcodec_find_encoder(AV_CODEC_ID_MP2);<br>    <span class=\"hljs-keyword\">if</span> (!codec) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Codec not found\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* åˆ›å»ºç¼–ç å™¨AVCodecContextä¸Šä¸‹æ–‡ */</span><br>    c = avcodec_alloc_context3(codec);<br>    <span class=\"hljs-keyword\">if</span> (!c) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate audio codec context\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* è®¾ç½®ç ç‡ */</span><br>    c-&gt;bit_rate = <span class=\"hljs-number\">64000</span>;<br><br>    <span class=\"hljs-comment\">/* é‡‡æ ·æ ¼å¼ */</span><br>    c-&gt;sample_fmt = AV_SAMPLE_FMT_S16;<br>    <span class=\"hljs-comment\">/* æ£€æŸ¥ç¼–ç å™¨æ˜¯å¦æ”¯æŒè¯¥é‡‡æ ·æ ¼å¼ */</span><br>    <span class=\"hljs-keyword\">if</span> (!check_sample_fmt(codec, c-&gt;sample_fmt)) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Encoder does not support sample format %s&quot;</span>,<br>                av_get_sample_fmt_name(c-&gt;sample_fmt));<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* select other audio parameters supported by the encoder */</span><br>    <span class=\"hljs-comment\">/* è®¾ç½®é‡‡æ ·ç‡ */</span><br>    c-&gt;sample_rate    = select_sample_rate(codec);<br>    <span class=\"hljs-comment\">/* å£°é“å¸ƒå±€ */</span><br>    c-&gt;channel_layout = select_channel_layout(codec);<br>    <span class=\"hljs-comment\">/* å£°é“æ•°é‡ */</span><br>    c-&gt;channels       = av_get_channel_layout_nb_channels(c-&gt;channel_layout);<br><br>    <span class=\"hljs-comment\">/* æ‰“å¼€ç¼–ç å™¨ */</span><br>    <span class=\"hljs-keyword\">if</span> (avcodec_open2(c, codec, <span class=\"hljs-literal\">NULL</span>) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open codec\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* æ‰“å¼€å†™æ–‡ä»¶ */</span><br>    f = fopen(filename, <span class=\"hljs-string\">&quot;wb&quot;</span>);<br>    <span class=\"hljs-keyword\">if</span> (!f) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open %s\\n&quot;</span>, filename);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* åˆ›å»ºpktï¼Œä¿å­˜ç¼–ç åçš„æ•°æ® */</span><br>    pkt = av_packet_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!pkt) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;could not allocate the packet\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* åˆ›å»ºframeï¼Œ ä¿å­˜ç¼–ç å‰çš„æ•°æ® */</span><br>    frame = av_frame_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!frame) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate audio frame\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* ç»™frame è®¾ç½®å‚æ•° */</span><br>    <span class=\"hljs-comment\">// æ¯ä¸ªå£°é“æœ‰å¤šå°‘ä¸ªé‡‡æ ·</span><br>    frame-&gt;nb_samples     = c-&gt;frame_size;<br>    <span class=\"hljs-comment\">// é‡‡æ ·çš„æ ¼å¼</span><br>    frame-&gt;format         = c-&gt;sample_fmt;<br>    <span class=\"hljs-comment\">// å£°é“å¸ƒå±€</span><br>    frame-&gt;channel_layout = c-&gt;channel_layout;<br><br>    <span class=\"hljs-comment\">/* ç»™ frame å†…éƒ¨åˆ†é…å†…å­˜ */</span><br>    ret = av_frame_get_buffer(frame, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate audio data buffers\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* ç»™frameå¡«å……æ•°æ®ï¼Œç¼–ç ï¼Œå†™å…¥æ–‡ä»¶ */</span><br>    t = <span class=\"hljs-number\">0</span>;<br>    tincr = <span class=\"hljs-number\">2</span> * M_PI * <span class=\"hljs-number\">440.0</span> / c-&gt;sample_rate;<br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">200</span>; i++) &#123;<br>        <span class=\"hljs-comment\">/* make sure the frame is writable -- makes a copy if the encoder</span><br><span class=\"hljs-comment\">         * kept a reference internally */</span><br><br>        <span class=\"hljs-comment\">/*ç¡®å®šframeæ˜¯å¯å†™çš„ï¼Œå¦‚æœframeè¢«ç¼–ç å™¨å†…éƒ¨å¼•ç”¨ï¼Œä¼šå˜æˆä¸å¯å†™ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ï¼Œç»™frameå†…éƒ¨çš„bufæŒ‡å‘æ–°åˆ†é…çš„ç©ºé—´ï¼Œä½¿å…¶å˜ä¸ºå¯å†™ã€‚ */</span><br>        ret = av_frame_make_writable(frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-comment\">//è·å¾—å†™å…¥çš„æŒ‡é’ˆï¼Œç”±äºè®¾ç½®çš„æ˜¯AV_SAMPLE_FMT_S16ï¼Œéå¹³é¢ç±»å‹ï¼Œdata[0]ä¿å­˜äº†å†™å…¥åœ°å€ã€‚</span><br>        samples = (<span class=\"hljs-type\">uint16_t</span>*)frame-&gt;data[<span class=\"hljs-number\">0</span>];<br><br>        <span class=\"hljs-keyword\">for</span> (j = <span class=\"hljs-number\">0</span>; j &lt; c-&gt;frame_size; j++) &#123;<br>            samples[<span class=\"hljs-number\">2</span>*j] = (<span class=\"hljs-type\">int</span>)(<span class=\"hljs-built_in\">sin</span>(t) * <span class=\"hljs-number\">10000</span>);<br>            <span class=\"hljs-comment\">//å¤šä¸ªå£°é“ï¼Œäº¤é”™å†™æ•°æ®</span><br>            <span class=\"hljs-keyword\">for</span> (k = <span class=\"hljs-number\">1</span>; k &lt; c-&gt;channels; k++)<br>                samples[<span class=\"hljs-number\">2</span>*j + k] = samples[<span class=\"hljs-number\">2</span>*j];<br>            t += tincr;<br>        &#125;<br>        <span class=\"hljs-comment\">//ç¼–ç ï¼Œå†™æ–‡ä»¶</span><br>        encode(c, frame, pkt, f);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* å†²æ´—ç¼–ç å™¨ï¼Œè¯»å‡ºå‰©ä½™æ•°æ®ï¼Œå†™å…¥æ–‡ä»¶ */</span><br>    encode(c, <span class=\"hljs-literal\">NULL</span>, pkt, f);<br><br>    <span class=\"hljs-comment\">//å…³é—­æ–‡ä»¶</span><br>    fclose(f);<br>    <span class=\"hljs-comment\">//é‡Šæ”¾èµ„æº</span><br>    av_frame_free(&amp;frame);<br>    av_packet_free(&amp;pkt);<br>    avcodec_free_context(&amp;c);<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°\"><a href=\"#éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°\" class=\"headerlink\" title=\"éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°\"></a>éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* check that a given sample format is supported by the encoder */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">check_sample_fmt</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> AVCodec *codec, <span class=\"hljs-keyword\">enum</span> AVSampleFormat sample_fmt)</span><br>&#123;<br>    <span class=\"hljs-comment\">//sample_fmts: array of supported sample formats, or NULL if unknown, array is terminated by -1</span><br>    <span class=\"hljs-comment\">//æ”¯æŒçš„é‡‡æ ·æ ¼å¼æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥-1ç»“å°¾</span><br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title\">AVSampleFormat</span> *<span class=\"hljs-title\">p</span> =</span> codec-&gt;sample_fmts;<br>    <span class=\"hljs-comment\">//åˆ¤æ–­è®¾ç½®çš„é‡‡æ ·æ ¼å¼æ˜¯å¦æ”¯æŒï¼Œ1 æ”¯æŒ 0 ä¸æ”¯æŒ</span><br>    <span class=\"hljs-keyword\">while</span> (*p != AV_SAMPLE_FMT_NONE) &#123;<br>        <span class=\"hljs-keyword\">if</span> (*p == sample_fmt)<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>        p++;<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br><br><span class=\"hljs-comment\">/* just pick the highest supported samplerate */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">select_sample_rate</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> AVCodec *codec)</span><br>&#123;<br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">int</span> *p;<br>    <span class=\"hljs-type\">int</span> best_samplerate = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//supported_samplerates: array of supported audio samplerates, or NULL if unknown, array is terminated by 0</span><br>    <span class=\"hljs-comment\">//supported_samplerates ä¿å­˜äº†æ”¯æŒçš„é‡‡æ ·ç‡çš„æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥ 0 ç»“å°¾</span><br>    <span class=\"hljs-keyword\">if</span> (!codec-&gt;supported_samplerates)<br>        <span class=\"hljs-comment\">//ä¸ºç©ºï¼Œè¿”å›44100</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">44100</span>;<br><br>    p = codec-&gt;supported_samplerates;<br>    <span class=\"hljs-comment\">//æ‰¾åˆ°æ”¯æŒçš„é‡‡æ ·ç‡çš„æœ€å¤§å€¼</span><br>    <span class=\"hljs-keyword\">while</span> (*p) &#123;<br>        <span class=\"hljs-keyword\">if</span> (!best_samplerate || <span class=\"hljs-built_in\">abs</span>(<span class=\"hljs-number\">44100</span> - *p) &lt; <span class=\"hljs-built_in\">abs</span>(<span class=\"hljs-number\">44100</span> - best_samplerate))<br>            best_samplerate = *p;<br>        p++;<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> best_samplerate;<br>&#125;<br><br><span class=\"hljs-comment\">/* select layout with the highest channel count */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">select_channel_layout</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> AVCodec *codec)</span><br>&#123;<br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint64_t</span> *p;<br>    <span class=\"hljs-type\">uint64_t</span> best_ch_layout = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-type\">int</span> best_nb_channels   = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//channel_layouts: array of support channel layouts, or NULL if unknown. array is terminated by 0</span><br>    <span class=\"hljs-comment\">//channel_layouts ä¿å­˜äº†æ”¯æŒçš„æ‰€æœ‰å£°é“å¸ƒå±€æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥ 0 ç»“å°¾</span><br>    <span class=\"hljs-keyword\">if</span> (!codec-&gt;channel_layouts)<br>        <span class=\"hljs-comment\">//ä¸ºç©ºï¼Œè¿”å›AV_CH_LAYOUT_STEREO</span><br>        <span class=\"hljs-keyword\">return</span> AV_CH_LAYOUT_STEREO;<br><br>    <span class=\"hljs-comment\">//æ‰¾å£°é“æ•°æœ€å¤šçš„é‚£ä¸ª</span><br>    p = codec-&gt;channel_layouts;<br>    <span class=\"hljs-keyword\">while</span> (*p) &#123;<br>        <span class=\"hljs-type\">int</span> nb_channels = av_get_channel_layout_nb_channels(*p);<br><br>        <span class=\"hljs-keyword\">if</span> (nb_channels &gt; best_nb_channels) &#123;<br>            best_ch_layout    = *p;<br>            best_nb_channels = nb_channels;<br>        &#125;<br>        p++;<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> best_ch_layout;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"encode\"><a href=\"#encode\" class=\"headerlink\" title=\"encode\"></a>encode</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">encode</span><span class=\"hljs-params\">(AVCodecContext *ctx, AVFrame *frame, AVPacket *pkt,</span><br><span class=\"hljs-params\">                   FILE *output)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret;<br><br>    <span class=\"hljs-comment\">/* ç»™ç¼–ç å™¨å‘é€frame */</span><br>    ret = avcodec_send_frame(ctx, frame);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error sending the frame to the encoder\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* read all the available output packets (in general there may be any</span><br><span class=\"hljs-comment\">     * number of them */</span><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//ä»ç¼–ç å™¨ä¸­è¯»pktï¼Œpkté‡Œé¢ä¿å­˜äº†ç¼–ç åçš„æ•°æ®</span><br>        ret = avcodec_receive_packet(ctx, pkt);<br>        <span class=\"hljs-keyword\">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)<br>            <span class=\"hljs-comment\">//EAGAINç¼–ç å™¨è¿˜éœ€è¦æ›´å¤šçš„frameæ‰èƒ½ç»§ç»­è¾“å‡ºpkt</span><br>            <span class=\"hljs-comment\">//AVERROR_EOFç¼–ç å™¨æ²¡æœ‰æ›´å¤šæ•°æ®å¯ä»¥è¯»å–äº†ï¼Œä¾‹å¦‚è¢«å†²æ´—äº†</span><br>            <span class=\"hljs-keyword\">return</span>;<br>        <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error encoding audio frame\\n&quot;</span>);<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br>        <span class=\"hljs-comment\">//å†™å…¥æ–‡ä»¶</span><br>        fwrite(pkt-&gt;data, <span class=\"hljs-number\">1</span>, pkt-&gt;size, output);<br>        <span class=\"hljs-comment\">//å–æ¶ˆå¼•ç”¨pkt</span><br>        av_packet_unref(pkt);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å¤‡æ³¨\"><a href=\"#å¤‡æ³¨\" class=\"headerlink\" title=\"å¤‡æ³¨\"></a>å¤‡æ³¨</h2><h3 id=\"ffmpeg-æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨\"><a href=\"#ffmpeg-æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨\" class=\"headerlink\" title=\"ffmpeg æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨\"></a>ffmpeg æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨</h3><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs less\"><span class=\"hljs-selector-tag\">ffmpeg</span> <span class=\"hljs-selector-tag\">-codecs</span> | <span class=\"hljs-selector-tag\">grep</span> <span class=\"hljs-selector-tag\">encoder</span> | <span class=\"hljs-selector-tag\">grep</span> <span class=\"hljs-selector-tag\">-i</span> <span class=\"hljs-selector-tag\">audio</span><br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">aac</span>                  <span class=\"hljs-selector-tag\">AAC</span> (Advanced Audio Coding) (<span class=\"hljs-attribute\">decoders</span>: aac aac_fixed aac_at ) (<span class=\"hljs-attribute\">encoders</span>: aac aac_at )<br> <span class=\"hljs-selector-tag\">DEAI</span><span class=\"hljs-selector-class\">.S</span> <span class=\"hljs-selector-tag\">alac</span>                 <span class=\"hljs-selector-tag\">ALAC</span> (Apple Lossless Audio Codec) (<span class=\"hljs-attribute\">decoders</span>: alac alac_at ) (<span class=\"hljs-attribute\">encoders</span>: alac alac_at )<br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">mp2</span>                  <span class=\"hljs-selector-tag\">MP2</span> (MPEG audio layer <span class=\"hljs-number\">2</span>) (<span class=\"hljs-attribute\">decoders</span>: mp2 mp2float mp2_at ) (<span class=\"hljs-attribute\">encoders</span>: mp2 mp2fixed )<br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">mp3</span>                  <span class=\"hljs-selector-tag\">MP3</span> (MPEG audio layer <span class=\"hljs-number\">3</span>) (<span class=\"hljs-attribute\">decoders</span>: mp3float mp3 mp3_at ) (<span class=\"hljs-attribute\">encoders</span>: libmp3lame )<br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">opus</span>                 <span class=\"hljs-selector-tag\">Opus</span> (Opus Interactive Audio Codec) (<span class=\"hljs-attribute\">decoders</span>: opus libopus ) (<span class=\"hljs-attribute\">encoders</span>: opus libopus )<br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">ra_144</span>               <span class=\"hljs-selector-tag\">RealAudio</span> <span class=\"hljs-number\">1.0</span> (<span class=\"hljs-number\">14.4</span>K) (<span class=\"hljs-attribute\">decoders</span>: real_144 ) (<span class=\"hljs-attribute\">encoders</span>: real_144 )<br></code></pre></td></tr></table></figure>\n\n<p>ç¤ºä¾‹ä¸­é€‰æ‹©çš„æ˜¯AV_CODEC_ID_MP2</p>\n<p>é€šè¿‡avcodec_find_encoder(AV_CODEC_ID_MP2)æ¥æ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨</p>\n<p>ä½ ä¹Ÿå¯ä»¥å°è¯•mp3ï¼Œaac ï¼Œopus ä¹‹ç±»çš„ã€‚</p>\n<h3 id=\"é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹\"><a href=\"#é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹\" class=\"headerlink\" title=\"é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹\"></a>é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹</h3><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVSampleFormat</span> &#123;<br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_NONE</span> = <span class=\"hljs-number\">-1</span>,<br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_U8</span>,          <span class=\"hljs-comment\">///&lt; unsigned 8 bits</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S16</span>,         <span class=\"hljs-comment\">///&lt; signed 16 bits</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S32</span>,         <span class=\"hljs-comment\">///&lt; signed 32 bits</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_FLT</span>,         <span class=\"hljs-comment\">///&lt; float</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_DBL</span>,         <span class=\"hljs-comment\">///&lt; double</span><br><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_U8P</span>,         <span class=\"hljs-comment\">///&lt; unsigned 8 bits, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S16P</span>,        <span class=\"hljs-comment\">///&lt; signed 16 bits, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S32P</span>,        <span class=\"hljs-comment\">///&lt; signed 32 bits, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_FLTP</span>,        <span class=\"hljs-comment\">///&lt; float, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_DBLP</span>,        <span class=\"hljs-comment\">///&lt; double, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S64</span>,         <span class=\"hljs-comment\">///&lt; signed 64 bits</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S64P</span>,        <span class=\"hljs-comment\">///&lt; signed 64 bits, planar</span><br><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_NB</span>           <span class=\"hljs-comment\">///&lt; Number of sample formats. DO NOT USE if linking dynamically</span><br>&#125;;<br></code></pre></td></tr></table></figure>\n\n<p>åç¼€å¸¦Pçš„å°±æ˜¯å¹³é¢å‹çš„ï¼Œä¸å¸¦Pçš„å°±æ˜¯äº¤é”™å‹çš„ã€‚</p>\n<p>å‚è€ƒ<a href=\"https://blog.csdn.net/lyy901135/article/details/103061967\">éŸ³é¢‘æ ¼å¼è§£æï¼šäº¤é”™æ¨¡å¼ vs Planeæ¨¡å¼_lyy901135çš„åšå®¢-CSDNåšå®¢_planeæ¨¡å¼</a></p>\n<h3 id=\"æ—¶é—´æˆ³\"><a href=\"#æ—¶é—´æˆ³\" class=\"headerlink\" title=\"æ—¶é—´æˆ³\"></a>æ—¶é—´æˆ³</h3><p>åœ¨h264è§†é¢‘ç¼–ç çš„æ—¶å€™ï¼Œæœ‰æ‰“æ—¶é—´æˆ³ï¼ŒéŸ³é¢‘ç¼–ç æ²¡æœ‰çœ‹åˆ°æ‰“æ—¶é—´æˆ³çš„ç¯èŠ‚ï¼Œä¹‹åå†æ¢ç©¶ã€‚</p>\n","excerpt":"","more":"<p>å…³äºå¦‚ä½•æºç è°ƒè¯•ï¼Œå‚è€ƒå‰é¢çš„æ–‡ç« <a href=\"https://juejin.cn/post/7073796134912655367\">ffmpeg example è§†é¢‘ç¼–ç  - æ˜é‡‘</a></p>\n<p>ä»Šå¤©åˆ†æ<code>encode_audio.c</code>å­¦ä¹ ffmpegå¦‚ä½•ç¼–ç éŸ³é¢‘æ•°æ®ï¼Œç”±äºå¤ªç®€å•äº†ï¼Œç›´æ¥è´´ä»£ç </p>\n<p>##mainå‡½æ•°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">main</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">char</span> **argv)</span><br>&#123;<br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> *filename;<br>    <span class=\"hljs-type\">const</span> AVCodec *codec;<br>    AVCodecContext *c= <span class=\"hljs-literal\">NULL</span>;<br>    AVFrame *frame;<br>    AVPacket *pkt;<br>    <span class=\"hljs-type\">int</span> i, j, k, ret;<br>    FILE *f;<br>    <span class=\"hljs-type\">uint16_t</span> *samples;<br>    <span class=\"hljs-type\">float</span> t, tincr;<br><br>    <span class=\"hljs-keyword\">if</span> (argc &lt;= <span class=\"hljs-number\">1</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Usage: %s &lt;output file&gt;\\n&quot;</span>, argv[<span class=\"hljs-number\">0</span>]);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>    &#125;<br>    filename = argv[<span class=\"hljs-number\">1</span>];<br><br>    <span class=\"hljs-comment\">/* æ ¹æ®codec_id æ‰¾åˆ°å¯¹åº”çš„éŸ³é¢‘ç¼–ç å™¨ */</span><br>    codec = avcodec_find_encoder(AV_CODEC_ID_MP2);<br>    <span class=\"hljs-keyword\">if</span> (!codec) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Codec not found\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* åˆ›å»ºç¼–ç å™¨AVCodecContextä¸Šä¸‹æ–‡ */</span><br>    c = avcodec_alloc_context3(codec);<br>    <span class=\"hljs-keyword\">if</span> (!c) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate audio codec context\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* è®¾ç½®ç ç‡ */</span><br>    c-&gt;bit_rate = <span class=\"hljs-number\">64000</span>;<br><br>    <span class=\"hljs-comment\">/* é‡‡æ ·æ ¼å¼ */</span><br>    c-&gt;sample_fmt = AV_SAMPLE_FMT_S16;<br>    <span class=\"hljs-comment\">/* æ£€æŸ¥ç¼–ç å™¨æ˜¯å¦æ”¯æŒè¯¥é‡‡æ ·æ ¼å¼ */</span><br>    <span class=\"hljs-keyword\">if</span> (!check_sample_fmt(codec, c-&gt;sample_fmt)) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Encoder does not support sample format %s&quot;</span>,<br>                av_get_sample_fmt_name(c-&gt;sample_fmt));<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* select other audio parameters supported by the encoder */</span><br>    <span class=\"hljs-comment\">/* è®¾ç½®é‡‡æ ·ç‡ */</span><br>    c-&gt;sample_rate    = select_sample_rate(codec);<br>    <span class=\"hljs-comment\">/* å£°é“å¸ƒå±€ */</span><br>    c-&gt;channel_layout = select_channel_layout(codec);<br>    <span class=\"hljs-comment\">/* å£°é“æ•°é‡ */</span><br>    c-&gt;channels       = av_get_channel_layout_nb_channels(c-&gt;channel_layout);<br><br>    <span class=\"hljs-comment\">/* æ‰“å¼€ç¼–ç å™¨ */</span><br>    <span class=\"hljs-keyword\">if</span> (avcodec_open2(c, codec, <span class=\"hljs-literal\">NULL</span>) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open codec\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* æ‰“å¼€å†™æ–‡ä»¶ */</span><br>    f = fopen(filename, <span class=\"hljs-string\">&quot;wb&quot;</span>);<br>    <span class=\"hljs-keyword\">if</span> (!f) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open %s\\n&quot;</span>, filename);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* åˆ›å»ºpktï¼Œä¿å­˜ç¼–ç åçš„æ•°æ® */</span><br>    pkt = av_packet_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!pkt) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;could not allocate the packet\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* åˆ›å»ºframeï¼Œ ä¿å­˜ç¼–ç å‰çš„æ•°æ® */</span><br>    frame = av_frame_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!frame) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate audio frame\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/* ç»™frame è®¾ç½®å‚æ•° */</span><br>    <span class=\"hljs-comment\">// æ¯ä¸ªå£°é“æœ‰å¤šå°‘ä¸ªé‡‡æ ·</span><br>    frame-&gt;nb_samples     = c-&gt;frame_size;<br>    <span class=\"hljs-comment\">// é‡‡æ ·çš„æ ¼å¼</span><br>    frame-&gt;format         = c-&gt;sample_fmt;<br>    <span class=\"hljs-comment\">// å£°é“å¸ƒå±€</span><br>    frame-&gt;channel_layout = c-&gt;channel_layout;<br><br>    <span class=\"hljs-comment\">/* ç»™ frame å†…éƒ¨åˆ†é…å†…å­˜ */</span><br>    ret = av_frame_get_buffer(frame, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate audio data buffers\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* ç»™frameå¡«å……æ•°æ®ï¼Œç¼–ç ï¼Œå†™å…¥æ–‡ä»¶ */</span><br>    t = <span class=\"hljs-number\">0</span>;<br>    tincr = <span class=\"hljs-number\">2</span> * M_PI * <span class=\"hljs-number\">440.0</span> / c-&gt;sample_rate;<br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">200</span>; i++) &#123;<br>        <span class=\"hljs-comment\">/* make sure the frame is writable -- makes a copy if the encoder</span><br><span class=\"hljs-comment\">         * kept a reference internally */</span><br><br>        <span class=\"hljs-comment\">/*ç¡®å®šframeæ˜¯å¯å†™çš„ï¼Œå¦‚æœframeè¢«ç¼–ç å™¨å†…éƒ¨å¼•ç”¨ï¼Œä¼šå˜æˆä¸å¯å†™ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ï¼Œç»™frameå†…éƒ¨çš„bufæŒ‡å‘æ–°åˆ†é…çš„ç©ºé—´ï¼Œä½¿å…¶å˜ä¸ºå¯å†™ã€‚ */</span><br>        ret = av_frame_make_writable(frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-comment\">//è·å¾—å†™å…¥çš„æŒ‡é’ˆï¼Œç”±äºè®¾ç½®çš„æ˜¯AV_SAMPLE_FMT_S16ï¼Œéå¹³é¢ç±»å‹ï¼Œdata[0]ä¿å­˜äº†å†™å…¥åœ°å€ã€‚</span><br>        samples = (<span class=\"hljs-type\">uint16_t</span>*)frame-&gt;data[<span class=\"hljs-number\">0</span>];<br><br>        <span class=\"hljs-keyword\">for</span> (j = <span class=\"hljs-number\">0</span>; j &lt; c-&gt;frame_size; j++) &#123;<br>            samples[<span class=\"hljs-number\">2</span>*j] = (<span class=\"hljs-type\">int</span>)(<span class=\"hljs-built_in\">sin</span>(t) * <span class=\"hljs-number\">10000</span>);<br>            <span class=\"hljs-comment\">//å¤šä¸ªå£°é“ï¼Œäº¤é”™å†™æ•°æ®</span><br>            <span class=\"hljs-keyword\">for</span> (k = <span class=\"hljs-number\">1</span>; k &lt; c-&gt;channels; k++)<br>                samples[<span class=\"hljs-number\">2</span>*j + k] = samples[<span class=\"hljs-number\">2</span>*j];<br>            t += tincr;<br>        &#125;<br>        <span class=\"hljs-comment\">//ç¼–ç ï¼Œå†™æ–‡ä»¶</span><br>        encode(c, frame, pkt, f);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* å†²æ´—ç¼–ç å™¨ï¼Œè¯»å‡ºå‰©ä½™æ•°æ®ï¼Œå†™å…¥æ–‡ä»¶ */</span><br>    encode(c, <span class=\"hljs-literal\">NULL</span>, pkt, f);<br><br>    <span class=\"hljs-comment\">//å…³é—­æ–‡ä»¶</span><br>    fclose(f);<br>    <span class=\"hljs-comment\">//é‡Šæ”¾èµ„æº</span><br>    av_frame_free(&amp;frame);<br>    av_packet_free(&amp;pkt);<br>    avcodec_free_context(&amp;c);<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°\"><a href=\"#éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°\" class=\"headerlink\" title=\"éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°\"></a>éªŒè¯é‡‡æ ·æ ¼å¼ï¼Œæ‰¾æœ€å¤§é‡‡æ ·ç‡ï¼Œå£°é“æ•°</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* check that a given sample format is supported by the encoder */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">check_sample_fmt</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> AVCodec *codec, <span class=\"hljs-keyword\">enum</span> AVSampleFormat sample_fmt)</span><br>&#123;<br>    <span class=\"hljs-comment\">//sample_fmts: array of supported sample formats, or NULL if unknown, array is terminated by -1</span><br>    <span class=\"hljs-comment\">//æ”¯æŒçš„é‡‡æ ·æ ¼å¼æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥-1ç»“å°¾</span><br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title\">AVSampleFormat</span> *<span class=\"hljs-title\">p</span> =</span> codec-&gt;sample_fmts;<br>    <span class=\"hljs-comment\">//åˆ¤æ–­è®¾ç½®çš„é‡‡æ ·æ ¼å¼æ˜¯å¦æ”¯æŒï¼Œ1 æ”¯æŒ 0 ä¸æ”¯æŒ</span><br>    <span class=\"hljs-keyword\">while</span> (*p != AV_SAMPLE_FMT_NONE) &#123;<br>        <span class=\"hljs-keyword\">if</span> (*p == sample_fmt)<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>        p++;<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br><br><span class=\"hljs-comment\">/* just pick the highest supported samplerate */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">select_sample_rate</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> AVCodec *codec)</span><br>&#123;<br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">int</span> *p;<br>    <span class=\"hljs-type\">int</span> best_samplerate = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//supported_samplerates: array of supported audio samplerates, or NULL if unknown, array is terminated by 0</span><br>    <span class=\"hljs-comment\">//supported_samplerates ä¿å­˜äº†æ”¯æŒçš„é‡‡æ ·ç‡çš„æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥ 0 ç»“å°¾</span><br>    <span class=\"hljs-keyword\">if</span> (!codec-&gt;supported_samplerates)<br>        <span class=\"hljs-comment\">//ä¸ºç©ºï¼Œè¿”å›44100</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">44100</span>;<br><br>    p = codec-&gt;supported_samplerates;<br>    <span class=\"hljs-comment\">//æ‰¾åˆ°æ”¯æŒçš„é‡‡æ ·ç‡çš„æœ€å¤§å€¼</span><br>    <span class=\"hljs-keyword\">while</span> (*p) &#123;<br>        <span class=\"hljs-keyword\">if</span> (!best_samplerate || <span class=\"hljs-built_in\">abs</span>(<span class=\"hljs-number\">44100</span> - *p) &lt; <span class=\"hljs-built_in\">abs</span>(<span class=\"hljs-number\">44100</span> - best_samplerate))<br>            best_samplerate = *p;<br>        p++;<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> best_samplerate;<br>&#125;<br><br><span class=\"hljs-comment\">/* select layout with the highest channel count */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">select_channel_layout</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> AVCodec *codec)</span><br>&#123;<br>    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint64_t</span> *p;<br>    <span class=\"hljs-type\">uint64_t</span> best_ch_layout = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-type\">int</span> best_nb_channels   = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//channel_layouts: array of support channel layouts, or NULL if unknown. array is terminated by 0</span><br>    <span class=\"hljs-comment\">//channel_layouts ä¿å­˜äº†æ”¯æŒçš„æ‰€æœ‰å£°é“å¸ƒå±€æ•°ç»„ï¼Œä¸ºç©ºï¼Œæˆ–è€…ä»¥ 0 ç»“å°¾</span><br>    <span class=\"hljs-keyword\">if</span> (!codec-&gt;channel_layouts)<br>        <span class=\"hljs-comment\">//ä¸ºç©ºï¼Œè¿”å›AV_CH_LAYOUT_STEREO</span><br>        <span class=\"hljs-keyword\">return</span> AV_CH_LAYOUT_STEREO;<br><br>    <span class=\"hljs-comment\">//æ‰¾å£°é“æ•°æœ€å¤šçš„é‚£ä¸ª</span><br>    p = codec-&gt;channel_layouts;<br>    <span class=\"hljs-keyword\">while</span> (*p) &#123;<br>        <span class=\"hljs-type\">int</span> nb_channels = av_get_channel_layout_nb_channels(*p);<br><br>        <span class=\"hljs-keyword\">if</span> (nb_channels &gt; best_nb_channels) &#123;<br>            best_ch_layout    = *p;<br>            best_nb_channels = nb_channels;<br>        &#125;<br>        p++;<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> best_ch_layout;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"encode\"><a href=\"#encode\" class=\"headerlink\" title=\"encode\"></a>encode</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">encode</span><span class=\"hljs-params\">(AVCodecContext *ctx, AVFrame *frame, AVPacket *pkt,</span><br><span class=\"hljs-params\">                   FILE *output)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret;<br><br>    <span class=\"hljs-comment\">/* ç»™ç¼–ç å™¨å‘é€frame */</span><br>    ret = avcodec_send_frame(ctx, frame);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error sending the frame to the encoder\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* read all the available output packets (in general there may be any</span><br><span class=\"hljs-comment\">     * number of them */</span><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//ä»ç¼–ç å™¨ä¸­è¯»pktï¼Œpkté‡Œé¢ä¿å­˜äº†ç¼–ç åçš„æ•°æ®</span><br>        ret = avcodec_receive_packet(ctx, pkt);<br>        <span class=\"hljs-keyword\">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)<br>            <span class=\"hljs-comment\">//EAGAINç¼–ç å™¨è¿˜éœ€è¦æ›´å¤šçš„frameæ‰èƒ½ç»§ç»­è¾“å‡ºpkt</span><br>            <span class=\"hljs-comment\">//AVERROR_EOFç¼–ç å™¨æ²¡æœ‰æ›´å¤šæ•°æ®å¯ä»¥è¯»å–äº†ï¼Œä¾‹å¦‚è¢«å†²æ´—äº†</span><br>            <span class=\"hljs-keyword\">return</span>;<br>        <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error encoding audio frame\\n&quot;</span>);<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br>        <span class=\"hljs-comment\">//å†™å…¥æ–‡ä»¶</span><br>        fwrite(pkt-&gt;data, <span class=\"hljs-number\">1</span>, pkt-&gt;size, output);<br>        <span class=\"hljs-comment\">//å–æ¶ˆå¼•ç”¨pkt</span><br>        av_packet_unref(pkt);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"å¤‡æ³¨\"><a href=\"#å¤‡æ³¨\" class=\"headerlink\" title=\"å¤‡æ³¨\"></a>å¤‡æ³¨</h2><h3 id=\"ffmpeg-æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨\"><a href=\"#ffmpeg-æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨\" class=\"headerlink\" title=\"ffmpeg æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨\"></a>ffmpeg æ”¯æŒçš„éŸ³é¢‘ç¼–ç å™¨</h3><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs less\"><span class=\"hljs-selector-tag\">ffmpeg</span> <span class=\"hljs-selector-tag\">-codecs</span> | <span class=\"hljs-selector-tag\">grep</span> <span class=\"hljs-selector-tag\">encoder</span> | <span class=\"hljs-selector-tag\">grep</span> <span class=\"hljs-selector-tag\">-i</span> <span class=\"hljs-selector-tag\">audio</span><br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">aac</span>                  <span class=\"hljs-selector-tag\">AAC</span> (Advanced Audio Coding) (<span class=\"hljs-attribute\">decoders</span>: aac aac_fixed aac_at ) (<span class=\"hljs-attribute\">encoders</span>: aac aac_at )<br> <span class=\"hljs-selector-tag\">DEAI</span><span class=\"hljs-selector-class\">.S</span> <span class=\"hljs-selector-tag\">alac</span>                 <span class=\"hljs-selector-tag\">ALAC</span> (Apple Lossless Audio Codec) (<span class=\"hljs-attribute\">decoders</span>: alac alac_at ) (<span class=\"hljs-attribute\">encoders</span>: alac alac_at )<br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">mp2</span>                  <span class=\"hljs-selector-tag\">MP2</span> (MPEG audio layer <span class=\"hljs-number\">2</span>) (<span class=\"hljs-attribute\">decoders</span>: mp2 mp2float mp2_at ) (<span class=\"hljs-attribute\">encoders</span>: mp2 mp2fixed )<br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">mp3</span>                  <span class=\"hljs-selector-tag\">MP3</span> (MPEG audio layer <span class=\"hljs-number\">3</span>) (<span class=\"hljs-attribute\">decoders</span>: mp3float mp3 mp3_at ) (<span class=\"hljs-attribute\">encoders</span>: libmp3lame )<br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">opus</span>                 <span class=\"hljs-selector-tag\">Opus</span> (Opus Interactive Audio Codec) (<span class=\"hljs-attribute\">decoders</span>: opus libopus ) (<span class=\"hljs-attribute\">encoders</span>: opus libopus )<br> <span class=\"hljs-selector-tag\">DEAIL</span>. <span class=\"hljs-selector-tag\">ra_144</span>               <span class=\"hljs-selector-tag\">RealAudio</span> <span class=\"hljs-number\">1.0</span> (<span class=\"hljs-number\">14.4</span>K) (<span class=\"hljs-attribute\">decoders</span>: real_144 ) (<span class=\"hljs-attribute\">encoders</span>: real_144 )<br></code></pre></td></tr></table></figure>\n\n<p>ç¤ºä¾‹ä¸­é€‰æ‹©çš„æ˜¯AV_CODEC_ID_MP2</p>\n<p>é€šè¿‡avcodec_find_encoder(AV_CODEC_ID_MP2)æ¥æ‰¾åˆ°å¯¹åº”çš„ç¼–ç å™¨</p>\n<p>ä½ ä¹Ÿå¯ä»¥å°è¯•mp3ï¼Œaac ï¼Œopus ä¹‹ç±»çš„ã€‚</p>\n<h3 id=\"é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹\"><a href=\"#é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹\" class=\"headerlink\" title=\"é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹\"></a>é‡‡æ ·æ ¼å¼ï¼Œåˆ†å¹³é¢å‹å’Œéå¹³é¢å‹</h3><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVSampleFormat</span> &#123;<br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_NONE</span> = <span class=\"hljs-number\">-1</span>,<br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_U8</span>,          <span class=\"hljs-comment\">///&lt; unsigned 8 bits</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S16</span>,         <span class=\"hljs-comment\">///&lt; signed 16 bits</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S32</span>,         <span class=\"hljs-comment\">///&lt; signed 32 bits</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_FLT</span>,         <span class=\"hljs-comment\">///&lt; float</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_DBL</span>,         <span class=\"hljs-comment\">///&lt; double</span><br><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_U8P</span>,         <span class=\"hljs-comment\">///&lt; unsigned 8 bits, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S16P</span>,        <span class=\"hljs-comment\">///&lt; signed 16 bits, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S32P</span>,        <span class=\"hljs-comment\">///&lt; signed 32 bits, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_FLTP</span>,        <span class=\"hljs-comment\">///&lt; float, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_DBLP</span>,        <span class=\"hljs-comment\">///&lt; double, planar</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S64</span>,         <span class=\"hljs-comment\">///&lt; signed 64 bits</span><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_S64P</span>,        <span class=\"hljs-comment\">///&lt; signed 64 bits, planar</span><br><br>    <span class=\"hljs-built_in\">AV_SAMPLE_FMT_NB</span>           <span class=\"hljs-comment\">///&lt; Number of sample formats. DO NOT USE if linking dynamically</span><br>&#125;;<br></code></pre></td></tr></table></figure>\n\n<p>åç¼€å¸¦Pçš„å°±æ˜¯å¹³é¢å‹çš„ï¼Œä¸å¸¦Pçš„å°±æ˜¯äº¤é”™å‹çš„ã€‚</p>\n<p>å‚è€ƒ<a href=\"https://blog.csdn.net/lyy901135/article/details/103061967\">éŸ³é¢‘æ ¼å¼è§£æï¼šäº¤é”™æ¨¡å¼ vs Planeæ¨¡å¼_lyy901135çš„åšå®¢-CSDNåšå®¢_planeæ¨¡å¼</a></p>\n<h3 id=\"æ—¶é—´æˆ³\"><a href=\"#æ—¶é—´æˆ³\" class=\"headerlink\" title=\"æ—¶é—´æˆ³\"></a>æ—¶é—´æˆ³</h3><p>åœ¨h264è§†é¢‘ç¼–ç çš„æ—¶å€™ï¼Œæœ‰æ‰“æ—¶é—´æˆ³ï¼ŒéŸ³é¢‘ç¼–ç æ²¡æœ‰çœ‹åˆ°æ‰“æ—¶é—´æˆ³çš„ç¯èŠ‚ï¼Œä¹‹åå†æ¢ç©¶ã€‚</p>\n"},{"layout":"post","title":"ffmpeg example 4.è§†é¢‘æ–‡ä»¶å°è£…å’Œç¼–ç ","date":"2022-03-12T16:00:00.000Z","_content":"\nä»Šå¤©å­¦ä¹  `ffmpeg/doc/examples/muxing.c`\n\nè¯¥ç¨‹åºæ¥å—ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚`/tmp/mux.mp4`,`/tmp/mux.mov`ã€‚ æ–‡ä»¶åçš„åç¼€ä¼šç”¨æ¥æ¨æµ‹ç”Ÿæˆçš„AVFormatContextçš„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°±ä½¿ç”¨`mpeg`ã€‚ä½¿ç”¨fmt é»˜è®¤çš„è§†é¢‘ç¼–ç å™¨å’ŒéŸ³é¢‘ç¼–ç å™¨ï¼Œç¼–ç 10ç§’é’Ÿçš„éŸ³è§†é¢‘æ•°æ®ï¼Œäº¤æ›¿å†™å…¥æ–‡ä»¶ã€‚\n\næ“ä½œå°è£…éœ€è¦æ“ä½œ`AVFormatContext`\n\n## åˆ›å»ºAVFormatContext\n\n```c\n    //åˆ›å»ºAVFormatContextï¼Œ æ ¹æ®æ–‡ä»¶åç¼€æ¥æ¨æµ‹output format\n    avformat_alloc_output_context2(&oc, NULL, NULL, filename);\n    if (!oc) {\n        printf(\"Could not deduce output format from file extension: using MPEG.\\n\");\n        //æ— æ³•æ¨æµ‹output formatï¼Œ ä½¿ç”¨mpeg\n        avformat_alloc_output_context2(&oc, NULL, \"mpeg\", filename);\n    }\n```\n\n## ç»™AVFormatContextæ·»åŠ  video / audio stream\n\n```c\n    if (fmt->video_codec != AV_CODEC_ID_NONE) {\n        add_stream(&video_st, oc, &video_codec, fmt->video_codec);\n        have_video = 1;\n        encode_video = 1;\n    }\n    if (fmt->audio_codec != AV_CODEC_ID_NONE) {\n        add_stream(&audio_st, oc, &audio_codec, fmt->audio_codec);\n        have_audio = 1;\n        encode_audio = 1;\n    }\n```\n\næˆ‘ä»¬çœ‹çœ‹add_streamåšäº†ä»€ä¹ˆ\n\n```c\n/* Add an output stream. */\nstatic void add_stream(OutputStream *ost, AVFormatContext *oc,\n                       const AVCodec **codec,\n                       enum AVCodecID codec_id)\n{\n    AVCodecContext *c;\n    int i;\n    /* find the encoder */\n    //æ‰¾åˆ°codec_idå¯¹åº”çš„ç¼–ç å™¨AVCodec\n    *codec = avcodec_find_encoder(codec_id);\n    //åˆ›å»ºpkt\n    ost->tmp_pkt = av_packet_alloc();\n    //åˆ›å»ºAVStream\n    ost->st = avformat_new_stream(oc, NULL);\n    //è®¾ç½®streamçš„index\n    ost->st->id = oc->nb_streams-1;\n    //åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡\n    c = avcodec_alloc_context3(*codec);\n    //ä¿å­˜ç¼–ç å™¨ä¸Šä¸‹æ–‡\n    ost->enc = c;\n\n    switch ((*codec)->type) {\n    case AVMEDIA_TYPE_AUDIO:\n         //è®¾ç½®éŸ³é¢‘ç¼–ç å™¨ä¸Šä¸‹æ–‡å‚æ•°(ç ç‡ï¼Œé‡‡æ ·ç‡ï¼Œä½æ·±ï¼Œå£°é“å¸ƒå±€ç­‰)\nÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ...\n        //è®¾ç½®streamçš„æ—¶é—´åŸº\n        ost->st->time_base = (AVRational){ 1, c->sample_rate };\n        break;\n\n    case AVMEDIA_TYPE_VIDEO:\n        //è®¾ç½®ç¼–ç å™¨ä¸Šä¸‹æ–‡çš„å‚æ•°\n        c->codec_id = codec_id;\n        //è®¾ç½®streamçš„æ—¶é—´åŸº\n        ost->st->time_base = (AVRational){ 1, STREAM_FRAME_RATE };\n        c->time_base       = ost->st->time_base;\nÂ Â Â Â Â Â Â Â //ç¼–ç å™¨ç ç‡ï¼Œå¸§ç‡ï¼Œgopï¼Œåˆ†è¾¨ç‡, è®¾ç½®\nÂ Â Â Â Â Â Â Â ...\n        break;\n\n    default:\n        break;\n    }\n    /* Some formats want stream headers to be separate. */\nÂ Â Â Â //å¤„ç†ä¸€ä¸‹stream header\n    if (oc->oformat->flags & AVFMT_GLOBALHEADER)\n        c->flags |= AV_CODEC_FLAG_GLOBAL_HEADER;\n}\n```\n\n1. æ ¹æ®codec_idæ‰¾åˆ°AVCodec\n\n2. è°ƒç”¨avformat_new_streamåˆ›å»ºstream\n\n3. è®¾ç½®streamçš„index\n\n4. æ ¹æ®AVCodecåˆ›å»ºç¼–ç å™¨çš„ä¸Šä¸‹æ–‡ï¼Œé…ç½®ç¼–ç å™¨å‚æ•°\n\n5. è®¾ç½®streamçš„time_base\n\n6. å¤„ç†ä¸€ä¸‹ stream headers çš„æ ‡å¿—ä½\n\n## éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡\n\n1. ä¸Šé¢åˆ›å»ºå¥½äº†stream, åˆ›å»ºäº†ç¼–ç å™¨ä¸Šä¸‹æ–‡ã€‚open_video/open_audioç»§ç»­ä¸ºå†™å…¥åšå‡†å¤‡\n\n2. å‡†å¤‡å®Œæˆå°±æ‰“å¼€æ–‡ä»¶å‡†å¤‡å†™å…¥\n\n```c\n    /* Now that all the parameters are set, we can open the audio and\n     * video codecs and allocate the necessary encode buffers. */\n    if (have_video)\n        open_video(oc, video_codec, &video_st, opt);\n\n    if (have_audio)\n        open_audio(oc, audio_codec, &audio_st, opt);\n\n    //æ‰“å°ocçš„ä¿¡æ¯\n    av_dump_format(oc, 0, filename, 1);\n\n    /* open the output file, if needed */\n    if (!(fmt->flags & AVFMT_NOFILE)) {\n        //æ‰“å¼€æ–‡ä»¶\n        ret = avio_open(&oc->pb, filename, AVIO_FLAG_WRITE);\n        if (ret < 0) {\n            fprintf(stderr, \"Could not open '%s': %s\\n\", filename,\n                    av_err2str(ret));\n            return 1;\n        }\n    }\n```\n\nçœ‹çœ‹open_video åšäº†ä»€ä¹ˆ\n\n```c\nstatic void open_video(AVFormatContext *oc, const AVCodec *codec,\n                       OutputStream *ost, AVDictionary *opt_arg)\n{\n    int ret;\n    AVCodecContext *c = ost->enc;\n    AVDictionary *opt = NULL;\n    //å°†opt_argä¸­çš„å†…å®¹æ‹·è´åˆ°optä¸­\n    av_dict_copy(&opt, opt_arg, 0);\n    /* open the codec */\n    //æ‰“å¼€ç¼–ç å™¨\n    ret = avcodec_open2(c, codec, &opt);\n    //é‡Šæ”¾opt\n    av_dict_free(&opt);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not open video codec: %s\\n\", av_err2str(ret));\n        exit(1);\n    }\n\n    /* allocate and init a re-usable frame */\n    //æ ¹æ®æ ¼å¼ï¼Œå®½é«˜ï¼Œåˆ›å»ºä¸€ä¸ªå¤ç”¨çš„AVFrame\n    ost->frame = alloc_picture(c->pix_fmt, c->width, c->height);\n    if (!ost->frame) {\n        fprintf(stderr, \"Could not allocate video frame\\n\");\n        exit(1);\n    }\n\n    /* If the output format is not YUV420P, then a temporary YUV420P\n     * picture is needed too. It is then converted to the required\n     * output format. */\n    ost->tmp_frame = NULL;\n    if (c->pix_fmt != AV_PIX_FMT_YUV420P) {\n        //å¦‚æœç¼–ç å™¨å¯¹åº”çš„pix_fmtä¸æ˜¯yuv420pï¼Œ åˆ›å»ºä¸€ä¸ªyuv420pæ ¼å¼çš„AVFrameï¼Œä¿å­˜åœ¨ost->tmp_frameä¸­\n        ost->tmp_frame = alloc_picture(AV_PIX_FMT_YUV420P, c->width, c->height);\n        if (!ost->tmp_frame) {\n            fprintf(stderr, \"Could not allocate temporary picture\\n\");\n            exit(1);\n        }\n    }\n\n    /* copy the stream parameters to the muxer */\n    //å°†ç¼–ç å™¨çš„å‚æ•°æ‹·è´åˆ°streamå¯¹åº”çš„ç¼–ç å‚æ•°ä¸­\n    ret = avcodec_parameters_from_context(ost->st->codecpar, c);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not copy the stream parameters\\n\");\n        exit(1);\n    }\n}\n```\n\n1. æ‰“å¼€ç¼–ç å™¨\n\n2. ç”³è¯·èµ„æºï¼Œåˆ›å»ºä¸€ä¸ªAVFrameç”¨äºå­˜å‚¨ç¼–ç å‰æ•°æ®\n\n3. è°ƒç”¨avcodec_parameters_from_contextå°†ç¼–ç å™¨çš„ç¼–ç å‚æ•°æ‹·è´åˆ°streamçš„codecparä¸­\n\n## å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶\n\nå†™æ–‡ä»¶å¤´\n\n```c\n    /* Write the stream header, if any. */\n    //å°†æµä¿¡æ¯å†™æ–‡ä»¶å¤´\n    ret = avformat_write_header(oc, &opt);\n    if (ret < 0) {\n        fprintf(stderr, \"Error occurred when opening output file: %s\\n\",\n                av_err2str(ret));\n        return 1;\n    }\n```\n\näº¤æ›¿å†™éŸ³è§†é¢‘å¸§\n\n```c\n    while (encode_video || encode_audio) {\n        /* select the stream to encode */\n        /*\n         äº¤æ›¿å†™å…¥ç¼–ç åçš„éŸ³é¢‘å’Œè§†é¢‘å¸§\n         è§†é¢‘å†™å…¥ç»“æŸæˆ–è€…video_st.next_pts <= audio_st.next_pts, å†™è§†é¢‘\n         å¦åˆ™å†™éŸ³é¢‘\n        */\n        if (encode_video &&\n            (!encode_audio || av_compare_ts(video_st.next_pts, video_st.enc->time_base,\n                                            audio_st.next_pts, audio_st.enc->time_base) <= 0)) {\n            //å†™å…¥ç¼–ç åçš„è§†é¢‘å¸§\n            encode_video = !write_video_frame(oc, &video_st);\n        } else {\n            //å†™å…¥ç¼–ç åçš„éŸ³é¢‘å¸§\n            encode_audio = !write_audio_frame(oc, &audio_st);\n        }\n    }\n```\n\n å†™trailer\n\n```c\n    /* Write the trailer, if any. The trailer must be written before you\n     * close the CodecContexts open when you wrote the header; otherwise\n     * av_write_trailer() may try to use memory that was freed on\n     * av_codec_close(). */\n    av_write_trailer(oc);\n```\n\nå…³é—­ç¼–ç å™¨ï¼Œå…³é—­æ–‡ä»¶ï¼Œé‡Šæ”¾èµ„æº\n\n```c\n    /* Close each codec. */\n    if (have_video)\n        close_stream(oc, &video_st);\n    if (have_audio)\n        close_stream(oc, &audio_st);\n\n    if (!(fmt->flags & AVFMT_NOFILE))\n        /* Close the output file. */\n        avio_closep(&oc->pb);\n\n    /* free the stream */\n    avformat_free_context(oc);\n```\n\n### write_video_frame\n\n```\nstatic int write_video_frame(AVFormatContext *oc, OutputStream *ost)\n{\n    return write_frame(oc, ost->enc, ost->st, get_video_frame(ost), ost->tmp_pkt);\n}\n```\n\nåªæ˜¯ç®€å•è°ƒç”¨äº†write_frame\n\n```c\nstatic int write_frame(AVFormatContext *fmt_ctx, AVCodecContext *c,\n                       AVStream *st, AVFrame *frame, AVPacket *pkt)\n{\n    int ret;\n\n    // send the frame to the encoder\n    //å°†frameé€ç»™ç¼–ç å™¨å»ç¼–ç \n    ret = avcodec_send_frame(c, frame);\n    if (ret < 0) {\n        fprintf(stderr, \"Error sending a frame to the encoder: %s\\n\",\n                av_err2str(ret));\n        exit(1);\n    }\n\n    while (ret >= 0) {\n        //ä»ç¼–ç å™¨ä¸­è¯»å‡ºç¼–ç åçš„pkt\n        ret = avcodec_receive_packet(c, pkt);\n        if (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)\n            break;\n        else if (ret < 0) {\n            fprintf(stderr, \"Error encoding a frame: %s\\n\", av_err2str(ret));\n            exit(1);\n        }\n\n        /* rescale output packet timestamp values from codec to stream timebase */\n        //è°ƒæ•´pktçš„ptsï¼Œpktçš„æ—¶é—´åŸºå‚ç¼–ç å™¨çš„æ—¶é—´åŸºï¼Œå°†å…¶è½¬æ¢ä¸ºå‚è€ƒstreamçš„æ—¶é—´åŸº\n        av_packet_rescale_ts(pkt, c->time_base, st->time_base);\n        //è®¾ç½®pktçš„stream_indexå’Œstreamå¯¹åº”çš„ä¸€è‡´ï¼ŒéŸ³è§†é¢‘åˆ†åˆ«å¯¹åº”äºä¸åŒçš„stream_index\n        pkt->stream_index = st->index;\n\n        /* Write the compressed frame to the media file. */\n        log_packet(fmt_ctx, pkt);\n        //å°†pktå†™å…¥è§†é¢‘æ–‡ä»¶\n        ret = av_interleaved_write_frame(fmt_ctx, pkt);\n        /* pkt is now blank (av_interleaved_write_frame() takes ownership of\n         * its contents and resets pkt), so that no unreferencing is necessary.\n         * This would be different if one used av_write_frame(). */\n        if (ret < 0) {\n            fprintf(stderr, \"Error while writing output packet: %s\\n\", av_err2str(ret));\n            exit(1);\n        }\n    }\n\n    return ret == AVERROR_EOF ? 1 : 0;\n}\n```\n\n1. å°†AVFrameé€ç»™ç¼–ç å™¨å»ç¼–ç \n\n2. è¯»å–pkt\n\n3. è°ƒç”¨av_packet_rescale_tsï¼Œè°ƒæ•´pktçš„æ—¶é—´æˆ³ï¼Œå†™å…¥æ–‡ä»¶pktçš„ptsè¦ä»¥streamçš„time_baseä¸ºåŸºå‡†\n\n4. è®¾ç½®pktçš„index\n\n5. è°ƒç”¨av_interleaved_write_frameå°†pktå†™å…¥æ–‡ä»¶\n\n6. è¿”å›å†™å…¥ç»“æœã€‚å½“AVFrameä¸ºç©ºæ—¶ï¼Œä¼šå†²æ´—ç¼–ç å™¨ï¼Œret = AVERROR_EOFï¼Œ è¿”å›1ï¼Œ ç»“æŸå†™å…¥\n\nframeçš„æ¯ä¸€å¸§æ•°æ®ï¼Œæ˜¯æ¥è‡ªäºget_video_frameæ–¹æ³•, å¡«å……çš„å‡æ•°æ®\n\n```c\nstatic AVFrame *get_video_frame(OutputStream *ost)\n{\n    AVCodecContext *c = ost->enc;\n\n    /* check if we want to generate more frames */\n    if (av_compare_ts(ost->next_pts, c->time_base,\n                      STREAM_DURATION, (AVRational){ 1, 1 }) > 0)\n        return NULL;\n\n    /* when we pass a frame to the encoder, it may keep a reference to it\n     * internally; make sure we do not overwrite it here */\n    if (av_frame_make_writable(ost->frame) < 0)\n        exit(1);\n\n    if (c->pix_fmt != AV_PIX_FMT_YUV420P) {\n        /* as we only generate a YUV420P picture, we must convert it\n         * to the codec pixel format if needed */\n        if (!ost->sws_ctx) {\n            ost->sws_ctx = sws_getContext(c->width, c->height,\n                                          AV_PIX_FMT_YUV420P,\n                                          c->width, c->height,\n                                          c->pix_fmt,\n                                          SCALE_FLAGS, NULL, NULL, NULL);\n            if (!ost->sws_ctx) {\n                fprintf(stderr,\n                        \"Could not initialize the conversion context\\n\");\n                exit(1);\n            }\n        }\n        fill_yuv_image(ost->tmp_frame, ost->next_pts, c->width, c->height);\n        sws_scale(ost->sws_ctx, (const uint8_t * const *) ost->tmp_frame->data,\n                  ost->tmp_frame->linesize, 0, c->height, ost->frame->data,\n                  ost->frame->linesize);\n    } else {\n        fill_yuv_image(ost->frame, ost->next_pts, c->width, c->height);\n    }\n\n    ost->frame->pts = ost->next_pts++;\n\n    return ost->frame;\n}\n```\n\n1. è°ƒç”¨av_compare_ts åˆ¤æ–­æ˜¯å¦ç»§ç»­ç”Ÿæˆæ–°çš„frameï¼Œä¸€å¼€å§‹è§„å®šäº†åªå†™10ç§’é’Ÿçš„æ•°æ®ï¼Œè¶…è¿‡äº†å°±ä¸å†™äº†\n\n2. av_frame_make_writableä½¿å½“å‰çš„frameå¯å†™ï¼Œè¢«ç¼–ç å™¨å¼•ç”¨çš„frameä¸å¯å†™ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å¦‚æœè¢«å¼•ç”¨ï¼Œå†…éƒ¨ä¼šåˆ›å»ºæ–°bufï¼Œå˜æˆå¯å†™çš„\n\n3. å¡«å……æ•°æ®yuvï¼Œè¿˜åšäº†ç¼©æ”¾å¤„ç†ï¼Œæš‚ä¸è®¨è®º\n\n4. æ›´æ–°frameçš„pts\n\n5. è¿”å›ç”Ÿæˆçš„frame\n\nwrite_audio_frame\n\n```c\n/*\n * encode one audio frame and send it to the muxer\n * return 1 when encoding is finished, 0 otherwise\n */\nstatic int write_audio_frame(AVFormatContext *oc, OutputStream *ost)\n{\n    AVCodecContext *c;\n    AVFrame *frame;\n    int ret;\n    int dst_nb_samples;\n\n    c = ost->enc;\n\n    //è·å–éŸ³é¢‘å¸§\n    frame = get_audio_frame(ost);   \n\n    if (frame) {\n        /* convert samples from native format to destination codec format, using the resampler */\n        /* compute destination number of samples */\n\n        /*\n        è®¡ç®—æ ¹æ®é‡é‡‡æ ·ååº”è¯¥ç”Ÿæˆçš„é‡‡æ ·ä¸ªæ•°\n        */\n        dst_nb_samples = av_rescale_rnd(swr_get_delay(ost->swr_ctx, c->sample_rate) + frame->nb_samples,\n                                        c->sample_rate, c->sample_rate, AV_ROUND_UP);\n        //ç”±äºæ²¡æœ‰ä¿®æ”¹é‡‡æ ·ç‡ï¼Œåªæ˜¯ä¿®æ”¹äº†ä½æ·±ï¼Œé‡‡æ ·ä¸ªæ•°ä¿æŒä¸å˜\n        av_assert0(dst_nb_samples == frame->nb_samples);\n\n        /* when we pass a frame to the encoder, it may keep a reference to it\n         * internally;\n         * make sure we do not overwrite it here\n         */\n        //ä½¿ost->frameå¯å†™\n        ret = av_frame_make_writable(ost->frame);\n        if (ret < 0)\n            exit(1);\n\n        /* convert to destination format */\n        //é‡é‡‡æ ·\n        ret = swr_convert(ost->swr_ctx,\n                          ost->frame->data, dst_nb_samples,\n                          (const uint8_t **)frame->data, frame->nb_samples);\n        if (ret < 0) {\n            fprintf(stderr, \"Error while converting\\n\");\n            exit(1);\n        }\n\n        frame = ost->frame;\n        //é‡æ–°è®¡ç®—éŸ³é¢‘pts\n        frame->pts = av_rescale_q(ost->samples_count, (AVRational){1, c->sample_rate}, c->time_base);\n        //è®¡ç®—samples_count\n        ost->samples_count += dst_nb_samples;\n    }\n    //å°†éŸ³é¢‘å¸§å†™å…¥æ–‡ä»¶\n    return write_frame(oc, c, ost->st, frame, ost->tmp_pkt);\n}\n```\n\n1. å‡†å¤‡AVFrameï¼Œè°ƒç”¨get_audio_frameè·å–ä¸€ä¸ªAVFrameï¼Œå†…éƒ¨æ ¹æ®ç¼–ç æ ¼å¼ï¼Œå¡«å……pcmå‡æ•°æ®\n\n2. è°ƒç”¨av_rescale_rndè®¡ç®—é‡é‡‡æ ·ä¸ªæ•°ï¼Œå¦‚æœæ•°æ®æºå’Œé€å…¥ç¼–ç å™¨çš„éŸ³é¢‘çš„é‡‡æ ·ç‡ä¸åŒï¼Œéœ€è¦è½¬æ¢é‡‡æ ·ç‡ï¼Œç¤ºä¾‹ç¨‹åºåªæ˜¯å˜äº†é‡‡æ ·æ ¼å¼ï¼Œæ²¡æœ‰æ›´æ”¹é‡‡æ ·ç‡ï¼Œé‡‡æ ·ä¸ªæ•°ä¸å˜\n\n3. åšé‡é‡‡æ ·ï¼Œé‡é‡‡æ ·æ•°æ®ä¿å­˜åœ¨ost->frameä¸­\n\n4. é‡é‡‡æ ·åï¼Œéœ€è¦æ›´æ–°frameçš„pts\n\n5. è°ƒç”¨write_frameç¼–ç ï¼Œå°†æ•°æ®å†™å…¥æ–‡ä»¶\n\n## æ€»ç»“ï¼š\n\nå­¦ä¹ äº†é€šè¿‡åº”ç”¨libavformatå°†éŸ³è§†é¢‘æ•°æ®ç¼–ç å°è£…åˆ°æ–‡ä»¶ä¸­\n\n1. åˆ›å»ºAVFormatContext\n\n2. æ·»åŠ stream\n\n3. é…ç½®ç¼–è§£ç å™¨ï¼Œstream å‚æ•°\n\n4. ç¼–ç frameï¼Œç”Ÿæˆpktï¼Œæ›´æ–°pts\n\n5. äº¤æ›¿å†™éŸ³è§†é¢‘pkt\n\n6. å…³é—­ç¼–è§£ç å™¨ï¼Œç»“æŸå†™æ–‡ä»¶\n\n# \n","source":"_posts/ffmpeg/2022-03-13-ffmpeg example å­¦ä¹  4.md","raw":"---\nlayout: post\ntitle: \"ffmpeg example 4.è§†é¢‘æ–‡ä»¶å°è£…å’Œç¼–ç \"\ndate: 2022-03-13 \ntag: ffmpeg\n---\n\nä»Šå¤©å­¦ä¹  `ffmpeg/doc/examples/muxing.c`\n\nè¯¥ç¨‹åºæ¥å—ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚`/tmp/mux.mp4`,`/tmp/mux.mov`ã€‚ æ–‡ä»¶åçš„åç¼€ä¼šç”¨æ¥æ¨æµ‹ç”Ÿæˆçš„AVFormatContextçš„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°±ä½¿ç”¨`mpeg`ã€‚ä½¿ç”¨fmt é»˜è®¤çš„è§†é¢‘ç¼–ç å™¨å’ŒéŸ³é¢‘ç¼–ç å™¨ï¼Œç¼–ç 10ç§’é’Ÿçš„éŸ³è§†é¢‘æ•°æ®ï¼Œäº¤æ›¿å†™å…¥æ–‡ä»¶ã€‚\n\næ“ä½œå°è£…éœ€è¦æ“ä½œ`AVFormatContext`\n\n## åˆ›å»ºAVFormatContext\n\n```c\n    //åˆ›å»ºAVFormatContextï¼Œ æ ¹æ®æ–‡ä»¶åç¼€æ¥æ¨æµ‹output format\n    avformat_alloc_output_context2(&oc, NULL, NULL, filename);\n    if (!oc) {\n        printf(\"Could not deduce output format from file extension: using MPEG.\\n\");\n        //æ— æ³•æ¨æµ‹output formatï¼Œ ä½¿ç”¨mpeg\n        avformat_alloc_output_context2(&oc, NULL, \"mpeg\", filename);\n    }\n```\n\n## ç»™AVFormatContextæ·»åŠ  video / audio stream\n\n```c\n    if (fmt->video_codec != AV_CODEC_ID_NONE) {\n        add_stream(&video_st, oc, &video_codec, fmt->video_codec);\n        have_video = 1;\n        encode_video = 1;\n    }\n    if (fmt->audio_codec != AV_CODEC_ID_NONE) {\n        add_stream(&audio_st, oc, &audio_codec, fmt->audio_codec);\n        have_audio = 1;\n        encode_audio = 1;\n    }\n```\n\næˆ‘ä»¬çœ‹çœ‹add_streamåšäº†ä»€ä¹ˆ\n\n```c\n/* Add an output stream. */\nstatic void add_stream(OutputStream *ost, AVFormatContext *oc,\n                       const AVCodec **codec,\n                       enum AVCodecID codec_id)\n{\n    AVCodecContext *c;\n    int i;\n    /* find the encoder */\n    //æ‰¾åˆ°codec_idå¯¹åº”çš„ç¼–ç å™¨AVCodec\n    *codec = avcodec_find_encoder(codec_id);\n    //åˆ›å»ºpkt\n    ost->tmp_pkt = av_packet_alloc();\n    //åˆ›å»ºAVStream\n    ost->st = avformat_new_stream(oc, NULL);\n    //è®¾ç½®streamçš„index\n    ost->st->id = oc->nb_streams-1;\n    //åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡\n    c = avcodec_alloc_context3(*codec);\n    //ä¿å­˜ç¼–ç å™¨ä¸Šä¸‹æ–‡\n    ost->enc = c;\n\n    switch ((*codec)->type) {\n    case AVMEDIA_TYPE_AUDIO:\n         //è®¾ç½®éŸ³é¢‘ç¼–ç å™¨ä¸Šä¸‹æ–‡å‚æ•°(ç ç‡ï¼Œé‡‡æ ·ç‡ï¼Œä½æ·±ï¼Œå£°é“å¸ƒå±€ç­‰)\nÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ...\n        //è®¾ç½®streamçš„æ—¶é—´åŸº\n        ost->st->time_base = (AVRational){ 1, c->sample_rate };\n        break;\n\n    case AVMEDIA_TYPE_VIDEO:\n        //è®¾ç½®ç¼–ç å™¨ä¸Šä¸‹æ–‡çš„å‚æ•°\n        c->codec_id = codec_id;\n        //è®¾ç½®streamçš„æ—¶é—´åŸº\n        ost->st->time_base = (AVRational){ 1, STREAM_FRAME_RATE };\n        c->time_base       = ost->st->time_base;\nÂ Â Â Â Â Â Â Â //ç¼–ç å™¨ç ç‡ï¼Œå¸§ç‡ï¼Œgopï¼Œåˆ†è¾¨ç‡, è®¾ç½®\nÂ Â Â Â Â Â Â Â ...\n        break;\n\n    default:\n        break;\n    }\n    /* Some formats want stream headers to be separate. */\nÂ Â Â Â //å¤„ç†ä¸€ä¸‹stream header\n    if (oc->oformat->flags & AVFMT_GLOBALHEADER)\n        c->flags |= AV_CODEC_FLAG_GLOBAL_HEADER;\n}\n```\n\n1. æ ¹æ®codec_idæ‰¾åˆ°AVCodec\n\n2. è°ƒç”¨avformat_new_streamåˆ›å»ºstream\n\n3. è®¾ç½®streamçš„index\n\n4. æ ¹æ®AVCodecåˆ›å»ºç¼–ç å™¨çš„ä¸Šä¸‹æ–‡ï¼Œé…ç½®ç¼–ç å™¨å‚æ•°\n\n5. è®¾ç½®streamçš„time_base\n\n6. å¤„ç†ä¸€ä¸‹ stream headers çš„æ ‡å¿—ä½\n\n## éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡\n\n1. ä¸Šé¢åˆ›å»ºå¥½äº†stream, åˆ›å»ºäº†ç¼–ç å™¨ä¸Šä¸‹æ–‡ã€‚open_video/open_audioç»§ç»­ä¸ºå†™å…¥åšå‡†å¤‡\n\n2. å‡†å¤‡å®Œæˆå°±æ‰“å¼€æ–‡ä»¶å‡†å¤‡å†™å…¥\n\n```c\n    /* Now that all the parameters are set, we can open the audio and\n     * video codecs and allocate the necessary encode buffers. */\n    if (have_video)\n        open_video(oc, video_codec, &video_st, opt);\n\n    if (have_audio)\n        open_audio(oc, audio_codec, &audio_st, opt);\n\n    //æ‰“å°ocçš„ä¿¡æ¯\n    av_dump_format(oc, 0, filename, 1);\n\n    /* open the output file, if needed */\n    if (!(fmt->flags & AVFMT_NOFILE)) {\n        //æ‰“å¼€æ–‡ä»¶\n        ret = avio_open(&oc->pb, filename, AVIO_FLAG_WRITE);\n        if (ret < 0) {\n            fprintf(stderr, \"Could not open '%s': %s\\n\", filename,\n                    av_err2str(ret));\n            return 1;\n        }\n    }\n```\n\nçœ‹çœ‹open_video åšäº†ä»€ä¹ˆ\n\n```c\nstatic void open_video(AVFormatContext *oc, const AVCodec *codec,\n                       OutputStream *ost, AVDictionary *opt_arg)\n{\n    int ret;\n    AVCodecContext *c = ost->enc;\n    AVDictionary *opt = NULL;\n    //å°†opt_argä¸­çš„å†…å®¹æ‹·è´åˆ°optä¸­\n    av_dict_copy(&opt, opt_arg, 0);\n    /* open the codec */\n    //æ‰“å¼€ç¼–ç å™¨\n    ret = avcodec_open2(c, codec, &opt);\n    //é‡Šæ”¾opt\n    av_dict_free(&opt);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not open video codec: %s\\n\", av_err2str(ret));\n        exit(1);\n    }\n\n    /* allocate and init a re-usable frame */\n    //æ ¹æ®æ ¼å¼ï¼Œå®½é«˜ï¼Œåˆ›å»ºä¸€ä¸ªå¤ç”¨çš„AVFrame\n    ost->frame = alloc_picture(c->pix_fmt, c->width, c->height);\n    if (!ost->frame) {\n        fprintf(stderr, \"Could not allocate video frame\\n\");\n        exit(1);\n    }\n\n    /* If the output format is not YUV420P, then a temporary YUV420P\n     * picture is needed too. It is then converted to the required\n     * output format. */\n    ost->tmp_frame = NULL;\n    if (c->pix_fmt != AV_PIX_FMT_YUV420P) {\n        //å¦‚æœç¼–ç å™¨å¯¹åº”çš„pix_fmtä¸æ˜¯yuv420pï¼Œ åˆ›å»ºä¸€ä¸ªyuv420pæ ¼å¼çš„AVFrameï¼Œä¿å­˜åœ¨ost->tmp_frameä¸­\n        ost->tmp_frame = alloc_picture(AV_PIX_FMT_YUV420P, c->width, c->height);\n        if (!ost->tmp_frame) {\n            fprintf(stderr, \"Could not allocate temporary picture\\n\");\n            exit(1);\n        }\n    }\n\n    /* copy the stream parameters to the muxer */\n    //å°†ç¼–ç å™¨çš„å‚æ•°æ‹·è´åˆ°streamå¯¹åº”çš„ç¼–ç å‚æ•°ä¸­\n    ret = avcodec_parameters_from_context(ost->st->codecpar, c);\n    if (ret < 0) {\n        fprintf(stderr, \"Could not copy the stream parameters\\n\");\n        exit(1);\n    }\n}\n```\n\n1. æ‰“å¼€ç¼–ç å™¨\n\n2. ç”³è¯·èµ„æºï¼Œåˆ›å»ºä¸€ä¸ªAVFrameç”¨äºå­˜å‚¨ç¼–ç å‰æ•°æ®\n\n3. è°ƒç”¨avcodec_parameters_from_contextå°†ç¼–ç å™¨çš„ç¼–ç å‚æ•°æ‹·è´åˆ°streamçš„codecparä¸­\n\n## å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶\n\nå†™æ–‡ä»¶å¤´\n\n```c\n    /* Write the stream header, if any. */\n    //å°†æµä¿¡æ¯å†™æ–‡ä»¶å¤´\n    ret = avformat_write_header(oc, &opt);\n    if (ret < 0) {\n        fprintf(stderr, \"Error occurred when opening output file: %s\\n\",\n                av_err2str(ret));\n        return 1;\n    }\n```\n\näº¤æ›¿å†™éŸ³è§†é¢‘å¸§\n\n```c\n    while (encode_video || encode_audio) {\n        /* select the stream to encode */\n        /*\n         äº¤æ›¿å†™å…¥ç¼–ç åçš„éŸ³é¢‘å’Œè§†é¢‘å¸§\n         è§†é¢‘å†™å…¥ç»“æŸæˆ–è€…video_st.next_pts <= audio_st.next_pts, å†™è§†é¢‘\n         å¦åˆ™å†™éŸ³é¢‘\n        */\n        if (encode_video &&\n            (!encode_audio || av_compare_ts(video_st.next_pts, video_st.enc->time_base,\n                                            audio_st.next_pts, audio_st.enc->time_base) <= 0)) {\n            //å†™å…¥ç¼–ç åçš„è§†é¢‘å¸§\n            encode_video = !write_video_frame(oc, &video_st);\n        } else {\n            //å†™å…¥ç¼–ç åçš„éŸ³é¢‘å¸§\n            encode_audio = !write_audio_frame(oc, &audio_st);\n        }\n    }\n```\n\n å†™trailer\n\n```c\n    /* Write the trailer, if any. The trailer must be written before you\n     * close the CodecContexts open when you wrote the header; otherwise\n     * av_write_trailer() may try to use memory that was freed on\n     * av_codec_close(). */\n    av_write_trailer(oc);\n```\n\nå…³é—­ç¼–ç å™¨ï¼Œå…³é—­æ–‡ä»¶ï¼Œé‡Šæ”¾èµ„æº\n\n```c\n    /* Close each codec. */\n    if (have_video)\n        close_stream(oc, &video_st);\n    if (have_audio)\n        close_stream(oc, &audio_st);\n\n    if (!(fmt->flags & AVFMT_NOFILE))\n        /* Close the output file. */\n        avio_closep(&oc->pb);\n\n    /* free the stream */\n    avformat_free_context(oc);\n```\n\n### write_video_frame\n\n```\nstatic int write_video_frame(AVFormatContext *oc, OutputStream *ost)\n{\n    return write_frame(oc, ost->enc, ost->st, get_video_frame(ost), ost->tmp_pkt);\n}\n```\n\nåªæ˜¯ç®€å•è°ƒç”¨äº†write_frame\n\n```c\nstatic int write_frame(AVFormatContext *fmt_ctx, AVCodecContext *c,\n                       AVStream *st, AVFrame *frame, AVPacket *pkt)\n{\n    int ret;\n\n    // send the frame to the encoder\n    //å°†frameé€ç»™ç¼–ç å™¨å»ç¼–ç \n    ret = avcodec_send_frame(c, frame);\n    if (ret < 0) {\n        fprintf(stderr, \"Error sending a frame to the encoder: %s\\n\",\n                av_err2str(ret));\n        exit(1);\n    }\n\n    while (ret >= 0) {\n        //ä»ç¼–ç å™¨ä¸­è¯»å‡ºç¼–ç åçš„pkt\n        ret = avcodec_receive_packet(c, pkt);\n        if (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)\n            break;\n        else if (ret < 0) {\n            fprintf(stderr, \"Error encoding a frame: %s\\n\", av_err2str(ret));\n            exit(1);\n        }\n\n        /* rescale output packet timestamp values from codec to stream timebase */\n        //è°ƒæ•´pktçš„ptsï¼Œpktçš„æ—¶é—´åŸºå‚ç¼–ç å™¨çš„æ—¶é—´åŸºï¼Œå°†å…¶è½¬æ¢ä¸ºå‚è€ƒstreamçš„æ—¶é—´åŸº\n        av_packet_rescale_ts(pkt, c->time_base, st->time_base);\n        //è®¾ç½®pktçš„stream_indexå’Œstreamå¯¹åº”çš„ä¸€è‡´ï¼ŒéŸ³è§†é¢‘åˆ†åˆ«å¯¹åº”äºä¸åŒçš„stream_index\n        pkt->stream_index = st->index;\n\n        /* Write the compressed frame to the media file. */\n        log_packet(fmt_ctx, pkt);\n        //å°†pktå†™å…¥è§†é¢‘æ–‡ä»¶\n        ret = av_interleaved_write_frame(fmt_ctx, pkt);\n        /* pkt is now blank (av_interleaved_write_frame() takes ownership of\n         * its contents and resets pkt), so that no unreferencing is necessary.\n         * This would be different if one used av_write_frame(). */\n        if (ret < 0) {\n            fprintf(stderr, \"Error while writing output packet: %s\\n\", av_err2str(ret));\n            exit(1);\n        }\n    }\n\n    return ret == AVERROR_EOF ? 1 : 0;\n}\n```\n\n1. å°†AVFrameé€ç»™ç¼–ç å™¨å»ç¼–ç \n\n2. è¯»å–pkt\n\n3. è°ƒç”¨av_packet_rescale_tsï¼Œè°ƒæ•´pktçš„æ—¶é—´æˆ³ï¼Œå†™å…¥æ–‡ä»¶pktçš„ptsè¦ä»¥streamçš„time_baseä¸ºåŸºå‡†\n\n4. è®¾ç½®pktçš„index\n\n5. è°ƒç”¨av_interleaved_write_frameå°†pktå†™å…¥æ–‡ä»¶\n\n6. è¿”å›å†™å…¥ç»“æœã€‚å½“AVFrameä¸ºç©ºæ—¶ï¼Œä¼šå†²æ´—ç¼–ç å™¨ï¼Œret = AVERROR_EOFï¼Œ è¿”å›1ï¼Œ ç»“æŸå†™å…¥\n\nframeçš„æ¯ä¸€å¸§æ•°æ®ï¼Œæ˜¯æ¥è‡ªäºget_video_frameæ–¹æ³•, å¡«å……çš„å‡æ•°æ®\n\n```c\nstatic AVFrame *get_video_frame(OutputStream *ost)\n{\n    AVCodecContext *c = ost->enc;\n\n    /* check if we want to generate more frames */\n    if (av_compare_ts(ost->next_pts, c->time_base,\n                      STREAM_DURATION, (AVRational){ 1, 1 }) > 0)\n        return NULL;\n\n    /* when we pass a frame to the encoder, it may keep a reference to it\n     * internally; make sure we do not overwrite it here */\n    if (av_frame_make_writable(ost->frame) < 0)\n        exit(1);\n\n    if (c->pix_fmt != AV_PIX_FMT_YUV420P) {\n        /* as we only generate a YUV420P picture, we must convert it\n         * to the codec pixel format if needed */\n        if (!ost->sws_ctx) {\n            ost->sws_ctx = sws_getContext(c->width, c->height,\n                                          AV_PIX_FMT_YUV420P,\n                                          c->width, c->height,\n                                          c->pix_fmt,\n                                          SCALE_FLAGS, NULL, NULL, NULL);\n            if (!ost->sws_ctx) {\n                fprintf(stderr,\n                        \"Could not initialize the conversion context\\n\");\n                exit(1);\n            }\n        }\n        fill_yuv_image(ost->tmp_frame, ost->next_pts, c->width, c->height);\n        sws_scale(ost->sws_ctx, (const uint8_t * const *) ost->tmp_frame->data,\n                  ost->tmp_frame->linesize, 0, c->height, ost->frame->data,\n                  ost->frame->linesize);\n    } else {\n        fill_yuv_image(ost->frame, ost->next_pts, c->width, c->height);\n    }\n\n    ost->frame->pts = ost->next_pts++;\n\n    return ost->frame;\n}\n```\n\n1. è°ƒç”¨av_compare_ts åˆ¤æ–­æ˜¯å¦ç»§ç»­ç”Ÿæˆæ–°çš„frameï¼Œä¸€å¼€å§‹è§„å®šäº†åªå†™10ç§’é’Ÿçš„æ•°æ®ï¼Œè¶…è¿‡äº†å°±ä¸å†™äº†\n\n2. av_frame_make_writableä½¿å½“å‰çš„frameå¯å†™ï¼Œè¢«ç¼–ç å™¨å¼•ç”¨çš„frameä¸å¯å†™ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å¦‚æœè¢«å¼•ç”¨ï¼Œå†…éƒ¨ä¼šåˆ›å»ºæ–°bufï¼Œå˜æˆå¯å†™çš„\n\n3. å¡«å……æ•°æ®yuvï¼Œè¿˜åšäº†ç¼©æ”¾å¤„ç†ï¼Œæš‚ä¸è®¨è®º\n\n4. æ›´æ–°frameçš„pts\n\n5. è¿”å›ç”Ÿæˆçš„frame\n\nwrite_audio_frame\n\n```c\n/*\n * encode one audio frame and send it to the muxer\n * return 1 when encoding is finished, 0 otherwise\n */\nstatic int write_audio_frame(AVFormatContext *oc, OutputStream *ost)\n{\n    AVCodecContext *c;\n    AVFrame *frame;\n    int ret;\n    int dst_nb_samples;\n\n    c = ost->enc;\n\n    //è·å–éŸ³é¢‘å¸§\n    frame = get_audio_frame(ost);   \n\n    if (frame) {\n        /* convert samples from native format to destination codec format, using the resampler */\n        /* compute destination number of samples */\n\n        /*\n        è®¡ç®—æ ¹æ®é‡é‡‡æ ·ååº”è¯¥ç”Ÿæˆçš„é‡‡æ ·ä¸ªæ•°\n        */\n        dst_nb_samples = av_rescale_rnd(swr_get_delay(ost->swr_ctx, c->sample_rate) + frame->nb_samples,\n                                        c->sample_rate, c->sample_rate, AV_ROUND_UP);\n        //ç”±äºæ²¡æœ‰ä¿®æ”¹é‡‡æ ·ç‡ï¼Œåªæ˜¯ä¿®æ”¹äº†ä½æ·±ï¼Œé‡‡æ ·ä¸ªæ•°ä¿æŒä¸å˜\n        av_assert0(dst_nb_samples == frame->nb_samples);\n\n        /* when we pass a frame to the encoder, it may keep a reference to it\n         * internally;\n         * make sure we do not overwrite it here\n         */\n        //ä½¿ost->frameå¯å†™\n        ret = av_frame_make_writable(ost->frame);\n        if (ret < 0)\n            exit(1);\n\n        /* convert to destination format */\n        //é‡é‡‡æ ·\n        ret = swr_convert(ost->swr_ctx,\n                          ost->frame->data, dst_nb_samples,\n                          (const uint8_t **)frame->data, frame->nb_samples);\n        if (ret < 0) {\n            fprintf(stderr, \"Error while converting\\n\");\n            exit(1);\n        }\n\n        frame = ost->frame;\n        //é‡æ–°è®¡ç®—éŸ³é¢‘pts\n        frame->pts = av_rescale_q(ost->samples_count, (AVRational){1, c->sample_rate}, c->time_base);\n        //è®¡ç®—samples_count\n        ost->samples_count += dst_nb_samples;\n    }\n    //å°†éŸ³é¢‘å¸§å†™å…¥æ–‡ä»¶\n    return write_frame(oc, c, ost->st, frame, ost->tmp_pkt);\n}\n```\n\n1. å‡†å¤‡AVFrameï¼Œè°ƒç”¨get_audio_frameè·å–ä¸€ä¸ªAVFrameï¼Œå†…éƒ¨æ ¹æ®ç¼–ç æ ¼å¼ï¼Œå¡«å……pcmå‡æ•°æ®\n\n2. è°ƒç”¨av_rescale_rndè®¡ç®—é‡é‡‡æ ·ä¸ªæ•°ï¼Œå¦‚æœæ•°æ®æºå’Œé€å…¥ç¼–ç å™¨çš„éŸ³é¢‘çš„é‡‡æ ·ç‡ä¸åŒï¼Œéœ€è¦è½¬æ¢é‡‡æ ·ç‡ï¼Œç¤ºä¾‹ç¨‹åºåªæ˜¯å˜äº†é‡‡æ ·æ ¼å¼ï¼Œæ²¡æœ‰æ›´æ”¹é‡‡æ ·ç‡ï¼Œé‡‡æ ·ä¸ªæ•°ä¸å˜\n\n3. åšé‡é‡‡æ ·ï¼Œé‡é‡‡æ ·æ•°æ®ä¿å­˜åœ¨ost->frameä¸­\n\n4. é‡é‡‡æ ·åï¼Œéœ€è¦æ›´æ–°frameçš„pts\n\n5. è°ƒç”¨write_frameç¼–ç ï¼Œå°†æ•°æ®å†™å…¥æ–‡ä»¶\n\n## æ€»ç»“ï¼š\n\nå­¦ä¹ äº†é€šè¿‡åº”ç”¨libavformatå°†éŸ³è§†é¢‘æ•°æ®ç¼–ç å°è£…åˆ°æ–‡ä»¶ä¸­\n\n1. åˆ›å»ºAVFormatContext\n\n2. æ·»åŠ stream\n\n3. é…ç½®ç¼–è§£ç å™¨ï¼Œstream å‚æ•°\n\n4. ç¼–ç frameï¼Œç”Ÿæˆpktï¼Œæ›´æ–°pts\n\n5. äº¤æ›¿å†™éŸ³è§†é¢‘pkt\n\n6. å…³é—­ç¼–è§£ç å™¨ï¼Œç»“æŸå†™æ–‡ä»¶\n\n# \n","slug":"ffmpeg/2022-03-13-ffmpeg example å­¦ä¹  4","published":1,"updated":"2024-03-06T11:53:13.565Z","comments":1,"photos":[],"_id":"clti3glkq001x57wh08hl76pn","content":"<p>ä»Šå¤©å­¦ä¹  <code>ffmpeg/doc/examples/muxing.c</code></p>\n<p>è¯¥ç¨‹åºæ¥å—ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚<code>/tmp/mux.mp4</code>,<code>/tmp/mux.mov</code>ã€‚ æ–‡ä»¶åçš„åç¼€ä¼šç”¨æ¥æ¨æµ‹ç”Ÿæˆçš„AVFormatContextçš„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°±ä½¿ç”¨<code>mpeg</code>ã€‚ä½¿ç”¨fmt é»˜è®¤çš„è§†é¢‘ç¼–ç å™¨å’ŒéŸ³é¢‘ç¼–ç å™¨ï¼Œç¼–ç 10ç§’é’Ÿçš„éŸ³è§†é¢‘æ•°æ®ï¼Œäº¤æ›¿å†™å…¥æ–‡ä»¶ã€‚</p>\n<p>æ“ä½œå°è£…éœ€è¦æ“ä½œ<code>AVFormatContext</code></p>\n<h2 id=\"åˆ›å»ºAVFormatContext\"><a href=\"#åˆ›å»ºAVFormatContext\" class=\"headerlink\" title=\"åˆ›å»ºAVFormatContext\"></a>åˆ›å»ºAVFormatContext</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//åˆ›å»ºAVFormatContextï¼Œ æ ¹æ®æ–‡ä»¶åç¼€æ¥æ¨æµ‹output format</span><br>avformat_alloc_output_context2(&amp;oc, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>, filename);<br><span class=\"hljs-keyword\">if</span> (!oc) &#123;<br>    <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;Could not deduce output format from file extension: using MPEG.\\n&quot;</span>);<br>    <span class=\"hljs-comment\">//æ— æ³•æ¨æµ‹output formatï¼Œ ä½¿ç”¨mpeg</span><br>    avformat_alloc_output_context2(&amp;oc, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-string\">&quot;mpeg&quot;</span>, filename);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ç»™AVFormatContextæ·»åŠ -video-audio-stream\"><a href=\"#ç»™AVFormatContextæ·»åŠ -video-audio-stream\" class=\"headerlink\" title=\"ç»™AVFormatContextæ·»åŠ  video &#x2F; audio stream\"></a>ç»™AVFormatContextæ·»åŠ  video &#x2F; audio stream</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (fmt-&gt;video_codec != AV_CODEC_ID_NONE) &#123;<br>    add_stream(&amp;video_st, oc, &amp;video_codec, fmt-&gt;video_codec);<br>    have_video = <span class=\"hljs-number\">1</span>;<br>    encode_video = <span class=\"hljs-number\">1</span>;<br>&#125;<br><span class=\"hljs-keyword\">if</span> (fmt-&gt;audio_codec != AV_CODEC_ID_NONE) &#123;<br>    add_stream(&amp;audio_st, oc, &amp;audio_codec, fmt-&gt;audio_codec);<br>    have_audio = <span class=\"hljs-number\">1</span>;<br>    encode_audio = <span class=\"hljs-number\">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æˆ‘ä»¬çœ‹çœ‹add_streamåšäº†ä»€ä¹ˆ</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Add an output stream. */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">add_stream</span><span class=\"hljs-params\">(OutputStream *ost, AVFormatContext *oc,</span><br><span class=\"hljs-params\">                       <span class=\"hljs-type\">const</span> AVCodec **codec,</span><br><span class=\"hljs-params\">                       <span class=\"hljs-keyword\">enum</span> AVCodecID codec_id)</span><br>&#123;<br>    AVCodecContext *c;<br>    <span class=\"hljs-type\">int</span> i;<br>    <span class=\"hljs-comment\">/* find the encoder */</span><br>    <span class=\"hljs-comment\">//æ‰¾åˆ°codec_idå¯¹åº”çš„ç¼–ç å™¨AVCodec</span><br>    *codec = avcodec_find_encoder(codec_id);<br>    <span class=\"hljs-comment\">//åˆ›å»ºpkt</span><br>    ost-&gt;tmp_pkt = av_packet_alloc();<br>    <span class=\"hljs-comment\">//åˆ›å»ºAVStream</span><br>    ost-&gt;st = avformat_new_stream(oc, <span class=\"hljs-literal\">NULL</span>);<br>    <span class=\"hljs-comment\">//è®¾ç½®streamçš„index</span><br>    ost-&gt;st-&gt;id = oc-&gt;nb_streams<span class=\"hljs-number\">-1</span>;<br>    <span class=\"hljs-comment\">//åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡</span><br>    c = avcodec_alloc_context3(*codec);<br>    <span class=\"hljs-comment\">//ä¿å­˜ç¼–ç å™¨ä¸Šä¸‹æ–‡</span><br>    ost-&gt;enc = c;<br><br>    <span class=\"hljs-keyword\">switch</span> ((*codec)-&gt;type) &#123;<br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_AUDIO:<br>         <span class=\"hljs-comment\">//è®¾ç½®éŸ³é¢‘ç¼–ç å™¨ä¸Šä¸‹æ–‡å‚æ•°(ç ç‡ï¼Œé‡‡æ ·ç‡ï¼Œä½æ·±ï¼Œå£°é“å¸ƒå±€ç­‰)</span><br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ...<br>        <span class=\"hljs-comment\">//è®¾ç½®streamçš„æ—¶é—´åŸº</span><br>        ost-&gt;st-&gt;time_base = (AVRational)&#123; <span class=\"hljs-number\">1</span>, c-&gt;sample_rate &#125;;<br>        <span class=\"hljs-keyword\">break</span>;<br><br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_VIDEO:<br>        <span class=\"hljs-comment\">//è®¾ç½®ç¼–ç å™¨ä¸Šä¸‹æ–‡çš„å‚æ•°</span><br>        c-&gt;codec_id = codec_id;<br>        <span class=\"hljs-comment\">//è®¾ç½®streamçš„æ—¶é—´åŸº</span><br>        ost-&gt;st-&gt;time_base = (AVRational)&#123; <span class=\"hljs-number\">1</span>, STREAM_FRAME_RATE &#125;;<br>        c-&gt;time_base       = ost-&gt;st-&gt;time_base;<br>Â Â Â Â Â Â Â Â <span class=\"hljs-comment\">//ç¼–ç å™¨ç ç‡ï¼Œå¸§ç‡ï¼Œgopï¼Œåˆ†è¾¨ç‡, è®¾ç½®</span><br>Â Â Â Â Â Â Â Â ...<br>        <span class=\"hljs-keyword\">break</span>;<br><br>    <span class=\"hljs-keyword\">default</span>:<br>        <span class=\"hljs-keyword\">break</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">/* Some formats want stream headers to be separate. */</span><br>Â Â Â Â <span class=\"hljs-comment\">//å¤„ç†ä¸€ä¸‹stream header</span><br>    <span class=\"hljs-keyword\">if</span> (oc-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)<br>        c-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>æ ¹æ®codec_idæ‰¾åˆ°AVCodec</p>\n</li>\n<li><p>è°ƒç”¨avformat_new_streamåˆ›å»ºstream</p>\n</li>\n<li><p>è®¾ç½®streamçš„index</p>\n</li>\n<li><p>æ ¹æ®AVCodecåˆ›å»ºç¼–ç å™¨çš„ä¸Šä¸‹æ–‡ï¼Œé…ç½®ç¼–ç å™¨å‚æ•°</p>\n</li>\n<li><p>è®¾ç½®streamçš„time_base</p>\n</li>\n<li><p>å¤„ç†ä¸€ä¸‹ stream headers çš„æ ‡å¿—ä½</p>\n</li>\n</ol>\n<h2 id=\"éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡\"><a href=\"#éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡\" class=\"headerlink\" title=\"éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡\"></a>éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡</h2><ol>\n<li><p>ä¸Šé¢åˆ›å»ºå¥½äº†stream, åˆ›å»ºäº†ç¼–ç å™¨ä¸Šä¸‹æ–‡ã€‚open_video&#x2F;open_audioç»§ç»­ä¸ºå†™å…¥åšå‡†å¤‡</p>\n</li>\n<li><p>å‡†å¤‡å®Œæˆå°±æ‰“å¼€æ–‡ä»¶å‡†å¤‡å†™å…¥</p>\n</li>\n</ol>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Now that all the parameters are set, we can open the audio and</span><br><span class=\"hljs-comment\"> * video codecs and allocate the necessary encode buffers. */</span><br><span class=\"hljs-keyword\">if</span> (have_video)<br>    open_video(oc, video_codec, &amp;video_st, opt);<br><br><span class=\"hljs-keyword\">if</span> (have_audio)<br>    open_audio(oc, audio_codec, &amp;audio_st, opt);<br><br><span class=\"hljs-comment\">//æ‰“å°ocçš„ä¿¡æ¯</span><br>av_dump_format(oc, <span class=\"hljs-number\">0</span>, filename, <span class=\"hljs-number\">1</span>);<br><br><span class=\"hljs-comment\">/* open the output file, if needed */</span><br><span class=\"hljs-keyword\">if</span> (!(fmt-&gt;flags &amp; AVFMT_NOFILE)) &#123;<br>    <span class=\"hljs-comment\">//æ‰“å¼€æ–‡ä»¶</span><br>    ret = avio_open(&amp;oc-&gt;pb, filename, AVIO_FLAG_WRITE);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open &#x27;%s&#x27;: %s\\n&quot;</span>, filename,<br>                av_err2str(ret));<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>çœ‹çœ‹open_video åšäº†ä»€ä¹ˆ</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">open_video</span><span class=\"hljs-params\">(AVFormatContext *oc, <span class=\"hljs-type\">const</span> AVCodec *codec,</span><br><span class=\"hljs-params\">                       OutputStream *ost, AVDictionary *opt_arg)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret;<br>    AVCodecContext *c = ost-&gt;enc;<br>    AVDictionary *opt = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-comment\">//å°†opt_argä¸­çš„å†…å®¹æ‹·è´åˆ°optä¸­</span><br>    av_dict_copy(&amp;opt, opt_arg, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-comment\">/* open the codec */</span><br>    <span class=\"hljs-comment\">//æ‰“å¼€ç¼–ç å™¨</span><br>    ret = avcodec_open2(c, codec, &amp;opt);<br>    <span class=\"hljs-comment\">//é‡Šæ”¾opt</span><br>    av_dict_free(&amp;opt);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open video codec: %s\\n&quot;</span>, av_err2str(ret));<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* allocate and init a re-usable frame */</span><br>    <span class=\"hljs-comment\">//æ ¹æ®æ ¼å¼ï¼Œå®½é«˜ï¼Œåˆ›å»ºä¸€ä¸ªå¤ç”¨çš„AVFrame</span><br>    ost-&gt;frame = alloc_picture(c-&gt;pix_fmt, c-&gt;width, c-&gt;height);<br>    <span class=\"hljs-keyword\">if</span> (!ost-&gt;frame) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate video frame\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* If the output format is not YUV420P, then a temporary YUV420P</span><br><span class=\"hljs-comment\">     * picture is needed too. It is then converted to the required</span><br><span class=\"hljs-comment\">     * output format. */</span><br>    ost-&gt;tmp_frame = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-keyword\">if</span> (c-&gt;pix_fmt != AV_PIX_FMT_YUV420P) &#123;<br>        <span class=\"hljs-comment\">//å¦‚æœç¼–ç å™¨å¯¹åº”çš„pix_fmtä¸æ˜¯yuv420pï¼Œ åˆ›å»ºä¸€ä¸ªyuv420pæ ¼å¼çš„AVFrameï¼Œä¿å­˜åœ¨ost-&gt;tmp_frameä¸­</span><br>        ost-&gt;tmp_frame = alloc_picture(AV_PIX_FMT_YUV420P, c-&gt;width, c-&gt;height);<br>        <span class=\"hljs-keyword\">if</span> (!ost-&gt;tmp_frame) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate temporary picture\\n&quot;</span>);<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* copy the stream parameters to the muxer */</span><br>    <span class=\"hljs-comment\">//å°†ç¼–ç å™¨çš„å‚æ•°æ‹·è´åˆ°streamå¯¹åº”çš„ç¼–ç å‚æ•°ä¸­</span><br>    ret = avcodec_parameters_from_context(ost-&gt;st-&gt;codecpar, c);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not copy the stream parameters\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>æ‰“å¼€ç¼–ç å™¨</p>\n</li>\n<li><p>ç”³è¯·èµ„æºï¼Œåˆ›å»ºä¸€ä¸ªAVFrameç”¨äºå­˜å‚¨ç¼–ç å‰æ•°æ®</p>\n</li>\n<li><p>è°ƒç”¨avcodec_parameters_from_contextå°†ç¼–ç å™¨çš„ç¼–ç å‚æ•°æ‹·è´åˆ°streamçš„codecparä¸­</p>\n</li>\n</ol>\n<h2 id=\"å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶\"><a href=\"#å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶\" class=\"headerlink\" title=\"å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶\"></a>å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶</h2><p>å†™æ–‡ä»¶å¤´</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Write the stream header, if any. */</span><br><span class=\"hljs-comment\">//å°†æµä¿¡æ¯å†™æ–‡ä»¶å¤´</span><br>ret = avformat_write_header(oc, &amp;opt);<br><span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>    <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error occurred when opening output file: %s\\n&quot;</span>,<br>            av_err2str(ret));<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>äº¤æ›¿å†™éŸ³è§†é¢‘å¸§</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">while</span> (encode_video || encode_audio) &#123;<br>    <span class=\"hljs-comment\">/* select the stream to encode */</span><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     äº¤æ›¿å†™å…¥ç¼–ç åçš„éŸ³é¢‘å’Œè§†é¢‘å¸§</span><br><span class=\"hljs-comment\">     è§†é¢‘å†™å…¥ç»“æŸæˆ–è€…video_st.next_pts &lt;= audio_st.next_pts, å†™è§†é¢‘</span><br><span class=\"hljs-comment\">     å¦åˆ™å†™éŸ³é¢‘</span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">if</span> (encode_video &amp;&amp;<br>        (!encode_audio || av_compare_ts(video_st.next_pts, video_st.enc-&gt;time_base,<br>                                        audio_st.next_pts, audio_st.enc-&gt;time_base) &lt;= <span class=\"hljs-number\">0</span>)) &#123;<br>        <span class=\"hljs-comment\">//å†™å…¥ç¼–ç åçš„è§†é¢‘å¸§</span><br>        encode_video = !write_video_frame(oc, &amp;video_st);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-comment\">//å†™å…¥ç¼–ç åçš„éŸ³é¢‘å¸§</span><br>        encode_audio = !write_audio_frame(oc, &amp;audio_st);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p> å†™trailer</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Write the trailer, if any. The trailer must be written before you</span><br><span class=\"hljs-comment\"> * close the CodecContexts open when you wrote the header; otherwise</span><br><span class=\"hljs-comment\"> * av_write_trailer() may try to use memory that was freed on</span><br><span class=\"hljs-comment\"> * av_codec_close(). */</span><br>av_write_trailer(oc);<br></code></pre></td></tr></table></figure>\n\n<p>å…³é—­ç¼–ç å™¨ï¼Œå…³é—­æ–‡ä»¶ï¼Œé‡Šæ”¾èµ„æº</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Close each codec. */</span><br><span class=\"hljs-keyword\">if</span> (have_video)<br>    close_stream(oc, &amp;video_st);<br><span class=\"hljs-keyword\">if</span> (have_audio)<br>    close_stream(oc, &amp;audio_st);<br><br><span class=\"hljs-keyword\">if</span> (!(fmt-&gt;flags &amp; AVFMT_NOFILE))<br>    <span class=\"hljs-comment\">/* Close the output file. */</span><br>    avio_closep(&amp;oc-&gt;pb);<br><br><span class=\"hljs-comment\">/* free the stream */</span><br>avformat_free_context(oc);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"write-video-frame\"><a href=\"#write-video-frame\" class=\"headerlink\" title=\"write_video_frame\"></a>write_video_frame</h3><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static int write_video_frame(AVFormatContext *oc, OutputStream *ost)<br>&#123;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">return</span> write_frame(oc, ost-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">enc</span>, ost-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">st</span>, get_video_frame(ost), ost-&gt;</span>tmp_pkt);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åªæ˜¯ç®€å•è°ƒç”¨äº†write_frame</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">write_frame</span><span class=\"hljs-params\">(AVFormatContext *fmt_ctx, AVCodecContext *c,</span><br><span class=\"hljs-params\">                       AVStream *st, AVFrame *frame, AVPacket *pkt)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret;<br><br>    <span class=\"hljs-comment\">// send the frame to the encoder</span><br>    <span class=\"hljs-comment\">//å°†frameé€ç»™ç¼–ç å™¨å»ç¼–ç </span><br>    ret = avcodec_send_frame(c, frame);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error sending a frame to the encoder: %s\\n&quot;</span>,<br>                av_err2str(ret));<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//ä»ç¼–ç å™¨ä¸­è¯»å‡ºç¼–ç åçš„pkt</span><br>        ret = avcodec_receive_packet(c, pkt);<br>        <span class=\"hljs-keyword\">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)<br>            <span class=\"hljs-keyword\">break</span>;<br>        <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error encoding a frame: %s\\n&quot;</span>, av_err2str(ret));<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br><br>        <span class=\"hljs-comment\">/* rescale output packet timestamp values from codec to stream timebase */</span><br>        <span class=\"hljs-comment\">//è°ƒæ•´pktçš„ptsï¼Œpktçš„æ—¶é—´åŸºå‚ç¼–ç å™¨çš„æ—¶é—´åŸºï¼Œå°†å…¶è½¬æ¢ä¸ºå‚è€ƒstreamçš„æ—¶é—´åŸº</span><br>        av_packet_rescale_ts(pkt, c-&gt;time_base, st-&gt;time_base);<br>        <span class=\"hljs-comment\">//è®¾ç½®pktçš„stream_indexå’Œstreamå¯¹åº”çš„ä¸€è‡´ï¼ŒéŸ³è§†é¢‘åˆ†åˆ«å¯¹åº”äºä¸åŒçš„stream_index</span><br>        pkt-&gt;stream_index = st-&gt;index;<br><br>        <span class=\"hljs-comment\">/* Write the compressed frame to the media file. */</span><br>        log_packet(fmt_ctx, pkt);<br>        <span class=\"hljs-comment\">//å°†pktå†™å…¥è§†é¢‘æ–‡ä»¶</span><br>        ret = av_interleaved_write_frame(fmt_ctx, pkt);<br>        <span class=\"hljs-comment\">/* pkt is now blank (av_interleaved_write_frame() takes ownership of</span><br><span class=\"hljs-comment\">         * its contents and resets pkt), so that no unreferencing is necessary.</span><br><span class=\"hljs-comment\">         * This would be different if one used av_write_frame(). */</span><br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error while writing output packet: %s\\n&quot;</span>, av_err2str(ret));<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">return</span> ret == AVERROR_EOF ? <span class=\"hljs-number\">1</span> : <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å°†AVFrameé€ç»™ç¼–ç å™¨å»ç¼–ç </p>\n</li>\n<li><p>è¯»å–pkt</p>\n</li>\n<li><p>è°ƒç”¨av_packet_rescale_tsï¼Œè°ƒæ•´pktçš„æ—¶é—´æˆ³ï¼Œå†™å…¥æ–‡ä»¶pktçš„ptsè¦ä»¥streamçš„time_baseä¸ºåŸºå‡†</p>\n</li>\n<li><p>è®¾ç½®pktçš„index</p>\n</li>\n<li><p>è°ƒç”¨av_interleaved_write_frameå°†pktå†™å…¥æ–‡ä»¶</p>\n</li>\n<li><p>è¿”å›å†™å…¥ç»“æœã€‚å½“AVFrameä¸ºç©ºæ—¶ï¼Œä¼šå†²æ´—ç¼–ç å™¨ï¼Œret &#x3D; AVERROR_EOFï¼Œ è¿”å›1ï¼Œ ç»“æŸå†™å…¥</p>\n</li>\n</ol>\n<p>frameçš„æ¯ä¸€å¸§æ•°æ®ï¼Œæ˜¯æ¥è‡ªäºget_video_frameæ–¹æ³•, å¡«å……çš„å‡æ•°æ®</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> AVFrame *<span class=\"hljs-title function_\">get_video_frame</span><span class=\"hljs-params\">(OutputStream *ost)</span><br>&#123;<br>    AVCodecContext *c = ost-&gt;enc;<br><br>    <span class=\"hljs-comment\">/* check if we want to generate more frames */</span><br>    <span class=\"hljs-keyword\">if</span> (av_compare_ts(ost-&gt;next_pts, c-&gt;time_base,<br>                      STREAM_DURATION, (AVRational)&#123; <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span> &#125;) &gt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;<br><br>    <span class=\"hljs-comment\">/* when we pass a frame to the encoder, it may keep a reference to it</span><br><span class=\"hljs-comment\">     * internally; make sure we do not overwrite it here */</span><br>    <span class=\"hljs-keyword\">if</span> (av_frame_make_writable(ost-&gt;frame) &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br><br>    <span class=\"hljs-keyword\">if</span> (c-&gt;pix_fmt != AV_PIX_FMT_YUV420P) &#123;<br>        <span class=\"hljs-comment\">/* as we only generate a YUV420P picture, we must convert it</span><br><span class=\"hljs-comment\">         * to the codec pixel format if needed */</span><br>        <span class=\"hljs-keyword\">if</span> (!ost-&gt;sws_ctx) &#123;<br>            ost-&gt;sws_ctx = sws_getContext(c-&gt;width, c-&gt;height,<br>                                          AV_PIX_FMT_YUV420P,<br>                                          c-&gt;width, c-&gt;height,<br>                                          c-&gt;pix_fmt,<br>                                          SCALE_FLAGS, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>);<br>            <span class=\"hljs-keyword\">if</span> (!ost-&gt;sws_ctx) &#123;<br>                <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>,<br>                        <span class=\"hljs-string\">&quot;Could not initialize the conversion context\\n&quot;</span>);<br>                <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>            &#125;<br>        &#125;<br>        fill_yuv_image(ost-&gt;tmp_frame, ost-&gt;next_pts, c-&gt;width, c-&gt;height);<br>        sws_scale(ost-&gt;sws_ctx, (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint8_t</span> * <span class=\"hljs-type\">const</span> *) ost-&gt;tmp_frame-&gt;data,<br>                  ost-&gt;tmp_frame-&gt;linesize, <span class=\"hljs-number\">0</span>, c-&gt;height, ost-&gt;frame-&gt;data,<br>                  ost-&gt;frame-&gt;linesize);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        fill_yuv_image(ost-&gt;frame, ost-&gt;next_pts, c-&gt;width, c-&gt;height);<br>    &#125;<br><br>    ost-&gt;frame-&gt;pts = ost-&gt;next_pts++;<br><br>    <span class=\"hljs-keyword\">return</span> ost-&gt;frame;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è°ƒç”¨av_compare_ts åˆ¤æ–­æ˜¯å¦ç»§ç»­ç”Ÿæˆæ–°çš„frameï¼Œä¸€å¼€å§‹è§„å®šäº†åªå†™10ç§’é’Ÿçš„æ•°æ®ï¼Œè¶…è¿‡äº†å°±ä¸å†™äº†</p>\n</li>\n<li><p>av_frame_make_writableä½¿å½“å‰çš„frameå¯å†™ï¼Œè¢«ç¼–ç å™¨å¼•ç”¨çš„frameä¸å¯å†™ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å¦‚æœè¢«å¼•ç”¨ï¼Œå†…éƒ¨ä¼šåˆ›å»ºæ–°bufï¼Œå˜æˆå¯å†™çš„</p>\n</li>\n<li><p>å¡«å……æ•°æ®yuvï¼Œè¿˜åšäº†ç¼©æ”¾å¤„ç†ï¼Œæš‚ä¸è®¨è®º</p>\n</li>\n<li><p>æ›´æ–°frameçš„pts</p>\n</li>\n<li><p>è¿”å›ç”Ÿæˆçš„frame</p>\n</li>\n</ol>\n<p>write_audio_frame</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\"> * encode one audio frame and send it to the muxer</span><br><span class=\"hljs-comment\"> * return 1 when encoding is finished, 0 otherwise</span><br><span class=\"hljs-comment\"> */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">write_audio_frame</span><span class=\"hljs-params\">(AVFormatContext *oc, OutputStream *ost)</span><br>&#123;<br>    AVCodecContext *c;<br>    AVFrame *frame;<br>    <span class=\"hljs-type\">int</span> ret;<br>    <span class=\"hljs-type\">int</span> dst_nb_samples;<br><br>    c = ost-&gt;enc;<br><br>    <span class=\"hljs-comment\">//è·å–éŸ³é¢‘å¸§</span><br>    frame = get_audio_frame(ost);   <br><br>    <span class=\"hljs-keyword\">if</span> (frame) &#123;<br>        <span class=\"hljs-comment\">/* convert samples from native format to destination codec format, using the resampler */</span><br>        <span class=\"hljs-comment\">/* compute destination number of samples */</span><br><br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">        è®¡ç®—æ ¹æ®é‡é‡‡æ ·ååº”è¯¥ç”Ÿæˆçš„é‡‡æ ·ä¸ªæ•°</span><br><span class=\"hljs-comment\">        */</span><br>        dst_nb_samples = av_rescale_rnd(swr_get_delay(ost-&gt;swr_ctx, c-&gt;sample_rate) + frame-&gt;nb_samples,<br>                                        c-&gt;sample_rate, c-&gt;sample_rate, AV_ROUND_UP);<br>        <span class=\"hljs-comment\">//ç”±äºæ²¡æœ‰ä¿®æ”¹é‡‡æ ·ç‡ï¼Œåªæ˜¯ä¿®æ”¹äº†ä½æ·±ï¼Œé‡‡æ ·ä¸ªæ•°ä¿æŒä¸å˜</span><br>        av_assert0(dst_nb_samples == frame-&gt;nb_samples);<br><br>        <span class=\"hljs-comment\">/* when we pass a frame to the encoder, it may keep a reference to it</span><br><span class=\"hljs-comment\">         * internally;</span><br><span class=\"hljs-comment\">         * make sure we do not overwrite it here</span><br><span class=\"hljs-comment\">         */</span><br>        <span class=\"hljs-comment\">//ä½¿ost-&gt;frameå¯å†™</span><br>        ret = av_frame_make_writable(ost-&gt;frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br><br>        <span class=\"hljs-comment\">/* convert to destination format */</span><br>        <span class=\"hljs-comment\">//é‡é‡‡æ ·</span><br>        ret = swr_convert(ost-&gt;swr_ctx,<br>                          ost-&gt;frame-&gt;data, dst_nb_samples,<br>                          (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint8_t</span> **)frame-&gt;data, frame-&gt;nb_samples);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error while converting\\n&quot;</span>);<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br><br>        frame = ost-&gt;frame;<br>        <span class=\"hljs-comment\">//é‡æ–°è®¡ç®—éŸ³é¢‘pts</span><br>        frame-&gt;pts = av_rescale_q(ost-&gt;samples_count, (AVRational)&#123;<span class=\"hljs-number\">1</span>, c-&gt;sample_rate&#125;, c-&gt;time_base);<br>        <span class=\"hljs-comment\">//è®¡ç®—samples_count</span><br>        ost-&gt;samples_count += dst_nb_samples;<br>    &#125;<br>    <span class=\"hljs-comment\">//å°†éŸ³é¢‘å¸§å†™å…¥æ–‡ä»¶</span><br>    <span class=\"hljs-keyword\">return</span> write_frame(oc, c, ost-&gt;st, frame, ost-&gt;tmp_pkt);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å‡†å¤‡AVFrameï¼Œè°ƒç”¨get_audio_frameè·å–ä¸€ä¸ªAVFrameï¼Œå†…éƒ¨æ ¹æ®ç¼–ç æ ¼å¼ï¼Œå¡«å……pcmå‡æ•°æ®</p>\n</li>\n<li><p>è°ƒç”¨av_rescale_rndè®¡ç®—é‡é‡‡æ ·ä¸ªæ•°ï¼Œå¦‚æœæ•°æ®æºå’Œé€å…¥ç¼–ç å™¨çš„éŸ³é¢‘çš„é‡‡æ ·ç‡ä¸åŒï¼Œéœ€è¦è½¬æ¢é‡‡æ ·ç‡ï¼Œç¤ºä¾‹ç¨‹åºåªæ˜¯å˜äº†é‡‡æ ·æ ¼å¼ï¼Œæ²¡æœ‰æ›´æ”¹é‡‡æ ·ç‡ï¼Œé‡‡æ ·ä¸ªæ•°ä¸å˜</p>\n</li>\n<li><p>åšé‡é‡‡æ ·ï¼Œé‡é‡‡æ ·æ•°æ®ä¿å­˜åœ¨ost-&gt;frameä¸­</p>\n</li>\n<li><p>é‡é‡‡æ ·åï¼Œéœ€è¦æ›´æ–°frameçš„pts</p>\n</li>\n<li><p>è°ƒç”¨write_frameç¼–ç ï¼Œå°†æ•°æ®å†™å…¥æ–‡ä»¶</p>\n</li>\n</ol>\n<h2 id=\"æ€»ç»“ï¼š\"><a href=\"#æ€»ç»“ï¼š\" class=\"headerlink\" title=\"æ€»ç»“ï¼š\"></a>æ€»ç»“ï¼š</h2><p>å­¦ä¹ äº†é€šè¿‡åº”ç”¨libavformatå°†éŸ³è§†é¢‘æ•°æ®ç¼–ç å°è£…åˆ°æ–‡ä»¶ä¸­</p>\n<ol>\n<li><p>åˆ›å»ºAVFormatContext</p>\n</li>\n<li><p>æ·»åŠ stream</p>\n</li>\n<li><p>é…ç½®ç¼–è§£ç å™¨ï¼Œstream å‚æ•°</p>\n</li>\n<li><p>ç¼–ç frameï¼Œç”Ÿæˆpktï¼Œæ›´æ–°pts</p>\n</li>\n<li><p>äº¤æ›¿å†™éŸ³è§†é¢‘pkt</p>\n</li>\n<li><p>å…³é—­ç¼–è§£ç å™¨ï¼Œç»“æŸå†™æ–‡ä»¶</p>\n</li>\n</ol>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1>","excerpt":"","more":"<p>ä»Šå¤©å­¦ä¹  <code>ffmpeg/doc/examples/muxing.c</code></p>\n<p>è¯¥ç¨‹åºæ¥å—ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚<code>/tmp/mux.mp4</code>,<code>/tmp/mux.mov</code>ã€‚ æ–‡ä»¶åçš„åç¼€ä¼šç”¨æ¥æ¨æµ‹ç”Ÿæˆçš„AVFormatContextçš„æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°±ä½¿ç”¨<code>mpeg</code>ã€‚ä½¿ç”¨fmt é»˜è®¤çš„è§†é¢‘ç¼–ç å™¨å’ŒéŸ³é¢‘ç¼–ç å™¨ï¼Œç¼–ç 10ç§’é’Ÿçš„éŸ³è§†é¢‘æ•°æ®ï¼Œäº¤æ›¿å†™å…¥æ–‡ä»¶ã€‚</p>\n<p>æ“ä½œå°è£…éœ€è¦æ“ä½œ<code>AVFormatContext</code></p>\n<h2 id=\"åˆ›å»ºAVFormatContext\"><a href=\"#åˆ›å»ºAVFormatContext\" class=\"headerlink\" title=\"åˆ›å»ºAVFormatContext\"></a>åˆ›å»ºAVFormatContext</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//åˆ›å»ºAVFormatContextï¼Œ æ ¹æ®æ–‡ä»¶åç¼€æ¥æ¨æµ‹output format</span><br>avformat_alloc_output_context2(&amp;oc, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>, filename);<br><span class=\"hljs-keyword\">if</span> (!oc) &#123;<br>    <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;Could not deduce output format from file extension: using MPEG.\\n&quot;</span>);<br>    <span class=\"hljs-comment\">//æ— æ³•æ¨æµ‹output formatï¼Œ ä½¿ç”¨mpeg</span><br>    avformat_alloc_output_context2(&amp;oc, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-string\">&quot;mpeg&quot;</span>, filename);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ç»™AVFormatContextæ·»åŠ -video-audio-stream\"><a href=\"#ç»™AVFormatContextæ·»åŠ -video-audio-stream\" class=\"headerlink\" title=\"ç»™AVFormatContextæ·»åŠ  video &#x2F; audio stream\"></a>ç»™AVFormatContextæ·»åŠ  video &#x2F; audio stream</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (fmt-&gt;video_codec != AV_CODEC_ID_NONE) &#123;<br>    add_stream(&amp;video_st, oc, &amp;video_codec, fmt-&gt;video_codec);<br>    have_video = <span class=\"hljs-number\">1</span>;<br>    encode_video = <span class=\"hljs-number\">1</span>;<br>&#125;<br><span class=\"hljs-keyword\">if</span> (fmt-&gt;audio_codec != AV_CODEC_ID_NONE) &#123;<br>    add_stream(&amp;audio_st, oc, &amp;audio_codec, fmt-&gt;audio_codec);<br>    have_audio = <span class=\"hljs-number\">1</span>;<br>    encode_audio = <span class=\"hljs-number\">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æˆ‘ä»¬çœ‹çœ‹add_streamåšäº†ä»€ä¹ˆ</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Add an output stream. */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">add_stream</span><span class=\"hljs-params\">(OutputStream *ost, AVFormatContext *oc,</span><br><span class=\"hljs-params\">                       <span class=\"hljs-type\">const</span> AVCodec **codec,</span><br><span class=\"hljs-params\">                       <span class=\"hljs-keyword\">enum</span> AVCodecID codec_id)</span><br>&#123;<br>    AVCodecContext *c;<br>    <span class=\"hljs-type\">int</span> i;<br>    <span class=\"hljs-comment\">/* find the encoder */</span><br>    <span class=\"hljs-comment\">//æ‰¾åˆ°codec_idå¯¹åº”çš„ç¼–ç å™¨AVCodec</span><br>    *codec = avcodec_find_encoder(codec_id);<br>    <span class=\"hljs-comment\">//åˆ›å»ºpkt</span><br>    ost-&gt;tmp_pkt = av_packet_alloc();<br>    <span class=\"hljs-comment\">//åˆ›å»ºAVStream</span><br>    ost-&gt;st = avformat_new_stream(oc, <span class=\"hljs-literal\">NULL</span>);<br>    <span class=\"hljs-comment\">//è®¾ç½®streamçš„index</span><br>    ost-&gt;st-&gt;id = oc-&gt;nb_streams<span class=\"hljs-number\">-1</span>;<br>    <span class=\"hljs-comment\">//åˆ›å»ºç¼–ç å™¨ä¸Šä¸‹æ–‡</span><br>    c = avcodec_alloc_context3(*codec);<br>    <span class=\"hljs-comment\">//ä¿å­˜ç¼–ç å™¨ä¸Šä¸‹æ–‡</span><br>    ost-&gt;enc = c;<br><br>    <span class=\"hljs-keyword\">switch</span> ((*codec)-&gt;type) &#123;<br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_AUDIO:<br>         <span class=\"hljs-comment\">//è®¾ç½®éŸ³é¢‘ç¼–ç å™¨ä¸Šä¸‹æ–‡å‚æ•°(ç ç‡ï¼Œé‡‡æ ·ç‡ï¼Œä½æ·±ï¼Œå£°é“å¸ƒå±€ç­‰)</span><br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ...<br>        <span class=\"hljs-comment\">//è®¾ç½®streamçš„æ—¶é—´åŸº</span><br>        ost-&gt;st-&gt;time_base = (AVRational)&#123; <span class=\"hljs-number\">1</span>, c-&gt;sample_rate &#125;;<br>        <span class=\"hljs-keyword\">break</span>;<br><br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_VIDEO:<br>        <span class=\"hljs-comment\">//è®¾ç½®ç¼–ç å™¨ä¸Šä¸‹æ–‡çš„å‚æ•°</span><br>        c-&gt;codec_id = codec_id;<br>        <span class=\"hljs-comment\">//è®¾ç½®streamçš„æ—¶é—´åŸº</span><br>        ost-&gt;st-&gt;time_base = (AVRational)&#123; <span class=\"hljs-number\">1</span>, STREAM_FRAME_RATE &#125;;<br>        c-&gt;time_base       = ost-&gt;st-&gt;time_base;<br>Â Â Â Â Â Â Â Â <span class=\"hljs-comment\">//ç¼–ç å™¨ç ç‡ï¼Œå¸§ç‡ï¼Œgopï¼Œåˆ†è¾¨ç‡, è®¾ç½®</span><br>Â Â Â Â Â Â Â Â ...<br>        <span class=\"hljs-keyword\">break</span>;<br><br>    <span class=\"hljs-keyword\">default</span>:<br>        <span class=\"hljs-keyword\">break</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">/* Some formats want stream headers to be separate. */</span><br>Â Â Â Â <span class=\"hljs-comment\">//å¤„ç†ä¸€ä¸‹stream header</span><br>    <span class=\"hljs-keyword\">if</span> (oc-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)<br>        c-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>æ ¹æ®codec_idæ‰¾åˆ°AVCodec</p>\n</li>\n<li><p>è°ƒç”¨avformat_new_streamåˆ›å»ºstream</p>\n</li>\n<li><p>è®¾ç½®streamçš„index</p>\n</li>\n<li><p>æ ¹æ®AVCodecåˆ›å»ºç¼–ç å™¨çš„ä¸Šä¸‹æ–‡ï¼Œé…ç½®ç¼–ç å™¨å‚æ•°</p>\n</li>\n<li><p>è®¾ç½®streamçš„time_base</p>\n</li>\n<li><p>å¤„ç†ä¸€ä¸‹ stream headers çš„æ ‡å¿—ä½</p>\n</li>\n</ol>\n<h2 id=\"éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡\"><a href=\"#éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡\" class=\"headerlink\" title=\"éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡\"></a>éŸ³è§†é¢‘æµåˆ›å»ºå¥½äº†ï¼Œä¸‹ä¸€æ­¥ä¸ºå†™å…¥å‡†å¤‡</h2><ol>\n<li><p>ä¸Šé¢åˆ›å»ºå¥½äº†stream, åˆ›å»ºäº†ç¼–ç å™¨ä¸Šä¸‹æ–‡ã€‚open_video&#x2F;open_audioç»§ç»­ä¸ºå†™å…¥åšå‡†å¤‡</p>\n</li>\n<li><p>å‡†å¤‡å®Œæˆå°±æ‰“å¼€æ–‡ä»¶å‡†å¤‡å†™å…¥</p>\n</li>\n</ol>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Now that all the parameters are set, we can open the audio and</span><br><span class=\"hljs-comment\"> * video codecs and allocate the necessary encode buffers. */</span><br><span class=\"hljs-keyword\">if</span> (have_video)<br>    open_video(oc, video_codec, &amp;video_st, opt);<br><br><span class=\"hljs-keyword\">if</span> (have_audio)<br>    open_audio(oc, audio_codec, &amp;audio_st, opt);<br><br><span class=\"hljs-comment\">//æ‰“å°ocçš„ä¿¡æ¯</span><br>av_dump_format(oc, <span class=\"hljs-number\">0</span>, filename, <span class=\"hljs-number\">1</span>);<br><br><span class=\"hljs-comment\">/* open the output file, if needed */</span><br><span class=\"hljs-keyword\">if</span> (!(fmt-&gt;flags &amp; AVFMT_NOFILE)) &#123;<br>    <span class=\"hljs-comment\">//æ‰“å¼€æ–‡ä»¶</span><br>    ret = avio_open(&amp;oc-&gt;pb, filename, AVIO_FLAG_WRITE);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open &#x27;%s&#x27;: %s\\n&quot;</span>, filename,<br>                av_err2str(ret));<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>çœ‹çœ‹open_video åšäº†ä»€ä¹ˆ</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">open_video</span><span class=\"hljs-params\">(AVFormatContext *oc, <span class=\"hljs-type\">const</span> AVCodec *codec,</span><br><span class=\"hljs-params\">                       OutputStream *ost, AVDictionary *opt_arg)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret;<br>    AVCodecContext *c = ost-&gt;enc;<br>    AVDictionary *opt = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-comment\">//å°†opt_argä¸­çš„å†…å®¹æ‹·è´åˆ°optä¸­</span><br>    av_dict_copy(&amp;opt, opt_arg, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-comment\">/* open the codec */</span><br>    <span class=\"hljs-comment\">//æ‰“å¼€ç¼–ç å™¨</span><br>    ret = avcodec_open2(c, codec, &amp;opt);<br>    <span class=\"hljs-comment\">//é‡Šæ”¾opt</span><br>    av_dict_free(&amp;opt);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not open video codec: %s\\n&quot;</span>, av_err2str(ret));<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* allocate and init a re-usable frame */</span><br>    <span class=\"hljs-comment\">//æ ¹æ®æ ¼å¼ï¼Œå®½é«˜ï¼Œåˆ›å»ºä¸€ä¸ªå¤ç”¨çš„AVFrame</span><br>    ost-&gt;frame = alloc_picture(c-&gt;pix_fmt, c-&gt;width, c-&gt;height);<br>    <span class=\"hljs-keyword\">if</span> (!ost-&gt;frame) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate video frame\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* If the output format is not YUV420P, then a temporary YUV420P</span><br><span class=\"hljs-comment\">     * picture is needed too. It is then converted to the required</span><br><span class=\"hljs-comment\">     * output format. */</span><br>    ost-&gt;tmp_frame = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-keyword\">if</span> (c-&gt;pix_fmt != AV_PIX_FMT_YUV420P) &#123;<br>        <span class=\"hljs-comment\">//å¦‚æœç¼–ç å™¨å¯¹åº”çš„pix_fmtä¸æ˜¯yuv420pï¼Œ åˆ›å»ºä¸€ä¸ªyuv420pæ ¼å¼çš„AVFrameï¼Œä¿å­˜åœ¨ost-&gt;tmp_frameä¸­</span><br>        ost-&gt;tmp_frame = alloc_picture(AV_PIX_FMT_YUV420P, c-&gt;width, c-&gt;height);<br>        <span class=\"hljs-keyword\">if</span> (!ost-&gt;tmp_frame) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not allocate temporary picture\\n&quot;</span>);<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* copy the stream parameters to the muxer */</span><br>    <span class=\"hljs-comment\">//å°†ç¼–ç å™¨çš„å‚æ•°æ‹·è´åˆ°streamå¯¹åº”çš„ç¼–ç å‚æ•°ä¸­</span><br>    ret = avcodec_parameters_from_context(ost-&gt;st-&gt;codecpar, c);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Could not copy the stream parameters\\n&quot;</span>);<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>æ‰“å¼€ç¼–ç å™¨</p>\n</li>\n<li><p>ç”³è¯·èµ„æºï¼Œåˆ›å»ºä¸€ä¸ªAVFrameç”¨äºå­˜å‚¨ç¼–ç å‰æ•°æ®</p>\n</li>\n<li><p>è°ƒç”¨avcodec_parameters_from_contextå°†ç¼–ç å™¨çš„ç¼–ç å‚æ•°æ‹·è´åˆ°streamçš„codecparä¸­</p>\n</li>\n</ol>\n<h2 id=\"å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶\"><a href=\"#å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶\" class=\"headerlink\" title=\"å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶\"></a>å†™éŸ³è§†é¢‘æ•°æ®åˆ°æ–‡ä»¶</h2><p>å†™æ–‡ä»¶å¤´</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Write the stream header, if any. */</span><br><span class=\"hljs-comment\">//å°†æµä¿¡æ¯å†™æ–‡ä»¶å¤´</span><br>ret = avformat_write_header(oc, &amp;opt);<br><span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>    <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error occurred when opening output file: %s\\n&quot;</span>,<br>            av_err2str(ret));<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>äº¤æ›¿å†™éŸ³è§†é¢‘å¸§</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">while</span> (encode_video || encode_audio) &#123;<br>    <span class=\"hljs-comment\">/* select the stream to encode */</span><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     äº¤æ›¿å†™å…¥ç¼–ç åçš„éŸ³é¢‘å’Œè§†é¢‘å¸§</span><br><span class=\"hljs-comment\">     è§†é¢‘å†™å…¥ç»“æŸæˆ–è€…video_st.next_pts &lt;= audio_st.next_pts, å†™è§†é¢‘</span><br><span class=\"hljs-comment\">     å¦åˆ™å†™éŸ³é¢‘</span><br><span class=\"hljs-comment\">    */</span><br>    <span class=\"hljs-keyword\">if</span> (encode_video &amp;&amp;<br>        (!encode_audio || av_compare_ts(video_st.next_pts, video_st.enc-&gt;time_base,<br>                                        audio_st.next_pts, audio_st.enc-&gt;time_base) &lt;= <span class=\"hljs-number\">0</span>)) &#123;<br>        <span class=\"hljs-comment\">//å†™å…¥ç¼–ç åçš„è§†é¢‘å¸§</span><br>        encode_video = !write_video_frame(oc, &amp;video_st);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-comment\">//å†™å…¥ç¼–ç åçš„éŸ³é¢‘å¸§</span><br>        encode_audio = !write_audio_frame(oc, &amp;audio_st);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p> å†™trailer</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Write the trailer, if any. The trailer must be written before you</span><br><span class=\"hljs-comment\"> * close the CodecContexts open when you wrote the header; otherwise</span><br><span class=\"hljs-comment\"> * av_write_trailer() may try to use memory that was freed on</span><br><span class=\"hljs-comment\"> * av_codec_close(). */</span><br>av_write_trailer(oc);<br></code></pre></td></tr></table></figure>\n\n<p>å…³é—­ç¼–ç å™¨ï¼Œå…³é—­æ–‡ä»¶ï¼Œé‡Šæ”¾èµ„æº</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Close each codec. */</span><br><span class=\"hljs-keyword\">if</span> (have_video)<br>    close_stream(oc, &amp;video_st);<br><span class=\"hljs-keyword\">if</span> (have_audio)<br>    close_stream(oc, &amp;audio_st);<br><br><span class=\"hljs-keyword\">if</span> (!(fmt-&gt;flags &amp; AVFMT_NOFILE))<br>    <span class=\"hljs-comment\">/* Close the output file. */</span><br>    avio_closep(&amp;oc-&gt;pb);<br><br><span class=\"hljs-comment\">/* free the stream */</span><br>avformat_free_context(oc);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"write-video-frame\"><a href=\"#write-video-frame\" class=\"headerlink\" title=\"write_video_frame\"></a>write_video_frame</h3><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static int write_video_frame(AVFormatContext *oc, OutputStream *ost)<br>&#123;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">return</span> write_frame(oc, ost-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">enc</span>, ost-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">st</span>, get_video_frame(ost), ost-&gt;</span>tmp_pkt);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åªæ˜¯ç®€å•è°ƒç”¨äº†write_frame</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">write_frame</span><span class=\"hljs-params\">(AVFormatContext *fmt_ctx, AVCodecContext *c,</span><br><span class=\"hljs-params\">                       AVStream *st, AVFrame *frame, AVPacket *pkt)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> ret;<br><br>    <span class=\"hljs-comment\">// send the frame to the encoder</span><br>    <span class=\"hljs-comment\">//å°†frameé€ç»™ç¼–ç å™¨å»ç¼–ç </span><br>    ret = avcodec_send_frame(c, frame);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error sending a frame to the encoder: %s\\n&quot;</span>,<br>                av_err2str(ret));<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>    &#125;<br><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//ä»ç¼–ç å™¨ä¸­è¯»å‡ºç¼–ç åçš„pkt</span><br>        ret = avcodec_receive_packet(c, pkt);<br>        <span class=\"hljs-keyword\">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)<br>            <span class=\"hljs-keyword\">break</span>;<br>        <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error encoding a frame: %s\\n&quot;</span>, av_err2str(ret));<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br><br>        <span class=\"hljs-comment\">/* rescale output packet timestamp values from codec to stream timebase */</span><br>        <span class=\"hljs-comment\">//è°ƒæ•´pktçš„ptsï¼Œpktçš„æ—¶é—´åŸºå‚ç¼–ç å™¨çš„æ—¶é—´åŸºï¼Œå°†å…¶è½¬æ¢ä¸ºå‚è€ƒstreamçš„æ—¶é—´åŸº</span><br>        av_packet_rescale_ts(pkt, c-&gt;time_base, st-&gt;time_base);<br>        <span class=\"hljs-comment\">//è®¾ç½®pktçš„stream_indexå’Œstreamå¯¹åº”çš„ä¸€è‡´ï¼ŒéŸ³è§†é¢‘åˆ†åˆ«å¯¹åº”äºä¸åŒçš„stream_index</span><br>        pkt-&gt;stream_index = st-&gt;index;<br><br>        <span class=\"hljs-comment\">/* Write the compressed frame to the media file. */</span><br>        log_packet(fmt_ctx, pkt);<br>        <span class=\"hljs-comment\">//å°†pktå†™å…¥è§†é¢‘æ–‡ä»¶</span><br>        ret = av_interleaved_write_frame(fmt_ctx, pkt);<br>        <span class=\"hljs-comment\">/* pkt is now blank (av_interleaved_write_frame() takes ownership of</span><br><span class=\"hljs-comment\">         * its contents and resets pkt), so that no unreferencing is necessary.</span><br><span class=\"hljs-comment\">         * This would be different if one used av_write_frame(). */</span><br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error while writing output packet: %s\\n&quot;</span>, av_err2str(ret));<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">return</span> ret == AVERROR_EOF ? <span class=\"hljs-number\">1</span> : <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å°†AVFrameé€ç»™ç¼–ç å™¨å»ç¼–ç </p>\n</li>\n<li><p>è¯»å–pkt</p>\n</li>\n<li><p>è°ƒç”¨av_packet_rescale_tsï¼Œè°ƒæ•´pktçš„æ—¶é—´æˆ³ï¼Œå†™å…¥æ–‡ä»¶pktçš„ptsè¦ä»¥streamçš„time_baseä¸ºåŸºå‡†</p>\n</li>\n<li><p>è®¾ç½®pktçš„index</p>\n</li>\n<li><p>è°ƒç”¨av_interleaved_write_frameå°†pktå†™å…¥æ–‡ä»¶</p>\n</li>\n<li><p>è¿”å›å†™å…¥ç»“æœã€‚å½“AVFrameä¸ºç©ºæ—¶ï¼Œä¼šå†²æ´—ç¼–ç å™¨ï¼Œret &#x3D; AVERROR_EOFï¼Œ è¿”å›1ï¼Œ ç»“æŸå†™å…¥</p>\n</li>\n</ol>\n<p>frameçš„æ¯ä¸€å¸§æ•°æ®ï¼Œæ˜¯æ¥è‡ªäºget_video_frameæ–¹æ³•, å¡«å……çš„å‡æ•°æ®</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> AVFrame *<span class=\"hljs-title function_\">get_video_frame</span><span class=\"hljs-params\">(OutputStream *ost)</span><br>&#123;<br>    AVCodecContext *c = ost-&gt;enc;<br><br>    <span class=\"hljs-comment\">/* check if we want to generate more frames */</span><br>    <span class=\"hljs-keyword\">if</span> (av_compare_ts(ost-&gt;next_pts, c-&gt;time_base,<br>                      STREAM_DURATION, (AVRational)&#123; <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span> &#125;) &gt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;<br><br>    <span class=\"hljs-comment\">/* when we pass a frame to the encoder, it may keep a reference to it</span><br><span class=\"hljs-comment\">     * internally; make sure we do not overwrite it here */</span><br>    <span class=\"hljs-keyword\">if</span> (av_frame_make_writable(ost-&gt;frame) &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br><br>    <span class=\"hljs-keyword\">if</span> (c-&gt;pix_fmt != AV_PIX_FMT_YUV420P) &#123;<br>        <span class=\"hljs-comment\">/* as we only generate a YUV420P picture, we must convert it</span><br><span class=\"hljs-comment\">         * to the codec pixel format if needed */</span><br>        <span class=\"hljs-keyword\">if</span> (!ost-&gt;sws_ctx) &#123;<br>            ost-&gt;sws_ctx = sws_getContext(c-&gt;width, c-&gt;height,<br>                                          AV_PIX_FMT_YUV420P,<br>                                          c-&gt;width, c-&gt;height,<br>                                          c-&gt;pix_fmt,<br>                                          SCALE_FLAGS, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>);<br>            <span class=\"hljs-keyword\">if</span> (!ost-&gt;sws_ctx) &#123;<br>                <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>,<br>                        <span class=\"hljs-string\">&quot;Could not initialize the conversion context\\n&quot;</span>);<br>                <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>            &#125;<br>        &#125;<br>        fill_yuv_image(ost-&gt;tmp_frame, ost-&gt;next_pts, c-&gt;width, c-&gt;height);<br>        sws_scale(ost-&gt;sws_ctx, (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint8_t</span> * <span class=\"hljs-type\">const</span> *) ost-&gt;tmp_frame-&gt;data,<br>                  ost-&gt;tmp_frame-&gt;linesize, <span class=\"hljs-number\">0</span>, c-&gt;height, ost-&gt;frame-&gt;data,<br>                  ost-&gt;frame-&gt;linesize);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        fill_yuv_image(ost-&gt;frame, ost-&gt;next_pts, c-&gt;width, c-&gt;height);<br>    &#125;<br><br>    ost-&gt;frame-&gt;pts = ost-&gt;next_pts++;<br><br>    <span class=\"hljs-keyword\">return</span> ost-&gt;frame;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è°ƒç”¨av_compare_ts åˆ¤æ–­æ˜¯å¦ç»§ç»­ç”Ÿæˆæ–°çš„frameï¼Œä¸€å¼€å§‹è§„å®šäº†åªå†™10ç§’é’Ÿçš„æ•°æ®ï¼Œè¶…è¿‡äº†å°±ä¸å†™äº†</p>\n</li>\n<li><p>av_frame_make_writableä½¿å½“å‰çš„frameå¯å†™ï¼Œè¢«ç¼–ç å™¨å¼•ç”¨çš„frameä¸å¯å†™ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å¦‚æœè¢«å¼•ç”¨ï¼Œå†…éƒ¨ä¼šåˆ›å»ºæ–°bufï¼Œå˜æˆå¯å†™çš„</p>\n</li>\n<li><p>å¡«å……æ•°æ®yuvï¼Œè¿˜åšäº†ç¼©æ”¾å¤„ç†ï¼Œæš‚ä¸è®¨è®º</p>\n</li>\n<li><p>æ›´æ–°frameçš„pts</p>\n</li>\n<li><p>è¿”å›ç”Ÿæˆçš„frame</p>\n</li>\n</ol>\n<p>write_audio_frame</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\"> * encode one audio frame and send it to the muxer</span><br><span class=\"hljs-comment\"> * return 1 when encoding is finished, 0 otherwise</span><br><span class=\"hljs-comment\"> */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">write_audio_frame</span><span class=\"hljs-params\">(AVFormatContext *oc, OutputStream *ost)</span><br>&#123;<br>    AVCodecContext *c;<br>    AVFrame *frame;<br>    <span class=\"hljs-type\">int</span> ret;<br>    <span class=\"hljs-type\">int</span> dst_nb_samples;<br><br>    c = ost-&gt;enc;<br><br>    <span class=\"hljs-comment\">//è·å–éŸ³é¢‘å¸§</span><br>    frame = get_audio_frame(ost);   <br><br>    <span class=\"hljs-keyword\">if</span> (frame) &#123;<br>        <span class=\"hljs-comment\">/* convert samples from native format to destination codec format, using the resampler */</span><br>        <span class=\"hljs-comment\">/* compute destination number of samples */</span><br><br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">        è®¡ç®—æ ¹æ®é‡é‡‡æ ·ååº”è¯¥ç”Ÿæˆçš„é‡‡æ ·ä¸ªæ•°</span><br><span class=\"hljs-comment\">        */</span><br>        dst_nb_samples = av_rescale_rnd(swr_get_delay(ost-&gt;swr_ctx, c-&gt;sample_rate) + frame-&gt;nb_samples,<br>                                        c-&gt;sample_rate, c-&gt;sample_rate, AV_ROUND_UP);<br>        <span class=\"hljs-comment\">//ç”±äºæ²¡æœ‰ä¿®æ”¹é‡‡æ ·ç‡ï¼Œåªæ˜¯ä¿®æ”¹äº†ä½æ·±ï¼Œé‡‡æ ·ä¸ªæ•°ä¿æŒä¸å˜</span><br>        av_assert0(dst_nb_samples == frame-&gt;nb_samples);<br><br>        <span class=\"hljs-comment\">/* when we pass a frame to the encoder, it may keep a reference to it</span><br><span class=\"hljs-comment\">         * internally;</span><br><span class=\"hljs-comment\">         * make sure we do not overwrite it here</span><br><span class=\"hljs-comment\">         */</span><br>        <span class=\"hljs-comment\">//ä½¿ost-&gt;frameå¯å†™</span><br>        ret = av_frame_make_writable(ost-&gt;frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br><br>        <span class=\"hljs-comment\">/* convert to destination format */</span><br>        <span class=\"hljs-comment\">//é‡é‡‡æ ·</span><br>        ret = swr_convert(ost-&gt;swr_ctx,<br>                          ost-&gt;frame-&gt;data, dst_nb_samples,<br>                          (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint8_t</span> **)frame-&gt;data, frame-&gt;nb_samples);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(<span class=\"hljs-built_in\">stderr</span>, <span class=\"hljs-string\">&quot;Error while converting\\n&quot;</span>);<br>            <span class=\"hljs-built_in\">exit</span>(<span class=\"hljs-number\">1</span>);<br>        &#125;<br><br>        frame = ost-&gt;frame;<br>        <span class=\"hljs-comment\">//é‡æ–°è®¡ç®—éŸ³é¢‘pts</span><br>        frame-&gt;pts = av_rescale_q(ost-&gt;samples_count, (AVRational)&#123;<span class=\"hljs-number\">1</span>, c-&gt;sample_rate&#125;, c-&gt;time_base);<br>        <span class=\"hljs-comment\">//è®¡ç®—samples_count</span><br>        ost-&gt;samples_count += dst_nb_samples;<br>    &#125;<br>    <span class=\"hljs-comment\">//å°†éŸ³é¢‘å¸§å†™å…¥æ–‡ä»¶</span><br>    <span class=\"hljs-keyword\">return</span> write_frame(oc, c, ost-&gt;st, frame, ost-&gt;tmp_pkt);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å‡†å¤‡AVFrameï¼Œè°ƒç”¨get_audio_frameè·å–ä¸€ä¸ªAVFrameï¼Œå†…éƒ¨æ ¹æ®ç¼–ç æ ¼å¼ï¼Œå¡«å……pcmå‡æ•°æ®</p>\n</li>\n<li><p>è°ƒç”¨av_rescale_rndè®¡ç®—é‡é‡‡æ ·ä¸ªæ•°ï¼Œå¦‚æœæ•°æ®æºå’Œé€å…¥ç¼–ç å™¨çš„éŸ³é¢‘çš„é‡‡æ ·ç‡ä¸åŒï¼Œéœ€è¦è½¬æ¢é‡‡æ ·ç‡ï¼Œç¤ºä¾‹ç¨‹åºåªæ˜¯å˜äº†é‡‡æ ·æ ¼å¼ï¼Œæ²¡æœ‰æ›´æ”¹é‡‡æ ·ç‡ï¼Œé‡‡æ ·ä¸ªæ•°ä¸å˜</p>\n</li>\n<li><p>åšé‡é‡‡æ ·ï¼Œé‡é‡‡æ ·æ•°æ®ä¿å­˜åœ¨ost-&gt;frameä¸­</p>\n</li>\n<li><p>é‡é‡‡æ ·åï¼Œéœ€è¦æ›´æ–°frameçš„pts</p>\n</li>\n<li><p>è°ƒç”¨write_frameç¼–ç ï¼Œå°†æ•°æ®å†™å…¥æ–‡ä»¶</p>\n</li>\n</ol>\n<h2 id=\"æ€»ç»“ï¼š\"><a href=\"#æ€»ç»“ï¼š\" class=\"headerlink\" title=\"æ€»ç»“ï¼š\"></a>æ€»ç»“ï¼š</h2><p>å­¦ä¹ äº†é€šè¿‡åº”ç”¨libavformatå°†éŸ³è§†é¢‘æ•°æ®ç¼–ç å°è£…åˆ°æ–‡ä»¶ä¸­</p>\n<ol>\n<li><p>åˆ›å»ºAVFormatContext</p>\n</li>\n<li><p>æ·»åŠ stream</p>\n</li>\n<li><p>é…ç½®ç¼–è§£ç å™¨ï¼Œstream å‚æ•°</p>\n</li>\n<li><p>ç¼–ç frameï¼Œç”Ÿæˆpktï¼Œæ›´æ–°pts</p>\n</li>\n<li><p>äº¤æ›¿å†™éŸ³è§†é¢‘pkt</p>\n</li>\n<li><p>å…³é—­ç¼–è§£ç å™¨ï¼Œç»“æŸå†™æ–‡ä»¶</p>\n</li>\n</ol>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1>"},{"layout":"post","title":"ffmpeg+nginx+rtmpæ­å»ºæœ¬åœ°æ¨æµæœåŠ¡å™¨","date":"2022-03-12T16:00:00.000Z","_content":"\n## å®‰è£…[nginx](https://github.com/denji/homebrew-nginx)+[rtmp](https://github.com/sergey-dryabzhinsky/nginx-rtmp-module)\n\n```\nbrew tap denji/nginx\nbrew install nginx-full --with-rtmp-module\n```\n\n## é…ç½®`nginx.conf`,è·¯å¾„`/opt/homebrew/etc/nginx/nginx.conf`\n\n```\nrtmp {\n    server {\n        listen 1935;\n        chunk_size 4096;\n\n        # live on\n        application rtmp_live {\n            live on;\n            # hls on; #è¿™ä¸ªå‚æ•°æŠŠç›´æ’­æœåŠ¡å™¨æ”¹é€ æˆå®æ—¶å›æ”¾æœåŠ¡å™¨ã€‚\n            # wait_key on; #å¯¹è§†é¢‘åˆ‡ç‰‡è¿›è¡Œä¿æŠ¤ï¼Œè¿™æ ·å°±ä¸ä¼šäº§ç”Ÿé©¬èµ›å…‹äº†ã€‚\n            # hls_path ./sbin/html; #åˆ‡ç‰‡è§†é¢‘æ–‡ä»¶å­˜æ”¾ä½ç½®ã€‚\n            # hls_fragment 10s;     #æ¯ä¸ªè§†é¢‘åˆ‡ç‰‡çš„æ—¶é•¿ã€‚\n            # hls_playlist_length 60s;  #æ€»å…±å¯ä»¥å›çœ‹çš„æ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®çš„æ˜¯1åˆ†é’Ÿã€‚\n            # hls_continuous on; #è¿ç»­æ¨¡å¼ã€‚\n            # hls_cleanup on;    #å¯¹å¤šä½™çš„åˆ‡ç‰‡è¿›è¡Œåˆ é™¤ã€‚\n            # hls_nested on;     #åµŒå¥—æ¨¡å¼ã€‚\n        }\n\n        # play videos\n        application rtmp_play{\n            play ./videos;  #build directory\n        }\n    }\n}\n```\n\næ›´å¤šé…ç½®å‚è€ƒ:[example-nginxconf](https://github.com/sergey-dryabzhinsky/nginx-rtmp-module#example-nginxconf)\n\n### é‡å¯ nginx\n\n```\nReload config:\n $ nginx -s reload\nReopen Logfile:\n $ nginx -s reopen\nStop process:\n $ nginx -s stop\nWaiting on exit process\n $ nginx -s quit\n```\n\n## ä½¿ç”¨ffmpeg æ¨æµ\n\n```\nffmpeg -re -i test.flv -vcodec libx264 -acodec aac -strict -2 -f flv rtmp://localhost:1935/$app/$name\n```\n\nä¸Šé¢å®šä¹‰çš„appå«rtmp_liveï¼Œå‡è®¾name=video\n\n```\nffmpeg -re -i test.flv -vcodec libx264 -acodec aac -strict -2 -f flv rtmp://localhost:1935/rtmp_live/video\n```\n\n## ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ\n\n```\nffplay rtmp://localhost:1935/rtmp_live/video\n```\n\n---\n\nå‚è€ƒï¼š\n\n[MACOSä¸Šæ­å»ºnginx+rtmpç¯å¢ƒ](https://github.com/guoxiaopang/LiveExplanation/blob/master/MACOS%E4%B8%8A%E6%90%AD%E5%BB%BAnginx%2Brtmp%E7%8E%AF%E5%A2%83.md)\n\n\n","source":"_posts/ffmpeg/2022-03-13-ffmpeg+nginx+rtmpæ­å»ºæ¨æµæœåŠ¡å™¨.md","raw":"---\nlayout: post\ntitle: \"ffmpeg+nginx+rtmpæ­å»ºæœ¬åœ°æ¨æµæœåŠ¡å™¨\"\ndate: 2022-03-13 \ntag: ffmpeg\n---\n\n## å®‰è£…[nginx](https://github.com/denji/homebrew-nginx)+[rtmp](https://github.com/sergey-dryabzhinsky/nginx-rtmp-module)\n\n```\nbrew tap denji/nginx\nbrew install nginx-full --with-rtmp-module\n```\n\n## é…ç½®`nginx.conf`,è·¯å¾„`/opt/homebrew/etc/nginx/nginx.conf`\n\n```\nrtmp {\n    server {\n        listen 1935;\n        chunk_size 4096;\n\n        # live on\n        application rtmp_live {\n            live on;\n            # hls on; #è¿™ä¸ªå‚æ•°æŠŠç›´æ’­æœåŠ¡å™¨æ”¹é€ æˆå®æ—¶å›æ”¾æœåŠ¡å™¨ã€‚\n            # wait_key on; #å¯¹è§†é¢‘åˆ‡ç‰‡è¿›è¡Œä¿æŠ¤ï¼Œè¿™æ ·å°±ä¸ä¼šäº§ç”Ÿé©¬èµ›å…‹äº†ã€‚\n            # hls_path ./sbin/html; #åˆ‡ç‰‡è§†é¢‘æ–‡ä»¶å­˜æ”¾ä½ç½®ã€‚\n            # hls_fragment 10s;     #æ¯ä¸ªè§†é¢‘åˆ‡ç‰‡çš„æ—¶é•¿ã€‚\n            # hls_playlist_length 60s;  #æ€»å…±å¯ä»¥å›çœ‹çš„æ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®çš„æ˜¯1åˆ†é’Ÿã€‚\n            # hls_continuous on; #è¿ç»­æ¨¡å¼ã€‚\n            # hls_cleanup on;    #å¯¹å¤šä½™çš„åˆ‡ç‰‡è¿›è¡Œåˆ é™¤ã€‚\n            # hls_nested on;     #åµŒå¥—æ¨¡å¼ã€‚\n        }\n\n        # play videos\n        application rtmp_play{\n            play ./videos;  #build directory\n        }\n    }\n}\n```\n\næ›´å¤šé…ç½®å‚è€ƒ:[example-nginxconf](https://github.com/sergey-dryabzhinsky/nginx-rtmp-module#example-nginxconf)\n\n### é‡å¯ nginx\n\n```\nReload config:\n $ nginx -s reload\nReopen Logfile:\n $ nginx -s reopen\nStop process:\n $ nginx -s stop\nWaiting on exit process\n $ nginx -s quit\n```\n\n## ä½¿ç”¨ffmpeg æ¨æµ\n\n```\nffmpeg -re -i test.flv -vcodec libx264 -acodec aac -strict -2 -f flv rtmp://localhost:1935/$app/$name\n```\n\nä¸Šé¢å®šä¹‰çš„appå«rtmp_liveï¼Œå‡è®¾name=video\n\n```\nffmpeg -re -i test.flv -vcodec libx264 -acodec aac -strict -2 -f flv rtmp://localhost:1935/rtmp_live/video\n```\n\n## ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ\n\n```\nffplay rtmp://localhost:1935/rtmp_live/video\n```\n\n---\n\nå‚è€ƒï¼š\n\n[MACOSä¸Šæ­å»ºnginx+rtmpç¯å¢ƒ](https://github.com/guoxiaopang/LiveExplanation/blob/master/MACOS%E4%B8%8A%E6%90%AD%E5%BB%BAnginx%2Brtmp%E7%8E%AF%E5%A2%83.md)\n\n\n","slug":"ffmpeg/2022-03-13-ffmpeg+nginx+rtmpæ­å»ºæ¨æµæœåŠ¡å™¨","published":1,"updated":"2024-03-06T11:53:13.565Z","comments":1,"photos":[],"_id":"clti3glkq001z57wh2m4e99hd","content":"<h2 id=\"å®‰è£…nginx-rtmp\"><a href=\"#å®‰è£…nginx-rtmp\" class=\"headerlink\" title=\"å®‰è£…nginx+rtmp\"></a>å®‰è£…<a href=\"https://github.com/denji/homebrew-nginx\">nginx</a>+<a href=\"https://github.com/sergey-dryabzhinsky/nginx-rtmp-module\">rtmp</a></h2><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs clean\">brew tap denji/nginx<br>brew install nginx-full --<span class=\"hljs-keyword\">with</span>-rtmp-<span class=\"hljs-keyword\">module</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"é…ç½®nginx-conf-è·¯å¾„-opt-homebrew-etc-nginx-nginx-conf\"><a href=\"#é…ç½®nginx-conf-è·¯å¾„-opt-homebrew-etc-nginx-nginx-conf\" class=\"headerlink\" title=\"é…ç½®nginx.conf,è·¯å¾„/opt/homebrew/etc/nginx/nginx.conf\"></a>é…ç½®<code>nginx.conf</code>,è·¯å¾„<code>/opt/homebrew/etc/nginx/nginx.conf</code></h2><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs clean\">rtmp &#123;<br>    server &#123;<br>        listen <span class=\"hljs-number\">1935</span>;<br>        chunk_size <span class=\"hljs-number\">4096</span>;<br><br>        # live on<br>        application rtmp_live &#123;<br>            live on;<br>            # hls on; #è¿™ä¸ªå‚æ•°æŠŠç›´æ’­æœåŠ¡å™¨æ”¹é€ æˆå®æ—¶å›æ”¾æœåŠ¡å™¨ã€‚<br>            # wait_key on; #å¯¹è§†é¢‘åˆ‡ç‰‡è¿›è¡Œä¿æŠ¤ï¼Œè¿™æ ·å°±ä¸ä¼šäº§ç”Ÿé©¬èµ›å…‹äº†ã€‚<br>            # hls_path ./sbin/html; #åˆ‡ç‰‡è§†é¢‘æ–‡ä»¶å­˜æ”¾ä½ç½®ã€‚<br>            # hls_fragment <span class=\"hljs-number\">10</span>s;     #æ¯ä¸ªè§†é¢‘åˆ‡ç‰‡çš„æ—¶é•¿ã€‚<br>            # hls_playlist_length <span class=\"hljs-number\">60</span>s;  #æ€»å…±å¯ä»¥å›çœ‹çš„æ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®çš„æ˜¯<span class=\"hljs-number\">1</span>åˆ†é’Ÿã€‚<br>            # hls_continuous on; #è¿ç»­æ¨¡å¼ã€‚<br>            # hls_cleanup on;    #å¯¹å¤šä½™çš„åˆ‡ç‰‡è¿›è¡Œåˆ é™¤ã€‚<br>            # hls_nested on;     #åµŒå¥—æ¨¡å¼ã€‚<br>        &#125;<br><br>        # play videos<br>        application rtmp_play&#123;<br>            play ./videos;  #build directory<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ›´å¤šé…ç½®å‚è€ƒ:<a href=\"https://github.com/sergey-dryabzhinsky/nginx-rtmp-module#example-nginxconf\">example-nginxconf</a></p>\n<h3 id=\"é‡å¯-nginx\"><a href=\"#é‡å¯-nginx\" class=\"headerlink\" title=\"é‡å¯ nginx\"></a>é‡å¯ nginx</h3><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">Reload config:<br> $ nginx -s reload<br>Reopen Logfile:<br> $ nginx -s reopen<br>Stop process:<br> $ nginx -s stop<br>Waiting on <span class=\"hljs-keyword\">exit</span> process<br> $ nginx -s quit<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ä½¿ç”¨ffmpeg-æ¨æµ\"><a href=\"#ä½¿ç”¨ffmpeg-æ¨æµ\" class=\"headerlink\" title=\"ä½¿ç”¨ffmpeg æ¨æµ\"></a>ä½¿ç”¨ffmpeg æ¨æµ</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">ffmpeg -re -i test.flv -vcodec libx264 -acodec aac -strict -<span class=\"hljs-number\">2</span> -f flv rtmp:<span class=\"hljs-regexp\">//</span>localhost:<span class=\"hljs-number\">1935</span><span class=\"hljs-regexp\">/$app/</span><span class=\"hljs-variable\">$name</span><br></code></pre></td></tr></table></figure>\n\n<p>ä¸Šé¢å®šä¹‰çš„appå«rtmp_liveï¼Œå‡è®¾name&#x3D;video</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -re -<span class=\"hljs-selector-tag\">i</span> test<span class=\"hljs-selector-class\">.flv</span> -vcodec libx264 -acodec aac -strict -<span class=\"hljs-number\">2</span> -f flv rtmp:<span class=\"hljs-comment\">//localhost:1935/rtmp_live/video</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ\"><a href=\"#ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ\" class=\"headerlink\" title=\"ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ\"></a>ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">ffplay rtmp:<span class=\"hljs-regexp\">//</span>localhost:<span class=\"hljs-number\">1935</span><span class=\"hljs-regexp\">/rtmp_live/</span>video<br></code></pre></td></tr></table></figure>\n\n<hr>\n<p>å‚è€ƒï¼š</p>\n<p><a href=\"https://github.com/guoxiaopang/LiveExplanation/blob/master/MACOS%E4%B8%8A%E6%90%AD%E5%BB%BAnginx%2Brtmp%E7%8E%AF%E5%A2%83.md\">MACOSä¸Šæ­å»ºnginx+rtmpç¯å¢ƒ</a></p>\n","excerpt":"","more":"<h2 id=\"å®‰è£…nginx-rtmp\"><a href=\"#å®‰è£…nginx-rtmp\" class=\"headerlink\" title=\"å®‰è£…nginx+rtmp\"></a>å®‰è£…<a href=\"https://github.com/denji/homebrew-nginx\">nginx</a>+<a href=\"https://github.com/sergey-dryabzhinsky/nginx-rtmp-module\">rtmp</a></h2><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs clean\">brew tap denji/nginx<br>brew install nginx-full --<span class=\"hljs-keyword\">with</span>-rtmp-<span class=\"hljs-keyword\">module</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"é…ç½®nginx-conf-è·¯å¾„-opt-homebrew-etc-nginx-nginx-conf\"><a href=\"#é…ç½®nginx-conf-è·¯å¾„-opt-homebrew-etc-nginx-nginx-conf\" class=\"headerlink\" title=\"é…ç½®nginx.conf,è·¯å¾„/opt/homebrew/etc/nginx/nginx.conf\"></a>é…ç½®<code>nginx.conf</code>,è·¯å¾„<code>/opt/homebrew/etc/nginx/nginx.conf</code></h2><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs clean\">rtmp &#123;<br>    server &#123;<br>        listen <span class=\"hljs-number\">1935</span>;<br>        chunk_size <span class=\"hljs-number\">4096</span>;<br><br>        # live on<br>        application rtmp_live &#123;<br>            live on;<br>            # hls on; #è¿™ä¸ªå‚æ•°æŠŠç›´æ’­æœåŠ¡å™¨æ”¹é€ æˆå®æ—¶å›æ”¾æœåŠ¡å™¨ã€‚<br>            # wait_key on; #å¯¹è§†é¢‘åˆ‡ç‰‡è¿›è¡Œä¿æŠ¤ï¼Œè¿™æ ·å°±ä¸ä¼šäº§ç”Ÿé©¬èµ›å…‹äº†ã€‚<br>            # hls_path ./sbin/html; #åˆ‡ç‰‡è§†é¢‘æ–‡ä»¶å­˜æ”¾ä½ç½®ã€‚<br>            # hls_fragment <span class=\"hljs-number\">10</span>s;     #æ¯ä¸ªè§†é¢‘åˆ‡ç‰‡çš„æ—¶é•¿ã€‚<br>            # hls_playlist_length <span class=\"hljs-number\">60</span>s;  #æ€»å…±å¯ä»¥å›çœ‹çš„æ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®çš„æ˜¯<span class=\"hljs-number\">1</span>åˆ†é’Ÿã€‚<br>            # hls_continuous on; #è¿ç»­æ¨¡å¼ã€‚<br>            # hls_cleanup on;    #å¯¹å¤šä½™çš„åˆ‡ç‰‡è¿›è¡Œåˆ é™¤ã€‚<br>            # hls_nested on;     #åµŒå¥—æ¨¡å¼ã€‚<br>        &#125;<br><br>        # play videos<br>        application rtmp_play&#123;<br>            play ./videos;  #build directory<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ›´å¤šé…ç½®å‚è€ƒ:<a href=\"https://github.com/sergey-dryabzhinsky/nginx-rtmp-module#example-nginxconf\">example-nginxconf</a></p>\n<h3 id=\"é‡å¯-nginx\"><a href=\"#é‡å¯-nginx\" class=\"headerlink\" title=\"é‡å¯ nginx\"></a>é‡å¯ nginx</h3><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">Reload config:<br> $ nginx -s reload<br>Reopen Logfile:<br> $ nginx -s reopen<br>Stop process:<br> $ nginx -s stop<br>Waiting on <span class=\"hljs-keyword\">exit</span> process<br> $ nginx -s quit<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ä½¿ç”¨ffmpeg-æ¨æµ\"><a href=\"#ä½¿ç”¨ffmpeg-æ¨æµ\" class=\"headerlink\" title=\"ä½¿ç”¨ffmpeg æ¨æµ\"></a>ä½¿ç”¨ffmpeg æ¨æµ</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">ffmpeg -re -i test.flv -vcodec libx264 -acodec aac -strict -<span class=\"hljs-number\">2</span> -f flv rtmp:<span class=\"hljs-regexp\">//</span>localhost:<span class=\"hljs-number\">1935</span><span class=\"hljs-regexp\">/$app/</span><span class=\"hljs-variable\">$name</span><br></code></pre></td></tr></table></figure>\n\n<p>ä¸Šé¢å®šä¹‰çš„appå«rtmp_liveï¼Œå‡è®¾name&#x3D;video</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -re -<span class=\"hljs-selector-tag\">i</span> test<span class=\"hljs-selector-class\">.flv</span> -vcodec libx264 -acodec aac -strict -<span class=\"hljs-number\">2</span> -f flv rtmp:<span class=\"hljs-comment\">//localhost:1935/rtmp_live/video</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ\"><a href=\"#ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ\" class=\"headerlink\" title=\"ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ\"></a>ä½¿ç”¨ffplayæ‹‰æµæˆ–è€…vlcæ‹‰æµ</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">ffplay rtmp:<span class=\"hljs-regexp\">//</span>localhost:<span class=\"hljs-number\">1935</span><span class=\"hljs-regexp\">/rtmp_live/</span>video<br></code></pre></td></tr></table></figure>\n\n<hr>\n<p>å‚è€ƒï¼š</p>\n<p><a href=\"https://github.com/guoxiaopang/LiveExplanation/blob/master/MACOS%E4%B8%8A%E6%90%AD%E5%BB%BAnginx%2Brtmp%E7%8E%AF%E5%A2%83.md\">MACOSä¸Šæ­å»ºnginx+rtmpç¯å¢ƒ</a></p>\n"},{"layout":"post","title":"ffplay packet queue åˆ†æ","date":"2022-03-13T16:00:00.000Z","_content":"\nå‚è€ƒï¼š [ffplay packet queueåˆ†æ](https://zhuanlan.zhihu.com/p/43295650)\n\n---\n\nffplay  ç”¨ PacketQueue æ¥ä¿å­˜è§£å°è£…åçš„æ•°æ®ï¼Œå³AVPacketã€‚\nå®šä¹‰MyAVPacketListè¡¨ç¤ºé˜Ÿåˆ—ä¸­çš„å…ƒç´ ï¼Œè¿™é‡Œå‘½åä¸ºMyAVPacketNodeå¯èƒ½æ›´åˆç†ã€‚\n\n```c\ntypedef struct MyAVPacketList {\n    //å¾…è§£ç çš„æ•°æ®\n    AVPacket *pkt;\n    //pktåºåˆ—å·\n    int serial;\n} MyAVPacketList;\n\ntypedef struct PacketQueue {\n    /* ffmpegå°è£…çš„é˜Ÿåˆ—æ•°æ®ç»“æ„ï¼Œå…ˆå…¥å…ˆå‡º */\n    AVFifo *pkt_list;\n    /* å½“å‰é˜Ÿé‡Œçš„pktçš„æ•°é‡ */\n    int nb_packets;\n    /* å½“å‰æ‰€æœ‰èŠ‚ç‚¹å ç”¨çš„æ€»å†…å­˜å¤§å° */\n    int size;\n    /* é˜Ÿåˆ—æ‰€æœ‰èŠ‚ç‚¹çš„åˆè®¡æ—¶é•¿ */\n    int64_t duration;\n    /* æ˜¯å¦è¦ä¸­æ­¢é˜Ÿåˆ—æ“ä½œï¼Œç”¨äºå®‰å…¨å¿«é€Ÿé€€å‡ºæ’­æ”¾ */\n    int abort_request;\n    //åºåˆ—å·ï¼Œå’ŒMyAVPacketListçš„serialä½œç”¨ç›¸åŒï¼Œä½†æ”¹å˜çš„æ—¶åºç¨å¾®æœ‰ç‚¹ä¸åŒ\n    int serial;\n    //ç”¨äºç»´æŒPacketQueueçš„å¤šçº¿ç¨‹å®‰å…¨(SDL_mutexå¯ä»¥æŒ‰pthread_mutex_tç†è§£ï¼‰\n    SDL_mutex *mutex;\n    //ç”¨äºè¯»ã€å†™çº¿ç¨‹ç›¸äº’é€šçŸ¥(SDL_condå¯ä»¥æŒ‰pthread_cond_tç†è§£)\n    SDL_cond *cond;\n} PacketQueue;\n```\n\nç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯AVFifoæŒ‡é’ˆç±»å‹çš„ã€‚FFmpeg å®šä¹‰äº†AVFifoç»“æ„ä½“å’Œæ“ä½œè¿™ä¸ªç»“æ„ä½“çš„ä¸€ç³»åˆ—å‡½æ•°ï¼Œå®ç°äº†é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ã€‚PacketQueue æ˜¯å°è£…äº†AVFifo å®ä¾‹ï¼Œæ¥ç®¡ç†MyAVPacketListï¼Œè¿›è€Œç®¡ç†è§£å°è£…åçš„AVPacketçš„ã€‚\n\n## AVFifo\n\n```c\nstruct AVFifo {\n    uint8_t *buffer;\n\n    size_t elem_size, nb_elems;\n    size_t offset_r, offset_w;\n    // distinguishes the ambiguous situation offset_r == offset_w\n    int    is_empty;\n\n    unsigned int flags;\n    size_t       auto_grow_limit;\n};\n```\n\næ“ä½œ\n\n```\nAVFifo *av_fifo_alloc2(size_t elems, size_t elem_size,\n                       unsigned int flags);\n\nint av_fifo_write(AVFifo *f, const void *buf, size_t nb_elems);\n\nint av_fifo_read(AVFifo *f, void *buf, size_t nb_elems);\n\nvoid av_fifo_freep2(AVFifo **f);\n```\n\n- av_fifo_alloc2 åˆ›å»ºé˜Ÿåˆ—\n\n- av_fifo_read ä»é˜Ÿåˆ—ä¸­è¯»ä¸€ä¸ªå…ƒç´ ï¼Œé˜Ÿåˆ—é•¿åº¦å‡ 1\n\n- av_fifo_write ç»™é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œ é˜Ÿåˆ—é•¿åº¦åŠ 1 \n\n- av_fifo_freep2 é”€æ¯é˜Ÿåˆ—\n\n# PacketQueue æ“ä½œå‡½æ•°\n\n`PacketQueue`æ“ä½œæä¾›ä»¥ä¸‹æ–¹æ³•ï¼š\n\n- packet_queue_init:  åˆå§‹åŒ–\n\n- packet_queue_destroyï¼š é”€æ¯\n\n- packet_queue_startï¼š å¼€å¯\n\n- packet_queue_abortï¼š ç»ˆæ­¢\n\n- packet_queue_getï¼š è·å–ä¸€ä¸ªèŠ‚ç‚¹\n\n- packet_queue_putï¼š å­˜å…¥ä¸€ä¸ªèŠ‚ç‚¹\n\n- packet_queue_put_nullpacketï¼š å­˜å…¥ä¸€ä¸ªç©ºèŠ‚ç‚¹\n\n- packet_queue_flushï¼š æ¸…é™¤é˜Ÿåˆ—å†…æ‰€æœ‰çš„èŠ‚ç‚¹\n\n## packet_queue_init\n\n```\nstatic int packet_queue_init(PacketQueue *q)\n{\n    memset(q, 0, sizeof(PacketQueue));\n    q->pkt_list = av_fifo_alloc2(1, sizeof(MyAVPacketList), AV_FIFO_FLAG_AUTO_GROW);\n    if (!q->pkt_list)\n        return AVERROR(ENOMEM);\n    q->mutex = SDL_CreateMutex();\n    if (!q->mutex) {\n        av_log(NULL, AV_LOG_FATAL, \"SDL_CreateMutex(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    q->cond = SDL_CreateCond();\n    if (!q->cond) {\n        av_log(NULL, AV_LOG_FATAL, \"SDL_CreateCond(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    q->abort_request = 1;\n    return 0;\n}\n```\n\n1. å†…éƒ¨è°ƒç”¨av_fifo_alloc2 åˆ›å»ºAVFifo é˜Ÿåˆ—å®ä¾‹\n\n2. åˆ›å»ºmutexç”¨äºé˜Ÿåˆ—å®‰å…¨è®¿é—®\n\n3. åˆ›å»ºcond ç”¨äºé˜Ÿåˆ—ç­‰å¾…å’Œå”¤é†’æ§åˆ¶\n\n4. åˆå§‹è®¾ç½®abort_request = 1\n\n## packet_queue_destroy\n\n```\nstatic void packet_queue_destroy(PacketQueue *q)\n{\n    packet_queue_flush(q);\n    av_fifo_freep2(&q->pkt_list);\n    SDL_DestroyMutex(q->mutex);\n    SDL_DestroyCond(q->cond);\n}\n```\n\n1. è°ƒç”¨packet_queue_flushæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„å…ƒç´ \n\n2. é”€æ¯AVFifo é˜Ÿåˆ—å®ä¾‹\n\n3. é”€æ¯mutex\n\n4. é”€æ¯cond\n\n## packet_queue_start\n\n```\nstatic void packet_queue_start(PacketQueue *q)\n{\n    SDL_LockMutex(q->mutex);\n    q->abort_request = 0;\n    q->serial++;\n    SDL_UnlockMutex(q->mutex);\n}\n```\n\nåªæ˜¯åŠ é”ï¼Œå°†abort_requestè®¾ç½®ä¸º0ï¼Œå¹¶ä¸”å°†serialåŠ 1ï¼Œç„¶åè§£é”ã€‚\n\n## packet_queue_abort\n\n```\nstatic void packet_queue_abort(PacketQueue *q)\n{\n    SDL_LockMutex(q->mutex);\n\n    q->abort_request = 1;\n\n    SDL_CondSignal(q->cond);\n\n    SDL_UnlockMutex(q->mutex);\n}\n```\n\nåŠ é”ï¼Œå°†abort_requestè®¾ç½®ä¸º1ï¼Œæ ‡è®°ä¸ºé˜Ÿåˆ—è¢«ç»ˆæ­¢ã€‚\n\nåŒæ—¶å”¤é†’ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹ï¼Œä½¿å…¶æ­£å¸¸é€€å‡º,   è§£é”ã€‚\n\n## packet_queue_get\n\n```c\n/* return < 0 if aborted, 0 if no packet and > 0 if packet.  */\nstatic int packet_queue_get(PacketQueue *q, AVPacket *pkt, int block, int *serial)\n{\n    MyAVPacketList pkt1;\n    int ret;\n    //åŠ é”\n    SDL_LockMutex(q->mutex);\n\n    for (;;) {\n        if (q->abort_request) {\n            //é˜Ÿåˆ—ç»ˆæ­¢äº†, è®¾ç½®è¿”å›å€¼ä¸º-1\n            ret = -1;\n            break;\n        }\n        //ä»pkt_listä¸­è¯»å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ”¾å…¥MyAVPacketListä¸­ï¼ŒåŒæ—¶æ›´æ–°é˜Ÿåˆ—çš„ä¿¡æ¯\n        if (av_fifo_read(q->pkt_list, &pkt1, 1) >= 0) {\n            //æ›´æ–°é˜Ÿåˆ—é•¿åº¦\n            q->nb_packets--;\n            //æ›´æ–°é˜Ÿåˆ—å ç”¨å†…å­˜å¤§å°\n            q->size -= pkt1.pkt->size + sizeof(pkt1);\n            //æ›´æ–°é˜Ÿåˆ—æ—¶é•¿\n            q->duration -= pkt1.pkt->duration;\n            //è½¬ç§»pkt1.pktçš„å†…å®¹åˆ°pktä¸­\n            av_packet_move_ref(pkt, pkt1.pkt);\n            //è®¾ç½®serialçš„å€¼\n            if (serial)\n                *serial = pkt1.serial;\n            //pkt1.pktå†…å®¹å·²è¿‘è¢«è½¬ç§»ï¼Œé‡Šæ”¾pkt1.pktçš„å†…å­˜\n            av_packet_free(&pkt1.pkt);\n            //è¿”å›å€¼>0,ä»£è¡¨ä»é˜Ÿåˆ—è·å–åˆ°äº†å…ƒç´ \n            ret = 1;\n            break;\n        } else if (!block) {\n            //æ²¡æœ‰è·å–åˆ°å…ƒç´ ï¼Œä½†æ˜¯è°ƒç”¨æ”¾è¦æ±‚ä¸é˜»å¡ï¼Œè®¾ç½®è¿”å›å€¼ä¸º0ï¼Œè·³å‡ºå¾ªç¯\n            ret = 0;\n            break;\n        } else {\n            //æ²¡è¯»åˆ°å…ƒç´ ï¼Œé˜»å¡ç­‰å¾…æœ‰å…ƒç´ å¯ä»¥è·å–\n            SDL_CondWait(q->cond, q->mutex);\n        }\n    }\n    //è§£é”\n    SDL_UnlockMutex(q->mutex);\n    return ret;\n}\n```\n\nä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå…ƒç´ \n\n1. åŠ é”\n\n2. è·å–æˆåŠŸï¼Œé˜Ÿåˆ—å…ƒç´ å‡å°‘ï¼Œæ›´æ–°é˜Ÿåˆ—ä¿¡æ¯\n\n3. è·å–å¤±è´¥ï¼Œè¦æ±‚ä¸é˜»å¡ï¼Œç«‹é©¬è¿”å›\n\n4. è·å–å¤±è´¥ï¼Œè¦æ±‚é˜»å¡ï¼Œè°ƒç”¨waitè¿›å…¥ç­‰å¾…çŠ¶æ€\n\n5. è§£é”\n\n## packet_queue_put\n\n```\nstatic int packet_queue_put_private(PacketQueue *q, AVPacket *pkt)\n{\n    MyAVPacketList pkt1;\n    int ret;\n    //å¦‚æœé˜Ÿåˆ—è¢«ç»ˆæ­¢ï¼Œè¿”å›-1\n    if (q->abort_request)\n       return -1;\n\n    //ç»™èŠ‚ç‚¹å¡«å……æ•°æ®\n    pkt1.pkt = pkt;\n    //è®¾ç½®pktçš„åºåˆ—å·\n    pkt1.serial = q->serial;\n    //å°†èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—\n    ret = av_fifo_write(q->pkt_list, &pkt1, 1);\n    if (ret < 0)\n        return ret;\n    //æ›´æ–°é˜Ÿåˆ—å¤§å°\n    q->nb_packets++;\n    //æ›´æ–°é˜Ÿåˆ—å†…å­˜å¤§å°ï¼Œæ·»åŠ èŠ‚ç‚¹size(pktå†…å­˜çš„å¤§å° + èŠ‚ç‚¹æ•°æ®å¤§å°)\n    q->size += pkt1.pkt->size + sizeof(pkt1);\n    //æ›´æ–°é˜Ÿåˆ—çš„æ€»æ—¶é•¿\n    q->duration += pkt1.pkt->duration;\n    /* XXX: should duplicate packet data in DV case */\n    SDL_CondSignal(q->cond);\n    return 0;\n}\n\nstatic int packet_queue_put(PacketQueue *q, AVPacket *pkt)\n{\n    AVPacket *pkt1;\n    int ret;\n    //åˆ›å»ºpkt1\n    pkt1 = av_packet_alloc();\n    if (!pkt1) {\n        //åˆ›å»ºpkt1å¤±è´¥ï¼Œå–æ¶ˆå¼•ç”¨pkt\n        av_packet_unref(pkt);\n        return -1;\n    }\n    //å°†pktå†…å®¹è½¬ç§»åˆ°pkt1ä¸­\n    av_packet_move_ref(pkt1, pkt);\n    //åŠ é”æ“åŠ å…¥é˜Ÿåˆ—\n    SDL_LockMutex(q->mutex);\n    //è°ƒç”¨packet_queue_put_privateå°†pkt1æ”¾å…¥é˜Ÿåˆ—ä¸­\n    ret = packet_queue_put_private(q, pkt1);\n    SDL_UnlockMutex(q->mutex);\n\n    if (ret < 0)\n        //æ”¾å…¥é˜Ÿåˆ—å¤±è´¥ï¼Œéœ€è¦å–æ¶ˆå¼•ç”¨pkt1\n        av_packet_free(&pkt1);\n\n    return ret;\n}\n```\n\n1. å°†AVPacketå°è£…ä¸ºMyAVPacketListï¼Œä¿å­˜åœ¨å†…éƒ¨çš„é˜Ÿåˆ—ä¸­\n\n2. é˜Ÿåˆ—é•¿åº¦åŠ 1ï¼ŒåŒæ—¶æ›´æ–°æ—¶é•¿ï¼Œå†…å­˜å ç”¨ç­‰ä¿¡æ¯\n\n3. packet_queue_putå†…éƒ¨è°ƒç”¨packet_queue_put_privateæ¥å®Œæˆç›¸å…³çš„æ“ä½œ\n\n## packet_queue_put_nullpacket\n\n```\n//æ’­æ”¾å®Œäº†ï¼Œä»æ–‡ä»¶ä¸­è¯»å‡ºäº†ç©ºçš„pktï¼Œç©ºçš„pktä¸¢ç»™è§£ç å™¨çš„æ—¶å€™ï¼Œä¼šå†²æ´—è§£ç å™¨ï¼Œå°†è§£ç å™¨å‰©ä½™çš„é¢æ•°æ®è¯»å‡ºæ¥\nstatic int packet_queue_put_nullpacket(PacketQueue *q, AVPacket *pkt, int stream_index)\n{\nÂ Â Â Â //è®¾ç½®pktå¯¹åº”çš„stream_index \n    pkt->stream_index = stream_index;\nÂ Â Â Â //æ·»åŠ æœ‰ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„pktåˆ°é˜Ÿåˆ—ä¸­\n    return packet_queue_put(q, pkt);\n}\n```\n\n1. ç»™é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„pkt\n\n2. è®¾ç½®pktå¯¹åº”çš„stream_indexï¼Œè¿½åŠ åˆ°é˜Ÿåˆ—ä¸­\n\n## packet_queue_flush\n\n```\nstatic void packet_queue_flush(PacketQueue *q)\n{\n    MyAVPacketList pkt1;\n    //åŠ é”\n    SDL_LockMutex(q->mutex);\n    //ä»å†…éƒ¨é˜Ÿåˆ—å¾ªç¯è·å–å…ƒç´ ï¼Œå­˜å…¥pkt1ä¸­\n    while (av_fifo_read(q->pkt_list, &pkt1, 1) >= 0)\n        //é‡Šæ”¾MyAVPacketListä¸­çš„AVPacketçš„å†…å­˜\n        av_packet_free(&pkt1.pkt);\n    //æ›´æ–°é˜Ÿåˆ—ä¿¡æ¯\n    q->nb_packets = 0;\n    q->size = 0;\n    q->duration = 0;\n    //serialåŠ 1\n    q->serial++;\n    //è§£é”\n    SDL_UnlockMutex(q->mutex);\n}\n```\n\n æ¸…ç©ºé˜Ÿåˆ—ï¼Œé‡Šæ”¾èŠ‚ç‚¹çš„å†…å­˜ï¼Œæ›´æ–°é˜Ÿåˆ—ä¿¡æ¯ã€‚\n\nè€Œå¯¹äºserialçš„æ“ä½œä¸æ˜¯è®¾ç½®ä¸º0ï¼Œè€Œæ˜¯åœ¨åŸæ¥çš„åŸºç¡€ä¸Šå¢åŠ äº†1ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\n\n## æ€»ç»“ï¼š\n\n1. ffplay ç”¨PacketQueueæ¥ä¿å­˜è§£å°è£…åçš„AVPacket\n\n2. PacketQueueå¯¹å…ƒç´ çš„æ“ä½œï¼Œä¾èµ–äºå†…éƒ¨åŸºäºffmpeg AVFifoçš„é˜Ÿåˆ—å®ä¾‹\n\n3. PacketQueueé€šè¿‡mutexæ¥ä¿è¯çº¿å±‚å®‰å…¨\n\n4. PacketQueueé€šè¿‡æ¡ä»¶å˜é‡æ¥æ§åˆ¶å†™å…¥å’Œè¯»å–çš„é¡ºåº\n","source":"_posts/ffmpeg/2022-03-14-ffplay-packet queue  åˆ†æ.md","raw":"---\nlayout: post\ntitle: \"ffplay packet queue åˆ†æ\"\ndate: 2022-03-14\ntag: ffmpeg\n\n---\n\nå‚è€ƒï¼š [ffplay packet queueåˆ†æ](https://zhuanlan.zhihu.com/p/43295650)\n\n---\n\nffplay  ç”¨ PacketQueue æ¥ä¿å­˜è§£å°è£…åçš„æ•°æ®ï¼Œå³AVPacketã€‚\nå®šä¹‰MyAVPacketListè¡¨ç¤ºé˜Ÿåˆ—ä¸­çš„å…ƒç´ ï¼Œè¿™é‡Œå‘½åä¸ºMyAVPacketNodeå¯èƒ½æ›´åˆç†ã€‚\n\n```c\ntypedef struct MyAVPacketList {\n    //å¾…è§£ç çš„æ•°æ®\n    AVPacket *pkt;\n    //pktåºåˆ—å·\n    int serial;\n} MyAVPacketList;\n\ntypedef struct PacketQueue {\n    /* ffmpegå°è£…çš„é˜Ÿåˆ—æ•°æ®ç»“æ„ï¼Œå…ˆå…¥å…ˆå‡º */\n    AVFifo *pkt_list;\n    /* å½“å‰é˜Ÿé‡Œçš„pktçš„æ•°é‡ */\n    int nb_packets;\n    /* å½“å‰æ‰€æœ‰èŠ‚ç‚¹å ç”¨çš„æ€»å†…å­˜å¤§å° */\n    int size;\n    /* é˜Ÿåˆ—æ‰€æœ‰èŠ‚ç‚¹çš„åˆè®¡æ—¶é•¿ */\n    int64_t duration;\n    /* æ˜¯å¦è¦ä¸­æ­¢é˜Ÿåˆ—æ“ä½œï¼Œç”¨äºå®‰å…¨å¿«é€Ÿé€€å‡ºæ’­æ”¾ */\n    int abort_request;\n    //åºåˆ—å·ï¼Œå’ŒMyAVPacketListçš„serialä½œç”¨ç›¸åŒï¼Œä½†æ”¹å˜çš„æ—¶åºç¨å¾®æœ‰ç‚¹ä¸åŒ\n    int serial;\n    //ç”¨äºç»´æŒPacketQueueçš„å¤šçº¿ç¨‹å®‰å…¨(SDL_mutexå¯ä»¥æŒ‰pthread_mutex_tç†è§£ï¼‰\n    SDL_mutex *mutex;\n    //ç”¨äºè¯»ã€å†™çº¿ç¨‹ç›¸äº’é€šçŸ¥(SDL_condå¯ä»¥æŒ‰pthread_cond_tç†è§£)\n    SDL_cond *cond;\n} PacketQueue;\n```\n\nç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯AVFifoæŒ‡é’ˆç±»å‹çš„ã€‚FFmpeg å®šä¹‰äº†AVFifoç»“æ„ä½“å’Œæ“ä½œè¿™ä¸ªç»“æ„ä½“çš„ä¸€ç³»åˆ—å‡½æ•°ï¼Œå®ç°äº†é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ã€‚PacketQueue æ˜¯å°è£…äº†AVFifo å®ä¾‹ï¼Œæ¥ç®¡ç†MyAVPacketListï¼Œè¿›è€Œç®¡ç†è§£å°è£…åçš„AVPacketçš„ã€‚\n\n## AVFifo\n\n```c\nstruct AVFifo {\n    uint8_t *buffer;\n\n    size_t elem_size, nb_elems;\n    size_t offset_r, offset_w;\n    // distinguishes the ambiguous situation offset_r == offset_w\n    int    is_empty;\n\n    unsigned int flags;\n    size_t       auto_grow_limit;\n};\n```\n\næ“ä½œ\n\n```\nAVFifo *av_fifo_alloc2(size_t elems, size_t elem_size,\n                       unsigned int flags);\n\nint av_fifo_write(AVFifo *f, const void *buf, size_t nb_elems);\n\nint av_fifo_read(AVFifo *f, void *buf, size_t nb_elems);\n\nvoid av_fifo_freep2(AVFifo **f);\n```\n\n- av_fifo_alloc2 åˆ›å»ºé˜Ÿåˆ—\n\n- av_fifo_read ä»é˜Ÿåˆ—ä¸­è¯»ä¸€ä¸ªå…ƒç´ ï¼Œé˜Ÿåˆ—é•¿åº¦å‡ 1\n\n- av_fifo_write ç»™é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œ é˜Ÿåˆ—é•¿åº¦åŠ 1 \n\n- av_fifo_freep2 é”€æ¯é˜Ÿåˆ—\n\n# PacketQueue æ“ä½œå‡½æ•°\n\n`PacketQueue`æ“ä½œæä¾›ä»¥ä¸‹æ–¹æ³•ï¼š\n\n- packet_queue_init:  åˆå§‹åŒ–\n\n- packet_queue_destroyï¼š é”€æ¯\n\n- packet_queue_startï¼š å¼€å¯\n\n- packet_queue_abortï¼š ç»ˆæ­¢\n\n- packet_queue_getï¼š è·å–ä¸€ä¸ªèŠ‚ç‚¹\n\n- packet_queue_putï¼š å­˜å…¥ä¸€ä¸ªèŠ‚ç‚¹\n\n- packet_queue_put_nullpacketï¼š å­˜å…¥ä¸€ä¸ªç©ºèŠ‚ç‚¹\n\n- packet_queue_flushï¼š æ¸…é™¤é˜Ÿåˆ—å†…æ‰€æœ‰çš„èŠ‚ç‚¹\n\n## packet_queue_init\n\n```\nstatic int packet_queue_init(PacketQueue *q)\n{\n    memset(q, 0, sizeof(PacketQueue));\n    q->pkt_list = av_fifo_alloc2(1, sizeof(MyAVPacketList), AV_FIFO_FLAG_AUTO_GROW);\n    if (!q->pkt_list)\n        return AVERROR(ENOMEM);\n    q->mutex = SDL_CreateMutex();\n    if (!q->mutex) {\n        av_log(NULL, AV_LOG_FATAL, \"SDL_CreateMutex(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    q->cond = SDL_CreateCond();\n    if (!q->cond) {\n        av_log(NULL, AV_LOG_FATAL, \"SDL_CreateCond(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    q->abort_request = 1;\n    return 0;\n}\n```\n\n1. å†…éƒ¨è°ƒç”¨av_fifo_alloc2 åˆ›å»ºAVFifo é˜Ÿåˆ—å®ä¾‹\n\n2. åˆ›å»ºmutexç”¨äºé˜Ÿåˆ—å®‰å…¨è®¿é—®\n\n3. åˆ›å»ºcond ç”¨äºé˜Ÿåˆ—ç­‰å¾…å’Œå”¤é†’æ§åˆ¶\n\n4. åˆå§‹è®¾ç½®abort_request = 1\n\n## packet_queue_destroy\n\n```\nstatic void packet_queue_destroy(PacketQueue *q)\n{\n    packet_queue_flush(q);\n    av_fifo_freep2(&q->pkt_list);\n    SDL_DestroyMutex(q->mutex);\n    SDL_DestroyCond(q->cond);\n}\n```\n\n1. è°ƒç”¨packet_queue_flushæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„å…ƒç´ \n\n2. é”€æ¯AVFifo é˜Ÿåˆ—å®ä¾‹\n\n3. é”€æ¯mutex\n\n4. é”€æ¯cond\n\n## packet_queue_start\n\n```\nstatic void packet_queue_start(PacketQueue *q)\n{\n    SDL_LockMutex(q->mutex);\n    q->abort_request = 0;\n    q->serial++;\n    SDL_UnlockMutex(q->mutex);\n}\n```\n\nåªæ˜¯åŠ é”ï¼Œå°†abort_requestè®¾ç½®ä¸º0ï¼Œå¹¶ä¸”å°†serialåŠ 1ï¼Œç„¶åè§£é”ã€‚\n\n## packet_queue_abort\n\n```\nstatic void packet_queue_abort(PacketQueue *q)\n{\n    SDL_LockMutex(q->mutex);\n\n    q->abort_request = 1;\n\n    SDL_CondSignal(q->cond);\n\n    SDL_UnlockMutex(q->mutex);\n}\n```\n\nåŠ é”ï¼Œå°†abort_requestè®¾ç½®ä¸º1ï¼Œæ ‡è®°ä¸ºé˜Ÿåˆ—è¢«ç»ˆæ­¢ã€‚\n\nåŒæ—¶å”¤é†’ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹ï¼Œä½¿å…¶æ­£å¸¸é€€å‡º,   è§£é”ã€‚\n\n## packet_queue_get\n\n```c\n/* return < 0 if aborted, 0 if no packet and > 0 if packet.  */\nstatic int packet_queue_get(PacketQueue *q, AVPacket *pkt, int block, int *serial)\n{\n    MyAVPacketList pkt1;\n    int ret;\n    //åŠ é”\n    SDL_LockMutex(q->mutex);\n\n    for (;;) {\n        if (q->abort_request) {\n            //é˜Ÿåˆ—ç»ˆæ­¢äº†, è®¾ç½®è¿”å›å€¼ä¸º-1\n            ret = -1;\n            break;\n        }\n        //ä»pkt_listä¸­è¯»å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ”¾å…¥MyAVPacketListä¸­ï¼ŒåŒæ—¶æ›´æ–°é˜Ÿåˆ—çš„ä¿¡æ¯\n        if (av_fifo_read(q->pkt_list, &pkt1, 1) >= 0) {\n            //æ›´æ–°é˜Ÿåˆ—é•¿åº¦\n            q->nb_packets--;\n            //æ›´æ–°é˜Ÿåˆ—å ç”¨å†…å­˜å¤§å°\n            q->size -= pkt1.pkt->size + sizeof(pkt1);\n            //æ›´æ–°é˜Ÿåˆ—æ—¶é•¿\n            q->duration -= pkt1.pkt->duration;\n            //è½¬ç§»pkt1.pktçš„å†…å®¹åˆ°pktä¸­\n            av_packet_move_ref(pkt, pkt1.pkt);\n            //è®¾ç½®serialçš„å€¼\n            if (serial)\n                *serial = pkt1.serial;\n            //pkt1.pktå†…å®¹å·²è¿‘è¢«è½¬ç§»ï¼Œé‡Šæ”¾pkt1.pktçš„å†…å­˜\n            av_packet_free(&pkt1.pkt);\n            //è¿”å›å€¼>0,ä»£è¡¨ä»é˜Ÿåˆ—è·å–åˆ°äº†å…ƒç´ \n            ret = 1;\n            break;\n        } else if (!block) {\n            //æ²¡æœ‰è·å–åˆ°å…ƒç´ ï¼Œä½†æ˜¯è°ƒç”¨æ”¾è¦æ±‚ä¸é˜»å¡ï¼Œè®¾ç½®è¿”å›å€¼ä¸º0ï¼Œè·³å‡ºå¾ªç¯\n            ret = 0;\n            break;\n        } else {\n            //æ²¡è¯»åˆ°å…ƒç´ ï¼Œé˜»å¡ç­‰å¾…æœ‰å…ƒç´ å¯ä»¥è·å–\n            SDL_CondWait(q->cond, q->mutex);\n        }\n    }\n    //è§£é”\n    SDL_UnlockMutex(q->mutex);\n    return ret;\n}\n```\n\nä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå…ƒç´ \n\n1. åŠ é”\n\n2. è·å–æˆåŠŸï¼Œé˜Ÿåˆ—å…ƒç´ å‡å°‘ï¼Œæ›´æ–°é˜Ÿåˆ—ä¿¡æ¯\n\n3. è·å–å¤±è´¥ï¼Œè¦æ±‚ä¸é˜»å¡ï¼Œç«‹é©¬è¿”å›\n\n4. è·å–å¤±è´¥ï¼Œè¦æ±‚é˜»å¡ï¼Œè°ƒç”¨waitè¿›å…¥ç­‰å¾…çŠ¶æ€\n\n5. è§£é”\n\n## packet_queue_put\n\n```\nstatic int packet_queue_put_private(PacketQueue *q, AVPacket *pkt)\n{\n    MyAVPacketList pkt1;\n    int ret;\n    //å¦‚æœé˜Ÿåˆ—è¢«ç»ˆæ­¢ï¼Œè¿”å›-1\n    if (q->abort_request)\n       return -1;\n\n    //ç»™èŠ‚ç‚¹å¡«å……æ•°æ®\n    pkt1.pkt = pkt;\n    //è®¾ç½®pktçš„åºåˆ—å·\n    pkt1.serial = q->serial;\n    //å°†èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—\n    ret = av_fifo_write(q->pkt_list, &pkt1, 1);\n    if (ret < 0)\n        return ret;\n    //æ›´æ–°é˜Ÿåˆ—å¤§å°\n    q->nb_packets++;\n    //æ›´æ–°é˜Ÿåˆ—å†…å­˜å¤§å°ï¼Œæ·»åŠ èŠ‚ç‚¹size(pktå†…å­˜çš„å¤§å° + èŠ‚ç‚¹æ•°æ®å¤§å°)\n    q->size += pkt1.pkt->size + sizeof(pkt1);\n    //æ›´æ–°é˜Ÿåˆ—çš„æ€»æ—¶é•¿\n    q->duration += pkt1.pkt->duration;\n    /* XXX: should duplicate packet data in DV case */\n    SDL_CondSignal(q->cond);\n    return 0;\n}\n\nstatic int packet_queue_put(PacketQueue *q, AVPacket *pkt)\n{\n    AVPacket *pkt1;\n    int ret;\n    //åˆ›å»ºpkt1\n    pkt1 = av_packet_alloc();\n    if (!pkt1) {\n        //åˆ›å»ºpkt1å¤±è´¥ï¼Œå–æ¶ˆå¼•ç”¨pkt\n        av_packet_unref(pkt);\n        return -1;\n    }\n    //å°†pktå†…å®¹è½¬ç§»åˆ°pkt1ä¸­\n    av_packet_move_ref(pkt1, pkt);\n    //åŠ é”æ“åŠ å…¥é˜Ÿåˆ—\n    SDL_LockMutex(q->mutex);\n    //è°ƒç”¨packet_queue_put_privateå°†pkt1æ”¾å…¥é˜Ÿåˆ—ä¸­\n    ret = packet_queue_put_private(q, pkt1);\n    SDL_UnlockMutex(q->mutex);\n\n    if (ret < 0)\n        //æ”¾å…¥é˜Ÿåˆ—å¤±è´¥ï¼Œéœ€è¦å–æ¶ˆå¼•ç”¨pkt1\n        av_packet_free(&pkt1);\n\n    return ret;\n}\n```\n\n1. å°†AVPacketå°è£…ä¸ºMyAVPacketListï¼Œä¿å­˜åœ¨å†…éƒ¨çš„é˜Ÿåˆ—ä¸­\n\n2. é˜Ÿåˆ—é•¿åº¦åŠ 1ï¼ŒåŒæ—¶æ›´æ–°æ—¶é•¿ï¼Œå†…å­˜å ç”¨ç­‰ä¿¡æ¯\n\n3. packet_queue_putå†…éƒ¨è°ƒç”¨packet_queue_put_privateæ¥å®Œæˆç›¸å…³çš„æ“ä½œ\n\n## packet_queue_put_nullpacket\n\n```\n//æ’­æ”¾å®Œäº†ï¼Œä»æ–‡ä»¶ä¸­è¯»å‡ºäº†ç©ºçš„pktï¼Œç©ºçš„pktä¸¢ç»™è§£ç å™¨çš„æ—¶å€™ï¼Œä¼šå†²æ´—è§£ç å™¨ï¼Œå°†è§£ç å™¨å‰©ä½™çš„é¢æ•°æ®è¯»å‡ºæ¥\nstatic int packet_queue_put_nullpacket(PacketQueue *q, AVPacket *pkt, int stream_index)\n{\nÂ Â Â Â //è®¾ç½®pktå¯¹åº”çš„stream_index \n    pkt->stream_index = stream_index;\nÂ Â Â Â //æ·»åŠ æœ‰ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„pktåˆ°é˜Ÿåˆ—ä¸­\n    return packet_queue_put(q, pkt);\n}\n```\n\n1. ç»™é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„pkt\n\n2. è®¾ç½®pktå¯¹åº”çš„stream_indexï¼Œè¿½åŠ åˆ°é˜Ÿåˆ—ä¸­\n\n## packet_queue_flush\n\n```\nstatic void packet_queue_flush(PacketQueue *q)\n{\n    MyAVPacketList pkt1;\n    //åŠ é”\n    SDL_LockMutex(q->mutex);\n    //ä»å†…éƒ¨é˜Ÿåˆ—å¾ªç¯è·å–å…ƒç´ ï¼Œå­˜å…¥pkt1ä¸­\n    while (av_fifo_read(q->pkt_list, &pkt1, 1) >= 0)\n        //é‡Šæ”¾MyAVPacketListä¸­çš„AVPacketçš„å†…å­˜\n        av_packet_free(&pkt1.pkt);\n    //æ›´æ–°é˜Ÿåˆ—ä¿¡æ¯\n    q->nb_packets = 0;\n    q->size = 0;\n    q->duration = 0;\n    //serialåŠ 1\n    q->serial++;\n    //è§£é”\n    SDL_UnlockMutex(q->mutex);\n}\n```\n\n æ¸…ç©ºé˜Ÿåˆ—ï¼Œé‡Šæ”¾èŠ‚ç‚¹çš„å†…å­˜ï¼Œæ›´æ–°é˜Ÿåˆ—ä¿¡æ¯ã€‚\n\nè€Œå¯¹äºserialçš„æ“ä½œä¸æ˜¯è®¾ç½®ä¸º0ï¼Œè€Œæ˜¯åœ¨åŸæ¥çš„åŸºç¡€ä¸Šå¢åŠ äº†1ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\n\n## æ€»ç»“ï¼š\n\n1. ffplay ç”¨PacketQueueæ¥ä¿å­˜è§£å°è£…åçš„AVPacket\n\n2. PacketQueueå¯¹å…ƒç´ çš„æ“ä½œï¼Œä¾èµ–äºå†…éƒ¨åŸºäºffmpeg AVFifoçš„é˜Ÿåˆ—å®ä¾‹\n\n3. PacketQueueé€šè¿‡mutexæ¥ä¿è¯çº¿å±‚å®‰å…¨\n\n4. PacketQueueé€šè¿‡æ¡ä»¶å˜é‡æ¥æ§åˆ¶å†™å…¥å’Œè¯»å–çš„é¡ºåº\n","slug":"ffmpeg/2022-03-14-ffplay-packet queue  åˆ†æ","published":1,"updated":"2024-03-06T11:53:13.566Z","comments":1,"photos":[],"_id":"clti3glkq002157whb89c9evn","content":"<p>å‚è€ƒï¼š <a href=\"https://zhuanlan.zhihu.com/p/43295650\">ffplay packet queueåˆ†æ</a></p>\n<hr>\n<p>ffplay  ç”¨ PacketQueue æ¥ä¿å­˜è§£å°è£…åçš„æ•°æ®ï¼Œå³AVPacketã€‚<br>å®šä¹‰MyAVPacketListè¡¨ç¤ºé˜Ÿåˆ—ä¸­çš„å…ƒç´ ï¼Œè¿™é‡Œå‘½åä¸ºMyAVPacketNodeå¯èƒ½æ›´åˆç†ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">MyAVPacketList</span> &#123;</span><br>    <span class=\"hljs-comment\">//å¾…è§£ç çš„æ•°æ®</span><br>    AVPacket *pkt;<br>    <span class=\"hljs-comment\">//pktåºåˆ—å·</span><br>    <span class=\"hljs-type\">int</span> serial;<br>&#125; MyAVPacketList;<br><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">PacketQueue</span> &#123;</span><br>    <span class=\"hljs-comment\">/* ffmpegå°è£…çš„é˜Ÿåˆ—æ•°æ®ç»“æ„ï¼Œå…ˆå…¥å…ˆå‡º */</span><br>    AVFifo *pkt_list;<br>    <span class=\"hljs-comment\">/* å½“å‰é˜Ÿé‡Œçš„pktçš„æ•°é‡ */</span><br>    <span class=\"hljs-type\">int</span> nb_packets;<br>    <span class=\"hljs-comment\">/* å½“å‰æ‰€æœ‰èŠ‚ç‚¹å ç”¨çš„æ€»å†…å­˜å¤§å° */</span><br>    <span class=\"hljs-type\">int</span> size;<br>    <span class=\"hljs-comment\">/* é˜Ÿåˆ—æ‰€æœ‰èŠ‚ç‚¹çš„åˆè®¡æ—¶é•¿ */</span><br>    <span class=\"hljs-type\">int64_t</span> duration;<br>    <span class=\"hljs-comment\">/* æ˜¯å¦è¦ä¸­æ­¢é˜Ÿåˆ—æ“ä½œï¼Œç”¨äºå®‰å…¨å¿«é€Ÿé€€å‡ºæ’­æ”¾ */</span><br>    <span class=\"hljs-type\">int</span> abort_request;<br>    <span class=\"hljs-comment\">//åºåˆ—å·ï¼Œå’ŒMyAVPacketListçš„serialä½œç”¨ç›¸åŒï¼Œä½†æ”¹å˜çš„æ—¶åºç¨å¾®æœ‰ç‚¹ä¸åŒ</span><br>    <span class=\"hljs-type\">int</span> serial;<br>    <span class=\"hljs-comment\">//ç”¨äºç»´æŒPacketQueueçš„å¤šçº¿ç¨‹å®‰å…¨(SDL_mutexå¯ä»¥æŒ‰pthread_mutex_tç†è§£ï¼‰</span><br>    SDL_mutex *mutex;<br>    <span class=\"hljs-comment\">//ç”¨äºè¯»ã€å†™çº¿ç¨‹ç›¸äº’é€šçŸ¥(SDL_condå¯ä»¥æŒ‰pthread_cond_tç†è§£)</span><br>    SDL_cond *cond;<br>&#125; PacketQueue;<br></code></pre></td></tr></table></figure>\n\n<p>ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯AVFifoæŒ‡é’ˆç±»å‹çš„ã€‚FFmpeg å®šä¹‰äº†AVFifoç»“æ„ä½“å’Œæ“ä½œè¿™ä¸ªç»“æ„ä½“çš„ä¸€ç³»åˆ—å‡½æ•°ï¼Œå®ç°äº†é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ã€‚PacketQueue æ˜¯å°è£…äº†AVFifo å®ä¾‹ï¼Œæ¥ç®¡ç†MyAVPacketListï¼Œè¿›è€Œç®¡ç†è§£å°è£…åçš„AVPacketçš„ã€‚</p>\n<h2 id=\"AVFifo\"><a href=\"#AVFifo\" class=\"headerlink\" title=\"AVFifo\"></a>AVFifo</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">AVFifo</span> &#123;</span><br>    <span class=\"hljs-type\">uint8_t</span> *buffer;<br><br>    <span class=\"hljs-type\">size_t</span> elem_size, nb_elems;<br>    <span class=\"hljs-type\">size_t</span> offset_r, offset_w;<br>    <span class=\"hljs-comment\">// distinguishes the ambiguous situation offset_r == offset_w</span><br>    <span class=\"hljs-type\">int</span>    is_empty;<br><br>    <span class=\"hljs-type\">unsigned</span> <span class=\"hljs-type\">int</span> flags;<br>    <span class=\"hljs-type\">size_t</span>       auto_grow_limit;<br>&#125;;<br></code></pre></td></tr></table></figure>\n\n<p>æ“ä½œ</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\">AVFifo *<span class=\"hljs-title\">av_fifo_alloc2</span><span class=\"hljs-params\">(<span class=\"hljs-type\">size_t</span> elems, <span class=\"hljs-type\">size_t</span> elem_size,</span></span><br><span class=\"hljs-params\"><span class=\"hljs-function\">                       <span class=\"hljs-type\">unsigned</span> <span class=\"hljs-type\">int</span> flags)</span></span>;<br><br><span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">av_fifo_write</span><span class=\"hljs-params\">(AVFifo *f, <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">void</span> *buf, <span class=\"hljs-type\">size_t</span> nb_elems)</span></span>;<br><br><span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">av_fifo_read</span><span class=\"hljs-params\">(AVFifo *f, <span class=\"hljs-type\">void</span> *buf, <span class=\"hljs-type\">size_t</span> nb_elems)</span></span>;<br><br><span class=\"hljs-function\"><span class=\"hljs-type\">void</span> <span class=\"hljs-title\">av_fifo_freep2</span><span class=\"hljs-params\">(AVFifo **f)</span></span>;<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><p>av_fifo_alloc2 åˆ›å»ºé˜Ÿåˆ—</p>\n</li>\n<li><p>av_fifo_read ä»é˜Ÿåˆ—ä¸­è¯»ä¸€ä¸ªå…ƒç´ ï¼Œé˜Ÿåˆ—é•¿åº¦å‡ 1</p>\n</li>\n<li><p>av_fifo_write ç»™é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œ é˜Ÿåˆ—é•¿åº¦åŠ 1 </p>\n</li>\n<li><p>av_fifo_freep2 é”€æ¯é˜Ÿåˆ—</p>\n</li>\n</ul>\n<h1 id=\"PacketQueue-æ“ä½œå‡½æ•°\"><a href=\"#PacketQueue-æ“ä½œå‡½æ•°\" class=\"headerlink\" title=\"PacketQueue æ“ä½œå‡½æ•°\"></a>PacketQueue æ“ä½œå‡½æ•°</h1><p><code>PacketQueue</code>æ“ä½œæä¾›ä»¥ä¸‹æ–¹æ³•ï¼š</p>\n<ul>\n<li><p>packet_queue_init:  åˆå§‹åŒ–</p>\n</li>\n<li><p>packet_queue_destroyï¼š é”€æ¯</p>\n</li>\n<li><p>packet_queue_startï¼š å¼€å¯</p>\n</li>\n<li><p>packet_queue_abortï¼š ç»ˆæ­¢</p>\n</li>\n<li><p>packet_queue_getï¼š è·å–ä¸€ä¸ªèŠ‚ç‚¹</p>\n</li>\n<li><p>packet_queue_putï¼š å­˜å…¥ä¸€ä¸ªèŠ‚ç‚¹</p>\n</li>\n<li><p>packet_queue_put_nullpacketï¼š å­˜å…¥ä¸€ä¸ªç©ºèŠ‚ç‚¹</p>\n</li>\n<li><p>packet_queue_flushï¼š æ¸…é™¤é˜Ÿåˆ—å†…æ‰€æœ‰çš„èŠ‚ç‚¹</p>\n</li>\n</ul>\n<h2 id=\"packet-queue-init\"><a href=\"#packet-queue-init\" class=\"headerlink\" title=\"packet_queue_init\"></a>packet_queue_init</h2><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-type\">int</span> packet_queue_init(PacketQueue *q)<br>&#123;<br>    memset(q, <span class=\"hljs-number\">0</span>, <span class=\"hljs-keyword\">sizeof</span>(PacketQueue));<br>    q-&gt;pkt_list = av_fifo_alloc2(<span class=\"hljs-number\">1</span>, <span class=\"hljs-keyword\">sizeof</span>(MyAVPacketList), <span class=\"hljs-built_in\">AV_FIFO_FLAG_AUTO_GROW</span>);<br>    <span class=\"hljs-keyword\">if</span> (!q-&gt;pkt_list)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>    q-&gt;mutex = SDL_CreateMutex();<br>    <span class=\"hljs-keyword\">if</span> (!q-&gt;mutex) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-built_in\">AV_LOG_FATAL</span>, <span class=\"hljs-string\">&quot;SDL_CreateMutex(): %s\\n&quot;</span>, SDL_GetError());<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>    &#125;<br>    q-&gt;cond = SDL_CreateCond();<br>    <span class=\"hljs-keyword\">if</span> (!q-&gt;cond) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-built_in\">AV_LOG_FATAL</span>, <span class=\"hljs-string\">&quot;SDL_CreateCond(): %s\\n&quot;</span>, SDL_GetError());<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>    &#125;<br>    q-&gt;abort_request = <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å†…éƒ¨è°ƒç”¨av_fifo_alloc2 åˆ›å»ºAVFifo é˜Ÿåˆ—å®ä¾‹</p>\n</li>\n<li><p>åˆ›å»ºmutexç”¨äºé˜Ÿåˆ—å®‰å…¨è®¿é—®</p>\n</li>\n<li><p>åˆ›å»ºcond ç”¨äºé˜Ÿåˆ—ç­‰å¾…å’Œå”¤é†’æ§åˆ¶</p>\n</li>\n<li><p>åˆå§‹è®¾ç½®abort_request &#x3D; 1</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-destroy\"><a href=\"#packet-queue-destroy\" class=\"headerlink\" title=\"packet_queue_destroy\"></a>packet_queue_destroy</h2><figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">static void <span class=\"hljs-built_in\">packet_queue_destroy</span>(PacketQueue *q)<br>&#123;<br>    <span class=\"hljs-built_in\">packet_queue_flush</span>(q);<br>    <span class=\"hljs-built_in\">av_fifo_freep2</span>(&amp;q-&gt;pkt_list);<br>    <span class=\"hljs-built_in\">SDL_DestroyMutex</span>(q-&gt;mutex);<br>    <span class=\"hljs-built_in\">SDL_DestroyCond</span>(q-&gt;cond);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è°ƒç”¨packet_queue_flushæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„å…ƒç´ </p>\n</li>\n<li><p>é”€æ¯AVFifo é˜Ÿåˆ—å®ä¾‹</p>\n</li>\n<li><p>é”€æ¯mutex</p>\n</li>\n<li><p>é”€æ¯cond</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-start\"><a href=\"#packet-queue-start\" class=\"headerlink\" title=\"packet_queue_start\"></a>packet_queue_start</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static void packet_queue_start(PacketQueue *q)<br>&#123;<br>    SDL_L<span class=\"hljs-function\"><span class=\"hljs-title\">ockMutex</span>(q-&gt;</span>mutex);<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>abort_request = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>serial++;<br>    SDL_U<span class=\"hljs-function\"><span class=\"hljs-title\">nlockMutex</span>(q-&gt;</span>mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åªæ˜¯åŠ é”ï¼Œå°†abort_requestè®¾ç½®ä¸º0ï¼Œå¹¶ä¸”å°†serialåŠ 1ï¼Œç„¶åè§£é”ã€‚</p>\n<h2 id=\"packet-queue-abort\"><a href=\"#packet-queue-abort\" class=\"headerlink\" title=\"packet_queue_abort\"></a>packet_queue_abort</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static void packet_queue_abort(PacketQueue *q)<br>&#123;<br>    SDL_L<span class=\"hljs-function\"><span class=\"hljs-title\">ockMutex</span>(q-&gt;</span>mutex);<br><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>abort_request = <span class=\"hljs-number\">1</span>;<br><br>    SDL_C<span class=\"hljs-function\"><span class=\"hljs-title\">ondSignal</span>(q-&gt;</span>cond);<br><br>    SDL_U<span class=\"hljs-function\"><span class=\"hljs-title\">nlockMutex</span>(q-&gt;</span>mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åŠ é”ï¼Œå°†abort_requestè®¾ç½®ä¸º1ï¼Œæ ‡è®°ä¸ºé˜Ÿåˆ—è¢«ç»ˆæ­¢ã€‚</p>\n<p>åŒæ—¶å”¤é†’ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹ï¼Œä½¿å…¶æ­£å¸¸é€€å‡º,   è§£é”ã€‚</p>\n<h2 id=\"packet-queue-get\"><a href=\"#packet-queue-get\" class=\"headerlink\" title=\"packet_queue_get\"></a>packet_queue_get</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* return &lt; 0 if aborted, 0 if no packet and &gt; 0 if packet.  */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">packet_queue_get</span><span class=\"hljs-params\">(PacketQueue *q, AVPacket *pkt, <span class=\"hljs-type\">int</span> block, <span class=\"hljs-type\">int</span> *serial)</span><br>&#123;<br>    MyAVPacketList pkt1;<br>    <span class=\"hljs-type\">int</span> ret;<br>    <span class=\"hljs-comment\">//åŠ é”</span><br>    SDL_LockMutex(q-&gt;mutex);<br><br>    <span class=\"hljs-keyword\">for</span> (;;) &#123;<br>        <span class=\"hljs-keyword\">if</span> (q-&gt;abort_request) &#123;<br>            <span class=\"hljs-comment\">//é˜Ÿåˆ—ç»ˆæ­¢äº†, è®¾ç½®è¿”å›å€¼ä¸º-1</span><br>            ret = <span class=\"hljs-number\">-1</span>;<br>            <span class=\"hljs-keyword\">break</span>;<br>        &#125;<br>        <span class=\"hljs-comment\">//ä»pkt_listä¸­è¯»å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ”¾å…¥MyAVPacketListä¸­ï¼ŒåŒæ—¶æ›´æ–°é˜Ÿåˆ—çš„ä¿¡æ¯</span><br>        <span class=\"hljs-keyword\">if</span> (av_fifo_read(q-&gt;pkt_list, &amp;pkt1, <span class=\"hljs-number\">1</span>) &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—é•¿åº¦</span><br>            q-&gt;nb_packets--;<br>            <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—å ç”¨å†…å­˜å¤§å°</span><br>            q-&gt;size -= pkt1.pkt-&gt;size + <span class=\"hljs-keyword\">sizeof</span>(pkt1);<br>            <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—æ—¶é•¿</span><br>            q-&gt;duration -= pkt1.pkt-&gt;duration;<br>            <span class=\"hljs-comment\">//è½¬ç§»pkt1.pktçš„å†…å®¹åˆ°pktä¸­</span><br>            av_packet_move_ref(pkt, pkt1.pkt);<br>            <span class=\"hljs-comment\">//è®¾ç½®serialçš„å€¼</span><br>            <span class=\"hljs-keyword\">if</span> (serial)<br>                *serial = pkt1.serial;<br>            <span class=\"hljs-comment\">//pkt1.pktå†…å®¹å·²è¿‘è¢«è½¬ç§»ï¼Œé‡Šæ”¾pkt1.pktçš„å†…å­˜</span><br>            av_packet_free(&amp;pkt1.pkt);<br>            <span class=\"hljs-comment\">//è¿”å›å€¼&gt;0,ä»£è¡¨ä»é˜Ÿåˆ—è·å–åˆ°äº†å…ƒç´ </span><br>            ret = <span class=\"hljs-number\">1</span>;<br>            <span class=\"hljs-keyword\">break</span>;<br>        &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!block) &#123;<br>            <span class=\"hljs-comment\">//æ²¡æœ‰è·å–åˆ°å…ƒç´ ï¼Œä½†æ˜¯è°ƒç”¨æ”¾è¦æ±‚ä¸é˜»å¡ï¼Œè®¾ç½®è¿”å›å€¼ä¸º0ï¼Œè·³å‡ºå¾ªç¯</span><br>            ret = <span class=\"hljs-number\">0</span>;<br>            <span class=\"hljs-keyword\">break</span>;<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-comment\">//æ²¡è¯»åˆ°å…ƒç´ ï¼Œé˜»å¡ç­‰å¾…æœ‰å…ƒç´ å¯ä»¥è·å–</span><br>            SDL_CondWait(q-&gt;cond, q-&gt;mutex);<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-comment\">//è§£é”</span><br>    SDL_UnlockMutex(q-&gt;mutex);<br>    <span class=\"hljs-keyword\">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå…ƒç´ </p>\n<ol>\n<li><p>åŠ é”</p>\n</li>\n<li><p>è·å–æˆåŠŸï¼Œé˜Ÿåˆ—å…ƒç´ å‡å°‘ï¼Œæ›´æ–°é˜Ÿåˆ—ä¿¡æ¯</p>\n</li>\n<li><p>è·å–å¤±è´¥ï¼Œè¦æ±‚ä¸é˜»å¡ï¼Œç«‹é©¬è¿”å›</p>\n</li>\n<li><p>è·å–å¤±è´¥ï¼Œè¦æ±‚é˜»å¡ï¼Œè°ƒç”¨waitè¿›å…¥ç­‰å¾…çŠ¶æ€</p>\n</li>\n<li><p>è§£é”</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-put\"><a href=\"#packet-queue-put\" class=\"headerlink\" title=\"packet_queue_put\"></a>packet_queue_put</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static int packet_queue_put_private(PacketQueue *q, AVPacket *pkt)<br>&#123;<br>    MyAVPacketList pkt1;<br>    int ret;<br>    <span class=\"hljs-comment\">//å¦‚æœé˜Ÿåˆ—è¢«ç»ˆæ­¢ï¼Œè¿”å›-1</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (q-&gt;</span>abort_request)<br>       return -<span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-comment\">//ç»™èŠ‚ç‚¹å¡«å……æ•°æ®</span><br>    pkt1.pkt = pkt;<br>    <span class=\"hljs-comment\">//è®¾ç½®pktçš„åºåˆ—å·</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">pkt1</span>.serial = q-&gt;</span>serial;<br>    <span class=\"hljs-comment\">//å°†èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">ret</span> = av_fifo_write(q-&gt;</span>pkt_list, &amp;pkt1, <span class=\"hljs-number\">1</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>        return ret;<br>    <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—å¤§å°</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>nb_packets++;<br>    <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—å†…å­˜å¤§å°ï¼Œæ·»åŠ èŠ‚ç‚¹size(pktå†…å­˜çš„å¤§å° + èŠ‚ç‚¹æ•°æ®å¤§å°)</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">size</span> += pkt1.pkt-&gt;</span>size + sizeof(pkt1);<br>    <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—çš„æ€»æ—¶é•¿</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">duration</span> += pkt1.pkt-&gt;</span>duration;<br>    <span class=\"hljs-comment\">/* <span class=\"hljs-doctag\">XXX:</span> should duplicate packet data in DV case */</span><br>    SDL_C<span class=\"hljs-function\"><span class=\"hljs-title\">ondSignal</span>(q-&gt;</span>cond);<br>    return <span class=\"hljs-number\">0</span>;<br>&#125;<br><br>static int packet_queue_put(PacketQueue *q, AVPacket *pkt)<br>&#123;<br>    AVPacket *pkt1;<br>    int ret;<br>    <span class=\"hljs-comment\">//åˆ›å»ºpkt1</span><br>    pkt1 = av_packet_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!pkt1) &#123;<br>        <span class=\"hljs-comment\">//åˆ›å»ºpkt1å¤±è´¥ï¼Œå–æ¶ˆå¼•ç”¨pkt</span><br>        av_packet_unref(pkt);<br>        return -<span class=\"hljs-number\">1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//å°†pktå†…å®¹è½¬ç§»åˆ°pkt1ä¸­</span><br>    av_packet_move_ref(pkt1, pkt);<br>    <span class=\"hljs-comment\">//åŠ é”æ“åŠ å…¥é˜Ÿåˆ—</span><br>    SDL_L<span class=\"hljs-function\"><span class=\"hljs-title\">ockMutex</span>(q-&gt;</span>mutex);<br>    <span class=\"hljs-comment\">//è°ƒç”¨packet_queue_put_privateå°†pkt1æ”¾å…¥é˜Ÿåˆ—ä¸­</span><br>    ret = packet_queue_put_private(q, pkt1);<br>    SDL_U<span class=\"hljs-function\"><span class=\"hljs-title\">nlockMutex</span>(q-&gt;</span>mutex);<br><br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-comment\">//æ”¾å…¥é˜Ÿåˆ—å¤±è´¥ï¼Œéœ€è¦å–æ¶ˆå¼•ç”¨pkt1</span><br>        av_packet_free(&amp;pkt1);<br><br>    return ret;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å°†AVPacketå°è£…ä¸ºMyAVPacketListï¼Œä¿å­˜åœ¨å†…éƒ¨çš„é˜Ÿåˆ—ä¸­</p>\n</li>\n<li><p>é˜Ÿåˆ—é•¿åº¦åŠ 1ï¼ŒåŒæ—¶æ›´æ–°æ—¶é•¿ï¼Œå†…å­˜å ç”¨ç­‰ä¿¡æ¯</p>\n</li>\n<li><p>packet_queue_putå†…éƒ¨è°ƒç”¨packet_queue_put_privateæ¥å®Œæˆç›¸å…³çš„æ“ä½œ</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-put-nullpacket\"><a href=\"#packet-queue-put-nullpacket\" class=\"headerlink\" title=\"packet_queue_put_nullpacket\"></a>packet_queue_put_nullpacket</h2><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs aspectj\"><span class=\"hljs-comment\">//æ’­æ”¾å®Œäº†ï¼Œä»æ–‡ä»¶ä¸­è¯»å‡ºäº†ç©ºçš„pktï¼Œç©ºçš„pktä¸¢ç»™è§£ç å™¨çš„æ—¶å€™ï¼Œä¼šå†²æ´—è§£ç å™¨ï¼Œå°†è§£ç å™¨å‰©ä½™çš„é¢æ•°æ®è¯»å‡ºæ¥</span><br><span class=\"hljs-keyword\">static</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">packet_queue_put_nullpacket</span><span class=\"hljs-params\">(PacketQueue *q, AVPacket *pkt, <span class=\"hljs-keyword\">int</span> stream_index)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>Â Â Â Â <span class=\"hljs-comment\">//è®¾ç½®pktå¯¹åº”çš„stream_index </span><br>    pkt-&gt;stream_index = stream_index;<br>Â Â Â Â <span class=\"hljs-comment\">//æ·»åŠ æœ‰ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„pktåˆ°é˜Ÿåˆ—ä¸­</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">return</span> <span class=\"hljs-title\">packet_queue_put</span><span class=\"hljs-params\">(q, pkt)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>ç»™é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„pkt</p>\n</li>\n<li><p>è®¾ç½®pktå¯¹åº”çš„stream_indexï¼Œè¿½åŠ åˆ°é˜Ÿåˆ—ä¸­</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-flush\"><a href=\"#packet-queue-flush\" class=\"headerlink\" title=\"packet_queue_flush\"></a>packet_queue_flush</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static void packet_queue_flush(PacketQueue *q)<br>&#123;<br>    MyAVPacketList pkt1;<br>    <span class=\"hljs-comment\">//åŠ é”</span><br>    SDL_L<span class=\"hljs-function\"><span class=\"hljs-title\">ockMutex</span>(q-&gt;</span>mutex);<br>    <span class=\"hljs-comment\">//ä»å†…éƒ¨é˜Ÿåˆ—å¾ªç¯è·å–å…ƒç´ ï¼Œå­˜å…¥pkt1ä¸­</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">while</span> (av_fifo_read(q-&gt;</span>pkt_list, &amp;pkt1, <span class=\"hljs-number\">1</span>) &gt;= <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-comment\">//é‡Šæ”¾MyAVPacketListä¸­çš„AVPacketçš„å†…å­˜</span><br>        av_packet_free(&amp;pkt1.pkt);<br>    <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—ä¿¡æ¯</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>nb_packets = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>size = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>duration = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//serialåŠ 1</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>serial++;<br>    <span class=\"hljs-comment\">//è§£é”</span><br>    SDL_U<span class=\"hljs-function\"><span class=\"hljs-title\">nlockMutex</span>(q-&gt;</span>mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p> æ¸…ç©ºé˜Ÿåˆ—ï¼Œé‡Šæ”¾èŠ‚ç‚¹çš„å†…å­˜ï¼Œæ›´æ–°é˜Ÿåˆ—ä¿¡æ¯ã€‚</p>\n<p>è€Œå¯¹äºserialçš„æ“ä½œä¸æ˜¯è®¾ç½®ä¸º0ï¼Œè€Œæ˜¯åœ¨åŸæ¥çš„åŸºç¡€ä¸Šå¢åŠ äº†1ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>\n<h2 id=\"æ€»ç»“ï¼š\"><a href=\"#æ€»ç»“ï¼š\" class=\"headerlink\" title=\"æ€»ç»“ï¼š\"></a>æ€»ç»“ï¼š</h2><ol>\n<li><p>ffplay ç”¨PacketQueueæ¥ä¿å­˜è§£å°è£…åçš„AVPacket</p>\n</li>\n<li><p>PacketQueueå¯¹å…ƒç´ çš„æ“ä½œï¼Œä¾èµ–äºå†…éƒ¨åŸºäºffmpeg AVFifoçš„é˜Ÿåˆ—å®ä¾‹</p>\n</li>\n<li><p>PacketQueueé€šè¿‡mutexæ¥ä¿è¯çº¿å±‚å®‰å…¨</p>\n</li>\n<li><p>PacketQueueé€šè¿‡æ¡ä»¶å˜é‡æ¥æ§åˆ¶å†™å…¥å’Œè¯»å–çš„é¡ºåº</p>\n</li>\n</ol>\n","excerpt":"","more":"<p>å‚è€ƒï¼š <a href=\"https://zhuanlan.zhihu.com/p/43295650\">ffplay packet queueåˆ†æ</a></p>\n<hr>\n<p>ffplay  ç”¨ PacketQueue æ¥ä¿å­˜è§£å°è£…åçš„æ•°æ®ï¼Œå³AVPacketã€‚<br>å®šä¹‰MyAVPacketListè¡¨ç¤ºé˜Ÿåˆ—ä¸­çš„å…ƒç´ ï¼Œè¿™é‡Œå‘½åä¸ºMyAVPacketNodeå¯èƒ½æ›´åˆç†ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">MyAVPacketList</span> &#123;</span><br>    <span class=\"hljs-comment\">//å¾…è§£ç çš„æ•°æ®</span><br>    AVPacket *pkt;<br>    <span class=\"hljs-comment\">//pktåºåˆ—å·</span><br>    <span class=\"hljs-type\">int</span> serial;<br>&#125; MyAVPacketList;<br><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">PacketQueue</span> &#123;</span><br>    <span class=\"hljs-comment\">/* ffmpegå°è£…çš„é˜Ÿåˆ—æ•°æ®ç»“æ„ï¼Œå…ˆå…¥å…ˆå‡º */</span><br>    AVFifo *pkt_list;<br>    <span class=\"hljs-comment\">/* å½“å‰é˜Ÿé‡Œçš„pktçš„æ•°é‡ */</span><br>    <span class=\"hljs-type\">int</span> nb_packets;<br>    <span class=\"hljs-comment\">/* å½“å‰æ‰€æœ‰èŠ‚ç‚¹å ç”¨çš„æ€»å†…å­˜å¤§å° */</span><br>    <span class=\"hljs-type\">int</span> size;<br>    <span class=\"hljs-comment\">/* é˜Ÿåˆ—æ‰€æœ‰èŠ‚ç‚¹çš„åˆè®¡æ—¶é•¿ */</span><br>    <span class=\"hljs-type\">int64_t</span> duration;<br>    <span class=\"hljs-comment\">/* æ˜¯å¦è¦ä¸­æ­¢é˜Ÿåˆ—æ“ä½œï¼Œç”¨äºå®‰å…¨å¿«é€Ÿé€€å‡ºæ’­æ”¾ */</span><br>    <span class=\"hljs-type\">int</span> abort_request;<br>    <span class=\"hljs-comment\">//åºåˆ—å·ï¼Œå’ŒMyAVPacketListçš„serialä½œç”¨ç›¸åŒï¼Œä½†æ”¹å˜çš„æ—¶åºç¨å¾®æœ‰ç‚¹ä¸åŒ</span><br>    <span class=\"hljs-type\">int</span> serial;<br>    <span class=\"hljs-comment\">//ç”¨äºç»´æŒPacketQueueçš„å¤šçº¿ç¨‹å®‰å…¨(SDL_mutexå¯ä»¥æŒ‰pthread_mutex_tç†è§£ï¼‰</span><br>    SDL_mutex *mutex;<br>    <span class=\"hljs-comment\">//ç”¨äºè¯»ã€å†™çº¿ç¨‹ç›¸äº’é€šçŸ¥(SDL_condå¯ä»¥æŒ‰pthread_cond_tç†è§£)</span><br>    SDL_cond *cond;<br>&#125; PacketQueue;<br></code></pre></td></tr></table></figure>\n\n<p>ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯AVFifoæŒ‡é’ˆç±»å‹çš„ã€‚FFmpeg å®šä¹‰äº†AVFifoç»“æ„ä½“å’Œæ“ä½œè¿™ä¸ªç»“æ„ä½“çš„ä¸€ç³»åˆ—å‡½æ•°ï¼Œå®ç°äº†é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ã€‚PacketQueue æ˜¯å°è£…äº†AVFifo å®ä¾‹ï¼Œæ¥ç®¡ç†MyAVPacketListï¼Œè¿›è€Œç®¡ç†è§£å°è£…åçš„AVPacketçš„ã€‚</p>\n<h2 id=\"AVFifo\"><a href=\"#AVFifo\" class=\"headerlink\" title=\"AVFifo\"></a>AVFifo</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">AVFifo</span> &#123;</span><br>    <span class=\"hljs-type\">uint8_t</span> *buffer;<br><br>    <span class=\"hljs-type\">size_t</span> elem_size, nb_elems;<br>    <span class=\"hljs-type\">size_t</span> offset_r, offset_w;<br>    <span class=\"hljs-comment\">// distinguishes the ambiguous situation offset_r == offset_w</span><br>    <span class=\"hljs-type\">int</span>    is_empty;<br><br>    <span class=\"hljs-type\">unsigned</span> <span class=\"hljs-type\">int</span> flags;<br>    <span class=\"hljs-type\">size_t</span>       auto_grow_limit;<br>&#125;;<br></code></pre></td></tr></table></figure>\n\n<p>æ“ä½œ</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\">AVFifo *<span class=\"hljs-title\">av_fifo_alloc2</span><span class=\"hljs-params\">(<span class=\"hljs-type\">size_t</span> elems, <span class=\"hljs-type\">size_t</span> elem_size,</span></span><br><span class=\"hljs-params\"><span class=\"hljs-function\">                       <span class=\"hljs-type\">unsigned</span> <span class=\"hljs-type\">int</span> flags)</span></span>;<br><br><span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">av_fifo_write</span><span class=\"hljs-params\">(AVFifo *f, <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">void</span> *buf, <span class=\"hljs-type\">size_t</span> nb_elems)</span></span>;<br><br><span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">av_fifo_read</span><span class=\"hljs-params\">(AVFifo *f, <span class=\"hljs-type\">void</span> *buf, <span class=\"hljs-type\">size_t</span> nb_elems)</span></span>;<br><br><span class=\"hljs-function\"><span class=\"hljs-type\">void</span> <span class=\"hljs-title\">av_fifo_freep2</span><span class=\"hljs-params\">(AVFifo **f)</span></span>;<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><p>av_fifo_alloc2 åˆ›å»ºé˜Ÿåˆ—</p>\n</li>\n<li><p>av_fifo_read ä»é˜Ÿåˆ—ä¸­è¯»ä¸€ä¸ªå…ƒç´ ï¼Œé˜Ÿåˆ—é•¿åº¦å‡ 1</p>\n</li>\n<li><p>av_fifo_write ç»™é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œ é˜Ÿåˆ—é•¿åº¦åŠ 1 </p>\n</li>\n<li><p>av_fifo_freep2 é”€æ¯é˜Ÿåˆ—</p>\n</li>\n</ul>\n<h1 id=\"PacketQueue-æ“ä½œå‡½æ•°\"><a href=\"#PacketQueue-æ“ä½œå‡½æ•°\" class=\"headerlink\" title=\"PacketQueue æ“ä½œå‡½æ•°\"></a>PacketQueue æ“ä½œå‡½æ•°</h1><p><code>PacketQueue</code>æ“ä½œæä¾›ä»¥ä¸‹æ–¹æ³•ï¼š</p>\n<ul>\n<li><p>packet_queue_init:  åˆå§‹åŒ–</p>\n</li>\n<li><p>packet_queue_destroyï¼š é”€æ¯</p>\n</li>\n<li><p>packet_queue_startï¼š å¼€å¯</p>\n</li>\n<li><p>packet_queue_abortï¼š ç»ˆæ­¢</p>\n</li>\n<li><p>packet_queue_getï¼š è·å–ä¸€ä¸ªèŠ‚ç‚¹</p>\n</li>\n<li><p>packet_queue_putï¼š å­˜å…¥ä¸€ä¸ªèŠ‚ç‚¹</p>\n</li>\n<li><p>packet_queue_put_nullpacketï¼š å­˜å…¥ä¸€ä¸ªç©ºèŠ‚ç‚¹</p>\n</li>\n<li><p>packet_queue_flushï¼š æ¸…é™¤é˜Ÿåˆ—å†…æ‰€æœ‰çš„èŠ‚ç‚¹</p>\n</li>\n</ul>\n<h2 id=\"packet-queue-init\"><a href=\"#packet-queue-init\" class=\"headerlink\" title=\"packet_queue_init\"></a>packet_queue_init</h2><figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-type\">int</span> packet_queue_init(PacketQueue *q)<br>&#123;<br>    memset(q, <span class=\"hljs-number\">0</span>, <span class=\"hljs-keyword\">sizeof</span>(PacketQueue));<br>    q-&gt;pkt_list = av_fifo_alloc2(<span class=\"hljs-number\">1</span>, <span class=\"hljs-keyword\">sizeof</span>(MyAVPacketList), <span class=\"hljs-built_in\">AV_FIFO_FLAG_AUTO_GROW</span>);<br>    <span class=\"hljs-keyword\">if</span> (!q-&gt;pkt_list)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>    q-&gt;mutex = SDL_CreateMutex();<br>    <span class=\"hljs-keyword\">if</span> (!q-&gt;mutex) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-built_in\">AV_LOG_FATAL</span>, <span class=\"hljs-string\">&quot;SDL_CreateMutex(): %s\\n&quot;</span>, SDL_GetError());<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>    &#125;<br>    q-&gt;cond = SDL_CreateCond();<br>    <span class=\"hljs-keyword\">if</span> (!q-&gt;cond) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-built_in\">AV_LOG_FATAL</span>, <span class=\"hljs-string\">&quot;SDL_CreateCond(): %s\\n&quot;</span>, SDL_GetError());<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>    &#125;<br>    q-&gt;abort_request = <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å†…éƒ¨è°ƒç”¨av_fifo_alloc2 åˆ›å»ºAVFifo é˜Ÿåˆ—å®ä¾‹</p>\n</li>\n<li><p>åˆ›å»ºmutexç”¨äºé˜Ÿåˆ—å®‰å…¨è®¿é—®</p>\n</li>\n<li><p>åˆ›å»ºcond ç”¨äºé˜Ÿåˆ—ç­‰å¾…å’Œå”¤é†’æ§åˆ¶</p>\n</li>\n<li><p>åˆå§‹è®¾ç½®abort_request &#x3D; 1</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-destroy\"><a href=\"#packet-queue-destroy\" class=\"headerlink\" title=\"packet_queue_destroy\"></a>packet_queue_destroy</h2><figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">static void <span class=\"hljs-built_in\">packet_queue_destroy</span>(PacketQueue *q)<br>&#123;<br>    <span class=\"hljs-built_in\">packet_queue_flush</span>(q);<br>    <span class=\"hljs-built_in\">av_fifo_freep2</span>(&amp;q-&gt;pkt_list);<br>    <span class=\"hljs-built_in\">SDL_DestroyMutex</span>(q-&gt;mutex);<br>    <span class=\"hljs-built_in\">SDL_DestroyCond</span>(q-&gt;cond);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>è°ƒç”¨packet_queue_flushæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„å…ƒç´ </p>\n</li>\n<li><p>é”€æ¯AVFifo é˜Ÿåˆ—å®ä¾‹</p>\n</li>\n<li><p>é”€æ¯mutex</p>\n</li>\n<li><p>é”€æ¯cond</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-start\"><a href=\"#packet-queue-start\" class=\"headerlink\" title=\"packet_queue_start\"></a>packet_queue_start</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static void packet_queue_start(PacketQueue *q)<br>&#123;<br>    SDL_L<span class=\"hljs-function\"><span class=\"hljs-title\">ockMutex</span>(q-&gt;</span>mutex);<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>abort_request = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>serial++;<br>    SDL_U<span class=\"hljs-function\"><span class=\"hljs-title\">nlockMutex</span>(q-&gt;</span>mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åªæ˜¯åŠ é”ï¼Œå°†abort_requestè®¾ç½®ä¸º0ï¼Œå¹¶ä¸”å°†serialåŠ 1ï¼Œç„¶åè§£é”ã€‚</p>\n<h2 id=\"packet-queue-abort\"><a href=\"#packet-queue-abort\" class=\"headerlink\" title=\"packet_queue_abort\"></a>packet_queue_abort</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static void packet_queue_abort(PacketQueue *q)<br>&#123;<br>    SDL_L<span class=\"hljs-function\"><span class=\"hljs-title\">ockMutex</span>(q-&gt;</span>mutex);<br><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>abort_request = <span class=\"hljs-number\">1</span>;<br><br>    SDL_C<span class=\"hljs-function\"><span class=\"hljs-title\">ondSignal</span>(q-&gt;</span>cond);<br><br>    SDL_U<span class=\"hljs-function\"><span class=\"hljs-title\">nlockMutex</span>(q-&gt;</span>mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åŠ é”ï¼Œå°†abort_requestè®¾ç½®ä¸º1ï¼Œæ ‡è®°ä¸ºé˜Ÿåˆ—è¢«ç»ˆæ­¢ã€‚</p>\n<p>åŒæ—¶å”¤é†’ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹ï¼Œä½¿å…¶æ­£å¸¸é€€å‡º,   è§£é”ã€‚</p>\n<h2 id=\"packet-queue-get\"><a href=\"#packet-queue-get\" class=\"headerlink\" title=\"packet_queue_get\"></a>packet_queue_get</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* return &lt; 0 if aborted, 0 if no packet and &gt; 0 if packet.  */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">packet_queue_get</span><span class=\"hljs-params\">(PacketQueue *q, AVPacket *pkt, <span class=\"hljs-type\">int</span> block, <span class=\"hljs-type\">int</span> *serial)</span><br>&#123;<br>    MyAVPacketList pkt1;<br>    <span class=\"hljs-type\">int</span> ret;<br>    <span class=\"hljs-comment\">//åŠ é”</span><br>    SDL_LockMutex(q-&gt;mutex);<br><br>    <span class=\"hljs-keyword\">for</span> (;;) &#123;<br>        <span class=\"hljs-keyword\">if</span> (q-&gt;abort_request) &#123;<br>            <span class=\"hljs-comment\">//é˜Ÿåˆ—ç»ˆæ­¢äº†, è®¾ç½®è¿”å›å€¼ä¸º-1</span><br>            ret = <span class=\"hljs-number\">-1</span>;<br>            <span class=\"hljs-keyword\">break</span>;<br>        &#125;<br>        <span class=\"hljs-comment\">//ä»pkt_listä¸­è¯»å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ”¾å…¥MyAVPacketListä¸­ï¼ŒåŒæ—¶æ›´æ–°é˜Ÿåˆ—çš„ä¿¡æ¯</span><br>        <span class=\"hljs-keyword\">if</span> (av_fifo_read(q-&gt;pkt_list, &amp;pkt1, <span class=\"hljs-number\">1</span>) &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—é•¿åº¦</span><br>            q-&gt;nb_packets--;<br>            <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—å ç”¨å†…å­˜å¤§å°</span><br>            q-&gt;size -= pkt1.pkt-&gt;size + <span class=\"hljs-keyword\">sizeof</span>(pkt1);<br>            <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—æ—¶é•¿</span><br>            q-&gt;duration -= pkt1.pkt-&gt;duration;<br>            <span class=\"hljs-comment\">//è½¬ç§»pkt1.pktçš„å†…å®¹åˆ°pktä¸­</span><br>            av_packet_move_ref(pkt, pkt1.pkt);<br>            <span class=\"hljs-comment\">//è®¾ç½®serialçš„å€¼</span><br>            <span class=\"hljs-keyword\">if</span> (serial)<br>                *serial = pkt1.serial;<br>            <span class=\"hljs-comment\">//pkt1.pktå†…å®¹å·²è¿‘è¢«è½¬ç§»ï¼Œé‡Šæ”¾pkt1.pktçš„å†…å­˜</span><br>            av_packet_free(&amp;pkt1.pkt);<br>            <span class=\"hljs-comment\">//è¿”å›å€¼&gt;0,ä»£è¡¨ä»é˜Ÿåˆ—è·å–åˆ°äº†å…ƒç´ </span><br>            ret = <span class=\"hljs-number\">1</span>;<br>            <span class=\"hljs-keyword\">break</span>;<br>        &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!block) &#123;<br>            <span class=\"hljs-comment\">//æ²¡æœ‰è·å–åˆ°å…ƒç´ ï¼Œä½†æ˜¯è°ƒç”¨æ”¾è¦æ±‚ä¸é˜»å¡ï¼Œè®¾ç½®è¿”å›å€¼ä¸º0ï¼Œè·³å‡ºå¾ªç¯</span><br>            ret = <span class=\"hljs-number\">0</span>;<br>            <span class=\"hljs-keyword\">break</span>;<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-comment\">//æ²¡è¯»åˆ°å…ƒç´ ï¼Œé˜»å¡ç­‰å¾…æœ‰å…ƒç´ å¯ä»¥è·å–</span><br>            SDL_CondWait(q-&gt;cond, q-&gt;mutex);<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-comment\">//è§£é”</span><br>    SDL_UnlockMutex(q-&gt;mutex);<br>    <span class=\"hljs-keyword\">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå…ƒç´ </p>\n<ol>\n<li><p>åŠ é”</p>\n</li>\n<li><p>è·å–æˆåŠŸï¼Œé˜Ÿåˆ—å…ƒç´ å‡å°‘ï¼Œæ›´æ–°é˜Ÿåˆ—ä¿¡æ¯</p>\n</li>\n<li><p>è·å–å¤±è´¥ï¼Œè¦æ±‚ä¸é˜»å¡ï¼Œç«‹é©¬è¿”å›</p>\n</li>\n<li><p>è·å–å¤±è´¥ï¼Œè¦æ±‚é˜»å¡ï¼Œè°ƒç”¨waitè¿›å…¥ç­‰å¾…çŠ¶æ€</p>\n</li>\n<li><p>è§£é”</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-put\"><a href=\"#packet-queue-put\" class=\"headerlink\" title=\"packet_queue_put\"></a>packet_queue_put</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static int packet_queue_put_private(PacketQueue *q, AVPacket *pkt)<br>&#123;<br>    MyAVPacketList pkt1;<br>    int ret;<br>    <span class=\"hljs-comment\">//å¦‚æœé˜Ÿåˆ—è¢«ç»ˆæ­¢ï¼Œè¿”å›-1</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (q-&gt;</span>abort_request)<br>       return -<span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-comment\">//ç»™èŠ‚ç‚¹å¡«å……æ•°æ®</span><br>    pkt1.pkt = pkt;<br>    <span class=\"hljs-comment\">//è®¾ç½®pktçš„åºåˆ—å·</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">pkt1</span>.serial = q-&gt;</span>serial;<br>    <span class=\"hljs-comment\">//å°†èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">ret</span> = av_fifo_write(q-&gt;</span>pkt_list, &amp;pkt1, <span class=\"hljs-number\">1</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>        return ret;<br>    <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—å¤§å°</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>nb_packets++;<br>    <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—å†…å­˜å¤§å°ï¼Œæ·»åŠ èŠ‚ç‚¹size(pktå†…å­˜çš„å¤§å° + èŠ‚ç‚¹æ•°æ®å¤§å°)</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">size</span> += pkt1.pkt-&gt;</span>size + sizeof(pkt1);<br>    <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—çš„æ€»æ—¶é•¿</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">duration</span> += pkt1.pkt-&gt;</span>duration;<br>    <span class=\"hljs-comment\">/* <span class=\"hljs-doctag\">XXX:</span> should duplicate packet data in DV case */</span><br>    SDL_C<span class=\"hljs-function\"><span class=\"hljs-title\">ondSignal</span>(q-&gt;</span>cond);<br>    return <span class=\"hljs-number\">0</span>;<br>&#125;<br><br>static int packet_queue_put(PacketQueue *q, AVPacket *pkt)<br>&#123;<br>    AVPacket *pkt1;<br>    int ret;<br>    <span class=\"hljs-comment\">//åˆ›å»ºpkt1</span><br>    pkt1 = av_packet_alloc();<br>    <span class=\"hljs-keyword\">if</span> (!pkt1) &#123;<br>        <span class=\"hljs-comment\">//åˆ›å»ºpkt1å¤±è´¥ï¼Œå–æ¶ˆå¼•ç”¨pkt</span><br>        av_packet_unref(pkt);<br>        return -<span class=\"hljs-number\">1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//å°†pktå†…å®¹è½¬ç§»åˆ°pkt1ä¸­</span><br>    av_packet_move_ref(pkt1, pkt);<br>    <span class=\"hljs-comment\">//åŠ é”æ“åŠ å…¥é˜Ÿåˆ—</span><br>    SDL_L<span class=\"hljs-function\"><span class=\"hljs-title\">ockMutex</span>(q-&gt;</span>mutex);<br>    <span class=\"hljs-comment\">//è°ƒç”¨packet_queue_put_privateå°†pkt1æ”¾å…¥é˜Ÿåˆ—ä¸­</span><br>    ret = packet_queue_put_private(q, pkt1);<br>    SDL_U<span class=\"hljs-function\"><span class=\"hljs-title\">nlockMutex</span>(q-&gt;</span>mutex);<br><br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-comment\">//æ”¾å…¥é˜Ÿåˆ—å¤±è´¥ï¼Œéœ€è¦å–æ¶ˆå¼•ç”¨pkt1</span><br>        av_packet_free(&amp;pkt1);<br><br>    return ret;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å°†AVPacketå°è£…ä¸ºMyAVPacketListï¼Œä¿å­˜åœ¨å†…éƒ¨çš„é˜Ÿåˆ—ä¸­</p>\n</li>\n<li><p>é˜Ÿåˆ—é•¿åº¦åŠ 1ï¼ŒåŒæ—¶æ›´æ–°æ—¶é•¿ï¼Œå†…å­˜å ç”¨ç­‰ä¿¡æ¯</p>\n</li>\n<li><p>packet_queue_putå†…éƒ¨è°ƒç”¨packet_queue_put_privateæ¥å®Œæˆç›¸å…³çš„æ“ä½œ</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-put-nullpacket\"><a href=\"#packet-queue-put-nullpacket\" class=\"headerlink\" title=\"packet_queue_put_nullpacket\"></a>packet_queue_put_nullpacket</h2><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs aspectj\"><span class=\"hljs-comment\">//æ’­æ”¾å®Œäº†ï¼Œä»æ–‡ä»¶ä¸­è¯»å‡ºäº†ç©ºçš„pktï¼Œç©ºçš„pktä¸¢ç»™è§£ç å™¨çš„æ—¶å€™ï¼Œä¼šå†²æ´—è§£ç å™¨ï¼Œå°†è§£ç å™¨å‰©ä½™çš„é¢æ•°æ®è¯»å‡ºæ¥</span><br><span class=\"hljs-keyword\">static</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">packet_queue_put_nullpacket</span><span class=\"hljs-params\">(PacketQueue *q, AVPacket *pkt, <span class=\"hljs-keyword\">int</span> stream_index)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>Â Â Â Â <span class=\"hljs-comment\">//è®¾ç½®pktå¯¹åº”çš„stream_index </span><br>    pkt-&gt;stream_index = stream_index;<br>Â Â Â Â <span class=\"hljs-comment\">//æ·»åŠ æœ‰ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„pktåˆ°é˜Ÿåˆ—ä¸­</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">return</span> <span class=\"hljs-title\">packet_queue_put</span><span class=\"hljs-params\">(q, pkt)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>ç»™é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„pkt</p>\n</li>\n<li><p>è®¾ç½®pktå¯¹åº”çš„stream_indexï¼Œè¿½åŠ åˆ°é˜Ÿåˆ—ä¸­</p>\n</li>\n</ol>\n<h2 id=\"packet-queue-flush\"><a href=\"#packet-queue-flush\" class=\"headerlink\" title=\"packet_queue_flush\"></a>packet_queue_flush</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static void packet_queue_flush(PacketQueue *q)<br>&#123;<br>    MyAVPacketList pkt1;<br>    <span class=\"hljs-comment\">//åŠ é”</span><br>    SDL_L<span class=\"hljs-function\"><span class=\"hljs-title\">ockMutex</span>(q-&gt;</span>mutex);<br>    <span class=\"hljs-comment\">//ä»å†…éƒ¨é˜Ÿåˆ—å¾ªç¯è·å–å…ƒç´ ï¼Œå­˜å…¥pkt1ä¸­</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">while</span> (av_fifo_read(q-&gt;</span>pkt_list, &amp;pkt1, <span class=\"hljs-number\">1</span>) &gt;= <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-comment\">//é‡Šæ”¾MyAVPacketListä¸­çš„AVPacketçš„å†…å­˜</span><br>        av_packet_free(&amp;pkt1.pkt);<br>    <span class=\"hljs-comment\">//æ›´æ–°é˜Ÿåˆ—ä¿¡æ¯</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>nb_packets = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>size = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>duration = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//serialåŠ 1</span><br>    <span class=\"hljs-function\"><span class=\"hljs-title\">q</span>-&gt;</span>serial++;<br>    <span class=\"hljs-comment\">//è§£é”</span><br>    SDL_U<span class=\"hljs-function\"><span class=\"hljs-title\">nlockMutex</span>(q-&gt;</span>mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p> æ¸…ç©ºé˜Ÿåˆ—ï¼Œé‡Šæ”¾èŠ‚ç‚¹çš„å†…å­˜ï¼Œæ›´æ–°é˜Ÿåˆ—ä¿¡æ¯ã€‚</p>\n<p>è€Œå¯¹äºserialçš„æ“ä½œä¸æ˜¯è®¾ç½®ä¸º0ï¼Œè€Œæ˜¯åœ¨åŸæ¥çš„åŸºç¡€ä¸Šå¢åŠ äº†1ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>\n<h2 id=\"æ€»ç»“ï¼š\"><a href=\"#æ€»ç»“ï¼š\" class=\"headerlink\" title=\"æ€»ç»“ï¼š\"></a>æ€»ç»“ï¼š</h2><ol>\n<li><p>ffplay ç”¨PacketQueueæ¥ä¿å­˜è§£å°è£…åçš„AVPacket</p>\n</li>\n<li><p>PacketQueueå¯¹å…ƒç´ çš„æ“ä½œï¼Œä¾èµ–äºå†…éƒ¨åŸºäºffmpeg AVFifoçš„é˜Ÿåˆ—å®ä¾‹</p>\n</li>\n<li><p>PacketQueueé€šè¿‡mutexæ¥ä¿è¯çº¿å±‚å®‰å…¨</p>\n</li>\n<li><p>PacketQueueé€šè¿‡æ¡ä»¶å˜é‡æ¥æ§åˆ¶å†™å…¥å’Œè¯»å–çš„é¡ºåº</p>\n</li>\n</ol>\n"},{"layout":"post","title":"ffmpeg example 5.ç¡¬ä»¶è§£ç ","date":"2022-03-12T16:00:00.000Z","_content":"\n\n\nåœ¨`hw_decode.c`ç¤ºä¾‹ä¸­ï¼Œffmpegå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿæ¥è§£ç è§†é¢‘ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚\n\n\n\n## ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹\n\nå±•ç¤ºæ‰€æœ‰å¯ç”¨çš„ç¡¬ä»¶åŠ é€Ÿæ–¹æ³•, åœ¨macä¸Šåªæ‰¾åˆ°äº†`videotoolbox`åŠ é€Ÿçš„æ–¹å¼ã€‚\n\n```shell\nffmpeg -hwaccels\nHardware acceleration methods:\nvideotoolbox\n```\n\næŸ¥çœ‹ AVHWDeviceTypeçš„å®šä¹‰ï¼Œå‘ç°åˆ«çš„å¹³å°å¯ä»¥ä½¿ç”¨cudaï¼Œopenclï¼Œ mediacodecï¼Œvulkanç­‰æ¥å®ç°ç¡¬ä»¶åŠ é€Ÿã€‚\n\n```\nenum AVHWDeviceType {\n    AV_HWDEVICE_TYPE_NONE,\n    AV_HWDEVICE_TYPE_VDPAU,\n    AV_HWDEVICE_TYPE_CUDA,\n    AV_HWDEVICE_TYPE_VAAPI,\n    AV_HWDEVICE_TYPE_DXVA2,\n    AV_HWDEVICE_TYPE_QSV,\n    AV_HWDEVICE_TYPE_VIDEOTOOLBOX,\n    AV_HWDEVICE_TYPE_D3D11VA,\n    AV_HWDEVICE_TYPE_DRM,\n    AV_HWDEVICE_TYPE_OPENCL,\n    AV_HWDEVICE_TYPE_MEDIACODEC,\n    AV_HWDEVICE_TYPE_VULKAN,\n};\n```\n\n## æºç åˆ†æ\n\n è°ƒç”¨è¯¥ç¤ºä¾‹ç¨‹åºã€‚\n\n```\n./hw_decode videotoolbox /tmp/test.mp4 /tmp/test.yuv\n```\n\n1. å‚æ•°videotoolbox æŒ‡å®šä½¿ç”¨çš„ç¡¬ä»¶åŠ é€Ÿæ–¹å¼ï¼Œmacå¹³å°åªæ‰¾åˆ°è¿™ä¸€ç§\n\n2. /tmp/test.mp4 æŒ‡å®šè¦è§£å°è£…çš„æ–‡ä»¶ï¼Œä»æ–‡ä»¶ä¸­è¯»å–h264è¿›è¡Œè§£ç \n\n3. /tmp/test.yuv æŒ‡å®šè§£ç åå†™å…¥çš„æ–‡ä»¶è·¯å¾„\n\n### main å‡½æ•°\n\n```\nint main(int argc, char *argv[])\n{\n    AVFormatContext *input_ctx = NULL;\n    int video_stream, ret;\n    AVStream *video = NULL;\n    AVCodecContext *decoder_ctx = NULL;\n    const AVCodec *decoder = NULL;\n    AVPacket *packet = NULL;\n    enum AVHWDeviceType type;\n    int i;\n\n    if (argc < 4) {\n        fprintf(stderr, \"Usage: %s <device type> <input file> <output file>\\n\", argv[0]);\n        return -1;\n    }\n    //æ ¹æ®ä¼ å…¥åŠ é€Ÿå™¨åå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„type\n    type = av_hwdevice_find_type_by_name(argv[1]);\n    if (type == AV_HWDEVICE_TYPE_NONE) {\n        fprintf(stderr, \"Device type %s is not supported.\\n\", argv[1]);\n        fprintf(stderr, \"Available device types:\");\n        //æ²¡æ‰¾åˆ°åŠ é€Ÿå™¨ï¼Œæ‰“å°ffmepg æ”¯æŒçš„åŠ é€Ÿå™¨åˆ—è¡¨\n        while((type = av_hwdevice_iterate_types(type)) != AV_HWDEVICE_TYPE_NONE)\n            fprintf(stderr, \" %s\", av_hwdevice_get_type_name(type));\n        fprintf(stderr, \"\\n\");\n        return -1;\n    }\n    //ç”³è¯·packetä¿å­˜è§£ç å‰æ•°æ®\n    packet = av_packet_alloc();\n    if (!packet) {\n        fprintf(stderr, \"Failed to allocate AVPacket\\n\");\n        return -1;\n    }\n\n    //æ‰“å¼€è¾“å…¥çš„æ–‡ä»¶ï¼Œå…³è”åˆ°AVFormatContext\n    if (avformat_open_input(&input_ctx, argv[2], NULL, NULL) != 0) {\n        fprintf(stderr, \"Cannot open input file '%s'\\n\", argv[2]);\n        return -1;\n    }\n    //å¡«å……AVFormatContextï¼Œè·å–è§£å°è£…ä¿¡æ¯\n    if (avformat_find_stream_info(input_ctx, NULL) < 0) {\n        fprintf(stderr, \"Cannot find input stream information.\\n\");\n        return -1;\n    }\n\n    //æ‰¾åˆ°video å¯¹åº”çš„stream indexï¼Œ è·å–å¯¹åº”çš„è§£ç å™¨ä¿¡æ¯\n    ret = av_find_best_stream(input_ctx, AVMEDIA_TYPE_VIDEO, -1, -1, &decoder, 0);\n    if (ret < 0) {\n        fprintf(stderr, \"Cannot find a video stream in the input file\\n\");\n        return -1;\n    }\n    video_stream = ret;\n\n    //éå†è·å–è§£ç å™¨å¯¹åº”çš„ç¡¬ä»¶é…ç½®ä¿¡æ¯\n    for (i = 0;; i++) {\n        const AVCodecHWConfig *config = avcodec_get_hw_config(decoder, i);\n        //å¦‚æœæ²¡æ‰¾åˆ°æ”¯æŒçš„configï¼Œç»“æŸç¨‹åº\n        if (!config) {\n            fprintf(stderr, \"Decoder %s does not support device type %s.\\n\",\n                    decoder->name, av_hwdevice_get_type_name(type));\n            return -1;\n        }\n        /*\n         å¦‚æœconfigçš„device_typeåŒ¹é…æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œå¹¶ä¸”configçš„methodsçš„å€¼ä¸ºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX\n         ä¿å­˜æ”¯æŒçš„hw_pix_fmtï¼Œè·³å‡ºå¾ªç¯\n         \n         å…³äºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX\n         å¦‚æœæˆ‘ä»¬é€‰æ‹©äº†æ­¤ç§ç±»å‹ï¼Œéœ€è¦åœ¨è°ƒç”¨avcodec_open2()æ‰“å¼€è§£ç å™¨ä¹‹å‰ï¼Œç»™AVCodecContext.hw_device_ctxè®¾ç½®æ­£ç¡®çš„å€¼ã€‚\n         */\n        \n        if (config->methods & AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX &&\n            config->device_type == type) {\n            hw_pix_fmt = config->pix_fmt;\n            break;\n        }\n    }\n    //åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡\n    if (!(decoder_ctx = avcodec_alloc_context3(decoder)))\n        return AVERROR(ENOMEM);\n\n    video = input_ctx->streams[video_stream];\n    //ç»™è§£ç å™¨ä¸Šä¸‹æ–‡å¡«å……å‚æ•°ï¼Œå¤åˆ¶ä»æ–‡ä»¶ä¸­è¯»çš„çš„è§£ç å™¨å‚æ•°\n    if (avcodec_parameters_to_context(decoder_ctx, video->codecpar) < 0)\n        return -1;\n    \n    //get_formatæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬ç»™ffmpegæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œffmpeg è°ƒç”¨è¯¥å‡½æ•°ç¡®å®šè§£ç å¸§çš„æ•°æ®æ ¼å¼\n    decoder_ctx->get_format  = get_hw_format;\n\n    //æ ¹æ®AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTXçš„å®šä¹‰ï¼Œæˆ‘ä»¬éœ€è¦ç»™ctx->hw_device_ctxèµ‹å€¼\n    if (hw_decoder_init(decoder_ctx, type) < 0)\n        return -1;\n    //æ‰“å¼€è§£ç å™¨\n    if ((ret = avcodec_open2(decoder_ctx, decoder, NULL)) < 0) {\n        fprintf(stderr, \"Failed to open codec for stream #%u\\n\", video_stream);\n        return -1;\n    }\n\n    /* open the file to dump raw data */\n    output_file = fopen(argv[3], \"w+b\");\n\n    /* actual decoding and dump the raw data */\n    while (ret >= 0) {\n        //ä»æ–‡ä»¶ä¸­å¾ªç¯è¯»è§†é¢‘å¸§ï¼Œå­˜å…¥packet\n        if ((ret = av_read_frame(input_ctx, packet)) < 0)\n            break;\n\n        if (video_stream == packet->stream_index)\n            //è§£ç packetï¼Œå†™æ–‡ä»¶\n            ret = decode_write(decoder_ctx, packet);\n\n        av_packet_unref(packet);\n    }\n    //å†²æ´—è§£ç å™¨\n    /* flush the decoder */\n    ret = decode_write(decoder_ctx, NULL);\n\n    if (output_file)\n        fclose(output_file);\n    av_packet_free(&packet);\n    avcodec_free_context(&decoder_ctx);\n    avformat_close_input(&input_ctx);\n    av_buffer_unref(&hw_device_ctx);\n\n    return 0;\n}\n\n```\n\n\n\n1. éªŒè¯æˆ‘ä»¬è®¾ç½®çš„åŠ é€Ÿå™¨æ˜¯å¦æ­£ç¡®\n\n2. æ‰“å¼€æ–‡ä»¶ï¼Œè§£å°è£…ï¼Œè¯»å–è§†é¢‘æµï¼Œè§£ç å™¨ä¿¡æ¯\n\n3. è·å–è§£ç å™¨æ”¯æŒçš„ç¡¬ä»¶é…ç½®ä¿¡æ¯ï¼Œéå†ï¼Œæ‰¾åˆ°æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œä¿å­˜ç›®æ ‡é¢œè‰²æ ¼å¼\n\n4. åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡ï¼Œå¡«å……è§£ç å‚æ•°ï¼Œé€šè¿‡`get_format`å‘ŠçŸ¥è§£ç å™¨ç›®æ ‡é¢œè‰²æ ¼å¼\n\n5. åˆ›å»ºåŠ é€Ÿå™¨å®ä¾‹ï¼Œå‘Šè¯‰è§£ç å™¨ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„åŠ é€Ÿå™¨å®ä¾‹\n\n6. ä»æ–‡ä»¶ä¸­è¯»è§†é¢‘å¸§ï¼Œé€å…¥è§£ç å™¨\n\n7. ä»è§£ç å™¨ä¸­è¯»å–frameï¼Œåˆ¤æ–­é¢œè‰²æ ¼å¼ï¼Œå¤„ç†æ•°æ®ä»GPUå¤åˆ¶åˆ°CPU\n\n8. å»æ‰frameçš„å­—èŠ‚å¯¹é½ï¼Œå†™å…¥è¾“å‡ºæ–‡ä»¶ä¸­\n\n\n\n### ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼\n\n```\n    //éå†è·å–è§£ç å™¨å¯¹åº”çš„ç¡¬ä»¶é…ç½®ä¿¡æ¯\n    for (i = 0;; i++) {\n        const AVCodecHWConfig *config = avcodec_get_hw_config(decoder, i);\n        //å¦‚æœæ²¡æ‰¾åˆ°æ”¯æŒçš„configï¼Œç»“æŸç¨‹åº\n        if (!config) {\n            fprintf(stderr, \"Decoder %s does not support device type %s.\\n\",\n                    decoder->name, av_hwdevice_get_type_name(type));\n            return -1;\n        }\n        /*\n         å¦‚æœconfigçš„device_typeåŒ¹é…æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œå¹¶ä¸”configçš„methodsçš„å€¼ä¸ºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX\n         ä¿å­˜æ”¯æŒçš„hw_pix_fmtï¼Œè·³å‡ºå¾ªç¯\n         \n         å…³äºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX\n         å¦‚æœæˆ‘ä»¬é€‰æ‹©äº†æ­¤ç§ç±»å‹ï¼Œéœ€è¦åœ¨è°ƒç”¨avcodec_open2()æ‰“å¼€è§£ç å™¨ä¹‹å‰ï¼Œç»™AVCodecContext.hw_device_ctxè®¾ç½®æ­£ç¡®çš„å€¼ã€‚\n         */\n        \n        if (config->methods & AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX &&\n            config->device_type == type) {\n            hw_pix_fmt = config->pix_fmt;\n            break;\n        }\n    }\n\n```\n\n\n\nå‘Šè¯‰è§£ç å™¨ï¼Œæˆ‘ä»¬å¸Œæœ›è¾“å‡ºåƒç´ æ ¼å¼\n\n```\n    //get_formatæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬ç»™ffmpegæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œffmpeg è°ƒç”¨è¯¥å‡½æ•°ç¡®å®šè§£ç å¸§çš„æ•°æ®æ ¼å¼\n    decoder_ctx->get_format  = get_hw_format;\n\n```\n\n get_hw_format\n\n```\nstatic enum AVPixelFormat get_hw_format(AVCodecContext *ctx,\n                                        const enum AVPixelFormat *pix_fmts)\n{\n    const enum AVPixelFormat *p;\n\n    for (p = pix_fmts; *p != -1; p++) {\n        if (*p == hw_pix_fmt)\n            return *p;\n    }\n\n    fprintf(stderr, \"Failed to get HW surface format.\\n\");\n    return AV_PIX_FMT_NONE;\n}\n\n```\n\n### åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨\n\n```\nstatic int hw_decoder_init(AVCodecContext *ctx, const enum AVHWDeviceType type)\n{\n    int err = 0;\n    //åˆ›å»ºç¡¬ä»¶åŠ é€Ÿå™¨å®ä¾‹\n    if ((err = av_hwdevice_ctx_create(&hw_device_ctx, type,\n                                      NULL, NULL, 0)) < 0) {\n        fprintf(stderr, \"Failed to create specified HW device.\\n\");\n        return err;\n    }\n    //å‘Šè¯‰è§£ç å™¨ï¼Œä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„ç¡¬ä»¶åŠ é€Ÿå™¨\n    ctx->hw_device_ctx = av_buffer_ref(hw_device_ctx);\n\n    return err;\n}\n\n\n```\n\n### è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU\n\n```\nstatic int decode_write(AVCodecContext *avctx, AVPacket *packet)\n{\n    AVFrame *frame = NULL, *sw_frame = NULL;\n    AVFrame *tmp_frame = NULL;\n    uint8_t *buffer = NULL;\n    int size;\n    int ret = 0;\n\n    ret = avcodec_send_packet(avctx, packet);\n    if (ret < 0) {\n        fprintf(stderr, \"Error during decoding\\n\");\n        return ret;\n    }\n\n    while (1) {\n        if (!(frame = av_frame_alloc()) || !(sw_frame = av_frame_alloc())) {\n            fprintf(stderr, \"Can not alloc frame\\n\");\n            ret = AVERROR(ENOMEM);\n            goto fail;\n        }\n\n        ret = avcodec_receive_frame(avctx, frame);\n        if (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF) {\n            av_frame_free(&frame);\n            av_frame_free(&sw_frame);\n            return 0;\n        } else if (ret < 0) {\n            fprintf(stderr, \"Error while decoding\\n\");\n            goto fail;\n        }\n        /*\n         æˆ‘ä»¬æœŸå¾…è§£ç å™¨èƒ½å¤Ÿè§£ç å‡ºæˆ‘ä»¬æƒ³è¦åƒç´ æ ¼å¼\n         å¦‚æœè§£ç å™¨è¾“å‡ºäº†æˆ‘ä»¬æƒ³è¦çš„æ ¼å¼ï¼Œç”±äºä½¿ç”¨äº†ç¡¬ä»¶åŠ é€Ÿï¼Œæˆ‘ä»¬éœ€è¦å°†æ•°æ®ä»GPUæ‹·è´åˆ°cpu\n         å¦‚æœæ²¡æœ‰è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„æ ¼å¼ï¼Œè¯æ˜ä½¿ç”¨çš„æ˜¯è½¯ä»¶è§£ç \n         */\n        if (frame->format == hw_pix_fmt) {\n            /* å°†è§£ç æ•°æ®ä»GPUæ‹·è´åˆ°CPU */\n            if ((ret = av_hwframe_transfer_data(sw_frame, frame, 0)) < 0) {\n                fprintf(stderr, \"Error transferring the data to system memory\\n\");\n                goto fail;\n            }\n            tmp_frame = sw_frame;\n        } else\n            tmp_frame = frame;\n        \n        //ç”³è¯·ä¸€ä¸ªAVFrame, å°†è§£ç åçš„yuv/rgbï¼Œå»æ‰å­—èŠ‚å¯¹é½æ‹·è´è¿‡æ¥\n        size = av_image_get_buffer_size(tmp_frame->format, tmp_frame->width,\n                                        tmp_frame->height, 1);\n        buffer = av_malloc(size);\n        if (!buffer) {\n            fprintf(stderr, \"Can not alloc buffer\\n\");\n            ret = AVERROR(ENOMEM);\n            goto fail;\n        }\n        //æ‹·è´ï¼Œå»æ‰å­—èŠ‚å¯¹é½\n        ret = av_image_copy_to_buffer(buffer, size,\n                                      (const uint8_t * const *)tmp_frame->data,\n                                      (const int *)tmp_frame->linesize, tmp_frame->format,\n                                      tmp_frame->width, tmp_frame->height, 1);\n        if (ret < 0) {\n            fprintf(stderr, \"Can not copy image to buffer\\n\");\n            goto fail;\n        }\n        //å°†å·²ç»å»æ‰å­—èŠ‚å¯¹é½çš„yuv/rgbæ•°æ®ï¼Œå†™å…¥æ–‡ä»¶\n        if ((ret = fwrite(buffer, 1, size, output_file)) < 0) {\n            fprintf(stderr, \"Failed to dump raw data.\\n\");\n            goto fail;\n        }\n\n    fail:\n        av_frame_free(&frame);\n        av_frame_free(&sw_frame);\n        av_freep(&buffer);\n        if (ret < 0)\n            return ret;\n    }\n}\n```\n\n## æ€»ç»“ï¼š\n\n1. è§£ç å™¨é…ç½®çš„æ—¶å€™ï¼Œéœ€è¦å‘Šè¯‰è§£ç å™¨æˆ‘ä»¬ä½¿ç”¨çš„ç¡¬ä»¶åŠ é€Ÿå™¨\n\n2. ä¸è§£ç å™¨å•†é‡è¾“å‡ºçš„é¢œè‰²æ ¼å¼\n\n3. è§£ç åå¤„ç†ï¼Œå¤„ç†ä»GPUåˆ°CPUæ‹·è´çš„å†…å­˜æ‹·è´\n\n\n\n\n","source":"_posts/ffmpeg/2022-03-14-ffmpeg example å­¦ä¹  5.md","raw":"---\nlayout: post\ntitle: \"ffmpeg example 5.ç¡¬ä»¶è§£ç \"\ndate: 2022-03-13 \ntag: ffmpeg\n---\n\n\n\nåœ¨`hw_decode.c`ç¤ºä¾‹ä¸­ï¼Œffmpegå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿæ¥è§£ç è§†é¢‘ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚\n\n\n\n## ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹\n\nå±•ç¤ºæ‰€æœ‰å¯ç”¨çš„ç¡¬ä»¶åŠ é€Ÿæ–¹æ³•, åœ¨macä¸Šåªæ‰¾åˆ°äº†`videotoolbox`åŠ é€Ÿçš„æ–¹å¼ã€‚\n\n```shell\nffmpeg -hwaccels\nHardware acceleration methods:\nvideotoolbox\n```\n\næŸ¥çœ‹ AVHWDeviceTypeçš„å®šä¹‰ï¼Œå‘ç°åˆ«çš„å¹³å°å¯ä»¥ä½¿ç”¨cudaï¼Œopenclï¼Œ mediacodecï¼Œvulkanç­‰æ¥å®ç°ç¡¬ä»¶åŠ é€Ÿã€‚\n\n```\nenum AVHWDeviceType {\n    AV_HWDEVICE_TYPE_NONE,\n    AV_HWDEVICE_TYPE_VDPAU,\n    AV_HWDEVICE_TYPE_CUDA,\n    AV_HWDEVICE_TYPE_VAAPI,\n    AV_HWDEVICE_TYPE_DXVA2,\n    AV_HWDEVICE_TYPE_QSV,\n    AV_HWDEVICE_TYPE_VIDEOTOOLBOX,\n    AV_HWDEVICE_TYPE_D3D11VA,\n    AV_HWDEVICE_TYPE_DRM,\n    AV_HWDEVICE_TYPE_OPENCL,\n    AV_HWDEVICE_TYPE_MEDIACODEC,\n    AV_HWDEVICE_TYPE_VULKAN,\n};\n```\n\n## æºç åˆ†æ\n\n è°ƒç”¨è¯¥ç¤ºä¾‹ç¨‹åºã€‚\n\n```\n./hw_decode videotoolbox /tmp/test.mp4 /tmp/test.yuv\n```\n\n1. å‚æ•°videotoolbox æŒ‡å®šä½¿ç”¨çš„ç¡¬ä»¶åŠ é€Ÿæ–¹å¼ï¼Œmacå¹³å°åªæ‰¾åˆ°è¿™ä¸€ç§\n\n2. /tmp/test.mp4 æŒ‡å®šè¦è§£å°è£…çš„æ–‡ä»¶ï¼Œä»æ–‡ä»¶ä¸­è¯»å–h264è¿›è¡Œè§£ç \n\n3. /tmp/test.yuv æŒ‡å®šè§£ç åå†™å…¥çš„æ–‡ä»¶è·¯å¾„\n\n### main å‡½æ•°\n\n```\nint main(int argc, char *argv[])\n{\n    AVFormatContext *input_ctx = NULL;\n    int video_stream, ret;\n    AVStream *video = NULL;\n    AVCodecContext *decoder_ctx = NULL;\n    const AVCodec *decoder = NULL;\n    AVPacket *packet = NULL;\n    enum AVHWDeviceType type;\n    int i;\n\n    if (argc < 4) {\n        fprintf(stderr, \"Usage: %s <device type> <input file> <output file>\\n\", argv[0]);\n        return -1;\n    }\n    //æ ¹æ®ä¼ å…¥åŠ é€Ÿå™¨åå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„type\n    type = av_hwdevice_find_type_by_name(argv[1]);\n    if (type == AV_HWDEVICE_TYPE_NONE) {\n        fprintf(stderr, \"Device type %s is not supported.\\n\", argv[1]);\n        fprintf(stderr, \"Available device types:\");\n        //æ²¡æ‰¾åˆ°åŠ é€Ÿå™¨ï¼Œæ‰“å°ffmepg æ”¯æŒçš„åŠ é€Ÿå™¨åˆ—è¡¨\n        while((type = av_hwdevice_iterate_types(type)) != AV_HWDEVICE_TYPE_NONE)\n            fprintf(stderr, \" %s\", av_hwdevice_get_type_name(type));\n        fprintf(stderr, \"\\n\");\n        return -1;\n    }\n    //ç”³è¯·packetä¿å­˜è§£ç å‰æ•°æ®\n    packet = av_packet_alloc();\n    if (!packet) {\n        fprintf(stderr, \"Failed to allocate AVPacket\\n\");\n        return -1;\n    }\n\n    //æ‰“å¼€è¾“å…¥çš„æ–‡ä»¶ï¼Œå…³è”åˆ°AVFormatContext\n    if (avformat_open_input(&input_ctx, argv[2], NULL, NULL) != 0) {\n        fprintf(stderr, \"Cannot open input file '%s'\\n\", argv[2]);\n        return -1;\n    }\n    //å¡«å……AVFormatContextï¼Œè·å–è§£å°è£…ä¿¡æ¯\n    if (avformat_find_stream_info(input_ctx, NULL) < 0) {\n        fprintf(stderr, \"Cannot find input stream information.\\n\");\n        return -1;\n    }\n\n    //æ‰¾åˆ°video å¯¹åº”çš„stream indexï¼Œ è·å–å¯¹åº”çš„è§£ç å™¨ä¿¡æ¯\n    ret = av_find_best_stream(input_ctx, AVMEDIA_TYPE_VIDEO, -1, -1, &decoder, 0);\n    if (ret < 0) {\n        fprintf(stderr, \"Cannot find a video stream in the input file\\n\");\n        return -1;\n    }\n    video_stream = ret;\n\n    //éå†è·å–è§£ç å™¨å¯¹åº”çš„ç¡¬ä»¶é…ç½®ä¿¡æ¯\n    for (i = 0;; i++) {\n        const AVCodecHWConfig *config = avcodec_get_hw_config(decoder, i);\n        //å¦‚æœæ²¡æ‰¾åˆ°æ”¯æŒçš„configï¼Œç»“æŸç¨‹åº\n        if (!config) {\n            fprintf(stderr, \"Decoder %s does not support device type %s.\\n\",\n                    decoder->name, av_hwdevice_get_type_name(type));\n            return -1;\n        }\n        /*\n         å¦‚æœconfigçš„device_typeåŒ¹é…æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œå¹¶ä¸”configçš„methodsçš„å€¼ä¸ºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX\n         ä¿å­˜æ”¯æŒçš„hw_pix_fmtï¼Œè·³å‡ºå¾ªç¯\n         \n         å…³äºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX\n         å¦‚æœæˆ‘ä»¬é€‰æ‹©äº†æ­¤ç§ç±»å‹ï¼Œéœ€è¦åœ¨è°ƒç”¨avcodec_open2()æ‰“å¼€è§£ç å™¨ä¹‹å‰ï¼Œç»™AVCodecContext.hw_device_ctxè®¾ç½®æ­£ç¡®çš„å€¼ã€‚\n         */\n        \n        if (config->methods & AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX &&\n            config->device_type == type) {\n            hw_pix_fmt = config->pix_fmt;\n            break;\n        }\n    }\n    //åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡\n    if (!(decoder_ctx = avcodec_alloc_context3(decoder)))\n        return AVERROR(ENOMEM);\n\n    video = input_ctx->streams[video_stream];\n    //ç»™è§£ç å™¨ä¸Šä¸‹æ–‡å¡«å……å‚æ•°ï¼Œå¤åˆ¶ä»æ–‡ä»¶ä¸­è¯»çš„çš„è§£ç å™¨å‚æ•°\n    if (avcodec_parameters_to_context(decoder_ctx, video->codecpar) < 0)\n        return -1;\n    \n    //get_formatæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬ç»™ffmpegæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œffmpeg è°ƒç”¨è¯¥å‡½æ•°ç¡®å®šè§£ç å¸§çš„æ•°æ®æ ¼å¼\n    decoder_ctx->get_format  = get_hw_format;\n\n    //æ ¹æ®AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTXçš„å®šä¹‰ï¼Œæˆ‘ä»¬éœ€è¦ç»™ctx->hw_device_ctxèµ‹å€¼\n    if (hw_decoder_init(decoder_ctx, type) < 0)\n        return -1;\n    //æ‰“å¼€è§£ç å™¨\n    if ((ret = avcodec_open2(decoder_ctx, decoder, NULL)) < 0) {\n        fprintf(stderr, \"Failed to open codec for stream #%u\\n\", video_stream);\n        return -1;\n    }\n\n    /* open the file to dump raw data */\n    output_file = fopen(argv[3], \"w+b\");\n\n    /* actual decoding and dump the raw data */\n    while (ret >= 0) {\n        //ä»æ–‡ä»¶ä¸­å¾ªç¯è¯»è§†é¢‘å¸§ï¼Œå­˜å…¥packet\n        if ((ret = av_read_frame(input_ctx, packet)) < 0)\n            break;\n\n        if (video_stream == packet->stream_index)\n            //è§£ç packetï¼Œå†™æ–‡ä»¶\n            ret = decode_write(decoder_ctx, packet);\n\n        av_packet_unref(packet);\n    }\n    //å†²æ´—è§£ç å™¨\n    /* flush the decoder */\n    ret = decode_write(decoder_ctx, NULL);\n\n    if (output_file)\n        fclose(output_file);\n    av_packet_free(&packet);\n    avcodec_free_context(&decoder_ctx);\n    avformat_close_input(&input_ctx);\n    av_buffer_unref(&hw_device_ctx);\n\n    return 0;\n}\n\n```\n\n\n\n1. éªŒè¯æˆ‘ä»¬è®¾ç½®çš„åŠ é€Ÿå™¨æ˜¯å¦æ­£ç¡®\n\n2. æ‰“å¼€æ–‡ä»¶ï¼Œè§£å°è£…ï¼Œè¯»å–è§†é¢‘æµï¼Œè§£ç å™¨ä¿¡æ¯\n\n3. è·å–è§£ç å™¨æ”¯æŒçš„ç¡¬ä»¶é…ç½®ä¿¡æ¯ï¼Œéå†ï¼Œæ‰¾åˆ°æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œä¿å­˜ç›®æ ‡é¢œè‰²æ ¼å¼\n\n4. åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡ï¼Œå¡«å……è§£ç å‚æ•°ï¼Œé€šè¿‡`get_format`å‘ŠçŸ¥è§£ç å™¨ç›®æ ‡é¢œè‰²æ ¼å¼\n\n5. åˆ›å»ºåŠ é€Ÿå™¨å®ä¾‹ï¼Œå‘Šè¯‰è§£ç å™¨ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„åŠ é€Ÿå™¨å®ä¾‹\n\n6. ä»æ–‡ä»¶ä¸­è¯»è§†é¢‘å¸§ï¼Œé€å…¥è§£ç å™¨\n\n7. ä»è§£ç å™¨ä¸­è¯»å–frameï¼Œåˆ¤æ–­é¢œè‰²æ ¼å¼ï¼Œå¤„ç†æ•°æ®ä»GPUå¤åˆ¶åˆ°CPU\n\n8. å»æ‰frameçš„å­—èŠ‚å¯¹é½ï¼Œå†™å…¥è¾“å‡ºæ–‡ä»¶ä¸­\n\n\n\n### ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼\n\n```\n    //éå†è·å–è§£ç å™¨å¯¹åº”çš„ç¡¬ä»¶é…ç½®ä¿¡æ¯\n    for (i = 0;; i++) {\n        const AVCodecHWConfig *config = avcodec_get_hw_config(decoder, i);\n        //å¦‚æœæ²¡æ‰¾åˆ°æ”¯æŒçš„configï¼Œç»“æŸç¨‹åº\n        if (!config) {\n            fprintf(stderr, \"Decoder %s does not support device type %s.\\n\",\n                    decoder->name, av_hwdevice_get_type_name(type));\n            return -1;\n        }\n        /*\n         å¦‚æœconfigçš„device_typeåŒ¹é…æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œå¹¶ä¸”configçš„methodsçš„å€¼ä¸ºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX\n         ä¿å­˜æ”¯æŒçš„hw_pix_fmtï¼Œè·³å‡ºå¾ªç¯\n         \n         å…³äºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX\n         å¦‚æœæˆ‘ä»¬é€‰æ‹©äº†æ­¤ç§ç±»å‹ï¼Œéœ€è¦åœ¨è°ƒç”¨avcodec_open2()æ‰“å¼€è§£ç å™¨ä¹‹å‰ï¼Œç»™AVCodecContext.hw_device_ctxè®¾ç½®æ­£ç¡®çš„å€¼ã€‚\n         */\n        \n        if (config->methods & AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX &&\n            config->device_type == type) {\n            hw_pix_fmt = config->pix_fmt;\n            break;\n        }\n    }\n\n```\n\n\n\nå‘Šè¯‰è§£ç å™¨ï¼Œæˆ‘ä»¬å¸Œæœ›è¾“å‡ºåƒç´ æ ¼å¼\n\n```\n    //get_formatæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬ç»™ffmpegæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œffmpeg è°ƒç”¨è¯¥å‡½æ•°ç¡®å®šè§£ç å¸§çš„æ•°æ®æ ¼å¼\n    decoder_ctx->get_format  = get_hw_format;\n\n```\n\n get_hw_format\n\n```\nstatic enum AVPixelFormat get_hw_format(AVCodecContext *ctx,\n                                        const enum AVPixelFormat *pix_fmts)\n{\n    const enum AVPixelFormat *p;\n\n    for (p = pix_fmts; *p != -1; p++) {\n        if (*p == hw_pix_fmt)\n            return *p;\n    }\n\n    fprintf(stderr, \"Failed to get HW surface format.\\n\");\n    return AV_PIX_FMT_NONE;\n}\n\n```\n\n### åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨\n\n```\nstatic int hw_decoder_init(AVCodecContext *ctx, const enum AVHWDeviceType type)\n{\n    int err = 0;\n    //åˆ›å»ºç¡¬ä»¶åŠ é€Ÿå™¨å®ä¾‹\n    if ((err = av_hwdevice_ctx_create(&hw_device_ctx, type,\n                                      NULL, NULL, 0)) < 0) {\n        fprintf(stderr, \"Failed to create specified HW device.\\n\");\n        return err;\n    }\n    //å‘Šè¯‰è§£ç å™¨ï¼Œä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„ç¡¬ä»¶åŠ é€Ÿå™¨\n    ctx->hw_device_ctx = av_buffer_ref(hw_device_ctx);\n\n    return err;\n}\n\n\n```\n\n### è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU\n\n```\nstatic int decode_write(AVCodecContext *avctx, AVPacket *packet)\n{\n    AVFrame *frame = NULL, *sw_frame = NULL;\n    AVFrame *tmp_frame = NULL;\n    uint8_t *buffer = NULL;\n    int size;\n    int ret = 0;\n\n    ret = avcodec_send_packet(avctx, packet);\n    if (ret < 0) {\n        fprintf(stderr, \"Error during decoding\\n\");\n        return ret;\n    }\n\n    while (1) {\n        if (!(frame = av_frame_alloc()) || !(sw_frame = av_frame_alloc())) {\n            fprintf(stderr, \"Can not alloc frame\\n\");\n            ret = AVERROR(ENOMEM);\n            goto fail;\n        }\n\n        ret = avcodec_receive_frame(avctx, frame);\n        if (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF) {\n            av_frame_free(&frame);\n            av_frame_free(&sw_frame);\n            return 0;\n        } else if (ret < 0) {\n            fprintf(stderr, \"Error while decoding\\n\");\n            goto fail;\n        }\n        /*\n         æˆ‘ä»¬æœŸå¾…è§£ç å™¨èƒ½å¤Ÿè§£ç å‡ºæˆ‘ä»¬æƒ³è¦åƒç´ æ ¼å¼\n         å¦‚æœè§£ç å™¨è¾“å‡ºäº†æˆ‘ä»¬æƒ³è¦çš„æ ¼å¼ï¼Œç”±äºä½¿ç”¨äº†ç¡¬ä»¶åŠ é€Ÿï¼Œæˆ‘ä»¬éœ€è¦å°†æ•°æ®ä»GPUæ‹·è´åˆ°cpu\n         å¦‚æœæ²¡æœ‰è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„æ ¼å¼ï¼Œè¯æ˜ä½¿ç”¨çš„æ˜¯è½¯ä»¶è§£ç \n         */\n        if (frame->format == hw_pix_fmt) {\n            /* å°†è§£ç æ•°æ®ä»GPUæ‹·è´åˆ°CPU */\n            if ((ret = av_hwframe_transfer_data(sw_frame, frame, 0)) < 0) {\n                fprintf(stderr, \"Error transferring the data to system memory\\n\");\n                goto fail;\n            }\n            tmp_frame = sw_frame;\n        } else\n            tmp_frame = frame;\n        \n        //ç”³è¯·ä¸€ä¸ªAVFrame, å°†è§£ç åçš„yuv/rgbï¼Œå»æ‰å­—èŠ‚å¯¹é½æ‹·è´è¿‡æ¥\n        size = av_image_get_buffer_size(tmp_frame->format, tmp_frame->width,\n                                        tmp_frame->height, 1);\n        buffer = av_malloc(size);\n        if (!buffer) {\n            fprintf(stderr, \"Can not alloc buffer\\n\");\n            ret = AVERROR(ENOMEM);\n            goto fail;\n        }\n        //æ‹·è´ï¼Œå»æ‰å­—èŠ‚å¯¹é½\n        ret = av_image_copy_to_buffer(buffer, size,\n                                      (const uint8_t * const *)tmp_frame->data,\n                                      (const int *)tmp_frame->linesize, tmp_frame->format,\n                                      tmp_frame->width, tmp_frame->height, 1);\n        if (ret < 0) {\n            fprintf(stderr, \"Can not copy image to buffer\\n\");\n            goto fail;\n        }\n        //å°†å·²ç»å»æ‰å­—èŠ‚å¯¹é½çš„yuv/rgbæ•°æ®ï¼Œå†™å…¥æ–‡ä»¶\n        if ((ret = fwrite(buffer, 1, size, output_file)) < 0) {\n            fprintf(stderr, \"Failed to dump raw data.\\n\");\n            goto fail;\n        }\n\n    fail:\n        av_frame_free(&frame);\n        av_frame_free(&sw_frame);\n        av_freep(&buffer);\n        if (ret < 0)\n            return ret;\n    }\n}\n```\n\n## æ€»ç»“ï¼š\n\n1. è§£ç å™¨é…ç½®çš„æ—¶å€™ï¼Œéœ€è¦å‘Šè¯‰è§£ç å™¨æˆ‘ä»¬ä½¿ç”¨çš„ç¡¬ä»¶åŠ é€Ÿå™¨\n\n2. ä¸è§£ç å™¨å•†é‡è¾“å‡ºçš„é¢œè‰²æ ¼å¼\n\n3. è§£ç åå¤„ç†ï¼Œå¤„ç†ä»GPUåˆ°CPUæ‹·è´çš„å†…å­˜æ‹·è´\n\n\n\n\n","slug":"ffmpeg/2022-03-14-ffmpeg example å­¦ä¹  5","published":1,"updated":"2024-03-06T11:53:13.565Z","comments":1,"photos":[],"_id":"clti3glkq002357wh5cxydnfm","content":"<p>åœ¨<code>hw_decode.c</code>ç¤ºä¾‹ä¸­ï¼Œffmpegå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿæ¥è§£ç è§†é¢‘ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>\n<h2 id=\"ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹\"><a href=\"#ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹\" class=\"headerlink\" title=\"ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹\"></a>ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹</h2><p>å±•ç¤ºæ‰€æœ‰å¯ç”¨çš„ç¡¬ä»¶åŠ é€Ÿæ–¹æ³•, åœ¨macä¸Šåªæ‰¾åˆ°äº†<code>videotoolbox</code>åŠ é€Ÿçš„æ–¹å¼ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">ffmpeg -hwaccels<br>Hardware acceleration methods:<br>videotoolbox<br></code></pre></td></tr></table></figure>\n\n<p>æŸ¥çœ‹ AVHWDeviceTypeçš„å®šä¹‰ï¼Œå‘ç°åˆ«çš„å¹³å°å¯ä»¥ä½¿ç”¨cudaï¼Œopenclï¼Œ mediacodecï¼Œvulkanç­‰æ¥å®ç°ç¡¬ä»¶åŠ é€Ÿã€‚</p>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVHWDeviceType</span> &#123;<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_NONE</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_VDPAU</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_CUDA</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_VAAPI</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_DXVA2</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_QSV</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_VIDEOTOOLBOX</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_D3D11VA</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_DRM</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_OPENCL</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_MEDIACODEC</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_VULKAN</span>,<br>&#125;;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æºç åˆ†æ\"><a href=\"#æºç åˆ†æ\" class=\"headerlink\" title=\"æºç åˆ†æ\"></a>æºç åˆ†æ</h2><p> è°ƒç”¨è¯¥ç¤ºä¾‹ç¨‹åºã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">./hw_decode videotoolbox /tmp/test.mp4 /tmp/test.yuv<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å‚æ•°videotoolbox æŒ‡å®šä½¿ç”¨çš„ç¡¬ä»¶åŠ é€Ÿæ–¹å¼ï¼Œmacå¹³å°åªæ‰¾åˆ°è¿™ä¸€ç§</p>\n</li>\n<li><p>&#x2F;tmp&#x2F;test.mp4 æŒ‡å®šè¦è§£å°è£…çš„æ–‡ä»¶ï¼Œä»æ–‡ä»¶ä¸­è¯»å–h264è¿›è¡Œè§£ç </p>\n</li>\n<li><p>&#x2F;tmp&#x2F;test.yuv æŒ‡å®šè§£ç åå†™å…¥çš„æ–‡ä»¶è·¯å¾„</p>\n</li>\n</ol>\n<h3 id=\"main-å‡½æ•°\"><a href=\"#main-å‡½æ•°\" class=\"headerlink\" title=\"main å‡½æ•°\"></a>main å‡½æ•°</h3><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arduino\"><span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">char</span> *argv[])</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    AVFormatContext *input_ctx = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">int</span> video_stream, ret;<br>    AVStream *video = <span class=\"hljs-literal\">NULL</span>;<br>    AVCodecContext *decoder_ctx = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">const</span> AVCodec *decoder = <span class=\"hljs-literal\">NULL</span>;<br>    AVPacket *packet = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title class_\">AVHWDeviceType</span> type;<br>    <span class=\"hljs-type\">int</span> i;<br><br>    <span class=\"hljs-keyword\">if</span> (argc &lt; <span class=\"hljs-number\">4</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Usage: %s &lt;device type&gt; &lt;input file&gt; &lt;output file&gt;\\n&quot;</span>, argv[<span class=\"hljs-number\">0</span>]);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//æ ¹æ®ä¼ å…¥åŠ é€Ÿå™¨åå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„type</span><br>    type = <span class=\"hljs-built_in\">av_hwdevice_find_type_by_name</span>(argv[<span class=\"hljs-number\">1</span>]);<br>    <span class=\"hljs-keyword\">if</span> (type == AV_HWDEVICE_TYPE_NONE) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Device type %s is not supported.\\n&quot;</span>, argv[<span class=\"hljs-number\">1</span>]);<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Available device types:&quot;</span>);<br>        <span class=\"hljs-comment\">//æ²¡æ‰¾åˆ°åŠ é€Ÿå™¨ï¼Œæ‰“å°ffmepg æ”¯æŒçš„åŠ é€Ÿå™¨åˆ—è¡¨</span><br>        <span class=\"hljs-keyword\">while</span>((type = <span class=\"hljs-built_in\">av_hwdevice_iterate_types</span>(type)) != AV_HWDEVICE_TYPE_NONE)<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot; %s&quot;</span>, <span class=\"hljs-built_in\">av_hwdevice_get_type_name</span>(type));<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//ç”³è¯·packetä¿å­˜è§£ç å‰æ•°æ®</span><br>    packet = <span class=\"hljs-built_in\">av_packet_alloc</span>();<br>    <span class=\"hljs-keyword\">if</span> (!packet) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Failed to allocate AVPacket\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br><br>    <span class=\"hljs-comment\">//æ‰“å¼€è¾“å…¥çš„æ–‡ä»¶ï¼Œå…³è”åˆ°AVFormatContext</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">avformat_open_input</span>(&amp;input_ctx, argv[<span class=\"hljs-number\">2</span>], <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>) != <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Cannot open input file &#x27;%s&#x27;\\n&quot;</span>, argv[<span class=\"hljs-number\">2</span>]);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//å¡«å……AVFormatContextï¼Œè·å–è§£å°è£…ä¿¡æ¯</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">avformat_find_stream_info</span>(input_ctx, <span class=\"hljs-literal\">NULL</span>) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Cannot find input stream information.\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br><br>    <span class=\"hljs-comment\">//æ‰¾åˆ°video å¯¹åº”çš„stream indexï¼Œ è·å–å¯¹åº”çš„è§£ç å™¨ä¿¡æ¯</span><br>    ret = <span class=\"hljs-built_in\">av_find_best_stream</span>(input_ctx, AVMEDIA_TYPE_VIDEO, <span class=\"hljs-number\">-1</span>, <span class=\"hljs-number\">-1</span>, &amp;decoder, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Cannot find a video stream in the input file\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    video_stream = ret;<br><br>    <span class=\"hljs-comment\">//éå†è·å–è§£ç å™¨å¯¹åº”çš„ç¡¬ä»¶é…ç½®ä¿¡æ¯</span><br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>;; i++) &#123;<br>        <span class=\"hljs-type\">const</span> AVCodecHWConfig *config = <span class=\"hljs-built_in\">avcodec_get_hw_config</span>(decoder, i);<br>        <span class=\"hljs-comment\">//å¦‚æœæ²¡æ‰¾åˆ°æ”¯æŒçš„configï¼Œç»“æŸç¨‹åº</span><br>        <span class=\"hljs-keyword\">if</span> (!config) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Decoder %s does not support device type %s.\\n&quot;</span>,<br>                    decoder-&gt;name, <span class=\"hljs-built_in\">av_hwdevice_get_type_name</span>(type));<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>        &#125;<br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         å¦‚æœconfigçš„device_typeåŒ¹é…æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œå¹¶ä¸”configçš„methodsçš„å€¼ä¸ºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX</span><br><span class=\"hljs-comment\">         ä¿å­˜æ”¯æŒçš„hw_pix_fmtï¼Œè·³å‡ºå¾ªç¯</span><br><span class=\"hljs-comment\">         </span><br><span class=\"hljs-comment\">         å…³äºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX</span><br><span class=\"hljs-comment\">         å¦‚æœæˆ‘ä»¬é€‰æ‹©äº†æ­¤ç§ç±»å‹ï¼Œéœ€è¦åœ¨è°ƒç”¨avcodec_open2()æ‰“å¼€è§£ç å™¨ä¹‹å‰ï¼Œç»™AVCodecContext.hw_device_ctxè®¾ç½®æ­£ç¡®çš„å€¼ã€‚</span><br><span class=\"hljs-comment\">         */</span><br>        <br>        <span class=\"hljs-keyword\">if</span> (config-&gt;methods &amp; AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX &amp;&amp;<br>            config-&gt;device_type == type) &#123;<br>            hw_pix_fmt = config-&gt;pix_fmt;<br>            <span class=\"hljs-keyword\">break</span>;<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-comment\">//åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡</span><br>    <span class=\"hljs-keyword\">if</span> (!(decoder_ctx = <span class=\"hljs-built_in\">avcodec_alloc_context3</span>(decoder)))<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br><br>    video = input_ctx-&gt;streams[video_stream];<br>    <span class=\"hljs-comment\">//ç»™è§£ç å™¨ä¸Šä¸‹æ–‡å¡«å……å‚æ•°ï¼Œå¤åˆ¶ä»æ–‡ä»¶ä¸­è¯»çš„çš„è§£ç å™¨å‚æ•°</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">avcodec_parameters_to_context</span>(decoder_ctx, video-&gt;codecpar) &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    <br>    <span class=\"hljs-comment\">//get_formatæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬ç»™ffmpegæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œffmpeg è°ƒç”¨è¯¥å‡½æ•°ç¡®å®šè§£ç å¸§çš„æ•°æ®æ ¼å¼</span><br>    decoder_ctx-&gt;get_format  = get_hw_format;<br><br>    <span class=\"hljs-comment\">//æ ¹æ®AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTXçš„å®šä¹‰ï¼Œæˆ‘ä»¬éœ€è¦ç»™ctx-&gt;hw_device_ctxèµ‹å€¼</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">hw_decoder_init</span>(decoder_ctx, type) &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    <span class=\"hljs-comment\">//æ‰“å¼€è§£ç å™¨</span><br>    <span class=\"hljs-keyword\">if</span> ((ret = <span class=\"hljs-built_in\">avcodec_open2</span>(decoder_ctx, decoder, <span class=\"hljs-literal\">NULL</span>)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Failed to open codec for stream #%u\\n&quot;</span>, video_stream);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* open the file to dump raw data */</span><br>    output_file = <span class=\"hljs-built_in\">fopen</span>(argv[<span class=\"hljs-number\">3</span>], <span class=\"hljs-string\">&quot;w+b&quot;</span>);<br><br>    <span class=\"hljs-comment\">/* actual decoding and dump the raw data */</span><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//ä»æ–‡ä»¶ä¸­å¾ªç¯è¯»è§†é¢‘å¸§ï¼Œå­˜å…¥packet</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = <span class=\"hljs-built_in\">av_read_frame</span>(input_ctx, packet)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">break</span>;<br><br>        <span class=\"hljs-keyword\">if</span> (video_stream == packet-&gt;stream_index)<br>            <span class=\"hljs-comment\">//è§£ç packetï¼Œå†™æ–‡ä»¶</span><br>            ret = <span class=\"hljs-built_in\">decode_write</span>(decoder_ctx, packet);<br><br>        <span class=\"hljs-built_in\">av_packet_unref</span>(packet);<br>    &#125;<br>    <span class=\"hljs-comment\">//å†²æ´—è§£ç å™¨</span><br>    <span class=\"hljs-comment\">/* flush the decoder */</span><br>    ret = <span class=\"hljs-built_in\">decode_write</span>(decoder_ctx, <span class=\"hljs-literal\">NULL</span>);<br><br>    <span class=\"hljs-keyword\">if</span> (output_file)<br>        <span class=\"hljs-built_in\">fclose</span>(output_file);<br>    <span class=\"hljs-built_in\">av_packet_free</span>(&amp;packet);<br>    <span class=\"hljs-built_in\">avcodec_free_context</span>(&amp;decoder_ctx);<br>    <span class=\"hljs-built_in\">avformat_close_input</span>(&amp;input_ctx);<br>    <span class=\"hljs-built_in\">av_buffer_unref</span>(&amp;hw_device_ctx);<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n\n\n<ol>\n<li><p>éªŒè¯æˆ‘ä»¬è®¾ç½®çš„åŠ é€Ÿå™¨æ˜¯å¦æ­£ç¡®</p>\n</li>\n<li><p>æ‰“å¼€æ–‡ä»¶ï¼Œè§£å°è£…ï¼Œè¯»å–è§†é¢‘æµï¼Œè§£ç å™¨ä¿¡æ¯</p>\n</li>\n<li><p>è·å–è§£ç å™¨æ”¯æŒçš„ç¡¬ä»¶é…ç½®ä¿¡æ¯ï¼Œéå†ï¼Œæ‰¾åˆ°æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œä¿å­˜ç›®æ ‡é¢œè‰²æ ¼å¼</p>\n</li>\n<li><p>åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡ï¼Œå¡«å……è§£ç å‚æ•°ï¼Œé€šè¿‡<code>get_format</code>å‘ŠçŸ¥è§£ç å™¨ç›®æ ‡é¢œè‰²æ ¼å¼</p>\n</li>\n<li><p>åˆ›å»ºåŠ é€Ÿå™¨å®ä¾‹ï¼Œå‘Šè¯‰è§£ç å™¨ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„åŠ é€Ÿå™¨å®ä¾‹</p>\n</li>\n<li><p>ä»æ–‡ä»¶ä¸­è¯»è§†é¢‘å¸§ï¼Œé€å…¥è§£ç å™¨</p>\n</li>\n<li><p>ä»è§£ç å™¨ä¸­è¯»å–frameï¼Œåˆ¤æ–­é¢œè‰²æ ¼å¼ï¼Œå¤„ç†æ•°æ®ä»GPUå¤åˆ¶åˆ°CPU</p>\n</li>\n<li><p>å»æ‰frameçš„å­—èŠ‚å¯¹é½ï¼Œå†™å…¥è¾“å‡ºæ–‡ä»¶ä¸­</p>\n</li>\n</ol>\n<h3 id=\"ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼\"><a href=\"#ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼\" class=\"headerlink\" title=\"ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼\"></a>ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼</h3><figure class=\"highlight verilog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs verilog\"><span class=\"hljs-comment\">//éå†è·å–è§£ç å™¨å¯¹åº”çš„ç¡¬ä»¶é…ç½®ä¿¡æ¯</span><br><span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>;; i++) &#123;<br>    <span class=\"hljs-keyword\">const</span> AVCodecHWConfig *<span class=\"hljs-keyword\">config</span> = avcodec_get_hw_config(decoder, i);<br>    <span class=\"hljs-comment\">//å¦‚æœæ²¡æ‰¾åˆ°æ”¯æŒçš„configï¼Œç»“æŸç¨‹åº</span><br>    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">config</span>) &#123;<br>        fprintf(stderr, <span class=\"hljs-string\">&quot;Decoder %s does not support device type %s.\\n&quot;</span>,<br>                decoder-&gt;name, av_hwdevice_get_type_name(<span class=\"hljs-keyword\">type</span>));<br>        <span class=\"hljs-keyword\">return</span> -<span class=\"hljs-number\">1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     å¦‚æœconfigçš„device_typeåŒ¹é…æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œå¹¶ä¸”configçš„methodsçš„å€¼ä¸ºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX</span><br><span class=\"hljs-comment\">     ä¿å­˜æ”¯æŒçš„hw_pix_fmtï¼Œè·³å‡ºå¾ªç¯</span><br><span class=\"hljs-comment\">     </span><br><span class=\"hljs-comment\">     å…³äºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX</span><br><span class=\"hljs-comment\">     å¦‚æœæˆ‘ä»¬é€‰æ‹©äº†æ­¤ç§ç±»å‹ï¼Œéœ€è¦åœ¨è°ƒç”¨avcodec_open2()æ‰“å¼€è§£ç å™¨ä¹‹å‰ï¼Œç»™AVCodecContext.hw_device_ctxè®¾ç½®æ­£ç¡®çš„å€¼ã€‚</span><br><span class=\"hljs-comment\">     */</span><br>    <br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">config</span>-&gt;methods &amp; AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX &amp;&amp;<br>        <span class=\"hljs-keyword\">config</span>-&gt;device_type == <span class=\"hljs-keyword\">type</span>) &#123;<br>        hw_pix_fmt = <span class=\"hljs-keyword\">config</span>-&gt;pix_fmt;<br>        <span class=\"hljs-keyword\">break</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n\n\n<p>å‘Šè¯‰è§£ç å™¨ï¼Œæˆ‘ä»¬å¸Œæœ›è¾“å‡ºåƒç´ æ ¼å¼</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\"><span class=\"hljs-comment\">//get_formatæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬ç»™ffmpegæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œffmpeg è°ƒç”¨è¯¥å‡½æ•°ç¡®å®šè§£ç å¸§çš„æ•°æ®æ ¼å¼</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">decoder_ctx</span>-&gt;</span>get_format  = get_hw_format;<br><br></code></pre></td></tr></table></figure>\n\n<p> get_hw_format</p>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVPixelFormat</span> get_hw_format(<span class=\"hljs-built_in\">AVCodecContext</span> *ctx,<br>                                        <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVPixelFormat</span> *pix_fmts)<br>&#123;<br>    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVPixelFormat</span> *p;<br><br>    <span class=\"hljs-keyword\">for</span> (p = pix_fmts; *p != <span class=\"hljs-number\">-1</span>; p++) &#123;<br>        <span class=\"hljs-keyword\">if</span> (*p == hw_pix_fmt)<br>            <span class=\"hljs-keyword\">return</span> *p;<br>    &#125;<br><br>    fprintf(stderr, <span class=\"hljs-string\">&quot;Failed to get HW surface format.\\n&quot;</span>);<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AV_PIX_FMT_NONE</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨\"><a href=\"#åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨\" class=\"headerlink\" title=\"åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨\"></a>åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title\">hw_decoder_init</span><span class=\"hljs-params\">(AVCodecContext *ctx, <span class=\"hljs-type\">const</span> <span class=\"hljs-keyword\">enum</span> AVHWDeviceType type)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    <span class=\"hljs-type\">int</span> err = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//åˆ›å»ºç¡¬ä»¶åŠ é€Ÿå™¨å®ä¾‹</span><br>    <span class=\"hljs-keyword\">if</span> ((err = <span class=\"hljs-built_in\">av_hwdevice_ctx_create</span>(&amp;hw_device_ctx, type,<br>                                      <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Failed to create specified HW device.\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> err;<br>    &#125;<br>    <span class=\"hljs-comment\">//å‘Šè¯‰è§£ç å™¨ï¼Œä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„ç¡¬ä»¶åŠ é€Ÿå™¨</span><br>    ctx-&gt;hw_device_ctx = <span class=\"hljs-built_in\">av_buffer_ref</span>(hw_device_ctx);<br><br>    <span class=\"hljs-keyword\">return</span> err;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU\"><a href=\"#è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU\" class=\"headerlink\" title=\"è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU\"></a>è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU</h3><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arduino\"><span class=\"hljs-function\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title\">decode_write</span><span class=\"hljs-params\">(AVCodecContext *avctx, AVPacket *packet)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    AVFrame *frame = <span class=\"hljs-literal\">NULL</span>, *sw_frame = <span class=\"hljs-literal\">NULL</span>;<br>    AVFrame *tmp_frame = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">uint8_t</span> *buffer = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">int</span> size;<br>    <span class=\"hljs-type\">int</span> ret = <span class=\"hljs-number\">0</span>;<br><br>    ret = <span class=\"hljs-built_in\">avcodec_send_packet</span>(avctx, packet);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Error during decoding\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> ret;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">while</span> (<span class=\"hljs-number\">1</span>) &#123;<br>        <span class=\"hljs-keyword\">if</span> (!(frame = <span class=\"hljs-built_in\">av_frame_alloc</span>()) || !(sw_frame = <span class=\"hljs-built_in\">av_frame_alloc</span>())) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Can not alloc frame\\n&quot;</span>);<br>            ret = <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br><br>        ret = <span class=\"hljs-built_in\">avcodec_receive_frame</span>(avctx, frame);<br>        <span class=\"hljs-keyword\">if</span> (ret == <span class=\"hljs-built_in\">AVERROR</span>(EAGAIN) || ret == AVERROR_EOF) &#123;<br>            <span class=\"hljs-built_in\">av_frame_free</span>(&amp;frame);<br>            <span class=\"hljs-built_in\">av_frame_free</span>(&amp;sw_frame);<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>        &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Error while decoding\\n&quot;</span>);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         æˆ‘ä»¬æœŸå¾…è§£ç å™¨èƒ½å¤Ÿè§£ç å‡ºæˆ‘ä»¬æƒ³è¦åƒç´ æ ¼å¼</span><br><span class=\"hljs-comment\">         å¦‚æœè§£ç å™¨è¾“å‡ºäº†æˆ‘ä»¬æƒ³è¦çš„æ ¼å¼ï¼Œç”±äºä½¿ç”¨äº†ç¡¬ä»¶åŠ é€Ÿï¼Œæˆ‘ä»¬éœ€è¦å°†æ•°æ®ä»GPUæ‹·è´åˆ°cpu</span><br><span class=\"hljs-comment\">         å¦‚æœæ²¡æœ‰è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„æ ¼å¼ï¼Œè¯æ˜ä½¿ç”¨çš„æ˜¯è½¯ä»¶è§£ç </span><br><span class=\"hljs-comment\">         */</span><br>        <span class=\"hljs-keyword\">if</span> (frame-&gt;format == hw_pix_fmt) &#123;<br>            <span class=\"hljs-comment\">/* å°†è§£ç æ•°æ®ä»GPUæ‹·è´åˆ°CPU */</span><br>            <span class=\"hljs-keyword\">if</span> ((ret = <span class=\"hljs-built_in\">av_hwframe_transfer_data</span>(sw_frame, frame, <span class=\"hljs-number\">0</span>)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>                <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Error transferring the data to system memory\\n&quot;</span>);<br>                <span class=\"hljs-keyword\">goto</span> fail;<br>            &#125;<br>            tmp_frame = sw_frame;<br>        &#125; <span class=\"hljs-keyword\">else</span><br>            tmp_frame = frame;<br>        <br>        <span class=\"hljs-comment\">//ç”³è¯·ä¸€ä¸ªAVFrame, å°†è§£ç åçš„yuv/rgbï¼Œå»æ‰å­—èŠ‚å¯¹é½æ‹·è´è¿‡æ¥</span><br>        size = <span class=\"hljs-built_in\">av_image_get_buffer_size</span>(tmp_frame-&gt;format, tmp_frame-&gt;width,<br>                                        tmp_frame-&gt;height, <span class=\"hljs-number\">1</span>);<br>        buffer = <span class=\"hljs-built_in\">av_malloc</span>(size);<br>        <span class=\"hljs-keyword\">if</span> (!buffer) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Can not alloc buffer\\n&quot;</span>);<br>            ret = <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br>        <span class=\"hljs-comment\">//æ‹·è´ï¼Œå»æ‰å­—èŠ‚å¯¹é½</span><br>        ret = <span class=\"hljs-built_in\">av_image_copy_to_buffer</span>(buffer, size,<br>                                      (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint8_t</span> * <span class=\"hljs-type\">const</span> *)tmp_frame-&gt;data,<br>                                      (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">int</span> *)tmp_frame-&gt;linesize, tmp_frame-&gt;format,<br>                                      tmp_frame-&gt;width, tmp_frame-&gt;height, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Can not copy image to buffer\\n&quot;</span>);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br>        <span class=\"hljs-comment\">//å°†å·²ç»å»æ‰å­—èŠ‚å¯¹é½çš„yuv/rgbæ•°æ®ï¼Œå†™å…¥æ–‡ä»¶</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = <span class=\"hljs-built_in\">fwrite</span>(buffer, <span class=\"hljs-number\">1</span>, size, output_file)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Failed to dump raw data.\\n&quot;</span>);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br><br>    fail:<br>        <span class=\"hljs-built_in\">av_frame_free</span>(&amp;frame);<br>        <span class=\"hljs-built_in\">av_frame_free</span>(&amp;sw_frame);<br>        <span class=\"hljs-built_in\">av_freep</span>(&amp;buffer);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">return</span> ret;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æ€»ç»“ï¼š\"><a href=\"#æ€»ç»“ï¼š\" class=\"headerlink\" title=\"æ€»ç»“ï¼š\"></a>æ€»ç»“ï¼š</h2><ol>\n<li><p>è§£ç å™¨é…ç½®çš„æ—¶å€™ï¼Œéœ€è¦å‘Šè¯‰è§£ç å™¨æˆ‘ä»¬ä½¿ç”¨çš„ç¡¬ä»¶åŠ é€Ÿå™¨</p>\n</li>\n<li><p>ä¸è§£ç å™¨å•†é‡è¾“å‡ºçš„é¢œè‰²æ ¼å¼</p>\n</li>\n<li><p>è§£ç åå¤„ç†ï¼Œå¤„ç†ä»GPUåˆ°CPUæ‹·è´çš„å†…å­˜æ‹·è´</p>\n</li>\n</ol>\n","excerpt":"","more":"<p>åœ¨<code>hw_decode.c</code>ç¤ºä¾‹ä¸­ï¼Œffmpegå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿæ¥è§£ç è§†é¢‘ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>\n<h2 id=\"ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹\"><a href=\"#ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹\" class=\"headerlink\" title=\"ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹\"></a>ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç±»å‹</h2><p>å±•ç¤ºæ‰€æœ‰å¯ç”¨çš„ç¡¬ä»¶åŠ é€Ÿæ–¹æ³•, åœ¨macä¸Šåªæ‰¾åˆ°äº†<code>videotoolbox</code>åŠ é€Ÿçš„æ–¹å¼ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">ffmpeg -hwaccels<br>Hardware acceleration methods:<br>videotoolbox<br></code></pre></td></tr></table></figure>\n\n<p>æŸ¥çœ‹ AVHWDeviceTypeçš„å®šä¹‰ï¼Œå‘ç°åˆ«çš„å¹³å°å¯ä»¥ä½¿ç”¨cudaï¼Œopenclï¼Œ mediacodecï¼Œvulkanç­‰æ¥å®ç°ç¡¬ä»¶åŠ é€Ÿã€‚</p>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVHWDeviceType</span> &#123;<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_NONE</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_VDPAU</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_CUDA</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_VAAPI</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_DXVA2</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_QSV</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_VIDEOTOOLBOX</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_D3D11VA</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_DRM</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_OPENCL</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_MEDIACODEC</span>,<br>    <span class=\"hljs-built_in\">AV_HWDEVICE_TYPE_VULKAN</span>,<br>&#125;;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æºç åˆ†æ\"><a href=\"#æºç åˆ†æ\" class=\"headerlink\" title=\"æºç åˆ†æ\"></a>æºç åˆ†æ</h2><p> è°ƒç”¨è¯¥ç¤ºä¾‹ç¨‹åºã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">./hw_decode videotoolbox /tmp/test.mp4 /tmp/test.yuv<br></code></pre></td></tr></table></figure>\n\n<ol>\n<li><p>å‚æ•°videotoolbox æŒ‡å®šä½¿ç”¨çš„ç¡¬ä»¶åŠ é€Ÿæ–¹å¼ï¼Œmacå¹³å°åªæ‰¾åˆ°è¿™ä¸€ç§</p>\n</li>\n<li><p>&#x2F;tmp&#x2F;test.mp4 æŒ‡å®šè¦è§£å°è£…çš„æ–‡ä»¶ï¼Œä»æ–‡ä»¶ä¸­è¯»å–h264è¿›è¡Œè§£ç </p>\n</li>\n<li><p>&#x2F;tmp&#x2F;test.yuv æŒ‡å®šè§£ç åå†™å…¥çš„æ–‡ä»¶è·¯å¾„</p>\n</li>\n</ol>\n<h3 id=\"main-å‡½æ•°\"><a href=\"#main-å‡½æ•°\" class=\"headerlink\" title=\"main å‡½æ•°\"></a>main å‡½æ•°</h3><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arduino\"><span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> argc, <span class=\"hljs-type\">char</span> *argv[])</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    AVFormatContext *input_ctx = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">int</span> video_stream, ret;<br>    AVStream *video = <span class=\"hljs-literal\">NULL</span>;<br>    AVCodecContext *decoder_ctx = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">const</span> AVCodec *decoder = <span class=\"hljs-literal\">NULL</span>;<br>    AVPacket *packet = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title class_\">AVHWDeviceType</span> type;<br>    <span class=\"hljs-type\">int</span> i;<br><br>    <span class=\"hljs-keyword\">if</span> (argc &lt; <span class=\"hljs-number\">4</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Usage: %s &lt;device type&gt; &lt;input file&gt; &lt;output file&gt;\\n&quot;</span>, argv[<span class=\"hljs-number\">0</span>]);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//æ ¹æ®ä¼ å…¥åŠ é€Ÿå™¨åå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„type</span><br>    type = <span class=\"hljs-built_in\">av_hwdevice_find_type_by_name</span>(argv[<span class=\"hljs-number\">1</span>]);<br>    <span class=\"hljs-keyword\">if</span> (type == AV_HWDEVICE_TYPE_NONE) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Device type %s is not supported.\\n&quot;</span>, argv[<span class=\"hljs-number\">1</span>]);<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Available device types:&quot;</span>);<br>        <span class=\"hljs-comment\">//æ²¡æ‰¾åˆ°åŠ é€Ÿå™¨ï¼Œæ‰“å°ffmepg æ”¯æŒçš„åŠ é€Ÿå™¨åˆ—è¡¨</span><br>        <span class=\"hljs-keyword\">while</span>((type = <span class=\"hljs-built_in\">av_hwdevice_iterate_types</span>(type)) != AV_HWDEVICE_TYPE_NONE)<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot; %s&quot;</span>, <span class=\"hljs-built_in\">av_hwdevice_get_type_name</span>(type));<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//ç”³è¯·packetä¿å­˜è§£ç å‰æ•°æ®</span><br>    packet = <span class=\"hljs-built_in\">av_packet_alloc</span>();<br>    <span class=\"hljs-keyword\">if</span> (!packet) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Failed to allocate AVPacket\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br><br>    <span class=\"hljs-comment\">//æ‰“å¼€è¾“å…¥çš„æ–‡ä»¶ï¼Œå…³è”åˆ°AVFormatContext</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">avformat_open_input</span>(&amp;input_ctx, argv[<span class=\"hljs-number\">2</span>], <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>) != <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Cannot open input file &#x27;%s&#x27;\\n&quot;</span>, argv[<span class=\"hljs-number\">2</span>]);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//å¡«å……AVFormatContextï¼Œè·å–è§£å°è£…ä¿¡æ¯</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">avformat_find_stream_info</span>(input_ctx, <span class=\"hljs-literal\">NULL</span>) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Cannot find input stream information.\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br><br>    <span class=\"hljs-comment\">//æ‰¾åˆ°video å¯¹åº”çš„stream indexï¼Œ è·å–å¯¹åº”çš„è§£ç å™¨ä¿¡æ¯</span><br>    ret = <span class=\"hljs-built_in\">av_find_best_stream</span>(input_ctx, AVMEDIA_TYPE_VIDEO, <span class=\"hljs-number\">-1</span>, <span class=\"hljs-number\">-1</span>, &amp;decoder, <span class=\"hljs-number\">0</span>);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Cannot find a video stream in the input file\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br>    video_stream = ret;<br><br>    <span class=\"hljs-comment\">//éå†è·å–è§£ç å™¨å¯¹åº”çš„ç¡¬ä»¶é…ç½®ä¿¡æ¯</span><br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>;; i++) &#123;<br>        <span class=\"hljs-type\">const</span> AVCodecHWConfig *config = <span class=\"hljs-built_in\">avcodec_get_hw_config</span>(decoder, i);<br>        <span class=\"hljs-comment\">//å¦‚æœæ²¡æ‰¾åˆ°æ”¯æŒçš„configï¼Œç»“æŸç¨‹åº</span><br>        <span class=\"hljs-keyword\">if</span> (!config) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Decoder %s does not support device type %s.\\n&quot;</span>,<br>                    decoder-&gt;name, <span class=\"hljs-built_in\">av_hwdevice_get_type_name</span>(type));<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>        &#125;<br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         å¦‚æœconfigçš„device_typeåŒ¹é…æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œå¹¶ä¸”configçš„methodsçš„å€¼ä¸ºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX</span><br><span class=\"hljs-comment\">         ä¿å­˜æ”¯æŒçš„hw_pix_fmtï¼Œè·³å‡ºå¾ªç¯</span><br><span class=\"hljs-comment\">         </span><br><span class=\"hljs-comment\">         å…³äºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX</span><br><span class=\"hljs-comment\">         å¦‚æœæˆ‘ä»¬é€‰æ‹©äº†æ­¤ç§ç±»å‹ï¼Œéœ€è¦åœ¨è°ƒç”¨avcodec_open2()æ‰“å¼€è§£ç å™¨ä¹‹å‰ï¼Œç»™AVCodecContext.hw_device_ctxè®¾ç½®æ­£ç¡®çš„å€¼ã€‚</span><br><span class=\"hljs-comment\">         */</span><br>        <br>        <span class=\"hljs-keyword\">if</span> (config-&gt;methods &amp; AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX &amp;&amp;<br>            config-&gt;device_type == type) &#123;<br>            hw_pix_fmt = config-&gt;pix_fmt;<br>            <span class=\"hljs-keyword\">break</span>;<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-comment\">//åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡</span><br>    <span class=\"hljs-keyword\">if</span> (!(decoder_ctx = <span class=\"hljs-built_in\">avcodec_alloc_context3</span>(decoder)))<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br><br>    video = input_ctx-&gt;streams[video_stream];<br>    <span class=\"hljs-comment\">//ç»™è§£ç å™¨ä¸Šä¸‹æ–‡å¡«å……å‚æ•°ï¼Œå¤åˆ¶ä»æ–‡ä»¶ä¸­è¯»çš„çš„è§£ç å™¨å‚æ•°</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">avcodec_parameters_to_context</span>(decoder_ctx, video-&gt;codecpar) &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    <br>    <span class=\"hljs-comment\">//get_formatæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬ç»™ffmpegæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œffmpeg è°ƒç”¨è¯¥å‡½æ•°ç¡®å®šè§£ç å¸§çš„æ•°æ®æ ¼å¼</span><br>    decoder_ctx-&gt;get_format  = get_hw_format;<br><br>    <span class=\"hljs-comment\">//æ ¹æ®AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTXçš„å®šä¹‰ï¼Œæˆ‘ä»¬éœ€è¦ç»™ctx-&gt;hw_device_ctxèµ‹å€¼</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">hw_decoder_init</span>(decoder_ctx, type) &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    <span class=\"hljs-comment\">//æ‰“å¼€è§£ç å™¨</span><br>    <span class=\"hljs-keyword\">if</span> ((ret = <span class=\"hljs-built_in\">avcodec_open2</span>(decoder_ctx, decoder, <span class=\"hljs-literal\">NULL</span>)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Failed to open codec for stream #%u\\n&quot;</span>, video_stream);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/* open the file to dump raw data */</span><br>    output_file = <span class=\"hljs-built_in\">fopen</span>(argv[<span class=\"hljs-number\">3</span>], <span class=\"hljs-string\">&quot;w+b&quot;</span>);<br><br>    <span class=\"hljs-comment\">/* actual decoding and dump the raw data */</span><br>    <span class=\"hljs-keyword\">while</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//ä»æ–‡ä»¶ä¸­å¾ªç¯è¯»è§†é¢‘å¸§ï¼Œå­˜å…¥packet</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = <span class=\"hljs-built_in\">av_read_frame</span>(input_ctx, packet)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">break</span>;<br><br>        <span class=\"hljs-keyword\">if</span> (video_stream == packet-&gt;stream_index)<br>            <span class=\"hljs-comment\">//è§£ç packetï¼Œå†™æ–‡ä»¶</span><br>            ret = <span class=\"hljs-built_in\">decode_write</span>(decoder_ctx, packet);<br><br>        <span class=\"hljs-built_in\">av_packet_unref</span>(packet);<br>    &#125;<br>    <span class=\"hljs-comment\">//å†²æ´—è§£ç å™¨</span><br>    <span class=\"hljs-comment\">/* flush the decoder */</span><br>    ret = <span class=\"hljs-built_in\">decode_write</span>(decoder_ctx, <span class=\"hljs-literal\">NULL</span>);<br><br>    <span class=\"hljs-keyword\">if</span> (output_file)<br>        <span class=\"hljs-built_in\">fclose</span>(output_file);<br>    <span class=\"hljs-built_in\">av_packet_free</span>(&amp;packet);<br>    <span class=\"hljs-built_in\">avcodec_free_context</span>(&amp;decoder_ctx);<br>    <span class=\"hljs-built_in\">avformat_close_input</span>(&amp;input_ctx);<br>    <span class=\"hljs-built_in\">av_buffer_unref</span>(&amp;hw_device_ctx);<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n\n\n<ol>\n<li><p>éªŒè¯æˆ‘ä»¬è®¾ç½®çš„åŠ é€Ÿå™¨æ˜¯å¦æ­£ç¡®</p>\n</li>\n<li><p>æ‰“å¼€æ–‡ä»¶ï¼Œè§£å°è£…ï¼Œè¯»å–è§†é¢‘æµï¼Œè§£ç å™¨ä¿¡æ¯</p>\n</li>\n<li><p>è·å–è§£ç å™¨æ”¯æŒçš„ç¡¬ä»¶é…ç½®ä¿¡æ¯ï¼Œéå†ï¼Œæ‰¾åˆ°æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œä¿å­˜ç›®æ ‡é¢œè‰²æ ¼å¼</p>\n</li>\n<li><p>åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡ï¼Œå¡«å……è§£ç å‚æ•°ï¼Œé€šè¿‡<code>get_format</code>å‘ŠçŸ¥è§£ç å™¨ç›®æ ‡é¢œè‰²æ ¼å¼</p>\n</li>\n<li><p>åˆ›å»ºåŠ é€Ÿå™¨å®ä¾‹ï¼Œå‘Šè¯‰è§£ç å™¨ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„åŠ é€Ÿå™¨å®ä¾‹</p>\n</li>\n<li><p>ä»æ–‡ä»¶ä¸­è¯»è§†é¢‘å¸§ï¼Œé€å…¥è§£ç å™¨</p>\n</li>\n<li><p>ä»è§£ç å™¨ä¸­è¯»å–frameï¼Œåˆ¤æ–­é¢œè‰²æ ¼å¼ï¼Œå¤„ç†æ•°æ®ä»GPUå¤åˆ¶åˆ°CPU</p>\n</li>\n<li><p>å»æ‰frameçš„å­—èŠ‚å¯¹é½ï¼Œå†™å…¥è¾“å‡ºæ–‡ä»¶ä¸­</p>\n</li>\n</ol>\n<h3 id=\"ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼\"><a href=\"#ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼\" class=\"headerlink\" title=\"ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼\"></a>ç¡¬ä»¶åŠ é€Ÿå™¨ç›®æ ‡åƒç´ æ ¼å¼</h3><figure class=\"highlight verilog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs verilog\"><span class=\"hljs-comment\">//éå†è·å–è§£ç å™¨å¯¹åº”çš„ç¡¬ä»¶é…ç½®ä¿¡æ¯</span><br><span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>;; i++) &#123;<br>    <span class=\"hljs-keyword\">const</span> AVCodecHWConfig *<span class=\"hljs-keyword\">config</span> = avcodec_get_hw_config(decoder, i);<br>    <span class=\"hljs-comment\">//å¦‚æœæ²¡æ‰¾åˆ°æ”¯æŒçš„configï¼Œç»“æŸç¨‹åº</span><br>    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">config</span>) &#123;<br>        fprintf(stderr, <span class=\"hljs-string\">&quot;Decoder %s does not support device type %s.\\n&quot;</span>,<br>                decoder-&gt;name, av_hwdevice_get_type_name(<span class=\"hljs-keyword\">type</span>));<br>        <span class=\"hljs-keyword\">return</span> -<span class=\"hljs-number\">1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     å¦‚æœconfigçš„device_typeåŒ¹é…æˆ‘ä»¬è®¾ç½®çš„ç±»å‹ï¼Œå¹¶ä¸”configçš„methodsçš„å€¼ä¸ºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX</span><br><span class=\"hljs-comment\">     ä¿å­˜æ”¯æŒçš„hw_pix_fmtï¼Œè·³å‡ºå¾ªç¯</span><br><span class=\"hljs-comment\">     </span><br><span class=\"hljs-comment\">     å…³äºAV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX</span><br><span class=\"hljs-comment\">     å¦‚æœæˆ‘ä»¬é€‰æ‹©äº†æ­¤ç§ç±»å‹ï¼Œéœ€è¦åœ¨è°ƒç”¨avcodec_open2()æ‰“å¼€è§£ç å™¨ä¹‹å‰ï¼Œç»™AVCodecContext.hw_device_ctxè®¾ç½®æ­£ç¡®çš„å€¼ã€‚</span><br><span class=\"hljs-comment\">     */</span><br>    <br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">config</span>-&gt;methods &amp; AV_CODEC_HW_CONFIG_METHOD_HW_DEVICE_CTX &amp;&amp;<br>        <span class=\"hljs-keyword\">config</span>-&gt;device_type == <span class=\"hljs-keyword\">type</span>) &#123;<br>        hw_pix_fmt = <span class=\"hljs-keyword\">config</span>-&gt;pix_fmt;<br>        <span class=\"hljs-keyword\">break</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n\n\n<p>å‘Šè¯‰è§£ç å™¨ï¼Œæˆ‘ä»¬å¸Œæœ›è¾“å‡ºåƒç´ æ ¼å¼</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\"><span class=\"hljs-comment\">//get_formatæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬ç»™ffmpegæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œffmpeg è°ƒç”¨è¯¥å‡½æ•°ç¡®å®šè§£ç å¸§çš„æ•°æ®æ ¼å¼</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">decoder_ctx</span>-&gt;</span>get_format  = get_hw_format;<br><br></code></pre></td></tr></table></figure>\n\n<p> get_hw_format</p>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVPixelFormat</span> get_hw_format(<span class=\"hljs-built_in\">AVCodecContext</span> *ctx,<br>                                        <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVPixelFormat</span> *pix_fmts)<br>&#123;<br>    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">enum</span> <span class=\"hljs-built_in\">AVPixelFormat</span> *p;<br><br>    <span class=\"hljs-keyword\">for</span> (p = pix_fmts; *p != <span class=\"hljs-number\">-1</span>; p++) &#123;<br>        <span class=\"hljs-keyword\">if</span> (*p == hw_pix_fmt)<br>            <span class=\"hljs-keyword\">return</span> *p;<br>    &#125;<br><br>    fprintf(stderr, <span class=\"hljs-string\">&quot;Failed to get HW surface format.\\n&quot;</span>);<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AV_PIX_FMT_NONE</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨\"><a href=\"#åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨\" class=\"headerlink\" title=\"åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨\"></a>åˆ›å»ºå¹¶è®¾ç½®åŠ é€Ÿå™¨</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title\">hw_decoder_init</span><span class=\"hljs-params\">(AVCodecContext *ctx, <span class=\"hljs-type\">const</span> <span class=\"hljs-keyword\">enum</span> AVHWDeviceType type)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    <span class=\"hljs-type\">int</span> err = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//åˆ›å»ºç¡¬ä»¶åŠ é€Ÿå™¨å®ä¾‹</span><br>    <span class=\"hljs-keyword\">if</span> ((err = <span class=\"hljs-built_in\">av_hwdevice_ctx_create</span>(&amp;hw_device_ctx, type,<br>                                      <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Failed to create specified HW device.\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> err;<br>    &#125;<br>    <span class=\"hljs-comment\">//å‘Šè¯‰è§£ç å™¨ï¼Œä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„ç¡¬ä»¶åŠ é€Ÿå™¨</span><br>    ctx-&gt;hw_device_ctx = <span class=\"hljs-built_in\">av_buffer_ref</span>(hw_device_ctx);<br><br>    <span class=\"hljs-keyword\">return</span> err;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU\"><a href=\"#è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU\" class=\"headerlink\" title=\"è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU\"></a>è§£ç ï¼Œæ•°æ®ä»GPUåˆ°CPU</h3><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arduino\"><span class=\"hljs-function\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title\">decode_write</span><span class=\"hljs-params\">(AVCodecContext *avctx, AVPacket *packet)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    AVFrame *frame = <span class=\"hljs-literal\">NULL</span>, *sw_frame = <span class=\"hljs-literal\">NULL</span>;<br>    AVFrame *tmp_frame = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">uint8_t</span> *buffer = <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-type\">int</span> size;<br>    <span class=\"hljs-type\">int</span> ret = <span class=\"hljs-number\">0</span>;<br><br>    ret = <span class=\"hljs-built_in\">avcodec_send_packet</span>(avctx, packet);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Error during decoding\\n&quot;</span>);<br>        <span class=\"hljs-keyword\">return</span> ret;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">while</span> (<span class=\"hljs-number\">1</span>) &#123;<br>        <span class=\"hljs-keyword\">if</span> (!(frame = <span class=\"hljs-built_in\">av_frame_alloc</span>()) || !(sw_frame = <span class=\"hljs-built_in\">av_frame_alloc</span>())) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Can not alloc frame\\n&quot;</span>);<br>            ret = <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br><br>        ret = <span class=\"hljs-built_in\">avcodec_receive_frame</span>(avctx, frame);<br>        <span class=\"hljs-keyword\">if</span> (ret == <span class=\"hljs-built_in\">AVERROR</span>(EAGAIN) || ret == AVERROR_EOF) &#123;<br>            <span class=\"hljs-built_in\">av_frame_free</span>(&amp;frame);<br>            <span class=\"hljs-built_in\">av_frame_free</span>(&amp;sw_frame);<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>        &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Error while decoding\\n&quot;</span>);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         æˆ‘ä»¬æœŸå¾…è§£ç å™¨èƒ½å¤Ÿè§£ç å‡ºæˆ‘ä»¬æƒ³è¦åƒç´ æ ¼å¼</span><br><span class=\"hljs-comment\">         å¦‚æœè§£ç å™¨è¾“å‡ºäº†æˆ‘ä»¬æƒ³è¦çš„æ ¼å¼ï¼Œç”±äºä½¿ç”¨äº†ç¡¬ä»¶åŠ é€Ÿï¼Œæˆ‘ä»¬éœ€è¦å°†æ•°æ®ä»GPUæ‹·è´åˆ°cpu</span><br><span class=\"hljs-comment\">         å¦‚æœæ²¡æœ‰è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„æ ¼å¼ï¼Œè¯æ˜ä½¿ç”¨çš„æ˜¯è½¯ä»¶è§£ç </span><br><span class=\"hljs-comment\">         */</span><br>        <span class=\"hljs-keyword\">if</span> (frame-&gt;format == hw_pix_fmt) &#123;<br>            <span class=\"hljs-comment\">/* å°†è§£ç æ•°æ®ä»GPUæ‹·è´åˆ°CPU */</span><br>            <span class=\"hljs-keyword\">if</span> ((ret = <span class=\"hljs-built_in\">av_hwframe_transfer_data</span>(sw_frame, frame, <span class=\"hljs-number\">0</span>)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>                <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Error transferring the data to system memory\\n&quot;</span>);<br>                <span class=\"hljs-keyword\">goto</span> fail;<br>            &#125;<br>            tmp_frame = sw_frame;<br>        &#125; <span class=\"hljs-keyword\">else</span><br>            tmp_frame = frame;<br>        <br>        <span class=\"hljs-comment\">//ç”³è¯·ä¸€ä¸ªAVFrame, å°†è§£ç åçš„yuv/rgbï¼Œå»æ‰å­—èŠ‚å¯¹é½æ‹·è´è¿‡æ¥</span><br>        size = <span class=\"hljs-built_in\">av_image_get_buffer_size</span>(tmp_frame-&gt;format, tmp_frame-&gt;width,<br>                                        tmp_frame-&gt;height, <span class=\"hljs-number\">1</span>);<br>        buffer = <span class=\"hljs-built_in\">av_malloc</span>(size);<br>        <span class=\"hljs-keyword\">if</span> (!buffer) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Can not alloc buffer\\n&quot;</span>);<br>            ret = <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br>        <span class=\"hljs-comment\">//æ‹·è´ï¼Œå»æ‰å­—èŠ‚å¯¹é½</span><br>        ret = <span class=\"hljs-built_in\">av_image_copy_to_buffer</span>(buffer, size,<br>                                      (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">uint8_t</span> * <span class=\"hljs-type\">const</span> *)tmp_frame-&gt;data,<br>                                      (<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">int</span> *)tmp_frame-&gt;linesize, tmp_frame-&gt;format,<br>                                      tmp_frame-&gt;width, tmp_frame-&gt;height, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Can not copy image to buffer\\n&quot;</span>);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br>        <span class=\"hljs-comment\">//å°†å·²ç»å»æ‰å­—èŠ‚å¯¹é½çš„yuv/rgbæ•°æ®ï¼Œå†™å…¥æ–‡ä»¶</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = <span class=\"hljs-built_in\">fwrite</span>(buffer, <span class=\"hljs-number\">1</span>, size, output_file)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>            <span class=\"hljs-built_in\">fprintf</span>(stderr, <span class=\"hljs-string\">&quot;Failed to dump raw data.\\n&quot;</span>);<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        &#125;<br><br>    fail:<br>        <span class=\"hljs-built_in\">av_frame_free</span>(&amp;frame);<br>        <span class=\"hljs-built_in\">av_frame_free</span>(&amp;sw_frame);<br>        <span class=\"hljs-built_in\">av_freep</span>(&amp;buffer);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">return</span> ret;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"æ€»ç»“ï¼š\"><a href=\"#æ€»ç»“ï¼š\" class=\"headerlink\" title=\"æ€»ç»“ï¼š\"></a>æ€»ç»“ï¼š</h2><ol>\n<li><p>è§£ç å™¨é…ç½®çš„æ—¶å€™ï¼Œéœ€è¦å‘Šè¯‰è§£ç å™¨æˆ‘ä»¬ä½¿ç”¨çš„ç¡¬ä»¶åŠ é€Ÿå™¨</p>\n</li>\n<li><p>ä¸è§£ç å™¨å•†é‡è¾“å‡ºçš„é¢œè‰²æ ¼å¼</p>\n</li>\n<li><p>è§£ç åå¤„ç†ï¼Œå¤„ç†ä»GPUåˆ°CPUæ‹·è´çš„å†…å­˜æ‹·è´</p>\n</li>\n</ol>\n"},{"layout":"post","title":"FFmpeg filter","date":"2022-03-14T16:00:00.000Z","_content":"\nå‚è€ƒï¼š\n\n[FFmpeg filterç®€ä»‹ - Tocy - åšå®¢å›­](https://www.cnblogs.com/tocy/p/ffmpeg-filter-intro.html)\n\n[FFmpeg Filtering Guide](https://trac.ffmpeg.org/wiki/FilteringGuide)\n\n[FFmpeg Filters Documentation](http://ffmpeg.org/ffmpeg-filters.html)\n\n[FFmpeg filterçš„ä½¿ç”¨ä»‹ç»]([FFmpeg filterçš„ä½¿ç”¨ä»‹ç» - ç®€ä¹¦](https://www.jianshu.com/p/b16835da62ab))\n\n\n","source":"_posts/ffmpeg/2022-03-15-ffmpeg filters.md","raw":"---\nlayout: post\ntitle: \"FFmpeg filter\"\ndate: 2022-03-15\ntag: ffmpeg\n\n---\n\nå‚è€ƒï¼š\n\n[FFmpeg filterç®€ä»‹ - Tocy - åšå®¢å›­](https://www.cnblogs.com/tocy/p/ffmpeg-filter-intro.html)\n\n[FFmpeg Filtering Guide](https://trac.ffmpeg.org/wiki/FilteringGuide)\n\n[FFmpeg Filters Documentation](http://ffmpeg.org/ffmpeg-filters.html)\n\n[FFmpeg filterçš„ä½¿ç”¨ä»‹ç»]([FFmpeg filterçš„ä½¿ç”¨ä»‹ç» - ç®€ä¹¦](https://www.jianshu.com/p/b16835da62ab))\n\n\n","slug":"ffmpeg/2022-03-15-ffmpeg filters","published":1,"updated":"2024-03-07T03:07:32.474Z","comments":1,"photos":[],"_id":"clti3glkr002557whb7nncwt0","content":"<p>å‚è€ƒï¼š</p>\n<p><a href=\"https://www.cnblogs.com/tocy/p/ffmpeg-filter-intro.html\">FFmpeg filterç®€ä»‹ - Tocy - åšå®¢å›­</a></p>\n<p><a href=\"https://trac.ffmpeg.org/wiki/FilteringGuide\">FFmpeg Filtering Guide</a></p>\n<p><a href=\"http://ffmpeg.org/ffmpeg-filters.html\">FFmpeg Filters Documentation</a></p>\n<p>[FFmpeg filterçš„ä½¿ç”¨ä»‹ç»](<a href=\"https://www.jianshu.com/p/b16835da62ab\">FFmpeg filterçš„ä½¿ç”¨ä»‹ç» - ç®€ä¹¦</a>)</p>\n","excerpt":"","more":"<p>å‚è€ƒï¼š</p>\n<p><a href=\"https://www.cnblogs.com/tocy/p/ffmpeg-filter-intro.html\">FFmpeg filterç®€ä»‹ - Tocy - åšå®¢å›­</a></p>\n<p><a href=\"https://trac.ffmpeg.org/wiki/FilteringGuide\">FFmpeg Filtering Guide</a></p>\n<p><a href=\"http://ffmpeg.org/ffmpeg-filters.html\">FFmpeg Filters Documentation</a></p>\n<p>[FFmpeg filterçš„ä½¿ç”¨ä»‹ç»](<a href=\"https://www.jianshu.com/p/b16835da62ab\">FFmpeg filterçš„ä½¿ç”¨ä»‹ç» - ç®€ä¹¦</a>)</p>\n"},{"layout":"post","title":"ffplay frame queue åˆ†æ","date":"2022-03-14T16:00:00.000Z","_content":"\nå‚è€ƒï¼š  [ffplay frame queueåˆ†æ](https://zhuanlan.zhihu.com/p/43564980)\n\n## FrameQueueæ•°æ®ç»“æ„\n\nffplay å®šä¹‰äº† FrameQueue æ¥ç®¡ç†è§£ç åçš„éŸ³é¢‘ï¼Œè§†é¢‘ä»¥åŠå­—å¹•ã€‚\n\n```c\n/* Common struct for handling all types of decoded data and allocated render buffers. */\ntypedef struct Frame {\n    AVFrame *frame;       //audio/video frame\n    AVSubtitle sub;       //å­—å¹•\n    int serial;           //åºåˆ—å·\n    double pts;           /* presentation timestamp for the frame */\n    double duration;      /* estimated duration of the frame */\n    int64_t pos;          /* byte position of the frame in the input file */\n    int width;\n    int height;\n    int format;\n    AVRational sar;       //video aspect ratio\n    int uploaded;\n    int flip_v;           //videoï¼Œæ˜¯å¦åº”è¯¥åœ¨å‚ç›´æ–¹å‘ç¿»è½¬\n} Frame;\n\ntypedef struct FrameQueue {\n    Frame queue[FRAME_QUEUE_SIZE];  //frameæ•°ç»„ï¼Œç¯å½¢buffer\n    int rindex;                     //è¯»æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¯è¯»çš„ä½ç½®\n    int windex;                     //å†™æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¯å†™çš„ä½ç½®\n    int size;                       //é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°\n    int max_size;                   //é˜Ÿåˆ—å®¹é‡\n    int keep_last;                  //æ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­ä¿ç•™ä¸Šä¸€ä¸ªå·²è¯»çš„å…ƒç´ \n    int rindex_shown;               //æ ‡è®°rindexæŒ‡å‘çš„å…ƒç´ æ˜¯å¦å·²ç»å±•ç¤ºï¼ˆå·²è¯»ï¼‰ï¼Œkeep_lastä¸º1æ—¶ç”Ÿæ•ˆã€‚\n    SDL_mutex *mutex;               //é”,ç”¨äºå®‰å…¨è®¿é—®\n    SDL_cond *cond;                 //æ¡ä»¶å˜é‡ï¼Œç”¨äºæ§åˆ¶è¯»å–å’Œå†™å…¥ï¼Œé˜²æ­¢overrunå’Œunderflow\n    PacketQueue *pktq;              //è¯¥frame queue å¯¹åº”çš„ pkt queue\n} FrameQueue;\n```\n\n> Frameçš„è®¾è®¡è¯•å›¾ç”¨ä¸€ä¸ªç»“æ„ä½“â€œèåˆâ€3ç§æ•°æ®ï¼šè§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ï¼Œè™½ç„¶AVFrameæ—¢å¯ä»¥è¡¨ç¤ºè§†é¢‘åˆå¯ä»¥è¡¨ç¤ºéŸ³é¢‘ï¼Œä½†åœ¨èåˆå­—å¹•æ—¶åˆéœ€è¦å¼•å…¥AVSubtitleï¼Œä»¥åŠä¸€äº›å…¶ä»–å­—æ®µï¼Œå¦‚width/heightç­‰æ¥è¡¥å……AVSubtitleï¼Œæ‰€ä»¥æ•´ä¸ªç»“æ„ä½“çœ‹èµ·æ¥å¾ˆâ€œæ‹¼å‡‘â€ï¼ˆç”šè‡³è¿˜æœ‰è§†é¢‘ä¸“ç”¨çš„flip_vå­—æ®µï¼‰\n> \n> FrameQueueçš„è®¾è®¡ç†å¿µï¼š\n> \n> 1. é«˜æ•ˆç‡çš„è¯»å†™æ¨¡å‹\n> 2. é«˜æ•ˆçš„å†…å­˜æ¨¡å‹ï¼ˆèŠ‚ç‚¹å†…å­˜ä»¥æ•°ç»„å½¢å¼é¢„åˆ†é…ï¼Œæ— éœ€åŠ¨æ€åˆ†é…ï¼‰\n> 3. ç¯å½¢ç¼“å†²åŒºè®¾è®¡ï¼ŒåŒæ—¶å¯ä»¥è®¿é—®ä¸Šä¸€è¯»èŠ‚ç‚¹\n\n## é˜Ÿåˆ—çš„æ“ä½œï¼š\n\n### é˜Ÿåˆ—åˆå§‹åŒ–\n\n```c\nstatic int frame_queue_init(FrameQueue *f, PacketQueue *pktq, int max_size, int keep_last)\n{\n    int i;\n    memset(f, 0, sizeof(FrameQueue));\n    //äº’æ–¥é”åˆ›å»º\n    if (!(f->mutex = SDL_CreateMutex())) {\n        av_log(NULL, AV_LOG_FATAL, \"SDL_CreateMutex(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    //æ¡ä»¶å˜é‡åˆ›å»º\n    if (!(f->cond = SDL_CreateCond())) {\n        av_log(NULL, AV_LOG_FATAL, \"SDL_CreateCond(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    //è®¾ç½®å¯¹åº”çš„pkt queue\n    f->pktq = pktq;\n    //è®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œè§†é¢‘ 3, éŸ³é¢‘ 9ï¼Œå­—å¹• 16\n    f->max_size = FFMIN(max_size, FRAME_QUEUE_SIZE);\n    //æ˜¯å¦ä¿ç•™æœ€åä¸€ä¸ªä½ç½®ï¼Œè§†é¢‘éŸ³é¢‘ä¿ç•™ï¼Œå­—å¹•ä¸ä¿ç•™\n    f->keep_last = !!keep_last;\n    //ç»™é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„frameåˆå§‹åŒ–\n    for (i = 0; i < f->max_size; i++)\n        if (!(f->queue[i].frame = av_frame_alloc()))\n            return AVERROR(ENOMEM);\n    return 0;\n}\n```\n\nåˆå§‹åŒ–é˜Ÿåˆ—çš„å†…å­˜ï¼Œåˆ›å»ºé”ï¼Œæ¡ä»¶å˜é‡ï¼Œä¿å­˜pkt queueï¼Œè®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œkeep_lastæ ‡å¿—ä½åˆå§‹åŒ–ã€‚åˆå§‹åŒ–é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç»™é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„frameè°ƒç”¨av_frame_allocåˆ†é…å†…å­˜ã€‚\n\nå‚æ•°max_sizeç”¨æ¥è®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œæœ€å¤§ä¸è¶…è¿‡FRAME_QUEUE_SIZEã€‚å…¶ä¸­è§†é¢‘é˜Ÿåˆ—çš„å®¹é‡ä¸º3ï¼ŒéŸ³é¢‘9ï¼Œå­—å¹•16ã€‚FRAME_QUEUE_SIZEå®šä¹‰å¦‚ä¸‹:\n\n```c\n#define VIDEO_PICTURE_QUEUE_SIZE 3\n#define SUBPICTURE_QUEUE_SIZE 16\n#define SAMPLE_QUEUE_SIZE 9\n#define FRAME_QUEUE_SIZE FFMAX(SAMPLE_QUEUE_SIZE, FFMAX(VIDEO_PICTURE_QUEUE_SIZE, SUBPICTURE_QUEUE_SIZE))\n```\n\nå±•å¼€åFRAME_QUEUE_SIZEçš„å€¼ä¸º16ã€‚\n\nkeep_lastæ˜¯ä¸€ä¸ªboolå€¼ï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨ç¯å½¢ç¼“å†²åŒºçš„è¯»å†™è¿‡ç¨‹ä¸­ä¿ç•™æœ€åä¸€ä¸ªè¯»èŠ‚ç‚¹ä¸è¢«è¦†å†™ã€‚`f->keep_last = !!keep_last;`é‡Œçš„åŒæ„Ÿå¹å·æ˜¯Cä¸­çš„ä¸€ç§æŠ€å·§ï¼Œæ—¨åœ¨è®©intå‚æ•°è§„æ•´ä¸º0/1çš„â€œboolå€¼â€ã€‚è§†é¢‘å’ŒéŸ³é¢‘ä¼šä¿ç•™æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå­—å¹•ä¸ä¿ç•™ã€‚\n\n\n\n### é˜Ÿåˆ—é”€æ¯\n\n```c\nstatic void frame_queue_destory(FrameQueue *f)\n{\n    int i;\n    for (i = 0; i < f->max_size; i++) {\n        Frame *vp = &f->queue[i];\nÂ Â Â Â Â Â Â Â //å¯¹æ¯ä¸ªèŠ‚ç‚¹è°ƒç”¨frame_queue_unref_item\n        frame_queue_unref_item(vp);\nÂ Â Â Â Â Â Â Â //è°ƒç”¨av_frame_freeé‡Šæ”¾frameçš„å†…å­˜\n        av_frame_free(&vp->frame);\n    }\n    SDL_DestroyMutex(f->mutex);\n    SDL_DestroyCond(f->cond);\n}\n```\n\nè¾ƒä¸ºé‡è¦çš„æ˜¯queueå…ƒç´ çš„é‡Šæ”¾ã€‚åˆ†ä¸¤æ­¥ï¼Œåˆ†åˆ«æ˜¯`frame_queue_unref_item`å’Œ`av_frame_free`ã€‚å…¶ä¸­`av_frame_free`ä¸åˆå§‹åŒ–ä¸­çš„`av_frame_alloc`å¯¹åº”ï¼Œç”¨äºé‡Šæ”¾AVFrame.\n\n`frame_queue_unref_item`çš„å®šä¹‰å¦‚ä¸‹ï¼š\n\n```c\nstatic void frame_queue_unref_item(Frame *vp)\n{\n    av_frame_unref(vp->frame);//å¼•ç”¨è®¡æ•°-1\n    avsubtitle_free(&vp->sub);//subå…³è”çš„å†…å­˜é‡Šæ”¾\n}\n```\n\n`frame_queue_unref_item`é‡Šæ”¾çš„å†…å­˜éƒ½æ˜¯**å…³è”**çš„å†…å­˜ï¼Œè€Œéç»“æ„ä½“è‡ªèº«å†…å­˜ã€‚\n\nAVFrameå†…éƒ¨æœ‰è®¸å¤šçš„AVBufferRefç±»å‹å­—æ®µï¼Œè€ŒAVBufferRefåªæ˜¯AVBufferçš„å¼•ç”¨ï¼ŒAVBufferé€šè¿‡å¼•ç”¨è®¡æ•°è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼ˆç®€æ˜“åƒåœ¾å›æ”¶æœºåˆ¶ï¼‰ã€‚å› æ­¤AVFrameåœ¨ä¸éœ€è¦çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡`av_frame_unref`å‡å°‘å¼•ç”¨è®¡æ•°ã€‚\n\n> å…³äºAVBufferRefçš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š [æ·±å…¥ç†è§£FFMPEG-AVBuffer/AVBufferRef/AVBufferPool]([æ·±å…¥ç†è§£FFMPEG-AVBuffer/AVBufferRef/AVBufferPool_muyuyuzhongçš„ä¸“æ -CSDNåšå®¢](https://blog.csdn.net/muyuyuzhong/article/details/79381152))\n\n### é˜Ÿåˆ—å†™æ“ä½œ\n\nFrameQueueçš„â€œå†™â€åˆ†ä¸¤æ­¥ï¼Œå…ˆè°ƒç”¨`frame_queue_peek_writable`è·å–ä¸€ä¸ªå¯å†™èŠ‚ç‚¹ï¼Œåœ¨å¯¹èŠ‚ç‚¹æ“ä½œç»“æŸåï¼Œè°ƒç”¨`frame_queue_push`å‘ŠçŸ¥FrameQueueâ€œå­˜å…¥â€è¯¥èŠ‚ç‚¹ã€‚\n\n> é˜…è¯»æç¤ºï¼š  \n> åœ¨ffplayä¸­ï¼ŒFrameQueueå§‹ç»ˆæ˜¯ä¸€ä¸ªçº¿ç¨‹å†™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»ã€‚ä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªè¯»çº¿ç¨‹ï¼Œä¸ä¼šæœ‰å…¶ä»–è¯»çº¿ç¨‹ç«äº‰è¯»ï¼›åªæœ‰ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹ç«äº‰å†™ï¼›å”¯ä¸€éœ€è¦çš„æ˜¯è¯»ä¸å†™çº¿ç¨‹é—´çš„åŒæ­¥ã€‚FrameQueueçš„æ•´ä¸ªä¼˜åŒ–å’Œè®¾è®¡æ€è·¯æ­£æ˜¯åŸºäºè¿™ä¸€ç‚¹çš„ã€‚\n\nå…ˆçœ‹`frame_queue_peek_writable`ï¼š\n\n```c\nstatic Frame *frame_queue_peek_writable(FrameQueue *f)\n{\n    /* wait until we have space to put a new frame */\n    SDL_LockMutex(f->mutex);\n    while (f->size >= f->max_size &&\n           !f->pktq->abort_request) {\n        //ç­‰å¾…æœ‰ç©ºé—´å¯ä»¥å†™ï¼Œæ‰ç»§ç»­æ‰§è¡Œ\n        SDL_CondWait(f->cond, f->mutex);\n    }\n    SDL_UnlockMutex(f->mutex);\n\n    if (f->pktq->abort_request)\n        return NULL;\n    //è¿”å›f->windexå¯¹åº”çš„frame\n    return &f->queue[f->windex];\n}\n```\n\næ•´ä¸ªå‡½æ•°åˆ†3æ­¥ï¼š\n\n1. åŠ é”æƒ…å†µä¸‹ï¼Œç­‰å¾…ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºä½™ç©ºé—´å¯å†™ï¼ˆ`f->size < f->max_size`ï¼‰\n2. å¦‚æœæœ‰é€€å‡ºè¯·æ±‚ï¼ˆ`f->pktq->abort_request`ï¼‰ï¼Œåˆ™è¿”å›NULL\n3. è¿”å›`windex`ä½ç½®çš„å…ƒç´ ï¼ˆ`windex`æŒ‡å‘å½“å‰åº”å†™ä½ç½®ï¼‰\n\n> ä¸ºä»€ä¹ˆè¿™é‡Œé”çš„èŒƒå›´ä¸æ˜¯æ•´ä¸ªå‡½æ•°å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†å‡å°é”çš„èŒƒå›´ï¼Œä»¥æé«˜æ•ˆç‡ã€‚è€Œä¹‹æ‰€ä»¥å¯ä»¥åœ¨æ— é”çš„æƒ…å†µä¸‹å®‰å…¨è®¿é—®queue å­—æ®µï¼Œæ˜¯å› ä¸ºä¸Šæ–‡ä¸­æåˆ°çš„å•è¯»å•å†™çš„ç‰¹æ®Šåœºæ™¯ã€‚é¦–å…ˆï¼Œqueueæ˜¯ä¸€ä¸ªé¢„å…ˆåˆ†é…å¥½çš„æ•°ç»„ï¼Œå› æ­¤queueæœ¬èº«ä¸å‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥å®‰å…¨è®¿é—®ï¼›æ¥ç€queueå†…çš„å…ƒç´ ï¼Œè¯»å’Œå†™ä¸å­˜åœ¨é‡å ï¼Œå³windexå’Œrindexä¸ä¼šé‡å ã€‚\n> \n> å…³äºâ€œè¯»å’Œå†™ä¸å­˜åœ¨é‡å â€ï¼Œä»”ç»†çœ‹çœ‹ã€‚å› ä¸ºqueueæ•°ç»„è¢«å½“åšä¸€ä¸ªç¯å½¢ç¼“å†²åŒºä½¿ç”¨ï¼Œé‚£ä¹ˆçš„ç¡®å­˜åœ¨underrunå’Œoverrunçš„æƒ…å†µï¼Œå³è¯»è¿‡å¿«ï¼Œæˆ–å†™è¿‡å¿«çš„æƒ…å†µï¼Œè¿™æ—¶å¦‚æœä¸åŠ æ§åˆ¶ï¼Œå°±ä¼šå‘ˆç°ç¼“å†²åŒºè¦†ç›–ã€‚\n> \n> FrameQueueçš„ç²¾æ˜ä¹‹å¤„åœ¨äºï¼Œå…ˆé€šè¿‡sizeåˆ¤æ–­å½“å‰ç¼“å†²åŒºå†…ç©ºé—´æ˜¯å¦å¤Ÿå†™ï¼Œæˆ–è€…å¤Ÿè¯»ï¼Œæ¯”å¦‚è¿™é‡Œå…ˆé€šè¿‡ä¸€ä¸ªå¾ªç¯çš„æ¡ä»¶ç­‰å¾…ï¼Œåˆ¤æ–­`f->size >= f->max_size`ï¼Œå¦‚æœ`f->size >= f->max_size`ï¼Œé‚£ä¹ˆè¯´æ˜é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å·²ç»å†™æ»¡ï¼Œä¹Ÿå°±æ˜¯å·²ç»overrunäº†ï¼Œæ­¤æ—¶å¦‚æœå†å†™ï¼Œè‚¯å®šä¼šè¦†å†™æœªè¯»æ•°æ®ï¼Œé‚£ä¹ˆå°±éœ€è¦ç»§ç»­ç­‰å¾…ã€‚å½“æ— éœ€ç­‰å¾…æ—¶ï¼ŒwindexæŒ‡å‘çš„å†…å­˜ä¸€å®šæ˜¯å·²ç»è¯»è¿‡çš„ï¼ˆé™¤éä»£ç å¼‚å¸¸äº†ï¼‰ã€‚\n> \n> è°ƒç”¨`frame_queue_peek_writable`å–åˆ°FrameæŒ‡é’ˆåï¼Œå°±å¯ä»¥å¯¹Frameå†…çš„å­—æ®µè‡ªç”±æ”¹å†™ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå†™è¿›ç¨‹ï¼Œä¸”æ— éœ€æ‹…å¿ƒè¯»è¿›ç¨‹è¦†å†™ã€‚å¦‚ä¸Šåˆ†æï¼Œè¯»è¿›ç¨‹è¦è¯»ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¹Ÿä¼šå…ˆåˆ¤æ–­underrunçš„æƒ…å†µï¼‰ã€‚\n\nä¸€èˆ¬æ­¥éª¤æ˜¯ï¼š\n\n```c\nFrame* vp = frame_queue_peek_writable(q);\n//å°†è¦å­˜å‚¨çš„æ•°æ®å†™å…¥frameå­—æ®µï¼Œæ¯”å¦‚ï¼š\nav_frame_move_ref(vp->frame, src_frame);\n//å­˜å…¥é˜Ÿåˆ—\nframe_queue_push(q);\n```\n\n`frame_queue_push`æ€ä¹ˆçŸ¥é“è¦pushçš„æ˜¯è¿™é‡Œçš„vpå‘¢ï¼Ÿ\n\n```c\nstatic void frame_queue_push(FrameQueue *f)\n{\n    if (++f->windex == f->max_size)\n        f->windex = 0;\n    SDL_LockMutex(f->mutex);\n    f->size++;\n    SDL_CondSignal(f->cond);\n    SDL_UnlockMutex(f->mutex);\n}\n```\n\nç­”æ¡ˆæ˜¯pushå½“å‰windexèŠ‚ç‚¹ã€‚çœ‹`frame_queue_push`å‡½æ•°ï¼Œæ‰§è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š\n\n1. windexåŠ 1ï¼Œå¦‚æœè¶…è¿‡max_sizeï¼Œåˆ™å›ç¯ä¸º0\n2. åŠ é”æƒ…å†µä¸‹å¤§å°åŠ 1.\n\n> å› ä¸ºFrameQueueæ˜¯åŸºäºå›ºå®šé•¿åº¦çš„æ•°ç»„å®ç°çš„é˜Ÿåˆ—ï¼Œä¸é“¾è¡¨é˜Ÿåˆ—ä¸åŒï¼Œå…¶èŠ‚ç‚¹åœ¨åˆå§‹åŒ–çš„æ—¶å€™å·²ç»åœ¨é˜Ÿåˆ—ä¸­äº†ï¼Œpushæ‰€è¦åšçš„åªæ˜¯é€šè¿‡æŸç§æ ‡å¿—è®°å½•è¯¥èŠ‚ç‚¹æ˜¯å¦æ˜¯å†™å…¥æœªè¯»çš„ã€‚ffplayçš„åšæ³•æ˜¯å¯¹windexåŠ 1ï¼Œå°†å†™æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå‡¡æ˜¯windexâ€œä¹‹å‰â€çš„èŠ‚ç‚¹ï¼Œéƒ½æ˜¯å†™è¿‡çš„ã€‚ï¼ˆè‡³äºæ˜¯å¦å¯è¯»ï¼ŒrindexçŸ¥é“ï¼›è‡³äºåç»­æœ‰å¤šå°‘ç©ºé—´å¯å†™ï¼ŒsizeçŸ¥é“ï¼‰\n\n### é˜Ÿåˆ—è¯»æ“ä½œ\n\nå’Œå†™ä¸€æ ·ï¼ŒFrameQueueçš„è¯»ä¹Ÿåˆ†ä¸¤æ­¥ã€‚`frame_queue_peek_readable`å’Œ`frame_queue_next`ã€‚ç›¸æ¯”å†™è¦å¤æ‚ä¸€ç‚¹çš„æ˜¯ ï¼Œè¯»çš„ä»£ç å¤šè€ƒè™‘å¦ä¸€ä¸ªç‰¹æ€§ï¼Œå³å…è®¸ä¿ç•™ä¸Šä¸€è¯»èŠ‚ç‚¹ã€‚\n\n`frame_queue_peek_readable`ä»£ç å¦‚ä¸‹ï¼š\n\n```c\nstatic Frame *frame_queue_peek_readable(FrameQueue *f)\n{\n    /* wait until we have a readable a new frame */\n    SDL_LockMutex(f->mutex);\n    while (f->size - f->rindex_shown <= 0 &&\n           !f->pktq->abort_request) {\n        SDL_CondWait(f->cond, f->mutex);\n    }\n    SDL_UnlockMutex(f->mutex);\n\n    if (f->pktq->abort_request)\n        return NULL;\n\n    return &f->queue[(f->rindex + f->rindex_shown) % f->max_size];\n}\n```\n\nå’Œ`frame_queue_peek_writable`ç±»ä¼¼ï¼Œåˆ†ä¸‰æ­¥:\n\n1. åŠ é”æƒ…å†µä¸‹ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¯è¯»èŠ‚ç‚¹ï¼ˆ`f->size - f->rindex_shown > 0`)\n2. å¦‚æœæœ‰é€€å‡ºè¯·æ±‚ï¼Œåˆ™è¿”å›NULL\n3. è¯»å–å½“å‰å¯è¯»èŠ‚ç‚¹`(f->rindex + f->rindex_shown) % f->max_size`\n\n`rindex_shown`æœ‰äº›å¹²æ‰°ä»£ç åˆ†æï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸æ”¯æŒkeep_lastçš„æƒ…å†µï¼ˆåªéœ€è¦åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥keep_last = 0ï¼‰ï¼Œæ­¤äº‹`rindex_shown`å§‹ç»ˆä¸º0ï¼Œæ‰€ä»¥ï¼Œ`frame_queue_peek_readable`ç®€åŒ–å¦‚ä¸‹ï¼š\n\n```c\nstatic Frame *frame_queue_peek_readable(FrameQueue *f)\n{\n    /* wait until we have a readable a new frame */\n    SDL_LockMutex(f->mutex);\n    while (f->size <= 0 &&\n           !f->pktq->abort_request) {\n        SDL_CondWait(f->cond, f->mutex);\n    }\n    SDL_UnlockMutex(f->mutex);\n\n    if (f->pktq->abort_request)\n        return NULL;\n\n    return &f->queue[f->rindex];\n}\n\n```\n\nå’Œpeek_writableå‡ ä¹æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚å°±ä¸åˆ†æäº†ã€‚\n\n\n\nåœ¨ç®€åŒ–ç‰ˆæœ¬ä¸Šç†è§£å¼•å…¥`rindex_shown`çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£`rindex_shown`ã€‚`rindex_shown`çš„æ„æ€æ˜¯`rindex`æŒ‡å‘çš„èŠ‚ç‚¹æ˜¯å¦è¢«è¯»è¿‡ï¼Œå¦‚æœè¢«è¯»è¿‡ï¼Œ ä¸º1ï¼Œåä¹‹ï¼Œä¸º0ã€‚è¿™ä¸€è¡Œä¸ºï¼Œä½“ç°åœ¨`frame_queue_next`ï¼š\n\n```c\nstatic void frame_queue_next(FrameQueue *f)\n{   \n    //å¦‚æœæ”¯æŒkeep_lastï¼Œå¹¶ä¸”f->rindex_shownä¸º0, å°†rindex_shownè®¾ç½®ä¸º1ï¼Œè¿”å›\n    if (f->keep_last && !f->rindex_shown) {\n        f->rindex_shown = 1;\n        return;\n    }\n    //å¦åˆ™ï¼Œç§»åŠ¨rindexæŒ‡é’ˆï¼Œå¹¶å‡å°size\n    frame_queue_unref_item(&f->queue[f->rindex]);\n    if (++f->rindex == f->max_size)\n        f->rindex = 0;\n    SDL_LockMutex(f->mutex);\n    f->size--;\n    SDL_CondSignal(f->cond);\n    SDL_UnlockMutex(f->mutex);\n}\n```\n\n`frame_queue_next`ç”¨äºåœ¨è¯»å®Œä¸€ä¸ªèŠ‚ç‚¹åè°ƒç”¨ï¼Œç”¨äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹å·²ç»è¢«è¯»è¿‡ã€‚\n\nä¸å†™è¿‡ç¨‹ç±»ä¼¼ï¼Œè¯»è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºï¼š\n\n```c\nFrame* vp = frame_queue_peek_readable(f);\n//è¯»å–vpçš„æ•°æ®ï¼Œæ¯”å¦‚\nprintf(\"pict_type=%d\\n\", vp->frame->pict_type);\nframe_queue_next(f);\n```\n\n`frame_queue_next`æ¯”`frame_queue_push`ç•¥å¤æ‚ï¼Œæˆ‘ä»¬è¦åˆ†æä¸¤ä¸ªè¡Œä¸ºï¼šæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²è¯»ï¼Œä»¥åŠ`rindex_shown`çš„èµ‹å€¼ã€‚\n\næ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²è¯»äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²å†™æ˜¯ç±»ä¼¼çš„ï¼Œæ‰§è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š\n\n1. rindexåŠ 1ï¼Œå¦‚æœè¶…è¿‡max_sizeï¼Œåˆ™å›ç¯ä¸º0\n2. åŠ é”æƒ…å†µä¸‹å¤§å°å‡1.\n\nç‰¹åˆ«çš„æ˜¯ï¼Œå¯¹äºä»¥åŠè¯»è¿‡çš„èŠ‚ç‚¹ï¼Œéœ€è¦è°ƒç”¨`frame_queue_unref_item`é‡Šæ”¾å…³è”å†…å­˜ã€‚\n\næ‰§è¡Œrindexæ“ä½œå‰ï¼Œéœ€è¦å…ˆåˆ¤æ–­`rindex_shown`çš„å€¼ï¼Œå¦‚æœä¸º0ï¼Œåˆ™èµ‹1ã€‚è¿™ä¹ˆåšçš„æ„å›¾ä¸å¦¨ç”»å›¾åˆ†æï¼š\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16473273492201647327349203.png)\n\nè¿™é‡Œæ¨¡æ‹Ÿäº†ä»åˆå§‹åŒ–å¼€å§‹çš„2æ¬¡â€œè¯»â€ã€‚\n\nè¿˜æ²¡å¼€å§‹è¯»ï¼Œrindexå’Œrindex_shownå‡ä¸º0ã€‚è¿™æ—¶è¦peekçš„è¯»èŠ‚ç‚¹æ˜¯èŠ‚ç‚¹0(å›¾ä¸­é»‘è‰²å—ï¼‰ã€‚\n\nç¬¬ä¸€æ¬¡è¯»ï¼Œè°ƒç”¨nextï¼Œæ»¡è¶³æ¡ä»¶`f->keep_last && !f->rindex_shown`ï¼Œæ‰€ä»¥rindexä»ç„¶æ˜¯0ï¼Œè€Œrindex_shownä¸º1.æ­¤æ—¶èŠ‚ç‚¹0ï¼ˆç°è‰²å—ï¼‰æ˜¯å·²è¯»èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯è¦keepçš„lastèŠ‚ç‚¹ï¼Œå°†è¦è¯»çš„èŠ‚ç‚¹æ˜¯èŠ‚ç‚¹1ï¼ˆé»‘è‰²å—ï¼‰ã€‚ï¼ˆæ°å¥½æ˜¯rindex+rindex_shownï¼‰\n\nç¬¬äºŒæ¬¡è¯»ï¼Œpeekäº†é»‘è‰²å—åï¼Œè°ƒç”¨nextï¼Œä¸æ»¡è¶³æ¡ä»¶`f->keep_last && !f->rindex_shown`ï¼Œæ‰€ä»¥rindexä¸º1ï¼Œè€Œrindex_shownä¸º2.æ­¤æ—¶èŠ‚ç‚¹1ï¼ˆç°è‰²å—ï¼‰æ˜¯lastèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹2ï¼ˆé»‘è‰²å—ï¼‰æ˜¯å°†è¦è¯»çš„èŠ‚ç‚¹ã€‚ï¼ˆä¹Ÿæ°å¥½æ˜¯rindex+rindex_shownï¼‰\n\nç»§ç»­å¾€ååˆ†æï¼Œä¼šä¸€ç›´é‡å¤ç¬¬äºŒæ¬¡è¯»çš„æƒ…å†µï¼Œå§‹ç»ˆæ˜¯rindexæŒ‡å‘äº†lastï¼Œè€Œrindex_shownä¸€ç›´ä¸º1ï¼Œrindex+rindex_shownåˆšå¥½æ˜¯å°†è¦è¯»çš„èŠ‚ç‚¹ã€‚\n\nè‡³æ­¤ï¼Œ`frame_queue_next`çš„è¡Œä¸ºç®—æ˜¯æ˜ç¡®äº†ã€‚å›å¤´çœ‹çœ‹`frame_queue_peek_readable`ã€‚\n\næ­¥éª¤1ä¸­ï¼Œåˆ¤æ–­æ— å¯è¯»èŠ‚ç‚¹ï¼Œç”¨çš„æ˜¯`f->size - f->rindex_shown <= 0`ï¼Œå…¶å®æ˜¯ä»¥ä¸‹ä»£ç çš„ç®€åŒ–ï¼š\n\n```c\nif (f->rindex_shown)\n    return f->size - 1;\nelse\n    return f->size;\n```\n\nåªæ˜¯Cä¸­ç”¨intæ¨¡æ‹Ÿboolï¼Œåˆšå¥½rindex_shownä¸ºtrueæ˜¯1ï¼Œæ‰€ä»¥å¯ä»¥ç®€åŒ–ä¸º`` `f->size - f->rindex_shown ``.\n\næ­¥éª¤3ä¸­ï¼Œå–å°†è¦è¯»çš„èŠ‚ç‚¹ç”¨çš„æ˜¯`(f->rindex + f->rindex_shown) % f->max_size`ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªç®€åŒ–ï¼š\n\n```c\n//è¿™æ®µä»£ç æ ¹æ®ä¸Šå›¾å¾ˆå®¹æ˜“æ¨å¯¼\nif (f->rindex_shown)\n    return (f->rindex + 1) % f->max_size; //å› ä¸ºrindexåŠ 1åå¯èƒ½è¶…è¿‡max_sizeï¼Œæ‰€ä»¥è¿™é‡Œå–ä½™\nelse\n    return f->rindex;\n```\n\nä»¥ä¸Šï¼ŒFrameQueueçš„è¯»è¿‡ç¨‹ä¹Ÿåˆ†æå®Œäº†ã€‚\n\nä¸ºäº†æ”¯æŒçµæ´»åœ°è¯»ï¼Œè¿˜æœ‰ä¸€äº›è¾…åŠ©å‡½æ•°ï¼š\n\n```c\n//è¯»å½“å‰èŠ‚ç‚¹ï¼ˆä¸Šæ–‡ä¸­çš„ç”¨è¯æ˜¯â€œå°†è¦è¯»çš„èŠ‚ç‚¹â€ï¼Œä¹Ÿå°±æ˜¯é»‘è‰²å—ï¼‰ï¼Œä¸frame_queue_peek_readableç­‰æ•ˆï¼Œä½†æ²¡æœ‰æ£€æŸ¥æ˜¯å¦æœ‰å¯è¯»èŠ‚ç‚¹\nstatic Frame *frame_queue_peek(FrameQueue *f)\n{\n    return &f->queue[(f->rindex + f->rindex_shown) % f->max_size];\n}\n\n//è¯»ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\nstatic Frame *frame_queue_peek_next(FrameQueue *f)\n{\n    return &f->queue[(f->rindex + f->rindex_shown + 1) % f->max_size];\n}\n\n//è¯»ä¸Šä¸€ä¸ªèŠ‚ç‚¹\nstatic Frame *frame_queue_peek_last(FrameQueue *f)\n{\n    return &f->queue[f->rindex];\n}\n\n/* return the number of undisplayed frames in the queue */\nstatic int frame_queue_nb_remaining(FrameQueue *f)\n{\n    return f->size - f->rindex_shown;\n}\n```\n\nå®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œå€ŸåŠ©ä¸Šå›¾çœ‹ä¸‹èŠ‚ç‚¹ä½ç½®ï¼š\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16473274840541647327483583.png)\n\nè‡³æ­¤ï¼ŒFrameQueueçš„ä¸»ä½“åŠŸèƒ½åˆ†æå®Œäº†ã€‚ä»æºç ä¸­å¯ä»¥çœ‹åˆ°FrameQueueæ˜¯é’ˆå¯¹å•è¯»å•å†™ä¼˜åŒ–çš„é«˜æ•ˆçš„å¤šçº¿ç¨‹æ¨¡å‹ï¼Œå…¶è®¾è®¡æ€è·¯ä¸å¤±ä¸ºåœ¨Cè¯­è¨€å®è·µä¸­å¯å€Ÿé‰´çš„ä¸€ä¸ªå¥½ä¾‹å­ã€‚\n","source":"_posts/ffmpeg/2022-03-15-ffplay-frame queue åˆ†æ.md","raw":"---\nlayout: post\ntitle: \"ffplay frame queue åˆ†æ\"\ndate: 2022-03-15\ntag: ffmpeg\n\n---\n\nå‚è€ƒï¼š  [ffplay frame queueåˆ†æ](https://zhuanlan.zhihu.com/p/43564980)\n\n## FrameQueueæ•°æ®ç»“æ„\n\nffplay å®šä¹‰äº† FrameQueue æ¥ç®¡ç†è§£ç åçš„éŸ³é¢‘ï¼Œè§†é¢‘ä»¥åŠå­—å¹•ã€‚\n\n```c\n/* Common struct for handling all types of decoded data and allocated render buffers. */\ntypedef struct Frame {\n    AVFrame *frame;       //audio/video frame\n    AVSubtitle sub;       //å­—å¹•\n    int serial;           //åºåˆ—å·\n    double pts;           /* presentation timestamp for the frame */\n    double duration;      /* estimated duration of the frame */\n    int64_t pos;          /* byte position of the frame in the input file */\n    int width;\n    int height;\n    int format;\n    AVRational sar;       //video aspect ratio\n    int uploaded;\n    int flip_v;           //videoï¼Œæ˜¯å¦åº”è¯¥åœ¨å‚ç›´æ–¹å‘ç¿»è½¬\n} Frame;\n\ntypedef struct FrameQueue {\n    Frame queue[FRAME_QUEUE_SIZE];  //frameæ•°ç»„ï¼Œç¯å½¢buffer\n    int rindex;                     //è¯»æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¯è¯»çš„ä½ç½®\n    int windex;                     //å†™æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¯å†™çš„ä½ç½®\n    int size;                       //é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°\n    int max_size;                   //é˜Ÿåˆ—å®¹é‡\n    int keep_last;                  //æ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­ä¿ç•™ä¸Šä¸€ä¸ªå·²è¯»çš„å…ƒç´ \n    int rindex_shown;               //æ ‡è®°rindexæŒ‡å‘çš„å…ƒç´ æ˜¯å¦å·²ç»å±•ç¤ºï¼ˆå·²è¯»ï¼‰ï¼Œkeep_lastä¸º1æ—¶ç”Ÿæ•ˆã€‚\n    SDL_mutex *mutex;               //é”,ç”¨äºå®‰å…¨è®¿é—®\n    SDL_cond *cond;                 //æ¡ä»¶å˜é‡ï¼Œç”¨äºæ§åˆ¶è¯»å–å’Œå†™å…¥ï¼Œé˜²æ­¢overrunå’Œunderflow\n    PacketQueue *pktq;              //è¯¥frame queue å¯¹åº”çš„ pkt queue\n} FrameQueue;\n```\n\n> Frameçš„è®¾è®¡è¯•å›¾ç”¨ä¸€ä¸ªç»“æ„ä½“â€œèåˆâ€3ç§æ•°æ®ï¼šè§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ï¼Œè™½ç„¶AVFrameæ—¢å¯ä»¥è¡¨ç¤ºè§†é¢‘åˆå¯ä»¥è¡¨ç¤ºéŸ³é¢‘ï¼Œä½†åœ¨èåˆå­—å¹•æ—¶åˆéœ€è¦å¼•å…¥AVSubtitleï¼Œä»¥åŠä¸€äº›å…¶ä»–å­—æ®µï¼Œå¦‚width/heightç­‰æ¥è¡¥å……AVSubtitleï¼Œæ‰€ä»¥æ•´ä¸ªç»“æ„ä½“çœ‹èµ·æ¥å¾ˆâ€œæ‹¼å‡‘â€ï¼ˆç”šè‡³è¿˜æœ‰è§†é¢‘ä¸“ç”¨çš„flip_vå­—æ®µï¼‰\n> \n> FrameQueueçš„è®¾è®¡ç†å¿µï¼š\n> \n> 1. é«˜æ•ˆç‡çš„è¯»å†™æ¨¡å‹\n> 2. é«˜æ•ˆçš„å†…å­˜æ¨¡å‹ï¼ˆèŠ‚ç‚¹å†…å­˜ä»¥æ•°ç»„å½¢å¼é¢„åˆ†é…ï¼Œæ— éœ€åŠ¨æ€åˆ†é…ï¼‰\n> 3. ç¯å½¢ç¼“å†²åŒºè®¾è®¡ï¼ŒåŒæ—¶å¯ä»¥è®¿é—®ä¸Šä¸€è¯»èŠ‚ç‚¹\n\n## é˜Ÿåˆ—çš„æ“ä½œï¼š\n\n### é˜Ÿåˆ—åˆå§‹åŒ–\n\n```c\nstatic int frame_queue_init(FrameQueue *f, PacketQueue *pktq, int max_size, int keep_last)\n{\n    int i;\n    memset(f, 0, sizeof(FrameQueue));\n    //äº’æ–¥é”åˆ›å»º\n    if (!(f->mutex = SDL_CreateMutex())) {\n        av_log(NULL, AV_LOG_FATAL, \"SDL_CreateMutex(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    //æ¡ä»¶å˜é‡åˆ›å»º\n    if (!(f->cond = SDL_CreateCond())) {\n        av_log(NULL, AV_LOG_FATAL, \"SDL_CreateCond(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    //è®¾ç½®å¯¹åº”çš„pkt queue\n    f->pktq = pktq;\n    //è®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œè§†é¢‘ 3, éŸ³é¢‘ 9ï¼Œå­—å¹• 16\n    f->max_size = FFMIN(max_size, FRAME_QUEUE_SIZE);\n    //æ˜¯å¦ä¿ç•™æœ€åä¸€ä¸ªä½ç½®ï¼Œè§†é¢‘éŸ³é¢‘ä¿ç•™ï¼Œå­—å¹•ä¸ä¿ç•™\n    f->keep_last = !!keep_last;\n    //ç»™é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„frameåˆå§‹åŒ–\n    for (i = 0; i < f->max_size; i++)\n        if (!(f->queue[i].frame = av_frame_alloc()))\n            return AVERROR(ENOMEM);\n    return 0;\n}\n```\n\nåˆå§‹åŒ–é˜Ÿåˆ—çš„å†…å­˜ï¼Œåˆ›å»ºé”ï¼Œæ¡ä»¶å˜é‡ï¼Œä¿å­˜pkt queueï¼Œè®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œkeep_lastæ ‡å¿—ä½åˆå§‹åŒ–ã€‚åˆå§‹åŒ–é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç»™é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„frameè°ƒç”¨av_frame_allocåˆ†é…å†…å­˜ã€‚\n\nå‚æ•°max_sizeç”¨æ¥è®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œæœ€å¤§ä¸è¶…è¿‡FRAME_QUEUE_SIZEã€‚å…¶ä¸­è§†é¢‘é˜Ÿåˆ—çš„å®¹é‡ä¸º3ï¼ŒéŸ³é¢‘9ï¼Œå­—å¹•16ã€‚FRAME_QUEUE_SIZEå®šä¹‰å¦‚ä¸‹:\n\n```c\n#define VIDEO_PICTURE_QUEUE_SIZE 3\n#define SUBPICTURE_QUEUE_SIZE 16\n#define SAMPLE_QUEUE_SIZE 9\n#define FRAME_QUEUE_SIZE FFMAX(SAMPLE_QUEUE_SIZE, FFMAX(VIDEO_PICTURE_QUEUE_SIZE, SUBPICTURE_QUEUE_SIZE))\n```\n\nå±•å¼€åFRAME_QUEUE_SIZEçš„å€¼ä¸º16ã€‚\n\nkeep_lastæ˜¯ä¸€ä¸ªboolå€¼ï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨ç¯å½¢ç¼“å†²åŒºçš„è¯»å†™è¿‡ç¨‹ä¸­ä¿ç•™æœ€åä¸€ä¸ªè¯»èŠ‚ç‚¹ä¸è¢«è¦†å†™ã€‚`f->keep_last = !!keep_last;`é‡Œçš„åŒæ„Ÿå¹å·æ˜¯Cä¸­çš„ä¸€ç§æŠ€å·§ï¼Œæ—¨åœ¨è®©intå‚æ•°è§„æ•´ä¸º0/1çš„â€œboolå€¼â€ã€‚è§†é¢‘å’ŒéŸ³é¢‘ä¼šä¿ç•™æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå­—å¹•ä¸ä¿ç•™ã€‚\n\n\n\n### é˜Ÿåˆ—é”€æ¯\n\n```c\nstatic void frame_queue_destory(FrameQueue *f)\n{\n    int i;\n    for (i = 0; i < f->max_size; i++) {\n        Frame *vp = &f->queue[i];\nÂ Â Â Â Â Â Â Â //å¯¹æ¯ä¸ªèŠ‚ç‚¹è°ƒç”¨frame_queue_unref_item\n        frame_queue_unref_item(vp);\nÂ Â Â Â Â Â Â Â //è°ƒç”¨av_frame_freeé‡Šæ”¾frameçš„å†…å­˜\n        av_frame_free(&vp->frame);\n    }\n    SDL_DestroyMutex(f->mutex);\n    SDL_DestroyCond(f->cond);\n}\n```\n\nè¾ƒä¸ºé‡è¦çš„æ˜¯queueå…ƒç´ çš„é‡Šæ”¾ã€‚åˆ†ä¸¤æ­¥ï¼Œåˆ†åˆ«æ˜¯`frame_queue_unref_item`å’Œ`av_frame_free`ã€‚å…¶ä¸­`av_frame_free`ä¸åˆå§‹åŒ–ä¸­çš„`av_frame_alloc`å¯¹åº”ï¼Œç”¨äºé‡Šæ”¾AVFrame.\n\n`frame_queue_unref_item`çš„å®šä¹‰å¦‚ä¸‹ï¼š\n\n```c\nstatic void frame_queue_unref_item(Frame *vp)\n{\n    av_frame_unref(vp->frame);//å¼•ç”¨è®¡æ•°-1\n    avsubtitle_free(&vp->sub);//subå…³è”çš„å†…å­˜é‡Šæ”¾\n}\n```\n\n`frame_queue_unref_item`é‡Šæ”¾çš„å†…å­˜éƒ½æ˜¯**å…³è”**çš„å†…å­˜ï¼Œè€Œéç»“æ„ä½“è‡ªèº«å†…å­˜ã€‚\n\nAVFrameå†…éƒ¨æœ‰è®¸å¤šçš„AVBufferRefç±»å‹å­—æ®µï¼Œè€ŒAVBufferRefåªæ˜¯AVBufferçš„å¼•ç”¨ï¼ŒAVBufferé€šè¿‡å¼•ç”¨è®¡æ•°è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼ˆç®€æ˜“åƒåœ¾å›æ”¶æœºåˆ¶ï¼‰ã€‚å› æ­¤AVFrameåœ¨ä¸éœ€è¦çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡`av_frame_unref`å‡å°‘å¼•ç”¨è®¡æ•°ã€‚\n\n> å…³äºAVBufferRefçš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š [æ·±å…¥ç†è§£FFMPEG-AVBuffer/AVBufferRef/AVBufferPool]([æ·±å…¥ç†è§£FFMPEG-AVBuffer/AVBufferRef/AVBufferPool_muyuyuzhongçš„ä¸“æ -CSDNåšå®¢](https://blog.csdn.net/muyuyuzhong/article/details/79381152))\n\n### é˜Ÿåˆ—å†™æ“ä½œ\n\nFrameQueueçš„â€œå†™â€åˆ†ä¸¤æ­¥ï¼Œå…ˆè°ƒç”¨`frame_queue_peek_writable`è·å–ä¸€ä¸ªå¯å†™èŠ‚ç‚¹ï¼Œåœ¨å¯¹èŠ‚ç‚¹æ“ä½œç»“æŸåï¼Œè°ƒç”¨`frame_queue_push`å‘ŠçŸ¥FrameQueueâ€œå­˜å…¥â€è¯¥èŠ‚ç‚¹ã€‚\n\n> é˜…è¯»æç¤ºï¼š  \n> åœ¨ffplayä¸­ï¼ŒFrameQueueå§‹ç»ˆæ˜¯ä¸€ä¸ªçº¿ç¨‹å†™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»ã€‚ä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªè¯»çº¿ç¨‹ï¼Œä¸ä¼šæœ‰å…¶ä»–è¯»çº¿ç¨‹ç«äº‰è¯»ï¼›åªæœ‰ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹ç«äº‰å†™ï¼›å”¯ä¸€éœ€è¦çš„æ˜¯è¯»ä¸å†™çº¿ç¨‹é—´çš„åŒæ­¥ã€‚FrameQueueçš„æ•´ä¸ªä¼˜åŒ–å’Œè®¾è®¡æ€è·¯æ­£æ˜¯åŸºäºè¿™ä¸€ç‚¹çš„ã€‚\n\nå…ˆçœ‹`frame_queue_peek_writable`ï¼š\n\n```c\nstatic Frame *frame_queue_peek_writable(FrameQueue *f)\n{\n    /* wait until we have space to put a new frame */\n    SDL_LockMutex(f->mutex);\n    while (f->size >= f->max_size &&\n           !f->pktq->abort_request) {\n        //ç­‰å¾…æœ‰ç©ºé—´å¯ä»¥å†™ï¼Œæ‰ç»§ç»­æ‰§è¡Œ\n        SDL_CondWait(f->cond, f->mutex);\n    }\n    SDL_UnlockMutex(f->mutex);\n\n    if (f->pktq->abort_request)\n        return NULL;\n    //è¿”å›f->windexå¯¹åº”çš„frame\n    return &f->queue[f->windex];\n}\n```\n\næ•´ä¸ªå‡½æ•°åˆ†3æ­¥ï¼š\n\n1. åŠ é”æƒ…å†µä¸‹ï¼Œç­‰å¾…ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºä½™ç©ºé—´å¯å†™ï¼ˆ`f->size < f->max_size`ï¼‰\n2. å¦‚æœæœ‰é€€å‡ºè¯·æ±‚ï¼ˆ`f->pktq->abort_request`ï¼‰ï¼Œåˆ™è¿”å›NULL\n3. è¿”å›`windex`ä½ç½®çš„å…ƒç´ ï¼ˆ`windex`æŒ‡å‘å½“å‰åº”å†™ä½ç½®ï¼‰\n\n> ä¸ºä»€ä¹ˆè¿™é‡Œé”çš„èŒƒå›´ä¸æ˜¯æ•´ä¸ªå‡½æ•°å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†å‡å°é”çš„èŒƒå›´ï¼Œä»¥æé«˜æ•ˆç‡ã€‚è€Œä¹‹æ‰€ä»¥å¯ä»¥åœ¨æ— é”çš„æƒ…å†µä¸‹å®‰å…¨è®¿é—®queue å­—æ®µï¼Œæ˜¯å› ä¸ºä¸Šæ–‡ä¸­æåˆ°çš„å•è¯»å•å†™çš„ç‰¹æ®Šåœºæ™¯ã€‚é¦–å…ˆï¼Œqueueæ˜¯ä¸€ä¸ªé¢„å…ˆåˆ†é…å¥½çš„æ•°ç»„ï¼Œå› æ­¤queueæœ¬èº«ä¸å‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥å®‰å…¨è®¿é—®ï¼›æ¥ç€queueå†…çš„å…ƒç´ ï¼Œè¯»å’Œå†™ä¸å­˜åœ¨é‡å ï¼Œå³windexå’Œrindexä¸ä¼šé‡å ã€‚\n> \n> å…³äºâ€œè¯»å’Œå†™ä¸å­˜åœ¨é‡å â€ï¼Œä»”ç»†çœ‹çœ‹ã€‚å› ä¸ºqueueæ•°ç»„è¢«å½“åšä¸€ä¸ªç¯å½¢ç¼“å†²åŒºä½¿ç”¨ï¼Œé‚£ä¹ˆçš„ç¡®å­˜åœ¨underrunå’Œoverrunçš„æƒ…å†µï¼Œå³è¯»è¿‡å¿«ï¼Œæˆ–å†™è¿‡å¿«çš„æƒ…å†µï¼Œè¿™æ—¶å¦‚æœä¸åŠ æ§åˆ¶ï¼Œå°±ä¼šå‘ˆç°ç¼“å†²åŒºè¦†ç›–ã€‚\n> \n> FrameQueueçš„ç²¾æ˜ä¹‹å¤„åœ¨äºï¼Œå…ˆé€šè¿‡sizeåˆ¤æ–­å½“å‰ç¼“å†²åŒºå†…ç©ºé—´æ˜¯å¦å¤Ÿå†™ï¼Œæˆ–è€…å¤Ÿè¯»ï¼Œæ¯”å¦‚è¿™é‡Œå…ˆé€šè¿‡ä¸€ä¸ªå¾ªç¯çš„æ¡ä»¶ç­‰å¾…ï¼Œåˆ¤æ–­`f->size >= f->max_size`ï¼Œå¦‚æœ`f->size >= f->max_size`ï¼Œé‚£ä¹ˆè¯´æ˜é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å·²ç»å†™æ»¡ï¼Œä¹Ÿå°±æ˜¯å·²ç»overrunäº†ï¼Œæ­¤æ—¶å¦‚æœå†å†™ï¼Œè‚¯å®šä¼šè¦†å†™æœªè¯»æ•°æ®ï¼Œé‚£ä¹ˆå°±éœ€è¦ç»§ç»­ç­‰å¾…ã€‚å½“æ— éœ€ç­‰å¾…æ—¶ï¼ŒwindexæŒ‡å‘çš„å†…å­˜ä¸€å®šæ˜¯å·²ç»è¯»è¿‡çš„ï¼ˆé™¤éä»£ç å¼‚å¸¸äº†ï¼‰ã€‚\n> \n> è°ƒç”¨`frame_queue_peek_writable`å–åˆ°FrameæŒ‡é’ˆåï¼Œå°±å¯ä»¥å¯¹Frameå†…çš„å­—æ®µè‡ªç”±æ”¹å†™ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå†™è¿›ç¨‹ï¼Œä¸”æ— éœ€æ‹…å¿ƒè¯»è¿›ç¨‹è¦†å†™ã€‚å¦‚ä¸Šåˆ†æï¼Œè¯»è¿›ç¨‹è¦è¯»ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¹Ÿä¼šå…ˆåˆ¤æ–­underrunçš„æƒ…å†µï¼‰ã€‚\n\nä¸€èˆ¬æ­¥éª¤æ˜¯ï¼š\n\n```c\nFrame* vp = frame_queue_peek_writable(q);\n//å°†è¦å­˜å‚¨çš„æ•°æ®å†™å…¥frameå­—æ®µï¼Œæ¯”å¦‚ï¼š\nav_frame_move_ref(vp->frame, src_frame);\n//å­˜å…¥é˜Ÿåˆ—\nframe_queue_push(q);\n```\n\n`frame_queue_push`æ€ä¹ˆçŸ¥é“è¦pushçš„æ˜¯è¿™é‡Œçš„vpå‘¢ï¼Ÿ\n\n```c\nstatic void frame_queue_push(FrameQueue *f)\n{\n    if (++f->windex == f->max_size)\n        f->windex = 0;\n    SDL_LockMutex(f->mutex);\n    f->size++;\n    SDL_CondSignal(f->cond);\n    SDL_UnlockMutex(f->mutex);\n}\n```\n\nç­”æ¡ˆæ˜¯pushå½“å‰windexèŠ‚ç‚¹ã€‚çœ‹`frame_queue_push`å‡½æ•°ï¼Œæ‰§è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š\n\n1. windexåŠ 1ï¼Œå¦‚æœè¶…è¿‡max_sizeï¼Œåˆ™å›ç¯ä¸º0\n2. åŠ é”æƒ…å†µä¸‹å¤§å°åŠ 1.\n\n> å› ä¸ºFrameQueueæ˜¯åŸºäºå›ºå®šé•¿åº¦çš„æ•°ç»„å®ç°çš„é˜Ÿåˆ—ï¼Œä¸é“¾è¡¨é˜Ÿåˆ—ä¸åŒï¼Œå…¶èŠ‚ç‚¹åœ¨åˆå§‹åŒ–çš„æ—¶å€™å·²ç»åœ¨é˜Ÿåˆ—ä¸­äº†ï¼Œpushæ‰€è¦åšçš„åªæ˜¯é€šè¿‡æŸç§æ ‡å¿—è®°å½•è¯¥èŠ‚ç‚¹æ˜¯å¦æ˜¯å†™å…¥æœªè¯»çš„ã€‚ffplayçš„åšæ³•æ˜¯å¯¹windexåŠ 1ï¼Œå°†å†™æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå‡¡æ˜¯windexâ€œä¹‹å‰â€çš„èŠ‚ç‚¹ï¼Œéƒ½æ˜¯å†™è¿‡çš„ã€‚ï¼ˆè‡³äºæ˜¯å¦å¯è¯»ï¼ŒrindexçŸ¥é“ï¼›è‡³äºåç»­æœ‰å¤šå°‘ç©ºé—´å¯å†™ï¼ŒsizeçŸ¥é“ï¼‰\n\n### é˜Ÿåˆ—è¯»æ“ä½œ\n\nå’Œå†™ä¸€æ ·ï¼ŒFrameQueueçš„è¯»ä¹Ÿåˆ†ä¸¤æ­¥ã€‚`frame_queue_peek_readable`å’Œ`frame_queue_next`ã€‚ç›¸æ¯”å†™è¦å¤æ‚ä¸€ç‚¹çš„æ˜¯ ï¼Œè¯»çš„ä»£ç å¤šè€ƒè™‘å¦ä¸€ä¸ªç‰¹æ€§ï¼Œå³å…è®¸ä¿ç•™ä¸Šä¸€è¯»èŠ‚ç‚¹ã€‚\n\n`frame_queue_peek_readable`ä»£ç å¦‚ä¸‹ï¼š\n\n```c\nstatic Frame *frame_queue_peek_readable(FrameQueue *f)\n{\n    /* wait until we have a readable a new frame */\n    SDL_LockMutex(f->mutex);\n    while (f->size - f->rindex_shown <= 0 &&\n           !f->pktq->abort_request) {\n        SDL_CondWait(f->cond, f->mutex);\n    }\n    SDL_UnlockMutex(f->mutex);\n\n    if (f->pktq->abort_request)\n        return NULL;\n\n    return &f->queue[(f->rindex + f->rindex_shown) % f->max_size];\n}\n```\n\nå’Œ`frame_queue_peek_writable`ç±»ä¼¼ï¼Œåˆ†ä¸‰æ­¥:\n\n1. åŠ é”æƒ…å†µä¸‹ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¯è¯»èŠ‚ç‚¹ï¼ˆ`f->size - f->rindex_shown > 0`)\n2. å¦‚æœæœ‰é€€å‡ºè¯·æ±‚ï¼Œåˆ™è¿”å›NULL\n3. è¯»å–å½“å‰å¯è¯»èŠ‚ç‚¹`(f->rindex + f->rindex_shown) % f->max_size`\n\n`rindex_shown`æœ‰äº›å¹²æ‰°ä»£ç åˆ†æï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸æ”¯æŒkeep_lastçš„æƒ…å†µï¼ˆåªéœ€è¦åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥keep_last = 0ï¼‰ï¼Œæ­¤äº‹`rindex_shown`å§‹ç»ˆä¸º0ï¼Œæ‰€ä»¥ï¼Œ`frame_queue_peek_readable`ç®€åŒ–å¦‚ä¸‹ï¼š\n\n```c\nstatic Frame *frame_queue_peek_readable(FrameQueue *f)\n{\n    /* wait until we have a readable a new frame */\n    SDL_LockMutex(f->mutex);\n    while (f->size <= 0 &&\n           !f->pktq->abort_request) {\n        SDL_CondWait(f->cond, f->mutex);\n    }\n    SDL_UnlockMutex(f->mutex);\n\n    if (f->pktq->abort_request)\n        return NULL;\n\n    return &f->queue[f->rindex];\n}\n\n```\n\nå’Œpeek_writableå‡ ä¹æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚å°±ä¸åˆ†æäº†ã€‚\n\n\n\nåœ¨ç®€åŒ–ç‰ˆæœ¬ä¸Šç†è§£å¼•å…¥`rindex_shown`çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£`rindex_shown`ã€‚`rindex_shown`çš„æ„æ€æ˜¯`rindex`æŒ‡å‘çš„èŠ‚ç‚¹æ˜¯å¦è¢«è¯»è¿‡ï¼Œå¦‚æœè¢«è¯»è¿‡ï¼Œ ä¸º1ï¼Œåä¹‹ï¼Œä¸º0ã€‚è¿™ä¸€è¡Œä¸ºï¼Œä½“ç°åœ¨`frame_queue_next`ï¼š\n\n```c\nstatic void frame_queue_next(FrameQueue *f)\n{   \n    //å¦‚æœæ”¯æŒkeep_lastï¼Œå¹¶ä¸”f->rindex_shownä¸º0, å°†rindex_shownè®¾ç½®ä¸º1ï¼Œè¿”å›\n    if (f->keep_last && !f->rindex_shown) {\n        f->rindex_shown = 1;\n        return;\n    }\n    //å¦åˆ™ï¼Œç§»åŠ¨rindexæŒ‡é’ˆï¼Œå¹¶å‡å°size\n    frame_queue_unref_item(&f->queue[f->rindex]);\n    if (++f->rindex == f->max_size)\n        f->rindex = 0;\n    SDL_LockMutex(f->mutex);\n    f->size--;\n    SDL_CondSignal(f->cond);\n    SDL_UnlockMutex(f->mutex);\n}\n```\n\n`frame_queue_next`ç”¨äºåœ¨è¯»å®Œä¸€ä¸ªèŠ‚ç‚¹åè°ƒç”¨ï¼Œç”¨äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹å·²ç»è¢«è¯»è¿‡ã€‚\n\nä¸å†™è¿‡ç¨‹ç±»ä¼¼ï¼Œè¯»è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºï¼š\n\n```c\nFrame* vp = frame_queue_peek_readable(f);\n//è¯»å–vpçš„æ•°æ®ï¼Œæ¯”å¦‚\nprintf(\"pict_type=%d\\n\", vp->frame->pict_type);\nframe_queue_next(f);\n```\n\n`frame_queue_next`æ¯”`frame_queue_push`ç•¥å¤æ‚ï¼Œæˆ‘ä»¬è¦åˆ†æä¸¤ä¸ªè¡Œä¸ºï¼šæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²è¯»ï¼Œä»¥åŠ`rindex_shown`çš„èµ‹å€¼ã€‚\n\næ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²è¯»äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²å†™æ˜¯ç±»ä¼¼çš„ï¼Œæ‰§è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š\n\n1. rindexåŠ 1ï¼Œå¦‚æœè¶…è¿‡max_sizeï¼Œåˆ™å›ç¯ä¸º0\n2. åŠ é”æƒ…å†µä¸‹å¤§å°å‡1.\n\nç‰¹åˆ«çš„æ˜¯ï¼Œå¯¹äºä»¥åŠè¯»è¿‡çš„èŠ‚ç‚¹ï¼Œéœ€è¦è°ƒç”¨`frame_queue_unref_item`é‡Šæ”¾å…³è”å†…å­˜ã€‚\n\næ‰§è¡Œrindexæ“ä½œå‰ï¼Œéœ€è¦å…ˆåˆ¤æ–­`rindex_shown`çš„å€¼ï¼Œå¦‚æœä¸º0ï¼Œåˆ™èµ‹1ã€‚è¿™ä¹ˆåšçš„æ„å›¾ä¸å¦¨ç”»å›¾åˆ†æï¼š\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16473273492201647327349203.png)\n\nè¿™é‡Œæ¨¡æ‹Ÿäº†ä»åˆå§‹åŒ–å¼€å§‹çš„2æ¬¡â€œè¯»â€ã€‚\n\nè¿˜æ²¡å¼€å§‹è¯»ï¼Œrindexå’Œrindex_shownå‡ä¸º0ã€‚è¿™æ—¶è¦peekçš„è¯»èŠ‚ç‚¹æ˜¯èŠ‚ç‚¹0(å›¾ä¸­é»‘è‰²å—ï¼‰ã€‚\n\nç¬¬ä¸€æ¬¡è¯»ï¼Œè°ƒç”¨nextï¼Œæ»¡è¶³æ¡ä»¶`f->keep_last && !f->rindex_shown`ï¼Œæ‰€ä»¥rindexä»ç„¶æ˜¯0ï¼Œè€Œrindex_shownä¸º1.æ­¤æ—¶èŠ‚ç‚¹0ï¼ˆç°è‰²å—ï¼‰æ˜¯å·²è¯»èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯è¦keepçš„lastèŠ‚ç‚¹ï¼Œå°†è¦è¯»çš„èŠ‚ç‚¹æ˜¯èŠ‚ç‚¹1ï¼ˆé»‘è‰²å—ï¼‰ã€‚ï¼ˆæ°å¥½æ˜¯rindex+rindex_shownï¼‰\n\nç¬¬äºŒæ¬¡è¯»ï¼Œpeekäº†é»‘è‰²å—åï¼Œè°ƒç”¨nextï¼Œä¸æ»¡è¶³æ¡ä»¶`f->keep_last && !f->rindex_shown`ï¼Œæ‰€ä»¥rindexä¸º1ï¼Œè€Œrindex_shownä¸º2.æ­¤æ—¶èŠ‚ç‚¹1ï¼ˆç°è‰²å—ï¼‰æ˜¯lastèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹2ï¼ˆé»‘è‰²å—ï¼‰æ˜¯å°†è¦è¯»çš„èŠ‚ç‚¹ã€‚ï¼ˆä¹Ÿæ°å¥½æ˜¯rindex+rindex_shownï¼‰\n\nç»§ç»­å¾€ååˆ†æï¼Œä¼šä¸€ç›´é‡å¤ç¬¬äºŒæ¬¡è¯»çš„æƒ…å†µï¼Œå§‹ç»ˆæ˜¯rindexæŒ‡å‘äº†lastï¼Œè€Œrindex_shownä¸€ç›´ä¸º1ï¼Œrindex+rindex_shownåˆšå¥½æ˜¯å°†è¦è¯»çš„èŠ‚ç‚¹ã€‚\n\nè‡³æ­¤ï¼Œ`frame_queue_next`çš„è¡Œä¸ºç®—æ˜¯æ˜ç¡®äº†ã€‚å›å¤´çœ‹çœ‹`frame_queue_peek_readable`ã€‚\n\næ­¥éª¤1ä¸­ï¼Œåˆ¤æ–­æ— å¯è¯»èŠ‚ç‚¹ï¼Œç”¨çš„æ˜¯`f->size - f->rindex_shown <= 0`ï¼Œå…¶å®æ˜¯ä»¥ä¸‹ä»£ç çš„ç®€åŒ–ï¼š\n\n```c\nif (f->rindex_shown)\n    return f->size - 1;\nelse\n    return f->size;\n```\n\nåªæ˜¯Cä¸­ç”¨intæ¨¡æ‹Ÿboolï¼Œåˆšå¥½rindex_shownä¸ºtrueæ˜¯1ï¼Œæ‰€ä»¥å¯ä»¥ç®€åŒ–ä¸º`` `f->size - f->rindex_shown ``.\n\næ­¥éª¤3ä¸­ï¼Œå–å°†è¦è¯»çš„èŠ‚ç‚¹ç”¨çš„æ˜¯`(f->rindex + f->rindex_shown) % f->max_size`ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªç®€åŒ–ï¼š\n\n```c\n//è¿™æ®µä»£ç æ ¹æ®ä¸Šå›¾å¾ˆå®¹æ˜“æ¨å¯¼\nif (f->rindex_shown)\n    return (f->rindex + 1) % f->max_size; //å› ä¸ºrindexåŠ 1åå¯èƒ½è¶…è¿‡max_sizeï¼Œæ‰€ä»¥è¿™é‡Œå–ä½™\nelse\n    return f->rindex;\n```\n\nä»¥ä¸Šï¼ŒFrameQueueçš„è¯»è¿‡ç¨‹ä¹Ÿåˆ†æå®Œäº†ã€‚\n\nä¸ºäº†æ”¯æŒçµæ´»åœ°è¯»ï¼Œè¿˜æœ‰ä¸€äº›è¾…åŠ©å‡½æ•°ï¼š\n\n```c\n//è¯»å½“å‰èŠ‚ç‚¹ï¼ˆä¸Šæ–‡ä¸­çš„ç”¨è¯æ˜¯â€œå°†è¦è¯»çš„èŠ‚ç‚¹â€ï¼Œä¹Ÿå°±æ˜¯é»‘è‰²å—ï¼‰ï¼Œä¸frame_queue_peek_readableç­‰æ•ˆï¼Œä½†æ²¡æœ‰æ£€æŸ¥æ˜¯å¦æœ‰å¯è¯»èŠ‚ç‚¹\nstatic Frame *frame_queue_peek(FrameQueue *f)\n{\n    return &f->queue[(f->rindex + f->rindex_shown) % f->max_size];\n}\n\n//è¯»ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\nstatic Frame *frame_queue_peek_next(FrameQueue *f)\n{\n    return &f->queue[(f->rindex + f->rindex_shown + 1) % f->max_size];\n}\n\n//è¯»ä¸Šä¸€ä¸ªèŠ‚ç‚¹\nstatic Frame *frame_queue_peek_last(FrameQueue *f)\n{\n    return &f->queue[f->rindex];\n}\n\n/* return the number of undisplayed frames in the queue */\nstatic int frame_queue_nb_remaining(FrameQueue *f)\n{\n    return f->size - f->rindex_shown;\n}\n```\n\nå®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œå€ŸåŠ©ä¸Šå›¾çœ‹ä¸‹èŠ‚ç‚¹ä½ç½®ï¼š\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16473274840541647327483583.png)\n\nè‡³æ­¤ï¼ŒFrameQueueçš„ä¸»ä½“åŠŸèƒ½åˆ†æå®Œäº†ã€‚ä»æºç ä¸­å¯ä»¥çœ‹åˆ°FrameQueueæ˜¯é’ˆå¯¹å•è¯»å•å†™ä¼˜åŒ–çš„é«˜æ•ˆçš„å¤šçº¿ç¨‹æ¨¡å‹ï¼Œå…¶è®¾è®¡æ€è·¯ä¸å¤±ä¸ºåœ¨Cè¯­è¨€å®è·µä¸­å¯å€Ÿé‰´çš„ä¸€ä¸ªå¥½ä¾‹å­ã€‚\n","slug":"ffmpeg/2022-03-15-ffplay-frame queue åˆ†æ","published":1,"updated":"2024-03-06T11:53:13.566Z","comments":1,"photos":[],"_id":"clti3glkr002757wh4rlj3g96","content":"<p>å‚è€ƒï¼š  <a href=\"https://zhuanlan.zhihu.com/p/43564980\">ffplay frame queueåˆ†æ</a></p>\n<h2 id=\"FrameQueueæ•°æ®ç»“æ„\"><a href=\"#FrameQueueæ•°æ®ç»“æ„\" class=\"headerlink\" title=\"FrameQueueæ•°æ®ç»“æ„\"></a>FrameQueueæ•°æ®ç»“æ„</h2><p>ffplay å®šä¹‰äº† FrameQueue æ¥ç®¡ç†è§£ç åçš„éŸ³é¢‘ï¼Œè§†é¢‘ä»¥åŠå­—å¹•ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Common struct for handling all types of decoded data and allocated render buffers. */</span><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">Frame</span> &#123;</span><br>    AVFrame *frame;       <span class=\"hljs-comment\">//audio/video frame</span><br>    AVSubtitle sub;       <span class=\"hljs-comment\">//å­—å¹•</span><br>    <span class=\"hljs-type\">int</span> serial;           <span class=\"hljs-comment\">//åºåˆ—å·</span><br>    <span class=\"hljs-type\">double</span> pts;           <span class=\"hljs-comment\">/* presentation timestamp for the frame */</span><br>    <span class=\"hljs-type\">double</span> duration;      <span class=\"hljs-comment\">/* estimated duration of the frame */</span><br>    <span class=\"hljs-type\">int64_t</span> pos;          <span class=\"hljs-comment\">/* byte position of the frame in the input file */</span><br>    <span class=\"hljs-type\">int</span> width;<br>    <span class=\"hljs-type\">int</span> height;<br>    <span class=\"hljs-type\">int</span> format;<br>    AVRational sar;       <span class=\"hljs-comment\">//video aspect ratio</span><br>    <span class=\"hljs-type\">int</span> uploaded;<br>    <span class=\"hljs-type\">int</span> flip_v;           <span class=\"hljs-comment\">//videoï¼Œæ˜¯å¦åº”è¯¥åœ¨å‚ç›´æ–¹å‘ç¿»è½¬</span><br>&#125; Frame;<br><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">FrameQueue</span> &#123;</span><br>    Frame <span class=\"hljs-built_in\">queue</span>[FRAME_QUEUE_SIZE];  <span class=\"hljs-comment\">//frameæ•°ç»„ï¼Œç¯å½¢buffer</span><br>    <span class=\"hljs-type\">int</span> rindex;                     <span class=\"hljs-comment\">//è¯»æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¯è¯»çš„ä½ç½®</span><br>    <span class=\"hljs-type\">int</span> windex;                     <span class=\"hljs-comment\">//å†™æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¯å†™çš„ä½ç½®</span><br>    <span class=\"hljs-type\">int</span> size;                       <span class=\"hljs-comment\">//é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°</span><br>    <span class=\"hljs-type\">int</span> max_size;                   <span class=\"hljs-comment\">//é˜Ÿåˆ—å®¹é‡</span><br>    <span class=\"hljs-type\">int</span> keep_last;                  <span class=\"hljs-comment\">//æ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­ä¿ç•™ä¸Šä¸€ä¸ªå·²è¯»çš„å…ƒç´ </span><br>    <span class=\"hljs-type\">int</span> rindex_shown;               <span class=\"hljs-comment\">//æ ‡è®°rindexæŒ‡å‘çš„å…ƒç´ æ˜¯å¦å·²ç»å±•ç¤ºï¼ˆå·²è¯»ï¼‰ï¼Œkeep_lastä¸º1æ—¶ç”Ÿæ•ˆã€‚</span><br>    SDL_mutex *mutex;               <span class=\"hljs-comment\">//é”,ç”¨äºå®‰å…¨è®¿é—®</span><br>    SDL_cond *cond;                 <span class=\"hljs-comment\">//æ¡ä»¶å˜é‡ï¼Œç”¨äºæ§åˆ¶è¯»å–å’Œå†™å…¥ï¼Œé˜²æ­¢overrunå’Œunderflow</span><br>    PacketQueue *pktq;              <span class=\"hljs-comment\">//è¯¥frame queue å¯¹åº”çš„ pkt queue</span><br>&#125; FrameQueue;<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Frameçš„è®¾è®¡è¯•å›¾ç”¨ä¸€ä¸ªç»“æ„ä½“â€œèåˆâ€3ç§æ•°æ®ï¼šè§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ï¼Œè™½ç„¶AVFrameæ—¢å¯ä»¥è¡¨ç¤ºè§†é¢‘åˆå¯ä»¥è¡¨ç¤ºéŸ³é¢‘ï¼Œä½†åœ¨èåˆå­—å¹•æ—¶åˆéœ€è¦å¼•å…¥AVSubtitleï¼Œä»¥åŠä¸€äº›å…¶ä»–å­—æ®µï¼Œå¦‚width&#x2F;heightç­‰æ¥è¡¥å……AVSubtitleï¼Œæ‰€ä»¥æ•´ä¸ªç»“æ„ä½“çœ‹èµ·æ¥å¾ˆâ€œæ‹¼å‡‘â€ï¼ˆç”šè‡³è¿˜æœ‰è§†é¢‘ä¸“ç”¨çš„flip_vå­—æ®µï¼‰</p>\n<p>FrameQueueçš„è®¾è®¡ç†å¿µï¼š</p>\n<ol>\n<li>é«˜æ•ˆç‡çš„è¯»å†™æ¨¡å‹</li>\n<li>é«˜æ•ˆçš„å†…å­˜æ¨¡å‹ï¼ˆèŠ‚ç‚¹å†…å­˜ä»¥æ•°ç»„å½¢å¼é¢„åˆ†é…ï¼Œæ— éœ€åŠ¨æ€åˆ†é…ï¼‰</li>\n<li>ç¯å½¢ç¼“å†²åŒºè®¾è®¡ï¼ŒåŒæ—¶å¯ä»¥è®¿é—®ä¸Šä¸€è¯»èŠ‚ç‚¹</li>\n</ol>\n</blockquote>\n<h2 id=\"é˜Ÿåˆ—çš„æ“ä½œï¼š\"><a href=\"#é˜Ÿåˆ—çš„æ“ä½œï¼š\" class=\"headerlink\" title=\"é˜Ÿåˆ—çš„æ“ä½œï¼š\"></a>é˜Ÿåˆ—çš„æ“ä½œï¼š</h2><h3 id=\"é˜Ÿåˆ—åˆå§‹åŒ–\"><a href=\"#é˜Ÿåˆ—åˆå§‹åŒ–\" class=\"headerlink\" title=\"é˜Ÿåˆ—åˆå§‹åŒ–\"></a>é˜Ÿåˆ—åˆå§‹åŒ–</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">frame_queue_init</span><span class=\"hljs-params\">(FrameQueue *f, PacketQueue *pktq, <span class=\"hljs-type\">int</span> max_size, <span class=\"hljs-type\">int</span> keep_last)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> i;<br>    <span class=\"hljs-built_in\">memset</span>(f, <span class=\"hljs-number\">0</span>, <span class=\"hljs-keyword\">sizeof</span>(FrameQueue));<br>    <span class=\"hljs-comment\">//äº’æ–¥é”åˆ›å»º</span><br>    <span class=\"hljs-keyword\">if</span> (!(f-&gt;mutex = SDL_CreateMutex())) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, AV_LOG_FATAL, <span class=\"hljs-string\">&quot;SDL_CreateMutex(): %s\\n&quot;</span>, SDL_GetError());<br>        <span class=\"hljs-keyword\">return</span> AVERROR(ENOMEM);<br>    &#125;<br>    <span class=\"hljs-comment\">//æ¡ä»¶å˜é‡åˆ›å»º</span><br>    <span class=\"hljs-keyword\">if</span> (!(f-&gt;cond = SDL_CreateCond())) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, AV_LOG_FATAL, <span class=\"hljs-string\">&quot;SDL_CreateCond(): %s\\n&quot;</span>, SDL_GetError());<br>        <span class=\"hljs-keyword\">return</span> AVERROR(ENOMEM);<br>    &#125;<br>    <span class=\"hljs-comment\">//è®¾ç½®å¯¹åº”çš„pkt queue</span><br>    f-&gt;pktq = pktq;<br>    <span class=\"hljs-comment\">//è®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œè§†é¢‘ 3, éŸ³é¢‘ 9ï¼Œå­—å¹• 16</span><br>    f-&gt;max_size = FFMIN(max_size, FRAME_QUEUE_SIZE);<br>    <span class=\"hljs-comment\">//æ˜¯å¦ä¿ç•™æœ€åä¸€ä¸ªä½ç½®ï¼Œè§†é¢‘éŸ³é¢‘ä¿ç•™ï¼Œå­—å¹•ä¸ä¿ç•™</span><br>    f-&gt;keep_last = !!keep_last;<br>    <span class=\"hljs-comment\">//ç»™é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„frameåˆå§‹åŒ–</span><br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; f-&gt;max_size; i++)<br>        <span class=\"hljs-keyword\">if</span> (!(f-&gt;<span class=\"hljs-built_in\">queue</span>[i].frame = av_frame_alloc()))<br>            <span class=\"hljs-keyword\">return</span> AVERROR(ENOMEM);<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åˆå§‹åŒ–é˜Ÿåˆ—çš„å†…å­˜ï¼Œåˆ›å»ºé”ï¼Œæ¡ä»¶å˜é‡ï¼Œä¿å­˜pkt queueï¼Œè®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œkeep_lastæ ‡å¿—ä½åˆå§‹åŒ–ã€‚åˆå§‹åŒ–é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç»™é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„frameè°ƒç”¨av_frame_allocåˆ†é…å†…å­˜ã€‚</p>\n<p>å‚æ•°max_sizeç”¨æ¥è®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œæœ€å¤§ä¸è¶…è¿‡FRAME_QUEUE_SIZEã€‚å…¶ä¸­è§†é¢‘é˜Ÿåˆ—çš„å®¹é‡ä¸º3ï¼ŒéŸ³é¢‘9ï¼Œå­—å¹•16ã€‚FRAME_QUEUE_SIZEå®šä¹‰å¦‚ä¸‹:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> VIDEO_PICTURE_QUEUE_SIZE 3</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> SUBPICTURE_QUEUE_SIZE 16</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> SAMPLE_QUEUE_SIZE 9</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> FRAME_QUEUE_SIZE FFMAX(SAMPLE_QUEUE_SIZE, FFMAX(VIDEO_PICTURE_QUEUE_SIZE, SUBPICTURE_QUEUE_SIZE))</span><br></code></pre></td></tr></table></figure>\n\n<p>å±•å¼€åFRAME_QUEUE_SIZEçš„å€¼ä¸º16ã€‚</p>\n<p>keep_lastæ˜¯ä¸€ä¸ªboolå€¼ï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨ç¯å½¢ç¼“å†²åŒºçš„è¯»å†™è¿‡ç¨‹ä¸­ä¿ç•™æœ€åä¸€ä¸ªè¯»èŠ‚ç‚¹ä¸è¢«è¦†å†™ã€‚<code>f-&gt;keep_last = !!keep_last;</code>é‡Œçš„åŒæ„Ÿå¹å·æ˜¯Cä¸­çš„ä¸€ç§æŠ€å·§ï¼Œæ—¨åœ¨è®©intå‚æ•°è§„æ•´ä¸º0&#x2F;1çš„â€œboolå€¼â€ã€‚è§†é¢‘å’ŒéŸ³é¢‘ä¼šä¿ç•™æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå­—å¹•ä¸ä¿ç•™ã€‚</p>\n<h3 id=\"é˜Ÿåˆ—é”€æ¯\"><a href=\"#é˜Ÿåˆ—é”€æ¯\" class=\"headerlink\" title=\"é˜Ÿåˆ—é”€æ¯\"></a>é˜Ÿåˆ—é”€æ¯</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">frame_queue_destory</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> i;<br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; f-&gt;max_size; i++) &#123;<br>        Frame *vp = &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[i];<br>Â Â Â Â Â Â Â Â <span class=\"hljs-comment\">//å¯¹æ¯ä¸ªèŠ‚ç‚¹è°ƒç”¨frame_queue_unref_item</span><br>        frame_queue_unref_item(vp);<br>Â Â Â Â Â Â Â Â <span class=\"hljs-comment\">//è°ƒç”¨av_frame_freeé‡Šæ”¾frameçš„å†…å­˜</span><br>        av_frame_free(&amp;vp-&gt;frame);<br>    &#125;<br>    SDL_DestroyMutex(f-&gt;mutex);<br>    SDL_DestroyCond(f-&gt;cond);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>è¾ƒä¸ºé‡è¦çš„æ˜¯queueå…ƒç´ çš„é‡Šæ”¾ã€‚åˆ†ä¸¤æ­¥ï¼Œåˆ†åˆ«æ˜¯<code>frame_queue_unref_item</code>å’Œ<code>av_frame_free</code>ã€‚å…¶ä¸­<code>av_frame_free</code>ä¸åˆå§‹åŒ–ä¸­çš„<code>av_frame_alloc</code>å¯¹åº”ï¼Œç”¨äºé‡Šæ”¾AVFrame.</p>\n<p><code>frame_queue_unref_item</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">frame_queue_unref_item</span><span class=\"hljs-params\">(Frame *vp)</span><br>&#123;<br>    av_frame_unref(vp-&gt;frame);<span class=\"hljs-comment\">//å¼•ç”¨è®¡æ•°-1</span><br>    avsubtitle_free(&amp;vp-&gt;sub);<span class=\"hljs-comment\">//subå…³è”çš„å†…å­˜é‡Šæ”¾</span><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>frame_queue_unref_item</code>é‡Šæ”¾çš„å†…å­˜éƒ½æ˜¯<strong>å…³è”</strong>çš„å†…å­˜ï¼Œè€Œéç»“æ„ä½“è‡ªèº«å†…å­˜ã€‚</p>\n<p>AVFrameå†…éƒ¨æœ‰è®¸å¤šçš„AVBufferRefç±»å‹å­—æ®µï¼Œè€ŒAVBufferRefåªæ˜¯AVBufferçš„å¼•ç”¨ï¼ŒAVBufferé€šè¿‡å¼•ç”¨è®¡æ•°è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼ˆç®€æ˜“åƒåœ¾å›æ”¶æœºåˆ¶ï¼‰ã€‚å› æ­¤AVFrameåœ¨ä¸éœ€è¦çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡<code>av_frame_unref</code>å‡å°‘å¼•ç”¨è®¡æ•°ã€‚</p>\n<blockquote>\n<p>å…³äºAVBufferRefçš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š <a href=\"%5B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3FFMPEG-AVBuffer/AVBufferRef/AVBufferPool_muyuyuzhong%E7%9A%84%E4%B8%93%E6%A0%8F-CSDN%E5%8D%9A%E5%AE%A2%5D(https://blog.csdn.net/muyuyuzhong/article/details/79381152)\">æ·±å…¥ç†è§£FFMPEG-AVBuffer&#x2F;AVBufferRef&#x2F;AVBufferPool</a></p>\n</blockquote>\n<h3 id=\"é˜Ÿåˆ—å†™æ“ä½œ\"><a href=\"#é˜Ÿåˆ—å†™æ“ä½œ\" class=\"headerlink\" title=\"é˜Ÿåˆ—å†™æ“ä½œ\"></a>é˜Ÿåˆ—å†™æ“ä½œ</h3><p>FrameQueueçš„â€œå†™â€åˆ†ä¸¤æ­¥ï¼Œå…ˆè°ƒç”¨<code>frame_queue_peek_writable</code>è·å–ä¸€ä¸ªå¯å†™èŠ‚ç‚¹ï¼Œåœ¨å¯¹èŠ‚ç‚¹æ“ä½œç»“æŸåï¼Œè°ƒç”¨<code>frame_queue_push</code>å‘ŠçŸ¥FrameQueueâ€œå­˜å…¥â€è¯¥èŠ‚ç‚¹ã€‚</p>\n<blockquote>\n<p>é˜…è¯»æç¤ºï¼š<br>åœ¨ffplayä¸­ï¼ŒFrameQueueå§‹ç»ˆæ˜¯ä¸€ä¸ªçº¿ç¨‹å†™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»ã€‚ä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªè¯»çº¿ç¨‹ï¼Œä¸ä¼šæœ‰å…¶ä»–è¯»çº¿ç¨‹ç«äº‰è¯»ï¼›åªæœ‰ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹ç«äº‰å†™ï¼›å”¯ä¸€éœ€è¦çš„æ˜¯è¯»ä¸å†™çº¿ç¨‹é—´çš„åŒæ­¥ã€‚FrameQueueçš„æ•´ä¸ªä¼˜åŒ–å’Œè®¾è®¡æ€è·¯æ­£æ˜¯åŸºäºè¿™ä¸€ç‚¹çš„ã€‚</p>\n</blockquote>\n<p>å…ˆçœ‹<code>frame_queue_peek_writable</code>ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_writable</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-comment\">/* wait until we have space to put a new frame */</span><br>    SDL_LockMutex(f-&gt;mutex);<br>    <span class=\"hljs-keyword\">while</span> (f-&gt;size &gt;= f-&gt;max_size &amp;&amp;<br>           !f-&gt;pktq-&gt;abort_request) &#123;<br>        <span class=\"hljs-comment\">//ç­‰å¾…æœ‰ç©ºé—´å¯ä»¥å†™ï¼Œæ‰ç»§ç»­æ‰§è¡Œ</span><br>        SDL_CondWait(f-&gt;cond, f-&gt;mutex);<br>    &#125;<br>    SDL_UnlockMutex(f-&gt;mutex);<br><br>    <span class=\"hljs-keyword\">if</span> (f-&gt;pktq-&gt;abort_request)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-comment\">//è¿”å›f-&gt;windexå¯¹åº”çš„frame</span><br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[f-&gt;windex];<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ•´ä¸ªå‡½æ•°åˆ†3æ­¥ï¼š</p>\n<ol>\n<li>åŠ é”æƒ…å†µä¸‹ï¼Œç­‰å¾…ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºä½™ç©ºé—´å¯å†™ï¼ˆ<code>f-&gt;size &lt; f-&gt;max_size</code>ï¼‰</li>\n<li>å¦‚æœæœ‰é€€å‡ºè¯·æ±‚ï¼ˆ<code>f-&gt;pktq-&gt;abort_request</code>ï¼‰ï¼Œåˆ™è¿”å›NULL</li>\n<li>è¿”å›<code>windex</code>ä½ç½®çš„å…ƒç´ ï¼ˆ<code>windex</code>æŒ‡å‘å½“å‰åº”å†™ä½ç½®ï¼‰</li>\n</ol>\n<blockquote>\n<p>ä¸ºä»€ä¹ˆè¿™é‡Œé”çš„èŒƒå›´ä¸æ˜¯æ•´ä¸ªå‡½æ•°å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†å‡å°é”çš„èŒƒå›´ï¼Œä»¥æé«˜æ•ˆç‡ã€‚è€Œä¹‹æ‰€ä»¥å¯ä»¥åœ¨æ— é”çš„æƒ…å†µä¸‹å®‰å…¨è®¿é—®queue å­—æ®µï¼Œæ˜¯å› ä¸ºä¸Šæ–‡ä¸­æåˆ°çš„å•è¯»å•å†™çš„ç‰¹æ®Šåœºæ™¯ã€‚é¦–å…ˆï¼Œqueueæ˜¯ä¸€ä¸ªé¢„å…ˆåˆ†é…å¥½çš„æ•°ç»„ï¼Œå› æ­¤queueæœ¬èº«ä¸å‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥å®‰å…¨è®¿é—®ï¼›æ¥ç€queueå†…çš„å…ƒç´ ï¼Œè¯»å’Œå†™ä¸å­˜åœ¨é‡å ï¼Œå³windexå’Œrindexä¸ä¼šé‡å ã€‚</p>\n<p>å…³äºâ€œè¯»å’Œå†™ä¸å­˜åœ¨é‡å â€ï¼Œä»”ç»†çœ‹çœ‹ã€‚å› ä¸ºqueueæ•°ç»„è¢«å½“åšä¸€ä¸ªç¯å½¢ç¼“å†²åŒºä½¿ç”¨ï¼Œé‚£ä¹ˆçš„ç¡®å­˜åœ¨underrunå’Œoverrunçš„æƒ…å†µï¼Œå³è¯»è¿‡å¿«ï¼Œæˆ–å†™è¿‡å¿«çš„æƒ…å†µï¼Œè¿™æ—¶å¦‚æœä¸åŠ æ§åˆ¶ï¼Œå°±ä¼šå‘ˆç°ç¼“å†²åŒºè¦†ç›–ã€‚</p>\n<p>FrameQueueçš„ç²¾æ˜ä¹‹å¤„åœ¨äºï¼Œå…ˆé€šè¿‡sizeåˆ¤æ–­å½“å‰ç¼“å†²åŒºå†…ç©ºé—´æ˜¯å¦å¤Ÿå†™ï¼Œæˆ–è€…å¤Ÿè¯»ï¼Œæ¯”å¦‚è¿™é‡Œå…ˆé€šè¿‡ä¸€ä¸ªå¾ªç¯çš„æ¡ä»¶ç­‰å¾…ï¼Œåˆ¤æ–­<code>f-&gt;size &gt;= f-&gt;max_size</code>ï¼Œå¦‚æœ<code>f-&gt;size &gt;= f-&gt;max_size</code>ï¼Œé‚£ä¹ˆè¯´æ˜é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å·²ç»å†™æ»¡ï¼Œä¹Ÿå°±æ˜¯å·²ç»overrunäº†ï¼Œæ­¤æ—¶å¦‚æœå†å†™ï¼Œè‚¯å®šä¼šè¦†å†™æœªè¯»æ•°æ®ï¼Œé‚£ä¹ˆå°±éœ€è¦ç»§ç»­ç­‰å¾…ã€‚å½“æ— éœ€ç­‰å¾…æ—¶ï¼ŒwindexæŒ‡å‘çš„å†…å­˜ä¸€å®šæ˜¯å·²ç»è¯»è¿‡çš„ï¼ˆé™¤éä»£ç å¼‚å¸¸äº†ï¼‰ã€‚</p>\n<p>è°ƒç”¨<code>frame_queue_peek_writable</code>å–åˆ°FrameæŒ‡é’ˆåï¼Œå°±å¯ä»¥å¯¹Frameå†…çš„å­—æ®µè‡ªç”±æ”¹å†™ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå†™è¿›ç¨‹ï¼Œä¸”æ— éœ€æ‹…å¿ƒè¯»è¿›ç¨‹è¦†å†™ã€‚å¦‚ä¸Šåˆ†æï¼Œè¯»è¿›ç¨‹è¦è¯»ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¹Ÿä¼šå…ˆåˆ¤æ–­underrunçš„æƒ…å†µï¼‰ã€‚</p>\n</blockquote>\n<p>ä¸€èˆ¬æ­¥éª¤æ˜¯ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\">Frame* vp = frame_queue_peek_writable(q);<br><span class=\"hljs-comment\">//å°†è¦å­˜å‚¨çš„æ•°æ®å†™å…¥frameå­—æ®µï¼Œæ¯”å¦‚ï¼š</span><br>av_frame_move_ref(vp-&gt;frame, src_frame);<br><span class=\"hljs-comment\">//å­˜å…¥é˜Ÿåˆ—</span><br>frame_queue_push(q);<br></code></pre></td></tr></table></figure>\n\n<p><code>frame_queue_push</code>æ€ä¹ˆçŸ¥é“è¦pushçš„æ˜¯è¿™é‡Œçš„vpå‘¢ï¼Ÿ</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">frame_queue_push</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">if</span> (++f-&gt;windex == f-&gt;max_size)<br>        f-&gt;windex = <span class=\"hljs-number\">0</span>;<br>    SDL_LockMutex(f-&gt;mutex);<br>    f-&gt;size++;<br>    SDL_CondSignal(f-&gt;cond);<br>    SDL_UnlockMutex(f-&gt;mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ç­”æ¡ˆæ˜¯pushå½“å‰windexèŠ‚ç‚¹ã€‚çœ‹<code>frame_queue_push</code>å‡½æ•°ï¼Œæ‰§è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š</p>\n<ol>\n<li>windexåŠ 1ï¼Œå¦‚æœè¶…è¿‡max_sizeï¼Œåˆ™å›ç¯ä¸º0</li>\n<li>åŠ é”æƒ…å†µä¸‹å¤§å°åŠ 1.</li>\n</ol>\n<blockquote>\n<p>å› ä¸ºFrameQueueæ˜¯åŸºäºå›ºå®šé•¿åº¦çš„æ•°ç»„å®ç°çš„é˜Ÿåˆ—ï¼Œä¸é“¾è¡¨é˜Ÿåˆ—ä¸åŒï¼Œå…¶èŠ‚ç‚¹åœ¨åˆå§‹åŒ–çš„æ—¶å€™å·²ç»åœ¨é˜Ÿåˆ—ä¸­äº†ï¼Œpushæ‰€è¦åšçš„åªæ˜¯é€šè¿‡æŸç§æ ‡å¿—è®°å½•è¯¥èŠ‚ç‚¹æ˜¯å¦æ˜¯å†™å…¥æœªè¯»çš„ã€‚ffplayçš„åšæ³•æ˜¯å¯¹windexåŠ 1ï¼Œå°†å†™æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå‡¡æ˜¯windexâ€œä¹‹å‰â€çš„èŠ‚ç‚¹ï¼Œéƒ½æ˜¯å†™è¿‡çš„ã€‚ï¼ˆè‡³äºæ˜¯å¦å¯è¯»ï¼ŒrindexçŸ¥é“ï¼›è‡³äºåç»­æœ‰å¤šå°‘ç©ºé—´å¯å†™ï¼ŒsizeçŸ¥é“ï¼‰</p>\n</blockquote>\n<h3 id=\"é˜Ÿåˆ—è¯»æ“ä½œ\"><a href=\"#é˜Ÿåˆ—è¯»æ“ä½œ\" class=\"headerlink\" title=\"é˜Ÿåˆ—è¯»æ“ä½œ\"></a>é˜Ÿåˆ—è¯»æ“ä½œ</h3><p>å’Œå†™ä¸€æ ·ï¼ŒFrameQueueçš„è¯»ä¹Ÿåˆ†ä¸¤æ­¥ã€‚<code>frame_queue_peek_readable</code>å’Œ<code>frame_queue_next</code>ã€‚ç›¸æ¯”å†™è¦å¤æ‚ä¸€ç‚¹çš„æ˜¯ ï¼Œè¯»çš„ä»£ç å¤šè€ƒè™‘å¦ä¸€ä¸ªç‰¹æ€§ï¼Œå³å…è®¸ä¿ç•™ä¸Šä¸€è¯»èŠ‚ç‚¹ã€‚</p>\n<p><code>frame_queue_peek_readable</code>ä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_readable</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-comment\">/* wait until we have a readable a new frame */</span><br>    SDL_LockMutex(f-&gt;mutex);<br>    <span class=\"hljs-keyword\">while</span> (f-&gt;size - f-&gt;rindex_shown &lt;= <span class=\"hljs-number\">0</span> &amp;&amp;<br>           !f-&gt;pktq-&gt;abort_request) &#123;<br>        SDL_CondWait(f-&gt;cond, f-&gt;mutex);<br>    &#125;<br>    SDL_UnlockMutex(f-&gt;mutex);<br><br>    <span class=\"hljs-keyword\">if</span> (f-&gt;pktq-&gt;abort_request)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;<br><br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[(f-&gt;rindex + f-&gt;rindex_shown) % f-&gt;max_size];<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>å’Œ<code>frame_queue_peek_writable</code>ç±»ä¼¼ï¼Œåˆ†ä¸‰æ­¥:</p>\n<ol>\n<li>åŠ é”æƒ…å†µä¸‹ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¯è¯»èŠ‚ç‚¹ï¼ˆ<code>f-&gt;size - f-&gt;rindex_shown &gt; 0</code>)</li>\n<li>å¦‚æœæœ‰é€€å‡ºè¯·æ±‚ï¼Œåˆ™è¿”å›NULL</li>\n<li>è¯»å–å½“å‰å¯è¯»èŠ‚ç‚¹<code>(f-&gt;rindex + f-&gt;rindex_shown) % f-&gt;max_size</code></li>\n</ol>\n<p><code>rindex_shown</code>æœ‰äº›å¹²æ‰°ä»£ç åˆ†æï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸æ”¯æŒkeep_lastçš„æƒ…å†µï¼ˆåªéœ€è¦åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥keep_last &#x3D; 0ï¼‰ï¼Œæ­¤äº‹<code>rindex_shown</code>å§‹ç»ˆä¸º0ï¼Œæ‰€ä»¥ï¼Œ<code>frame_queue_peek_readable</code>ç®€åŒ–å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_readable</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-comment\">/* wait until we have a readable a new frame */</span><br>    SDL_LockMutex(f-&gt;mutex);<br>    <span class=\"hljs-keyword\">while</span> (f-&gt;size &lt;= <span class=\"hljs-number\">0</span> &amp;&amp;<br>           !f-&gt;pktq-&gt;abort_request) &#123;<br>        SDL_CondWait(f-&gt;cond, f-&gt;mutex);<br>    &#125;<br>    SDL_UnlockMutex(f-&gt;mutex);<br><br>    <span class=\"hljs-keyword\">if</span> (f-&gt;pktq-&gt;abort_request)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;<br><br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[f-&gt;rindex];<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n<p>å’Œpeek_writableå‡ ä¹æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚å°±ä¸åˆ†æäº†ã€‚</p>\n<p>åœ¨ç®€åŒ–ç‰ˆæœ¬ä¸Šç†è§£å¼•å…¥<code>rindex_shown</code>çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£<code>rindex_shown</code>ã€‚<code>rindex_shown</code>çš„æ„æ€æ˜¯<code>rindex</code>æŒ‡å‘çš„èŠ‚ç‚¹æ˜¯å¦è¢«è¯»è¿‡ï¼Œå¦‚æœè¢«è¯»è¿‡ï¼Œ ä¸º1ï¼Œåä¹‹ï¼Œä¸º0ã€‚è¿™ä¸€è¡Œä¸ºï¼Œä½“ç°åœ¨<code>frame_queue_next</code>ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">frame_queue_next</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;   <br>    <span class=\"hljs-comment\">//å¦‚æœæ”¯æŒkeep_lastï¼Œå¹¶ä¸”f-&gt;rindex_shownä¸º0, å°†rindex_shownè®¾ç½®ä¸º1ï¼Œè¿”å›</span><br>    <span class=\"hljs-keyword\">if</span> (f-&gt;keep_last &amp;&amp; !f-&gt;rindex_shown) &#123;<br>        f-&gt;rindex_shown = <span class=\"hljs-number\">1</span>;<br>        <span class=\"hljs-keyword\">return</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//å¦åˆ™ï¼Œç§»åŠ¨rindexæŒ‡é’ˆï¼Œå¹¶å‡å°size</span><br>    frame_queue_unref_item(&amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[f-&gt;rindex]);<br>    <span class=\"hljs-keyword\">if</span> (++f-&gt;rindex == f-&gt;max_size)<br>        f-&gt;rindex = <span class=\"hljs-number\">0</span>;<br>    SDL_LockMutex(f-&gt;mutex);<br>    f-&gt;size--;<br>    SDL_CondSignal(f-&gt;cond);<br>    SDL_UnlockMutex(f-&gt;mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>frame_queue_next</code>ç”¨äºåœ¨è¯»å®Œä¸€ä¸ªèŠ‚ç‚¹åè°ƒç”¨ï¼Œç”¨äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹å·²ç»è¢«è¯»è¿‡ã€‚</p>\n<p>ä¸å†™è¿‡ç¨‹ç±»ä¼¼ï¼Œè¯»è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\">Frame* vp = frame_queue_peek_readable(f);<br><span class=\"hljs-comment\">//è¯»å–vpçš„æ•°æ®ï¼Œæ¯”å¦‚</span><br><span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;pict_type=%d\\n&quot;</span>, vp-&gt;frame-&gt;pict_type);<br>frame_queue_next(f);<br></code></pre></td></tr></table></figure>\n\n<p><code>frame_queue_next</code>æ¯”<code>frame_queue_push</code>ç•¥å¤æ‚ï¼Œæˆ‘ä»¬è¦åˆ†æä¸¤ä¸ªè¡Œä¸ºï¼šæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²è¯»ï¼Œä»¥åŠ<code>rindex_shown</code>çš„èµ‹å€¼ã€‚</p>\n<p>æ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²è¯»äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²å†™æ˜¯ç±»ä¼¼çš„ï¼Œæ‰§è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š</p>\n<ol>\n<li>rindexåŠ 1ï¼Œå¦‚æœè¶…è¿‡max_sizeï¼Œåˆ™å›ç¯ä¸º0</li>\n<li>åŠ é”æƒ…å†µä¸‹å¤§å°å‡1.</li>\n</ol>\n<p>ç‰¹åˆ«çš„æ˜¯ï¼Œå¯¹äºä»¥åŠè¯»è¿‡çš„èŠ‚ç‚¹ï¼Œéœ€è¦è°ƒç”¨<code>frame_queue_unref_item</code>é‡Šæ”¾å…³è”å†…å­˜ã€‚</p>\n<p>æ‰§è¡Œrindexæ“ä½œå‰ï¼Œéœ€è¦å…ˆåˆ¤æ–­<code>rindex_shown</code>çš„å€¼ï¼Œå¦‚æœä¸º0ï¼Œåˆ™èµ‹1ã€‚è¿™ä¹ˆåšçš„æ„å›¾ä¸å¦¨ç”»å›¾åˆ†æï¼š</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16473273492201647327349203.png\"></p>\n<p>è¿™é‡Œæ¨¡æ‹Ÿäº†ä»åˆå§‹åŒ–å¼€å§‹çš„2æ¬¡â€œè¯»â€ã€‚</p>\n<p>è¿˜æ²¡å¼€å§‹è¯»ï¼Œrindexå’Œrindex_shownå‡ä¸º0ã€‚è¿™æ—¶è¦peekçš„è¯»èŠ‚ç‚¹æ˜¯èŠ‚ç‚¹0(å›¾ä¸­é»‘è‰²å—ï¼‰ã€‚</p>\n<p>ç¬¬ä¸€æ¬¡è¯»ï¼Œè°ƒç”¨nextï¼Œæ»¡è¶³æ¡ä»¶<code>f-&gt;keep_last &amp;&amp; !f-&gt;rindex_shown</code>ï¼Œæ‰€ä»¥rindexä»ç„¶æ˜¯0ï¼Œè€Œrindex_shownä¸º1.æ­¤æ—¶èŠ‚ç‚¹0ï¼ˆç°è‰²å—ï¼‰æ˜¯å·²è¯»èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯è¦keepçš„lastèŠ‚ç‚¹ï¼Œå°†è¦è¯»çš„èŠ‚ç‚¹æ˜¯èŠ‚ç‚¹1ï¼ˆé»‘è‰²å—ï¼‰ã€‚ï¼ˆæ°å¥½æ˜¯rindex+rindex_shownï¼‰</p>\n<p>ç¬¬äºŒæ¬¡è¯»ï¼Œpeekäº†é»‘è‰²å—åï¼Œè°ƒç”¨nextï¼Œä¸æ»¡è¶³æ¡ä»¶<code>f-&gt;keep_last &amp;&amp; !f-&gt;rindex_shown</code>ï¼Œæ‰€ä»¥rindexä¸º1ï¼Œè€Œrindex_shownä¸º2.æ­¤æ—¶èŠ‚ç‚¹1ï¼ˆç°è‰²å—ï¼‰æ˜¯lastèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹2ï¼ˆé»‘è‰²å—ï¼‰æ˜¯å°†è¦è¯»çš„èŠ‚ç‚¹ã€‚ï¼ˆä¹Ÿæ°å¥½æ˜¯rindex+rindex_shownï¼‰</p>\n<p>ç»§ç»­å¾€ååˆ†æï¼Œä¼šä¸€ç›´é‡å¤ç¬¬äºŒæ¬¡è¯»çš„æƒ…å†µï¼Œå§‹ç»ˆæ˜¯rindexæŒ‡å‘äº†lastï¼Œè€Œrindex_shownä¸€ç›´ä¸º1ï¼Œrindex+rindex_shownåˆšå¥½æ˜¯å°†è¦è¯»çš„èŠ‚ç‚¹ã€‚</p>\n<p>è‡³æ­¤ï¼Œ<code>frame_queue_next</code>çš„è¡Œä¸ºç®—æ˜¯æ˜ç¡®äº†ã€‚å›å¤´çœ‹çœ‹<code>frame_queue_peek_readable</code>ã€‚</p>\n<p>æ­¥éª¤1ä¸­ï¼Œåˆ¤æ–­æ— å¯è¯»èŠ‚ç‚¹ï¼Œç”¨çš„æ˜¯<code>f-&gt;size - f-&gt;rindex_shown &lt;= 0</code>ï¼Œå…¶å®æ˜¯ä»¥ä¸‹ä»£ç çš„ç®€åŒ–ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (f-&gt;rindex_shown)<br>    <span class=\"hljs-keyword\">return</span> f-&gt;size - <span class=\"hljs-number\">1</span>;<br><span class=\"hljs-keyword\">else</span><br>    <span class=\"hljs-keyword\">return</span> f-&gt;size;<br></code></pre></td></tr></table></figure>\n\n<p>åªæ˜¯Cä¸­ç”¨intæ¨¡æ‹Ÿboolï¼Œåˆšå¥½rindex_shownä¸ºtrueæ˜¯1ï¼Œæ‰€ä»¥å¯ä»¥ç®€åŒ–ä¸º<code>`f-&gt;size - f-&gt;rindex_shown</code>.</p>\n<p>æ­¥éª¤3ä¸­ï¼Œå–å°†è¦è¯»çš„èŠ‚ç‚¹ç”¨çš„æ˜¯<code>(f-&gt;rindex + f-&gt;rindex_shown) % f-&gt;max_size</code>ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªç®€åŒ–ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//è¿™æ®µä»£ç æ ¹æ®ä¸Šå›¾å¾ˆå®¹æ˜“æ¨å¯¼</span><br><span class=\"hljs-keyword\">if</span> (f-&gt;rindex_shown)<br>    <span class=\"hljs-keyword\">return</span> (f-&gt;rindex + <span class=\"hljs-number\">1</span>) % f-&gt;max_size; <span class=\"hljs-comment\">//å› ä¸ºrindexåŠ 1åå¯èƒ½è¶…è¿‡max_sizeï¼Œæ‰€ä»¥è¿™é‡Œå–ä½™</span><br><span class=\"hljs-keyword\">else</span><br>    <span class=\"hljs-keyword\">return</span> f-&gt;rindex;<br></code></pre></td></tr></table></figure>\n\n<p>ä»¥ä¸Šï¼ŒFrameQueueçš„è¯»è¿‡ç¨‹ä¹Ÿåˆ†æå®Œäº†ã€‚</p>\n<p>ä¸ºäº†æ”¯æŒçµæ´»åœ°è¯»ï¼Œè¿˜æœ‰ä¸€äº›è¾…åŠ©å‡½æ•°ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//è¯»å½“å‰èŠ‚ç‚¹ï¼ˆä¸Šæ–‡ä¸­çš„ç”¨è¯æ˜¯â€œå°†è¦è¯»çš„èŠ‚ç‚¹â€ï¼Œä¹Ÿå°±æ˜¯é»‘è‰²å—ï¼‰ï¼Œä¸frame_queue_peek_readableç­‰æ•ˆï¼Œä½†æ²¡æœ‰æ£€æŸ¥æ˜¯å¦æœ‰å¯è¯»èŠ‚ç‚¹</span><br><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[(f-&gt;rindex + f-&gt;rindex_shown) % f-&gt;max_size];<br>&#125;<br><br><span class=\"hljs-comment\">//è¯»ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_next</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[(f-&gt;rindex + f-&gt;rindex_shown + <span class=\"hljs-number\">1</span>) % f-&gt;max_size];<br>&#125;<br><br><span class=\"hljs-comment\">//è¯»ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span><br><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_last</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[f-&gt;rindex];<br>&#125;<br><br><span class=\"hljs-comment\">/* return the number of undisplayed frames in the queue */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">frame_queue_nb_remaining</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">return</span> f-&gt;size - f-&gt;rindex_shown;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>å®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œå€ŸåŠ©ä¸Šå›¾çœ‹ä¸‹èŠ‚ç‚¹ä½ç½®ï¼š</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16473274840541647327483583.png\"></p>\n<p>è‡³æ­¤ï¼ŒFrameQueueçš„ä¸»ä½“åŠŸèƒ½åˆ†æå®Œäº†ã€‚ä»æºç ä¸­å¯ä»¥çœ‹åˆ°FrameQueueæ˜¯é’ˆå¯¹å•è¯»å•å†™ä¼˜åŒ–çš„é«˜æ•ˆçš„å¤šçº¿ç¨‹æ¨¡å‹ï¼Œå…¶è®¾è®¡æ€è·¯ä¸å¤±ä¸ºåœ¨Cè¯­è¨€å®è·µä¸­å¯å€Ÿé‰´çš„ä¸€ä¸ªå¥½ä¾‹å­ã€‚</p>\n","excerpt":"","more":"<p>å‚è€ƒï¼š  <a href=\"https://zhuanlan.zhihu.com/p/43564980\">ffplay frame queueåˆ†æ</a></p>\n<h2 id=\"FrameQueueæ•°æ®ç»“æ„\"><a href=\"#FrameQueueæ•°æ®ç»“æ„\" class=\"headerlink\" title=\"FrameQueueæ•°æ®ç»“æ„\"></a>FrameQueueæ•°æ®ç»“æ„</h2><p>ffplay å®šä¹‰äº† FrameQueue æ¥ç®¡ç†è§£ç åçš„éŸ³é¢‘ï¼Œè§†é¢‘ä»¥åŠå­—å¹•ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">/* Common struct for handling all types of decoded data and allocated render buffers. */</span><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">Frame</span> &#123;</span><br>    AVFrame *frame;       <span class=\"hljs-comment\">//audio/video frame</span><br>    AVSubtitle sub;       <span class=\"hljs-comment\">//å­—å¹•</span><br>    <span class=\"hljs-type\">int</span> serial;           <span class=\"hljs-comment\">//åºåˆ—å·</span><br>    <span class=\"hljs-type\">double</span> pts;           <span class=\"hljs-comment\">/* presentation timestamp for the frame */</span><br>    <span class=\"hljs-type\">double</span> duration;      <span class=\"hljs-comment\">/* estimated duration of the frame */</span><br>    <span class=\"hljs-type\">int64_t</span> pos;          <span class=\"hljs-comment\">/* byte position of the frame in the input file */</span><br>    <span class=\"hljs-type\">int</span> width;<br>    <span class=\"hljs-type\">int</span> height;<br>    <span class=\"hljs-type\">int</span> format;<br>    AVRational sar;       <span class=\"hljs-comment\">//video aspect ratio</span><br>    <span class=\"hljs-type\">int</span> uploaded;<br>    <span class=\"hljs-type\">int</span> flip_v;           <span class=\"hljs-comment\">//videoï¼Œæ˜¯å¦åº”è¯¥åœ¨å‚ç›´æ–¹å‘ç¿»è½¬</span><br>&#125; Frame;<br><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">FrameQueue</span> &#123;</span><br>    Frame <span class=\"hljs-built_in\">queue</span>[FRAME_QUEUE_SIZE];  <span class=\"hljs-comment\">//frameæ•°ç»„ï¼Œç¯å½¢buffer</span><br>    <span class=\"hljs-type\">int</span> rindex;                     <span class=\"hljs-comment\">//è¯»æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¯è¯»çš„ä½ç½®</span><br>    <span class=\"hljs-type\">int</span> windex;                     <span class=\"hljs-comment\">//å†™æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¯å†™çš„ä½ç½®</span><br>    <span class=\"hljs-type\">int</span> size;                       <span class=\"hljs-comment\">//é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°</span><br>    <span class=\"hljs-type\">int</span> max_size;                   <span class=\"hljs-comment\">//é˜Ÿåˆ—å®¹é‡</span><br>    <span class=\"hljs-type\">int</span> keep_last;                  <span class=\"hljs-comment\">//æ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­ä¿ç•™ä¸Šä¸€ä¸ªå·²è¯»çš„å…ƒç´ </span><br>    <span class=\"hljs-type\">int</span> rindex_shown;               <span class=\"hljs-comment\">//æ ‡è®°rindexæŒ‡å‘çš„å…ƒç´ æ˜¯å¦å·²ç»å±•ç¤ºï¼ˆå·²è¯»ï¼‰ï¼Œkeep_lastä¸º1æ—¶ç”Ÿæ•ˆã€‚</span><br>    SDL_mutex *mutex;               <span class=\"hljs-comment\">//é”,ç”¨äºå®‰å…¨è®¿é—®</span><br>    SDL_cond *cond;                 <span class=\"hljs-comment\">//æ¡ä»¶å˜é‡ï¼Œç”¨äºæ§åˆ¶è¯»å–å’Œå†™å…¥ï¼Œé˜²æ­¢overrunå’Œunderflow</span><br>    PacketQueue *pktq;              <span class=\"hljs-comment\">//è¯¥frame queue å¯¹åº”çš„ pkt queue</span><br>&#125; FrameQueue;<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Frameçš„è®¾è®¡è¯•å›¾ç”¨ä¸€ä¸ªç»“æ„ä½“â€œèåˆâ€3ç§æ•°æ®ï¼šè§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ï¼Œè™½ç„¶AVFrameæ—¢å¯ä»¥è¡¨ç¤ºè§†é¢‘åˆå¯ä»¥è¡¨ç¤ºéŸ³é¢‘ï¼Œä½†åœ¨èåˆå­—å¹•æ—¶åˆéœ€è¦å¼•å…¥AVSubtitleï¼Œä»¥åŠä¸€äº›å…¶ä»–å­—æ®µï¼Œå¦‚width&#x2F;heightç­‰æ¥è¡¥å……AVSubtitleï¼Œæ‰€ä»¥æ•´ä¸ªç»“æ„ä½“çœ‹èµ·æ¥å¾ˆâ€œæ‹¼å‡‘â€ï¼ˆç”šè‡³è¿˜æœ‰è§†é¢‘ä¸“ç”¨çš„flip_vå­—æ®µï¼‰</p>\n<p>FrameQueueçš„è®¾è®¡ç†å¿µï¼š</p>\n<ol>\n<li>é«˜æ•ˆç‡çš„è¯»å†™æ¨¡å‹</li>\n<li>é«˜æ•ˆçš„å†…å­˜æ¨¡å‹ï¼ˆèŠ‚ç‚¹å†…å­˜ä»¥æ•°ç»„å½¢å¼é¢„åˆ†é…ï¼Œæ— éœ€åŠ¨æ€åˆ†é…ï¼‰</li>\n<li>ç¯å½¢ç¼“å†²åŒºè®¾è®¡ï¼ŒåŒæ—¶å¯ä»¥è®¿é—®ä¸Šä¸€è¯»èŠ‚ç‚¹</li>\n</ol>\n</blockquote>\n<h2 id=\"é˜Ÿåˆ—çš„æ“ä½œï¼š\"><a href=\"#é˜Ÿåˆ—çš„æ“ä½œï¼š\" class=\"headerlink\" title=\"é˜Ÿåˆ—çš„æ“ä½œï¼š\"></a>é˜Ÿåˆ—çš„æ“ä½œï¼š</h2><h3 id=\"é˜Ÿåˆ—åˆå§‹åŒ–\"><a href=\"#é˜Ÿåˆ—åˆå§‹åŒ–\" class=\"headerlink\" title=\"é˜Ÿåˆ—åˆå§‹åŒ–\"></a>é˜Ÿåˆ—åˆå§‹åŒ–</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">frame_queue_init</span><span class=\"hljs-params\">(FrameQueue *f, PacketQueue *pktq, <span class=\"hljs-type\">int</span> max_size, <span class=\"hljs-type\">int</span> keep_last)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> i;<br>    <span class=\"hljs-built_in\">memset</span>(f, <span class=\"hljs-number\">0</span>, <span class=\"hljs-keyword\">sizeof</span>(FrameQueue));<br>    <span class=\"hljs-comment\">//äº’æ–¥é”åˆ›å»º</span><br>    <span class=\"hljs-keyword\">if</span> (!(f-&gt;mutex = SDL_CreateMutex())) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, AV_LOG_FATAL, <span class=\"hljs-string\">&quot;SDL_CreateMutex(): %s\\n&quot;</span>, SDL_GetError());<br>        <span class=\"hljs-keyword\">return</span> AVERROR(ENOMEM);<br>    &#125;<br>    <span class=\"hljs-comment\">//æ¡ä»¶å˜é‡åˆ›å»º</span><br>    <span class=\"hljs-keyword\">if</span> (!(f-&gt;cond = SDL_CreateCond())) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, AV_LOG_FATAL, <span class=\"hljs-string\">&quot;SDL_CreateCond(): %s\\n&quot;</span>, SDL_GetError());<br>        <span class=\"hljs-keyword\">return</span> AVERROR(ENOMEM);<br>    &#125;<br>    <span class=\"hljs-comment\">//è®¾ç½®å¯¹åº”çš„pkt queue</span><br>    f-&gt;pktq = pktq;<br>    <span class=\"hljs-comment\">//è®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œè§†é¢‘ 3, éŸ³é¢‘ 9ï¼Œå­—å¹• 16</span><br>    f-&gt;max_size = FFMIN(max_size, FRAME_QUEUE_SIZE);<br>    <span class=\"hljs-comment\">//æ˜¯å¦ä¿ç•™æœ€åä¸€ä¸ªä½ç½®ï¼Œè§†é¢‘éŸ³é¢‘ä¿ç•™ï¼Œå­—å¹•ä¸ä¿ç•™</span><br>    f-&gt;keep_last = !!keep_last;<br>    <span class=\"hljs-comment\">//ç»™é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„frameåˆå§‹åŒ–</span><br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; f-&gt;max_size; i++)<br>        <span class=\"hljs-keyword\">if</span> (!(f-&gt;<span class=\"hljs-built_in\">queue</span>[i].frame = av_frame_alloc()))<br>            <span class=\"hljs-keyword\">return</span> AVERROR(ENOMEM);<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åˆå§‹åŒ–é˜Ÿåˆ—çš„å†…å­˜ï¼Œåˆ›å»ºé”ï¼Œæ¡ä»¶å˜é‡ï¼Œä¿å­˜pkt queueï¼Œè®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œkeep_lastæ ‡å¿—ä½åˆå§‹åŒ–ã€‚åˆå§‹åŒ–é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç»™é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„frameè°ƒç”¨av_frame_allocåˆ†é…å†…å­˜ã€‚</p>\n<p>å‚æ•°max_sizeç”¨æ¥è®¾ç½®é˜Ÿåˆ—çš„å®¹é‡ï¼Œæœ€å¤§ä¸è¶…è¿‡FRAME_QUEUE_SIZEã€‚å…¶ä¸­è§†é¢‘é˜Ÿåˆ—çš„å®¹é‡ä¸º3ï¼ŒéŸ³é¢‘9ï¼Œå­—å¹•16ã€‚FRAME_QUEUE_SIZEå®šä¹‰å¦‚ä¸‹:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> VIDEO_PICTURE_QUEUE_SIZE 3</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> SUBPICTURE_QUEUE_SIZE 16</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> SAMPLE_QUEUE_SIZE 9</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> FRAME_QUEUE_SIZE FFMAX(SAMPLE_QUEUE_SIZE, FFMAX(VIDEO_PICTURE_QUEUE_SIZE, SUBPICTURE_QUEUE_SIZE))</span><br></code></pre></td></tr></table></figure>\n\n<p>å±•å¼€åFRAME_QUEUE_SIZEçš„å€¼ä¸º16ã€‚</p>\n<p>keep_lastæ˜¯ä¸€ä¸ªboolå€¼ï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨ç¯å½¢ç¼“å†²åŒºçš„è¯»å†™è¿‡ç¨‹ä¸­ä¿ç•™æœ€åä¸€ä¸ªè¯»èŠ‚ç‚¹ä¸è¢«è¦†å†™ã€‚<code>f-&gt;keep_last = !!keep_last;</code>é‡Œçš„åŒæ„Ÿå¹å·æ˜¯Cä¸­çš„ä¸€ç§æŠ€å·§ï¼Œæ—¨åœ¨è®©intå‚æ•°è§„æ•´ä¸º0&#x2F;1çš„â€œboolå€¼â€ã€‚è§†é¢‘å’ŒéŸ³é¢‘ä¼šä¿ç•™æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå­—å¹•ä¸ä¿ç•™ã€‚</p>\n<h3 id=\"é˜Ÿåˆ—é”€æ¯\"><a href=\"#é˜Ÿåˆ—é”€æ¯\" class=\"headerlink\" title=\"é˜Ÿåˆ—é”€æ¯\"></a>é˜Ÿåˆ—é”€æ¯</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">frame_queue_destory</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> i;<br>    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; f-&gt;max_size; i++) &#123;<br>        Frame *vp = &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[i];<br>Â Â Â Â Â Â Â Â <span class=\"hljs-comment\">//å¯¹æ¯ä¸ªèŠ‚ç‚¹è°ƒç”¨frame_queue_unref_item</span><br>        frame_queue_unref_item(vp);<br>Â Â Â Â Â Â Â Â <span class=\"hljs-comment\">//è°ƒç”¨av_frame_freeé‡Šæ”¾frameçš„å†…å­˜</span><br>        av_frame_free(&amp;vp-&gt;frame);<br>    &#125;<br>    SDL_DestroyMutex(f-&gt;mutex);<br>    SDL_DestroyCond(f-&gt;cond);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>è¾ƒä¸ºé‡è¦çš„æ˜¯queueå…ƒç´ çš„é‡Šæ”¾ã€‚åˆ†ä¸¤æ­¥ï¼Œåˆ†åˆ«æ˜¯<code>frame_queue_unref_item</code>å’Œ<code>av_frame_free</code>ã€‚å…¶ä¸­<code>av_frame_free</code>ä¸åˆå§‹åŒ–ä¸­çš„<code>av_frame_alloc</code>å¯¹åº”ï¼Œç”¨äºé‡Šæ”¾AVFrame.</p>\n<p><code>frame_queue_unref_item</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">frame_queue_unref_item</span><span class=\"hljs-params\">(Frame *vp)</span><br>&#123;<br>    av_frame_unref(vp-&gt;frame);<span class=\"hljs-comment\">//å¼•ç”¨è®¡æ•°-1</span><br>    avsubtitle_free(&amp;vp-&gt;sub);<span class=\"hljs-comment\">//subå…³è”çš„å†…å­˜é‡Šæ”¾</span><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>frame_queue_unref_item</code>é‡Šæ”¾çš„å†…å­˜éƒ½æ˜¯<strong>å…³è”</strong>çš„å†…å­˜ï¼Œè€Œéç»“æ„ä½“è‡ªèº«å†…å­˜ã€‚</p>\n<p>AVFrameå†…éƒ¨æœ‰è®¸å¤šçš„AVBufferRefç±»å‹å­—æ®µï¼Œè€ŒAVBufferRefåªæ˜¯AVBufferçš„å¼•ç”¨ï¼ŒAVBufferé€šè¿‡å¼•ç”¨è®¡æ•°è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼ˆç®€æ˜“åƒåœ¾å›æ”¶æœºåˆ¶ï¼‰ã€‚å› æ­¤AVFrameåœ¨ä¸éœ€è¦çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡<code>av_frame_unref</code>å‡å°‘å¼•ç”¨è®¡æ•°ã€‚</p>\n<blockquote>\n<p>å…³äºAVBufferRefçš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š <a href=\"%5B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3FFMPEG-AVBuffer/AVBufferRef/AVBufferPool_muyuyuzhong%E7%9A%84%E4%B8%93%E6%A0%8F-CSDN%E5%8D%9A%E5%AE%A2%5D(https://blog.csdn.net/muyuyuzhong/article/details/79381152)\">æ·±å…¥ç†è§£FFMPEG-AVBuffer&#x2F;AVBufferRef&#x2F;AVBufferPool</a></p>\n</blockquote>\n<h3 id=\"é˜Ÿåˆ—å†™æ“ä½œ\"><a href=\"#é˜Ÿåˆ—å†™æ“ä½œ\" class=\"headerlink\" title=\"é˜Ÿåˆ—å†™æ“ä½œ\"></a>é˜Ÿåˆ—å†™æ“ä½œ</h3><p>FrameQueueçš„â€œå†™â€åˆ†ä¸¤æ­¥ï¼Œå…ˆè°ƒç”¨<code>frame_queue_peek_writable</code>è·å–ä¸€ä¸ªå¯å†™èŠ‚ç‚¹ï¼Œåœ¨å¯¹èŠ‚ç‚¹æ“ä½œç»“æŸåï¼Œè°ƒç”¨<code>frame_queue_push</code>å‘ŠçŸ¥FrameQueueâ€œå­˜å…¥â€è¯¥èŠ‚ç‚¹ã€‚</p>\n<blockquote>\n<p>é˜…è¯»æç¤ºï¼š<br>åœ¨ffplayä¸­ï¼ŒFrameQueueå§‹ç»ˆæ˜¯ä¸€ä¸ªçº¿ç¨‹å†™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»ã€‚ä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªè¯»çº¿ç¨‹ï¼Œä¸ä¼šæœ‰å…¶ä»–è¯»çº¿ç¨‹ç«äº‰è¯»ï¼›åªæœ‰ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹ç«äº‰å†™ï¼›å”¯ä¸€éœ€è¦çš„æ˜¯è¯»ä¸å†™çº¿ç¨‹é—´çš„åŒæ­¥ã€‚FrameQueueçš„æ•´ä¸ªä¼˜åŒ–å’Œè®¾è®¡æ€è·¯æ­£æ˜¯åŸºäºè¿™ä¸€ç‚¹çš„ã€‚</p>\n</blockquote>\n<p>å…ˆçœ‹<code>frame_queue_peek_writable</code>ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_writable</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-comment\">/* wait until we have space to put a new frame */</span><br>    SDL_LockMutex(f-&gt;mutex);<br>    <span class=\"hljs-keyword\">while</span> (f-&gt;size &gt;= f-&gt;max_size &amp;&amp;<br>           !f-&gt;pktq-&gt;abort_request) &#123;<br>        <span class=\"hljs-comment\">//ç­‰å¾…æœ‰ç©ºé—´å¯ä»¥å†™ï¼Œæ‰ç»§ç»­æ‰§è¡Œ</span><br>        SDL_CondWait(f-&gt;cond, f-&gt;mutex);<br>    &#125;<br>    SDL_UnlockMutex(f-&gt;mutex);<br><br>    <span class=\"hljs-keyword\">if</span> (f-&gt;pktq-&gt;abort_request)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;<br>    <span class=\"hljs-comment\">//è¿”å›f-&gt;windexå¯¹åº”çš„frame</span><br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[f-&gt;windex];<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ•´ä¸ªå‡½æ•°åˆ†3æ­¥ï¼š</p>\n<ol>\n<li>åŠ é”æƒ…å†µä¸‹ï¼Œç­‰å¾…ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºä½™ç©ºé—´å¯å†™ï¼ˆ<code>f-&gt;size &lt; f-&gt;max_size</code>ï¼‰</li>\n<li>å¦‚æœæœ‰é€€å‡ºè¯·æ±‚ï¼ˆ<code>f-&gt;pktq-&gt;abort_request</code>ï¼‰ï¼Œåˆ™è¿”å›NULL</li>\n<li>è¿”å›<code>windex</code>ä½ç½®çš„å…ƒç´ ï¼ˆ<code>windex</code>æŒ‡å‘å½“å‰åº”å†™ä½ç½®ï¼‰</li>\n</ol>\n<blockquote>\n<p>ä¸ºä»€ä¹ˆè¿™é‡Œé”çš„èŒƒå›´ä¸æ˜¯æ•´ä¸ªå‡½æ•°å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†å‡å°é”çš„èŒƒå›´ï¼Œä»¥æé«˜æ•ˆç‡ã€‚è€Œä¹‹æ‰€ä»¥å¯ä»¥åœ¨æ— é”çš„æƒ…å†µä¸‹å®‰å…¨è®¿é—®queue å­—æ®µï¼Œæ˜¯å› ä¸ºä¸Šæ–‡ä¸­æåˆ°çš„å•è¯»å•å†™çš„ç‰¹æ®Šåœºæ™¯ã€‚é¦–å…ˆï¼Œqueueæ˜¯ä¸€ä¸ªé¢„å…ˆåˆ†é…å¥½çš„æ•°ç»„ï¼Œå› æ­¤queueæœ¬èº«ä¸å‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥å®‰å…¨è®¿é—®ï¼›æ¥ç€queueå†…çš„å…ƒç´ ï¼Œè¯»å’Œå†™ä¸å­˜åœ¨é‡å ï¼Œå³windexå’Œrindexä¸ä¼šé‡å ã€‚</p>\n<p>å…³äºâ€œè¯»å’Œå†™ä¸å­˜åœ¨é‡å â€ï¼Œä»”ç»†çœ‹çœ‹ã€‚å› ä¸ºqueueæ•°ç»„è¢«å½“åšä¸€ä¸ªç¯å½¢ç¼“å†²åŒºä½¿ç”¨ï¼Œé‚£ä¹ˆçš„ç¡®å­˜åœ¨underrunå’Œoverrunçš„æƒ…å†µï¼Œå³è¯»è¿‡å¿«ï¼Œæˆ–å†™è¿‡å¿«çš„æƒ…å†µï¼Œè¿™æ—¶å¦‚æœä¸åŠ æ§åˆ¶ï¼Œå°±ä¼šå‘ˆç°ç¼“å†²åŒºè¦†ç›–ã€‚</p>\n<p>FrameQueueçš„ç²¾æ˜ä¹‹å¤„åœ¨äºï¼Œå…ˆé€šè¿‡sizeåˆ¤æ–­å½“å‰ç¼“å†²åŒºå†…ç©ºé—´æ˜¯å¦å¤Ÿå†™ï¼Œæˆ–è€…å¤Ÿè¯»ï¼Œæ¯”å¦‚è¿™é‡Œå…ˆé€šè¿‡ä¸€ä¸ªå¾ªç¯çš„æ¡ä»¶ç­‰å¾…ï¼Œåˆ¤æ–­<code>f-&gt;size &gt;= f-&gt;max_size</code>ï¼Œå¦‚æœ<code>f-&gt;size &gt;= f-&gt;max_size</code>ï¼Œé‚£ä¹ˆè¯´æ˜é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å·²ç»å†™æ»¡ï¼Œä¹Ÿå°±æ˜¯å·²ç»overrunäº†ï¼Œæ­¤æ—¶å¦‚æœå†å†™ï¼Œè‚¯å®šä¼šè¦†å†™æœªè¯»æ•°æ®ï¼Œé‚£ä¹ˆå°±éœ€è¦ç»§ç»­ç­‰å¾…ã€‚å½“æ— éœ€ç­‰å¾…æ—¶ï¼ŒwindexæŒ‡å‘çš„å†…å­˜ä¸€å®šæ˜¯å·²ç»è¯»è¿‡çš„ï¼ˆé™¤éä»£ç å¼‚å¸¸äº†ï¼‰ã€‚</p>\n<p>è°ƒç”¨<code>frame_queue_peek_writable</code>å–åˆ°FrameæŒ‡é’ˆåï¼Œå°±å¯ä»¥å¯¹Frameå†…çš„å­—æ®µè‡ªç”±æ”¹å†™ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå†™è¿›ç¨‹ï¼Œä¸”æ— éœ€æ‹…å¿ƒè¯»è¿›ç¨‹è¦†å†™ã€‚å¦‚ä¸Šåˆ†æï¼Œè¯»è¿›ç¨‹è¦è¯»ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¹Ÿä¼šå…ˆåˆ¤æ–­underrunçš„æƒ…å†µï¼‰ã€‚</p>\n</blockquote>\n<p>ä¸€èˆ¬æ­¥éª¤æ˜¯ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\">Frame* vp = frame_queue_peek_writable(q);<br><span class=\"hljs-comment\">//å°†è¦å­˜å‚¨çš„æ•°æ®å†™å…¥frameå­—æ®µï¼Œæ¯”å¦‚ï¼š</span><br>av_frame_move_ref(vp-&gt;frame, src_frame);<br><span class=\"hljs-comment\">//å­˜å…¥é˜Ÿåˆ—</span><br>frame_queue_push(q);<br></code></pre></td></tr></table></figure>\n\n<p><code>frame_queue_push</code>æ€ä¹ˆçŸ¥é“è¦pushçš„æ˜¯è¿™é‡Œçš„vpå‘¢ï¼Ÿ</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">frame_queue_push</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">if</span> (++f-&gt;windex == f-&gt;max_size)<br>        f-&gt;windex = <span class=\"hljs-number\">0</span>;<br>    SDL_LockMutex(f-&gt;mutex);<br>    f-&gt;size++;<br>    SDL_CondSignal(f-&gt;cond);<br>    SDL_UnlockMutex(f-&gt;mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ç­”æ¡ˆæ˜¯pushå½“å‰windexèŠ‚ç‚¹ã€‚çœ‹<code>frame_queue_push</code>å‡½æ•°ï¼Œæ‰§è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š</p>\n<ol>\n<li>windexåŠ 1ï¼Œå¦‚æœè¶…è¿‡max_sizeï¼Œåˆ™å›ç¯ä¸º0</li>\n<li>åŠ é”æƒ…å†µä¸‹å¤§å°åŠ 1.</li>\n</ol>\n<blockquote>\n<p>å› ä¸ºFrameQueueæ˜¯åŸºäºå›ºå®šé•¿åº¦çš„æ•°ç»„å®ç°çš„é˜Ÿåˆ—ï¼Œä¸é“¾è¡¨é˜Ÿåˆ—ä¸åŒï¼Œå…¶èŠ‚ç‚¹åœ¨åˆå§‹åŒ–çš„æ—¶å€™å·²ç»åœ¨é˜Ÿåˆ—ä¸­äº†ï¼Œpushæ‰€è¦åšçš„åªæ˜¯é€šè¿‡æŸç§æ ‡å¿—è®°å½•è¯¥èŠ‚ç‚¹æ˜¯å¦æ˜¯å†™å…¥æœªè¯»çš„ã€‚ffplayçš„åšæ³•æ˜¯å¯¹windexåŠ 1ï¼Œå°†å†™æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå‡¡æ˜¯windexâ€œä¹‹å‰â€çš„èŠ‚ç‚¹ï¼Œéƒ½æ˜¯å†™è¿‡çš„ã€‚ï¼ˆè‡³äºæ˜¯å¦å¯è¯»ï¼ŒrindexçŸ¥é“ï¼›è‡³äºåç»­æœ‰å¤šå°‘ç©ºé—´å¯å†™ï¼ŒsizeçŸ¥é“ï¼‰</p>\n</blockquote>\n<h3 id=\"é˜Ÿåˆ—è¯»æ“ä½œ\"><a href=\"#é˜Ÿåˆ—è¯»æ“ä½œ\" class=\"headerlink\" title=\"é˜Ÿåˆ—è¯»æ“ä½œ\"></a>é˜Ÿåˆ—è¯»æ“ä½œ</h3><p>å’Œå†™ä¸€æ ·ï¼ŒFrameQueueçš„è¯»ä¹Ÿåˆ†ä¸¤æ­¥ã€‚<code>frame_queue_peek_readable</code>å’Œ<code>frame_queue_next</code>ã€‚ç›¸æ¯”å†™è¦å¤æ‚ä¸€ç‚¹çš„æ˜¯ ï¼Œè¯»çš„ä»£ç å¤šè€ƒè™‘å¦ä¸€ä¸ªç‰¹æ€§ï¼Œå³å…è®¸ä¿ç•™ä¸Šä¸€è¯»èŠ‚ç‚¹ã€‚</p>\n<p><code>frame_queue_peek_readable</code>ä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_readable</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-comment\">/* wait until we have a readable a new frame */</span><br>    SDL_LockMutex(f-&gt;mutex);<br>    <span class=\"hljs-keyword\">while</span> (f-&gt;size - f-&gt;rindex_shown &lt;= <span class=\"hljs-number\">0</span> &amp;&amp;<br>           !f-&gt;pktq-&gt;abort_request) &#123;<br>        SDL_CondWait(f-&gt;cond, f-&gt;mutex);<br>    &#125;<br>    SDL_UnlockMutex(f-&gt;mutex);<br><br>    <span class=\"hljs-keyword\">if</span> (f-&gt;pktq-&gt;abort_request)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;<br><br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[(f-&gt;rindex + f-&gt;rindex_shown) % f-&gt;max_size];<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>å’Œ<code>frame_queue_peek_writable</code>ç±»ä¼¼ï¼Œåˆ†ä¸‰æ­¥:</p>\n<ol>\n<li>åŠ é”æƒ…å†µä¸‹ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¯è¯»èŠ‚ç‚¹ï¼ˆ<code>f-&gt;size - f-&gt;rindex_shown &gt; 0</code>)</li>\n<li>å¦‚æœæœ‰é€€å‡ºè¯·æ±‚ï¼Œåˆ™è¿”å›NULL</li>\n<li>è¯»å–å½“å‰å¯è¯»èŠ‚ç‚¹<code>(f-&gt;rindex + f-&gt;rindex_shown) % f-&gt;max_size</code></li>\n</ol>\n<p><code>rindex_shown</code>æœ‰äº›å¹²æ‰°ä»£ç åˆ†æï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸æ”¯æŒkeep_lastçš„æƒ…å†µï¼ˆåªéœ€è¦åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥keep_last &#x3D; 0ï¼‰ï¼Œæ­¤äº‹<code>rindex_shown</code>å§‹ç»ˆä¸º0ï¼Œæ‰€ä»¥ï¼Œ<code>frame_queue_peek_readable</code>ç®€åŒ–å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_readable</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-comment\">/* wait until we have a readable a new frame */</span><br>    SDL_LockMutex(f-&gt;mutex);<br>    <span class=\"hljs-keyword\">while</span> (f-&gt;size &lt;= <span class=\"hljs-number\">0</span> &amp;&amp;<br>           !f-&gt;pktq-&gt;abort_request) &#123;<br>        SDL_CondWait(f-&gt;cond, f-&gt;mutex);<br>    &#125;<br>    SDL_UnlockMutex(f-&gt;mutex);<br><br>    <span class=\"hljs-keyword\">if</span> (f-&gt;pktq-&gt;abort_request)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;<br><br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[f-&gt;rindex];<br>&#125;<br><br></code></pre></td></tr></table></figure>\n\n<p>å’Œpeek_writableå‡ ä¹æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚å°±ä¸åˆ†æäº†ã€‚</p>\n<p>åœ¨ç®€åŒ–ç‰ˆæœ¬ä¸Šç†è§£å¼•å…¥<code>rindex_shown</code>çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£<code>rindex_shown</code>ã€‚<code>rindex_shown</code>çš„æ„æ€æ˜¯<code>rindex</code>æŒ‡å‘çš„èŠ‚ç‚¹æ˜¯å¦è¢«è¯»è¿‡ï¼Œå¦‚æœè¢«è¯»è¿‡ï¼Œ ä¸º1ï¼Œåä¹‹ï¼Œä¸º0ã€‚è¿™ä¸€è¡Œä¸ºï¼Œä½“ç°åœ¨<code>frame_queue_next</code>ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">frame_queue_next</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;   <br>    <span class=\"hljs-comment\">//å¦‚æœæ”¯æŒkeep_lastï¼Œå¹¶ä¸”f-&gt;rindex_shownä¸º0, å°†rindex_shownè®¾ç½®ä¸º1ï¼Œè¿”å›</span><br>    <span class=\"hljs-keyword\">if</span> (f-&gt;keep_last &amp;&amp; !f-&gt;rindex_shown) &#123;<br>        f-&gt;rindex_shown = <span class=\"hljs-number\">1</span>;<br>        <span class=\"hljs-keyword\">return</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//å¦åˆ™ï¼Œç§»åŠ¨rindexæŒ‡é’ˆï¼Œå¹¶å‡å°size</span><br>    frame_queue_unref_item(&amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[f-&gt;rindex]);<br>    <span class=\"hljs-keyword\">if</span> (++f-&gt;rindex == f-&gt;max_size)<br>        f-&gt;rindex = <span class=\"hljs-number\">0</span>;<br>    SDL_LockMutex(f-&gt;mutex);<br>    f-&gt;size--;<br>    SDL_CondSignal(f-&gt;cond);<br>    SDL_UnlockMutex(f-&gt;mutex);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>frame_queue_next</code>ç”¨äºåœ¨è¯»å®Œä¸€ä¸ªèŠ‚ç‚¹åè°ƒç”¨ï¼Œç”¨äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹å·²ç»è¢«è¯»è¿‡ã€‚</p>\n<p>ä¸å†™è¿‡ç¨‹ç±»ä¼¼ï¼Œè¯»è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\">Frame* vp = frame_queue_peek_readable(f);<br><span class=\"hljs-comment\">//è¯»å–vpçš„æ•°æ®ï¼Œæ¯”å¦‚</span><br><span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;pict_type=%d\\n&quot;</span>, vp-&gt;frame-&gt;pict_type);<br>frame_queue_next(f);<br></code></pre></td></tr></table></figure>\n\n<p><code>frame_queue_next</code>æ¯”<code>frame_queue_push</code>ç•¥å¤æ‚ï¼Œæˆ‘ä»¬è¦åˆ†æä¸¤ä¸ªè¡Œä¸ºï¼šæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²è¯»ï¼Œä»¥åŠ<code>rindex_shown</code>çš„èµ‹å€¼ã€‚</p>\n<p>æ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²è¯»äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå·²å†™æ˜¯ç±»ä¼¼çš„ï¼Œæ‰§è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š</p>\n<ol>\n<li>rindexåŠ 1ï¼Œå¦‚æœè¶…è¿‡max_sizeï¼Œåˆ™å›ç¯ä¸º0</li>\n<li>åŠ é”æƒ…å†µä¸‹å¤§å°å‡1.</li>\n</ol>\n<p>ç‰¹åˆ«çš„æ˜¯ï¼Œå¯¹äºä»¥åŠè¯»è¿‡çš„èŠ‚ç‚¹ï¼Œéœ€è¦è°ƒç”¨<code>frame_queue_unref_item</code>é‡Šæ”¾å…³è”å†…å­˜ã€‚</p>\n<p>æ‰§è¡Œrindexæ“ä½œå‰ï¼Œéœ€è¦å…ˆåˆ¤æ–­<code>rindex_shown</code>çš„å€¼ï¼Œå¦‚æœä¸º0ï¼Œåˆ™èµ‹1ã€‚è¿™ä¹ˆåšçš„æ„å›¾ä¸å¦¨ç”»å›¾åˆ†æï¼š</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16473273492201647327349203.png\"></p>\n<p>è¿™é‡Œæ¨¡æ‹Ÿäº†ä»åˆå§‹åŒ–å¼€å§‹çš„2æ¬¡â€œè¯»â€ã€‚</p>\n<p>è¿˜æ²¡å¼€å§‹è¯»ï¼Œrindexå’Œrindex_shownå‡ä¸º0ã€‚è¿™æ—¶è¦peekçš„è¯»èŠ‚ç‚¹æ˜¯èŠ‚ç‚¹0(å›¾ä¸­é»‘è‰²å—ï¼‰ã€‚</p>\n<p>ç¬¬ä¸€æ¬¡è¯»ï¼Œè°ƒç”¨nextï¼Œæ»¡è¶³æ¡ä»¶<code>f-&gt;keep_last &amp;&amp; !f-&gt;rindex_shown</code>ï¼Œæ‰€ä»¥rindexä»ç„¶æ˜¯0ï¼Œè€Œrindex_shownä¸º1.æ­¤æ—¶èŠ‚ç‚¹0ï¼ˆç°è‰²å—ï¼‰æ˜¯å·²è¯»èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯è¦keepçš„lastèŠ‚ç‚¹ï¼Œå°†è¦è¯»çš„èŠ‚ç‚¹æ˜¯èŠ‚ç‚¹1ï¼ˆé»‘è‰²å—ï¼‰ã€‚ï¼ˆæ°å¥½æ˜¯rindex+rindex_shownï¼‰</p>\n<p>ç¬¬äºŒæ¬¡è¯»ï¼Œpeekäº†é»‘è‰²å—åï¼Œè°ƒç”¨nextï¼Œä¸æ»¡è¶³æ¡ä»¶<code>f-&gt;keep_last &amp;&amp; !f-&gt;rindex_shown</code>ï¼Œæ‰€ä»¥rindexä¸º1ï¼Œè€Œrindex_shownä¸º2.æ­¤æ—¶èŠ‚ç‚¹1ï¼ˆç°è‰²å—ï¼‰æ˜¯lastèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹2ï¼ˆé»‘è‰²å—ï¼‰æ˜¯å°†è¦è¯»çš„èŠ‚ç‚¹ã€‚ï¼ˆä¹Ÿæ°å¥½æ˜¯rindex+rindex_shownï¼‰</p>\n<p>ç»§ç»­å¾€ååˆ†æï¼Œä¼šä¸€ç›´é‡å¤ç¬¬äºŒæ¬¡è¯»çš„æƒ…å†µï¼Œå§‹ç»ˆæ˜¯rindexæŒ‡å‘äº†lastï¼Œè€Œrindex_shownä¸€ç›´ä¸º1ï¼Œrindex+rindex_shownåˆšå¥½æ˜¯å°†è¦è¯»çš„èŠ‚ç‚¹ã€‚</p>\n<p>è‡³æ­¤ï¼Œ<code>frame_queue_next</code>çš„è¡Œä¸ºç®—æ˜¯æ˜ç¡®äº†ã€‚å›å¤´çœ‹çœ‹<code>frame_queue_peek_readable</code>ã€‚</p>\n<p>æ­¥éª¤1ä¸­ï¼Œåˆ¤æ–­æ— å¯è¯»èŠ‚ç‚¹ï¼Œç”¨çš„æ˜¯<code>f-&gt;size - f-&gt;rindex_shown &lt;= 0</code>ï¼Œå…¶å®æ˜¯ä»¥ä¸‹ä»£ç çš„ç®€åŒ–ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (f-&gt;rindex_shown)<br>    <span class=\"hljs-keyword\">return</span> f-&gt;size - <span class=\"hljs-number\">1</span>;<br><span class=\"hljs-keyword\">else</span><br>    <span class=\"hljs-keyword\">return</span> f-&gt;size;<br></code></pre></td></tr></table></figure>\n\n<p>åªæ˜¯Cä¸­ç”¨intæ¨¡æ‹Ÿboolï¼Œåˆšå¥½rindex_shownä¸ºtrueæ˜¯1ï¼Œæ‰€ä»¥å¯ä»¥ç®€åŒ–ä¸º<code>`f-&gt;size - f-&gt;rindex_shown</code>.</p>\n<p>æ­¥éª¤3ä¸­ï¼Œå–å°†è¦è¯»çš„èŠ‚ç‚¹ç”¨çš„æ˜¯<code>(f-&gt;rindex + f-&gt;rindex_shown) % f-&gt;max_size</code>ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªç®€åŒ–ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//è¿™æ®µä»£ç æ ¹æ®ä¸Šå›¾å¾ˆå®¹æ˜“æ¨å¯¼</span><br><span class=\"hljs-keyword\">if</span> (f-&gt;rindex_shown)<br>    <span class=\"hljs-keyword\">return</span> (f-&gt;rindex + <span class=\"hljs-number\">1</span>) % f-&gt;max_size; <span class=\"hljs-comment\">//å› ä¸ºrindexåŠ 1åå¯èƒ½è¶…è¿‡max_sizeï¼Œæ‰€ä»¥è¿™é‡Œå–ä½™</span><br><span class=\"hljs-keyword\">else</span><br>    <span class=\"hljs-keyword\">return</span> f-&gt;rindex;<br></code></pre></td></tr></table></figure>\n\n<p>ä»¥ä¸Šï¼ŒFrameQueueçš„è¯»è¿‡ç¨‹ä¹Ÿåˆ†æå®Œäº†ã€‚</p>\n<p>ä¸ºäº†æ”¯æŒçµæ´»åœ°è¯»ï¼Œè¿˜æœ‰ä¸€äº›è¾…åŠ©å‡½æ•°ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//è¯»å½“å‰èŠ‚ç‚¹ï¼ˆä¸Šæ–‡ä¸­çš„ç”¨è¯æ˜¯â€œå°†è¦è¯»çš„èŠ‚ç‚¹â€ï¼Œä¹Ÿå°±æ˜¯é»‘è‰²å—ï¼‰ï¼Œä¸frame_queue_peek_readableç­‰æ•ˆï¼Œä½†æ²¡æœ‰æ£€æŸ¥æ˜¯å¦æœ‰å¯è¯»èŠ‚ç‚¹</span><br><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[(f-&gt;rindex + f-&gt;rindex_shown) % f-&gt;max_size];<br>&#125;<br><br><span class=\"hljs-comment\">//è¯»ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_next</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[(f-&gt;rindex + f-&gt;rindex_shown + <span class=\"hljs-number\">1</span>) % f-&gt;max_size];<br>&#125;<br><br><span class=\"hljs-comment\">//è¯»ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span><br><span class=\"hljs-type\">static</span> Frame *<span class=\"hljs-title function_\">frame_queue_peek_last</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">return</span> &amp;f-&gt;<span class=\"hljs-built_in\">queue</span>[f-&gt;rindex];<br>&#125;<br><br><span class=\"hljs-comment\">/* return the number of undisplayed frames in the queue */</span><br><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">frame_queue_nb_remaining</span><span class=\"hljs-params\">(FrameQueue *f)</span><br>&#123;<br>    <span class=\"hljs-keyword\">return</span> f-&gt;size - f-&gt;rindex_shown;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>å®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œå€ŸåŠ©ä¸Šå›¾çœ‹ä¸‹èŠ‚ç‚¹ä½ç½®ï¼š</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16473274840541647327483583.png\"></p>\n<p>è‡³æ­¤ï¼ŒFrameQueueçš„ä¸»ä½“åŠŸèƒ½åˆ†æå®Œäº†ã€‚ä»æºç ä¸­å¯ä»¥çœ‹åˆ°FrameQueueæ˜¯é’ˆå¯¹å•è¯»å•å†™ä¼˜åŒ–çš„é«˜æ•ˆçš„å¤šçº¿ç¨‹æ¨¡å‹ï¼Œå…¶è®¾è®¡æ€è·¯ä¸å¤±ä¸ºåœ¨Cè¯­è¨€å®è·µä¸­å¯å€Ÿé‰´çš„ä¸€ä¸ªå¥½ä¾‹å­ã€‚</p>\n"},{"layout":"post","title":"ffplay read_thread åˆ†æ","date":"2022-03-19T16:00:00.000Z","_content":"\n\nå‚è€ƒï¼š [ffplay readçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/43672062)\n\n> ffplay main å‡½æ•° åšäº†ä»€ä¹ˆ\n\n1. å‚æ•°éªŒè¯ä¸è§£æ\n\n2. æ³¨å†Œcodecsï¼Œ demuxï¼Œ protocols\n\n3. sdl åˆå§‹åŒ–ï¼Œåˆ›å»ºçª—å£\n\n4. è°ƒç”¨stream_openæ‰“å¼€æµ\n\n5. è°ƒç”¨event_loopè¿›å…¥è¿è¡Œå¾ªç¯\n\n> stream_open åšäº†ä»€ä¹ˆ\n\nÂ Â Â Â ä¸»è¦æ˜¯åˆå§‹åŒ–VideoState *isï¼Œå¡«å……å…³é”®ä¿¡æ¯\n\n1. åˆå§‹åŒ–ï¼Œåˆ†é…å†…å­˜`is = av_mallocz(sizeof(VideoState));`\n\n2. è°ƒç”¨frame_queue_initç»™VideoStateå¯¹åº”çš„éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”Frameé˜Ÿåˆ—åˆå§‹åŒ–åˆ†é…å†…å­˜\n\n3. è°ƒç”¨packet_queue_initç»™VideoStateå¯¹åº”çš„éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”Packeté˜Ÿåˆ—åˆå§‹åŒ–åˆ†é…å†…å­˜\n\n4. åˆ›å»ºæ¡ä»¶å˜é‡continue_read_threadï¼Œ ç”¨äºæ§åˆ¶æ˜¯å¦ç»§ç»­è¯»å–æˆ–è€…ç­‰å¾…\n\n5. è°ƒç”¨init_clock åˆå§‹åŒ–éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå¤–éƒ¨æ—¶é’Ÿ\n\n6. è®¾ç½®åŒæ­¥ç±»å‹av_sync_type\n\n7. åˆ›å»ºå¹¶å¼€å¯read_thread\n\n## read_thread\n\nåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š\n\n1. å‡†å¤‡é˜¶æ®µ\n\n2. å¾ªç¯è¯»pkt\n\nå‡†å¤‡é˜¶æ®µï¼š\n\nstream_open å¯¹VideoState *is åšäº†åˆå§‹åŒ–å…³é”®å‚æ•°çš„å¡«å……ã€‚read_thread åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæ‰“å¼€è¾“å…¥çš„æµï¼Œè§£å°è£…ï¼Œè¯»å–æµçš„ä¿¡æ¯ï¼Œæ‰¾åˆ°éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”çš„streamï¼Œè¯»å–è§£ç å‚æ•°ï¼Œåˆ›å»ºè§£ç å™¨ï¼Œå¼€å¯è§£ç å™¨ã€‚åˆ†åˆ«ä¸ºéŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¼€å¯åˆ›å»ºè§£ç çº¿ç¨‹ã€‚\n\nå¾ªç¯è¯»pktï¼š\n\nç„¶åè¿›å…¥å¾ªç¯ï¼Œä»æµä¸­è¯»å–pktï¼Œæ ¹æ®åŒæ­¥æ—¶é’Ÿï¼Œæ”¾å…¥pkté˜Ÿåˆ—æˆ–è€…ä¸¢å¼ƒã€‚å¦‚æœè¯»ç»“æŸï¼Œç»™pkté˜Ÿåˆ—æ”¾å…¥ç©ºåŒ…ï¼Œç”¨äºå†²æ´—è§£ç å™¨ã€‚\n\nå¾ªç¯ä¸­è¿˜è¦å¤„ç†ç»ˆæ­¢æš‚åœæ¢å¤äº‹ä»¶ï¼Œseekäº‹ä»¶ï¼Œæ ¹æ®é˜Ÿåˆ—çš„çŠ¶æ€ï¼ˆæ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®ï¼‰æ§åˆ¶ç­‰å¾…è¿˜æ˜¯ç»§ç»­è¯»å–æ–°çš„pktã€‚\n\n### å‡†å¤‡é˜¶æ®µ\n\næ‰“å¼€æ–‡ä»¶ï¼Œè§£å°è£…ï¼Œè·å–æ–‡ä»¶ä¿¡æ¯\n\n```c\nVideoState *is = arg;\nAVFormatContext *ic = NULL;\n//åˆ›å»ºAVFormatContext\nic = avformat_alloc_context();\n//interrupt_callbackç”¨äºffmpegå†…éƒ¨åœ¨æ‰§è¡Œè€—æ—¶æ“ä½œæ—¶æ£€æŸ¥æ˜¯å¦æœ‰é€€å‡ºè¯·æ±‚ï¼Œå¹¶æå‰ä¸­æ–­ï¼Œé¿å…ç”¨æˆ·é€€å‡ºè¯·æ±‚æ²¡æœ‰åŠæ—¶å“åº”\nic->interrupt_callback.callback = decode_interrupt_cb;\nic->interrupt_callback.opaque = is;\n//ç‰¹å®šé€‰é¡¹å¤„ç†\nif (!av_dict_get(format_opts, \"scan_all_pmts\", NULL, AV_DICT_MATCH_CASE)) {\n    av_dict_set(&format_opts, \"scan_all_pmts\", \"1\", AV_DICT_DONT_OVERWRITE);\n    scan_all_pmts_set = 1;\n}\n//æ‰“å¼€è¾“å…¥çš„æµï¼Œè¯»å–æµçš„å¤´éƒ¨ä¿¡æ¯\nerr = avformat_open_input(&ic, is->filename, is->iformat, &format_opts);\n//ä¿å­˜AVFormatContext\nis->ic = ic;\nif (find_stream_info) {\n    //å¦‚æœæ–‡ä»¶ä¸åŒ…å«å¤´éƒ¨ä¿¡æ¯(å¦‚ts)ï¼Œé€šè¿‡è¯»å–ä¸€æ®µæ–‡ä»¶åˆ†æåå¾—åˆ°æµä¿¡æ¯\n    err = avformat_find_stream_info(ic, opts);\n}\n```\n\nåˆ¤æ–­æ˜¯å¦æ˜¯å®æ—¶æµ\n\n```c\n//æ˜¯å¦æ˜¯å®æ—¶æµrtp/rtsp/sdpç­‰\nis->realtime = is_realtime(ic);\n```\n\nis_realtime å‡½æ•°\n\n```c\nstatic int is_realtime(AVFormatContext *s)\n{\n    if(   !strcmp(s->iformat->name, \"rtp\")\n       || !strcmp(s->iformat->name, \"rtsp\")\n       || !strcmp(s->iformat->name, \"sdp\")\n    )\n        return 1;\n\n    if(s->pb && (   !strncmp(s->url, \"rtp:\", 4)\n                 || !strncmp(s->url, \"udp:\", 4)\n                )\n    )\n        return 1;\n    return 0;\n}\n```\n\né€‰æ‹©éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•æµã€‚å®é™…æ“ä½œä¸­ï¼Œé€‰æ‹©çš„ç­–ç•¥å¾ˆå¤šï¼Œä¸€èˆ¬æ ¹æ®å…·ä½“éœ€æ±‚æ¥å®šâ€”â€”æ¯”å¦‚å¯ä»¥æ˜¯é€‰æ‹©æœ€é«˜æ¸…çš„è§†é¢‘æµï¼›é€‰æ‹©æœ¬åœ°è¯­è¨€çš„éŸ³é¢‘æµï¼›ç›´æ¥é€‰æ‹©ç¬¬ä¸€æ¡è§†é¢‘ã€éŸ³é¢‘è½¨é“ï¼›ç­‰ç­‰ã€‚\n\nffplayä¸»è¦æ˜¯é€šè¿‡`av_find_best_stream`æ¥é€‰æ‹©ï¼š\n\n```c\n    //å¦‚æœç”¨æˆ·é€šè¿‡wanted_stream_specæŒ‡å®šäº†æµï¼Œæ‰¾åˆ°ç”¨æˆ·é€‰æ‹©çš„æµ\n    for (i = 0; i < ic->nb_streams; i++) {\n        AVStream *st = ic->streams[i];\n        enum AVMediaType type = st->codecpar->codec_type;\n        st->discard = AVDISCARD_ALL;\n        if (type >= 0 && wanted_stream_spec[type] && st_index[type] == -1)\n            if (avformat_match_stream_specifier(ic, st, wanted_stream_spec[type]) > 0)\n                st_index[type] = i;\n    }\n    for (i = 0; i < AVMEDIA_TYPE_NB; i++) {\n        if (wanted_stream_spec[i] && st_index[i] == -1) {\n            //å¤„ç†æ‰¾ä¸åˆ°ç”¨æˆ·é€‰æ‹©çš„æµçš„æƒ…å†µ\n            av_log(NULL, AV_LOG_ERROR, \"Stream specifier %s does not match any %s stream\\n\", wanted_stream_spec[i], av_get_media_type_string(i));\n            st_index[i] = INT_MAX;\n        }\n    }\n\n    //è·å–video stream\n    if (!video_disable)\n        st_index[AVMEDIA_TYPE_VIDEO] =\n            av_find_best_stream(ic, AVMEDIA_TYPE_VIDEO,\n                                st_index[AVMEDIA_TYPE_VIDEO], -1, NULL, 0);\n    //è·å–audio streamï¼Œå‚è€ƒè§†é¢‘æµé€‰æ‹©\n    if (!audio_disable)\n        st_index[AVMEDIA_TYPE_AUDIO] =\n            av_find_best_stream(ic, AVMEDIA_TYPE_AUDIO,\n                                st_index[AVMEDIA_TYPE_AUDIO],\n                                st_index[AVMEDIA_TYPE_VIDEO],\n                                NULL, 0);\n    //è·å–subtitle streamï¼Œä¼˜å…ˆå‚è€ƒéŸ³é¢‘æµ\n    if (!video_disable && !subtitle_disable)\n        st_index[AVMEDIA_TYPE_SUBTITLE] =\n            av_find_best_stream(ic, AVMEDIA_TYPE_SUBTITLE,\n                                st_index[AVMEDIA_TYPE_SUBTITLE],\n                                (st_index[AVMEDIA_TYPE_AUDIO] >= 0 ?\n                                 st_index[AVMEDIA_TYPE_AUDIO] :\n                                 st_index[AVMEDIA_TYPE_VIDEO]),\n                                NULL, 0);\n```\n\nwanted_stream_specé€šè¿‡mainå‡½æ•°ä¼ å‚è®¾å®šï¼Œæ ¼å¼å¯ä»¥æœ‰å¾ˆå¤šç§ï¼Œå‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://www.ffmpeg.org/ffplay.html#Stream-specifiers-1)\n\nå¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šæµï¼Œæˆ–æŒ‡å®šéƒ¨åˆ†æµï¼Œæˆ–æŒ‡å®šæµä¸å­˜åœ¨ï¼Œåˆ™ä¸»è¦ç”±av_find_best_streamå‘æŒ¥ä½œç”¨ã€‚\n\n```c\nint av_find_best_stream(AVFormatContext *ic,\n                        enum AVMediaType type,//è¦é€‰æ‹©çš„æµç±»å‹\n                        int wanted_stream_nb,//ç›®æ ‡æµç´¢å¼•\n                        int related_stream,//å‚è€ƒæµç´¢å¼•\n                        AVCodec **decoder_ret,\n                        int flags);\n```\n\nå¦‚æœæŒ‡å®šäº†æ­£ç¡®çš„wanted_stream_nbï¼Œä¸€èˆ¬æƒ…å†µéƒ½æ˜¯ç›´æ¥è¿”å›è¯¥æŒ‡å®šæµï¼Œå³ç”¨æˆ·é€‰æ‹©çš„æµã€‚å¦‚æœæŒ‡å®šäº†å‚è€ƒæµï¼Œä¸”æœªæŒ‡å®šç›®æ ‡æµçš„æƒ…å†µï¼Œä¼šæ ¹æ®å‚è€ƒæµå»æŸ¥æ‰¾æ‰€éœ€ç±»å‹çš„æµï¼Œä½†ä¸€èˆ¬ç»“æœï¼Œéƒ½æ˜¯è¿”å›è¯¥ç±»å‹ç¬¬ä¸€ä¸ªæµã€‚\n\nå·²ç»è·å–äº†æµä¿¡æ¯ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯åˆ›å»ºè§£ç å™¨ï¼Œå¼€å¯è§£ç çº¿ç¨‹ã€‚ \n\nä¸»è¦åœ¨`stream_component_open`æ–¹æ³•ä¸­å®ç°, ç®€åŒ–ä»£ç å¦‚ä¸‹\n\n```c\nstatic int stream_component_open(VideoState *is, int stream_index)\n{\n    //åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡\n    avctx = avcodec_alloc_context3(NULL);        \n    //å¡«å……è§£ç å‚æ•°\n    ret = avcodec_parameters_to_context(avctx, ic->streams[stream_index]->codecpar);\n    //è®¾ç½®è§£ç å™¨çš„æ—¶é—´åŸºï¼Œç­‰äºstreamçš„æ—¶é—´åŸº\n    avctx->pkt_timebase = ic->streams[stream_index]->time_base;\n    //æ‰¾è§£ç å™¨\n    codec = avcodec_find_decoder(avctx->codec_id);\n    if (forced_codec_name)\n        //å¦‚æœç”¨æˆ·æŒ‡å®šäº†è§£ç å™¨ï¼Œä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„è§£ç å™¨\n        codec = avcodec_find_decoder_by_name(forced_codec_name);\n    //æ‰“å¼€è§£ç å™¨\n    if ((ret = avcodec_open2(avctx, codec, &opts)) < 0) {\n        goto fail;\n    }\n    switch (avctx->codec_type) {\n    case AVMEDIA_TYPE_AUDIO:\n        //æ‰“å¼€éŸ³é¢‘æ’­æ”¾å™¨\n        if ((ret = audio_open(is, channel_layout, nb_channels, sample_rate, &is->audio_tgt)) < 0)\n            goto fail;\n        //ç»™is->auddecåˆå§‹åŒ–\n        if ((ret = decoder_init(&is->auddec, avctx, &is->audioq, is->continue_read_thread)) < 0)\n            goto fail;\n        //å¼€å¯éŸ³é¢‘è§£ç çº¿ç¨‹\n        if ((ret = decoder_start(&is->auddec, audio_thread, \"audio_decoder\", is)) < 0)\n            goto out;\n        //æš‚åœéŸ³é¢‘æ’­æ”¾å™¨\n        SDL_PauseAudioDevice(audio_dev, 0);\n        break;\n    case AVMEDIA_TYPE_VIDEO:\n        is->video_stream = stream_index;\n        is->video_st = ic->streams[stream_index];\n        //ç»™is->viddecåˆå§‹åŒ–\n        if ((ret = decoder_init(&is->viddec, avctx, &is->videoq, is->continue_read_thread)) < 0)\n            goto fail;\n        //å¼€å¯è§†é¢‘è§£ç çº¿ç¨‹\n        if ((ret = decoder_start(&is->viddec, video_thread, \"video_decoder\", is)) < 0)\n            goto out;\n        is->queue_attachments_req = 1;\n        break;\n    case AVMEDIA_TYPE_SUBTITLE:\n        is->subtitle_stream = stream_index;\n        is->subtitle_st = ic->streams[stream_index];\n        //åˆå§‹åŒ–å­—å¹•è§£ç \n        if ((ret = decoder_init(&is->subdec, avctx, &is->subtitleq, is->continue_read_thread)) < 0)\n            goto fail;\n        //å¼€å¯å­—å¹•è§£ç çº¿ç¨‹\n        if ((ret = decoder_start(&is->subdec, subtitle_thread, \"subtitle_decoder\", is)) < 0)\n            goto out;\n        break;\n    }\n    //....\n    return ret;\n}\n```\n\né’ˆå¯¹éŸ³é¢‘ï¼Œéœ€è¦å¦å¤–å¤„ç†éŸ³é¢‘æ’­æ”¾å™¨çš„åˆå§‹åŒ–ï¼Œæš‚åœçŠ¶æ€ã€‚\n\nå¯¹éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•ï¼Œè°ƒç”¨`decoder_init`åˆå§‹åŒ–Decoderï¼Œ è°ƒç”¨`decoder_start`å¼€å¯å¯¹åº”çš„è§£ç çº¿ç¨‹ã€‚\n\ndecoder_init\n\n```\nstatic int decoder_init(Decoder *d, AVCodecContext *avctx, PacketQueue *queue, SDL_cond *empty_queue_cond) {\n    memset(d, 0, sizeof(Decoder));\n    d->pkt = av_packet_alloc();\n    if (!d->pkt)\n        return AVERROR(ENOMEM);\n    d->avctx = avctx;\n    d->queue = queue;\n    d->empty_queue_cond = empty_queue_cond;\n    d->start_pts = AV_NOPTS_VALUE;\n    d->pkt_serial = -1;\n    return 0;\n}\n```\n\ndecoder_start\n\n```\nstatic int decoder_start(Decoder *d, int (*fn)(void *), const char *thread_name, void* arg)\n{\n    //å¼€å¯packet queue\n    packet_queue_start(d->queue);\n    //å¼€å¯è§£ç çº¿ç¨‹\n    d->decoder_tid = SDL_CreateThread(fn, thread_name, arg);\n    if (!d->decoder_tid) {\n        av_log(NULL, AV_LOG_ERROR, \"SDL_CreateThread(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    return 0;\n}\n```\n\n### ä¸»å¾ªç¯è¯»åŒ…\n\nç®€åŒ–ä¸€ä¸‹å¦‚ä¸‹\n\n```\nfor (;;) {\n        if (is->abort_request)\n            break;//å¤„ç†é€€å‡ºæ¶ˆæ¯\n        if (is->paused != is->last_paused) {\n            //å¤„ç†æš‚åœä¸æ¢å¤\n            //.......\n        }\n\n        if (is->seek_req) {\n            //å¤„ç†seekæ“ä½œ\n            ret = avformat_seek_file(is->ic, -1, seek_min, seek_target, seek_max, is->seek_flags);\n        }\n        /*\n        æ§åˆ¶é˜Ÿåˆ—å¤§å°\n        */\n        if (infinite_buffer<1 &&\n              (is->audioq.size + is->videoq.size + is->subtitleq.size > MAX_QUEUE_SIZE\n            || (stream_has_enough_packets(is->audio_st, is->audio_stream, &is->audioq) &&\n                stream_has_enough_packets(is->video_st, is->video_stream, &is->videoq) &&\n                stream_has_enough_packets(is->subtitle_st, is->subtitle_stream, &is->subtitleq)))) {\n            /* wait 10 ms */\n            SDL_LockMutex(wait_mutex);\n            SDL_CondWaitTimeout(is->continue_read_thread, wait_mutex, 10);\n            SDL_UnlockMutex(wait_mutex);\n            continue;\n        }\n        //å¤„ç†å¾ªç¯æ’­æ”¾\n        if (!is->paused &&\n            (!is->audio_st || (is->auddec.finished == is->audioq.serial && frame_queue_nb_remaining(&is->sampq) == 0)) &&\n            (!is->video_st || (is->viddec.finished == is->videoq.serial && frame_queue_nb_remaining(&is->pictq) == 0))) {\n            if (loop != 1 && (!loop || --loop)) {\n                stream_seek(is, start_time != AV_NOPTS_VALUE ? start_time : 0, 0, 0);\n            } else if (autoexit) {\n                ret = AVERROR_EOF;\n                goto fail;\n            }\n        }\n        //è¯»pkt\n        ret = av_read_frame(ic, pkt);\n\n        //åœ¨æ’­æ”¾åŒºé—´ï¼Œæ”¾å…¥é˜Ÿåˆ—\n        packet_queue_put(&is->videoq, pkt);\n        //ä¸åœ¨æ’­æ”¾åŒºé—´ï¼Œä¸¢å¼ƒ\n        av_packet_unref(pkt);\n\n    }\n```\n\nä¸»è¦çš„ä»£ç å°±`av_read_frame`å’Œ`packet_queue_put`ï¼Œ`av_read_frame`ä»æ–‡ä»¶ä¸­è¯»å–è§†é¢‘æ•°æ®ï¼Œå¹¶è·å–ä¸€ä¸ªAVPacketï¼Œ`packet_queue_put`æŠŠå®ƒæ”¾å…¥åˆ°å¯¹åº”çš„PacketQueueä¸­ã€‚\n\nå½“ç„¶ï¼Œè¯»å–è¿‡ç¨‹è¿˜ä¼šæœ‰seekã€pauseã€resumeã€abortç­‰äº‹ä»¶ï¼Œæ‰€ä»¥æœ‰ä¸“é—¨çš„åˆ†æ”¯å¤„ç†è¿™äº›è¯·æ±‚ã€‚\n\nPacketQueueé»˜è®¤æƒ…å†µä¸‹ä¼šæœ‰å¤§å°é™åˆ¶ï¼Œè¾¾åˆ°è¿™ä¸ªå¤§å°åï¼Œå°±éœ€è¦ç­‰å¾…10msï¼Œä»¥è®©æ¶ˆè´¹è€…â€”â€”è§£ç çº¿ç¨‹èƒ½æœ‰æ—¶é—´æ¶ˆè€—ã€‚\n\næ’­æ”¾å®Œæˆåï¼Œä¼šæ ¹æ®loopçš„è®¾ç½®å†³å®šæ˜¯å¦å¾ªç¯ã€‚\n\næš‚åœ/æ¢å¤çš„å¤„ç†ï¼š\n\n```c\nif (is->paused != is->last_paused) {\n    //æ›´æ–°pausedçŠ¶æ€\n    is->last_paused = is->paused;\n    if (is->paused)\n        //æš‚åœ\n        is->read_pause_return = av_read_pause(ic);\n    else\n        //æ¢å¤æ’­æ”¾\n        av_read_play(ic);\n}\n```\n\nffmpegæœ‰ä¸“é—¨é’ˆå¯¹æš‚åœå’Œæ¢å¤çš„å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨å°±å¯ä»¥äº†ã€‚\n\n> av_read_pauseå’Œav_read_playå¯¹äºURLProtocolï¼Œä¼šè°ƒç”¨å…¶url_read_pauseï¼Œé€šè¿‡å‚æ•°åŒºåˆ†æ˜¯è¦æš‚åœè¿˜æ˜¯æ¢å¤ã€‚å¯¹äºAVInputFormatä¼šè°ƒç”¨å…¶read_pauseå’Œread_play.  \n> ä¸€èˆ¬æƒ…å†µä¸‹URLProtocolå’ŒAVInputFormatéƒ½ä¸éœ€è¦ä¸“é—¨å¤„ç†æš‚åœå’Œæ¢å¤ï¼Œä½†å¯¹äºåƒrtsp/rtmpè¿™ç§åœ¨é€šè®¯åè®®ä¸Šæ”¯æŒ(éœ€è¦)æš‚åœã€æ¢å¤çš„å°±ç‰¹åˆ«æœ‰ç”¨äº†ã€‚\n\nå¯¹äºseekçš„å¤„ç†ï¼Œä¼šæ¯”æš‚åœ/æ¢å¤ç•¥å¾®å¤æ‚ä¸€äº›ï¼š\n\n```c\nif (is->seek_req) {\n    //å¤„ç†seekæ“ä½œ\n    int64_t seek_target = is->seek_pos;\n    int64_t seek_min    = is->seek_rel > 0 ? seek_target - is->seek_rel + 2: INT64_MIN;\n    int64_t seek_max    = is->seek_rel < 0 ? seek_target - is->seek_rel - 2: INT64_MAX;\n// FIXME the +-2 is due to rounding being not done in the correct direction in generation\n//      of the seek_pos/seek_rel variables\n    //seekåˆ°æ­£ç¡®çš„ä½ç½®\n    ret = avformat_seek_file(is->ic, -1, seek_min, seek_target, seek_max, is->seek_flags);\n    if (ret < 0) {\n        av_log(NULL, AV_LOG_ERROR,\n               \"%s: error while seeking\\n\", is->ic->url);\n    } else {\n        if (is->audio_stream >= 0)\n            //æ¸…ç©ºéŸ³é¢‘å¸§é˜Ÿåˆ—\n            packet_queue_flush(&is->audioq);\n        if (is->subtitle_stream >= 0)\n            //æ¸…ç©ºå­—å¹•å¸§é˜Ÿåˆ—\n            packet_queue_flush(&is->subtitleq);\n        if (is->video_stream >= 0)\n            //æ¸…ç©ºè§†é¢‘å¸§é˜Ÿåˆ—\n            packet_queue_flush(&is->videoq);\n        //æ›´æ–°clock\n        if (is->seek_flags & AVSEEK_FLAG_BYTE) {\n           set_clock(&is->extclk, NAN, 0);\n        } else {\n           set_clock(&is->extclk, seek_target / (double)AV_TIME_BASE, 0);\n        }\n    }\n    is->seek_req = 0;\n    is->queue_attachments_req = 1;\n    is->eof = 0;\n    if (is->paused)\n        step_to_next_frame(is);\n}\n```\n\nä¸»è¦çš„seekæ“ä½œé€šè¿‡avformat_seek_fileå®Œæˆã€‚æ ¹æ®avformat_seek_fileçš„è¿”å›å€¼ï¼Œå¦‚æœseekæˆåŠŸï¼Œéœ€è¦ï¼š\n\n1. æ¸…é™¤PacketQueueçš„ç¼“å­˜ï¼Œå¹¶æ”¾å…¥ä¸€ä¸ªflush_pktã€‚æ”¾å…¥çš„flush_pktå¯ä»¥è®©PacketQueueçš„serialå¢1ï¼Œä»¥åŒºåˆ†seekå‰åçš„æ•°æ®\n2. åŒæ­¥å¤–éƒ¨æ—¶é’Ÿã€‚åœ¨åç»­éŸ³è§†é¢‘åŒæ­¥çš„æ–‡ç« ä¸­å†å…·ä½“åˆ†æã€‚\n\næœ€åæ¸…ç†ä¸€äº›å˜é‡ï¼Œå¹¶ï¼š\n\n1. è®¾ç½®queue_attachments_reqä»¥æ˜¾ç¤ºattachmentç”»é¢\n2. å¦‚æœå½“å‰æ˜¯æš‚åœçŠ¶æ€ï¼Œå°±è·³åˆ°seekåçš„ä¸‹ä¸€å¸§ï¼Œä»¥ç›´è§‚ä½“ç°seekæˆåŠŸäº†\n\nstep_to_next_frame\n\n```\nstatic void step_to_next_frame(VideoState *is)\n{\n    /* if the stream is paused unpause it, then step */\n    if (is->paused)\n        stream_toggle_pause(is);\n    is->step = 1;\n}\n```\n\nåŸä»£ç çš„æ³¨é‡Šæ¯”è¾ƒæ¸…æ™°äº†â€”â€”å…ˆå–æ¶ˆæš‚åœï¼Œç„¶åæ‰§è¡Œstepã€‚å½“è®¾ç½®stepä¸º1åï¼Œæ˜¾ç¤ºçº¿ç¨‹ä¼šæ˜¾ç¤ºå‡ºä¸€å¸§ç”»é¢ï¼Œç„¶åå†æ¬¡è¿›å…¥æš‚åœï¼š\n\n```\n//in video_refresh\nif (is->step && !is->paused)\n    stream_toggle_pause(is);\n```\n\nè¿™æ ·seekçš„å¤„ç†å°±å®Œæˆäº†ã€‚\n\nå‰é¢seekã€æš‚åœã€æ¢å¤éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨ffmpegçš„å‡½æ•°ï¼Œè¾…åŠ©ä¸€äº›æµç¨‹æ§åˆ¶å®Œæˆå°è£…ã€‚\n\nè€Œè¯»å–ç¼“å†²åŒºçš„æ§åˆ¶å¯ä»¥è¯´æ˜¯ffplayåŸç”Ÿçš„ç‰¹æ€§äº†ã€‚\n\næ˜¯å¦éœ€è¦æ§åˆ¶ç¼“å†²åŒºå¤§å°ç”±å˜é‡infinite_bufferå†³å®šã€‚infinite_bufferä¸º1è¡¨ç¤ºå½“å‰bufferæ— é™å¤§ï¼Œä¸éœ€è¦ä½¿ç”¨ç¼“å†²åŒºé™åˆ¶ç­–ç•¥ã€‚\n\ninfinite_bufferæ˜¯å¯é€‰é€‰é¡¹ï¼Œä½†åœ¨æ–‡ä»¶æ˜¯å®æ—¶åè®®æ—¶ï¼Œä¸”ç”¨æˆ·æœªæŒ‡å®šæ—¶ï¼Œè¿™ä¸ªå€¼ä¼šè¢«å¼ºåˆ¶ä¸º1ï¼š\n\n```c\nstatic int is_realtime(AVFormatContext *s)\n{\n    if(   !strcmp(s->iformat->name, \"rtp\")\n       || !strcmp(s->iformat->name, \"rtsp\")\n       || !strcmp(s->iformat->name, \"sdp\")\n    )\n        return 1;\n\n    if(s->pb && (   !strncmp(s->url, \"rtp:\", 4)\n                 || !strncmp(s->url, \"udp:\", 4)\n                )\n    )\n        return 1;\n    return 0;\n}\n\nâ€¦â€¦\nis->realtime = is_realtime(ic);\nâ€¦â€¦\nif (infinite_buffer < 0 && is->realtime)\n    infinite_buffer = 1;\n```\n\næˆ‘ä»¬çœ‹ä¸‹éœ€æ§åˆ¶ç¼“å†²åŒºå¤§å°çš„æƒ…å†µï¼š\n\n```c\nif (infinite_buffer<1 &&\n    (is->audioq.size + is->videoq.size + is->subtitleq.size > MAX_QUEUE_SIZE\n    || (stream_has_enough_packets(is->audio_st, is->audio_stream, &is->audioq) &&\n        stream_has_enough_packets(is->video_st, is->video_stream, &is->videoq) &&\n        stream_has_enough_packets(is->subtitle_st, is->subtitle_stream, &is->subtitleq)))) {\n    /* wait 10 ms */\n    SDL_LockMutex(wait_mutex);\n    SDL_CondWaitTimeout(is->continue_read_thread, wait_mutex, 10);\n    SDL_UnlockMutex(wait_mutex);\n    continue;\n}\n```\n\nç¼“å†²åŒºæ»¡æœ‰ä¸¤ç§å¯èƒ½ï¼š\n\n1. audioqï¼Œvideoqï¼Œsubtitleqä¸‰ä¸ªPacketQueueçš„æ€»å­—èŠ‚æ•°è¾¾åˆ°äº†MAX_QUEUE_SIZEï¼ˆ15Mï¼‰\n2. éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•æµéƒ½å·²æœ‰å¤Ÿç”¨çš„åŒ…ï¼ˆstream_has_enough_packetsï¼‰\n\nç¬¬ä¸€ç§å¥½ç†è§£ï¼Œçœ‹ä¸‹ç¬¬äºŒç§ä¸­çš„stream_has_enough_packetsï¼š\n\n```c\nstatic int stream_has_enough_packets(AVStream *st, int stream_id, PacketQueue *queue) {\n    return stream_id < 0 ||\n           queue->abort_request ||\n           (st->disposition & AV_DISPOSITION_ATTACHED_PIC) ||\n           queue->nb_packets > MIN_FRAMES && (!queue->duration || av_q2d(st->time_base) * queue->duration > 1.0);\n}\n```\n\nåœ¨æ»¡è¶³PacketQueueæ€»æ—¶é•¿ä¸º0ï¼Œæˆ–æ€»æ—¶é•¿è¶…è¿‡1sçš„å‰æä¸‹ï¼š\n\næœ‰è¿™ä¹ˆå‡ ç§æƒ…å†µåŒ…æ˜¯å¤Ÿç”¨çš„ï¼š\n\n1. æµæ²¡æœ‰æ‰“å¼€ï¼ˆstream_id < 0ï¼‰\n2. æœ‰é€€å‡ºè¯·æ±‚ï¼ˆqueue->abort_requestï¼‰\n3. é…ç½®äº†AV_DISPOSITION_ATTACHED_PICï¼Ÿï¼ˆè¿™ä¸ªè¿˜ä¸ç†è§£ï¼Œåç»­åˆ†æattachementæ—¶å›å¤´çœ‹çœ‹ï¼‰\n4. é˜Ÿåˆ—å†…åŒ…ä¸ªæ•°å¤§äºMIN_FRAMESï¼ˆ=25ï¼‰\n\næŒºé¥¶åœ°ï¼Œæ²¡æœ‰æ·±åˆ»ä½“ä¼šå…¶è®¾è®¡ç”¨æ„ï¼Œä¸è¯„è®ºã€‚\n\nä¸Šè¿°çš„å‡ ç§å¤„ç†éƒ½è¿˜æ˜¯åœ¨æ­£å¸¸æ’­æ”¾æµç¨‹å†…ï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹æ’­æ”¾å·²å®Œæˆæƒ…å†µçš„å¤„ç†ã€‚\n\n```c\nif (!is->paused &&\n    (!is->audio_st || (is->auddec.finished == is->audioq.serial && frame_queue_nb_remaining(&is->sampq) == 0)) &&\n    (!is->video_st || (is->viddec.finished == is->videoq.serial && frame_queue_nb_remaining(&is->pictq) == 0))) {\n    if (loop != 1 && (!loop || --loop)) {\n        stream_seek(is, start_time != AV_NOPTS_VALUE ? start_time : 0, 0, 0);\n    } else if (autoexit) {\n        ret = AVERROR_EOF;\n        goto fail;\n    }\n}\n```\n\nè¿™é‡Œåˆ¤æ–­æ’­æ”¾å·²å®Œæˆçš„æ¡ä»¶ä¾ç„¶å¾ˆâ€œffplayâ€ï¼Œéœ€è¦æ»¡è¶³ï¼š\n\n1. ä¸åœ¨æš‚åœçŠ¶æ€\n2. éŸ³é¢‘æœªæ‰“å¼€ï¼Œæˆ–è€…æ‰“å¼€äº†ï¼Œä½†æ˜¯è§£ç å·²è§£ç å®Œæ¯•ï¼Œserialç­‰äºPacketQueueçš„serialï¼Œå¹¶ä¸”PacketQueueä¸­æ²¡æœ‰èŠ‚ç‚¹äº†\n3. è§†é¢‘æœªæ‰“å¼€ï¼Œæˆ–è€…æ‰“å¼€äº†ï¼Œä½†æ˜¯è§£ç å·²è§£ç å®Œæ¯•ï¼Œserialç­‰äºPacketQueueçš„serialï¼Œå¹¶ä¸”PacketQueueä¸­æ²¡æœ‰èŠ‚ç‚¹äº†\n\nåœ¨ç¡®è®¤å·²ç»“æŸçš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·æœ‰ä¸¤ä¸ªå˜é‡å¯ä»¥æ§åˆ¶æ’­æ”¾å™¨è¡Œä¸ºï¼š\n\n1. loop: æ§åˆ¶æ’­æ”¾æ¬¡æ•°ï¼ˆå½“å‰è¿™æ¬¡ä¹Ÿç®—åœ¨å†…ï¼Œä¹Ÿå°±æ˜¯æœ€å°å°±æ˜¯1æ¬¡äº†ï¼‰ï¼Œ0è¡¨ç¤ºæ— é™æ¬¡\n2. autoexitï¼šè‡ªåŠ¨é€€å‡ºï¼Œä¹Ÿå°±æ˜¯æ’­æ”¾å®Œæˆåè‡ªåŠ¨é€€å‡ºã€‚\n\nloopæ¡ä»¶ç®€åŒ–çš„éå¸¸ä¸å‹å¥½ï¼Œå…¶æ„æ€æ˜¯ï¼šå¦‚æœloop==1ï¼Œé‚£ä¹ˆå·²ç»æ’­äº†1æ¬¡äº†ï¼Œæ— éœ€å†seeké‡æ–°æ’­æ”¾ï¼›å¦‚æœloopä¸æ˜¯1ï¼Œ==0ï¼Œéšæ„ï¼Œæ— é™æ¬¡å¾ªç¯ï¼›å‡1åè¿˜å¤§äº0ï¼ˆ--loopï¼‰ï¼Œä¹Ÿå…è®¸å¾ªç¯ã€‚ä¹Ÿå°±æ˜¯ï¼š\n\n```c\nstatic int allow_loop() {\n    if (loop == 1)\n        return 0;\n\n    if (loop == 0)\n        return 1;\n\n    --loop;\n    if (loop > 0)\n        return 1;\n\n    return 0;\n}\n```\n\nå‰é¢è®²äº†å¾ˆå¤šè¯»çº¿ç¨‹ä¸»å¾ªç¯å†…çš„å¤„ç†ï¼Œæ¯”å¦‚æš‚åœã€seekã€ç»“æŸloopå¤„ç†ç­‰ï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹çœŸæ­£è¯»çš„ä»£ç ï¼š\n\n```c\nret = av_read_frame(ic, pkt);\nif (ret < 0) {\n    //æ–‡ä»¶è¯»å–å®Œäº†ï¼Œè°ƒç”¨packet_queue_put_nullpacketé€šçŸ¥è§£ç çº¿ç¨‹\n    if ((ret == AVERROR_EOF || avio_feof(ic->pb)) && !is->eof) {\n        if (is->video_stream >= 0)\n            packet_queue_put_nullpacket(&is->videoq, is->video_stream);\n        if (is->audio_stream >= 0)\n            packet_queue_put_nullpacket(&is->audioq, is->audio_stream);\n        if (is->subtitle_stream >= 0)\n            packet_queue_put_nullpacket(&is->subtitleq, is->subtitle_stream);\n        is->eof = 1;\n    }\n    //å‘ç”Ÿé”™è¯¯äº†ï¼Œé€€å‡ºä¸»å¾ªç¯\n    if (ic->pb && ic->pb->error)\n        break;\n\n    //å¦‚æœéƒ½ä¸æ˜¯ï¼Œå¯èƒ½åªæ˜¯è¦ç­‰ä¸€ç­‰\n    SDL_LockMutex(wait_mutex);\n    SDL_CondWaitTimeout(is->continue_read_thread, wait_mutex, 10);\n    SDL_UnlockMutex(wait_mutex);\n    continue;\n} else {\n    is->eof = 0;\n}\n\n/* check if packet is in play range specified by user, then queue, otherwise discard */\nstream_start_time = ic->streams[pkt->stream_index]->start_time;\npkt_ts = pkt->pts == AV_NOPTS_VALUE ? pkt->dts : pkt->pts;\npkt_in_play_range = duration == AV_NOPTS_VALUE ||\n        (pkt_ts - (stream_start_time != AV_NOPTS_VALUE ? stream_start_time : 0)) *\n        av_q2d(ic->streams[pkt->stream_index]->time_base) -\n        (double)(start_time != AV_NOPTS_VALUE ? start_time : 0) / 1000000\n        <= ((double)duration / 1000000);\n\n//å¦‚æœåœ¨æ—¶é—´èŒƒå›´å†…ï¼Œé‚£ä¹ˆæ ¹æ®stream_indexï¼Œæ”¾å…¥åˆ°è§†é¢‘ã€éŸ³é¢‘ã€ä¼šå­—å¹•çš„PacketQueueä¸­\nif (pkt->stream_index == is->audio_stream && pkt_in_play_range) {\n    packet_queue_put(&is->audioq, pkt);\n} else if (pkt->stream_index == is->video_stream && pkt_in_play_range\n           && !(is->video_st->disposition & AV_DISPOSITION_ATTACHED_PIC)) {\n    packet_queue_put(&is->videoq, pkt);\n} else if (pkt->stream_index == is->subtitle_stream && pkt_in_play_range) {\n    packet_queue_put(&is->subtitleq, pkt);\n} else {\n    av_packet_unref(pkt);\n}\n```\n\nçœ‹èµ·æ¥å¾ˆé•¿ï¼Œå®é™…æ¯”ä¸Šè¿°å„ç§ç‰¹æ®Šæµç¨‹çš„å¤„ç†éƒ½ç›´ç™½ï¼Œä¸»è¦ä¸ºï¼š\n\n1. av_read_frameè¯»å–ä¸€ä¸ªåŒ…(AVPacket)\n2. è¿”å›å€¼å¤„ç†\n3. pkt_in_play_rangeè®¡ç®—\n4. packet_queue_putæ”¾å…¥å„è‡ªé˜Ÿåˆ—ï¼Œæˆ–è€…ä¸¢å¼ƒ\n\næ­¥éª¤1ã€æ­¥éª¤2ã€æ­¥éª¤4ï¼Œéƒ½æ¯”è¾ƒç›´æ¥ï¼Œçœ‹æ³¨é‡Šå³å¯ã€‚\n\nè¿™é‡Œçœ‹ä¸‹pkt_in_play_rangeçš„è®¡ç®—ï¼Œæˆ‘ä»¬æŠŠä»¥ä¸Šä»£ç åˆ†è§£ä¸‹ï¼š\n\n```c\nint64_t get_stream_start_time(AVFormatContext* ic, int index) {\n    int64_t stream_start_time = ic->streams[index]->start_time;\n    return stream_start_time != AV_NOPTS_VALUE ? stream_start_time : 0;\n}\n\nint64_t get_pkt_ts(AVPacket* pkt) {//ts: timestampï¼ˆæ—¶é—´æˆ³ï¼‰çš„ç¼©å†™\n    return pkt->pts == AV_NOPTS_VALUE ? pkt->dts : pkt->pts;\n}\n\ndouble ts_as_second(int64_t tsï¼ŒAVFormatContext* icï¼Œint index) {\n    return ts * av_q2d(ic->streams[index]->time_base);\n} \n\ndouble get_ic_start_time(AVFormatContext* ic) {//icä¸­çš„æ—¶é—´å•ä½æ˜¯us\n    return (start_time != AV_NOPTS_VALUE ? start_time : 0) / 1000000;\n}\n```\n\næœ‰äº†è¿™äº›å‡½æ•°ï¼Œå°±å¯ä»¥è®¡ç®—pkt_in_play_rangeäº†ï¼š\n\n```c\nint is_pkt_in_play_range(AVFormatContext* ic, AVPacket* pkt) {\n    if (duration == AV_NOPTS_VALUE) //å¦‚æœå½“å‰æµæ— æ³•è®¡ç®—æ€»æ—¶é•¿ï¼ŒæŒ‰æ— é™æ—¶é•¿å¤„ç†\n        return 1;\n\n    //è®¡ç®—pktç›¸å¯¹streamä½ç½®\n    int64_t stream_ts = get_pkt_ts(pkt) - get_stream_start_time(ic, pkt->stream_index);\n    double stream_ts_s = ts_as_second(stream_ts, ic, pkt->stream_index);\n\n    //è®¡ç®—pktç›¸å¯¹icä½ç½®\n    double ic_ts = stream_ts_s - get_ic_start_time(ic);\n\n    //æ˜¯å¦åœ¨æ—¶é—´èŒƒå›´å†…\n    return ic_ts <= ((double)duration / 1000000);\n}\n```\n","source":"_posts/ffmpeg/2022-03-20-ffplay read_thread åˆ†æ.md","raw":"---\nlayout: post\ntitle: \"ffplay read_thread åˆ†æ\"\ndate: 2022-03-20\ntag: ffmpeg\n\n---\n\n\nå‚è€ƒï¼š [ffplay readçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/43672062)\n\n> ffplay main å‡½æ•° åšäº†ä»€ä¹ˆ\n\n1. å‚æ•°éªŒè¯ä¸è§£æ\n\n2. æ³¨å†Œcodecsï¼Œ demuxï¼Œ protocols\n\n3. sdl åˆå§‹åŒ–ï¼Œåˆ›å»ºçª—å£\n\n4. è°ƒç”¨stream_openæ‰“å¼€æµ\n\n5. è°ƒç”¨event_loopè¿›å…¥è¿è¡Œå¾ªç¯\n\n> stream_open åšäº†ä»€ä¹ˆ\n\nÂ Â Â Â ä¸»è¦æ˜¯åˆå§‹åŒ–VideoState *isï¼Œå¡«å……å…³é”®ä¿¡æ¯\n\n1. åˆå§‹åŒ–ï¼Œåˆ†é…å†…å­˜`is = av_mallocz(sizeof(VideoState));`\n\n2. è°ƒç”¨frame_queue_initç»™VideoStateå¯¹åº”çš„éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”Frameé˜Ÿåˆ—åˆå§‹åŒ–åˆ†é…å†…å­˜\n\n3. è°ƒç”¨packet_queue_initç»™VideoStateå¯¹åº”çš„éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”Packeté˜Ÿåˆ—åˆå§‹åŒ–åˆ†é…å†…å­˜\n\n4. åˆ›å»ºæ¡ä»¶å˜é‡continue_read_threadï¼Œ ç”¨äºæ§åˆ¶æ˜¯å¦ç»§ç»­è¯»å–æˆ–è€…ç­‰å¾…\n\n5. è°ƒç”¨init_clock åˆå§‹åŒ–éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå¤–éƒ¨æ—¶é’Ÿ\n\n6. è®¾ç½®åŒæ­¥ç±»å‹av_sync_type\n\n7. åˆ›å»ºå¹¶å¼€å¯read_thread\n\n## read_thread\n\nåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š\n\n1. å‡†å¤‡é˜¶æ®µ\n\n2. å¾ªç¯è¯»pkt\n\nå‡†å¤‡é˜¶æ®µï¼š\n\nstream_open å¯¹VideoState *is åšäº†åˆå§‹åŒ–å…³é”®å‚æ•°çš„å¡«å……ã€‚read_thread åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæ‰“å¼€è¾“å…¥çš„æµï¼Œè§£å°è£…ï¼Œè¯»å–æµçš„ä¿¡æ¯ï¼Œæ‰¾åˆ°éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”çš„streamï¼Œè¯»å–è§£ç å‚æ•°ï¼Œåˆ›å»ºè§£ç å™¨ï¼Œå¼€å¯è§£ç å™¨ã€‚åˆ†åˆ«ä¸ºéŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¼€å¯åˆ›å»ºè§£ç çº¿ç¨‹ã€‚\n\nå¾ªç¯è¯»pktï¼š\n\nç„¶åè¿›å…¥å¾ªç¯ï¼Œä»æµä¸­è¯»å–pktï¼Œæ ¹æ®åŒæ­¥æ—¶é’Ÿï¼Œæ”¾å…¥pkté˜Ÿåˆ—æˆ–è€…ä¸¢å¼ƒã€‚å¦‚æœè¯»ç»“æŸï¼Œç»™pkté˜Ÿåˆ—æ”¾å…¥ç©ºåŒ…ï¼Œç”¨äºå†²æ´—è§£ç å™¨ã€‚\n\nå¾ªç¯ä¸­è¿˜è¦å¤„ç†ç»ˆæ­¢æš‚åœæ¢å¤äº‹ä»¶ï¼Œseekäº‹ä»¶ï¼Œæ ¹æ®é˜Ÿåˆ—çš„çŠ¶æ€ï¼ˆæ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®ï¼‰æ§åˆ¶ç­‰å¾…è¿˜æ˜¯ç»§ç»­è¯»å–æ–°çš„pktã€‚\n\n### å‡†å¤‡é˜¶æ®µ\n\næ‰“å¼€æ–‡ä»¶ï¼Œè§£å°è£…ï¼Œè·å–æ–‡ä»¶ä¿¡æ¯\n\n```c\nVideoState *is = arg;\nAVFormatContext *ic = NULL;\n//åˆ›å»ºAVFormatContext\nic = avformat_alloc_context();\n//interrupt_callbackç”¨äºffmpegå†…éƒ¨åœ¨æ‰§è¡Œè€—æ—¶æ“ä½œæ—¶æ£€æŸ¥æ˜¯å¦æœ‰é€€å‡ºè¯·æ±‚ï¼Œå¹¶æå‰ä¸­æ–­ï¼Œé¿å…ç”¨æˆ·é€€å‡ºè¯·æ±‚æ²¡æœ‰åŠæ—¶å“åº”\nic->interrupt_callback.callback = decode_interrupt_cb;\nic->interrupt_callback.opaque = is;\n//ç‰¹å®šé€‰é¡¹å¤„ç†\nif (!av_dict_get(format_opts, \"scan_all_pmts\", NULL, AV_DICT_MATCH_CASE)) {\n    av_dict_set(&format_opts, \"scan_all_pmts\", \"1\", AV_DICT_DONT_OVERWRITE);\n    scan_all_pmts_set = 1;\n}\n//æ‰“å¼€è¾“å…¥çš„æµï¼Œè¯»å–æµçš„å¤´éƒ¨ä¿¡æ¯\nerr = avformat_open_input(&ic, is->filename, is->iformat, &format_opts);\n//ä¿å­˜AVFormatContext\nis->ic = ic;\nif (find_stream_info) {\n    //å¦‚æœæ–‡ä»¶ä¸åŒ…å«å¤´éƒ¨ä¿¡æ¯(å¦‚ts)ï¼Œé€šè¿‡è¯»å–ä¸€æ®µæ–‡ä»¶åˆ†æåå¾—åˆ°æµä¿¡æ¯\n    err = avformat_find_stream_info(ic, opts);\n}\n```\n\nåˆ¤æ–­æ˜¯å¦æ˜¯å®æ—¶æµ\n\n```c\n//æ˜¯å¦æ˜¯å®æ—¶æµrtp/rtsp/sdpç­‰\nis->realtime = is_realtime(ic);\n```\n\nis_realtime å‡½æ•°\n\n```c\nstatic int is_realtime(AVFormatContext *s)\n{\n    if(   !strcmp(s->iformat->name, \"rtp\")\n       || !strcmp(s->iformat->name, \"rtsp\")\n       || !strcmp(s->iformat->name, \"sdp\")\n    )\n        return 1;\n\n    if(s->pb && (   !strncmp(s->url, \"rtp:\", 4)\n                 || !strncmp(s->url, \"udp:\", 4)\n                )\n    )\n        return 1;\n    return 0;\n}\n```\n\né€‰æ‹©éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•æµã€‚å®é™…æ“ä½œä¸­ï¼Œé€‰æ‹©çš„ç­–ç•¥å¾ˆå¤šï¼Œä¸€èˆ¬æ ¹æ®å…·ä½“éœ€æ±‚æ¥å®šâ€”â€”æ¯”å¦‚å¯ä»¥æ˜¯é€‰æ‹©æœ€é«˜æ¸…çš„è§†é¢‘æµï¼›é€‰æ‹©æœ¬åœ°è¯­è¨€çš„éŸ³é¢‘æµï¼›ç›´æ¥é€‰æ‹©ç¬¬ä¸€æ¡è§†é¢‘ã€éŸ³é¢‘è½¨é“ï¼›ç­‰ç­‰ã€‚\n\nffplayä¸»è¦æ˜¯é€šè¿‡`av_find_best_stream`æ¥é€‰æ‹©ï¼š\n\n```c\n    //å¦‚æœç”¨æˆ·é€šè¿‡wanted_stream_specæŒ‡å®šäº†æµï¼Œæ‰¾åˆ°ç”¨æˆ·é€‰æ‹©çš„æµ\n    for (i = 0; i < ic->nb_streams; i++) {\n        AVStream *st = ic->streams[i];\n        enum AVMediaType type = st->codecpar->codec_type;\n        st->discard = AVDISCARD_ALL;\n        if (type >= 0 && wanted_stream_spec[type] && st_index[type] == -1)\n            if (avformat_match_stream_specifier(ic, st, wanted_stream_spec[type]) > 0)\n                st_index[type] = i;\n    }\n    for (i = 0; i < AVMEDIA_TYPE_NB; i++) {\n        if (wanted_stream_spec[i] && st_index[i] == -1) {\n            //å¤„ç†æ‰¾ä¸åˆ°ç”¨æˆ·é€‰æ‹©çš„æµçš„æƒ…å†µ\n            av_log(NULL, AV_LOG_ERROR, \"Stream specifier %s does not match any %s stream\\n\", wanted_stream_spec[i], av_get_media_type_string(i));\n            st_index[i] = INT_MAX;\n        }\n    }\n\n    //è·å–video stream\n    if (!video_disable)\n        st_index[AVMEDIA_TYPE_VIDEO] =\n            av_find_best_stream(ic, AVMEDIA_TYPE_VIDEO,\n                                st_index[AVMEDIA_TYPE_VIDEO], -1, NULL, 0);\n    //è·å–audio streamï¼Œå‚è€ƒè§†é¢‘æµé€‰æ‹©\n    if (!audio_disable)\n        st_index[AVMEDIA_TYPE_AUDIO] =\n            av_find_best_stream(ic, AVMEDIA_TYPE_AUDIO,\n                                st_index[AVMEDIA_TYPE_AUDIO],\n                                st_index[AVMEDIA_TYPE_VIDEO],\n                                NULL, 0);\n    //è·å–subtitle streamï¼Œä¼˜å…ˆå‚è€ƒéŸ³é¢‘æµ\n    if (!video_disable && !subtitle_disable)\n        st_index[AVMEDIA_TYPE_SUBTITLE] =\n            av_find_best_stream(ic, AVMEDIA_TYPE_SUBTITLE,\n                                st_index[AVMEDIA_TYPE_SUBTITLE],\n                                (st_index[AVMEDIA_TYPE_AUDIO] >= 0 ?\n                                 st_index[AVMEDIA_TYPE_AUDIO] :\n                                 st_index[AVMEDIA_TYPE_VIDEO]),\n                                NULL, 0);\n```\n\nwanted_stream_specé€šè¿‡mainå‡½æ•°ä¼ å‚è®¾å®šï¼Œæ ¼å¼å¯ä»¥æœ‰å¾ˆå¤šç§ï¼Œå‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://www.ffmpeg.org/ffplay.html#Stream-specifiers-1)\n\nå¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šæµï¼Œæˆ–æŒ‡å®šéƒ¨åˆ†æµï¼Œæˆ–æŒ‡å®šæµä¸å­˜åœ¨ï¼Œåˆ™ä¸»è¦ç”±av_find_best_streamå‘æŒ¥ä½œç”¨ã€‚\n\n```c\nint av_find_best_stream(AVFormatContext *ic,\n                        enum AVMediaType type,//è¦é€‰æ‹©çš„æµç±»å‹\n                        int wanted_stream_nb,//ç›®æ ‡æµç´¢å¼•\n                        int related_stream,//å‚è€ƒæµç´¢å¼•\n                        AVCodec **decoder_ret,\n                        int flags);\n```\n\nå¦‚æœæŒ‡å®šäº†æ­£ç¡®çš„wanted_stream_nbï¼Œä¸€èˆ¬æƒ…å†µéƒ½æ˜¯ç›´æ¥è¿”å›è¯¥æŒ‡å®šæµï¼Œå³ç”¨æˆ·é€‰æ‹©çš„æµã€‚å¦‚æœæŒ‡å®šäº†å‚è€ƒæµï¼Œä¸”æœªæŒ‡å®šç›®æ ‡æµçš„æƒ…å†µï¼Œä¼šæ ¹æ®å‚è€ƒæµå»æŸ¥æ‰¾æ‰€éœ€ç±»å‹çš„æµï¼Œä½†ä¸€èˆ¬ç»“æœï¼Œéƒ½æ˜¯è¿”å›è¯¥ç±»å‹ç¬¬ä¸€ä¸ªæµã€‚\n\nå·²ç»è·å–äº†æµä¿¡æ¯ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯åˆ›å»ºè§£ç å™¨ï¼Œå¼€å¯è§£ç çº¿ç¨‹ã€‚ \n\nä¸»è¦åœ¨`stream_component_open`æ–¹æ³•ä¸­å®ç°, ç®€åŒ–ä»£ç å¦‚ä¸‹\n\n```c\nstatic int stream_component_open(VideoState *is, int stream_index)\n{\n    //åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡\n    avctx = avcodec_alloc_context3(NULL);        \n    //å¡«å……è§£ç å‚æ•°\n    ret = avcodec_parameters_to_context(avctx, ic->streams[stream_index]->codecpar);\n    //è®¾ç½®è§£ç å™¨çš„æ—¶é—´åŸºï¼Œç­‰äºstreamçš„æ—¶é—´åŸº\n    avctx->pkt_timebase = ic->streams[stream_index]->time_base;\n    //æ‰¾è§£ç å™¨\n    codec = avcodec_find_decoder(avctx->codec_id);\n    if (forced_codec_name)\n        //å¦‚æœç”¨æˆ·æŒ‡å®šäº†è§£ç å™¨ï¼Œä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„è§£ç å™¨\n        codec = avcodec_find_decoder_by_name(forced_codec_name);\n    //æ‰“å¼€è§£ç å™¨\n    if ((ret = avcodec_open2(avctx, codec, &opts)) < 0) {\n        goto fail;\n    }\n    switch (avctx->codec_type) {\n    case AVMEDIA_TYPE_AUDIO:\n        //æ‰“å¼€éŸ³é¢‘æ’­æ”¾å™¨\n        if ((ret = audio_open(is, channel_layout, nb_channels, sample_rate, &is->audio_tgt)) < 0)\n            goto fail;\n        //ç»™is->auddecåˆå§‹åŒ–\n        if ((ret = decoder_init(&is->auddec, avctx, &is->audioq, is->continue_read_thread)) < 0)\n            goto fail;\n        //å¼€å¯éŸ³é¢‘è§£ç çº¿ç¨‹\n        if ((ret = decoder_start(&is->auddec, audio_thread, \"audio_decoder\", is)) < 0)\n            goto out;\n        //æš‚åœéŸ³é¢‘æ’­æ”¾å™¨\n        SDL_PauseAudioDevice(audio_dev, 0);\n        break;\n    case AVMEDIA_TYPE_VIDEO:\n        is->video_stream = stream_index;\n        is->video_st = ic->streams[stream_index];\n        //ç»™is->viddecåˆå§‹åŒ–\n        if ((ret = decoder_init(&is->viddec, avctx, &is->videoq, is->continue_read_thread)) < 0)\n            goto fail;\n        //å¼€å¯è§†é¢‘è§£ç çº¿ç¨‹\n        if ((ret = decoder_start(&is->viddec, video_thread, \"video_decoder\", is)) < 0)\n            goto out;\n        is->queue_attachments_req = 1;\n        break;\n    case AVMEDIA_TYPE_SUBTITLE:\n        is->subtitle_stream = stream_index;\n        is->subtitle_st = ic->streams[stream_index];\n        //åˆå§‹åŒ–å­—å¹•è§£ç \n        if ((ret = decoder_init(&is->subdec, avctx, &is->subtitleq, is->continue_read_thread)) < 0)\n            goto fail;\n        //å¼€å¯å­—å¹•è§£ç çº¿ç¨‹\n        if ((ret = decoder_start(&is->subdec, subtitle_thread, \"subtitle_decoder\", is)) < 0)\n            goto out;\n        break;\n    }\n    //....\n    return ret;\n}\n```\n\né’ˆå¯¹éŸ³é¢‘ï¼Œéœ€è¦å¦å¤–å¤„ç†éŸ³é¢‘æ’­æ”¾å™¨çš„åˆå§‹åŒ–ï¼Œæš‚åœçŠ¶æ€ã€‚\n\nå¯¹éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•ï¼Œè°ƒç”¨`decoder_init`åˆå§‹åŒ–Decoderï¼Œ è°ƒç”¨`decoder_start`å¼€å¯å¯¹åº”çš„è§£ç çº¿ç¨‹ã€‚\n\ndecoder_init\n\n```\nstatic int decoder_init(Decoder *d, AVCodecContext *avctx, PacketQueue *queue, SDL_cond *empty_queue_cond) {\n    memset(d, 0, sizeof(Decoder));\n    d->pkt = av_packet_alloc();\n    if (!d->pkt)\n        return AVERROR(ENOMEM);\n    d->avctx = avctx;\n    d->queue = queue;\n    d->empty_queue_cond = empty_queue_cond;\n    d->start_pts = AV_NOPTS_VALUE;\n    d->pkt_serial = -1;\n    return 0;\n}\n```\n\ndecoder_start\n\n```\nstatic int decoder_start(Decoder *d, int (*fn)(void *), const char *thread_name, void* arg)\n{\n    //å¼€å¯packet queue\n    packet_queue_start(d->queue);\n    //å¼€å¯è§£ç çº¿ç¨‹\n    d->decoder_tid = SDL_CreateThread(fn, thread_name, arg);\n    if (!d->decoder_tid) {\n        av_log(NULL, AV_LOG_ERROR, \"SDL_CreateThread(): %s\\n\", SDL_GetError());\n        return AVERROR(ENOMEM);\n    }\n    return 0;\n}\n```\n\n### ä¸»å¾ªç¯è¯»åŒ…\n\nç®€åŒ–ä¸€ä¸‹å¦‚ä¸‹\n\n```\nfor (;;) {\n        if (is->abort_request)\n            break;//å¤„ç†é€€å‡ºæ¶ˆæ¯\n        if (is->paused != is->last_paused) {\n            //å¤„ç†æš‚åœä¸æ¢å¤\n            //.......\n        }\n\n        if (is->seek_req) {\n            //å¤„ç†seekæ“ä½œ\n            ret = avformat_seek_file(is->ic, -1, seek_min, seek_target, seek_max, is->seek_flags);\n        }\n        /*\n        æ§åˆ¶é˜Ÿåˆ—å¤§å°\n        */\n        if (infinite_buffer<1 &&\n              (is->audioq.size + is->videoq.size + is->subtitleq.size > MAX_QUEUE_SIZE\n            || (stream_has_enough_packets(is->audio_st, is->audio_stream, &is->audioq) &&\n                stream_has_enough_packets(is->video_st, is->video_stream, &is->videoq) &&\n                stream_has_enough_packets(is->subtitle_st, is->subtitle_stream, &is->subtitleq)))) {\n            /* wait 10 ms */\n            SDL_LockMutex(wait_mutex);\n            SDL_CondWaitTimeout(is->continue_read_thread, wait_mutex, 10);\n            SDL_UnlockMutex(wait_mutex);\n            continue;\n        }\n        //å¤„ç†å¾ªç¯æ’­æ”¾\n        if (!is->paused &&\n            (!is->audio_st || (is->auddec.finished == is->audioq.serial && frame_queue_nb_remaining(&is->sampq) == 0)) &&\n            (!is->video_st || (is->viddec.finished == is->videoq.serial && frame_queue_nb_remaining(&is->pictq) == 0))) {\n            if (loop != 1 && (!loop || --loop)) {\n                stream_seek(is, start_time != AV_NOPTS_VALUE ? start_time : 0, 0, 0);\n            } else if (autoexit) {\n                ret = AVERROR_EOF;\n                goto fail;\n            }\n        }\n        //è¯»pkt\n        ret = av_read_frame(ic, pkt);\n\n        //åœ¨æ’­æ”¾åŒºé—´ï¼Œæ”¾å…¥é˜Ÿåˆ—\n        packet_queue_put(&is->videoq, pkt);\n        //ä¸åœ¨æ’­æ”¾åŒºé—´ï¼Œä¸¢å¼ƒ\n        av_packet_unref(pkt);\n\n    }\n```\n\nä¸»è¦çš„ä»£ç å°±`av_read_frame`å’Œ`packet_queue_put`ï¼Œ`av_read_frame`ä»æ–‡ä»¶ä¸­è¯»å–è§†é¢‘æ•°æ®ï¼Œå¹¶è·å–ä¸€ä¸ªAVPacketï¼Œ`packet_queue_put`æŠŠå®ƒæ”¾å…¥åˆ°å¯¹åº”çš„PacketQueueä¸­ã€‚\n\nå½“ç„¶ï¼Œè¯»å–è¿‡ç¨‹è¿˜ä¼šæœ‰seekã€pauseã€resumeã€abortç­‰äº‹ä»¶ï¼Œæ‰€ä»¥æœ‰ä¸“é—¨çš„åˆ†æ”¯å¤„ç†è¿™äº›è¯·æ±‚ã€‚\n\nPacketQueueé»˜è®¤æƒ…å†µä¸‹ä¼šæœ‰å¤§å°é™åˆ¶ï¼Œè¾¾åˆ°è¿™ä¸ªå¤§å°åï¼Œå°±éœ€è¦ç­‰å¾…10msï¼Œä»¥è®©æ¶ˆè´¹è€…â€”â€”è§£ç çº¿ç¨‹èƒ½æœ‰æ—¶é—´æ¶ˆè€—ã€‚\n\næ’­æ”¾å®Œæˆåï¼Œä¼šæ ¹æ®loopçš„è®¾ç½®å†³å®šæ˜¯å¦å¾ªç¯ã€‚\n\næš‚åœ/æ¢å¤çš„å¤„ç†ï¼š\n\n```c\nif (is->paused != is->last_paused) {\n    //æ›´æ–°pausedçŠ¶æ€\n    is->last_paused = is->paused;\n    if (is->paused)\n        //æš‚åœ\n        is->read_pause_return = av_read_pause(ic);\n    else\n        //æ¢å¤æ’­æ”¾\n        av_read_play(ic);\n}\n```\n\nffmpegæœ‰ä¸“é—¨é’ˆå¯¹æš‚åœå’Œæ¢å¤çš„å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨å°±å¯ä»¥äº†ã€‚\n\n> av_read_pauseå’Œav_read_playå¯¹äºURLProtocolï¼Œä¼šè°ƒç”¨å…¶url_read_pauseï¼Œé€šè¿‡å‚æ•°åŒºåˆ†æ˜¯è¦æš‚åœè¿˜æ˜¯æ¢å¤ã€‚å¯¹äºAVInputFormatä¼šè°ƒç”¨å…¶read_pauseå’Œread_play.  \n> ä¸€èˆ¬æƒ…å†µä¸‹URLProtocolå’ŒAVInputFormatéƒ½ä¸éœ€è¦ä¸“é—¨å¤„ç†æš‚åœå’Œæ¢å¤ï¼Œä½†å¯¹äºåƒrtsp/rtmpè¿™ç§åœ¨é€šè®¯åè®®ä¸Šæ”¯æŒ(éœ€è¦)æš‚åœã€æ¢å¤çš„å°±ç‰¹åˆ«æœ‰ç”¨äº†ã€‚\n\nå¯¹äºseekçš„å¤„ç†ï¼Œä¼šæ¯”æš‚åœ/æ¢å¤ç•¥å¾®å¤æ‚ä¸€äº›ï¼š\n\n```c\nif (is->seek_req) {\n    //å¤„ç†seekæ“ä½œ\n    int64_t seek_target = is->seek_pos;\n    int64_t seek_min    = is->seek_rel > 0 ? seek_target - is->seek_rel + 2: INT64_MIN;\n    int64_t seek_max    = is->seek_rel < 0 ? seek_target - is->seek_rel - 2: INT64_MAX;\n// FIXME the +-2 is due to rounding being not done in the correct direction in generation\n//      of the seek_pos/seek_rel variables\n    //seekåˆ°æ­£ç¡®çš„ä½ç½®\n    ret = avformat_seek_file(is->ic, -1, seek_min, seek_target, seek_max, is->seek_flags);\n    if (ret < 0) {\n        av_log(NULL, AV_LOG_ERROR,\n               \"%s: error while seeking\\n\", is->ic->url);\n    } else {\n        if (is->audio_stream >= 0)\n            //æ¸…ç©ºéŸ³é¢‘å¸§é˜Ÿåˆ—\n            packet_queue_flush(&is->audioq);\n        if (is->subtitle_stream >= 0)\n            //æ¸…ç©ºå­—å¹•å¸§é˜Ÿåˆ—\n            packet_queue_flush(&is->subtitleq);\n        if (is->video_stream >= 0)\n            //æ¸…ç©ºè§†é¢‘å¸§é˜Ÿåˆ—\n            packet_queue_flush(&is->videoq);\n        //æ›´æ–°clock\n        if (is->seek_flags & AVSEEK_FLAG_BYTE) {\n           set_clock(&is->extclk, NAN, 0);\n        } else {\n           set_clock(&is->extclk, seek_target / (double)AV_TIME_BASE, 0);\n        }\n    }\n    is->seek_req = 0;\n    is->queue_attachments_req = 1;\n    is->eof = 0;\n    if (is->paused)\n        step_to_next_frame(is);\n}\n```\n\nä¸»è¦çš„seekæ“ä½œé€šè¿‡avformat_seek_fileå®Œæˆã€‚æ ¹æ®avformat_seek_fileçš„è¿”å›å€¼ï¼Œå¦‚æœseekæˆåŠŸï¼Œéœ€è¦ï¼š\n\n1. æ¸…é™¤PacketQueueçš„ç¼“å­˜ï¼Œå¹¶æ”¾å…¥ä¸€ä¸ªflush_pktã€‚æ”¾å…¥çš„flush_pktå¯ä»¥è®©PacketQueueçš„serialå¢1ï¼Œä»¥åŒºåˆ†seekå‰åçš„æ•°æ®\n2. åŒæ­¥å¤–éƒ¨æ—¶é’Ÿã€‚åœ¨åç»­éŸ³è§†é¢‘åŒæ­¥çš„æ–‡ç« ä¸­å†å…·ä½“åˆ†æã€‚\n\næœ€åæ¸…ç†ä¸€äº›å˜é‡ï¼Œå¹¶ï¼š\n\n1. è®¾ç½®queue_attachments_reqä»¥æ˜¾ç¤ºattachmentç”»é¢\n2. å¦‚æœå½“å‰æ˜¯æš‚åœçŠ¶æ€ï¼Œå°±è·³åˆ°seekåçš„ä¸‹ä¸€å¸§ï¼Œä»¥ç›´è§‚ä½“ç°seekæˆåŠŸäº†\n\nstep_to_next_frame\n\n```\nstatic void step_to_next_frame(VideoState *is)\n{\n    /* if the stream is paused unpause it, then step */\n    if (is->paused)\n        stream_toggle_pause(is);\n    is->step = 1;\n}\n```\n\nåŸä»£ç çš„æ³¨é‡Šæ¯”è¾ƒæ¸…æ™°äº†â€”â€”å…ˆå–æ¶ˆæš‚åœï¼Œç„¶åæ‰§è¡Œstepã€‚å½“è®¾ç½®stepä¸º1åï¼Œæ˜¾ç¤ºçº¿ç¨‹ä¼šæ˜¾ç¤ºå‡ºä¸€å¸§ç”»é¢ï¼Œç„¶åå†æ¬¡è¿›å…¥æš‚åœï¼š\n\n```\n//in video_refresh\nif (is->step && !is->paused)\n    stream_toggle_pause(is);\n```\n\nè¿™æ ·seekçš„å¤„ç†å°±å®Œæˆäº†ã€‚\n\nå‰é¢seekã€æš‚åœã€æ¢å¤éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨ffmpegçš„å‡½æ•°ï¼Œè¾…åŠ©ä¸€äº›æµç¨‹æ§åˆ¶å®Œæˆå°è£…ã€‚\n\nè€Œè¯»å–ç¼“å†²åŒºçš„æ§åˆ¶å¯ä»¥è¯´æ˜¯ffplayåŸç”Ÿçš„ç‰¹æ€§äº†ã€‚\n\næ˜¯å¦éœ€è¦æ§åˆ¶ç¼“å†²åŒºå¤§å°ç”±å˜é‡infinite_bufferå†³å®šã€‚infinite_bufferä¸º1è¡¨ç¤ºå½“å‰bufferæ— é™å¤§ï¼Œä¸éœ€è¦ä½¿ç”¨ç¼“å†²åŒºé™åˆ¶ç­–ç•¥ã€‚\n\ninfinite_bufferæ˜¯å¯é€‰é€‰é¡¹ï¼Œä½†åœ¨æ–‡ä»¶æ˜¯å®æ—¶åè®®æ—¶ï¼Œä¸”ç”¨æˆ·æœªæŒ‡å®šæ—¶ï¼Œè¿™ä¸ªå€¼ä¼šè¢«å¼ºåˆ¶ä¸º1ï¼š\n\n```c\nstatic int is_realtime(AVFormatContext *s)\n{\n    if(   !strcmp(s->iformat->name, \"rtp\")\n       || !strcmp(s->iformat->name, \"rtsp\")\n       || !strcmp(s->iformat->name, \"sdp\")\n    )\n        return 1;\n\n    if(s->pb && (   !strncmp(s->url, \"rtp:\", 4)\n                 || !strncmp(s->url, \"udp:\", 4)\n                )\n    )\n        return 1;\n    return 0;\n}\n\nâ€¦â€¦\nis->realtime = is_realtime(ic);\nâ€¦â€¦\nif (infinite_buffer < 0 && is->realtime)\n    infinite_buffer = 1;\n```\n\næˆ‘ä»¬çœ‹ä¸‹éœ€æ§åˆ¶ç¼“å†²åŒºå¤§å°çš„æƒ…å†µï¼š\n\n```c\nif (infinite_buffer<1 &&\n    (is->audioq.size + is->videoq.size + is->subtitleq.size > MAX_QUEUE_SIZE\n    || (stream_has_enough_packets(is->audio_st, is->audio_stream, &is->audioq) &&\n        stream_has_enough_packets(is->video_st, is->video_stream, &is->videoq) &&\n        stream_has_enough_packets(is->subtitle_st, is->subtitle_stream, &is->subtitleq)))) {\n    /* wait 10 ms */\n    SDL_LockMutex(wait_mutex);\n    SDL_CondWaitTimeout(is->continue_read_thread, wait_mutex, 10);\n    SDL_UnlockMutex(wait_mutex);\n    continue;\n}\n```\n\nç¼“å†²åŒºæ»¡æœ‰ä¸¤ç§å¯èƒ½ï¼š\n\n1. audioqï¼Œvideoqï¼Œsubtitleqä¸‰ä¸ªPacketQueueçš„æ€»å­—èŠ‚æ•°è¾¾åˆ°äº†MAX_QUEUE_SIZEï¼ˆ15Mï¼‰\n2. éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•æµéƒ½å·²æœ‰å¤Ÿç”¨çš„åŒ…ï¼ˆstream_has_enough_packetsï¼‰\n\nç¬¬ä¸€ç§å¥½ç†è§£ï¼Œçœ‹ä¸‹ç¬¬äºŒç§ä¸­çš„stream_has_enough_packetsï¼š\n\n```c\nstatic int stream_has_enough_packets(AVStream *st, int stream_id, PacketQueue *queue) {\n    return stream_id < 0 ||\n           queue->abort_request ||\n           (st->disposition & AV_DISPOSITION_ATTACHED_PIC) ||\n           queue->nb_packets > MIN_FRAMES && (!queue->duration || av_q2d(st->time_base) * queue->duration > 1.0);\n}\n```\n\nåœ¨æ»¡è¶³PacketQueueæ€»æ—¶é•¿ä¸º0ï¼Œæˆ–æ€»æ—¶é•¿è¶…è¿‡1sçš„å‰æä¸‹ï¼š\n\næœ‰è¿™ä¹ˆå‡ ç§æƒ…å†µåŒ…æ˜¯å¤Ÿç”¨çš„ï¼š\n\n1. æµæ²¡æœ‰æ‰“å¼€ï¼ˆstream_id < 0ï¼‰\n2. æœ‰é€€å‡ºè¯·æ±‚ï¼ˆqueue->abort_requestï¼‰\n3. é…ç½®äº†AV_DISPOSITION_ATTACHED_PICï¼Ÿï¼ˆè¿™ä¸ªè¿˜ä¸ç†è§£ï¼Œåç»­åˆ†æattachementæ—¶å›å¤´çœ‹çœ‹ï¼‰\n4. é˜Ÿåˆ—å†…åŒ…ä¸ªæ•°å¤§äºMIN_FRAMESï¼ˆ=25ï¼‰\n\næŒºé¥¶åœ°ï¼Œæ²¡æœ‰æ·±åˆ»ä½“ä¼šå…¶è®¾è®¡ç”¨æ„ï¼Œä¸è¯„è®ºã€‚\n\nä¸Šè¿°çš„å‡ ç§å¤„ç†éƒ½è¿˜æ˜¯åœ¨æ­£å¸¸æ’­æ”¾æµç¨‹å†…ï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹æ’­æ”¾å·²å®Œæˆæƒ…å†µçš„å¤„ç†ã€‚\n\n```c\nif (!is->paused &&\n    (!is->audio_st || (is->auddec.finished == is->audioq.serial && frame_queue_nb_remaining(&is->sampq) == 0)) &&\n    (!is->video_st || (is->viddec.finished == is->videoq.serial && frame_queue_nb_remaining(&is->pictq) == 0))) {\n    if (loop != 1 && (!loop || --loop)) {\n        stream_seek(is, start_time != AV_NOPTS_VALUE ? start_time : 0, 0, 0);\n    } else if (autoexit) {\n        ret = AVERROR_EOF;\n        goto fail;\n    }\n}\n```\n\nè¿™é‡Œåˆ¤æ–­æ’­æ”¾å·²å®Œæˆçš„æ¡ä»¶ä¾ç„¶å¾ˆâ€œffplayâ€ï¼Œéœ€è¦æ»¡è¶³ï¼š\n\n1. ä¸åœ¨æš‚åœçŠ¶æ€\n2. éŸ³é¢‘æœªæ‰“å¼€ï¼Œæˆ–è€…æ‰“å¼€äº†ï¼Œä½†æ˜¯è§£ç å·²è§£ç å®Œæ¯•ï¼Œserialç­‰äºPacketQueueçš„serialï¼Œå¹¶ä¸”PacketQueueä¸­æ²¡æœ‰èŠ‚ç‚¹äº†\n3. è§†é¢‘æœªæ‰“å¼€ï¼Œæˆ–è€…æ‰“å¼€äº†ï¼Œä½†æ˜¯è§£ç å·²è§£ç å®Œæ¯•ï¼Œserialç­‰äºPacketQueueçš„serialï¼Œå¹¶ä¸”PacketQueueä¸­æ²¡æœ‰èŠ‚ç‚¹äº†\n\nåœ¨ç¡®è®¤å·²ç»“æŸçš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·æœ‰ä¸¤ä¸ªå˜é‡å¯ä»¥æ§åˆ¶æ’­æ”¾å™¨è¡Œä¸ºï¼š\n\n1. loop: æ§åˆ¶æ’­æ”¾æ¬¡æ•°ï¼ˆå½“å‰è¿™æ¬¡ä¹Ÿç®—åœ¨å†…ï¼Œä¹Ÿå°±æ˜¯æœ€å°å°±æ˜¯1æ¬¡äº†ï¼‰ï¼Œ0è¡¨ç¤ºæ— é™æ¬¡\n2. autoexitï¼šè‡ªåŠ¨é€€å‡ºï¼Œä¹Ÿå°±æ˜¯æ’­æ”¾å®Œæˆåè‡ªåŠ¨é€€å‡ºã€‚\n\nloopæ¡ä»¶ç®€åŒ–çš„éå¸¸ä¸å‹å¥½ï¼Œå…¶æ„æ€æ˜¯ï¼šå¦‚æœloop==1ï¼Œé‚£ä¹ˆå·²ç»æ’­äº†1æ¬¡äº†ï¼Œæ— éœ€å†seeké‡æ–°æ’­æ”¾ï¼›å¦‚æœloopä¸æ˜¯1ï¼Œ==0ï¼Œéšæ„ï¼Œæ— é™æ¬¡å¾ªç¯ï¼›å‡1åè¿˜å¤§äº0ï¼ˆ--loopï¼‰ï¼Œä¹Ÿå…è®¸å¾ªç¯ã€‚ä¹Ÿå°±æ˜¯ï¼š\n\n```c\nstatic int allow_loop() {\n    if (loop == 1)\n        return 0;\n\n    if (loop == 0)\n        return 1;\n\n    --loop;\n    if (loop > 0)\n        return 1;\n\n    return 0;\n}\n```\n\nå‰é¢è®²äº†å¾ˆå¤šè¯»çº¿ç¨‹ä¸»å¾ªç¯å†…çš„å¤„ç†ï¼Œæ¯”å¦‚æš‚åœã€seekã€ç»“æŸloopå¤„ç†ç­‰ï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹çœŸæ­£è¯»çš„ä»£ç ï¼š\n\n```c\nret = av_read_frame(ic, pkt);\nif (ret < 0) {\n    //æ–‡ä»¶è¯»å–å®Œäº†ï¼Œè°ƒç”¨packet_queue_put_nullpacketé€šçŸ¥è§£ç çº¿ç¨‹\n    if ((ret == AVERROR_EOF || avio_feof(ic->pb)) && !is->eof) {\n        if (is->video_stream >= 0)\n            packet_queue_put_nullpacket(&is->videoq, is->video_stream);\n        if (is->audio_stream >= 0)\n            packet_queue_put_nullpacket(&is->audioq, is->audio_stream);\n        if (is->subtitle_stream >= 0)\n            packet_queue_put_nullpacket(&is->subtitleq, is->subtitle_stream);\n        is->eof = 1;\n    }\n    //å‘ç”Ÿé”™è¯¯äº†ï¼Œé€€å‡ºä¸»å¾ªç¯\n    if (ic->pb && ic->pb->error)\n        break;\n\n    //å¦‚æœéƒ½ä¸æ˜¯ï¼Œå¯èƒ½åªæ˜¯è¦ç­‰ä¸€ç­‰\n    SDL_LockMutex(wait_mutex);\n    SDL_CondWaitTimeout(is->continue_read_thread, wait_mutex, 10);\n    SDL_UnlockMutex(wait_mutex);\n    continue;\n} else {\n    is->eof = 0;\n}\n\n/* check if packet is in play range specified by user, then queue, otherwise discard */\nstream_start_time = ic->streams[pkt->stream_index]->start_time;\npkt_ts = pkt->pts == AV_NOPTS_VALUE ? pkt->dts : pkt->pts;\npkt_in_play_range = duration == AV_NOPTS_VALUE ||\n        (pkt_ts - (stream_start_time != AV_NOPTS_VALUE ? stream_start_time : 0)) *\n        av_q2d(ic->streams[pkt->stream_index]->time_base) -\n        (double)(start_time != AV_NOPTS_VALUE ? start_time : 0) / 1000000\n        <= ((double)duration / 1000000);\n\n//å¦‚æœåœ¨æ—¶é—´èŒƒå›´å†…ï¼Œé‚£ä¹ˆæ ¹æ®stream_indexï¼Œæ”¾å…¥åˆ°è§†é¢‘ã€éŸ³é¢‘ã€ä¼šå­—å¹•çš„PacketQueueä¸­\nif (pkt->stream_index == is->audio_stream && pkt_in_play_range) {\n    packet_queue_put(&is->audioq, pkt);\n} else if (pkt->stream_index == is->video_stream && pkt_in_play_range\n           && !(is->video_st->disposition & AV_DISPOSITION_ATTACHED_PIC)) {\n    packet_queue_put(&is->videoq, pkt);\n} else if (pkt->stream_index == is->subtitle_stream && pkt_in_play_range) {\n    packet_queue_put(&is->subtitleq, pkt);\n} else {\n    av_packet_unref(pkt);\n}\n```\n\nçœ‹èµ·æ¥å¾ˆé•¿ï¼Œå®é™…æ¯”ä¸Šè¿°å„ç§ç‰¹æ®Šæµç¨‹çš„å¤„ç†éƒ½ç›´ç™½ï¼Œä¸»è¦ä¸ºï¼š\n\n1. av_read_frameè¯»å–ä¸€ä¸ªåŒ…(AVPacket)\n2. è¿”å›å€¼å¤„ç†\n3. pkt_in_play_rangeè®¡ç®—\n4. packet_queue_putæ”¾å…¥å„è‡ªé˜Ÿåˆ—ï¼Œæˆ–è€…ä¸¢å¼ƒ\n\næ­¥éª¤1ã€æ­¥éª¤2ã€æ­¥éª¤4ï¼Œéƒ½æ¯”è¾ƒç›´æ¥ï¼Œçœ‹æ³¨é‡Šå³å¯ã€‚\n\nè¿™é‡Œçœ‹ä¸‹pkt_in_play_rangeçš„è®¡ç®—ï¼Œæˆ‘ä»¬æŠŠä»¥ä¸Šä»£ç åˆ†è§£ä¸‹ï¼š\n\n```c\nint64_t get_stream_start_time(AVFormatContext* ic, int index) {\n    int64_t stream_start_time = ic->streams[index]->start_time;\n    return stream_start_time != AV_NOPTS_VALUE ? stream_start_time : 0;\n}\n\nint64_t get_pkt_ts(AVPacket* pkt) {//ts: timestampï¼ˆæ—¶é—´æˆ³ï¼‰çš„ç¼©å†™\n    return pkt->pts == AV_NOPTS_VALUE ? pkt->dts : pkt->pts;\n}\n\ndouble ts_as_second(int64_t tsï¼ŒAVFormatContext* icï¼Œint index) {\n    return ts * av_q2d(ic->streams[index]->time_base);\n} \n\ndouble get_ic_start_time(AVFormatContext* ic) {//icä¸­çš„æ—¶é—´å•ä½æ˜¯us\n    return (start_time != AV_NOPTS_VALUE ? start_time : 0) / 1000000;\n}\n```\n\næœ‰äº†è¿™äº›å‡½æ•°ï¼Œå°±å¯ä»¥è®¡ç®—pkt_in_play_rangeäº†ï¼š\n\n```c\nint is_pkt_in_play_range(AVFormatContext* ic, AVPacket* pkt) {\n    if (duration == AV_NOPTS_VALUE) //å¦‚æœå½“å‰æµæ— æ³•è®¡ç®—æ€»æ—¶é•¿ï¼ŒæŒ‰æ— é™æ—¶é•¿å¤„ç†\n        return 1;\n\n    //è®¡ç®—pktç›¸å¯¹streamä½ç½®\n    int64_t stream_ts = get_pkt_ts(pkt) - get_stream_start_time(ic, pkt->stream_index);\n    double stream_ts_s = ts_as_second(stream_ts, ic, pkt->stream_index);\n\n    //è®¡ç®—pktç›¸å¯¹icä½ç½®\n    double ic_ts = stream_ts_s - get_ic_start_time(ic);\n\n    //æ˜¯å¦åœ¨æ—¶é—´èŒƒå›´å†…\n    return ic_ts <= ((double)duration / 1000000);\n}\n```\n","slug":"ffmpeg/2022-03-20-ffplay read_thread åˆ†æ","published":1,"updated":"2024-03-06T11:53:13.566Z","comments":1,"photos":[],"_id":"clti3glkr002957wh8h4h6hfp","content":"<p>å‚è€ƒï¼š <a href=\"https://zhuanlan.zhihu.com/p/43672062\">ffplay readçº¿ç¨‹åˆ†æ</a></p>\n<blockquote>\n<p>ffplay main å‡½æ•° åšäº†ä»€ä¹ˆ</p>\n</blockquote>\n<ol>\n<li><p>å‚æ•°éªŒè¯ä¸è§£æ</p>\n</li>\n<li><p>æ³¨å†Œcodecsï¼Œ demuxï¼Œ protocols</p>\n</li>\n<li><p>sdl åˆå§‹åŒ–ï¼Œåˆ›å»ºçª—å£</p>\n</li>\n<li><p>è°ƒç”¨stream_openæ‰“å¼€æµ</p>\n</li>\n<li><p>è°ƒç”¨event_loopè¿›å…¥è¿è¡Œå¾ªç¯</p>\n</li>\n</ol>\n<blockquote>\n<p>stream_open åšäº†ä»€ä¹ˆ</p>\n</blockquote>\n<p>Â Â Â Â ä¸»è¦æ˜¯åˆå§‹åŒ–VideoState *isï¼Œå¡«å……å…³é”®ä¿¡æ¯</p>\n<ol>\n<li><p>åˆå§‹åŒ–ï¼Œåˆ†é…å†…å­˜<code>is = av_mallocz(sizeof(VideoState));</code></p>\n</li>\n<li><p>è°ƒç”¨frame_queue_initç»™VideoStateå¯¹åº”çš„éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”Frameé˜Ÿåˆ—åˆå§‹åŒ–åˆ†é…å†…å­˜</p>\n</li>\n<li><p>è°ƒç”¨packet_queue_initç»™VideoStateå¯¹åº”çš„éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”Packeté˜Ÿåˆ—åˆå§‹åŒ–åˆ†é…å†…å­˜</p>\n</li>\n<li><p>åˆ›å»ºæ¡ä»¶å˜é‡continue_read_threadï¼Œ ç”¨äºæ§åˆ¶æ˜¯å¦ç»§ç»­è¯»å–æˆ–è€…ç­‰å¾…</p>\n</li>\n<li><p>è°ƒç”¨init_clock åˆå§‹åŒ–éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå¤–éƒ¨æ—¶é’Ÿ</p>\n</li>\n<li><p>è®¾ç½®åŒæ­¥ç±»å‹av_sync_type</p>\n</li>\n<li><p>åˆ›å»ºå¹¶å¼€å¯read_thread</p>\n</li>\n</ol>\n<h2 id=\"read-thread\"><a href=\"#read-thread\" class=\"headerlink\" title=\"read_thread\"></a>read_thread</h2><p>åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p>\n<ol>\n<li><p>å‡†å¤‡é˜¶æ®µ</p>\n</li>\n<li><p>å¾ªç¯è¯»pkt</p>\n</li>\n</ol>\n<p>å‡†å¤‡é˜¶æ®µï¼š</p>\n<p>stream_open å¯¹VideoState *is åšäº†åˆå§‹åŒ–å…³é”®å‚æ•°çš„å¡«å……ã€‚read_thread åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæ‰“å¼€è¾“å…¥çš„æµï¼Œè§£å°è£…ï¼Œè¯»å–æµçš„ä¿¡æ¯ï¼Œæ‰¾åˆ°éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”çš„streamï¼Œè¯»å–è§£ç å‚æ•°ï¼Œåˆ›å»ºè§£ç å™¨ï¼Œå¼€å¯è§£ç å™¨ã€‚åˆ†åˆ«ä¸ºéŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¼€å¯åˆ›å»ºè§£ç çº¿ç¨‹ã€‚</p>\n<p>å¾ªç¯è¯»pktï¼š</p>\n<p>ç„¶åè¿›å…¥å¾ªç¯ï¼Œä»æµä¸­è¯»å–pktï¼Œæ ¹æ®åŒæ­¥æ—¶é’Ÿï¼Œæ”¾å…¥pkté˜Ÿåˆ—æˆ–è€…ä¸¢å¼ƒã€‚å¦‚æœè¯»ç»“æŸï¼Œç»™pkté˜Ÿåˆ—æ”¾å…¥ç©ºåŒ…ï¼Œç”¨äºå†²æ´—è§£ç å™¨ã€‚</p>\n<p>å¾ªç¯ä¸­è¿˜è¦å¤„ç†ç»ˆæ­¢æš‚åœæ¢å¤äº‹ä»¶ï¼Œseekäº‹ä»¶ï¼Œæ ¹æ®é˜Ÿåˆ—çš„çŠ¶æ€ï¼ˆæ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®ï¼‰æ§åˆ¶ç­‰å¾…è¿˜æ˜¯ç»§ç»­è¯»å–æ–°çš„pktã€‚</p>\n<h3 id=\"å‡†å¤‡é˜¶æ®µ\"><a href=\"#å‡†å¤‡é˜¶æ®µ\" class=\"headerlink\" title=\"å‡†å¤‡é˜¶æ®µ\"></a>å‡†å¤‡é˜¶æ®µ</h3><p>æ‰“å¼€æ–‡ä»¶ï¼Œè§£å°è£…ï¼Œè·å–æ–‡ä»¶ä¿¡æ¯</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\">VideoState *is = arg;<br>AVFormatContext *ic = <span class=\"hljs-literal\">NULL</span>;<br><span class=\"hljs-comment\">//åˆ›å»ºAVFormatContext</span><br>ic = avformat_alloc_context();<br><span class=\"hljs-comment\">//interrupt_callbackç”¨äºffmpegå†…éƒ¨åœ¨æ‰§è¡Œè€—æ—¶æ“ä½œæ—¶æ£€æŸ¥æ˜¯å¦æœ‰é€€å‡ºè¯·æ±‚ï¼Œå¹¶æå‰ä¸­æ–­ï¼Œé¿å…ç”¨æˆ·é€€å‡ºè¯·æ±‚æ²¡æœ‰åŠæ—¶å“åº”</span><br>ic-&gt;interrupt_callback.callback = decode_interrupt_cb;<br>ic-&gt;interrupt_callback.opaque = is;<br><span class=\"hljs-comment\">//ç‰¹å®šé€‰é¡¹å¤„ç†</span><br><span class=\"hljs-keyword\">if</span> (!av_dict_get(format_opts, <span class=\"hljs-string\">&quot;scan_all_pmts&quot;</span>, <span class=\"hljs-literal\">NULL</span>, AV_DICT_MATCH_CASE)) &#123;<br>    av_dict_set(&amp;format_opts, <span class=\"hljs-string\">&quot;scan_all_pmts&quot;</span>, <span class=\"hljs-string\">&quot;1&quot;</span>, AV_DICT_DONT_OVERWRITE);<br>    scan_all_pmts_set = <span class=\"hljs-number\">1</span>;<br>&#125;<br><span class=\"hljs-comment\">//æ‰“å¼€è¾“å…¥çš„æµï¼Œè¯»å–æµçš„å¤´éƒ¨ä¿¡æ¯</span><br>err = avformat_open_input(&amp;ic, is-&gt;filename, is-&gt;iformat, &amp;format_opts);<br><span class=\"hljs-comment\">//ä¿å­˜AVFormatContext</span><br>is-&gt;ic = ic;<br><span class=\"hljs-keyword\">if</span> (find_stream_info) &#123;<br>    <span class=\"hljs-comment\">//å¦‚æœæ–‡ä»¶ä¸åŒ…å«å¤´éƒ¨ä¿¡æ¯(å¦‚ts)ï¼Œé€šè¿‡è¯»å–ä¸€æ®µæ–‡ä»¶åˆ†æåå¾—åˆ°æµä¿¡æ¯</span><br>    err = avformat_find_stream_info(ic, opts);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åˆ¤æ–­æ˜¯å¦æ˜¯å®æ—¶æµ</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//æ˜¯å¦æ˜¯å®æ—¶æµrtp/rtsp/sdpç­‰</span><br>is-&gt;realtime = is_realtime(ic);<br></code></pre></td></tr></table></figure>\n\n<p>is_realtime å‡½æ•°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">is_realtime</span><span class=\"hljs-params\">(AVFormatContext *s)</span><br>&#123;<br>    <span class=\"hljs-keyword\">if</span>(   !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;rtp&quot;</span>)<br>       || !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;rtsp&quot;</span>)<br>       || !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;sdp&quot;</span>)<br>    )<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-keyword\">if</span>(s-&gt;pb &amp;&amp; (   !<span class=\"hljs-built_in\">strncmp</span>(s-&gt;url, <span class=\"hljs-string\">&quot;rtp:&quot;</span>, <span class=\"hljs-number\">4</span>)<br>                 || !<span class=\"hljs-built_in\">strncmp</span>(s-&gt;url, <span class=\"hljs-string\">&quot;udp:&quot;</span>, <span class=\"hljs-number\">4</span>)<br>                )<br>    )<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>é€‰æ‹©éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•æµã€‚å®é™…æ“ä½œä¸­ï¼Œé€‰æ‹©çš„ç­–ç•¥å¾ˆå¤šï¼Œä¸€èˆ¬æ ¹æ®å…·ä½“éœ€æ±‚æ¥å®šâ€”â€”æ¯”å¦‚å¯ä»¥æ˜¯é€‰æ‹©æœ€é«˜æ¸…çš„è§†é¢‘æµï¼›é€‰æ‹©æœ¬åœ°è¯­è¨€çš„éŸ³é¢‘æµï¼›ç›´æ¥é€‰æ‹©ç¬¬ä¸€æ¡è§†é¢‘ã€éŸ³é¢‘è½¨é“ï¼›ç­‰ç­‰ã€‚</p>\n<p>ffplayä¸»è¦æ˜¯é€šè¿‡<code>av_find_best_stream</code>æ¥é€‰æ‹©ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//å¦‚æœç”¨æˆ·é€šè¿‡wanted_stream_specæŒ‡å®šäº†æµï¼Œæ‰¾åˆ°ç”¨æˆ·é€‰æ‹©çš„æµ</span><br><span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; ic-&gt;nb_streams; i++) &#123;<br>    AVStream *st = ic-&gt;streams[i];<br>    <span class=\"hljs-class\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title\">AVMediaType</span> <span class=\"hljs-title\">type</span> =</span> st-&gt;codecpar-&gt;codec_type;<br>    st-&gt;discard = AVDISCARD_ALL;<br>    <span class=\"hljs-keyword\">if</span> (type &gt;= <span class=\"hljs-number\">0</span> &amp;&amp; wanted_stream_spec[type] &amp;&amp; st_index[type] == <span class=\"hljs-number\">-1</span>)<br>        <span class=\"hljs-keyword\">if</span> (avformat_match_stream_specifier(ic, st, wanted_stream_spec[type]) &gt; <span class=\"hljs-number\">0</span>)<br>            st_index[type] = i;<br>&#125;<br><span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; AVMEDIA_TYPE_NB; i++) &#123;<br>    <span class=\"hljs-keyword\">if</span> (wanted_stream_spec[i] &amp;&amp; st_index[i] == <span class=\"hljs-number\">-1</span>) &#123;<br>        <span class=\"hljs-comment\">//å¤„ç†æ‰¾ä¸åˆ°ç”¨æˆ·é€‰æ‹©çš„æµçš„æƒ…å†µ</span><br>        av_log(<span class=\"hljs-literal\">NULL</span>, AV_LOG_ERROR, <span class=\"hljs-string\">&quot;Stream specifier %s does not match any %s stream\\n&quot;</span>, wanted_stream_spec[i], av_get_media_type_string(i));<br>        st_index[i] = INT_MAX;<br>    &#125;<br>&#125;<br><br><span class=\"hljs-comment\">//è·å–video stream</span><br><span class=\"hljs-keyword\">if</span> (!video_disable)<br>    st_index[AVMEDIA_TYPE_VIDEO] =<br>        av_find_best_stream(ic, AVMEDIA_TYPE_VIDEO,<br>                            st_index[AVMEDIA_TYPE_VIDEO], <span class=\"hljs-number\">-1</span>, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>);<br><span class=\"hljs-comment\">//è·å–audio streamï¼Œå‚è€ƒè§†é¢‘æµé€‰æ‹©</span><br><span class=\"hljs-keyword\">if</span> (!audio_disable)<br>    st_index[AVMEDIA_TYPE_AUDIO] =<br>        av_find_best_stream(ic, AVMEDIA_TYPE_AUDIO,<br>                            st_index[AVMEDIA_TYPE_AUDIO],<br>                            st_index[AVMEDIA_TYPE_VIDEO],<br>                            <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>);<br><span class=\"hljs-comment\">//è·å–subtitle streamï¼Œä¼˜å…ˆå‚è€ƒéŸ³é¢‘æµ</span><br><span class=\"hljs-keyword\">if</span> (!video_disable &amp;&amp; !subtitle_disable)<br>    st_index[AVMEDIA_TYPE_SUBTITLE] =<br>        av_find_best_stream(ic, AVMEDIA_TYPE_SUBTITLE,<br>                            st_index[AVMEDIA_TYPE_SUBTITLE],<br>                            (st_index[AVMEDIA_TYPE_AUDIO] &gt;= <span class=\"hljs-number\">0</span> ?<br>                             st_index[AVMEDIA_TYPE_AUDIO] :<br>                             st_index[AVMEDIA_TYPE_VIDEO]),<br>                            <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>);<br></code></pre></td></tr></table></figure>\n\n<p>wanted_stream_specé€šè¿‡mainå‡½æ•°ä¼ å‚è®¾å®šï¼Œæ ¼å¼å¯ä»¥æœ‰å¾ˆå¤šç§ï¼Œå‚è€ƒ<a href=\"https://www.ffmpeg.org/ffplay.html#Stream-specifiers-1\">å®˜æ–¹æ–‡æ¡£</a></p>\n<p>å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šæµï¼Œæˆ–æŒ‡å®šéƒ¨åˆ†æµï¼Œæˆ–æŒ‡å®šæµä¸å­˜åœ¨ï¼Œåˆ™ä¸»è¦ç”±av_find_best_streamå‘æŒ¥ä½œç”¨ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">av_find_best_stream</span><span class=\"hljs-params\">(AVFormatContext *ic,</span><br><span class=\"hljs-params\">                        <span class=\"hljs-keyword\">enum</span> AVMediaType type,<span class=\"hljs-comment\">//è¦é€‰æ‹©çš„æµç±»å‹</span></span><br><span class=\"hljs-params\">                        <span class=\"hljs-type\">int</span> wanted_stream_nb,<span class=\"hljs-comment\">//ç›®æ ‡æµç´¢å¼•</span></span><br><span class=\"hljs-params\">                        <span class=\"hljs-type\">int</span> related_stream,<span class=\"hljs-comment\">//å‚è€ƒæµç´¢å¼•</span></span><br><span class=\"hljs-params\">                        AVCodec **decoder_ret,</span><br><span class=\"hljs-params\">                        <span class=\"hljs-type\">int</span> flags)</span>;<br></code></pre></td></tr></table></figure>\n\n<p>å¦‚æœæŒ‡å®šäº†æ­£ç¡®çš„wanted_stream_nbï¼Œä¸€èˆ¬æƒ…å†µéƒ½æ˜¯ç›´æ¥è¿”å›è¯¥æŒ‡å®šæµï¼Œå³ç”¨æˆ·é€‰æ‹©çš„æµã€‚å¦‚æœæŒ‡å®šäº†å‚è€ƒæµï¼Œä¸”æœªæŒ‡å®šç›®æ ‡æµçš„æƒ…å†µï¼Œä¼šæ ¹æ®å‚è€ƒæµå»æŸ¥æ‰¾æ‰€éœ€ç±»å‹çš„æµï¼Œä½†ä¸€èˆ¬ç»“æœï¼Œéƒ½æ˜¯è¿”å›è¯¥ç±»å‹ç¬¬ä¸€ä¸ªæµã€‚</p>\n<p>å·²ç»è·å–äº†æµä¿¡æ¯ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯åˆ›å»ºè§£ç å™¨ï¼Œå¼€å¯è§£ç çº¿ç¨‹ã€‚ </p>\n<p>ä¸»è¦åœ¨<code>stream_component_open</code>æ–¹æ³•ä¸­å®ç°, ç®€åŒ–ä»£ç å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">stream_component_open</span><span class=\"hljs-params\">(VideoState *is, <span class=\"hljs-type\">int</span> stream_index)</span><br>&#123;<br>    <span class=\"hljs-comment\">//åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡</span><br>    avctx = avcodec_alloc_context3(<span class=\"hljs-literal\">NULL</span>);        <br>    <span class=\"hljs-comment\">//å¡«å……è§£ç å‚æ•°</span><br>    ret = avcodec_parameters_to_context(avctx, ic-&gt;streams[stream_index]-&gt;codecpar);<br>    <span class=\"hljs-comment\">//è®¾ç½®è§£ç å™¨çš„æ—¶é—´åŸºï¼Œç­‰äºstreamçš„æ—¶é—´åŸº</span><br>    avctx-&gt;pkt_timebase = ic-&gt;streams[stream_index]-&gt;time_base;<br>    <span class=\"hljs-comment\">//æ‰¾è§£ç å™¨</span><br>    codec = avcodec_find_decoder(avctx-&gt;codec_id);<br>    <span class=\"hljs-keyword\">if</span> (forced_codec_name)<br>        <span class=\"hljs-comment\">//å¦‚æœç”¨æˆ·æŒ‡å®šäº†è§£ç å™¨ï¼Œä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„è§£ç å™¨</span><br>        codec = avcodec_find_decoder_by_name(forced_codec_name);<br>    <span class=\"hljs-comment\">//æ‰“å¼€è§£ç å™¨</span><br>    <span class=\"hljs-keyword\">if</span> ((ret = avcodec_open2(avctx, codec, &amp;opts)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-keyword\">goto</span> fail;<br>    &#125;<br>    <span class=\"hljs-keyword\">switch</span> (avctx-&gt;codec_type) &#123;<br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_AUDIO:<br>        <span class=\"hljs-comment\">//æ‰“å¼€éŸ³é¢‘æ’­æ”¾å™¨</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = audio_open(is, channel_layout, nb_channels, sample_rate, &amp;is-&gt;audio_tgt)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        <span class=\"hljs-comment\">//ç»™is-&gt;auddecåˆå§‹åŒ–</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_init(&amp;is-&gt;auddec, avctx, &amp;is-&gt;audioq, is-&gt;continue_read_thread)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        <span class=\"hljs-comment\">//å¼€å¯éŸ³é¢‘è§£ç çº¿ç¨‹</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_start(&amp;is-&gt;auddec, audio_thread, <span class=\"hljs-string\">&quot;audio_decoder&quot;</span>, is)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> out;<br>        <span class=\"hljs-comment\">//æš‚åœéŸ³é¢‘æ’­æ”¾å™¨</span><br>        SDL_PauseAudioDevice(audio_dev, <span class=\"hljs-number\">0</span>);<br>        <span class=\"hljs-keyword\">break</span>;<br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_VIDEO:<br>        is-&gt;video_stream = stream_index;<br>        is-&gt;video_st = ic-&gt;streams[stream_index];<br>        <span class=\"hljs-comment\">//ç»™is-&gt;viddecåˆå§‹åŒ–</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_init(&amp;is-&gt;viddec, avctx, &amp;is-&gt;videoq, is-&gt;continue_read_thread)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        <span class=\"hljs-comment\">//å¼€å¯è§†é¢‘è§£ç çº¿ç¨‹</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_start(&amp;is-&gt;viddec, video_thread, <span class=\"hljs-string\">&quot;video_decoder&quot;</span>, is)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> out;<br>        is-&gt;queue_attachments_req = <span class=\"hljs-number\">1</span>;<br>        <span class=\"hljs-keyword\">break</span>;<br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_SUBTITLE:<br>        is-&gt;subtitle_stream = stream_index;<br>        is-&gt;subtitle_st = ic-&gt;streams[stream_index];<br>        <span class=\"hljs-comment\">//åˆå§‹åŒ–å­—å¹•è§£ç </span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_init(&amp;is-&gt;subdec, avctx, &amp;is-&gt;subtitleq, is-&gt;continue_read_thread)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        <span class=\"hljs-comment\">//å¼€å¯å­—å¹•è§£ç çº¿ç¨‹</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_start(&amp;is-&gt;subdec, subtitle_thread, <span class=\"hljs-string\">&quot;subtitle_decoder&quot;</span>, is)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> out;<br>        <span class=\"hljs-keyword\">break</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//....</span><br>    <span class=\"hljs-keyword\">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>é’ˆå¯¹éŸ³é¢‘ï¼Œéœ€è¦å¦å¤–å¤„ç†éŸ³é¢‘æ’­æ”¾å™¨çš„åˆå§‹åŒ–ï¼Œæš‚åœçŠ¶æ€ã€‚</p>\n<p>å¯¹éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•ï¼Œè°ƒç”¨<code>decoder_init</code>åˆå§‹åŒ–Decoderï¼Œ è°ƒç”¨<code>decoder_start</code>å¼€å¯å¯¹åº”çš„è§£ç çº¿ç¨‹ã€‚</p>\n<p>decoder_init</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static int decoder_init(Decoder *d, AVCodecContext *avctx, PacketQueue *queue, SDL_cond *empty_queue_cond) &#123;<br>    memset(d, <span class=\"hljs-number\">0</span>, sizeof(Decoder));<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>pkt = av_packet_alloc();<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (!d-&gt;</span>pkt)<br>        return AVERROR(ENOMEM);<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>avctx = avctx;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>queue = queue;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>empty_queue_cond = empty_queue_cond;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>start_pts = AV_NOPTS_VALUE;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>pkt_serial = -<span class=\"hljs-number\">1</span>;<br>    return <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>decoder_start</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title\">decoder_start</span><span class=\"hljs-params\">(Decoder *d, <span class=\"hljs-type\">int</span> (*fn)(<span class=\"hljs-type\">void</span> *), <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> *thread_name, <span class=\"hljs-type\">void</span>* arg)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    <span class=\"hljs-comment\">//å¼€å¯packet queue</span><br>    <span class=\"hljs-built_in\">packet_queue_start</span>(d-&gt;queue);<br>    <span class=\"hljs-comment\">//å¼€å¯è§£ç çº¿ç¨‹</span><br>    d-&gt;decoder_tid = <span class=\"hljs-built_in\">SDL_CreateThread</span>(fn, thread_name, arg);<br>    <span class=\"hljs-keyword\">if</span> (!d-&gt;decoder_tid) &#123;<br>        <span class=\"hljs-built_in\">av_log</span>(<span class=\"hljs-literal\">NULL</span>, AV_LOG_ERROR, <span class=\"hljs-string\">&quot;SDL_CreateThread(): %s\\n&quot;</span>, <span class=\"hljs-built_in\">SDL_GetError</span>());<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"ä¸»å¾ªç¯è¯»åŒ…\"><a href=\"#ä¸»å¾ªç¯è¯»åŒ…\" class=\"headerlink\" title=\"ä¸»å¾ªç¯è¯»åŒ…\"></a>ä¸»å¾ªç¯è¯»åŒ…</h3><p>ç®€åŒ–ä¸€ä¸‹å¦‚ä¸‹</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\"><span class=\"hljs-keyword\">for</span> (;;) &#123;<br>        <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;</span>abort_request)<br>            break;<span class=\"hljs-comment\">//å¤„ç†é€€å‡ºæ¶ˆæ¯</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">paused</span> != <span class=\"hljs-keyword\">is</span>-&gt;</span>last_paused) &#123;<br>            <span class=\"hljs-comment\">//å¤„ç†æš‚åœä¸æ¢å¤</span><br>            <span class=\"hljs-comment\">//.......</span><br>        &#125;<br><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;</span>seek_req) &#123;<br>            <span class=\"hljs-comment\">//å¤„ç†seekæ“ä½œ</span><br>            <span class=\"hljs-function\"><span class=\"hljs-title\">ret</span> = avformat_seek_file(<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">ic</span>, -1, seek_min, seek_target, seek_max, <span class=\"hljs-keyword\">is</span>-&gt;</span>seek_flags);<br>        &#125;<br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">        æ§åˆ¶é˜Ÿåˆ—å¤§å°</span><br><span class=\"hljs-comment\">        */</span><br>        <span class=\"hljs-keyword\">if</span> (infinite_buffer&lt;<span class=\"hljs-number\">1</span> &amp;&amp;<br>              (<span class=\"hljs-function\"><span class=\"hljs-title\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audioq</span>.size + <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">videoq</span>.size + <span class=\"hljs-keyword\">is</span>-&gt;</span>subtitleq.size &gt; MAX_QUEUE_SIZE<br>            || (<span class=\"hljs-function\"><span class=\"hljs-title\">stream_has_enough_packets</span>(<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audio_st</span>, <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audio_stream</span>, &amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>audioq) &amp;&amp;<br>                <span class=\"hljs-function\"><span class=\"hljs-title\">stream_has_enough_packets</span>(<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">video_st</span>, <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">video_stream</span>, &amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>videoq) &amp;&amp;<br>                <span class=\"hljs-function\"><span class=\"hljs-title\">stream_has_enough_packets</span>(<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">subtitle_st</span>, <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">subtitle_stream</span>, &amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>subtitleq)))) &#123;<br>            <span class=\"hljs-comment\">/* wait 10 ms */</span><br>            SDL_LockMutex(wait_mutex);<br>            SDL_C<span class=\"hljs-function\"><span class=\"hljs-title\">ondWaitTimeout</span>(<span class=\"hljs-keyword\">is</span>-&gt;</span>continue_read_thread, wait_mutex, <span class=\"hljs-number\">10</span>);<br>            SDL_UnlockMutex(wait_mutex);<br>            continue;<br>        &#125;<br>        <span class=\"hljs-comment\">//å¤„ç†å¾ªç¯æ’­æ”¾</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (!<span class=\"hljs-keyword\">is</span>-&gt;</span>paused &amp;&amp;<br>            (!<span class=\"hljs-function\"><span class=\"hljs-title\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audio_st</span> || (<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">auddec</span>.finished == <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audioq</span>.serial &amp;&amp; frame_queue_nb_remaining(&amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>sampq) == <span class=\"hljs-number\">0</span>)) &amp;&amp;<br>            (!<span class=\"hljs-function\"><span class=\"hljs-title\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">video_st</span> || (<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">viddec</span>.finished == <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">videoq</span>.serial &amp;&amp; frame_queue_nb_remaining(&amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>pictq) == <span class=\"hljs-number\">0</span>))) &#123;<br>            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">loop</span> != <span class=\"hljs-number\">1</span> &amp;&amp; (!<span class=\"hljs-keyword\">loop</span> || --<span class=\"hljs-keyword\">loop</span>)) &#123;<br>                stream_seek(<span class=\"hljs-keyword\">is</span>, start_time != AV_NOPTS_VALUE ? start_time : <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>);<br>            &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (autoexit) &#123;<br>                ret = AVERROR_EOF;<br>                goto fail;<br>            &#125;<br>        &#125;<br>        <span class=\"hljs-comment\">//è¯»pkt</span><br>        ret = av_read_frame(ic, pkt);<br><br>        <span class=\"hljs-comment\">//åœ¨æ’­æ”¾åŒºé—´ï¼Œæ”¾å…¥é˜Ÿåˆ—</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">packet_queue_put</span>(&amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>videoq, pkt);<br>        <span class=\"hljs-comment\">//ä¸åœ¨æ’­æ”¾åŒºé—´ï¼Œä¸¢å¼ƒ</span><br>        av_packet_unref(pkt);<br><br>    &#125;<br></code></pre></td></tr></table></figure>\n\n<p>ä¸»è¦çš„ä»£ç å°±<code>av_read_frame</code>å’Œ<code>packet_queue_put</code>ï¼Œ<code>av_read_frame</code>ä»æ–‡ä»¶ä¸­è¯»å–è§†é¢‘æ•°æ®ï¼Œå¹¶è·å–ä¸€ä¸ªAVPacketï¼Œ<code>packet_queue_put</code>æŠŠå®ƒæ”¾å…¥åˆ°å¯¹åº”çš„PacketQueueä¸­ã€‚</p>\n<p>å½“ç„¶ï¼Œè¯»å–è¿‡ç¨‹è¿˜ä¼šæœ‰seekã€pauseã€resumeã€abortç­‰äº‹ä»¶ï¼Œæ‰€ä»¥æœ‰ä¸“é—¨çš„åˆ†æ”¯å¤„ç†è¿™äº›è¯·æ±‚ã€‚</p>\n<p>PacketQueueé»˜è®¤æƒ…å†µä¸‹ä¼šæœ‰å¤§å°é™åˆ¶ï¼Œè¾¾åˆ°è¿™ä¸ªå¤§å°åï¼Œå°±éœ€è¦ç­‰å¾…10msï¼Œä»¥è®©æ¶ˆè´¹è€…â€”â€”è§£ç çº¿ç¨‹èƒ½æœ‰æ—¶é—´æ¶ˆè€—ã€‚</p>\n<p>æ’­æ”¾å®Œæˆåï¼Œä¼šæ ¹æ®loopçš„è®¾ç½®å†³å®šæ˜¯å¦å¾ªç¯ã€‚</p>\n<p>æš‚åœ&#x2F;æ¢å¤çš„å¤„ç†ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (is-&gt;paused != is-&gt;last_paused) &#123;<br>    <span class=\"hljs-comment\">//æ›´æ–°pausedçŠ¶æ€</span><br>    is-&gt;last_paused = is-&gt;paused;<br>    <span class=\"hljs-keyword\">if</span> (is-&gt;paused)<br>        <span class=\"hljs-comment\">//æš‚åœ</span><br>        is-&gt;read_pause_return = av_read_pause(ic);<br>    <span class=\"hljs-keyword\">else</span><br>        <span class=\"hljs-comment\">//æ¢å¤æ’­æ”¾</span><br>        av_read_play(ic);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ffmpegæœ‰ä¸“é—¨é’ˆå¯¹æš‚åœå’Œæ¢å¤çš„å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨å°±å¯ä»¥äº†ã€‚</p>\n<blockquote>\n<p>av_read_pauseå’Œav_read_playå¯¹äºURLProtocolï¼Œä¼šè°ƒç”¨å…¶url_read_pauseï¼Œé€šè¿‡å‚æ•°åŒºåˆ†æ˜¯è¦æš‚åœè¿˜æ˜¯æ¢å¤ã€‚å¯¹äºAVInputFormatä¼šè°ƒç”¨å…¶read_pauseå’Œread_play.<br>ä¸€èˆ¬æƒ…å†µä¸‹URLProtocolå’ŒAVInputFormatéƒ½ä¸éœ€è¦ä¸“é—¨å¤„ç†æš‚åœå’Œæ¢å¤ï¼Œä½†å¯¹äºåƒrtsp&#x2F;rtmpè¿™ç§åœ¨é€šè®¯åè®®ä¸Šæ”¯æŒ(éœ€è¦)æš‚åœã€æ¢å¤çš„å°±ç‰¹åˆ«æœ‰ç”¨äº†ã€‚</p>\n</blockquote>\n<p>å¯¹äºseekçš„å¤„ç†ï¼Œä¼šæ¯”æš‚åœ&#x2F;æ¢å¤ç•¥å¾®å¤æ‚ä¸€äº›ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (is-&gt;seek_req) &#123;<br>    <span class=\"hljs-comment\">//å¤„ç†seekæ“ä½œ</span><br>    <span class=\"hljs-type\">int64_t</span> seek_target = is-&gt;seek_pos;<br>    <span class=\"hljs-type\">int64_t</span> seek_min    = is-&gt;seek_rel &gt; <span class=\"hljs-number\">0</span> ? seek_target - is-&gt;seek_rel + <span class=\"hljs-number\">2</span>: INT64_MIN;<br>    <span class=\"hljs-type\">int64_t</span> seek_max    = is-&gt;seek_rel &lt; <span class=\"hljs-number\">0</span> ? seek_target - is-&gt;seek_rel - <span class=\"hljs-number\">2</span>: INT64_MAX;<br><span class=\"hljs-comment\">// FIXME the +-2 is due to rounding being not done in the correct direction in generation</span><br><span class=\"hljs-comment\">//      of the seek_pos/seek_rel variables</span><br>    <span class=\"hljs-comment\">//seekåˆ°æ­£ç¡®çš„ä½ç½®</span><br>    ret = avformat_seek_file(is-&gt;ic, <span class=\"hljs-number\">-1</span>, seek_min, seek_target, seek_max, is-&gt;seek_flags);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, AV_LOG_ERROR,<br>               <span class=\"hljs-string\">&quot;%s: error while seeking\\n&quot;</span>, is-&gt;ic-&gt;url);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;audio_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-comment\">//æ¸…ç©ºéŸ³é¢‘å¸§é˜Ÿåˆ—</span><br>            packet_queue_flush(&amp;is-&gt;audioq);<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;subtitle_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-comment\">//æ¸…ç©ºå­—å¹•å¸§é˜Ÿåˆ—</span><br>            packet_queue_flush(&amp;is-&gt;subtitleq);<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;video_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-comment\">//æ¸…ç©ºè§†é¢‘å¸§é˜Ÿåˆ—</span><br>            packet_queue_flush(&amp;is-&gt;videoq);<br>        <span class=\"hljs-comment\">//æ›´æ–°clock</span><br>        <span class=\"hljs-keyword\">if</span> (is-&gt;seek_flags &amp; AVSEEK_FLAG_BYTE) &#123;<br>           set_clock(&amp;is-&gt;extclk, NAN, <span class=\"hljs-number\">0</span>);<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>           set_clock(&amp;is-&gt;extclk, seek_target / (<span class=\"hljs-type\">double</span>)AV_TIME_BASE, <span class=\"hljs-number\">0</span>);<br>        &#125;<br>    &#125;<br>    is-&gt;seek_req = <span class=\"hljs-number\">0</span>;<br>    is-&gt;queue_attachments_req = <span class=\"hljs-number\">1</span>;<br>    is-&gt;eof = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-keyword\">if</span> (is-&gt;paused)<br>        step_to_next_frame(is);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ä¸»è¦çš„seekæ“ä½œé€šè¿‡avformat_seek_fileå®Œæˆã€‚æ ¹æ®avformat_seek_fileçš„è¿”å›å€¼ï¼Œå¦‚æœseekæˆåŠŸï¼Œéœ€è¦ï¼š</p>\n<ol>\n<li>æ¸…é™¤PacketQueueçš„ç¼“å­˜ï¼Œå¹¶æ”¾å…¥ä¸€ä¸ªflush_pktã€‚æ”¾å…¥çš„flush_pktå¯ä»¥è®©PacketQueueçš„serialå¢1ï¼Œä»¥åŒºåˆ†seekå‰åçš„æ•°æ®</li>\n<li>åŒæ­¥å¤–éƒ¨æ—¶é’Ÿã€‚åœ¨åç»­éŸ³è§†é¢‘åŒæ­¥çš„æ–‡ç« ä¸­å†å…·ä½“åˆ†æã€‚</li>\n</ol>\n<p>æœ€åæ¸…ç†ä¸€äº›å˜é‡ï¼Œå¹¶ï¼š</p>\n<ol>\n<li>è®¾ç½®queue_attachments_reqä»¥æ˜¾ç¤ºattachmentç”»é¢</li>\n<li>å¦‚æœå½“å‰æ˜¯æš‚åœçŠ¶æ€ï¼Œå°±è·³åˆ°seekåçš„ä¸‹ä¸€å¸§ï¼Œä»¥ç›´è§‚ä½“ç°seekæˆåŠŸäº†</li>\n</ol>\n<p>step_to_next_frame</p>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs livescript\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-literal\">void</span> step_to_next_frame(VideoState *<span class=\"hljs-keyword\">is</span>)<br>&#123;<br>    <span class=\"hljs-comment\">/* if the stream is paused unpause it, then step */</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;paused)<br>        stream_toggle_pause(<span class=\"hljs-keyword\">is</span>);<br>    <span class=\"hljs-keyword\">is</span>-&gt;step = <span class=\"hljs-number\">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åŸä»£ç çš„æ³¨é‡Šæ¯”è¾ƒæ¸…æ™°äº†â€”â€”å…ˆå–æ¶ˆæš‚åœï¼Œç„¶åæ‰§è¡Œstepã€‚å½“è®¾ç½®stepä¸º1åï¼Œæ˜¾ç¤ºçº¿ç¨‹ä¼šæ˜¾ç¤ºå‡ºä¸€å¸§ç”»é¢ï¼Œç„¶åå†æ¬¡è¿›å…¥æš‚åœï¼š</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\"><span class=\"hljs-comment\">//in video_refresh</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">step</span> &amp;&amp; !<span class=\"hljs-keyword\">is</span>-&gt;</span>paused)<br>    stream_toggle_pause(<span class=\"hljs-keyword\">is</span>);<br></code></pre></td></tr></table></figure>\n\n<p>è¿™æ ·seekçš„å¤„ç†å°±å®Œæˆäº†ã€‚</p>\n<p>å‰é¢seekã€æš‚åœã€æ¢å¤éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨ffmpegçš„å‡½æ•°ï¼Œè¾…åŠ©ä¸€äº›æµç¨‹æ§åˆ¶å®Œæˆå°è£…ã€‚</p>\n<p>è€Œè¯»å–ç¼“å†²åŒºçš„æ§åˆ¶å¯ä»¥è¯´æ˜¯ffplayåŸç”Ÿçš„ç‰¹æ€§äº†ã€‚</p>\n<p>æ˜¯å¦éœ€è¦æ§åˆ¶ç¼“å†²åŒºå¤§å°ç”±å˜é‡infinite_bufferå†³å®šã€‚infinite_bufferä¸º1è¡¨ç¤ºå½“å‰bufferæ— é™å¤§ï¼Œä¸éœ€è¦ä½¿ç”¨ç¼“å†²åŒºé™åˆ¶ç­–ç•¥ã€‚</p>\n<p>infinite_bufferæ˜¯å¯é€‰é€‰é¡¹ï¼Œä½†åœ¨æ–‡ä»¶æ˜¯å®æ—¶åè®®æ—¶ï¼Œä¸”ç”¨æˆ·æœªæŒ‡å®šæ—¶ï¼Œè¿™ä¸ªå€¼ä¼šè¢«å¼ºåˆ¶ä¸º1ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">is_realtime</span><span class=\"hljs-params\">(AVFormatContext *s)</span><br>&#123;<br>    <span class=\"hljs-keyword\">if</span>(   !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;rtp&quot;</span>)<br>       || !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;rtsp&quot;</span>)<br>       || !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;sdp&quot;</span>)<br>    )<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-keyword\">if</span>(s-&gt;pb &amp;&amp; (   !<span class=\"hljs-built_in\">strncmp</span>(s-&gt;url, <span class=\"hljs-string\">&quot;rtp:&quot;</span>, <span class=\"hljs-number\">4</span>)<br>                 || !<span class=\"hljs-built_in\">strncmp</span>(s-&gt;url, <span class=\"hljs-string\">&quot;udp:&quot;</span>, <span class=\"hljs-number\">4</span>)<br>                )<br>    )<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br><br>â€¦â€¦<br>is-&gt;realtime = is_realtime(ic);<br>â€¦â€¦<br><span class=\"hljs-keyword\">if</span> (infinite_buffer &lt; <span class=\"hljs-number\">0</span> &amp;&amp; is-&gt;realtime)<br>    infinite_buffer = <span class=\"hljs-number\">1</span>;<br></code></pre></td></tr></table></figure>\n\n<p>æˆ‘ä»¬çœ‹ä¸‹éœ€æ§åˆ¶ç¼“å†²åŒºå¤§å°çš„æƒ…å†µï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (infinite_buffer&lt;<span class=\"hljs-number\">1</span> &amp;&amp;<br>    (is-&gt;audioq.size + is-&gt;videoq.size + is-&gt;subtitleq.size &gt; MAX_QUEUE_SIZE<br>    || (stream_has_enough_packets(is-&gt;audio_st, is-&gt;audio_stream, &amp;is-&gt;audioq) &amp;&amp;<br>        stream_has_enough_packets(is-&gt;video_st, is-&gt;video_stream, &amp;is-&gt;videoq) &amp;&amp;<br>        stream_has_enough_packets(is-&gt;subtitle_st, is-&gt;subtitle_stream, &amp;is-&gt;subtitleq)))) &#123;<br>    <span class=\"hljs-comment\">/* wait 10 ms */</span><br>    SDL_LockMutex(wait_mutex);<br>    SDL_CondWaitTimeout(is-&gt;continue_read_thread, wait_mutex, <span class=\"hljs-number\">10</span>);<br>    SDL_UnlockMutex(wait_mutex);<br>    <span class=\"hljs-keyword\">continue</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ç¼“å†²åŒºæ»¡æœ‰ä¸¤ç§å¯èƒ½ï¼š</p>\n<ol>\n<li>audioqï¼Œvideoqï¼Œsubtitleqä¸‰ä¸ªPacketQueueçš„æ€»å­—èŠ‚æ•°è¾¾åˆ°äº†MAX_QUEUE_SIZEï¼ˆ15Mï¼‰</li>\n<li>éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•æµéƒ½å·²æœ‰å¤Ÿç”¨çš„åŒ…ï¼ˆstream_has_enough_packetsï¼‰</li>\n</ol>\n<p>ç¬¬ä¸€ç§å¥½ç†è§£ï¼Œçœ‹ä¸‹ç¬¬äºŒç§ä¸­çš„stream_has_enough_packetsï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">stream_has_enough_packets</span><span class=\"hljs-params\">(AVStream *st, <span class=\"hljs-type\">int</span> stream_id, PacketQueue *<span class=\"hljs-built_in\">queue</span>)</span> &#123;<br>    <span class=\"hljs-keyword\">return</span> stream_id &lt; <span class=\"hljs-number\">0</span> ||<br>           <span class=\"hljs-built_in\">queue</span>-&gt;abort_request ||<br>           (st-&gt;disposition &amp; AV_DISPOSITION_ATTACHED_PIC) ||<br>           <span class=\"hljs-built_in\">queue</span>-&gt;nb_packets &gt; MIN_FRAMES &amp;&amp; (!<span class=\"hljs-built_in\">queue</span>-&gt;duration || av_q2d(st-&gt;time_base) * <span class=\"hljs-built_in\">queue</span>-&gt;duration &gt; <span class=\"hljs-number\">1.0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åœ¨æ»¡è¶³PacketQueueæ€»æ—¶é•¿ä¸º0ï¼Œæˆ–æ€»æ—¶é•¿è¶…è¿‡1sçš„å‰æä¸‹ï¼š</p>\n<p>æœ‰è¿™ä¹ˆå‡ ç§æƒ…å†µåŒ…æ˜¯å¤Ÿç”¨çš„ï¼š</p>\n<ol>\n<li>æµæ²¡æœ‰æ‰“å¼€ï¼ˆstream_id &lt; 0ï¼‰</li>\n<li>æœ‰é€€å‡ºè¯·æ±‚ï¼ˆqueue-&gt;abort_requestï¼‰</li>\n<li>é…ç½®äº†AV_DISPOSITION_ATTACHED_PICï¼Ÿï¼ˆè¿™ä¸ªè¿˜ä¸ç†è§£ï¼Œåç»­åˆ†æattachementæ—¶å›å¤´çœ‹çœ‹ï¼‰</li>\n<li>é˜Ÿåˆ—å†…åŒ…ä¸ªæ•°å¤§äºMIN_FRAMESï¼ˆ&#x3D;25ï¼‰</li>\n</ol>\n<p>æŒºé¥¶åœ°ï¼Œæ²¡æœ‰æ·±åˆ»ä½“ä¼šå…¶è®¾è®¡ç”¨æ„ï¼Œä¸è¯„è®ºã€‚</p>\n<p>ä¸Šè¿°çš„å‡ ç§å¤„ç†éƒ½è¿˜æ˜¯åœ¨æ­£å¸¸æ’­æ”¾æµç¨‹å†…ï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹æ’­æ”¾å·²å®Œæˆæƒ…å†µçš„å¤„ç†ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (!is-&gt;paused &amp;&amp;<br>    (!is-&gt;audio_st || (is-&gt;auddec.finished == is-&gt;audioq.serial &amp;&amp; frame_queue_nb_remaining(&amp;is-&gt;sampq) == <span class=\"hljs-number\">0</span>)) &amp;&amp;<br>    (!is-&gt;video_st || (is-&gt;viddec.finished == is-&gt;videoq.serial &amp;&amp; frame_queue_nb_remaining(&amp;is-&gt;pictq) == <span class=\"hljs-number\">0</span>))) &#123;<br>    <span class=\"hljs-keyword\">if</span> (loop != <span class=\"hljs-number\">1</span> &amp;&amp; (!loop || --loop)) &#123;<br>        stream_seek(is, start_time != AV_NOPTS_VALUE ? start_time : <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>);<br>    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (autoexit) &#123;<br>        ret = AVERROR_EOF;<br>        <span class=\"hljs-keyword\">goto</span> fail;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>è¿™é‡Œåˆ¤æ–­æ’­æ”¾å·²å®Œæˆçš„æ¡ä»¶ä¾ç„¶å¾ˆâ€œffplayâ€ï¼Œéœ€è¦æ»¡è¶³ï¼š</p>\n<ol>\n<li>ä¸åœ¨æš‚åœçŠ¶æ€</li>\n<li>éŸ³é¢‘æœªæ‰“å¼€ï¼Œæˆ–è€…æ‰“å¼€äº†ï¼Œä½†æ˜¯è§£ç å·²è§£ç å®Œæ¯•ï¼Œserialç­‰äºPacketQueueçš„serialï¼Œå¹¶ä¸”PacketQueueä¸­æ²¡æœ‰èŠ‚ç‚¹äº†</li>\n<li>è§†é¢‘æœªæ‰“å¼€ï¼Œæˆ–è€…æ‰“å¼€äº†ï¼Œä½†æ˜¯è§£ç å·²è§£ç å®Œæ¯•ï¼Œserialç­‰äºPacketQueueçš„serialï¼Œå¹¶ä¸”PacketQueueä¸­æ²¡æœ‰èŠ‚ç‚¹äº†</li>\n</ol>\n<p>åœ¨ç¡®è®¤å·²ç»“æŸçš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·æœ‰ä¸¤ä¸ªå˜é‡å¯ä»¥æ§åˆ¶æ’­æ”¾å™¨è¡Œä¸ºï¼š</p>\n<ol>\n<li>loop: æ§åˆ¶æ’­æ”¾æ¬¡æ•°ï¼ˆå½“å‰è¿™æ¬¡ä¹Ÿç®—åœ¨å†…ï¼Œä¹Ÿå°±æ˜¯æœ€å°å°±æ˜¯1æ¬¡äº†ï¼‰ï¼Œ0è¡¨ç¤ºæ— é™æ¬¡</li>\n<li>autoexitï¼šè‡ªåŠ¨é€€å‡ºï¼Œä¹Ÿå°±æ˜¯æ’­æ”¾å®Œæˆåè‡ªåŠ¨é€€å‡ºã€‚</li>\n</ol>\n<p>loopæ¡ä»¶ç®€åŒ–çš„éå¸¸ä¸å‹å¥½ï¼Œå…¶æ„æ€æ˜¯ï¼šå¦‚æœloop&#x3D;&#x3D;1ï¼Œé‚£ä¹ˆå·²ç»æ’­äº†1æ¬¡äº†ï¼Œæ— éœ€å†seeké‡æ–°æ’­æ”¾ï¼›å¦‚æœloopä¸æ˜¯1ï¼Œ&#x3D;&#x3D;0ï¼Œéšæ„ï¼Œæ— é™æ¬¡å¾ªç¯ï¼›å‡1åè¿˜å¤§äº0ï¼ˆâ€“loopï¼‰ï¼Œä¹Ÿå…è®¸å¾ªç¯ã€‚ä¹Ÿå°±æ˜¯ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">allow_loop</span><span class=\"hljs-params\">()</span> &#123;<br>    <span class=\"hljs-keyword\">if</span> (loop == <span class=\"hljs-number\">1</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br><br>    <span class=\"hljs-keyword\">if</span> (loop == <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    --loop;<br>    <span class=\"hljs-keyword\">if</span> (loop &gt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>å‰é¢è®²äº†å¾ˆå¤šè¯»çº¿ç¨‹ä¸»å¾ªç¯å†…çš„å¤„ç†ï¼Œæ¯”å¦‚æš‚åœã€seekã€ç»“æŸloopå¤„ç†ç­‰ï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹çœŸæ­£è¯»çš„ä»£ç ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\">ret = av_read_frame(ic, pkt);<br><span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>    <span class=\"hljs-comment\">//æ–‡ä»¶è¯»å–å®Œäº†ï¼Œè°ƒç”¨packet_queue_put_nullpacketé€šçŸ¥è§£ç çº¿ç¨‹</span><br>    <span class=\"hljs-keyword\">if</span> ((ret == AVERROR_EOF || avio_feof(ic-&gt;pb)) &amp;&amp; !is-&gt;eof) &#123;<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;video_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            packet_queue_put_nullpacket(&amp;is-&gt;videoq, is-&gt;video_stream);<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;audio_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            packet_queue_put_nullpacket(&amp;is-&gt;audioq, is-&gt;audio_stream);<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;subtitle_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            packet_queue_put_nullpacket(&amp;is-&gt;subtitleq, is-&gt;subtitle_stream);<br>        is-&gt;eof = <span class=\"hljs-number\">1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//å‘ç”Ÿé”™è¯¯äº†ï¼Œé€€å‡ºä¸»å¾ªç¯</span><br>    <span class=\"hljs-keyword\">if</span> (ic-&gt;pb &amp;&amp; ic-&gt;pb-&gt;error)<br>        <span class=\"hljs-keyword\">break</span>;<br><br>    <span class=\"hljs-comment\">//å¦‚æœéƒ½ä¸æ˜¯ï¼Œå¯èƒ½åªæ˜¯è¦ç­‰ä¸€ç­‰</span><br>    SDL_LockMutex(wait_mutex);<br>    SDL_CondWaitTimeout(is-&gt;continue_read_thread, wait_mutex, <span class=\"hljs-number\">10</span>);<br>    SDL_UnlockMutex(wait_mutex);<br>    <span class=\"hljs-keyword\">continue</span>;<br>&#125; <span class=\"hljs-keyword\">else</span> &#123;<br>    is-&gt;eof = <span class=\"hljs-number\">0</span>;<br>&#125;<br><br><span class=\"hljs-comment\">/* check if packet is in play range specified by user, then queue, otherwise discard */</span><br>stream_start_time = ic-&gt;streams[pkt-&gt;stream_index]-&gt;start_time;<br>pkt_ts = pkt-&gt;pts == AV_NOPTS_VALUE ? pkt-&gt;dts : pkt-&gt;pts;<br>pkt_in_play_range = duration == AV_NOPTS_VALUE ||<br>        (pkt_ts - (stream_start_time != AV_NOPTS_VALUE ? stream_start_time : <span class=\"hljs-number\">0</span>)) *<br>        av_q2d(ic-&gt;streams[pkt-&gt;stream_index]-&gt;time_base) -<br>        (<span class=\"hljs-type\">double</span>)(start_time != AV_NOPTS_VALUE ? start_time : <span class=\"hljs-number\">0</span>) / <span class=\"hljs-number\">1000000</span><br>        &lt;= ((<span class=\"hljs-type\">double</span>)duration / <span class=\"hljs-number\">1000000</span>);<br><br><span class=\"hljs-comment\">//å¦‚æœåœ¨æ—¶é—´èŒƒå›´å†…ï¼Œé‚£ä¹ˆæ ¹æ®stream_indexï¼Œæ”¾å…¥åˆ°è§†é¢‘ã€éŸ³é¢‘ã€ä¼šå­—å¹•çš„PacketQueueä¸­</span><br><span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == is-&gt;audio_stream &amp;&amp; pkt_in_play_range) &#123;<br>    packet_queue_put(&amp;is-&gt;audioq, pkt);<br>&#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == is-&gt;video_stream &amp;&amp; pkt_in_play_range<br>           &amp;&amp; !(is-&gt;video_st-&gt;disposition &amp; AV_DISPOSITION_ATTACHED_PIC)) &#123;<br>    packet_queue_put(&amp;is-&gt;videoq, pkt);<br>&#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == is-&gt;subtitle_stream &amp;&amp; pkt_in_play_range) &#123;<br>    packet_queue_put(&amp;is-&gt;subtitleq, pkt);<br>&#125; <span class=\"hljs-keyword\">else</span> &#123;<br>    av_packet_unref(pkt);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>çœ‹èµ·æ¥å¾ˆé•¿ï¼Œå®é™…æ¯”ä¸Šè¿°å„ç§ç‰¹æ®Šæµç¨‹çš„å¤„ç†éƒ½ç›´ç™½ï¼Œä¸»è¦ä¸ºï¼š</p>\n<ol>\n<li>av_read_frameè¯»å–ä¸€ä¸ªåŒ…(AVPacket)</li>\n<li>è¿”å›å€¼å¤„ç†</li>\n<li>pkt_in_play_rangeè®¡ç®—</li>\n<li>packet_queue_putæ”¾å…¥å„è‡ªé˜Ÿåˆ—ï¼Œæˆ–è€…ä¸¢å¼ƒ</li>\n</ol>\n<p>æ­¥éª¤1ã€æ­¥éª¤2ã€æ­¥éª¤4ï¼Œéƒ½æ¯”è¾ƒç›´æ¥ï¼Œçœ‹æ³¨é‡Šå³å¯ã€‚</p>\n<p>è¿™é‡Œçœ‹ä¸‹pkt_in_play_rangeçš„è®¡ç®—ï¼Œæˆ‘ä»¬æŠŠä»¥ä¸Šä»£ç åˆ†è§£ä¸‹ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int64_t</span> <span class=\"hljs-title function_\">get_stream_start_time</span><span class=\"hljs-params\">(AVFormatContext* ic, <span class=\"hljs-type\">int</span> index)</span> &#123;<br>    <span class=\"hljs-type\">int64_t</span> stream_start_time = ic-&gt;streams[index]-&gt;start_time;<br>    <span class=\"hljs-keyword\">return</span> stream_start_time != AV_NOPTS_VALUE ? stream_start_time : <span class=\"hljs-number\">0</span>;<br>&#125;<br><br><span class=\"hljs-type\">int64_t</span> <span class=\"hljs-title function_\">get_pkt_ts</span><span class=\"hljs-params\">(AVPacket* pkt)</span> &#123;<span class=\"hljs-comment\">//ts: timestampï¼ˆæ—¶é—´æˆ³ï¼‰çš„ç¼©å†™</span><br>    <span class=\"hljs-keyword\">return</span> pkt-&gt;pts == AV_NOPTS_VALUE ? pkt-&gt;dts : pkt-&gt;pts;<br>&#125;<br><br><span class=\"hljs-type\">double</span> <span class=\"hljs-title function_\">ts_as_second</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int64_t</span> tsï¼ŒAVFormatContext* icï¼Œ<span class=\"hljs-type\">int</span> index)</span> &#123;<br>    <span class=\"hljs-keyword\">return</span> ts * av_q2d(ic-&gt;streams[index]-&gt;time_base);<br>&#125; <br><br><span class=\"hljs-type\">double</span> <span class=\"hljs-title function_\">get_ic_start_time</span><span class=\"hljs-params\">(AVFormatContext* ic)</span> &#123;<span class=\"hljs-comment\">//icä¸­çš„æ—¶é—´å•ä½æ˜¯us</span><br>    <span class=\"hljs-keyword\">return</span> (start_time != AV_NOPTS_VALUE ? start_time : <span class=\"hljs-number\">0</span>) / <span class=\"hljs-number\">1000000</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æœ‰äº†è¿™äº›å‡½æ•°ï¼Œå°±å¯ä»¥è®¡ç®—pkt_in_play_rangeäº†ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">is_pkt_in_play_range</span><span class=\"hljs-params\">(AVFormatContext* ic, AVPacket* pkt)</span> &#123;<br>    <span class=\"hljs-keyword\">if</span> (duration == AV_NOPTS_VALUE) <span class=\"hljs-comment\">//å¦‚æœå½“å‰æµæ— æ³•è®¡ç®—æ€»æ—¶é•¿ï¼ŒæŒ‰æ— é™æ—¶é•¿å¤„ç†</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-comment\">//è®¡ç®—pktç›¸å¯¹streamä½ç½®</span><br>    <span class=\"hljs-type\">int64_t</span> stream_ts = get_pkt_ts(pkt) - get_stream_start_time(ic, pkt-&gt;stream_index);<br>    <span class=\"hljs-type\">double</span> stream_ts_s = ts_as_second(stream_ts, ic, pkt-&gt;stream_index);<br><br>    <span class=\"hljs-comment\">//è®¡ç®—pktç›¸å¯¹icä½ç½®</span><br>    <span class=\"hljs-type\">double</span> ic_ts = stream_ts_s - get_ic_start_time(ic);<br><br>    <span class=\"hljs-comment\">//æ˜¯å¦åœ¨æ—¶é—´èŒƒå›´å†…</span><br>    <span class=\"hljs-keyword\">return</span> ic_ts &lt;= ((<span class=\"hljs-type\">double</span>)duration / <span class=\"hljs-number\">1000000</span>);<br>&#125;<br></code></pre></td></tr></table></figure>\n","excerpt":"","more":"<p>å‚è€ƒï¼š <a href=\"https://zhuanlan.zhihu.com/p/43672062\">ffplay readçº¿ç¨‹åˆ†æ</a></p>\n<blockquote>\n<p>ffplay main å‡½æ•° åšäº†ä»€ä¹ˆ</p>\n</blockquote>\n<ol>\n<li><p>å‚æ•°éªŒè¯ä¸è§£æ</p>\n</li>\n<li><p>æ³¨å†Œcodecsï¼Œ demuxï¼Œ protocols</p>\n</li>\n<li><p>sdl åˆå§‹åŒ–ï¼Œåˆ›å»ºçª—å£</p>\n</li>\n<li><p>è°ƒç”¨stream_openæ‰“å¼€æµ</p>\n</li>\n<li><p>è°ƒç”¨event_loopè¿›å…¥è¿è¡Œå¾ªç¯</p>\n</li>\n</ol>\n<blockquote>\n<p>stream_open åšäº†ä»€ä¹ˆ</p>\n</blockquote>\n<p>Â Â Â Â ä¸»è¦æ˜¯åˆå§‹åŒ–VideoState *isï¼Œå¡«å……å…³é”®ä¿¡æ¯</p>\n<ol>\n<li><p>åˆå§‹åŒ–ï¼Œåˆ†é…å†…å­˜<code>is = av_mallocz(sizeof(VideoState));</code></p>\n</li>\n<li><p>è°ƒç”¨frame_queue_initç»™VideoStateå¯¹åº”çš„éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”Frameé˜Ÿåˆ—åˆå§‹åŒ–åˆ†é…å†…å­˜</p>\n</li>\n<li><p>è°ƒç”¨packet_queue_initç»™VideoStateå¯¹åº”çš„éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”Packeté˜Ÿåˆ—åˆå§‹åŒ–åˆ†é…å†…å­˜</p>\n</li>\n<li><p>åˆ›å»ºæ¡ä»¶å˜é‡continue_read_threadï¼Œ ç”¨äºæ§åˆ¶æ˜¯å¦ç»§ç»­è¯»å–æˆ–è€…ç­‰å¾…</p>\n</li>\n<li><p>è°ƒç”¨init_clock åˆå§‹åŒ–éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå¤–éƒ¨æ—¶é’Ÿ</p>\n</li>\n<li><p>è®¾ç½®åŒæ­¥ç±»å‹av_sync_type</p>\n</li>\n<li><p>åˆ›å»ºå¹¶å¼€å¯read_thread</p>\n</li>\n</ol>\n<h2 id=\"read-thread\"><a href=\"#read-thread\" class=\"headerlink\" title=\"read_thread\"></a>read_thread</h2><p>åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p>\n<ol>\n<li><p>å‡†å¤‡é˜¶æ®µ</p>\n</li>\n<li><p>å¾ªç¯è¯»pkt</p>\n</li>\n</ol>\n<p>å‡†å¤‡é˜¶æ®µï¼š</p>\n<p>stream_open å¯¹VideoState *is åšäº†åˆå§‹åŒ–å…³é”®å‚æ•°çš„å¡«å……ã€‚read_thread åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæ‰“å¼€è¾“å…¥çš„æµï¼Œè§£å°è£…ï¼Œè¯»å–æµçš„ä¿¡æ¯ï¼Œæ‰¾åˆ°éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¯¹åº”çš„streamï¼Œè¯»å–è§£ç å‚æ•°ï¼Œåˆ›å»ºè§£ç å™¨ï¼Œå¼€å¯è§£ç å™¨ã€‚åˆ†åˆ«ä¸ºéŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•å¼€å¯åˆ›å»ºè§£ç çº¿ç¨‹ã€‚</p>\n<p>å¾ªç¯è¯»pktï¼š</p>\n<p>ç„¶åè¿›å…¥å¾ªç¯ï¼Œä»æµä¸­è¯»å–pktï¼Œæ ¹æ®åŒæ­¥æ—¶é’Ÿï¼Œæ”¾å…¥pkté˜Ÿåˆ—æˆ–è€…ä¸¢å¼ƒã€‚å¦‚æœè¯»ç»“æŸï¼Œç»™pkté˜Ÿåˆ—æ”¾å…¥ç©ºåŒ…ï¼Œç”¨äºå†²æ´—è§£ç å™¨ã€‚</p>\n<p>å¾ªç¯ä¸­è¿˜è¦å¤„ç†ç»ˆæ­¢æš‚åœæ¢å¤äº‹ä»¶ï¼Œseekäº‹ä»¶ï¼Œæ ¹æ®é˜Ÿåˆ—çš„çŠ¶æ€ï¼ˆæ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®ï¼‰æ§åˆ¶ç­‰å¾…è¿˜æ˜¯ç»§ç»­è¯»å–æ–°çš„pktã€‚</p>\n<h3 id=\"å‡†å¤‡é˜¶æ®µ\"><a href=\"#å‡†å¤‡é˜¶æ®µ\" class=\"headerlink\" title=\"å‡†å¤‡é˜¶æ®µ\"></a>å‡†å¤‡é˜¶æ®µ</h3><p>æ‰“å¼€æ–‡ä»¶ï¼Œè§£å°è£…ï¼Œè·å–æ–‡ä»¶ä¿¡æ¯</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\">VideoState *is = arg;<br>AVFormatContext *ic = <span class=\"hljs-literal\">NULL</span>;<br><span class=\"hljs-comment\">//åˆ›å»ºAVFormatContext</span><br>ic = avformat_alloc_context();<br><span class=\"hljs-comment\">//interrupt_callbackç”¨äºffmpegå†…éƒ¨åœ¨æ‰§è¡Œè€—æ—¶æ“ä½œæ—¶æ£€æŸ¥æ˜¯å¦æœ‰é€€å‡ºè¯·æ±‚ï¼Œå¹¶æå‰ä¸­æ–­ï¼Œé¿å…ç”¨æˆ·é€€å‡ºè¯·æ±‚æ²¡æœ‰åŠæ—¶å“åº”</span><br>ic-&gt;interrupt_callback.callback = decode_interrupt_cb;<br>ic-&gt;interrupt_callback.opaque = is;<br><span class=\"hljs-comment\">//ç‰¹å®šé€‰é¡¹å¤„ç†</span><br><span class=\"hljs-keyword\">if</span> (!av_dict_get(format_opts, <span class=\"hljs-string\">&quot;scan_all_pmts&quot;</span>, <span class=\"hljs-literal\">NULL</span>, AV_DICT_MATCH_CASE)) &#123;<br>    av_dict_set(&amp;format_opts, <span class=\"hljs-string\">&quot;scan_all_pmts&quot;</span>, <span class=\"hljs-string\">&quot;1&quot;</span>, AV_DICT_DONT_OVERWRITE);<br>    scan_all_pmts_set = <span class=\"hljs-number\">1</span>;<br>&#125;<br><span class=\"hljs-comment\">//æ‰“å¼€è¾“å…¥çš„æµï¼Œè¯»å–æµçš„å¤´éƒ¨ä¿¡æ¯</span><br>err = avformat_open_input(&amp;ic, is-&gt;filename, is-&gt;iformat, &amp;format_opts);<br><span class=\"hljs-comment\">//ä¿å­˜AVFormatContext</span><br>is-&gt;ic = ic;<br><span class=\"hljs-keyword\">if</span> (find_stream_info) &#123;<br>    <span class=\"hljs-comment\">//å¦‚æœæ–‡ä»¶ä¸åŒ…å«å¤´éƒ¨ä¿¡æ¯(å¦‚ts)ï¼Œé€šè¿‡è¯»å–ä¸€æ®µæ–‡ä»¶åˆ†æåå¾—åˆ°æµä¿¡æ¯</span><br>    err = avformat_find_stream_info(ic, opts);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åˆ¤æ–­æ˜¯å¦æ˜¯å®æ—¶æµ</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//æ˜¯å¦æ˜¯å®æ—¶æµrtp/rtsp/sdpç­‰</span><br>is-&gt;realtime = is_realtime(ic);<br></code></pre></td></tr></table></figure>\n\n<p>is_realtime å‡½æ•°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">is_realtime</span><span class=\"hljs-params\">(AVFormatContext *s)</span><br>&#123;<br>    <span class=\"hljs-keyword\">if</span>(   !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;rtp&quot;</span>)<br>       || !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;rtsp&quot;</span>)<br>       || !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;sdp&quot;</span>)<br>    )<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-keyword\">if</span>(s-&gt;pb &amp;&amp; (   !<span class=\"hljs-built_in\">strncmp</span>(s-&gt;url, <span class=\"hljs-string\">&quot;rtp:&quot;</span>, <span class=\"hljs-number\">4</span>)<br>                 || !<span class=\"hljs-built_in\">strncmp</span>(s-&gt;url, <span class=\"hljs-string\">&quot;udp:&quot;</span>, <span class=\"hljs-number\">4</span>)<br>                )<br>    )<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>é€‰æ‹©éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•æµã€‚å®é™…æ“ä½œä¸­ï¼Œé€‰æ‹©çš„ç­–ç•¥å¾ˆå¤šï¼Œä¸€èˆ¬æ ¹æ®å…·ä½“éœ€æ±‚æ¥å®šâ€”â€”æ¯”å¦‚å¯ä»¥æ˜¯é€‰æ‹©æœ€é«˜æ¸…çš„è§†é¢‘æµï¼›é€‰æ‹©æœ¬åœ°è¯­è¨€çš„éŸ³é¢‘æµï¼›ç›´æ¥é€‰æ‹©ç¬¬ä¸€æ¡è§†é¢‘ã€éŸ³é¢‘è½¨é“ï¼›ç­‰ç­‰ã€‚</p>\n<p>ffplayä¸»è¦æ˜¯é€šè¿‡<code>av_find_best_stream</code>æ¥é€‰æ‹©ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-comment\">//å¦‚æœç”¨æˆ·é€šè¿‡wanted_stream_specæŒ‡å®šäº†æµï¼Œæ‰¾åˆ°ç”¨æˆ·é€‰æ‹©çš„æµ</span><br><span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; ic-&gt;nb_streams; i++) &#123;<br>    AVStream *st = ic-&gt;streams[i];<br>    <span class=\"hljs-class\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title\">AVMediaType</span> <span class=\"hljs-title\">type</span> =</span> st-&gt;codecpar-&gt;codec_type;<br>    st-&gt;discard = AVDISCARD_ALL;<br>    <span class=\"hljs-keyword\">if</span> (type &gt;= <span class=\"hljs-number\">0</span> &amp;&amp; wanted_stream_spec[type] &amp;&amp; st_index[type] == <span class=\"hljs-number\">-1</span>)<br>        <span class=\"hljs-keyword\">if</span> (avformat_match_stream_specifier(ic, st, wanted_stream_spec[type]) &gt; <span class=\"hljs-number\">0</span>)<br>            st_index[type] = i;<br>&#125;<br><span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; AVMEDIA_TYPE_NB; i++) &#123;<br>    <span class=\"hljs-keyword\">if</span> (wanted_stream_spec[i] &amp;&amp; st_index[i] == <span class=\"hljs-number\">-1</span>) &#123;<br>        <span class=\"hljs-comment\">//å¤„ç†æ‰¾ä¸åˆ°ç”¨æˆ·é€‰æ‹©çš„æµçš„æƒ…å†µ</span><br>        av_log(<span class=\"hljs-literal\">NULL</span>, AV_LOG_ERROR, <span class=\"hljs-string\">&quot;Stream specifier %s does not match any %s stream\\n&quot;</span>, wanted_stream_spec[i], av_get_media_type_string(i));<br>        st_index[i] = INT_MAX;<br>    &#125;<br>&#125;<br><br><span class=\"hljs-comment\">//è·å–video stream</span><br><span class=\"hljs-keyword\">if</span> (!video_disable)<br>    st_index[AVMEDIA_TYPE_VIDEO] =<br>        av_find_best_stream(ic, AVMEDIA_TYPE_VIDEO,<br>                            st_index[AVMEDIA_TYPE_VIDEO], <span class=\"hljs-number\">-1</span>, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>);<br><span class=\"hljs-comment\">//è·å–audio streamï¼Œå‚è€ƒè§†é¢‘æµé€‰æ‹©</span><br><span class=\"hljs-keyword\">if</span> (!audio_disable)<br>    st_index[AVMEDIA_TYPE_AUDIO] =<br>        av_find_best_stream(ic, AVMEDIA_TYPE_AUDIO,<br>                            st_index[AVMEDIA_TYPE_AUDIO],<br>                            st_index[AVMEDIA_TYPE_VIDEO],<br>                            <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>);<br><span class=\"hljs-comment\">//è·å–subtitle streamï¼Œä¼˜å…ˆå‚è€ƒéŸ³é¢‘æµ</span><br><span class=\"hljs-keyword\">if</span> (!video_disable &amp;&amp; !subtitle_disable)<br>    st_index[AVMEDIA_TYPE_SUBTITLE] =<br>        av_find_best_stream(ic, AVMEDIA_TYPE_SUBTITLE,<br>                            st_index[AVMEDIA_TYPE_SUBTITLE],<br>                            (st_index[AVMEDIA_TYPE_AUDIO] &gt;= <span class=\"hljs-number\">0</span> ?<br>                             st_index[AVMEDIA_TYPE_AUDIO] :<br>                             st_index[AVMEDIA_TYPE_VIDEO]),<br>                            <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-number\">0</span>);<br></code></pre></td></tr></table></figure>\n\n<p>wanted_stream_specé€šè¿‡mainå‡½æ•°ä¼ å‚è®¾å®šï¼Œæ ¼å¼å¯ä»¥æœ‰å¾ˆå¤šç§ï¼Œå‚è€ƒ<a href=\"https://www.ffmpeg.org/ffplay.html#Stream-specifiers-1\">å®˜æ–¹æ–‡æ¡£</a></p>\n<p>å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šæµï¼Œæˆ–æŒ‡å®šéƒ¨åˆ†æµï¼Œæˆ–æŒ‡å®šæµä¸å­˜åœ¨ï¼Œåˆ™ä¸»è¦ç”±av_find_best_streamå‘æŒ¥ä½œç”¨ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">av_find_best_stream</span><span class=\"hljs-params\">(AVFormatContext *ic,</span><br><span class=\"hljs-params\">                        <span class=\"hljs-keyword\">enum</span> AVMediaType type,<span class=\"hljs-comment\">//è¦é€‰æ‹©çš„æµç±»å‹</span></span><br><span class=\"hljs-params\">                        <span class=\"hljs-type\">int</span> wanted_stream_nb,<span class=\"hljs-comment\">//ç›®æ ‡æµç´¢å¼•</span></span><br><span class=\"hljs-params\">                        <span class=\"hljs-type\">int</span> related_stream,<span class=\"hljs-comment\">//å‚è€ƒæµç´¢å¼•</span></span><br><span class=\"hljs-params\">                        AVCodec **decoder_ret,</span><br><span class=\"hljs-params\">                        <span class=\"hljs-type\">int</span> flags)</span>;<br></code></pre></td></tr></table></figure>\n\n<p>å¦‚æœæŒ‡å®šäº†æ­£ç¡®çš„wanted_stream_nbï¼Œä¸€èˆ¬æƒ…å†µéƒ½æ˜¯ç›´æ¥è¿”å›è¯¥æŒ‡å®šæµï¼Œå³ç”¨æˆ·é€‰æ‹©çš„æµã€‚å¦‚æœæŒ‡å®šäº†å‚è€ƒæµï¼Œä¸”æœªæŒ‡å®šç›®æ ‡æµçš„æƒ…å†µï¼Œä¼šæ ¹æ®å‚è€ƒæµå»æŸ¥æ‰¾æ‰€éœ€ç±»å‹çš„æµï¼Œä½†ä¸€èˆ¬ç»“æœï¼Œéƒ½æ˜¯è¿”å›è¯¥ç±»å‹ç¬¬ä¸€ä¸ªæµã€‚</p>\n<p>å·²ç»è·å–äº†æµä¿¡æ¯ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯åˆ›å»ºè§£ç å™¨ï¼Œå¼€å¯è§£ç çº¿ç¨‹ã€‚ </p>\n<p>ä¸»è¦åœ¨<code>stream_component_open</code>æ–¹æ³•ä¸­å®ç°, ç®€åŒ–ä»£ç å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">stream_component_open</span><span class=\"hljs-params\">(VideoState *is, <span class=\"hljs-type\">int</span> stream_index)</span><br>&#123;<br>    <span class=\"hljs-comment\">//åˆ›å»ºè§£ç å™¨ä¸Šä¸‹æ–‡</span><br>    avctx = avcodec_alloc_context3(<span class=\"hljs-literal\">NULL</span>);        <br>    <span class=\"hljs-comment\">//å¡«å……è§£ç å‚æ•°</span><br>    ret = avcodec_parameters_to_context(avctx, ic-&gt;streams[stream_index]-&gt;codecpar);<br>    <span class=\"hljs-comment\">//è®¾ç½®è§£ç å™¨çš„æ—¶é—´åŸºï¼Œç­‰äºstreamçš„æ—¶é—´åŸº</span><br>    avctx-&gt;pkt_timebase = ic-&gt;streams[stream_index]-&gt;time_base;<br>    <span class=\"hljs-comment\">//æ‰¾è§£ç å™¨</span><br>    codec = avcodec_find_decoder(avctx-&gt;codec_id);<br>    <span class=\"hljs-keyword\">if</span> (forced_codec_name)<br>        <span class=\"hljs-comment\">//å¦‚æœç”¨æˆ·æŒ‡å®šäº†è§£ç å™¨ï¼Œä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„è§£ç å™¨</span><br>        codec = avcodec_find_decoder_by_name(forced_codec_name);<br>    <span class=\"hljs-comment\">//æ‰“å¼€è§£ç å™¨</span><br>    <span class=\"hljs-keyword\">if</span> ((ret = avcodec_open2(avctx, codec, &amp;opts)) &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-keyword\">goto</span> fail;<br>    &#125;<br>    <span class=\"hljs-keyword\">switch</span> (avctx-&gt;codec_type) &#123;<br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_AUDIO:<br>        <span class=\"hljs-comment\">//æ‰“å¼€éŸ³é¢‘æ’­æ”¾å™¨</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = audio_open(is, channel_layout, nb_channels, sample_rate, &amp;is-&gt;audio_tgt)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        <span class=\"hljs-comment\">//ç»™is-&gt;auddecåˆå§‹åŒ–</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_init(&amp;is-&gt;auddec, avctx, &amp;is-&gt;audioq, is-&gt;continue_read_thread)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        <span class=\"hljs-comment\">//å¼€å¯éŸ³é¢‘è§£ç çº¿ç¨‹</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_start(&amp;is-&gt;auddec, audio_thread, <span class=\"hljs-string\">&quot;audio_decoder&quot;</span>, is)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> out;<br>        <span class=\"hljs-comment\">//æš‚åœéŸ³é¢‘æ’­æ”¾å™¨</span><br>        SDL_PauseAudioDevice(audio_dev, <span class=\"hljs-number\">0</span>);<br>        <span class=\"hljs-keyword\">break</span>;<br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_VIDEO:<br>        is-&gt;video_stream = stream_index;<br>        is-&gt;video_st = ic-&gt;streams[stream_index];<br>        <span class=\"hljs-comment\">//ç»™is-&gt;viddecåˆå§‹åŒ–</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_init(&amp;is-&gt;viddec, avctx, &amp;is-&gt;videoq, is-&gt;continue_read_thread)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        <span class=\"hljs-comment\">//å¼€å¯è§†é¢‘è§£ç çº¿ç¨‹</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_start(&amp;is-&gt;viddec, video_thread, <span class=\"hljs-string\">&quot;video_decoder&quot;</span>, is)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> out;<br>        is-&gt;queue_attachments_req = <span class=\"hljs-number\">1</span>;<br>        <span class=\"hljs-keyword\">break</span>;<br>    <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_SUBTITLE:<br>        is-&gt;subtitle_stream = stream_index;<br>        is-&gt;subtitle_st = ic-&gt;streams[stream_index];<br>        <span class=\"hljs-comment\">//åˆå§‹åŒ–å­—å¹•è§£ç </span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_init(&amp;is-&gt;subdec, avctx, &amp;is-&gt;subtitleq, is-&gt;continue_read_thread)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> fail;<br>        <span class=\"hljs-comment\">//å¼€å¯å­—å¹•è§£ç çº¿ç¨‹</span><br>        <span class=\"hljs-keyword\">if</span> ((ret = decoder_start(&amp;is-&gt;subdec, subtitle_thread, <span class=\"hljs-string\">&quot;subtitle_decoder&quot;</span>, is)) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">goto</span> out;<br>        <span class=\"hljs-keyword\">break</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//....</span><br>    <span class=\"hljs-keyword\">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>é’ˆå¯¹éŸ³é¢‘ï¼Œéœ€è¦å¦å¤–å¤„ç†éŸ³é¢‘æ’­æ”¾å™¨çš„åˆå§‹åŒ–ï¼Œæš‚åœçŠ¶æ€ã€‚</p>\n<p>å¯¹éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•ï¼Œè°ƒç”¨<code>decoder_init</code>åˆå§‹åŒ–Decoderï¼Œ è°ƒç”¨<code>decoder_start</code>å¼€å¯å¯¹åº”çš„è§£ç çº¿ç¨‹ã€‚</p>\n<p>decoder_init</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static int decoder_init(Decoder *d, AVCodecContext *avctx, PacketQueue *queue, SDL_cond *empty_queue_cond) &#123;<br>    memset(d, <span class=\"hljs-number\">0</span>, sizeof(Decoder));<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>pkt = av_packet_alloc();<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (!d-&gt;</span>pkt)<br>        return AVERROR(ENOMEM);<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>avctx = avctx;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>queue = queue;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>empty_queue_cond = empty_queue_cond;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>start_pts = AV_NOPTS_VALUE;<br>    <span class=\"hljs-function\"><span class=\"hljs-title\">d</span>-&gt;</span>pkt_serial = -<span class=\"hljs-number\">1</span>;<br>    return <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>decoder_start</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title\">decoder_start</span><span class=\"hljs-params\">(Decoder *d, <span class=\"hljs-type\">int</span> (*fn)(<span class=\"hljs-type\">void</span> *), <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> *thread_name, <span class=\"hljs-type\">void</span>* arg)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    <span class=\"hljs-comment\">//å¼€å¯packet queue</span><br>    <span class=\"hljs-built_in\">packet_queue_start</span>(d-&gt;queue);<br>    <span class=\"hljs-comment\">//å¼€å¯è§£ç çº¿ç¨‹</span><br>    d-&gt;decoder_tid = <span class=\"hljs-built_in\">SDL_CreateThread</span>(fn, thread_name, arg);<br>    <span class=\"hljs-keyword\">if</span> (!d-&gt;decoder_tid) &#123;<br>        <span class=\"hljs-built_in\">av_log</span>(<span class=\"hljs-literal\">NULL</span>, AV_LOG_ERROR, <span class=\"hljs-string\">&quot;SDL_CreateThread(): %s\\n&quot;</span>, <span class=\"hljs-built_in\">SDL_GetError</span>());<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">AVERROR</span>(ENOMEM);<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"ä¸»å¾ªç¯è¯»åŒ…\"><a href=\"#ä¸»å¾ªç¯è¯»åŒ…\" class=\"headerlink\" title=\"ä¸»å¾ªç¯è¯»åŒ…\"></a>ä¸»å¾ªç¯è¯»åŒ…</h3><p>ç®€åŒ–ä¸€ä¸‹å¦‚ä¸‹</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\"><span class=\"hljs-keyword\">for</span> (;;) &#123;<br>        <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;</span>abort_request)<br>            break;<span class=\"hljs-comment\">//å¤„ç†é€€å‡ºæ¶ˆæ¯</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">paused</span> != <span class=\"hljs-keyword\">is</span>-&gt;</span>last_paused) &#123;<br>            <span class=\"hljs-comment\">//å¤„ç†æš‚åœä¸æ¢å¤</span><br>            <span class=\"hljs-comment\">//.......</span><br>        &#125;<br><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;</span>seek_req) &#123;<br>            <span class=\"hljs-comment\">//å¤„ç†seekæ“ä½œ</span><br>            <span class=\"hljs-function\"><span class=\"hljs-title\">ret</span> = avformat_seek_file(<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">ic</span>, -1, seek_min, seek_target, seek_max, <span class=\"hljs-keyword\">is</span>-&gt;</span>seek_flags);<br>        &#125;<br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">        æ§åˆ¶é˜Ÿåˆ—å¤§å°</span><br><span class=\"hljs-comment\">        */</span><br>        <span class=\"hljs-keyword\">if</span> (infinite_buffer&lt;<span class=\"hljs-number\">1</span> &amp;&amp;<br>              (<span class=\"hljs-function\"><span class=\"hljs-title\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audioq</span>.size + <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">videoq</span>.size + <span class=\"hljs-keyword\">is</span>-&gt;</span>subtitleq.size &gt; MAX_QUEUE_SIZE<br>            || (<span class=\"hljs-function\"><span class=\"hljs-title\">stream_has_enough_packets</span>(<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audio_st</span>, <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audio_stream</span>, &amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>audioq) &amp;&amp;<br>                <span class=\"hljs-function\"><span class=\"hljs-title\">stream_has_enough_packets</span>(<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">video_st</span>, <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">video_stream</span>, &amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>videoq) &amp;&amp;<br>                <span class=\"hljs-function\"><span class=\"hljs-title\">stream_has_enough_packets</span>(<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">subtitle_st</span>, <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">subtitle_stream</span>, &amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>subtitleq)))) &#123;<br>            <span class=\"hljs-comment\">/* wait 10 ms */</span><br>            SDL_LockMutex(wait_mutex);<br>            SDL_C<span class=\"hljs-function\"><span class=\"hljs-title\">ondWaitTimeout</span>(<span class=\"hljs-keyword\">is</span>-&gt;</span>continue_read_thread, wait_mutex, <span class=\"hljs-number\">10</span>);<br>            SDL_UnlockMutex(wait_mutex);<br>            continue;<br>        &#125;<br>        <span class=\"hljs-comment\">//å¤„ç†å¾ªç¯æ’­æ”¾</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (!<span class=\"hljs-keyword\">is</span>-&gt;</span>paused &amp;&amp;<br>            (!<span class=\"hljs-function\"><span class=\"hljs-title\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audio_st</span> || (<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">auddec</span>.finished == <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">audioq</span>.serial &amp;&amp; frame_queue_nb_remaining(&amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>sampq) == <span class=\"hljs-number\">0</span>)) &amp;&amp;<br>            (!<span class=\"hljs-function\"><span class=\"hljs-title\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">video_st</span> || (<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">viddec</span>.finished == <span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">videoq</span>.serial &amp;&amp; frame_queue_nb_remaining(&amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>pictq) == <span class=\"hljs-number\">0</span>))) &#123;<br>            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">loop</span> != <span class=\"hljs-number\">1</span> &amp;&amp; (!<span class=\"hljs-keyword\">loop</span> || --<span class=\"hljs-keyword\">loop</span>)) &#123;<br>                stream_seek(<span class=\"hljs-keyword\">is</span>, start_time != AV_NOPTS_VALUE ? start_time : <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>);<br>            &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (autoexit) &#123;<br>                ret = AVERROR_EOF;<br>                goto fail;<br>            &#125;<br>        &#125;<br>        <span class=\"hljs-comment\">//è¯»pkt</span><br>        ret = av_read_frame(ic, pkt);<br><br>        <span class=\"hljs-comment\">//åœ¨æ’­æ”¾åŒºé—´ï¼Œæ”¾å…¥é˜Ÿåˆ—</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">packet_queue_put</span>(&amp;<span class=\"hljs-keyword\">is</span>-&gt;</span>videoq, pkt);<br>        <span class=\"hljs-comment\">//ä¸åœ¨æ’­æ”¾åŒºé—´ï¼Œä¸¢å¼ƒ</span><br>        av_packet_unref(pkt);<br><br>    &#125;<br></code></pre></td></tr></table></figure>\n\n<p>ä¸»è¦çš„ä»£ç å°±<code>av_read_frame</code>å’Œ<code>packet_queue_put</code>ï¼Œ<code>av_read_frame</code>ä»æ–‡ä»¶ä¸­è¯»å–è§†é¢‘æ•°æ®ï¼Œå¹¶è·å–ä¸€ä¸ªAVPacketï¼Œ<code>packet_queue_put</code>æŠŠå®ƒæ”¾å…¥åˆ°å¯¹åº”çš„PacketQueueä¸­ã€‚</p>\n<p>å½“ç„¶ï¼Œè¯»å–è¿‡ç¨‹è¿˜ä¼šæœ‰seekã€pauseã€resumeã€abortç­‰äº‹ä»¶ï¼Œæ‰€ä»¥æœ‰ä¸“é—¨çš„åˆ†æ”¯å¤„ç†è¿™äº›è¯·æ±‚ã€‚</p>\n<p>PacketQueueé»˜è®¤æƒ…å†µä¸‹ä¼šæœ‰å¤§å°é™åˆ¶ï¼Œè¾¾åˆ°è¿™ä¸ªå¤§å°åï¼Œå°±éœ€è¦ç­‰å¾…10msï¼Œä»¥è®©æ¶ˆè´¹è€…â€”â€”è§£ç çº¿ç¨‹èƒ½æœ‰æ—¶é—´æ¶ˆè€—ã€‚</p>\n<p>æ’­æ”¾å®Œæˆåï¼Œä¼šæ ¹æ®loopçš„è®¾ç½®å†³å®šæ˜¯å¦å¾ªç¯ã€‚</p>\n<p>æš‚åœ&#x2F;æ¢å¤çš„å¤„ç†ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (is-&gt;paused != is-&gt;last_paused) &#123;<br>    <span class=\"hljs-comment\">//æ›´æ–°pausedçŠ¶æ€</span><br>    is-&gt;last_paused = is-&gt;paused;<br>    <span class=\"hljs-keyword\">if</span> (is-&gt;paused)<br>        <span class=\"hljs-comment\">//æš‚åœ</span><br>        is-&gt;read_pause_return = av_read_pause(ic);<br>    <span class=\"hljs-keyword\">else</span><br>        <span class=\"hljs-comment\">//æ¢å¤æ’­æ”¾</span><br>        av_read_play(ic);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ffmpegæœ‰ä¸“é—¨é’ˆå¯¹æš‚åœå’Œæ¢å¤çš„å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨å°±å¯ä»¥äº†ã€‚</p>\n<blockquote>\n<p>av_read_pauseå’Œav_read_playå¯¹äºURLProtocolï¼Œä¼šè°ƒç”¨å…¶url_read_pauseï¼Œé€šè¿‡å‚æ•°åŒºåˆ†æ˜¯è¦æš‚åœè¿˜æ˜¯æ¢å¤ã€‚å¯¹äºAVInputFormatä¼šè°ƒç”¨å…¶read_pauseå’Œread_play.<br>ä¸€èˆ¬æƒ…å†µä¸‹URLProtocolå’ŒAVInputFormatéƒ½ä¸éœ€è¦ä¸“é—¨å¤„ç†æš‚åœå’Œæ¢å¤ï¼Œä½†å¯¹äºåƒrtsp&#x2F;rtmpè¿™ç§åœ¨é€šè®¯åè®®ä¸Šæ”¯æŒ(éœ€è¦)æš‚åœã€æ¢å¤çš„å°±ç‰¹åˆ«æœ‰ç”¨äº†ã€‚</p>\n</blockquote>\n<p>å¯¹äºseekçš„å¤„ç†ï¼Œä¼šæ¯”æš‚åœ&#x2F;æ¢å¤ç•¥å¾®å¤æ‚ä¸€äº›ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (is-&gt;seek_req) &#123;<br>    <span class=\"hljs-comment\">//å¤„ç†seekæ“ä½œ</span><br>    <span class=\"hljs-type\">int64_t</span> seek_target = is-&gt;seek_pos;<br>    <span class=\"hljs-type\">int64_t</span> seek_min    = is-&gt;seek_rel &gt; <span class=\"hljs-number\">0</span> ? seek_target - is-&gt;seek_rel + <span class=\"hljs-number\">2</span>: INT64_MIN;<br>    <span class=\"hljs-type\">int64_t</span> seek_max    = is-&gt;seek_rel &lt; <span class=\"hljs-number\">0</span> ? seek_target - is-&gt;seek_rel - <span class=\"hljs-number\">2</span>: INT64_MAX;<br><span class=\"hljs-comment\">// FIXME the +-2 is due to rounding being not done in the correct direction in generation</span><br><span class=\"hljs-comment\">//      of the seek_pos/seek_rel variables</span><br>    <span class=\"hljs-comment\">//seekåˆ°æ­£ç¡®çš„ä½ç½®</span><br>    ret = avformat_seek_file(is-&gt;ic, <span class=\"hljs-number\">-1</span>, seek_min, seek_target, seek_max, is-&gt;seek_flags);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        av_log(<span class=\"hljs-literal\">NULL</span>, AV_LOG_ERROR,<br>               <span class=\"hljs-string\">&quot;%s: error while seeking\\n&quot;</span>, is-&gt;ic-&gt;url);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;audio_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-comment\">//æ¸…ç©ºéŸ³é¢‘å¸§é˜Ÿåˆ—</span><br>            packet_queue_flush(&amp;is-&gt;audioq);<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;subtitle_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-comment\">//æ¸…ç©ºå­—å¹•å¸§é˜Ÿåˆ—</span><br>            packet_queue_flush(&amp;is-&gt;subtitleq);<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;video_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-comment\">//æ¸…ç©ºè§†é¢‘å¸§é˜Ÿåˆ—</span><br>            packet_queue_flush(&amp;is-&gt;videoq);<br>        <span class=\"hljs-comment\">//æ›´æ–°clock</span><br>        <span class=\"hljs-keyword\">if</span> (is-&gt;seek_flags &amp; AVSEEK_FLAG_BYTE) &#123;<br>           set_clock(&amp;is-&gt;extclk, NAN, <span class=\"hljs-number\">0</span>);<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>           set_clock(&amp;is-&gt;extclk, seek_target / (<span class=\"hljs-type\">double</span>)AV_TIME_BASE, <span class=\"hljs-number\">0</span>);<br>        &#125;<br>    &#125;<br>    is-&gt;seek_req = <span class=\"hljs-number\">0</span>;<br>    is-&gt;queue_attachments_req = <span class=\"hljs-number\">1</span>;<br>    is-&gt;eof = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-keyword\">if</span> (is-&gt;paused)<br>        step_to_next_frame(is);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ä¸»è¦çš„seekæ“ä½œé€šè¿‡avformat_seek_fileå®Œæˆã€‚æ ¹æ®avformat_seek_fileçš„è¿”å›å€¼ï¼Œå¦‚æœseekæˆåŠŸï¼Œéœ€è¦ï¼š</p>\n<ol>\n<li>æ¸…é™¤PacketQueueçš„ç¼“å­˜ï¼Œå¹¶æ”¾å…¥ä¸€ä¸ªflush_pktã€‚æ”¾å…¥çš„flush_pktå¯ä»¥è®©PacketQueueçš„serialå¢1ï¼Œä»¥åŒºåˆ†seekå‰åçš„æ•°æ®</li>\n<li>åŒæ­¥å¤–éƒ¨æ—¶é’Ÿã€‚åœ¨åç»­éŸ³è§†é¢‘åŒæ­¥çš„æ–‡ç« ä¸­å†å…·ä½“åˆ†æã€‚</li>\n</ol>\n<p>æœ€åæ¸…ç†ä¸€äº›å˜é‡ï¼Œå¹¶ï¼š</p>\n<ol>\n<li>è®¾ç½®queue_attachments_reqä»¥æ˜¾ç¤ºattachmentç”»é¢</li>\n<li>å¦‚æœå½“å‰æ˜¯æš‚åœçŠ¶æ€ï¼Œå°±è·³åˆ°seekåçš„ä¸‹ä¸€å¸§ï¼Œä»¥ç›´è§‚ä½“ç°seekæˆåŠŸäº†</li>\n</ol>\n<p>step_to_next_frame</p>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs livescript\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-literal\">void</span> step_to_next_frame(VideoState *<span class=\"hljs-keyword\">is</span>)<br>&#123;<br>    <span class=\"hljs-comment\">/* if the stream is paused unpause it, then step */</span><br>    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;paused)<br>        stream_toggle_pause(<span class=\"hljs-keyword\">is</span>);<br>    <span class=\"hljs-keyword\">is</span>-&gt;step = <span class=\"hljs-number\">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åŸä»£ç çš„æ³¨é‡Šæ¯”è¾ƒæ¸…æ™°äº†â€”â€”å…ˆå–æ¶ˆæš‚åœï¼Œç„¶åæ‰§è¡Œstepã€‚å½“è®¾ç½®stepä¸º1åï¼Œæ˜¾ç¤ºçº¿ç¨‹ä¼šæ˜¾ç¤ºå‡ºä¸€å¸§ç”»é¢ï¼Œç„¶åå†æ¬¡è¿›å…¥æš‚åœï¼š</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\"><span class=\"hljs-comment\">//in video_refresh</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">if</span> (<span class=\"hljs-keyword\">is</span>-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">step</span> &amp;&amp; !<span class=\"hljs-keyword\">is</span>-&gt;</span>paused)<br>    stream_toggle_pause(<span class=\"hljs-keyword\">is</span>);<br></code></pre></td></tr></table></figure>\n\n<p>è¿™æ ·seekçš„å¤„ç†å°±å®Œæˆäº†ã€‚</p>\n<p>å‰é¢seekã€æš‚åœã€æ¢å¤éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨ffmpegçš„å‡½æ•°ï¼Œè¾…åŠ©ä¸€äº›æµç¨‹æ§åˆ¶å®Œæˆå°è£…ã€‚</p>\n<p>è€Œè¯»å–ç¼“å†²åŒºçš„æ§åˆ¶å¯ä»¥è¯´æ˜¯ffplayåŸç”Ÿçš„ç‰¹æ€§äº†ã€‚</p>\n<p>æ˜¯å¦éœ€è¦æ§åˆ¶ç¼“å†²åŒºå¤§å°ç”±å˜é‡infinite_bufferå†³å®šã€‚infinite_bufferä¸º1è¡¨ç¤ºå½“å‰bufferæ— é™å¤§ï¼Œä¸éœ€è¦ä½¿ç”¨ç¼“å†²åŒºé™åˆ¶ç­–ç•¥ã€‚</p>\n<p>infinite_bufferæ˜¯å¯é€‰é€‰é¡¹ï¼Œä½†åœ¨æ–‡ä»¶æ˜¯å®æ—¶åè®®æ—¶ï¼Œä¸”ç”¨æˆ·æœªæŒ‡å®šæ—¶ï¼Œè¿™ä¸ªå€¼ä¼šè¢«å¼ºåˆ¶ä¸º1ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">is_realtime</span><span class=\"hljs-params\">(AVFormatContext *s)</span><br>&#123;<br>    <span class=\"hljs-keyword\">if</span>(   !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;rtp&quot;</span>)<br>       || !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;rtsp&quot;</span>)<br>       || !<span class=\"hljs-built_in\">strcmp</span>(s-&gt;iformat-&gt;name, <span class=\"hljs-string\">&quot;sdp&quot;</span>)<br>    )<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-keyword\">if</span>(s-&gt;pb &amp;&amp; (   !<span class=\"hljs-built_in\">strncmp</span>(s-&gt;url, <span class=\"hljs-string\">&quot;rtp:&quot;</span>, <span class=\"hljs-number\">4</span>)<br>                 || !<span class=\"hljs-built_in\">strncmp</span>(s-&gt;url, <span class=\"hljs-string\">&quot;udp:&quot;</span>, <span class=\"hljs-number\">4</span>)<br>                )<br>    )<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br><br>â€¦â€¦<br>is-&gt;realtime = is_realtime(ic);<br>â€¦â€¦<br><span class=\"hljs-keyword\">if</span> (infinite_buffer &lt; <span class=\"hljs-number\">0</span> &amp;&amp; is-&gt;realtime)<br>    infinite_buffer = <span class=\"hljs-number\">1</span>;<br></code></pre></td></tr></table></figure>\n\n<p>æˆ‘ä»¬çœ‹ä¸‹éœ€æ§åˆ¶ç¼“å†²åŒºå¤§å°çš„æƒ…å†µï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (infinite_buffer&lt;<span class=\"hljs-number\">1</span> &amp;&amp;<br>    (is-&gt;audioq.size + is-&gt;videoq.size + is-&gt;subtitleq.size &gt; MAX_QUEUE_SIZE<br>    || (stream_has_enough_packets(is-&gt;audio_st, is-&gt;audio_stream, &amp;is-&gt;audioq) &amp;&amp;<br>        stream_has_enough_packets(is-&gt;video_st, is-&gt;video_stream, &amp;is-&gt;videoq) &amp;&amp;<br>        stream_has_enough_packets(is-&gt;subtitle_st, is-&gt;subtitle_stream, &amp;is-&gt;subtitleq)))) &#123;<br>    <span class=\"hljs-comment\">/* wait 10 ms */</span><br>    SDL_LockMutex(wait_mutex);<br>    SDL_CondWaitTimeout(is-&gt;continue_read_thread, wait_mutex, <span class=\"hljs-number\">10</span>);<br>    SDL_UnlockMutex(wait_mutex);<br>    <span class=\"hljs-keyword\">continue</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ç¼“å†²åŒºæ»¡æœ‰ä¸¤ç§å¯èƒ½ï¼š</p>\n<ol>\n<li>audioqï¼Œvideoqï¼Œsubtitleqä¸‰ä¸ªPacketQueueçš„æ€»å­—èŠ‚æ•°è¾¾åˆ°äº†MAX_QUEUE_SIZEï¼ˆ15Mï¼‰</li>\n<li>éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•æµéƒ½å·²æœ‰å¤Ÿç”¨çš„åŒ…ï¼ˆstream_has_enough_packetsï¼‰</li>\n</ol>\n<p>ç¬¬ä¸€ç§å¥½ç†è§£ï¼Œçœ‹ä¸‹ç¬¬äºŒç§ä¸­çš„stream_has_enough_packetsï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">stream_has_enough_packets</span><span class=\"hljs-params\">(AVStream *st, <span class=\"hljs-type\">int</span> stream_id, PacketQueue *<span class=\"hljs-built_in\">queue</span>)</span> &#123;<br>    <span class=\"hljs-keyword\">return</span> stream_id &lt; <span class=\"hljs-number\">0</span> ||<br>           <span class=\"hljs-built_in\">queue</span>-&gt;abort_request ||<br>           (st-&gt;disposition &amp; AV_DISPOSITION_ATTACHED_PIC) ||<br>           <span class=\"hljs-built_in\">queue</span>-&gt;nb_packets &gt; MIN_FRAMES &amp;&amp; (!<span class=\"hljs-built_in\">queue</span>-&gt;duration || av_q2d(st-&gt;time_base) * <span class=\"hljs-built_in\">queue</span>-&gt;duration &gt; <span class=\"hljs-number\">1.0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>åœ¨æ»¡è¶³PacketQueueæ€»æ—¶é•¿ä¸º0ï¼Œæˆ–æ€»æ—¶é•¿è¶…è¿‡1sçš„å‰æä¸‹ï¼š</p>\n<p>æœ‰è¿™ä¹ˆå‡ ç§æƒ…å†µåŒ…æ˜¯å¤Ÿç”¨çš„ï¼š</p>\n<ol>\n<li>æµæ²¡æœ‰æ‰“å¼€ï¼ˆstream_id &lt; 0ï¼‰</li>\n<li>æœ‰é€€å‡ºè¯·æ±‚ï¼ˆqueue-&gt;abort_requestï¼‰</li>\n<li>é…ç½®äº†AV_DISPOSITION_ATTACHED_PICï¼Ÿï¼ˆè¿™ä¸ªè¿˜ä¸ç†è§£ï¼Œåç»­åˆ†æattachementæ—¶å›å¤´çœ‹çœ‹ï¼‰</li>\n<li>é˜Ÿåˆ—å†…åŒ…ä¸ªæ•°å¤§äºMIN_FRAMESï¼ˆ&#x3D;25ï¼‰</li>\n</ol>\n<p>æŒºé¥¶åœ°ï¼Œæ²¡æœ‰æ·±åˆ»ä½“ä¼šå…¶è®¾è®¡ç”¨æ„ï¼Œä¸è¯„è®ºã€‚</p>\n<p>ä¸Šè¿°çš„å‡ ç§å¤„ç†éƒ½è¿˜æ˜¯åœ¨æ­£å¸¸æ’­æ”¾æµç¨‹å†…ï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹æ’­æ”¾å·²å®Œæˆæƒ…å†µçš„å¤„ç†ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (!is-&gt;paused &amp;&amp;<br>    (!is-&gt;audio_st || (is-&gt;auddec.finished == is-&gt;audioq.serial &amp;&amp; frame_queue_nb_remaining(&amp;is-&gt;sampq) == <span class=\"hljs-number\">0</span>)) &amp;&amp;<br>    (!is-&gt;video_st || (is-&gt;viddec.finished == is-&gt;videoq.serial &amp;&amp; frame_queue_nb_remaining(&amp;is-&gt;pictq) == <span class=\"hljs-number\">0</span>))) &#123;<br>    <span class=\"hljs-keyword\">if</span> (loop != <span class=\"hljs-number\">1</span> &amp;&amp; (!loop || --loop)) &#123;<br>        stream_seek(is, start_time != AV_NOPTS_VALUE ? start_time : <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>);<br>    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (autoexit) &#123;<br>        ret = AVERROR_EOF;<br>        <span class=\"hljs-keyword\">goto</span> fail;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>è¿™é‡Œåˆ¤æ–­æ’­æ”¾å·²å®Œæˆçš„æ¡ä»¶ä¾ç„¶å¾ˆâ€œffplayâ€ï¼Œéœ€è¦æ»¡è¶³ï¼š</p>\n<ol>\n<li>ä¸åœ¨æš‚åœçŠ¶æ€</li>\n<li>éŸ³é¢‘æœªæ‰“å¼€ï¼Œæˆ–è€…æ‰“å¼€äº†ï¼Œä½†æ˜¯è§£ç å·²è§£ç å®Œæ¯•ï¼Œserialç­‰äºPacketQueueçš„serialï¼Œå¹¶ä¸”PacketQueueä¸­æ²¡æœ‰èŠ‚ç‚¹äº†</li>\n<li>è§†é¢‘æœªæ‰“å¼€ï¼Œæˆ–è€…æ‰“å¼€äº†ï¼Œä½†æ˜¯è§£ç å·²è§£ç å®Œæ¯•ï¼Œserialç­‰äºPacketQueueçš„serialï¼Œå¹¶ä¸”PacketQueueä¸­æ²¡æœ‰èŠ‚ç‚¹äº†</li>\n</ol>\n<p>åœ¨ç¡®è®¤å·²ç»“æŸçš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·æœ‰ä¸¤ä¸ªå˜é‡å¯ä»¥æ§åˆ¶æ’­æ”¾å™¨è¡Œä¸ºï¼š</p>\n<ol>\n<li>loop: æ§åˆ¶æ’­æ”¾æ¬¡æ•°ï¼ˆå½“å‰è¿™æ¬¡ä¹Ÿç®—åœ¨å†…ï¼Œä¹Ÿå°±æ˜¯æœ€å°å°±æ˜¯1æ¬¡äº†ï¼‰ï¼Œ0è¡¨ç¤ºæ— é™æ¬¡</li>\n<li>autoexitï¼šè‡ªåŠ¨é€€å‡ºï¼Œä¹Ÿå°±æ˜¯æ’­æ”¾å®Œæˆåè‡ªåŠ¨é€€å‡ºã€‚</li>\n</ol>\n<p>loopæ¡ä»¶ç®€åŒ–çš„éå¸¸ä¸å‹å¥½ï¼Œå…¶æ„æ€æ˜¯ï¼šå¦‚æœloop&#x3D;&#x3D;1ï¼Œé‚£ä¹ˆå·²ç»æ’­äº†1æ¬¡äº†ï¼Œæ— éœ€å†seeké‡æ–°æ’­æ”¾ï¼›å¦‚æœloopä¸æ˜¯1ï¼Œ&#x3D;&#x3D;0ï¼Œéšæ„ï¼Œæ— é™æ¬¡å¾ªç¯ï¼›å‡1åè¿˜å¤§äº0ï¼ˆâ€“loopï¼‰ï¼Œä¹Ÿå…è®¸å¾ªç¯ã€‚ä¹Ÿå°±æ˜¯ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">allow_loop</span><span class=\"hljs-params\">()</span> &#123;<br>    <span class=\"hljs-keyword\">if</span> (loop == <span class=\"hljs-number\">1</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br><br>    <span class=\"hljs-keyword\">if</span> (loop == <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    --loop;<br>    <span class=\"hljs-keyword\">if</span> (loop &gt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>å‰é¢è®²äº†å¾ˆå¤šè¯»çº¿ç¨‹ä¸»å¾ªç¯å†…çš„å¤„ç†ï¼Œæ¯”å¦‚æš‚åœã€seekã€ç»“æŸloopå¤„ç†ç­‰ï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹çœŸæ­£è¯»çš„ä»£ç ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\">ret = av_read_frame(ic, pkt);<br><span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>    <span class=\"hljs-comment\">//æ–‡ä»¶è¯»å–å®Œäº†ï¼Œè°ƒç”¨packet_queue_put_nullpacketé€šçŸ¥è§£ç çº¿ç¨‹</span><br>    <span class=\"hljs-keyword\">if</span> ((ret == AVERROR_EOF || avio_feof(ic-&gt;pb)) &amp;&amp; !is-&gt;eof) &#123;<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;video_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            packet_queue_put_nullpacket(&amp;is-&gt;videoq, is-&gt;video_stream);<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;audio_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            packet_queue_put_nullpacket(&amp;is-&gt;audioq, is-&gt;audio_stream);<br>        <span class=\"hljs-keyword\">if</span> (is-&gt;subtitle_stream &gt;= <span class=\"hljs-number\">0</span>)<br>            packet_queue_put_nullpacket(&amp;is-&gt;subtitleq, is-&gt;subtitle_stream);<br>        is-&gt;eof = <span class=\"hljs-number\">1</span>;<br>    &#125;<br>    <span class=\"hljs-comment\">//å‘ç”Ÿé”™è¯¯äº†ï¼Œé€€å‡ºä¸»å¾ªç¯</span><br>    <span class=\"hljs-keyword\">if</span> (ic-&gt;pb &amp;&amp; ic-&gt;pb-&gt;error)<br>        <span class=\"hljs-keyword\">break</span>;<br><br>    <span class=\"hljs-comment\">//å¦‚æœéƒ½ä¸æ˜¯ï¼Œå¯èƒ½åªæ˜¯è¦ç­‰ä¸€ç­‰</span><br>    SDL_LockMutex(wait_mutex);<br>    SDL_CondWaitTimeout(is-&gt;continue_read_thread, wait_mutex, <span class=\"hljs-number\">10</span>);<br>    SDL_UnlockMutex(wait_mutex);<br>    <span class=\"hljs-keyword\">continue</span>;<br>&#125; <span class=\"hljs-keyword\">else</span> &#123;<br>    is-&gt;eof = <span class=\"hljs-number\">0</span>;<br>&#125;<br><br><span class=\"hljs-comment\">/* check if packet is in play range specified by user, then queue, otherwise discard */</span><br>stream_start_time = ic-&gt;streams[pkt-&gt;stream_index]-&gt;start_time;<br>pkt_ts = pkt-&gt;pts == AV_NOPTS_VALUE ? pkt-&gt;dts : pkt-&gt;pts;<br>pkt_in_play_range = duration == AV_NOPTS_VALUE ||<br>        (pkt_ts - (stream_start_time != AV_NOPTS_VALUE ? stream_start_time : <span class=\"hljs-number\">0</span>)) *<br>        av_q2d(ic-&gt;streams[pkt-&gt;stream_index]-&gt;time_base) -<br>        (<span class=\"hljs-type\">double</span>)(start_time != AV_NOPTS_VALUE ? start_time : <span class=\"hljs-number\">0</span>) / <span class=\"hljs-number\">1000000</span><br>        &lt;= ((<span class=\"hljs-type\">double</span>)duration / <span class=\"hljs-number\">1000000</span>);<br><br><span class=\"hljs-comment\">//å¦‚æœåœ¨æ—¶é—´èŒƒå›´å†…ï¼Œé‚£ä¹ˆæ ¹æ®stream_indexï¼Œæ”¾å…¥åˆ°è§†é¢‘ã€éŸ³é¢‘ã€ä¼šå­—å¹•çš„PacketQueueä¸­</span><br><span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == is-&gt;audio_stream &amp;&amp; pkt_in_play_range) &#123;<br>    packet_queue_put(&amp;is-&gt;audioq, pkt);<br>&#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == is-&gt;video_stream &amp;&amp; pkt_in_play_range<br>           &amp;&amp; !(is-&gt;video_st-&gt;disposition &amp; AV_DISPOSITION_ATTACHED_PIC)) &#123;<br>    packet_queue_put(&amp;is-&gt;videoq, pkt);<br>&#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (pkt-&gt;stream_index == is-&gt;subtitle_stream &amp;&amp; pkt_in_play_range) &#123;<br>    packet_queue_put(&amp;is-&gt;subtitleq, pkt);<br>&#125; <span class=\"hljs-keyword\">else</span> &#123;<br>    av_packet_unref(pkt);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>çœ‹èµ·æ¥å¾ˆé•¿ï¼Œå®é™…æ¯”ä¸Šè¿°å„ç§ç‰¹æ®Šæµç¨‹çš„å¤„ç†éƒ½ç›´ç™½ï¼Œä¸»è¦ä¸ºï¼š</p>\n<ol>\n<li>av_read_frameè¯»å–ä¸€ä¸ªåŒ…(AVPacket)</li>\n<li>è¿”å›å€¼å¤„ç†</li>\n<li>pkt_in_play_rangeè®¡ç®—</li>\n<li>packet_queue_putæ”¾å…¥å„è‡ªé˜Ÿåˆ—ï¼Œæˆ–è€…ä¸¢å¼ƒ</li>\n</ol>\n<p>æ­¥éª¤1ã€æ­¥éª¤2ã€æ­¥éª¤4ï¼Œéƒ½æ¯”è¾ƒç›´æ¥ï¼Œçœ‹æ³¨é‡Šå³å¯ã€‚</p>\n<p>è¿™é‡Œçœ‹ä¸‹pkt_in_play_rangeçš„è®¡ç®—ï¼Œæˆ‘ä»¬æŠŠä»¥ä¸Šä»£ç åˆ†è§£ä¸‹ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int64_t</span> <span class=\"hljs-title function_\">get_stream_start_time</span><span class=\"hljs-params\">(AVFormatContext* ic, <span class=\"hljs-type\">int</span> index)</span> &#123;<br>    <span class=\"hljs-type\">int64_t</span> stream_start_time = ic-&gt;streams[index]-&gt;start_time;<br>    <span class=\"hljs-keyword\">return</span> stream_start_time != AV_NOPTS_VALUE ? stream_start_time : <span class=\"hljs-number\">0</span>;<br>&#125;<br><br><span class=\"hljs-type\">int64_t</span> <span class=\"hljs-title function_\">get_pkt_ts</span><span class=\"hljs-params\">(AVPacket* pkt)</span> &#123;<span class=\"hljs-comment\">//ts: timestampï¼ˆæ—¶é—´æˆ³ï¼‰çš„ç¼©å†™</span><br>    <span class=\"hljs-keyword\">return</span> pkt-&gt;pts == AV_NOPTS_VALUE ? pkt-&gt;dts : pkt-&gt;pts;<br>&#125;<br><br><span class=\"hljs-type\">double</span> <span class=\"hljs-title function_\">ts_as_second</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int64_t</span> tsï¼ŒAVFormatContext* icï¼Œ<span class=\"hljs-type\">int</span> index)</span> &#123;<br>    <span class=\"hljs-keyword\">return</span> ts * av_q2d(ic-&gt;streams[index]-&gt;time_base);<br>&#125; <br><br><span class=\"hljs-type\">double</span> <span class=\"hljs-title function_\">get_ic_start_time</span><span class=\"hljs-params\">(AVFormatContext* ic)</span> &#123;<span class=\"hljs-comment\">//icä¸­çš„æ—¶é—´å•ä½æ˜¯us</span><br>    <span class=\"hljs-keyword\">return</span> (start_time != AV_NOPTS_VALUE ? start_time : <span class=\"hljs-number\">0</span>) / <span class=\"hljs-number\">1000000</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æœ‰äº†è¿™äº›å‡½æ•°ï¼Œå°±å¯ä»¥è®¡ç®—pkt_in_play_rangeäº†ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">is_pkt_in_play_range</span><span class=\"hljs-params\">(AVFormatContext* ic, AVPacket* pkt)</span> &#123;<br>    <span class=\"hljs-keyword\">if</span> (duration == AV_NOPTS_VALUE) <span class=\"hljs-comment\">//å¦‚æœå½“å‰æµæ— æ³•è®¡ç®—æ€»æ—¶é•¿ï¼ŒæŒ‰æ— é™æ—¶é•¿å¤„ç†</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br><br>    <span class=\"hljs-comment\">//è®¡ç®—pktç›¸å¯¹streamä½ç½®</span><br>    <span class=\"hljs-type\">int64_t</span> stream_ts = get_pkt_ts(pkt) - get_stream_start_time(ic, pkt-&gt;stream_index);<br>    <span class=\"hljs-type\">double</span> stream_ts_s = ts_as_second(stream_ts, ic, pkt-&gt;stream_index);<br><br>    <span class=\"hljs-comment\">//è®¡ç®—pktç›¸å¯¹icä½ç½®</span><br>    <span class=\"hljs-type\">double</span> ic_ts = stream_ts_s - get_ic_start_time(ic);<br><br>    <span class=\"hljs-comment\">//æ˜¯å¦åœ¨æ—¶é—´èŒƒå›´å†…</span><br>    <span class=\"hljs-keyword\">return</span> ic_ts &lt;= ((<span class=\"hljs-type\">double</span>)duration / <span class=\"hljs-number\">1000000</span>);<br>&#125;<br></code></pre></td></tr></table></figure>\n"},{"layout":"post","title":"ffplay video_thread åˆ†æ","date":"2022-03-21T16:00:00.000Z","_content":"\nå»é™¤æ»¤é•œç›¸å…³ï¼Œç®€åŒ–ä¸º\n\n```\nstatic int video_thread(void *arg)\n{\n    for (;;) {\n        //è·å–è§£ç åçš„frame\n        ret = get_video_frame(is, frame);\n        if (ret < 0) //æ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼Œç»“æŸå¾ªç¯\n            goto the_end;\n        if (!ret)\n            continue;\n        //æ ¹æ®å¸§ç‡ï¼Œè®¡ç®—frameçš„æ’­æ”¾æŒç»­æ—¶é—´\n        duration = (frame_rate.num && frame_rate.den ? av_q2d((AVRational){frame_rate.den, frame_rate.num}) : 0);\n        //æ ¹æ®è§†é¢‘æµæ—¶é—´åŸºè®¡ç®—pts\n        pts = (frame->pts == AV_NOPTS_VALUE) ? NAN : frame->pts * av_q2d(tb);\n        //æ”¾å…¥frameé˜Ÿåˆ—\n        ret = queue_picture(is, frame, pts, duration, frame->pkt_pos, is->viddec.pkt_serial);\n        //å–æ¶ˆå¼•ç”¨frame\n        av_frame_unref(frame);\n     }\n}\n```\n\næ•´ä½“å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œè°ƒç”¨get_video_frame è·å–è§£ç åframeï¼Œ è°ƒç”¨queue_picture å°†frameæ”¾å…¥è§£ç åçš„é˜Ÿåˆ—ã€‚\n\n## get_video_frame\n\n```c\nstatic int get_video_frame(VideoState *is, AVFrame *frame)\n{\n    int got_picture;\n    //è§£ç ï¼Œå°†è§£ç åçš„æ•°æ®æ”¾å…¥frameä¸­\n    if ((got_picture = decoder_decode_frame(&is->viddec, frame, NULL)) < 0)\n        return -1;//å¤„ç†abort\n\n    if (got_picture) {\n        double dpts = NAN;\n\n        if (frame->pts != AV_NOPTS_VALUE)\n            dpts = av_q2d(is->video_st->time_base) * frame->pts;\n\n        frame->sample_aspect_ratio = av_guess_sample_aspect_ratio(is->ic, is->video_st, frame);\n        //å¤„ç†ä¸¢å¸§\n        if (framedrop>0 || (framedrop && get_master_sync_type(is) != AV_SYNC_VIDEO_MASTER)) {\n            if (frame->pts != AV_NOPTS_VALUE) {\n                double diff = dpts - get_master_clock(is);\n                if (!isnan(diff) && fabs(diff) < AV_NOSYNC_THRESHOLD &&\n                    diff - is->frame_last_filter_delay < 0 &&\n                    is->viddec.pkt_serial == is->vidclk.serial &&\n                    is->videoq.nb_packets) {\n                    is->frame_drops_early++;\n                    av_frame_unref(frame);\n                    got_picture = 0;\n                }\n            }\n        }\n    }\n    return got_picture;\n}\n```\n\nget_video_frame è°ƒç”¨decoder_decode_frame è·å–è§£ç åçš„ä¸€å¸§æ•°æ®ã€‚\n\nè·å–frameåï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†ä¸¢å¸§ï¼Œåšä¸¢å¸§å¤„ç†ã€‚\n\nè¿”å›å€¼: æˆåŠŸè·å–frame(>0)ï¼Œ è¢«ä¸¢å¸§ï¼ˆ=0ï¼‰ï¼Œæ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼ˆ-1ï¼‰\n\n## decoder_decode_frame\n\néœ€è¦å…ˆå…³æ³¨ä¸€ä¸ªç»“æ„ä½“Decoder\n\n```\ntypedef struct Decoder {\n    //è§£ç å‰æ•°æ®\n    AVPacket *pkt;\n    //pkté˜Ÿåˆ—\n    PacketQueue *queue;\n    //è§£ç å™¨ä¸Šä¸‹æ–‡\n    AVCodecContext *avctx;\n    int pkt_serial;\n    int finished;\n    int packet_pending; //æ ‡è®°å½“å‰pktæœªè¢«æˆåŠŸæ¶ˆè´¹ï¼Œåç»­éœ€è¦é‡æ–°å¤„ç†\n    SDL_cond *empty_queue_cond; //ç»‘å®šread_threadçº¿ç¨‹çš„continue_read_thread\n    int64_t start_pts;\n    AVRational start_pts_tb;\n    int64_t next_pts;\n    AVRational next_pts_tb;\n    SDL_Thread *decoder_tid;\n} Decoder;\n```\n\nåœ¨VideoState ç»“æ„ä½“ä¸­,ä¿å­˜äº†éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•è§£ç ç›¸å…³çš„Decoderå®ä¾‹ã€‚\n\n```\nDecoder auddec;\nDecoder viddec;\nDecoder subdec;\n```\n\ndecoder_decode_frame æ ¹æ® Decoderï¼Œ å®ç°éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•è§£ç çš„ä¸»è¦é€»è¾‘ã€‚\n\n```\nstatic int decoder_decode_frame(Decoder *d, AVFrame *frame, AVSubtitle *sub) {\n    int ret = AVERROR(EAGAIN);\n    for (;;) {\nÂ Â Â Â  Â Â //.....\nÂ Â Â Â }Â Â Â Â \n}\n```\n\næ•´ä½“åˆæ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œ æˆ‘ä»¬æŠŠå®ƒæ‹†å¼€çœ‹\n\n```c\nif (d->queue->serial == d->pkt_serial) {\n    //åˆ¤æ–­packetqueueçš„åºåˆ—å·ç­‰äºDecoderçš„åºåˆ—å·\n    //packetqueueçš„åºåˆ—å·ï¼Œåœ¨å‘ç”Ÿseekæ“ä½œåï¼Œä¼š+1\n    do {\n        if (d->queue->abort_request)\n            //å¦‚æœæ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼Œè¿”å›-1\n            return -1;\n\n        switch (d->avctx->codec_type) {\n            case AVMEDIA_TYPE_VIDEO:\n                //ä»è§£ç å™¨è¯»frame\n                ret = avcodec_receive_frame(d->avctx, frame);\n                if (ret >= 0) {\n                    //è¯»åˆ°äº†frame, è®¾ç½®frameçš„pts\n                    //decoder_reorder_pts: let decoder reorder pts 0=off 1=on -1=auto\n                    if (decoder_reorder_pts == -1) {\n                        frame->pts = frame->best_effort_timestamp;\n                    } else if (!decoder_reorder_pts) {\n                        frame->pts = frame->pkt_dts;\n                    }\n                }\n                break;\n            case AVMEDIA_TYPE_AUDIO:\n                //ä»è§£ç å™¨è¯»frame\n                ret = avcodec_receive_frame(d->avctx, frame);\n                if (ret >= 0) {\n                    //è¯»åˆ°äº†frameï¼Œè®¾ç½®frameçš„pts\n                    AVRational tb = (AVRational){1, frame->sample_rate};\n                    if (frame->pts != AV_NOPTS_VALUE)\n                        //ptsè½¬æ¢ï¼Œä»ç¼–ç å™¨çš„æ—¶é—´åŸºï¼Œè½¬æ¢ä¸ºtbä½œä¸ºæ—¶é—´åŸº\n                        frame->pts = av_rescale_q(frame->pts, d->avctx->pkt_timebase, tb);\n                    else if (d->next_pts != AV_NOPTS_VALUE)\n                        //frameçš„ptsæ²¡æœ‰å€¼ï¼Œå‚è€ƒd->next_ptsï¼Œå¹¶åšæ—¶é—´åŸºçš„è½¬åŒ–\n                        frame->pts = av_rescale_q(d->next_pts, d->next_pts_tb, tb);\n                    if (frame->pts != AV_NOPTS_VALUE) {\n                        //è®¡ç®—next_ptsï¼Œä¼šè¢«æ²¡æœ‰ptsçš„Frameå‚è€ƒ\n                        //ä¿å­˜next_pts_tb\n                        d->next_pts = frame->pts + frame->nb_samples;\n                        d->next_pts_tb = tb;\n                    }\n                }\n                break;\n        }\n        if (ret == AVERROR_EOF) {\n            //è§£ç å™¨ç»“æŸï¼Œæ‰€æœ‰çš„å¸§å·²ç»è¢«è¯»å‡º\n            d->finished = d->pkt_serial;\n            //é‡ç½®è§£ç å™¨å†…éƒ¨çŠ¶æ€\n            avcodec_flush_buffers(d->avctx);\n            return 0;\n        }\n        if (ret >= 0)\n            return 1;\n    } while (ret != AVERROR(EAGAIN)); //éœ€è¦é€å…¥æ›´å¤šçš„pkts\n}\n```\n\nä¸€ä¸ªifæ¡ä»¶ï¼Œå†…åµŒä¸€ä¸ªdo.whileå¾ªç¯ã€‚\n\né¦–å…ˆ if åˆ¤æ–­`d->queue->serial == d->pkt_serial`ï¼Œä¿è¯å½“å‰è¦å¤„ç†çš„pktä¸pkt->queueçš„åºåˆ—å·ä¸€è‡´ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œè¯æ˜æ˜¯è¯¥pktå’Œpkt->queueä¸­å…ƒç´ ï¼Œæ˜¯ä¸¤æ®µä¸è¿ç»­çš„æ•°æ®ï¼Œè¿›å…¥åç»­æµç¨‹ï¼Œåšä¸¢å¸§å¤„ç†ã€‚\n\nå¦‚æœåºåˆ—å·ä¸€è‡´ï¼Œè¿›å…¥å¾ªç¯ï¼Œå°è¯•ä»è§£ç å™¨è·å–frameã€‚\n\næˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªå¾ªç¯\n\n1. åˆ¤æ–­æ˜¯å¦æ”¶åˆ°é€€å‡ºè¯·æ±‚\n\n2. switchåˆ¤æ–­è§£ç å™¨çš„ç±»å‹ï¼Œå¤„ç†audio å’Œ video çš„æƒ…å†µã€‚ è°ƒç”¨avcodec_receive_frame å°è¯•ä»è§£ç å™¨è·å–frameã€‚ è¿”å›å€¼>=0 ä»£è¡¨è·å–æˆåŠŸï¼Œè½¬æ¢frameçš„pts\n\n3. å¤„ç†avcodec_receive_frameçš„è¿”å›å€¼ã€‚\n   \n   - ret = AVERROR_EOF è§£ç å™¨æ‰€æœ‰çš„å¸§å·²è¢«è¯»å‡ºï¼Œè§£ç ç»“æŸï¼Œè¿”å›0.\n   \n   - ret >= 0,  æˆåŠŸè·å–äº†frameï¼Œ ç›´æ¥è¿”å› 1\n   \n   - ret = AVERROR(EAGAIN)ï¼Œ è§£ç å™¨éœ€è¦æ¥å—æ›´å¤špktæ‰å¯ä»¥è¾“å‡ºframeï¼Œè·³å‡ºdo.whileå¾ªç¯ã€‚\n\nä¸Šä¸€é˜¶æ®µå°è¯•ä»è§£ç å™¨ä¸­è¯»å–frameï¼Œ ä½†æ˜¯è§£ç å™¨æŠ¥å‘ŠAVERROR(EAGAIN)ï¼Œéœ€è¦æ›´å¤šçš„pkt æ‰èƒ½äº§å‡ºframeã€‚ é‚£ä¹ˆä¸‹ä¸€é˜¶æ®µå¤„ç†è·å–pktï¼Œç»™è§£ç å‘é€pktã€‚\n\n```c\ndo {\n    if (d->queue->nb_packets == 0)\n        //pkté˜Ÿåˆ—ä¸ºç©ºï¼Œé€šçŸ¥read_threadå»è·å–æ›´å¤šæ•°æ®\n        SDL_CondSignal(d->empty_queue_cond);\n    if (d->packet_pending) {\n        d->packet_pending = 0;\n    } else {\n        int old_serial = d->pkt_serial;\n        if (packet_queue_get(d->queue, d->pkt, 1, &d->pkt_serial) < 0)\n            return -1;\n        //å¦‚æœæ–°çš„pktçš„åºåˆ—å·ï¼Œå’Œä¹‹å‰çš„ä¸ä¸€è‡´ã€‚å¯èƒ½æ˜¯å‘ç”Ÿäº†seekæ“ä½œï¼Œä¸¤æ®µæ•°æ®ä¸è¿ç»­äº†\n        //å†²æ´—è§£ç å™¨\n        if (old_serial != d->pkt_serial) {\n            //å†²æ´—è§£ç å™¨å†…éƒ¨çš„buffer\n            avcodec_flush_buffers(d->avctx);\n            d->finished = 0;\n            //æ›´æ–°ptsï¼Œ timebase\n            d->next_pts = d->start_pts;\n            d->next_pts_tb = d->start_pts_tb;\n        }\n    }\n    //åˆ¤æ–­åºåˆ—å·æ˜¯å¦æ»¡è¶³\n    if (d->queue->serial == d->pkt_serial)\n        break;\n    //è¿‡æ»¤æ‰åºåˆ—å·ä¸æ»¡è¶³æ¡ä»¶çš„pkt\n    av_packet_unref(d->pkt);\n} while (1);\n```\n\nåˆæ˜¯ä¸€ä¸ªdo.while å¾ªç¯ã€‚\n\n1. å¦‚æœpkt-queueä¸ºç©ºï¼Œè°ƒç”¨SDL_CondSignalï¼Œé€šçŸ¥read_threadå»è·å–æ›´å¤šçš„pkt\n\n2. å¦‚æœd->packet_pendingä¸ºtrue,  å°†d->packet_pendingæ ‡è®°ä¸ºfalseã€‚åœ¨ä¸‹ä¸€é˜¶æ®µï¼Œå°†pktå‘é€ç»™è§£ç å™¨æ—¶ï¼Œå¦‚æœè§£ç å™¨çš„pkté˜Ÿåˆ—å·²æ»¡ï¼Œæ— æ³•æ¥å—d- >pktã€‚ é€šè¿‡å°†d->packet_pendingè®¾ç½®ä¸º1ï¼Œ æ ‡è®°d- >pkt ä¸ºå¾…å¤„ç†ï¼Œä¸‹æ¬¡é‡æ–°å°†d->pktå‘é€ç»™è§£ç å™¨ã€‚\n\n3. æ²¡æœ‰å¾…å¤„ç†pktï¼Œè°ƒç”¨packet_queue_getä»d->queueä¸­è·å–ä¸€ä¸ªpktã€‚å…¶ä¸­ packet_queue_get çš„ç¬¬ä¸‰ä¸ªå‚æ•°block è¢«è®¾ç½®ä¸º1ï¼Œ åœ¨è·å–ptkçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ptk queue ä¸ºç©ºï¼Œå†…éƒ¨è°ƒç”¨SDL_CondWaitå°†çº¿ç¨‹ç½®äºç­‰å¾…çŠ¶æ€ã€‚\n\n4. å¦‚æœä»é˜Ÿåˆ—é‡Œè·å¾—äº†pktï¼Œpktçš„åºåˆ—å·å’ŒDecoderä¹‹å‰ä¿å­˜çš„pktçš„åºåˆ—å·ä¸ä¸€è‡´ã€‚ä¾‹å¦‚å‘ç”Ÿäº†seekï¼Œä¸­é—´æ•°æ®ä¸è¿ç»­äº†ï¼Œæ­¤æ—¶è°ƒç”¨avcodec_flush_bufferså†²æ´—è§£ç å™¨å†…éƒ¨bufferï¼Œè®©è§£ç å™¨å‡†å¤‡å¥½ä»seekä½ç½®å¼€å§‹è§£ç ã€‚\n\n5. å¾ªç¯å°†pktåºåˆ—å·ä¸ä¸€è‡´çš„pktè°ƒç”¨av_packet_unref(d->pkt);ä¸¢å¼ƒï¼Œç›´åˆ°`d->queue->serial == d->pkt_serial`,æ­¤æ—¶è·å–äº†ä¸€ä¸ªpktã€‚\n\nå‰é¢è§£ç å™¨è¦æ›´å¤šçš„ptkæ‰å¯ä»¥è¾“å‡ºframe, ç„¶åç¬¬äºŒé˜¶æ®µæˆ‘ä»¬ä»pkt queueä¸­ä¹Ÿè·å–åˆ°äº†ä¸€ä¸ªpktï¼Œä¸‹ä¸€æ­¥å°†è·å–çš„pktå‘é€ç»™è§£ç å™¨äº†\n\n```c\nif (d->avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {\n    int got_frame = 0;\n    //Return a negative value on error, otherwise return the number of bytes used\n    ret = avcodec_decode_subtitle2(d->avctx, sub, &got_frame, d->pkt);\n    if (ret < 0) {\n        //è§£ç å‘ç”Ÿäº†é”™è¯¯ï¼Œä¸ºäº†å’Œavcodec_send_packetçš„é”™è¯¯ç ä¸€èµ·å¤„ç†ï¼Œè½¬æ¢ä¸ºAVERROR(EAGAIN)ï¼Œå°è¯•ç»§ç»­å‘é€pkt\n        ret = AVERROR(EAGAIN);\n    } else {\n        if (got_frame && !d->pkt->data) {\n            //d->pkt->data = NULL ä»£è¡¨ç»™è§£ç å™¨å‘é€flushæ¶ˆæ¯ï¼Œ\n            //éœ€è¦æŒç»­ç»™è§£ç å™¨flushæ¶ˆæ¯ï¼Œç›´åˆ°æ— æ³•ç»§ç»­è¯»å–åˆ°æ–°çš„frame, \n            //å› æ­¤å°†packet_pendingè®¾ç½®ä¸º1,æ ‡è®°å½“å‰pktä¸ºå¾…å¤„ç†ï¼Œç›´åˆ°flushå®Œæˆ\n            d->packet_pending = 1;\n        }\n        ret = got_frame ? 0 : (d->pkt->data ? AVERROR(EAGAIN) : AVERROR_EOF);\n    }\n    av_packet_unref(d->pkt);\n} else {\n    //ç»™éŸ³è§†é¢‘è§£ç å™¨å‘é€pkt\n    if (avcodec_send_packet(d->avctx, d->pkt) == AVERROR(EAGAIN)) {\n        //æŠ¥é”™AVERROR(EAGAIN)ï¼Œè§£ç å™¨æ­¤æ—¶ä¸èƒ½æ¥å—æ›´å¤šäº†pkt\n        //éœ€è¦è°ƒç”¨avcodec_receive_frameå°†è§£ç å™¨ä¸­çš„frameè¯»å‡ºæ‰å¯ä»¥ç»§ç»­send pkt\n        av_log(d->avctx, AV_LOG_ERROR, \"Receive_frame and send_packet both returned EAGAIN, which is an API violation.\\n\");\n        //æ¯”è¾ƒå½“å‰pktæœªè¢«æˆåŠŸæ¶ˆè´¹ï¼Œåç»­éœ€è¦é‡æ–°å¤„ç†\n        d->packet_pending = 1;\n    } else {\n        //send pkt æˆåŠŸï¼Œå¼•ç”¨è®¡æ•°-1\n        av_packet_unref(d->pkt);\n    }\n}\n```\n\nè¿™é‡Œå­—å¹•è§£ç å™¨å‘é€pkt è°ƒç”¨çš„æ˜¯ avcodec_decode_subtitle2 \n\nç»™éŸ³è§†é¢‘è§£ç å™¨å‘é€pkt è°ƒç”¨çš„æ˜¯ avcodec_send_packetã€‚\n\næ³¨æ„å‘é€pktè¿”å›AVERROR(EAGAIN)ï¼Œ æ­¤æ—¶è§£ç å™¨æ— æ³•æ¥å—å½“å‰pktï¼ˆå¯èƒ½æ˜¯å†…éƒ¨çš„pktçš„é˜Ÿåˆ—æ»¡äº†ï¼‰ã€‚é€šè¿‡`d->packet_pending = 1`å°†pktæ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œä¸‹æ¬¡å¾ªç¯ï¼Œé‡æ–°å°è¯•å‘é€ç»™è§£ç å™¨è§£ç ã€‚\n\n\n\nå¦‚æœè§£ç å™¨æˆåŠŸæ¶ˆè´¹äº†pktï¼Œç»§ç»­è¿›å…¥å¾ªç¯ã€‚å›åˆ°è¯»frameçš„é˜¶æ®µï¼Œè¯»åˆ°äº†frameï¼Œå°±è¿”å›ç»™ä¸Šå±‚å»åŠ å…¥é˜Ÿåˆ—ã€‚\n\n\n\n\n\n## æ€»ç»“\n\n video_threadçš„å·¥ä½œæ˜¯å¾ªç¯ä»pkt queue å–å‡ºpktï¼Œé€ç»™è§£ç å™¨è§£ç ï¼Œå°†è§£ç åçš„frame æ”¾å…¥frame queueã€‚\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16479425075661647942506708.png)\n\n\n\n\n","source":"_posts/ffmpeg/2022-03-22-ffplay video_thread åˆ†æ.md","raw":"---\nlayout: post\ntitle: \"ffplay video_thread åˆ†æ\"\ndate: 2022-03-22\ntag: ffmpeg\n\n---\n\nå»é™¤æ»¤é•œç›¸å…³ï¼Œç®€åŒ–ä¸º\n\n```\nstatic int video_thread(void *arg)\n{\n    for (;;) {\n        //è·å–è§£ç åçš„frame\n        ret = get_video_frame(is, frame);\n        if (ret < 0) //æ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼Œç»“æŸå¾ªç¯\n            goto the_end;\n        if (!ret)\n            continue;\n        //æ ¹æ®å¸§ç‡ï¼Œè®¡ç®—frameçš„æ’­æ”¾æŒç»­æ—¶é—´\n        duration = (frame_rate.num && frame_rate.den ? av_q2d((AVRational){frame_rate.den, frame_rate.num}) : 0);\n        //æ ¹æ®è§†é¢‘æµæ—¶é—´åŸºè®¡ç®—pts\n        pts = (frame->pts == AV_NOPTS_VALUE) ? NAN : frame->pts * av_q2d(tb);\n        //æ”¾å…¥frameé˜Ÿåˆ—\n        ret = queue_picture(is, frame, pts, duration, frame->pkt_pos, is->viddec.pkt_serial);\n        //å–æ¶ˆå¼•ç”¨frame\n        av_frame_unref(frame);\n     }\n}\n```\n\næ•´ä½“å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œè°ƒç”¨get_video_frame è·å–è§£ç åframeï¼Œ è°ƒç”¨queue_picture å°†frameæ”¾å…¥è§£ç åçš„é˜Ÿåˆ—ã€‚\n\n## get_video_frame\n\n```c\nstatic int get_video_frame(VideoState *is, AVFrame *frame)\n{\n    int got_picture;\n    //è§£ç ï¼Œå°†è§£ç åçš„æ•°æ®æ”¾å…¥frameä¸­\n    if ((got_picture = decoder_decode_frame(&is->viddec, frame, NULL)) < 0)\n        return -1;//å¤„ç†abort\n\n    if (got_picture) {\n        double dpts = NAN;\n\n        if (frame->pts != AV_NOPTS_VALUE)\n            dpts = av_q2d(is->video_st->time_base) * frame->pts;\n\n        frame->sample_aspect_ratio = av_guess_sample_aspect_ratio(is->ic, is->video_st, frame);\n        //å¤„ç†ä¸¢å¸§\n        if (framedrop>0 || (framedrop && get_master_sync_type(is) != AV_SYNC_VIDEO_MASTER)) {\n            if (frame->pts != AV_NOPTS_VALUE) {\n                double diff = dpts - get_master_clock(is);\n                if (!isnan(diff) && fabs(diff) < AV_NOSYNC_THRESHOLD &&\n                    diff - is->frame_last_filter_delay < 0 &&\n                    is->viddec.pkt_serial == is->vidclk.serial &&\n                    is->videoq.nb_packets) {\n                    is->frame_drops_early++;\n                    av_frame_unref(frame);\n                    got_picture = 0;\n                }\n            }\n        }\n    }\n    return got_picture;\n}\n```\n\nget_video_frame è°ƒç”¨decoder_decode_frame è·å–è§£ç åçš„ä¸€å¸§æ•°æ®ã€‚\n\nè·å–frameåï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†ä¸¢å¸§ï¼Œåšä¸¢å¸§å¤„ç†ã€‚\n\nè¿”å›å€¼: æˆåŠŸè·å–frame(>0)ï¼Œ è¢«ä¸¢å¸§ï¼ˆ=0ï¼‰ï¼Œæ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼ˆ-1ï¼‰\n\n## decoder_decode_frame\n\néœ€è¦å…ˆå…³æ³¨ä¸€ä¸ªç»“æ„ä½“Decoder\n\n```\ntypedef struct Decoder {\n    //è§£ç å‰æ•°æ®\n    AVPacket *pkt;\n    //pkté˜Ÿåˆ—\n    PacketQueue *queue;\n    //è§£ç å™¨ä¸Šä¸‹æ–‡\n    AVCodecContext *avctx;\n    int pkt_serial;\n    int finished;\n    int packet_pending; //æ ‡è®°å½“å‰pktæœªè¢«æˆåŠŸæ¶ˆè´¹ï¼Œåç»­éœ€è¦é‡æ–°å¤„ç†\n    SDL_cond *empty_queue_cond; //ç»‘å®šread_threadçº¿ç¨‹çš„continue_read_thread\n    int64_t start_pts;\n    AVRational start_pts_tb;\n    int64_t next_pts;\n    AVRational next_pts_tb;\n    SDL_Thread *decoder_tid;\n} Decoder;\n```\n\nåœ¨VideoState ç»“æ„ä½“ä¸­,ä¿å­˜äº†éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•è§£ç ç›¸å…³çš„Decoderå®ä¾‹ã€‚\n\n```\nDecoder auddec;\nDecoder viddec;\nDecoder subdec;\n```\n\ndecoder_decode_frame æ ¹æ® Decoderï¼Œ å®ç°éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•è§£ç çš„ä¸»è¦é€»è¾‘ã€‚\n\n```\nstatic int decoder_decode_frame(Decoder *d, AVFrame *frame, AVSubtitle *sub) {\n    int ret = AVERROR(EAGAIN);\n    for (;;) {\nÂ Â Â Â  Â Â //.....\nÂ Â Â Â }Â Â Â Â \n}\n```\n\næ•´ä½“åˆæ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œ æˆ‘ä»¬æŠŠå®ƒæ‹†å¼€çœ‹\n\n```c\nif (d->queue->serial == d->pkt_serial) {\n    //åˆ¤æ–­packetqueueçš„åºåˆ—å·ç­‰äºDecoderçš„åºåˆ—å·\n    //packetqueueçš„åºåˆ—å·ï¼Œåœ¨å‘ç”Ÿseekæ“ä½œåï¼Œä¼š+1\n    do {\n        if (d->queue->abort_request)\n            //å¦‚æœæ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼Œè¿”å›-1\n            return -1;\n\n        switch (d->avctx->codec_type) {\n            case AVMEDIA_TYPE_VIDEO:\n                //ä»è§£ç å™¨è¯»frame\n                ret = avcodec_receive_frame(d->avctx, frame);\n                if (ret >= 0) {\n                    //è¯»åˆ°äº†frame, è®¾ç½®frameçš„pts\n                    //decoder_reorder_pts: let decoder reorder pts 0=off 1=on -1=auto\n                    if (decoder_reorder_pts == -1) {\n                        frame->pts = frame->best_effort_timestamp;\n                    } else if (!decoder_reorder_pts) {\n                        frame->pts = frame->pkt_dts;\n                    }\n                }\n                break;\n            case AVMEDIA_TYPE_AUDIO:\n                //ä»è§£ç å™¨è¯»frame\n                ret = avcodec_receive_frame(d->avctx, frame);\n                if (ret >= 0) {\n                    //è¯»åˆ°äº†frameï¼Œè®¾ç½®frameçš„pts\n                    AVRational tb = (AVRational){1, frame->sample_rate};\n                    if (frame->pts != AV_NOPTS_VALUE)\n                        //ptsè½¬æ¢ï¼Œä»ç¼–ç å™¨çš„æ—¶é—´åŸºï¼Œè½¬æ¢ä¸ºtbä½œä¸ºæ—¶é—´åŸº\n                        frame->pts = av_rescale_q(frame->pts, d->avctx->pkt_timebase, tb);\n                    else if (d->next_pts != AV_NOPTS_VALUE)\n                        //frameçš„ptsæ²¡æœ‰å€¼ï¼Œå‚è€ƒd->next_ptsï¼Œå¹¶åšæ—¶é—´åŸºçš„è½¬åŒ–\n                        frame->pts = av_rescale_q(d->next_pts, d->next_pts_tb, tb);\n                    if (frame->pts != AV_NOPTS_VALUE) {\n                        //è®¡ç®—next_ptsï¼Œä¼šè¢«æ²¡æœ‰ptsçš„Frameå‚è€ƒ\n                        //ä¿å­˜next_pts_tb\n                        d->next_pts = frame->pts + frame->nb_samples;\n                        d->next_pts_tb = tb;\n                    }\n                }\n                break;\n        }\n        if (ret == AVERROR_EOF) {\n            //è§£ç å™¨ç»“æŸï¼Œæ‰€æœ‰çš„å¸§å·²ç»è¢«è¯»å‡º\n            d->finished = d->pkt_serial;\n            //é‡ç½®è§£ç å™¨å†…éƒ¨çŠ¶æ€\n            avcodec_flush_buffers(d->avctx);\n            return 0;\n        }\n        if (ret >= 0)\n            return 1;\n    } while (ret != AVERROR(EAGAIN)); //éœ€è¦é€å…¥æ›´å¤šçš„pkts\n}\n```\n\nä¸€ä¸ªifæ¡ä»¶ï¼Œå†…åµŒä¸€ä¸ªdo.whileå¾ªç¯ã€‚\n\né¦–å…ˆ if åˆ¤æ–­`d->queue->serial == d->pkt_serial`ï¼Œä¿è¯å½“å‰è¦å¤„ç†çš„pktä¸pkt->queueçš„åºåˆ—å·ä¸€è‡´ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œè¯æ˜æ˜¯è¯¥pktå’Œpkt->queueä¸­å…ƒç´ ï¼Œæ˜¯ä¸¤æ®µä¸è¿ç»­çš„æ•°æ®ï¼Œè¿›å…¥åç»­æµç¨‹ï¼Œåšä¸¢å¸§å¤„ç†ã€‚\n\nå¦‚æœåºåˆ—å·ä¸€è‡´ï¼Œè¿›å…¥å¾ªç¯ï¼Œå°è¯•ä»è§£ç å™¨è·å–frameã€‚\n\næˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªå¾ªç¯\n\n1. åˆ¤æ–­æ˜¯å¦æ”¶åˆ°é€€å‡ºè¯·æ±‚\n\n2. switchåˆ¤æ–­è§£ç å™¨çš„ç±»å‹ï¼Œå¤„ç†audio å’Œ video çš„æƒ…å†µã€‚ è°ƒç”¨avcodec_receive_frame å°è¯•ä»è§£ç å™¨è·å–frameã€‚ è¿”å›å€¼>=0 ä»£è¡¨è·å–æˆåŠŸï¼Œè½¬æ¢frameçš„pts\n\n3. å¤„ç†avcodec_receive_frameçš„è¿”å›å€¼ã€‚\n   \n   - ret = AVERROR_EOF è§£ç å™¨æ‰€æœ‰çš„å¸§å·²è¢«è¯»å‡ºï¼Œè§£ç ç»“æŸï¼Œè¿”å›0.\n   \n   - ret >= 0,  æˆåŠŸè·å–äº†frameï¼Œ ç›´æ¥è¿”å› 1\n   \n   - ret = AVERROR(EAGAIN)ï¼Œ è§£ç å™¨éœ€è¦æ¥å—æ›´å¤špktæ‰å¯ä»¥è¾“å‡ºframeï¼Œè·³å‡ºdo.whileå¾ªç¯ã€‚\n\nä¸Šä¸€é˜¶æ®µå°è¯•ä»è§£ç å™¨ä¸­è¯»å–frameï¼Œ ä½†æ˜¯è§£ç å™¨æŠ¥å‘ŠAVERROR(EAGAIN)ï¼Œéœ€è¦æ›´å¤šçš„pkt æ‰èƒ½äº§å‡ºframeã€‚ é‚£ä¹ˆä¸‹ä¸€é˜¶æ®µå¤„ç†è·å–pktï¼Œç»™è§£ç å‘é€pktã€‚\n\n```c\ndo {\n    if (d->queue->nb_packets == 0)\n        //pkté˜Ÿåˆ—ä¸ºç©ºï¼Œé€šçŸ¥read_threadå»è·å–æ›´å¤šæ•°æ®\n        SDL_CondSignal(d->empty_queue_cond);\n    if (d->packet_pending) {\n        d->packet_pending = 0;\n    } else {\n        int old_serial = d->pkt_serial;\n        if (packet_queue_get(d->queue, d->pkt, 1, &d->pkt_serial) < 0)\n            return -1;\n        //å¦‚æœæ–°çš„pktçš„åºåˆ—å·ï¼Œå’Œä¹‹å‰çš„ä¸ä¸€è‡´ã€‚å¯èƒ½æ˜¯å‘ç”Ÿäº†seekæ“ä½œï¼Œä¸¤æ®µæ•°æ®ä¸è¿ç»­äº†\n        //å†²æ´—è§£ç å™¨\n        if (old_serial != d->pkt_serial) {\n            //å†²æ´—è§£ç å™¨å†…éƒ¨çš„buffer\n            avcodec_flush_buffers(d->avctx);\n            d->finished = 0;\n            //æ›´æ–°ptsï¼Œ timebase\n            d->next_pts = d->start_pts;\n            d->next_pts_tb = d->start_pts_tb;\n        }\n    }\n    //åˆ¤æ–­åºåˆ—å·æ˜¯å¦æ»¡è¶³\n    if (d->queue->serial == d->pkt_serial)\n        break;\n    //è¿‡æ»¤æ‰åºåˆ—å·ä¸æ»¡è¶³æ¡ä»¶çš„pkt\n    av_packet_unref(d->pkt);\n} while (1);\n```\n\nåˆæ˜¯ä¸€ä¸ªdo.while å¾ªç¯ã€‚\n\n1. å¦‚æœpkt-queueä¸ºç©ºï¼Œè°ƒç”¨SDL_CondSignalï¼Œé€šçŸ¥read_threadå»è·å–æ›´å¤šçš„pkt\n\n2. å¦‚æœd->packet_pendingä¸ºtrue,  å°†d->packet_pendingæ ‡è®°ä¸ºfalseã€‚åœ¨ä¸‹ä¸€é˜¶æ®µï¼Œå°†pktå‘é€ç»™è§£ç å™¨æ—¶ï¼Œå¦‚æœè§£ç å™¨çš„pkté˜Ÿåˆ—å·²æ»¡ï¼Œæ— æ³•æ¥å—d- >pktã€‚ é€šè¿‡å°†d->packet_pendingè®¾ç½®ä¸º1ï¼Œ æ ‡è®°d- >pkt ä¸ºå¾…å¤„ç†ï¼Œä¸‹æ¬¡é‡æ–°å°†d->pktå‘é€ç»™è§£ç å™¨ã€‚\n\n3. æ²¡æœ‰å¾…å¤„ç†pktï¼Œè°ƒç”¨packet_queue_getä»d->queueä¸­è·å–ä¸€ä¸ªpktã€‚å…¶ä¸­ packet_queue_get çš„ç¬¬ä¸‰ä¸ªå‚æ•°block è¢«è®¾ç½®ä¸º1ï¼Œ åœ¨è·å–ptkçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ptk queue ä¸ºç©ºï¼Œå†…éƒ¨è°ƒç”¨SDL_CondWaitå°†çº¿ç¨‹ç½®äºç­‰å¾…çŠ¶æ€ã€‚\n\n4. å¦‚æœä»é˜Ÿåˆ—é‡Œè·å¾—äº†pktï¼Œpktçš„åºåˆ—å·å’ŒDecoderä¹‹å‰ä¿å­˜çš„pktçš„åºåˆ—å·ä¸ä¸€è‡´ã€‚ä¾‹å¦‚å‘ç”Ÿäº†seekï¼Œä¸­é—´æ•°æ®ä¸è¿ç»­äº†ï¼Œæ­¤æ—¶è°ƒç”¨avcodec_flush_bufferså†²æ´—è§£ç å™¨å†…éƒ¨bufferï¼Œè®©è§£ç å™¨å‡†å¤‡å¥½ä»seekä½ç½®å¼€å§‹è§£ç ã€‚\n\n5. å¾ªç¯å°†pktåºåˆ—å·ä¸ä¸€è‡´çš„pktè°ƒç”¨av_packet_unref(d->pkt);ä¸¢å¼ƒï¼Œç›´åˆ°`d->queue->serial == d->pkt_serial`,æ­¤æ—¶è·å–äº†ä¸€ä¸ªpktã€‚\n\nå‰é¢è§£ç å™¨è¦æ›´å¤šçš„ptkæ‰å¯ä»¥è¾“å‡ºframe, ç„¶åç¬¬äºŒé˜¶æ®µæˆ‘ä»¬ä»pkt queueä¸­ä¹Ÿè·å–åˆ°äº†ä¸€ä¸ªpktï¼Œä¸‹ä¸€æ­¥å°†è·å–çš„pktå‘é€ç»™è§£ç å™¨äº†\n\n```c\nif (d->avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {\n    int got_frame = 0;\n    //Return a negative value on error, otherwise return the number of bytes used\n    ret = avcodec_decode_subtitle2(d->avctx, sub, &got_frame, d->pkt);\n    if (ret < 0) {\n        //è§£ç å‘ç”Ÿäº†é”™è¯¯ï¼Œä¸ºäº†å’Œavcodec_send_packetçš„é”™è¯¯ç ä¸€èµ·å¤„ç†ï¼Œè½¬æ¢ä¸ºAVERROR(EAGAIN)ï¼Œå°è¯•ç»§ç»­å‘é€pkt\n        ret = AVERROR(EAGAIN);\n    } else {\n        if (got_frame && !d->pkt->data) {\n            //d->pkt->data = NULL ä»£è¡¨ç»™è§£ç å™¨å‘é€flushæ¶ˆæ¯ï¼Œ\n            //éœ€è¦æŒç»­ç»™è§£ç å™¨flushæ¶ˆæ¯ï¼Œç›´åˆ°æ— æ³•ç»§ç»­è¯»å–åˆ°æ–°çš„frame, \n            //å› æ­¤å°†packet_pendingè®¾ç½®ä¸º1,æ ‡è®°å½“å‰pktä¸ºå¾…å¤„ç†ï¼Œç›´åˆ°flushå®Œæˆ\n            d->packet_pending = 1;\n        }\n        ret = got_frame ? 0 : (d->pkt->data ? AVERROR(EAGAIN) : AVERROR_EOF);\n    }\n    av_packet_unref(d->pkt);\n} else {\n    //ç»™éŸ³è§†é¢‘è§£ç å™¨å‘é€pkt\n    if (avcodec_send_packet(d->avctx, d->pkt) == AVERROR(EAGAIN)) {\n        //æŠ¥é”™AVERROR(EAGAIN)ï¼Œè§£ç å™¨æ­¤æ—¶ä¸èƒ½æ¥å—æ›´å¤šäº†pkt\n        //éœ€è¦è°ƒç”¨avcodec_receive_frameå°†è§£ç å™¨ä¸­çš„frameè¯»å‡ºæ‰å¯ä»¥ç»§ç»­send pkt\n        av_log(d->avctx, AV_LOG_ERROR, \"Receive_frame and send_packet both returned EAGAIN, which is an API violation.\\n\");\n        //æ¯”è¾ƒå½“å‰pktæœªè¢«æˆåŠŸæ¶ˆè´¹ï¼Œåç»­éœ€è¦é‡æ–°å¤„ç†\n        d->packet_pending = 1;\n    } else {\n        //send pkt æˆåŠŸï¼Œå¼•ç”¨è®¡æ•°-1\n        av_packet_unref(d->pkt);\n    }\n}\n```\n\nè¿™é‡Œå­—å¹•è§£ç å™¨å‘é€pkt è°ƒç”¨çš„æ˜¯ avcodec_decode_subtitle2 \n\nç»™éŸ³è§†é¢‘è§£ç å™¨å‘é€pkt è°ƒç”¨çš„æ˜¯ avcodec_send_packetã€‚\n\næ³¨æ„å‘é€pktè¿”å›AVERROR(EAGAIN)ï¼Œ æ­¤æ—¶è§£ç å™¨æ— æ³•æ¥å—å½“å‰pktï¼ˆå¯èƒ½æ˜¯å†…éƒ¨çš„pktçš„é˜Ÿåˆ—æ»¡äº†ï¼‰ã€‚é€šè¿‡`d->packet_pending = 1`å°†pktæ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œä¸‹æ¬¡å¾ªç¯ï¼Œé‡æ–°å°è¯•å‘é€ç»™è§£ç å™¨è§£ç ã€‚\n\n\n\nå¦‚æœè§£ç å™¨æˆåŠŸæ¶ˆè´¹äº†pktï¼Œç»§ç»­è¿›å…¥å¾ªç¯ã€‚å›åˆ°è¯»frameçš„é˜¶æ®µï¼Œè¯»åˆ°äº†frameï¼Œå°±è¿”å›ç»™ä¸Šå±‚å»åŠ å…¥é˜Ÿåˆ—ã€‚\n\n\n\n\n\n## æ€»ç»“\n\n video_threadçš„å·¥ä½œæ˜¯å¾ªç¯ä»pkt queue å–å‡ºpktï¼Œé€ç»™è§£ç å™¨è§£ç ï¼Œå°†è§£ç åçš„frame æ”¾å…¥frame queueã€‚\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16479425075661647942506708.png)\n\n\n\n\n","slug":"ffmpeg/2022-03-22-ffplay video_thread åˆ†æ","published":1,"updated":"2024-03-06T11:53:13.566Z","comments":1,"photos":[],"_id":"clti3glkr002b57wh4jfjdt2f","content":"<p>å»é™¤æ»¤é•œç›¸å…³ï¼Œç®€åŒ–ä¸º</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static int video_thread(void *arg)<br>&#123;<br>    <span class=\"hljs-keyword\">for</span> (;;) &#123;<br>        <span class=\"hljs-comment\">//è·å–è§£ç åçš„frame</span><br>        ret = get_video_frame(<span class=\"hljs-keyword\">is</span>, frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) <span class=\"hljs-comment\">//æ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼Œç»“æŸå¾ªç¯</span><br>            goto the_end;<br>        <span class=\"hljs-keyword\">if</span> (!ret)<br>            continue;<br>        <span class=\"hljs-comment\">//æ ¹æ®å¸§ç‡ï¼Œè®¡ç®—frameçš„æ’­æ”¾æŒç»­æ—¶é—´</span><br>        duration = (frame_rate.num &amp;&amp; frame_rate.den ? av_q2d((AVRational)&#123;frame_rate.den, frame_rate.num&#125;) : <span class=\"hljs-number\">0</span>);<br>        <span class=\"hljs-comment\">//æ ¹æ®è§†é¢‘æµæ—¶é—´åŸºè®¡ç®—pts</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">pts</span> = (frame-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">pts</span> == AV_NOPTS_VALUE) ? NAN : frame-&gt;</span>pts * av_q2d(tb);<br>        <span class=\"hljs-comment\">//æ”¾å…¥frameé˜Ÿåˆ—</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">ret</span> = queue_picture(<span class=\"hljs-keyword\">is</span>, frame, pts, duration, frame-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">pkt_pos</span>, <span class=\"hljs-keyword\">is</span>-&gt;</span>viddec.pkt_serial);<br>        <span class=\"hljs-comment\">//å–æ¶ˆå¼•ç”¨frame</span><br>        av_frame_unref(frame);<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ•´ä½“å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œè°ƒç”¨get_video_frame è·å–è§£ç åframeï¼Œ è°ƒç”¨queue_picture å°†frameæ”¾å…¥è§£ç åçš„é˜Ÿåˆ—ã€‚</p>\n<h2 id=\"get-video-frame\"><a href=\"#get-video-frame\" class=\"headerlink\" title=\"get_video_frame\"></a>get_video_frame</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">get_video_frame</span><span class=\"hljs-params\">(VideoState *is, AVFrame *frame)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> got_picture;<br>    <span class=\"hljs-comment\">//è§£ç ï¼Œå°†è§£ç åçš„æ•°æ®æ”¾å…¥frameä¸­</span><br>    <span class=\"hljs-keyword\">if</span> ((got_picture = decoder_decode_frame(&amp;is-&gt;viddec, frame, <span class=\"hljs-literal\">NULL</span>)) &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<span class=\"hljs-comment\">//å¤„ç†abort</span><br><br>    <span class=\"hljs-keyword\">if</span> (got_picture) &#123;<br>        <span class=\"hljs-type\">double</span> dpts = NAN;<br><br>        <span class=\"hljs-keyword\">if</span> (frame-&gt;pts != AV_NOPTS_VALUE)<br>            dpts = av_q2d(is-&gt;video_st-&gt;time_base) * frame-&gt;pts;<br><br>        frame-&gt;sample_aspect_ratio = av_guess_sample_aspect_ratio(is-&gt;ic, is-&gt;video_st, frame);<br>        <span class=\"hljs-comment\">//å¤„ç†ä¸¢å¸§</span><br>        <span class=\"hljs-keyword\">if</span> (framedrop&gt;<span class=\"hljs-number\">0</span> || (framedrop &amp;&amp; get_master_sync_type(is) != AV_SYNC_VIDEO_MASTER)) &#123;<br>            <span class=\"hljs-keyword\">if</span> (frame-&gt;pts != AV_NOPTS_VALUE) &#123;<br>                <span class=\"hljs-type\">double</span> diff = dpts - get_master_clock(is);<br>                <span class=\"hljs-keyword\">if</span> (!isnan(diff) &amp;&amp; <span class=\"hljs-built_in\">fabs</span>(diff) &lt; AV_NOSYNC_THRESHOLD &amp;&amp;<br>                    diff - is-&gt;frame_last_filter_delay &lt; <span class=\"hljs-number\">0</span> &amp;&amp;<br>                    is-&gt;viddec.pkt_serial == is-&gt;vidclk.serial &amp;&amp;<br>                    is-&gt;videoq.nb_packets) &#123;<br>                    is-&gt;frame_drops_early++;<br>                    av_frame_unref(frame);<br>                    got_picture = <span class=\"hljs-number\">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> got_picture;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>get_video_frame è°ƒç”¨decoder_decode_frame è·å–è§£ç åçš„ä¸€å¸§æ•°æ®ã€‚</p>\n<p>è·å–frameåï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†ä¸¢å¸§ï¼Œåšä¸¢å¸§å¤„ç†ã€‚</p>\n<p>è¿”å›å€¼: æˆåŠŸè·å–frame(&gt;0)ï¼Œ è¢«ä¸¢å¸§ï¼ˆ&#x3D;0ï¼‰ï¼Œæ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼ˆ-1ï¼‰</p>\n<h2 id=\"decoder-decode-frame\"><a href=\"#decoder-decode-frame\" class=\"headerlink\" title=\"decoder_decode_frame\"></a>decoder_decode_frame</h2><p>éœ€è¦å…ˆå…³æ³¨ä¸€ä¸ªç»“æ„ä½“Decoder</p>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-keyword\">struct</span> Decoder &#123;<br>    <span class=\"hljs-comment\">//è§£ç å‰æ•°æ®</span><br>    <span class=\"hljs-built_in\">AVPacket</span> *pkt;<br>    <span class=\"hljs-comment\">//pkté˜Ÿåˆ—</span><br>    PacketQueue *queue;<br>    <span class=\"hljs-comment\">//è§£ç å™¨ä¸Šä¸‹æ–‡</span><br>    <span class=\"hljs-built_in\">AVCodecContext</span> *avctx;<br>    <span class=\"hljs-type\">int</span> pkt_serial;<br>    <span class=\"hljs-type\">int</span> finished;<br>    <span class=\"hljs-type\">int</span> packet_pending; <span class=\"hljs-comment\">//æ ‡è®°å½“å‰pktæœªè¢«æˆåŠŸæ¶ˆè´¹ï¼Œåç»­éœ€è¦é‡æ–°å¤„ç†</span><br>    SDL_cond *empty_queue_cond; <span class=\"hljs-comment\">//ç»‘å®šread_threadçº¿ç¨‹çš„continue_read_thread</span><br>    int64_t start_pts;<br>    <span class=\"hljs-built_in\">AVRational</span> start_pts_tb;<br>    int64_t next_pts;<br>    <span class=\"hljs-built_in\">AVRational</span> next_pts_tb;<br>    SDL_Thread *decoder_tid;<br>&#125; Decoder;<br></code></pre></td></tr></table></figure>\n\n<p>åœ¨VideoState ç»“æ„ä½“ä¸­,ä¿å­˜äº†éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•è§£ç ç›¸å…³çš„Decoderå®ä¾‹ã€‚</p>\n<figure class=\"highlight abnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs abnf\">Decoder auddec<span class=\"hljs-comment\">;</span><br>Decoder viddec<span class=\"hljs-comment\">;</span><br>Decoder subdec<span class=\"hljs-comment\">;</span><br></code></pre></td></tr></table></figure>\n\n<p>decoder_decode_frame æ ¹æ® Decoderï¼Œ å®ç°éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•è§£ç çš„ä¸»è¦é€»è¾‘ã€‚</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs perl\">static <span class=\"hljs-keyword\">int</span> decoder_decode_frame(Decoder *d, AVFrame *frame, AVSubtitle *<span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span>) </span>&#123;<br>    <span class=\"hljs-keyword\">int</span> ret = AVERROR(EAGAIN);<br>    <span class=\"hljs-keyword\">for</span> (;;) &#123;<br>Â Â Â Â  Â Â <span class=\"hljs-regexp\">//</span>.....<br>Â Â Â Â &#125;Â Â Â Â <br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ•´ä½“åˆæ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œ æˆ‘ä»¬æŠŠå®ƒæ‹†å¼€çœ‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (d-&gt;<span class=\"hljs-built_in\">queue</span>-&gt;serial == d-&gt;pkt_serial) &#123;<br>    <span class=\"hljs-comment\">//åˆ¤æ–­packetqueueçš„åºåˆ—å·ç­‰äºDecoderçš„åºåˆ—å·</span><br>    <span class=\"hljs-comment\">//packetqueueçš„åºåˆ—å·ï¼Œåœ¨å‘ç”Ÿseekæ“ä½œåï¼Œä¼š+1</span><br>    <span class=\"hljs-keyword\">do</span> &#123;<br>        <span class=\"hljs-keyword\">if</span> (d-&gt;<span class=\"hljs-built_in\">queue</span>-&gt;abort_request)<br>            <span class=\"hljs-comment\">//å¦‚æœæ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼Œè¿”å›-1</span><br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br><br>        <span class=\"hljs-keyword\">switch</span> (d-&gt;avctx-&gt;codec_type) &#123;<br>            <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_VIDEO:<br>                <span class=\"hljs-comment\">//ä»è§£ç å™¨è¯»frame</span><br>                ret = avcodec_receive_frame(d-&gt;avctx, frame);<br>                <span class=\"hljs-keyword\">if</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>                    <span class=\"hljs-comment\">//è¯»åˆ°äº†frame, è®¾ç½®frameçš„pts</span><br>                    <span class=\"hljs-comment\">//decoder_reorder_pts: let decoder reorder pts 0=off 1=on -1=auto</span><br>                    <span class=\"hljs-keyword\">if</span> (decoder_reorder_pts == <span class=\"hljs-number\">-1</span>) &#123;<br>                        frame-&gt;pts = frame-&gt;best_effort_timestamp;<br>                    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!decoder_reorder_pts) &#123;<br>                        frame-&gt;pts = frame-&gt;pkt_dts;<br>                    &#125;<br>                &#125;<br>                <span class=\"hljs-keyword\">break</span>;<br>            <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_AUDIO:<br>                <span class=\"hljs-comment\">//ä»è§£ç å™¨è¯»frame</span><br>                ret = avcodec_receive_frame(d-&gt;avctx, frame);<br>                <span class=\"hljs-keyword\">if</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>                    <span class=\"hljs-comment\">//è¯»åˆ°äº†frameï¼Œè®¾ç½®frameçš„pts</span><br>                    AVRational tb = (AVRational)&#123;<span class=\"hljs-number\">1</span>, frame-&gt;sample_rate&#125;;<br>                    <span class=\"hljs-keyword\">if</span> (frame-&gt;pts != AV_NOPTS_VALUE)<br>                        <span class=\"hljs-comment\">//ptsè½¬æ¢ï¼Œä»ç¼–ç å™¨çš„æ—¶é—´åŸºï¼Œè½¬æ¢ä¸ºtbä½œä¸ºæ—¶é—´åŸº</span><br>                        frame-&gt;pts = av_rescale_q(frame-&gt;pts, d-&gt;avctx-&gt;pkt_timebase, tb);<br>                    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (d-&gt;next_pts != AV_NOPTS_VALUE)<br>                        <span class=\"hljs-comment\">//frameçš„ptsæ²¡æœ‰å€¼ï¼Œå‚è€ƒd-&gt;next_ptsï¼Œå¹¶åšæ—¶é—´åŸºçš„è½¬åŒ–</span><br>                        frame-&gt;pts = av_rescale_q(d-&gt;next_pts, d-&gt;next_pts_tb, tb);<br>                    <span class=\"hljs-keyword\">if</span> (frame-&gt;pts != AV_NOPTS_VALUE) &#123;<br>                        <span class=\"hljs-comment\">//è®¡ç®—next_ptsï¼Œä¼šè¢«æ²¡æœ‰ptsçš„Frameå‚è€ƒ</span><br>                        <span class=\"hljs-comment\">//ä¿å­˜next_pts_tb</span><br>                        d-&gt;next_pts = frame-&gt;pts + frame-&gt;nb_samples;<br>                        d-&gt;next_pts_tb = tb;<br>                    &#125;<br>                &#125;<br>                <span class=\"hljs-keyword\">break</span>;<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ret == AVERROR_EOF) &#123;<br>            <span class=\"hljs-comment\">//è§£ç å™¨ç»“æŸï¼Œæ‰€æœ‰çš„å¸§å·²ç»è¢«è¯»å‡º</span><br>            d-&gt;finished = d-&gt;pkt_serial;<br>            <span class=\"hljs-comment\">//é‡ç½®è§£ç å™¨å†…éƒ¨çŠ¶æ€</span><br>            avcodec_flush_buffers(d-&gt;avctx);<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ret &gt;= <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>    &#125; <span class=\"hljs-keyword\">while</span> (ret != AVERROR(EAGAIN)); <span class=\"hljs-comment\">//éœ€è¦é€å…¥æ›´å¤šçš„pkts</span><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ä¸€ä¸ªifæ¡ä»¶ï¼Œå†…åµŒä¸€ä¸ªdo.whileå¾ªç¯ã€‚</p>\n<p>é¦–å…ˆ if åˆ¤æ–­<code>d-&gt;queue-&gt;serial == d-&gt;pkt_serial</code>ï¼Œä¿è¯å½“å‰è¦å¤„ç†çš„pktä¸pkt-&gt;queueçš„åºåˆ—å·ä¸€è‡´ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œè¯æ˜æ˜¯è¯¥pktå’Œpkt-&gt;queueä¸­å…ƒç´ ï¼Œæ˜¯ä¸¤æ®µä¸è¿ç»­çš„æ•°æ®ï¼Œè¿›å…¥åç»­æµç¨‹ï¼Œåšä¸¢å¸§å¤„ç†ã€‚</p>\n<p>å¦‚æœåºåˆ—å·ä¸€è‡´ï¼Œè¿›å…¥å¾ªç¯ï¼Œå°è¯•ä»è§£ç å™¨è·å–frameã€‚</p>\n<p>æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªå¾ªç¯</p>\n<ol>\n<li><p>åˆ¤æ–­æ˜¯å¦æ”¶åˆ°é€€å‡ºè¯·æ±‚</p>\n</li>\n<li><p>switchåˆ¤æ–­è§£ç å™¨çš„ç±»å‹ï¼Œå¤„ç†audio å’Œ video çš„æƒ…å†µã€‚ è°ƒç”¨avcodec_receive_frame å°è¯•ä»è§£ç å™¨è·å–frameã€‚ è¿”å›å€¼&gt;&#x3D;0 ä»£è¡¨è·å–æˆåŠŸï¼Œè½¬æ¢frameçš„pts</p>\n</li>\n<li><p>å¤„ç†avcodec_receive_frameçš„è¿”å›å€¼ã€‚</p>\n<ul>\n<li><p>ret &#x3D; AVERROR_EOF è§£ç å™¨æ‰€æœ‰çš„å¸§å·²è¢«è¯»å‡ºï¼Œè§£ç ç»“æŸï¼Œè¿”å›0.</p>\n</li>\n<li><p>ret &gt;&#x3D; 0,  æˆåŠŸè·å–äº†frameï¼Œ ç›´æ¥è¿”å› 1</p>\n</li>\n<li><p>ret &#x3D; AVERROR(EAGAIN)ï¼Œ è§£ç å™¨éœ€è¦æ¥å—æ›´å¤špktæ‰å¯ä»¥è¾“å‡ºframeï¼Œè·³å‡ºdo.whileå¾ªç¯ã€‚</p>\n</li>\n</ul>\n</li>\n</ol>\n<p>ä¸Šä¸€é˜¶æ®µå°è¯•ä»è§£ç å™¨ä¸­è¯»å–frameï¼Œ ä½†æ˜¯è§£ç å™¨æŠ¥å‘ŠAVERROR(EAGAIN)ï¼Œéœ€è¦æ›´å¤šçš„pkt æ‰èƒ½äº§å‡ºframeã€‚ é‚£ä¹ˆä¸‹ä¸€é˜¶æ®µå¤„ç†è·å–pktï¼Œç»™è§£ç å‘é€pktã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">do</span> &#123;<br>    <span class=\"hljs-keyword\">if</span> (d-&gt;<span class=\"hljs-built_in\">queue</span>-&gt;nb_packets == <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-comment\">//pkté˜Ÿåˆ—ä¸ºç©ºï¼Œé€šçŸ¥read_threadå»è·å–æ›´å¤šæ•°æ®</span><br>        SDL_CondSignal(d-&gt;empty_queue_cond);<br>    <span class=\"hljs-keyword\">if</span> (d-&gt;packet_pending) &#123;<br>        d-&gt;packet_pending = <span class=\"hljs-number\">0</span>;<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-type\">int</span> old_serial = d-&gt;pkt_serial;<br>        <span class=\"hljs-keyword\">if</span> (packet_queue_get(d-&gt;<span class=\"hljs-built_in\">queue</span>, d-&gt;pkt, <span class=\"hljs-number\">1</span>, &amp;d-&gt;pkt_serial) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>        <span class=\"hljs-comment\">//å¦‚æœæ–°çš„pktçš„åºåˆ—å·ï¼Œå’Œä¹‹å‰çš„ä¸ä¸€è‡´ã€‚å¯èƒ½æ˜¯å‘ç”Ÿäº†seekæ“ä½œï¼Œä¸¤æ®µæ•°æ®ä¸è¿ç»­äº†</span><br>        <span class=\"hljs-comment\">//å†²æ´—è§£ç å™¨</span><br>        <span class=\"hljs-keyword\">if</span> (old_serial != d-&gt;pkt_serial) &#123;<br>            <span class=\"hljs-comment\">//å†²æ´—è§£ç å™¨å†…éƒ¨çš„buffer</span><br>            avcodec_flush_buffers(d-&gt;avctx);<br>            d-&gt;finished = <span class=\"hljs-number\">0</span>;<br>            <span class=\"hljs-comment\">//æ›´æ–°ptsï¼Œ timebase</span><br>            d-&gt;next_pts = d-&gt;start_pts;<br>            d-&gt;next_pts_tb = d-&gt;start_pts_tb;<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-comment\">//åˆ¤æ–­åºåˆ—å·æ˜¯å¦æ»¡è¶³</span><br>    <span class=\"hljs-keyword\">if</span> (d-&gt;<span class=\"hljs-built_in\">queue</span>-&gt;serial == d-&gt;pkt_serial)<br>        <span class=\"hljs-keyword\">break</span>;<br>    <span class=\"hljs-comment\">//è¿‡æ»¤æ‰åºåˆ—å·ä¸æ»¡è¶³æ¡ä»¶çš„pkt</span><br>    av_packet_unref(d-&gt;pkt);<br>&#125; <span class=\"hljs-keyword\">while</span> (<span class=\"hljs-number\">1</span>);<br></code></pre></td></tr></table></figure>\n\n<p>åˆæ˜¯ä¸€ä¸ªdo.while å¾ªç¯ã€‚</p>\n<ol>\n<li><p>å¦‚æœpkt-queueä¸ºç©ºï¼Œè°ƒç”¨SDL_CondSignalï¼Œé€šçŸ¥read_threadå»è·å–æ›´å¤šçš„pkt</p>\n</li>\n<li><p>å¦‚æœd-&gt;packet_pendingä¸ºtrue,  å°†d-&gt;packet_pendingæ ‡è®°ä¸ºfalseã€‚åœ¨ä¸‹ä¸€é˜¶æ®µï¼Œå°†pktå‘é€ç»™è§£ç å™¨æ—¶ï¼Œå¦‚æœè§£ç å™¨çš„pkté˜Ÿåˆ—å·²æ»¡ï¼Œæ— æ³•æ¥å—d- &gt;pktã€‚ é€šè¿‡å°†d-&gt;packet_pendingè®¾ç½®ä¸º1ï¼Œ æ ‡è®°d- &gt;pkt ä¸ºå¾…å¤„ç†ï¼Œä¸‹æ¬¡é‡æ–°å°†d-&gt;pktå‘é€ç»™è§£ç å™¨ã€‚</p>\n</li>\n<li><p>æ²¡æœ‰å¾…å¤„ç†pktï¼Œè°ƒç”¨packet_queue_getä»d-&gt;queueä¸­è·å–ä¸€ä¸ªpktã€‚å…¶ä¸­ packet_queue_get çš„ç¬¬ä¸‰ä¸ªå‚æ•°block è¢«è®¾ç½®ä¸º1ï¼Œ åœ¨è·å–ptkçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ptk queue ä¸ºç©ºï¼Œå†…éƒ¨è°ƒç”¨SDL_CondWaitå°†çº¿ç¨‹ç½®äºç­‰å¾…çŠ¶æ€ã€‚</p>\n</li>\n<li><p>å¦‚æœä»é˜Ÿåˆ—é‡Œè·å¾—äº†pktï¼Œpktçš„åºåˆ—å·å’ŒDecoderä¹‹å‰ä¿å­˜çš„pktçš„åºåˆ—å·ä¸ä¸€è‡´ã€‚ä¾‹å¦‚å‘ç”Ÿäº†seekï¼Œä¸­é—´æ•°æ®ä¸è¿ç»­äº†ï¼Œæ­¤æ—¶è°ƒç”¨avcodec_flush_bufferså†²æ´—è§£ç å™¨å†…éƒ¨bufferï¼Œè®©è§£ç å™¨å‡†å¤‡å¥½ä»seekä½ç½®å¼€å§‹è§£ç ã€‚</p>\n</li>\n<li><p>å¾ªç¯å°†pktåºåˆ—å·ä¸ä¸€è‡´çš„pktè°ƒç”¨av_packet_unref(d-&gt;pkt);ä¸¢å¼ƒï¼Œç›´åˆ°<code>d-&gt;queue-&gt;serial == d-&gt;pkt_serial</code>,æ­¤æ—¶è·å–äº†ä¸€ä¸ªpktã€‚</p>\n</li>\n</ol>\n<p>å‰é¢è§£ç å™¨è¦æ›´å¤šçš„ptkæ‰å¯ä»¥è¾“å‡ºframe, ç„¶åç¬¬äºŒé˜¶æ®µæˆ‘ä»¬ä»pkt queueä¸­ä¹Ÿè·å–åˆ°äº†ä¸€ä¸ªpktï¼Œä¸‹ä¸€æ­¥å°†è·å–çš„pktå‘é€ç»™è§£ç å™¨äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (d-&gt;avctx-&gt;codec_type == AVMEDIA_TYPE_SUBTITLE) &#123;<br>    <span class=\"hljs-type\">int</span> got_frame = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//Return a negative value on error, otherwise return the number of bytes used</span><br>    ret = avcodec_decode_subtitle2(d-&gt;avctx, sub, &amp;got_frame, d-&gt;pkt);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//è§£ç å‘ç”Ÿäº†é”™è¯¯ï¼Œä¸ºäº†å’Œavcodec_send_packetçš„é”™è¯¯ç ä¸€èµ·å¤„ç†ï¼Œè½¬æ¢ä¸ºAVERROR(EAGAIN)ï¼Œå°è¯•ç»§ç»­å‘é€pkt</span><br>        ret = AVERROR(EAGAIN);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-keyword\">if</span> (got_frame &amp;&amp; !d-&gt;pkt-&gt;data) &#123;<br>            <span class=\"hljs-comment\">//d-&gt;pkt-&gt;data = NULL ä»£è¡¨ç»™è§£ç å™¨å‘é€flushæ¶ˆæ¯ï¼Œ</span><br>            <span class=\"hljs-comment\">//éœ€è¦æŒç»­ç»™è§£ç å™¨flushæ¶ˆæ¯ï¼Œç›´åˆ°æ— æ³•ç»§ç»­è¯»å–åˆ°æ–°çš„frame, </span><br>            <span class=\"hljs-comment\">//å› æ­¤å°†packet_pendingè®¾ç½®ä¸º1,æ ‡è®°å½“å‰pktä¸ºå¾…å¤„ç†ï¼Œç›´åˆ°flushå®Œæˆ</span><br>            d-&gt;packet_pending = <span class=\"hljs-number\">1</span>;<br>        &#125;<br>        ret = got_frame ? <span class=\"hljs-number\">0</span> : (d-&gt;pkt-&gt;data ? AVERROR(EAGAIN) : AVERROR_EOF);<br>    &#125;<br>    av_packet_unref(d-&gt;pkt);<br>&#125; <span class=\"hljs-keyword\">else</span> &#123;<br>    <span class=\"hljs-comment\">//ç»™éŸ³è§†é¢‘è§£ç å™¨å‘é€pkt</span><br>    <span class=\"hljs-keyword\">if</span> (avcodec_send_packet(d-&gt;avctx, d-&gt;pkt) == AVERROR(EAGAIN)) &#123;<br>        <span class=\"hljs-comment\">//æŠ¥é”™AVERROR(EAGAIN)ï¼Œè§£ç å™¨æ­¤æ—¶ä¸èƒ½æ¥å—æ›´å¤šäº†pkt</span><br>        <span class=\"hljs-comment\">//éœ€è¦è°ƒç”¨avcodec_receive_frameå°†è§£ç å™¨ä¸­çš„frameè¯»å‡ºæ‰å¯ä»¥ç»§ç»­send pkt</span><br>        av_log(d-&gt;avctx, AV_LOG_ERROR, <span class=\"hljs-string\">&quot;Receive_frame and send_packet both returned EAGAIN, which is an API violation.\\n&quot;</span>);<br>        <span class=\"hljs-comment\">//æ¯”è¾ƒå½“å‰pktæœªè¢«æˆåŠŸæ¶ˆè´¹ï¼Œåç»­éœ€è¦é‡æ–°å¤„ç†</span><br>        d-&gt;packet_pending = <span class=\"hljs-number\">1</span>;<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-comment\">//send pkt æˆåŠŸï¼Œå¼•ç”¨è®¡æ•°-1</span><br>        av_packet_unref(d-&gt;pkt);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>è¿™é‡Œå­—å¹•è§£ç å™¨å‘é€pkt è°ƒç”¨çš„æ˜¯ avcodec_decode_subtitle2 </p>\n<p>ç»™éŸ³è§†é¢‘è§£ç å™¨å‘é€pkt è°ƒç”¨çš„æ˜¯ avcodec_send_packetã€‚</p>\n<p>æ³¨æ„å‘é€pktè¿”å›AVERROR(EAGAIN)ï¼Œ æ­¤æ—¶è§£ç å™¨æ— æ³•æ¥å—å½“å‰pktï¼ˆå¯èƒ½æ˜¯å†…éƒ¨çš„pktçš„é˜Ÿåˆ—æ»¡äº†ï¼‰ã€‚é€šè¿‡<code>d-&gt;packet_pending = 1</code>å°†pktæ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œä¸‹æ¬¡å¾ªç¯ï¼Œé‡æ–°å°è¯•å‘é€ç»™è§£ç å™¨è§£ç ã€‚</p>\n<p>å¦‚æœè§£ç å™¨æˆåŠŸæ¶ˆè´¹äº†pktï¼Œç»§ç»­è¿›å…¥å¾ªç¯ã€‚å›åˆ°è¯»frameçš„é˜¶æ®µï¼Œè¯»åˆ°äº†frameï¼Œå°±è¿”å›ç»™ä¸Šå±‚å»åŠ å…¥é˜Ÿåˆ—ã€‚</p>\n<h2 id=\"æ€»ç»“\"><a href=\"#æ€»ç»“\" class=\"headerlink\" title=\"æ€»ç»“\"></a>æ€»ç»“</h2><p> video_threadçš„å·¥ä½œæ˜¯å¾ªç¯ä»pkt queue å–å‡ºpktï¼Œé€ç»™è§£ç å™¨è§£ç ï¼Œå°†è§£ç åçš„frame æ”¾å…¥frame queueã€‚</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16479425075661647942506708.png\"></p>\n","excerpt":"","more":"<p>å»é™¤æ»¤é•œç›¸å…³ï¼Œç®€åŒ–ä¸º</p>\n<figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xl\">static int video_thread(void *arg)<br>&#123;<br>    <span class=\"hljs-keyword\">for</span> (;;) &#123;<br>        <span class=\"hljs-comment\">//è·å–è§£ç åçš„frame</span><br>        ret = get_video_frame(<span class=\"hljs-keyword\">is</span>, frame);<br>        <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) <span class=\"hljs-comment\">//æ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼Œç»“æŸå¾ªç¯</span><br>            goto the_end;<br>        <span class=\"hljs-keyword\">if</span> (!ret)<br>            continue;<br>        <span class=\"hljs-comment\">//æ ¹æ®å¸§ç‡ï¼Œè®¡ç®—frameçš„æ’­æ”¾æŒç»­æ—¶é—´</span><br>        duration = (frame_rate.num &amp;&amp; frame_rate.den ? av_q2d((AVRational)&#123;frame_rate.den, frame_rate.num&#125;) : <span class=\"hljs-number\">0</span>);<br>        <span class=\"hljs-comment\">//æ ¹æ®è§†é¢‘æµæ—¶é—´åŸºè®¡ç®—pts</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">pts</span> = (frame-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">pts</span> == AV_NOPTS_VALUE) ? NAN : frame-&gt;</span>pts * av_q2d(tb);<br>        <span class=\"hljs-comment\">//æ”¾å…¥frameé˜Ÿåˆ—</span><br>        <span class=\"hljs-function\"><span class=\"hljs-title\">ret</span> = queue_picture(<span class=\"hljs-keyword\">is</span>, frame, pts, duration, frame-&gt;</span><span class=\"hljs-function\"><span class=\"hljs-title\">pkt_pos</span>, <span class=\"hljs-keyword\">is</span>-&gt;</span>viddec.pkt_serial);<br>        <span class=\"hljs-comment\">//å–æ¶ˆå¼•ç”¨frame</span><br>        av_frame_unref(frame);<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ•´ä½“å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œè°ƒç”¨get_video_frame è·å–è§£ç åframeï¼Œ è°ƒç”¨queue_picture å°†frameæ”¾å…¥è§£ç åçš„é˜Ÿåˆ—ã€‚</p>\n<h2 id=\"get-video-frame\"><a href=\"#get-video-frame\" class=\"headerlink\" title=\"get_video_frame\"></a>get_video_frame</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-type\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">get_video_frame</span><span class=\"hljs-params\">(VideoState *is, AVFrame *frame)</span><br>&#123;<br>    <span class=\"hljs-type\">int</span> got_picture;<br>    <span class=\"hljs-comment\">//è§£ç ï¼Œå°†è§£ç åçš„æ•°æ®æ”¾å…¥frameä¸­</span><br>    <span class=\"hljs-keyword\">if</span> ((got_picture = decoder_decode_frame(&amp;is-&gt;viddec, frame, <span class=\"hljs-literal\">NULL</span>)) &lt; <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<span class=\"hljs-comment\">//å¤„ç†abort</span><br><br>    <span class=\"hljs-keyword\">if</span> (got_picture) &#123;<br>        <span class=\"hljs-type\">double</span> dpts = NAN;<br><br>        <span class=\"hljs-keyword\">if</span> (frame-&gt;pts != AV_NOPTS_VALUE)<br>            dpts = av_q2d(is-&gt;video_st-&gt;time_base) * frame-&gt;pts;<br><br>        frame-&gt;sample_aspect_ratio = av_guess_sample_aspect_ratio(is-&gt;ic, is-&gt;video_st, frame);<br>        <span class=\"hljs-comment\">//å¤„ç†ä¸¢å¸§</span><br>        <span class=\"hljs-keyword\">if</span> (framedrop&gt;<span class=\"hljs-number\">0</span> || (framedrop &amp;&amp; get_master_sync_type(is) != AV_SYNC_VIDEO_MASTER)) &#123;<br>            <span class=\"hljs-keyword\">if</span> (frame-&gt;pts != AV_NOPTS_VALUE) &#123;<br>                <span class=\"hljs-type\">double</span> diff = dpts - get_master_clock(is);<br>                <span class=\"hljs-keyword\">if</span> (!isnan(diff) &amp;&amp; <span class=\"hljs-built_in\">fabs</span>(diff) &lt; AV_NOSYNC_THRESHOLD &amp;&amp;<br>                    diff - is-&gt;frame_last_filter_delay &lt; <span class=\"hljs-number\">0</span> &amp;&amp;<br>                    is-&gt;viddec.pkt_serial == is-&gt;vidclk.serial &amp;&amp;<br>                    is-&gt;videoq.nb_packets) &#123;<br>                    is-&gt;frame_drops_early++;<br>                    av_frame_unref(frame);<br>                    got_picture = <span class=\"hljs-number\">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> got_picture;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>get_video_frame è°ƒç”¨decoder_decode_frame è·å–è§£ç åçš„ä¸€å¸§æ•°æ®ã€‚</p>\n<p>è·å–frameåï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†ä¸¢å¸§ï¼Œåšä¸¢å¸§å¤„ç†ã€‚</p>\n<p>è¿”å›å€¼: æˆåŠŸè·å–frame(&gt;0)ï¼Œ è¢«ä¸¢å¸§ï¼ˆ&#x3D;0ï¼‰ï¼Œæ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼ˆ-1ï¼‰</p>\n<h2 id=\"decoder-decode-frame\"><a href=\"#decoder-decode-frame\" class=\"headerlink\" title=\"decoder_decode_frame\"></a>decoder_decode_frame</h2><p>éœ€è¦å…ˆå…³æ³¨ä¸€ä¸ªç»“æ„ä½“Decoder</p>\n<figure class=\"highlight objectivec\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs objectivec\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-keyword\">struct</span> Decoder &#123;<br>    <span class=\"hljs-comment\">//è§£ç å‰æ•°æ®</span><br>    <span class=\"hljs-built_in\">AVPacket</span> *pkt;<br>    <span class=\"hljs-comment\">//pkté˜Ÿåˆ—</span><br>    PacketQueue *queue;<br>    <span class=\"hljs-comment\">//è§£ç å™¨ä¸Šä¸‹æ–‡</span><br>    <span class=\"hljs-built_in\">AVCodecContext</span> *avctx;<br>    <span class=\"hljs-type\">int</span> pkt_serial;<br>    <span class=\"hljs-type\">int</span> finished;<br>    <span class=\"hljs-type\">int</span> packet_pending; <span class=\"hljs-comment\">//æ ‡è®°å½“å‰pktæœªè¢«æˆåŠŸæ¶ˆè´¹ï¼Œåç»­éœ€è¦é‡æ–°å¤„ç†</span><br>    SDL_cond *empty_queue_cond; <span class=\"hljs-comment\">//ç»‘å®šread_threadçº¿ç¨‹çš„continue_read_thread</span><br>    int64_t start_pts;<br>    <span class=\"hljs-built_in\">AVRational</span> start_pts_tb;<br>    int64_t next_pts;<br>    <span class=\"hljs-built_in\">AVRational</span> next_pts_tb;<br>    SDL_Thread *decoder_tid;<br>&#125; Decoder;<br></code></pre></td></tr></table></figure>\n\n<p>åœ¨VideoState ç»“æ„ä½“ä¸­,ä¿å­˜äº†éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•è§£ç ç›¸å…³çš„Decoderå®ä¾‹ã€‚</p>\n<figure class=\"highlight abnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs abnf\">Decoder auddec<span class=\"hljs-comment\">;</span><br>Decoder viddec<span class=\"hljs-comment\">;</span><br>Decoder subdec<span class=\"hljs-comment\">;</span><br></code></pre></td></tr></table></figure>\n\n<p>decoder_decode_frame æ ¹æ® Decoderï¼Œ å®ç°éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œå­—å¹•è§£ç çš„ä¸»è¦é€»è¾‘ã€‚</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs perl\">static <span class=\"hljs-keyword\">int</span> decoder_decode_frame(Decoder *d, AVFrame *frame, AVSubtitle *<span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span>) </span>&#123;<br>    <span class=\"hljs-keyword\">int</span> ret = AVERROR(EAGAIN);<br>    <span class=\"hljs-keyword\">for</span> (;;) &#123;<br>Â Â Â Â  Â Â <span class=\"hljs-regexp\">//</span>.....<br>Â Â Â Â &#125;Â Â Â Â <br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>æ•´ä½“åˆæ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œ æˆ‘ä»¬æŠŠå®ƒæ‹†å¼€çœ‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (d-&gt;<span class=\"hljs-built_in\">queue</span>-&gt;serial == d-&gt;pkt_serial) &#123;<br>    <span class=\"hljs-comment\">//åˆ¤æ–­packetqueueçš„åºåˆ—å·ç­‰äºDecoderçš„åºåˆ—å·</span><br>    <span class=\"hljs-comment\">//packetqueueçš„åºåˆ—å·ï¼Œåœ¨å‘ç”Ÿseekæ“ä½œåï¼Œä¼š+1</span><br>    <span class=\"hljs-keyword\">do</span> &#123;<br>        <span class=\"hljs-keyword\">if</span> (d-&gt;<span class=\"hljs-built_in\">queue</span>-&gt;abort_request)<br>            <span class=\"hljs-comment\">//å¦‚æœæ”¶åˆ°äº†é€€å‡ºè¯·æ±‚ï¼Œè¿”å›-1</span><br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br><br>        <span class=\"hljs-keyword\">switch</span> (d-&gt;avctx-&gt;codec_type) &#123;<br>            <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_VIDEO:<br>                <span class=\"hljs-comment\">//ä»è§£ç å™¨è¯»frame</span><br>                ret = avcodec_receive_frame(d-&gt;avctx, frame);<br>                <span class=\"hljs-keyword\">if</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>                    <span class=\"hljs-comment\">//è¯»åˆ°äº†frame, è®¾ç½®frameçš„pts</span><br>                    <span class=\"hljs-comment\">//decoder_reorder_pts: let decoder reorder pts 0=off 1=on -1=auto</span><br>                    <span class=\"hljs-keyword\">if</span> (decoder_reorder_pts == <span class=\"hljs-number\">-1</span>) &#123;<br>                        frame-&gt;pts = frame-&gt;best_effort_timestamp;<br>                    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!decoder_reorder_pts) &#123;<br>                        frame-&gt;pts = frame-&gt;pkt_dts;<br>                    &#125;<br>                &#125;<br>                <span class=\"hljs-keyword\">break</span>;<br>            <span class=\"hljs-keyword\">case</span> AVMEDIA_TYPE_AUDIO:<br>                <span class=\"hljs-comment\">//ä»è§£ç å™¨è¯»frame</span><br>                ret = avcodec_receive_frame(d-&gt;avctx, frame);<br>                <span class=\"hljs-keyword\">if</span> (ret &gt;= <span class=\"hljs-number\">0</span>) &#123;<br>                    <span class=\"hljs-comment\">//è¯»åˆ°äº†frameï¼Œè®¾ç½®frameçš„pts</span><br>                    AVRational tb = (AVRational)&#123;<span class=\"hljs-number\">1</span>, frame-&gt;sample_rate&#125;;<br>                    <span class=\"hljs-keyword\">if</span> (frame-&gt;pts != AV_NOPTS_VALUE)<br>                        <span class=\"hljs-comment\">//ptsè½¬æ¢ï¼Œä»ç¼–ç å™¨çš„æ—¶é—´åŸºï¼Œè½¬æ¢ä¸ºtbä½œä¸ºæ—¶é—´åŸº</span><br>                        frame-&gt;pts = av_rescale_q(frame-&gt;pts, d-&gt;avctx-&gt;pkt_timebase, tb);<br>                    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (d-&gt;next_pts != AV_NOPTS_VALUE)<br>                        <span class=\"hljs-comment\">//frameçš„ptsæ²¡æœ‰å€¼ï¼Œå‚è€ƒd-&gt;next_ptsï¼Œå¹¶åšæ—¶é—´åŸºçš„è½¬åŒ–</span><br>                        frame-&gt;pts = av_rescale_q(d-&gt;next_pts, d-&gt;next_pts_tb, tb);<br>                    <span class=\"hljs-keyword\">if</span> (frame-&gt;pts != AV_NOPTS_VALUE) &#123;<br>                        <span class=\"hljs-comment\">//è®¡ç®—next_ptsï¼Œä¼šè¢«æ²¡æœ‰ptsçš„Frameå‚è€ƒ</span><br>                        <span class=\"hljs-comment\">//ä¿å­˜next_pts_tb</span><br>                        d-&gt;next_pts = frame-&gt;pts + frame-&gt;nb_samples;<br>                        d-&gt;next_pts_tb = tb;<br>                    &#125;<br>                &#125;<br>                <span class=\"hljs-keyword\">break</span>;<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ret == AVERROR_EOF) &#123;<br>            <span class=\"hljs-comment\">//è§£ç å™¨ç»“æŸï¼Œæ‰€æœ‰çš„å¸§å·²ç»è¢«è¯»å‡º</span><br>            d-&gt;finished = d-&gt;pkt_serial;<br>            <span class=\"hljs-comment\">//é‡ç½®è§£ç å™¨å†…éƒ¨çŠ¶æ€</span><br>            avcodec_flush_buffers(d-&gt;avctx);<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ret &gt;= <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;<br>    &#125; <span class=\"hljs-keyword\">while</span> (ret != AVERROR(EAGAIN)); <span class=\"hljs-comment\">//éœ€è¦é€å…¥æ›´å¤šçš„pkts</span><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>ä¸€ä¸ªifæ¡ä»¶ï¼Œå†…åµŒä¸€ä¸ªdo.whileå¾ªç¯ã€‚</p>\n<p>é¦–å…ˆ if åˆ¤æ–­<code>d-&gt;queue-&gt;serial == d-&gt;pkt_serial</code>ï¼Œä¿è¯å½“å‰è¦å¤„ç†çš„pktä¸pkt-&gt;queueçš„åºåˆ—å·ä¸€è‡´ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œè¯æ˜æ˜¯è¯¥pktå’Œpkt-&gt;queueä¸­å…ƒç´ ï¼Œæ˜¯ä¸¤æ®µä¸è¿ç»­çš„æ•°æ®ï¼Œè¿›å…¥åç»­æµç¨‹ï¼Œåšä¸¢å¸§å¤„ç†ã€‚</p>\n<p>å¦‚æœåºåˆ—å·ä¸€è‡´ï¼Œè¿›å…¥å¾ªç¯ï¼Œå°è¯•ä»è§£ç å™¨è·å–frameã€‚</p>\n<p>æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªå¾ªç¯</p>\n<ol>\n<li><p>åˆ¤æ–­æ˜¯å¦æ”¶åˆ°é€€å‡ºè¯·æ±‚</p>\n</li>\n<li><p>switchåˆ¤æ–­è§£ç å™¨çš„ç±»å‹ï¼Œå¤„ç†audio å’Œ video çš„æƒ…å†µã€‚ è°ƒç”¨avcodec_receive_frame å°è¯•ä»è§£ç å™¨è·å–frameã€‚ è¿”å›å€¼&gt;&#x3D;0 ä»£è¡¨è·å–æˆåŠŸï¼Œè½¬æ¢frameçš„pts</p>\n</li>\n<li><p>å¤„ç†avcodec_receive_frameçš„è¿”å›å€¼ã€‚</p>\n<ul>\n<li><p>ret &#x3D; AVERROR_EOF è§£ç å™¨æ‰€æœ‰çš„å¸§å·²è¢«è¯»å‡ºï¼Œè§£ç ç»“æŸï¼Œè¿”å›0.</p>\n</li>\n<li><p>ret &gt;&#x3D; 0,  æˆåŠŸè·å–äº†frameï¼Œ ç›´æ¥è¿”å› 1</p>\n</li>\n<li><p>ret &#x3D; AVERROR(EAGAIN)ï¼Œ è§£ç å™¨éœ€è¦æ¥å—æ›´å¤špktæ‰å¯ä»¥è¾“å‡ºframeï¼Œè·³å‡ºdo.whileå¾ªç¯ã€‚</p>\n</li>\n</ul>\n</li>\n</ol>\n<p>ä¸Šä¸€é˜¶æ®µå°è¯•ä»è§£ç å™¨ä¸­è¯»å–frameï¼Œ ä½†æ˜¯è§£ç å™¨æŠ¥å‘ŠAVERROR(EAGAIN)ï¼Œéœ€è¦æ›´å¤šçš„pkt æ‰èƒ½äº§å‡ºframeã€‚ é‚£ä¹ˆä¸‹ä¸€é˜¶æ®µå¤„ç†è·å–pktï¼Œç»™è§£ç å‘é€pktã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">do</span> &#123;<br>    <span class=\"hljs-keyword\">if</span> (d-&gt;<span class=\"hljs-built_in\">queue</span>-&gt;nb_packets == <span class=\"hljs-number\">0</span>)<br>        <span class=\"hljs-comment\">//pkté˜Ÿåˆ—ä¸ºç©ºï¼Œé€šçŸ¥read_threadå»è·å–æ›´å¤šæ•°æ®</span><br>        SDL_CondSignal(d-&gt;empty_queue_cond);<br>    <span class=\"hljs-keyword\">if</span> (d-&gt;packet_pending) &#123;<br>        d-&gt;packet_pending = <span class=\"hljs-number\">0</span>;<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-type\">int</span> old_serial = d-&gt;pkt_serial;<br>        <span class=\"hljs-keyword\">if</span> (packet_queue_get(d-&gt;<span class=\"hljs-built_in\">queue</span>, d-&gt;pkt, <span class=\"hljs-number\">1</span>, &amp;d-&gt;pkt_serial) &lt; <span class=\"hljs-number\">0</span>)<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;<br>        <span class=\"hljs-comment\">//å¦‚æœæ–°çš„pktçš„åºåˆ—å·ï¼Œå’Œä¹‹å‰çš„ä¸ä¸€è‡´ã€‚å¯èƒ½æ˜¯å‘ç”Ÿäº†seekæ“ä½œï¼Œä¸¤æ®µæ•°æ®ä¸è¿ç»­äº†</span><br>        <span class=\"hljs-comment\">//å†²æ´—è§£ç å™¨</span><br>        <span class=\"hljs-keyword\">if</span> (old_serial != d-&gt;pkt_serial) &#123;<br>            <span class=\"hljs-comment\">//å†²æ´—è§£ç å™¨å†…éƒ¨çš„buffer</span><br>            avcodec_flush_buffers(d-&gt;avctx);<br>            d-&gt;finished = <span class=\"hljs-number\">0</span>;<br>            <span class=\"hljs-comment\">//æ›´æ–°ptsï¼Œ timebase</span><br>            d-&gt;next_pts = d-&gt;start_pts;<br>            d-&gt;next_pts_tb = d-&gt;start_pts_tb;<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-comment\">//åˆ¤æ–­åºåˆ—å·æ˜¯å¦æ»¡è¶³</span><br>    <span class=\"hljs-keyword\">if</span> (d-&gt;<span class=\"hljs-built_in\">queue</span>-&gt;serial == d-&gt;pkt_serial)<br>        <span class=\"hljs-keyword\">break</span>;<br>    <span class=\"hljs-comment\">//è¿‡æ»¤æ‰åºåˆ—å·ä¸æ»¡è¶³æ¡ä»¶çš„pkt</span><br>    av_packet_unref(d-&gt;pkt);<br>&#125; <span class=\"hljs-keyword\">while</span> (<span class=\"hljs-number\">1</span>);<br></code></pre></td></tr></table></figure>\n\n<p>åˆæ˜¯ä¸€ä¸ªdo.while å¾ªç¯ã€‚</p>\n<ol>\n<li><p>å¦‚æœpkt-queueä¸ºç©ºï¼Œè°ƒç”¨SDL_CondSignalï¼Œé€šçŸ¥read_threadå»è·å–æ›´å¤šçš„pkt</p>\n</li>\n<li><p>å¦‚æœd-&gt;packet_pendingä¸ºtrue,  å°†d-&gt;packet_pendingæ ‡è®°ä¸ºfalseã€‚åœ¨ä¸‹ä¸€é˜¶æ®µï¼Œå°†pktå‘é€ç»™è§£ç å™¨æ—¶ï¼Œå¦‚æœè§£ç å™¨çš„pkté˜Ÿåˆ—å·²æ»¡ï¼Œæ— æ³•æ¥å—d- &gt;pktã€‚ é€šè¿‡å°†d-&gt;packet_pendingè®¾ç½®ä¸º1ï¼Œ æ ‡è®°d- &gt;pkt ä¸ºå¾…å¤„ç†ï¼Œä¸‹æ¬¡é‡æ–°å°†d-&gt;pktå‘é€ç»™è§£ç å™¨ã€‚</p>\n</li>\n<li><p>æ²¡æœ‰å¾…å¤„ç†pktï¼Œè°ƒç”¨packet_queue_getä»d-&gt;queueä¸­è·å–ä¸€ä¸ªpktã€‚å…¶ä¸­ packet_queue_get çš„ç¬¬ä¸‰ä¸ªå‚æ•°block è¢«è®¾ç½®ä¸º1ï¼Œ åœ¨è·å–ptkçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ptk queue ä¸ºç©ºï¼Œå†…éƒ¨è°ƒç”¨SDL_CondWaitå°†çº¿ç¨‹ç½®äºç­‰å¾…çŠ¶æ€ã€‚</p>\n</li>\n<li><p>å¦‚æœä»é˜Ÿåˆ—é‡Œè·å¾—äº†pktï¼Œpktçš„åºåˆ—å·å’ŒDecoderä¹‹å‰ä¿å­˜çš„pktçš„åºåˆ—å·ä¸ä¸€è‡´ã€‚ä¾‹å¦‚å‘ç”Ÿäº†seekï¼Œä¸­é—´æ•°æ®ä¸è¿ç»­äº†ï¼Œæ­¤æ—¶è°ƒç”¨avcodec_flush_bufferså†²æ´—è§£ç å™¨å†…éƒ¨bufferï¼Œè®©è§£ç å™¨å‡†å¤‡å¥½ä»seekä½ç½®å¼€å§‹è§£ç ã€‚</p>\n</li>\n<li><p>å¾ªç¯å°†pktåºåˆ—å·ä¸ä¸€è‡´çš„pktè°ƒç”¨av_packet_unref(d-&gt;pkt);ä¸¢å¼ƒï¼Œç›´åˆ°<code>d-&gt;queue-&gt;serial == d-&gt;pkt_serial</code>,æ­¤æ—¶è·å–äº†ä¸€ä¸ªpktã€‚</p>\n</li>\n</ol>\n<p>å‰é¢è§£ç å™¨è¦æ›´å¤šçš„ptkæ‰å¯ä»¥è¾“å‡ºframe, ç„¶åç¬¬äºŒé˜¶æ®µæˆ‘ä»¬ä»pkt queueä¸­ä¹Ÿè·å–åˆ°äº†ä¸€ä¸ªpktï¼Œä¸‹ä¸€æ­¥å°†è·å–çš„pktå‘é€ç»™è§£ç å™¨äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">if</span> (d-&gt;avctx-&gt;codec_type == AVMEDIA_TYPE_SUBTITLE) &#123;<br>    <span class=\"hljs-type\">int</span> got_frame = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-comment\">//Return a negative value on error, otherwise return the number of bytes used</span><br>    ret = avcodec_decode_subtitle2(d-&gt;avctx, sub, &amp;got_frame, d-&gt;pkt);<br>    <span class=\"hljs-keyword\">if</span> (ret &lt; <span class=\"hljs-number\">0</span>) &#123;<br>        <span class=\"hljs-comment\">//è§£ç å‘ç”Ÿäº†é”™è¯¯ï¼Œä¸ºäº†å’Œavcodec_send_packetçš„é”™è¯¯ç ä¸€èµ·å¤„ç†ï¼Œè½¬æ¢ä¸ºAVERROR(EAGAIN)ï¼Œå°è¯•ç»§ç»­å‘é€pkt</span><br>        ret = AVERROR(EAGAIN);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-keyword\">if</span> (got_frame &amp;&amp; !d-&gt;pkt-&gt;data) &#123;<br>            <span class=\"hljs-comment\">//d-&gt;pkt-&gt;data = NULL ä»£è¡¨ç»™è§£ç å™¨å‘é€flushæ¶ˆæ¯ï¼Œ</span><br>            <span class=\"hljs-comment\">//éœ€è¦æŒç»­ç»™è§£ç å™¨flushæ¶ˆæ¯ï¼Œç›´åˆ°æ— æ³•ç»§ç»­è¯»å–åˆ°æ–°çš„frame, </span><br>            <span class=\"hljs-comment\">//å› æ­¤å°†packet_pendingè®¾ç½®ä¸º1,æ ‡è®°å½“å‰pktä¸ºå¾…å¤„ç†ï¼Œç›´åˆ°flushå®Œæˆ</span><br>            d-&gt;packet_pending = <span class=\"hljs-number\">1</span>;<br>        &#125;<br>        ret = got_frame ? <span class=\"hljs-number\">0</span> : (d-&gt;pkt-&gt;data ? AVERROR(EAGAIN) : AVERROR_EOF);<br>    &#125;<br>    av_packet_unref(d-&gt;pkt);<br>&#125; <span class=\"hljs-keyword\">else</span> &#123;<br>    <span class=\"hljs-comment\">//ç»™éŸ³è§†é¢‘è§£ç å™¨å‘é€pkt</span><br>    <span class=\"hljs-keyword\">if</span> (avcodec_send_packet(d-&gt;avctx, d-&gt;pkt) == AVERROR(EAGAIN)) &#123;<br>        <span class=\"hljs-comment\">//æŠ¥é”™AVERROR(EAGAIN)ï¼Œè§£ç å™¨æ­¤æ—¶ä¸èƒ½æ¥å—æ›´å¤šäº†pkt</span><br>        <span class=\"hljs-comment\">//éœ€è¦è°ƒç”¨avcodec_receive_frameå°†è§£ç å™¨ä¸­çš„frameè¯»å‡ºæ‰å¯ä»¥ç»§ç»­send pkt</span><br>        av_log(d-&gt;avctx, AV_LOG_ERROR, <span class=\"hljs-string\">&quot;Receive_frame and send_packet both returned EAGAIN, which is an API violation.\\n&quot;</span>);<br>        <span class=\"hljs-comment\">//æ¯”è¾ƒå½“å‰pktæœªè¢«æˆåŠŸæ¶ˆè´¹ï¼Œåç»­éœ€è¦é‡æ–°å¤„ç†</span><br>        d-&gt;packet_pending = <span class=\"hljs-number\">1</span>;<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-comment\">//send pkt æˆåŠŸï¼Œå¼•ç”¨è®¡æ•°-1</span><br>        av_packet_unref(d-&gt;pkt);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>è¿™é‡Œå­—å¹•è§£ç å™¨å‘é€pkt è°ƒç”¨çš„æ˜¯ avcodec_decode_subtitle2 </p>\n<p>ç»™éŸ³è§†é¢‘è§£ç å™¨å‘é€pkt è°ƒç”¨çš„æ˜¯ avcodec_send_packetã€‚</p>\n<p>æ³¨æ„å‘é€pktè¿”å›AVERROR(EAGAIN)ï¼Œ æ­¤æ—¶è§£ç å™¨æ— æ³•æ¥å—å½“å‰pktï¼ˆå¯èƒ½æ˜¯å†…éƒ¨çš„pktçš„é˜Ÿåˆ—æ»¡äº†ï¼‰ã€‚é€šè¿‡<code>d-&gt;packet_pending = 1</code>å°†pktæ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œä¸‹æ¬¡å¾ªç¯ï¼Œé‡æ–°å°è¯•å‘é€ç»™è§£ç å™¨è§£ç ã€‚</p>\n<p>å¦‚æœè§£ç å™¨æˆåŠŸæ¶ˆè´¹äº†pktï¼Œç»§ç»­è¿›å…¥å¾ªç¯ã€‚å›åˆ°è¯»frameçš„é˜¶æ®µï¼Œè¯»åˆ°äº†frameï¼Œå°±è¿”å›ç»™ä¸Šå±‚å»åŠ å…¥é˜Ÿåˆ—ã€‚</p>\n<h2 id=\"æ€»ç»“\"><a href=\"#æ€»ç»“\" class=\"headerlink\" title=\"æ€»ç»“\"></a>æ€»ç»“</h2><p> video_threadçš„å·¥ä½œæ˜¯å¾ªç¯ä»pkt queue å–å‡ºpktï¼Œé€ç»™è§£ç å™¨è§£ç ï¼Œå°†è§£ç åçš„frame æ”¾å…¥frame queueã€‚</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16479425075661647942506708.png\"></p>\n"},{"layout":"post","title":"macä¸Šé€šè¿‡ doxygen + graphvizç”Ÿæˆå‡½æ•°è°ƒç”¨å›¾","date":"2022-03-25T16:00:00.000Z","_content":"\n\n\nå®‰è£…[Doxygen](https://www.doxygen.nl/index.html)\n\n```\nbrew install doxygen\nbrew install doxygen --cask\n```\n\nå®‰è£…[Graphviz](https://graphviz.org/)\n\n```\nbrew install graphviz\n```\n\n## é…ç½®doxygen\n\né…ç½®å·¥ä½œç›®å½•ï¼Œæºç ç›®å½•ï¼Œç”Ÿæˆæ–‡æ¡£ç›®å½•\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482609835051648260982959.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482610615021648261060637.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482621994932022-03-26-10-18-39-image.png)\n\né…ç½®DOT_PATH\n\n```\nâœ  ~ which dot\n/opt/homebrew/bin/dot\n```\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482622484922022-03-26-10-19-09-image.png)\n\nç”Ÿæˆæ–‡æ¡£å’Œå‡½æ•°è°ƒç”¨å›¾\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482622864902022-03-26-10-19-27-image.png)\n\n## æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾\n\n```\nâœ  ff_doc ls\nhtml  latex\nâœ  ff_doc cd html\nâœ  html open index.html\n```\n\næ–‡æ¡£ç”Ÿæˆç›®å½•ä¸‹ï¼Œæ‰“å¼€`html/index.html`\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482623074922022-03-26-10-26-47-image.png)\n\nå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å‡½æ•°è°ƒç”¨å›¾\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482623224912022-03-26-10-28-07-image.png)\n","source":"_posts/ffmpeg/2022-03-26-macä¸Šé€šè¿‡ doxygen + graphvizç”Ÿæˆå‡½æ•°è°ƒç”¨å›¾.md","raw":"---\nlayout: post\ntitle: \"macä¸Šé€šè¿‡ doxygen + graphvizç”Ÿæˆå‡½æ•°è°ƒç”¨å›¾\"\ndate: 2022-03-26\ntag: ffmpeg\n---\n\n\n\nå®‰è£…[Doxygen](https://www.doxygen.nl/index.html)\n\n```\nbrew install doxygen\nbrew install doxygen --cask\n```\n\nå®‰è£…[Graphviz](https://graphviz.org/)\n\n```\nbrew install graphviz\n```\n\n## é…ç½®doxygen\n\né…ç½®å·¥ä½œç›®å½•ï¼Œæºç ç›®å½•ï¼Œç”Ÿæˆæ–‡æ¡£ç›®å½•\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482609835051648260982959.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482610615021648261060637.png)\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482621994932022-03-26-10-18-39-image.png)\n\né…ç½®DOT_PATH\n\n```\nâœ  ~ which dot\n/opt/homebrew/bin/dot\n```\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482622484922022-03-26-10-19-09-image.png)\n\nç”Ÿæˆæ–‡æ¡£å’Œå‡½æ•°è°ƒç”¨å›¾\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482622864902022-03-26-10-19-27-image.png)\n\n## æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾\n\n```\nâœ  ff_doc ls\nhtml  latex\nâœ  ff_doc cd html\nâœ  html open index.html\n```\n\næ–‡æ¡£ç”Ÿæˆç›®å½•ä¸‹ï¼Œæ‰“å¼€`html/index.html`\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482623074922022-03-26-10-26-47-image.png)\n\nå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å‡½æ•°è°ƒç”¨å›¾\n\n![](https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482623224912022-03-26-10-28-07-image.png)\n","slug":"ffmpeg/2022-03-26-macä¸Šé€šè¿‡ doxygen + graphvizç”Ÿæˆå‡½æ•°è°ƒç”¨å›¾","published":1,"updated":"2024-03-06T11:53:13.566Z","comments":1,"photos":[],"_id":"clti3glkr002c57wh7ktt129w","content":"<p>å®‰è£…<a href=\"https://www.doxygen.nl/index.html\">Doxygen</a></p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>doxygen<br><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>doxygen --cask<br></code></pre></td></tr></table></figure>\n\n<p>å®‰è£…<a href=\"https://graphviz.org/\">Graphviz</a></p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>graphviz<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"é…ç½®doxygen\"><a href=\"#é…ç½®doxygen\" class=\"headerlink\" title=\"é…ç½®doxygen\"></a>é…ç½®doxygen</h2><p>é…ç½®å·¥ä½œç›®å½•ï¼Œæºç ç›®å½•ï¼Œç”Ÿæˆæ–‡æ¡£ç›®å½•</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482609835051648260982959.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482610615021648261060637.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482621994932022-03-26-10-18-39-image.png\"></p>\n<p>é…ç½®DOT_PATH</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">âœ  ~ which dot<br><span class=\"hljs-regexp\">/opt/</span>homebrew<span class=\"hljs-regexp\">/bin/</span>dot<br></code></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482622484922022-03-26-10-19-09-image.png\"></p>\n<p>ç”Ÿæˆæ–‡æ¡£å’Œå‡½æ•°è°ƒç”¨å›¾</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482622864902022-03-26-10-19-27-image.png\"></p>\n<h2 id=\"æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾\"><a href=\"#æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾\" class=\"headerlink\" title=\"æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾\"></a>æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾</h2><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\">âœ  ff_doc <span class=\"hljs-keyword\">ls</span><br>html  latex<br>âœ  ff_doc <span class=\"hljs-keyword\">cd</span> html<br>âœ  html <span class=\"hljs-keyword\">open</span> <span class=\"hljs-built_in\">index</span>.html<br></code></pre></td></tr></table></figure>\n\n<p>æ–‡æ¡£ç”Ÿæˆç›®å½•ä¸‹ï¼Œæ‰“å¼€<code>html/index.html</code></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482623074922022-03-26-10-26-47-image.png\"></p>\n<p>å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å‡½æ•°è°ƒç”¨å›¾</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482623224912022-03-26-10-28-07-image.png\"></p>\n","excerpt":"","more":"<p>å®‰è£…<a href=\"https://www.doxygen.nl/index.html\">Doxygen</a></p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>doxygen<br><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>doxygen --cask<br></code></pre></td></tr></table></figure>\n\n<p>å®‰è£…<a href=\"https://graphviz.org/\">Graphviz</a></p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\"><span class=\"hljs-keyword\">brew </span><span class=\"hljs-keyword\">install </span>graphviz<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"é…ç½®doxygen\"><a href=\"#é…ç½®doxygen\" class=\"headerlink\" title=\"é…ç½®doxygen\"></a>é…ç½®doxygen</h2><p>é…ç½®å·¥ä½œç›®å½•ï¼Œæºç ç›®å½•ï¼Œç”Ÿæˆæ–‡æ¡£ç›®å½•</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482609835051648260982959.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482610615021648261060637.png\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482621994932022-03-26-10-18-39-image.png\"></p>\n<p>é…ç½®DOT_PATH</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">âœ  ~ which dot<br><span class=\"hljs-regexp\">/opt/</span>homebrew<span class=\"hljs-regexp\">/bin/</span>dot<br></code></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482622484922022-03-26-10-19-09-image.png\"></p>\n<p>ç”Ÿæˆæ–‡æ¡£å’Œå‡½æ•°è°ƒç”¨å›¾</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482622864902022-03-26-10-19-27-image.png\"></p>\n<h2 id=\"æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾\"><a href=\"#æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾\" class=\"headerlink\" title=\"æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾\"></a>æŸ¥çœ‹å‡½æ•°è°ƒç”¨å›¾</h2><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\">âœ  ff_doc <span class=\"hljs-keyword\">ls</span><br>html  latex<br>âœ  ff_doc <span class=\"hljs-keyword\">cd</span> html<br>âœ  html <span class=\"hljs-keyword\">open</span> <span class=\"hljs-built_in\">index</span>.html<br></code></pre></td></tr></table></figure>\n\n<p>æ–‡æ¡£ç”Ÿæˆç›®å½•ä¸‹ï¼Œæ‰“å¼€<code>html/index.html</code></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482623074922022-03-26-10-26-47-image.png\"></p>\n<p>å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å‡½æ•°è°ƒç”¨å›¾</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16482623224912022-03-26-10-28-07-image.png\"></p>\n"},{"layout":"post","title":"ffplay ä»£ç ç»“æ„ä¸æ€»ç»“","date":"2022-03-26T16:00:00.000Z","_content":"\n## ffplay æºç åˆ†æç³»åˆ— - CSDN\n\n[ffplayæºç åˆ†æ1-æ¦‚è¿° - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10301215.html)\n\n[ffplayæºç åˆ†æ2-æ•°æ®ç»“æ„ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10301253.html)\n\n[ffplayæºç åˆ†æ3-ä»£ç æ¡†æ¶ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10301831.html)\n\n[ffplayæºç åˆ†æ4-éŸ³è§†é¢‘åŒæ­¥ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10307089.html)\n\n[ffplayæºç åˆ†æ5-å›¾åƒæ ¼å¼è½¬æ¢ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10311376.html)\n\n[ffplayæºç åˆ†æ6-éŸ³é¢‘é‡é‡‡æ · - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10312713.html)\n\n[ffplayæºç åˆ†æ7-æ’­æ”¾æ§åˆ¶ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10316225.html)\n\n## ffplay æºç åˆ†æç³»åˆ— - çŸ¥ä¹\n\n [ffplay packet queueåˆ†æ](https://zhuanlan.zhihu.com/p/43295650)\n\n [ffplay frame queueåˆ†æ](https://zhuanlan.zhihu.com/p/43564980)\n\n [ffplay readçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/43672062)\n\n [ffplayè§£ç çº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/43948483)\n\n [ffplay videoæ˜¾ç¤ºçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/44122324)\n\n [ffplay audioè¾“å‡ºçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/44139512)\n\n [ffplay subtitleæ˜¾ç¤ºçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/44207804)\n\n[ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”åŸºç¡€æ¦‚å¿µ](https://zhuanlan.zhihu.com/p/44615185)\n\n[ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”è§†é¢‘åŒæ­¥éŸ³é¢‘](https://zhuanlan.zhihu.com/p/44615401)\n\n[ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”éŸ³é¢‘åŒæ­¥è§†é¢‘](https://zhuanlan.zhihu.com/p/44680734)\n\n[ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”åŒæ­¥åˆ°å¤–éƒ¨æ—¶é’Ÿ](https://zhuanlan.zhihu.com/p/44684432)\n\n[ffplay åˆ†ææ¦‚è¿°](https://zhuanlan.zhihu.com/p/44694286)\n\n## ffplay æ€ç»´å¯¼å›¾\n\n<img title=\"\" src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1648385500340ffplay.png\" alt=\"\" width=\"821\">\n\n![](https://mmbiz.qpic.cn/mmbiz_png/GjBg4Rhq9j3NR2cp5nxibjIKz83QIicCQLV5SloO4tGdhWEdOgtkC7xJyRtspkhAeicqE3s39Lv90evp2WJbibg3cA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)\n\nffmpegæ•°æ®æµå‘\n\n1. ä»æ–‡ä»¶æˆ–è€…ç›´æ’­æµä¸­è·å–AVPacketå­˜å…¥Packet queueï¼Œ \n\n2. ä»paket queue è·å– AVPacket ï¼Œ å‘é€ç»™è§£ç å™¨è§£ç ï¼Œå¾—åˆ°AVFrame å­˜å…¥frame queue\n\n3. SDLéŸ³é¢‘æ’­æ”¾å™¨ä»frame queue ä¸­è·å– AVFrame è¿›è¡Œæ’­æ”¾ï¼ŒåŒæ—¶æ›´æ–°éŸ³é¢‘æ—¶é’Ÿ\n\n4. è§†é¢‘æ’­æ”¾ï¼Œä»frame queue ä¸­è·å– AVFrameï¼Œæ ¹æ®éŸ³é¢‘æ—¶é’Ÿè¿›è¡Œæ’­æ”¾ã€‚\n\n### Packet è·å–\n\nread_thead\n\n```\nfor (;;) {\nÂ Â Â Â //è§£å°è£…ï¼Œå°†è§£å°è£…å¾—åˆ°çš„pktæ”¾å…¥pkt queue\nÂ Â Â Â ret = av_read_frame(ic, pkt);\nÂ Â Â Â packet_queue_put(&is->subtitleq, pkt);\n}\n```\n\n### è§†é¢‘è§£ç \n\nvideo_thread\n\n```\n for (;;) {\n Â Â Â //è§£ç \nÂ Â Â Â packet_queue_get()\nÂ Â Â Â avcodec_send_packet()\nÂ Â Â Â avcodec_receive_frame()\n    //å°†è§£ç åçš„æ•°æ®æ”¾å…¥ frame queue\nÂ Â Â Â frame_queue_peek_writable();\nÂ Â Â Â frame_queue_push();\n }\n```\n\n### è§†é¢‘ç»˜åˆ¶\n\nvideo_refresh\n\n```\nframe_queue_peek();\nframe_queue_next();\n```\n\n### éŸ³é¢‘è§£ç \n\naudio_thread\n\n```\n for (;;) {\n Â Â Â //è§£ç \nÂ Â Â Â packet_queue_get()\nÂ Â Â Â avcodec_send_packet()\nÂ Â Â Â avcodec_receive_frame()\n    //å°†è§£ç åçš„æ•°æ®æ”¾å…¥ frame queue\nÂ Â Â Â frame_queue_peek_writable();\nÂ Â Â Â frame_queue_push();\n }\n```\n\n### éŸ³é¢‘æ’­æ”¾\n\nsdl_audio_callback\n\n```\nframe_queue_peek_readable();\nframe_queue_next();\n```\n","source":"_posts/ffmpeg/2022-03-27-ffplay ä»£ç ç»“æ„ä¸æ€»ç»“.md","raw":"---\nlayout: post\ntitle: \"ffplay ä»£ç ç»“æ„ä¸æ€»ç»“\"\ndate: 2022-03-27\ntag: ffmpeg\n---\n\n## ffplay æºç åˆ†æç³»åˆ— - CSDN\n\n[ffplayæºç åˆ†æ1-æ¦‚è¿° - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10301215.html)\n\n[ffplayæºç åˆ†æ2-æ•°æ®ç»“æ„ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10301253.html)\n\n[ffplayæºç åˆ†æ3-ä»£ç æ¡†æ¶ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10301831.html)\n\n[ffplayæºç åˆ†æ4-éŸ³è§†é¢‘åŒæ­¥ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10307089.html)\n\n[ffplayæºç åˆ†æ5-å›¾åƒæ ¼å¼è½¬æ¢ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10311376.html)\n\n[ffplayæºç åˆ†æ6-éŸ³é¢‘é‡é‡‡æ · - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10312713.html)\n\n[ffplayæºç åˆ†æ7-æ’­æ”¾æ§åˆ¶ - å¶ä½™ - åšå®¢å›­](https://www.cnblogs.com/leisure_chn/p/10316225.html)\n\n## ffplay æºç åˆ†æç³»åˆ— - çŸ¥ä¹\n\n [ffplay packet queueåˆ†æ](https://zhuanlan.zhihu.com/p/43295650)\n\n [ffplay frame queueåˆ†æ](https://zhuanlan.zhihu.com/p/43564980)\n\n [ffplay readçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/43672062)\n\n [ffplayè§£ç çº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/43948483)\n\n [ffplay videoæ˜¾ç¤ºçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/44122324)\n\n [ffplay audioè¾“å‡ºçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/44139512)\n\n [ffplay subtitleæ˜¾ç¤ºçº¿ç¨‹åˆ†æ](https://zhuanlan.zhihu.com/p/44207804)\n\n[ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”åŸºç¡€æ¦‚å¿µ](https://zhuanlan.zhihu.com/p/44615185)\n\n[ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”è§†é¢‘åŒæ­¥éŸ³é¢‘](https://zhuanlan.zhihu.com/p/44615401)\n\n[ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”éŸ³é¢‘åŒæ­¥è§†é¢‘](https://zhuanlan.zhihu.com/p/44680734)\n\n[ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”åŒæ­¥åˆ°å¤–éƒ¨æ—¶é’Ÿ](https://zhuanlan.zhihu.com/p/44684432)\n\n[ffplay åˆ†ææ¦‚è¿°](https://zhuanlan.zhihu.com/p/44694286)\n\n## ffplay æ€ç»´å¯¼å›¾\n\n<img title=\"\" src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1648385500340ffplay.png\" alt=\"\" width=\"821\">\n\n![](https://mmbiz.qpic.cn/mmbiz_png/GjBg4Rhq9j3NR2cp5nxibjIKz83QIicCQLV5SloO4tGdhWEdOgtkC7xJyRtspkhAeicqE3s39Lv90evp2WJbibg3cA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)\n\nffmpegæ•°æ®æµå‘\n\n1. ä»æ–‡ä»¶æˆ–è€…ç›´æ’­æµä¸­è·å–AVPacketå­˜å…¥Packet queueï¼Œ \n\n2. ä»paket queue è·å– AVPacket ï¼Œ å‘é€ç»™è§£ç å™¨è§£ç ï¼Œå¾—åˆ°AVFrame å­˜å…¥frame queue\n\n3. SDLéŸ³é¢‘æ’­æ”¾å™¨ä»frame queue ä¸­è·å– AVFrame è¿›è¡Œæ’­æ”¾ï¼ŒåŒæ—¶æ›´æ–°éŸ³é¢‘æ—¶é’Ÿ\n\n4. è§†é¢‘æ’­æ”¾ï¼Œä»frame queue ä¸­è·å– AVFrameï¼Œæ ¹æ®éŸ³é¢‘æ—¶é’Ÿè¿›è¡Œæ’­æ”¾ã€‚\n\n### Packet è·å–\n\nread_thead\n\n```\nfor (;;) {\nÂ Â Â Â //è§£å°è£…ï¼Œå°†è§£å°è£…å¾—åˆ°çš„pktæ”¾å…¥pkt queue\nÂ Â Â Â ret = av_read_frame(ic, pkt);\nÂ Â Â Â packet_queue_put(&is->subtitleq, pkt);\n}\n```\n\n### è§†é¢‘è§£ç \n\nvideo_thread\n\n```\n for (;;) {\n Â Â Â //è§£ç \nÂ Â Â Â packet_queue_get()\nÂ Â Â Â avcodec_send_packet()\nÂ Â Â Â avcodec_receive_frame()\n    //å°†è§£ç åçš„æ•°æ®æ”¾å…¥ frame queue\nÂ Â Â Â frame_queue_peek_writable();\nÂ Â Â Â frame_queue_push();\n }\n```\n\n### è§†é¢‘ç»˜åˆ¶\n\nvideo_refresh\n\n```\nframe_queue_peek();\nframe_queue_next();\n```\n\n### éŸ³é¢‘è§£ç \n\naudio_thread\n\n```\n for (;;) {\n Â Â Â //è§£ç \nÂ Â Â Â packet_queue_get()\nÂ Â Â Â avcodec_send_packet()\nÂ Â Â Â avcodec_receive_frame()\n    //å°†è§£ç åçš„æ•°æ®æ”¾å…¥ frame queue\nÂ Â Â Â frame_queue_peek_writable();\nÂ Â Â Â frame_queue_push();\n }\n```\n\n### éŸ³é¢‘æ’­æ”¾\n\nsdl_audio_callback\n\n```\nframe_queue_peek_readable();\nframe_queue_next();\n```\n","slug":"ffmpeg/2022-03-27-ffplay ä»£ç ç»“æ„ä¸æ€»ç»“","published":1,"updated":"2024-03-06T11:53:13.566Z","comments":1,"photos":[],"_id":"clti3glks002f57wh69bx7l8l","content":"<h2 id=\"ffplay-æºç åˆ†æç³»åˆ—-CSDN\"><a href=\"#ffplay-æºç åˆ†æç³»åˆ—-CSDN\" class=\"headerlink\" title=\"ffplay æºç åˆ†æç³»åˆ— - CSDN\"></a>ffplay æºç åˆ†æç³»åˆ— - CSDN</h2><p><a href=\"https://www.cnblogs.com/leisure_chn/p/10301215.html\">ffplayæºç åˆ†æ1-æ¦‚è¿° - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10301253.html\">ffplayæºç åˆ†æ2-æ•°æ®ç»“æ„ - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10301831.html\">ffplayæºç åˆ†æ3-ä»£ç æ¡†æ¶ - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10307089.html\">ffplayæºç åˆ†æ4-éŸ³è§†é¢‘åŒæ­¥ - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10311376.html\">ffplayæºç åˆ†æ5-å›¾åƒæ ¼å¼è½¬æ¢ - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10312713.html\">ffplayæºç åˆ†æ6-éŸ³é¢‘é‡é‡‡æ · - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10316225.html\">ffplayæºç åˆ†æ7-æ’­æ”¾æ§åˆ¶ - å¶ä½™ - åšå®¢å›­</a></p>\n<h2 id=\"ffplay-æºç åˆ†æç³»åˆ—-çŸ¥ä¹\"><a href=\"#ffplay-æºç åˆ†æç³»åˆ—-çŸ¥ä¹\" class=\"headerlink\" title=\"ffplay æºç åˆ†æç³»åˆ— - çŸ¥ä¹\"></a>ffplay æºç åˆ†æç³»åˆ— - çŸ¥ä¹</h2><p> <a href=\"https://zhuanlan.zhihu.com/p/43295650\">ffplay packet queueåˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/43564980\">ffplay frame queueåˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/43672062\">ffplay readçº¿ç¨‹åˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/43948483\">ffplayè§£ç çº¿ç¨‹åˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/44122324\">ffplay videoæ˜¾ç¤ºçº¿ç¨‹åˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/44139512\">ffplay audioè¾“å‡ºçº¿ç¨‹åˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/44207804\">ffplay subtitleæ˜¾ç¤ºçº¿ç¨‹åˆ†æ</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44615185\">ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”åŸºç¡€æ¦‚å¿µ</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44615401\">ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”è§†é¢‘åŒæ­¥éŸ³é¢‘</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44680734\">ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”éŸ³é¢‘åŒæ­¥è§†é¢‘</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44684432\">ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”åŒæ­¥åˆ°å¤–éƒ¨æ—¶é’Ÿ</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44694286\">ffplay åˆ†ææ¦‚è¿°</a></p>\n<h2 id=\"ffplay-æ€ç»´å¯¼å›¾\"><a href=\"#ffplay-æ€ç»´å¯¼å›¾\" class=\"headerlink\" title=\"ffplay æ€ç»´å¯¼å›¾\"></a>ffplay æ€ç»´å¯¼å›¾</h2><img title=\"\" src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1648385500340ffplay.png\" alt=\"\" width=\"821\">\n\n<p><img src=\"https://mmbiz.qpic.cn/mmbiz_png/GjBg4Rhq9j3NR2cp5nxibjIKz83QIicCQLV5SloO4tGdhWEdOgtkC7xJyRtspkhAeicqE3s39Lv90evp2WJbibg3cA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1\"></p>\n<p>ffmpegæ•°æ®æµå‘</p>\n<ol>\n<li><p>ä»æ–‡ä»¶æˆ–è€…ç›´æ’­æµä¸­è·å–AVPacketå­˜å…¥Packet queueï¼Œ </p>\n</li>\n<li><p>ä»paket queue è·å– AVPacket ï¼Œ å‘é€ç»™è§£ç å™¨è§£ç ï¼Œå¾—åˆ°AVFrame å­˜å…¥frame queue</p>\n</li>\n<li><p>SDLéŸ³é¢‘æ’­æ”¾å™¨ä»frame queue ä¸­è·å– AVFrame è¿›è¡Œæ’­æ”¾ï¼ŒåŒæ—¶æ›´æ–°éŸ³é¢‘æ—¶é’Ÿ</p>\n</li>\n<li><p>è§†é¢‘æ’­æ”¾ï¼Œä»frame queue ä¸­è·å– AVFrameï¼Œæ ¹æ®éŸ³é¢‘æ—¶é’Ÿè¿›è¡Œæ’­æ”¾ã€‚</p>\n</li>\n</ol>\n<h3 id=\"Packet-è·å–\"><a href=\"#Packet-è·å–\" class=\"headerlink\" title=\"Packet è·å–\"></a>Packet è·å–</h3><p>read_thead</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\">for <span class=\"hljs-comment\">(;;)</span> &#123;<br>Â Â Â Â <span class=\"hljs-comment\">//è§£å°è£…ï¼Œå°†è§£å°è£…å¾—åˆ°çš„pktæ”¾å…¥pkt queue</span><br>Â Â Â Â ret = av_read_frame<span class=\"hljs-comment\">(ic, pkt)</span>;<br>Â Â Â Â packet_queue_put<span class=\"hljs-comment\">(&amp;is-&gt;subtitleq, pkt)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"è§†é¢‘è§£ç \"><a href=\"#è§†é¢‘è§£ç \" class=\"headerlink\" title=\"è§†é¢‘è§£ç \"></a>è§†é¢‘è§£ç </h3><p>video_thread</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">for (;;) &#123;<br>Â Â Â <span class=\"hljs-comment\">//è§£ç </span><br>Â Â Â Â <span class=\"hljs-built_in\">packet_queue_get</span>()<br>Â Â Â Â <span class=\"hljs-built_in\">avcodec_send_packet</span>()<br>Â Â Â Â <span class=\"hljs-built_in\">avcodec_receive_frame</span>()<br>   <span class=\"hljs-comment\">//å°†è§£ç åçš„æ•°æ®æ”¾å…¥ frame queue</span><br>Â Â Â Â <span class=\"hljs-built_in\">frame_queue_peek_writable</span>();<br>Â Â Â Â <span class=\"hljs-built_in\">frame_queue_push</span>();<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"è§†é¢‘ç»˜åˆ¶\"><a href=\"#è§†é¢‘ç»˜åˆ¶\" class=\"headerlink\" title=\"è§†é¢‘ç»˜åˆ¶\"></a>è§†é¢‘ç»˜åˆ¶</h3><p>video_refresh</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">frame_queue_peek</span>();<br><span class=\"hljs-built_in\">frame_queue_next</span>();<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"éŸ³é¢‘è§£ç \"><a href=\"#éŸ³é¢‘è§£ç \" class=\"headerlink\" title=\"éŸ³é¢‘è§£ç \"></a>éŸ³é¢‘è§£ç </h3><p>audio_thread</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">for (;;) &#123;<br>Â Â Â <span class=\"hljs-comment\">//è§£ç </span><br>Â Â Â Â <span class=\"hljs-built_in\">packet_queue_get</span>()<br>Â Â Â Â <span class=\"hljs-built_in\">avcodec_send_packet</span>()<br>Â Â Â Â <span class=\"hljs-built_in\">avcodec_receive_frame</span>()<br>   <span class=\"hljs-comment\">//å°†è§£ç åçš„æ•°æ®æ”¾å…¥ frame queue</span><br>Â Â Â Â <span class=\"hljs-built_in\">frame_queue_peek_writable</span>();<br>Â Â Â Â <span class=\"hljs-built_in\">frame_queue_push</span>();<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"éŸ³é¢‘æ’­æ”¾\"><a href=\"#éŸ³é¢‘æ’­æ”¾\" class=\"headerlink\" title=\"éŸ³é¢‘æ’­æ”¾\"></a>éŸ³é¢‘æ’­æ”¾</h3><p>sdl_audio_callback</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">frame_queue_peek_readable</span>();<br><span class=\"hljs-built_in\">frame_queue_next</span>();<br></code></pre></td></tr></table></figure>\n","excerpt":"","more":"<h2 id=\"ffplay-æºç åˆ†æç³»åˆ—-CSDN\"><a href=\"#ffplay-æºç åˆ†æç³»åˆ—-CSDN\" class=\"headerlink\" title=\"ffplay æºç åˆ†æç³»åˆ— - CSDN\"></a>ffplay æºç åˆ†æç³»åˆ— - CSDN</h2><p><a href=\"https://www.cnblogs.com/leisure_chn/p/10301215.html\">ffplayæºç åˆ†æ1-æ¦‚è¿° - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10301253.html\">ffplayæºç åˆ†æ2-æ•°æ®ç»“æ„ - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10301831.html\">ffplayæºç åˆ†æ3-ä»£ç æ¡†æ¶ - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10307089.html\">ffplayæºç åˆ†æ4-éŸ³è§†é¢‘åŒæ­¥ - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10311376.html\">ffplayæºç åˆ†æ5-å›¾åƒæ ¼å¼è½¬æ¢ - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10312713.html\">ffplayæºç åˆ†æ6-éŸ³é¢‘é‡é‡‡æ · - å¶ä½™ - åšå®¢å›­</a></p>\n<p><a href=\"https://www.cnblogs.com/leisure_chn/p/10316225.html\">ffplayæºç åˆ†æ7-æ’­æ”¾æ§åˆ¶ - å¶ä½™ - åšå®¢å›­</a></p>\n<h2 id=\"ffplay-æºç åˆ†æç³»åˆ—-çŸ¥ä¹\"><a href=\"#ffplay-æºç åˆ†æç³»åˆ—-çŸ¥ä¹\" class=\"headerlink\" title=\"ffplay æºç åˆ†æç³»åˆ— - çŸ¥ä¹\"></a>ffplay æºç åˆ†æç³»åˆ— - çŸ¥ä¹</h2><p> <a href=\"https://zhuanlan.zhihu.com/p/43295650\">ffplay packet queueåˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/43564980\">ffplay frame queueåˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/43672062\">ffplay readçº¿ç¨‹åˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/43948483\">ffplayè§£ç çº¿ç¨‹åˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/44122324\">ffplay videoæ˜¾ç¤ºçº¿ç¨‹åˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/44139512\">ffplay audioè¾“å‡ºçº¿ç¨‹åˆ†æ</a></p>\n<p> <a href=\"https://zhuanlan.zhihu.com/p/44207804\">ffplay subtitleæ˜¾ç¤ºçº¿ç¨‹åˆ†æ</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44615185\">ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”åŸºç¡€æ¦‚å¿µ</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44615401\">ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”è§†é¢‘åŒæ­¥éŸ³é¢‘</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44680734\">ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”éŸ³é¢‘åŒæ­¥è§†é¢‘</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44684432\">ffplayéŸ³è§†é¢‘åŒæ­¥åˆ†æâ€”â€”åŒæ­¥åˆ°å¤–éƒ¨æ—¶é’Ÿ</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/44694286\">ffplay åˆ†ææ¦‚è¿°</a></p>\n<h2 id=\"ffplay-æ€ç»´å¯¼å›¾\"><a href=\"#ffplay-æ€ç»´å¯¼å›¾\" class=\"headerlink\" title=\"ffplay æ€ç»´å¯¼å›¾\"></a>ffplay æ€ç»´å¯¼å›¾</h2><img title=\"\" src=\"https://cdn.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/1648385500340ffplay.png\" alt=\"\" width=\"821\">\n\n<p><img src=\"https://mmbiz.qpic.cn/mmbiz_png/GjBg4Rhq9j3NR2cp5nxibjIKz83QIicCQLV5SloO4tGdhWEdOgtkC7xJyRtspkhAeicqE3s39Lv90evp2WJbibg3cA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1\"></p>\n<p>ffmpegæ•°æ®æµå‘</p>\n<ol>\n<li><p>ä»æ–‡ä»¶æˆ–è€…ç›´æ’­æµä¸­è·å–AVPacketå­˜å…¥Packet queueï¼Œ </p>\n</li>\n<li><p>ä»paket queue è·å– AVPacket ï¼Œ å‘é€ç»™è§£ç å™¨è§£ç ï¼Œå¾—åˆ°AVFrame å­˜å…¥frame queue</p>\n</li>\n<li><p>SDLéŸ³é¢‘æ’­æ”¾å™¨ä»frame queue ä¸­è·å– AVFrame è¿›è¡Œæ’­æ”¾ï¼ŒåŒæ—¶æ›´æ–°éŸ³é¢‘æ—¶é’Ÿ</p>\n</li>\n<li><p>è§†é¢‘æ’­æ”¾ï¼Œä»frame queue ä¸­è·å– AVFrameï¼Œæ ¹æ®éŸ³é¢‘æ—¶é’Ÿè¿›è¡Œæ’­æ”¾ã€‚</p>\n</li>\n</ol>\n<h3 id=\"Packet-è·å–\"><a href=\"#Packet-è·å–\" class=\"headerlink\" title=\"Packet è·å–\"></a>Packet è·å–</h3><p>read_thead</p>\n<figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gcode\">for <span class=\"hljs-comment\">(;;)</span> &#123;<br>Â Â Â Â <span class=\"hljs-comment\">//è§£å°è£…ï¼Œå°†è§£å°è£…å¾—åˆ°çš„pktæ”¾å…¥pkt queue</span><br>Â Â Â Â ret = av_read_frame<span class=\"hljs-comment\">(ic, pkt)</span>;<br>Â Â Â Â packet_queue_put<span class=\"hljs-comment\">(&amp;is-&gt;subtitleq, pkt)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"è§†é¢‘è§£ç \"><a href=\"#è§†é¢‘è§£ç \" class=\"headerlink\" title=\"è§†é¢‘è§£ç \"></a>è§†é¢‘è§£ç </h3><p>video_thread</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">for (;;) &#123;<br>Â Â Â <span class=\"hljs-comment\">//è§£ç </span><br>Â Â Â Â <span class=\"hljs-built_in\">packet_queue_get</span>()<br>Â Â Â Â <span class=\"hljs-built_in\">avcodec_send_packet</span>()<br>Â Â Â Â <span class=\"hljs-built_in\">avcodec_receive_frame</span>()<br>   <span class=\"hljs-comment\">//å°†è§£ç åçš„æ•°æ®æ”¾å…¥ frame queue</span><br>Â Â Â Â <span class=\"hljs-built_in\">frame_queue_peek_writable</span>();<br>Â Â Â Â <span class=\"hljs-built_in\">frame_queue_push</span>();<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"è§†é¢‘ç»˜åˆ¶\"><a href=\"#è§†é¢‘ç»˜åˆ¶\" class=\"headerlink\" title=\"è§†é¢‘ç»˜åˆ¶\"></a>è§†é¢‘ç»˜åˆ¶</h3><p>video_refresh</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">frame_queue_peek</span>();<br><span class=\"hljs-built_in\">frame_queue_next</span>();<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"éŸ³é¢‘è§£ç \"><a href=\"#éŸ³é¢‘è§£ç \" class=\"headerlink\" title=\"éŸ³é¢‘è§£ç \"></a>éŸ³é¢‘è§£ç </h3><p>audio_thread</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\">for (;;) &#123;<br>Â Â Â <span class=\"hljs-comment\">//è§£ç </span><br>Â Â Â Â <span class=\"hljs-built_in\">packet_queue_get</span>()<br>Â Â Â Â <span class=\"hljs-built_in\">avcodec_send_packet</span>()<br>Â Â Â Â <span class=\"hljs-built_in\">avcodec_receive_frame</span>()<br>   <span class=\"hljs-comment\">//å°†è§£ç åçš„æ•°æ®æ”¾å…¥ frame queue</span><br>Â Â Â Â <span class=\"hljs-built_in\">frame_queue_peek_writable</span>();<br>Â Â Â Â <span class=\"hljs-built_in\">frame_queue_push</span>();<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"éŸ³é¢‘æ’­æ”¾\"><a href=\"#éŸ³é¢‘æ’­æ”¾\" class=\"headerlink\" title=\"éŸ³é¢‘æ’­æ”¾\"></a>éŸ³é¢‘æ’­æ”¾</h3><p>sdl_audio_callback</p>\n<figure class=\"highlight scss\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scss\"><span class=\"hljs-built_in\">frame_queue_peek_readable</span>();<br><span class=\"hljs-built_in\">frame_queue_next</span>();<br></code></pre></td></tr></table></figure>\n"},{"layout":"post","title":"ffmpeg å‘½ä»¤","date":"2022-09-22T16:00:00.000Z","_content":"\n\n## ffmpeg \n```\nusage: ffmpeg [options] [[infile options] -i infile]... {[outfile options] outfile}...\n```\n\néŸ³é¢‘è½¬ç \n```\n#è½¬ç ç”Ÿæˆæ–°çš„æ–‡ä»¶ï¼Œç›®æ ‡ä¸º \n- ar é‡‡æ ·ç‡ 44100ï¼Œ\n- ac åŒå£°é“ï¼Œç¼–ç æ ¼å¼ aac\n- acodec ç¼–ç å™¨ aac\nffmpeg -i source.mp3 -ar 44100 -ac 2 -acodec aac -y output.m4a\n\n# è½¬æ¢ä¸º pcm\nffmpeg -i source.mp3 -f s16le -acodec pcm_s16le output.raw\n```\n\nä» mp4 ä¸­æå– yuv\n\n```\nffmpeg -i xx.mp4 -s 960x540 -pix_fmt yuv420p xx.yuv\n```\n\n- `-s` æ¥è®¾ç½® yuv æ•°æ®çš„åˆ†è¾¨ç‡\n- `-pix_fmt` è®¾ç½® yuv çš„é¢œè‰²æ ¼å¼\n\nä»mp4æˆ–flvæ–‡ä»¶ä¸­æå–h264\n```\nffmpeg -i test.flv -vcodec copy -an -bsf:v h264_mp4toannexb test.h264\n```\nä»mp4æ–‡ä»¶ä¸­æå–aac\n```\nffmpeg -i input.mp4 -vn -c:a copy output.aac\n```\n\næŠŠä¸€ä¸ª non-fragment MP4 è½¬æ¢æˆ fragment MP4ï¼Œå¯ä»¥ä½¿ç”¨ FFmpeg çš„ -movflags æ¥è½¬æ¢ã€‚å‚è€ƒï¼š[fragment mp4 è½¬æ¢](https://shangxin.me/2017/08/11/fragment-mp4-%E8%BD%AC%E6%8D%A2/)\n\nå¯¹äºåŸå§‹æ–‡ä»¶ä¸ºé MP4 æ–‡ä»¶\n```\nffmpeg -i trailer_1080p.mov -c:v copy -c:a copy -movflags frag_keyframe+empty_moov bunny_fragmented.mp4\n\n```\nå¯¹äºåŸå§‹æ–‡ä»¶å·²ç»æ˜¯ MP4 æ–‡ä»¶\n```\nffmpeg -i non_fragmented.mp4 -strict -2 -movflags frag_keyframe+empty_moov fragmented.mp4\n\n```\n\nå°† yuv ç¼–ç æˆ mp4\n```\nffmpeg -f rawvideo -pix_fmt yuv420p -s:v 1920x1080 -r 25 -i input.yuv \\\n-c:v libx264 output.mp4\n```\n\nå°† yuv ç¼–ç æˆ h264, å‚è€ƒ [Using ffmpeg to encode a raw video to H.264 format](https://superuser.com/questions/322354/using-ffmpeg-to-encode-a-raw-video-to-h-264-format)\n\n```\nffmpeg -f rawvideo -pix_fmt yuv420p -s:v 1920x1080 -r 25 -i input.yuv \\\n-c:v libx264 -f rawvideo output.264\n```\n\n## ffplay\n\næ’­æ”¾yuv\n```\nffplay -f rawvideo -video_size 1280x720 -pixel_format nv12 xxx.yuv\nffplay -f rawvideo -video_size 1280x720 -pixel_format yuv420p xxx.yuv\n```\n\næ’­æ”¾pcm\n```\nffplay -ar 16000 -ac 1 -f s16le -i xxx.pcm\n```\n\nffplay å­—å¹•ï¼Œ å‚è€ƒhttps://www.pianshen.com/article/9580874222/\n\nä½¿ç”¨è‡ªå¸¦çš„ç¬¬0ä¸ªå­—å¹•æµ\n\n```\nffplay -vf subtitles=infile:si=0 infile\n```\n","source":"_posts/ffmpeg/2022-09-23-ffmpeg-å‘½ä»¤.md","raw":"---\nlayout: post\ntitle: \"ffmpeg å‘½ä»¤\"\ndate: 2022-09-23\ntag: ffmpeg\n---\n\n\n## ffmpeg \n```\nusage: ffmpeg [options] [[infile options] -i infile]... {[outfile options] outfile}...\n```\n\néŸ³é¢‘è½¬ç \n```\n#è½¬ç ç”Ÿæˆæ–°çš„æ–‡ä»¶ï¼Œç›®æ ‡ä¸º \n- ar é‡‡æ ·ç‡ 44100ï¼Œ\n- ac åŒå£°é“ï¼Œç¼–ç æ ¼å¼ aac\n- acodec ç¼–ç å™¨ aac\nffmpeg -i source.mp3 -ar 44100 -ac 2 -acodec aac -y output.m4a\n\n# è½¬æ¢ä¸º pcm\nffmpeg -i source.mp3 -f s16le -acodec pcm_s16le output.raw\n```\n\nä» mp4 ä¸­æå– yuv\n\n```\nffmpeg -i xx.mp4 -s 960x540 -pix_fmt yuv420p xx.yuv\n```\n\n- `-s` æ¥è®¾ç½® yuv æ•°æ®çš„åˆ†è¾¨ç‡\n- `-pix_fmt` è®¾ç½® yuv çš„é¢œè‰²æ ¼å¼\n\nä»mp4æˆ–flvæ–‡ä»¶ä¸­æå–h264\n```\nffmpeg -i test.flv -vcodec copy -an -bsf:v h264_mp4toannexb test.h264\n```\nä»mp4æ–‡ä»¶ä¸­æå–aac\n```\nffmpeg -i input.mp4 -vn -c:a copy output.aac\n```\n\næŠŠä¸€ä¸ª non-fragment MP4 è½¬æ¢æˆ fragment MP4ï¼Œå¯ä»¥ä½¿ç”¨ FFmpeg çš„ -movflags æ¥è½¬æ¢ã€‚å‚è€ƒï¼š[fragment mp4 è½¬æ¢](https://shangxin.me/2017/08/11/fragment-mp4-%E8%BD%AC%E6%8D%A2/)\n\nå¯¹äºåŸå§‹æ–‡ä»¶ä¸ºé MP4 æ–‡ä»¶\n```\nffmpeg -i trailer_1080p.mov -c:v copy -c:a copy -movflags frag_keyframe+empty_moov bunny_fragmented.mp4\n\n```\nå¯¹äºåŸå§‹æ–‡ä»¶å·²ç»æ˜¯ MP4 æ–‡ä»¶\n```\nffmpeg -i non_fragmented.mp4 -strict -2 -movflags frag_keyframe+empty_moov fragmented.mp4\n\n```\n\nå°† yuv ç¼–ç æˆ mp4\n```\nffmpeg -f rawvideo -pix_fmt yuv420p -s:v 1920x1080 -r 25 -i input.yuv \\\n-c:v libx264 output.mp4\n```\n\nå°† yuv ç¼–ç æˆ h264, å‚è€ƒ [Using ffmpeg to encode a raw video to H.264 format](https://superuser.com/questions/322354/using-ffmpeg-to-encode-a-raw-video-to-h-264-format)\n\n```\nffmpeg -f rawvideo -pix_fmt yuv420p -s:v 1920x1080 -r 25 -i input.yuv \\\n-c:v libx264 -f rawvideo output.264\n```\n\n## ffplay\n\næ’­æ”¾yuv\n```\nffplay -f rawvideo -video_size 1280x720 -pixel_format nv12 xxx.yuv\nffplay -f rawvideo -video_size 1280x720 -pixel_format yuv420p xxx.yuv\n```\n\næ’­æ”¾pcm\n```\nffplay -ar 16000 -ac 1 -f s16le -i xxx.pcm\n```\n\nffplay å­—å¹•ï¼Œ å‚è€ƒhttps://www.pianshen.com/article/9580874222/\n\nä½¿ç”¨è‡ªå¸¦çš„ç¬¬0ä¸ªå­—å¹•æµ\n\n```\nffplay -vf subtitles=infile:si=0 infile\n```\n","slug":"ffmpeg/2022-09-23-ffmpeg-å‘½ä»¤","published":1,"updated":"2024-03-06T11:53:13.566Z","comments":1,"photos":[],"_id":"clti3glks002g57wh5creckit","content":"<h2 id=\"ffmpeg\"><a href=\"#ffmpeg\" class=\"headerlink\" title=\"ffmpeg\"></a>ffmpeg</h2><figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs prolog\">usage: ffmpeg [options] [[infile options] -i infile]... &#123;[outfile options] outfile&#125;...<br></code></pre></td></tr></table></figure>\n\n<p>éŸ³é¢‘è½¬ç </p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\">#è½¬ç ç”Ÿæˆæ–°çš„æ–‡ä»¶ï¼Œç›®æ ‡ä¸º </span><br><span class=\"hljs-bullet\">-</span> ar é‡‡æ ·ç‡ 44100ï¼Œ<br><span class=\"hljs-bullet\">-</span> ac åŒå£°é“ï¼Œç¼–ç æ ¼å¼ aac<br><span class=\"hljs-bullet\">-</span> acodec ç¼–ç å™¨ aac<br>ffmpeg -i source.mp3 -ar 44100 -ac 2 -acodec aac -y output.m4a<br><br><span class=\"hljs-section\"># è½¬æ¢ä¸º pcm</span><br>ffmpeg -i source.mp3 -f s16le -acodec pcm<span class=\"hljs-emphasis\">_s16le output.raw</span><br></code></pre></td></tr></table></figure>\n\n<p>ä» mp4 ä¸­æå– yuv</p>\n<figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs smali\">ffmpeg -i xx.mp4 -s 960x540 -pix_fmt yuv420p xx.yuv<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><code>-s</code> æ¥è®¾ç½® yuv æ•°æ®çš„åˆ†è¾¨ç‡</li>\n<li><code>-pix_fmt</code> è®¾ç½® yuv çš„é¢œè‰²æ ¼å¼</li>\n</ul>\n<p>ä»mp4æˆ–flvæ–‡ä»¶ä¸­æå–h264</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\">ffmpeg -i <span class=\"hljs-keyword\">test</span>.flv -vcodec <span class=\"hljs-keyword\">copy</span> -<span class=\"hljs-keyword\">an</span> -bsf:v h264_mp4toannexb <span class=\"hljs-keyword\">test</span>.h264<br></code></pre></td></tr></table></figure>\n<p>ä»mp4æ–‡ä»¶ä¸­æå–aac</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -<span class=\"hljs-selector-tag\">i</span> <span class=\"hljs-selector-tag\">input</span><span class=\"hljs-selector-class\">.mp4</span> -vn -c:<span class=\"hljs-selector-tag\">a</span> copy output.aac<br></code></pre></td></tr></table></figure>\n\n<p>æŠŠä¸€ä¸ª non-fragment MP4 è½¬æ¢æˆ fragment MP4ï¼Œå¯ä»¥ä½¿ç”¨ FFmpeg çš„ -movflags æ¥è½¬æ¢ã€‚å‚è€ƒï¼š<a href=\"https://shangxin.me/2017/08/11/fragment-mp4-%E8%BD%AC%E6%8D%A2/\">fragment mp4 è½¬æ¢</a></p>\n<p>å¯¹äºåŸå§‹æ–‡ä»¶ä¸ºé MP4 æ–‡ä»¶</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -<span class=\"hljs-selector-tag\">i</span> trailer_1080p<span class=\"hljs-selector-class\">.mov</span> -c:v copy -c:<span class=\"hljs-selector-tag\">a</span> copy -movflags frag_keyframe+empty_moov bunny_fragmented<span class=\"hljs-selector-class\">.mp4</span><br><br></code></pre></td></tr></table></figure>\n<p>å¯¹äºåŸå§‹æ–‡ä»¶å·²ç»æ˜¯ MP4 æ–‡ä»¶</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -<span class=\"hljs-selector-tag\">i</span> non_fragmented<span class=\"hljs-selector-class\">.mp4</span> -strict -<span class=\"hljs-number\">2</span> -movflags frag_keyframe+empty_moov fragmented<span class=\"hljs-selector-class\">.mp4</span><br><br></code></pre></td></tr></table></figure>\n\n<p>å°† yuv ç¼–ç æˆ mp4</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -f rawvideo -pix_fmt yuv420p -s:v <span class=\"hljs-number\">1920</span>x1080 -r <span class=\"hljs-number\">25</span> -<span class=\"hljs-selector-tag\">i</span> <span class=\"hljs-selector-tag\">input</span><span class=\"hljs-selector-class\">.yuv</span> \\<br>-c:v libx264 output.mp4<br></code></pre></td></tr></table></figure>\n\n<p>å°† yuv ç¼–ç æˆ h264, å‚è€ƒ <a href=\"https://superuser.com/questions/322354/using-ffmpeg-to-encode-a-raw-video-to-h-264-format\">Using ffmpeg to encode a raw video to H.264 format</a></p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -f rawvideo -pix_fmt yuv420p -s:v <span class=\"hljs-number\">1920</span>x1080 -r <span class=\"hljs-number\">25</span> -<span class=\"hljs-selector-tag\">i</span> <span class=\"hljs-selector-tag\">input</span><span class=\"hljs-selector-class\">.yuv</span> \\<br>-c:v libx264 -f rawvideo output.<span class=\"hljs-number\">264</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ffplay\"><a href=\"#ffplay\" class=\"headerlink\" title=\"ffplay\"></a>ffplay</h2><p>æ’­æ”¾yuv</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">ffplay</span> -f rawvideo -video_size <span class=\"hljs-number\">1280</span>x720 -pixel_format nv12 xxx.yuv<br><span class=\"hljs-attribute\">ffplay</span> -f rawvideo -video_size <span class=\"hljs-number\">1280</span>x720 -pixel_format yuv420p xxx.yuv<br></code></pre></td></tr></table></figure>\n\n<p>æ’­æ”¾pcm</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">ffplay</span> -ar <span class=\"hljs-number\">16000</span> -ac <span class=\"hljs-number\">1</span> -f s16le -i xxx.pcm<br></code></pre></td></tr></table></figure>\n\n<p>ffplay å­—å¹•ï¼Œ å‚è€ƒ<a href=\"https://www.pianshen.com/article/9580874222/\">https://www.pianshen.com/article/9580874222/</a></p>\n<p>ä½¿ç”¨è‡ªå¸¦çš„ç¬¬0ä¸ªå­—å¹•æµ</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">ffplay -vf <span class=\"hljs-attribute\">subtitles</span>=infile:si=0 infile<br></code></pre></td></tr></table></figure>\n","excerpt":"","more":"<h2 id=\"ffmpeg\"><a href=\"#ffmpeg\" class=\"headerlink\" title=\"ffmpeg\"></a>ffmpeg</h2><figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs prolog\">usage: ffmpeg [options] [[infile options] -i infile]... &#123;[outfile options] outfile&#125;...<br></code></pre></td></tr></table></figure>\n\n<p>éŸ³é¢‘è½¬ç </p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\">#è½¬ç ç”Ÿæˆæ–°çš„æ–‡ä»¶ï¼Œç›®æ ‡ä¸º </span><br><span class=\"hljs-bullet\">-</span> ar é‡‡æ ·ç‡ 44100ï¼Œ<br><span class=\"hljs-bullet\">-</span> ac åŒå£°é“ï¼Œç¼–ç æ ¼å¼ aac<br><span class=\"hljs-bullet\">-</span> acodec ç¼–ç å™¨ aac<br>ffmpeg -i source.mp3 -ar 44100 -ac 2 -acodec aac -y output.m4a<br><br><span class=\"hljs-section\"># è½¬æ¢ä¸º pcm</span><br>ffmpeg -i source.mp3 -f s16le -acodec pcm<span class=\"hljs-emphasis\">_s16le output.raw</span><br></code></pre></td></tr></table></figure>\n\n<p>ä» mp4 ä¸­æå– yuv</p>\n<figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs smali\">ffmpeg -i xx.mp4 -s 960x540 -pix_fmt yuv420p xx.yuv<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><code>-s</code> æ¥è®¾ç½® yuv æ•°æ®çš„åˆ†è¾¨ç‡</li>\n<li><code>-pix_fmt</code> è®¾ç½® yuv çš„é¢œè‰²æ ¼å¼</li>\n</ul>\n<p>ä»mp4æˆ–flvæ–‡ä»¶ä¸­æå–h264</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\">ffmpeg -i <span class=\"hljs-keyword\">test</span>.flv -vcodec <span class=\"hljs-keyword\">copy</span> -<span class=\"hljs-keyword\">an</span> -bsf:v h264_mp4toannexb <span class=\"hljs-keyword\">test</span>.h264<br></code></pre></td></tr></table></figure>\n<p>ä»mp4æ–‡ä»¶ä¸­æå–aac</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -<span class=\"hljs-selector-tag\">i</span> <span class=\"hljs-selector-tag\">input</span><span class=\"hljs-selector-class\">.mp4</span> -vn -c:<span class=\"hljs-selector-tag\">a</span> copy output.aac<br></code></pre></td></tr></table></figure>\n\n<p>æŠŠä¸€ä¸ª non-fragment MP4 è½¬æ¢æˆ fragment MP4ï¼Œå¯ä»¥ä½¿ç”¨ FFmpeg çš„ -movflags æ¥è½¬æ¢ã€‚å‚è€ƒï¼š<a href=\"https://shangxin.me/2017/08/11/fragment-mp4-%E8%BD%AC%E6%8D%A2/\">fragment mp4 è½¬æ¢</a></p>\n<p>å¯¹äºåŸå§‹æ–‡ä»¶ä¸ºé MP4 æ–‡ä»¶</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -<span class=\"hljs-selector-tag\">i</span> trailer_1080p<span class=\"hljs-selector-class\">.mov</span> -c:v copy -c:<span class=\"hljs-selector-tag\">a</span> copy -movflags frag_keyframe+empty_moov bunny_fragmented<span class=\"hljs-selector-class\">.mp4</span><br><br></code></pre></td></tr></table></figure>\n<p>å¯¹äºåŸå§‹æ–‡ä»¶å·²ç»æ˜¯ MP4 æ–‡ä»¶</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -<span class=\"hljs-selector-tag\">i</span> non_fragmented<span class=\"hljs-selector-class\">.mp4</span> -strict -<span class=\"hljs-number\">2</span> -movflags frag_keyframe+empty_moov fragmented<span class=\"hljs-selector-class\">.mp4</span><br><br></code></pre></td></tr></table></figure>\n\n<p>å°† yuv ç¼–ç æˆ mp4</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -f rawvideo -pix_fmt yuv420p -s:v <span class=\"hljs-number\">1920</span>x1080 -r <span class=\"hljs-number\">25</span> -<span class=\"hljs-selector-tag\">i</span> <span class=\"hljs-selector-tag\">input</span><span class=\"hljs-selector-class\">.yuv</span> \\<br>-c:v libx264 output.mp4<br></code></pre></td></tr></table></figure>\n\n<p>å°† yuv ç¼–ç æˆ h264, å‚è€ƒ <a href=\"https://superuser.com/questions/322354/using-ffmpeg-to-encode-a-raw-video-to-h-264-format\">Using ffmpeg to encode a raw video to H.264 format</a></p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">ffmpeg -f rawvideo -pix_fmt yuv420p -s:v <span class=\"hljs-number\">1920</span>x1080 -r <span class=\"hljs-number\">25</span> -<span class=\"hljs-selector-tag\">i</span> <span class=\"hljs-selector-tag\">input</span><span class=\"hljs-selector-class\">.yuv</span> \\<br>-c:v libx264 -f rawvideo output.<span class=\"hljs-number\">264</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ffplay\"><a href=\"#ffplay\" class=\"headerlink\" title=\"ffplay\"></a>ffplay</h2><p>æ’­æ”¾yuv</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">ffplay</span> -f rawvideo -video_size <span class=\"hljs-number\">1280</span>x720 -pixel_format nv12 xxx.yuv<br><span class=\"hljs-attribute\">ffplay</span> -f rawvideo -video_size <span class=\"hljs-number\">1280</span>x720 -pixel_format yuv420p xxx.yuv<br></code></pre></td></tr></table></figure>\n\n<p>æ’­æ”¾pcm</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">ffplay</span> -ar <span class=\"hljs-number\">16000</span> -ac <span class=\"hljs-number\">1</span> -f s16le -i xxx.pcm<br></code></pre></td></tr></table></figure>\n\n<p>ffplay å­—å¹•ï¼Œ å‚è€ƒ<a href=\"https://www.pianshen.com/article/9580874222/\">https://www.pianshen.com/article/9580874222/</a></p>\n<p>ä½¿ç”¨è‡ªå¸¦çš„ç¬¬0ä¸ªå­—å¹•æµ</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">ffplay -vf <span class=\"hljs-attribute\">subtitles</span>=infile:si=0 infile<br></code></pre></td></tr></table></figure>\n"},{"layout":"post","title":"GDB Examining Memory","date":"2023-05-22T16:00:00.000Z","_content":"å‚è€ƒï¼š\n[gdb/Output-Formats](https://sourceware.org/gdb/onlinedocs/gdb/Output-Formats.html)\n[gdb/Memory](https://sourceware.org/gdb/onlinedocs/gdb/Memory.html#Memory)\n\n\n# Output Formats\n\n- `x` : Print the binary representation of the value in hexadecimal.\n- `d`: Print the binary representation of the value in hexadecimal.\n- `u`: Print the binary representation of the value as an decimal, as if it were unsigned.\n- `o`: Print the binary representation of the value in octal.\n- `t`: Print the binary representation of the value in binary. The letter â€˜tâ€™ stands for â€œtwoâ€.\n- `a`: Print as an address, both absolute in hexadecimal and as an offset from the nearest preceding symbol. \n- `c`: Cast the value to an integer (unlike other formats, this does not just reinterpret the underlying bits) and print it as a character constant.\n- `f`: Regard the bits of the value as a floating point number and print using typical floating point syntax.\n- `s`:Regard as a string, if possible. With this format, pointers to single-byte data are displayed as null-terminated strings and arrays of single-byte data are displayed as fixed-length strings. Other values are displayed in their natural types.\n- `z`:Like â€˜xâ€™ formatting, the value is treated as an integer and printed as hexadecimal, but leading zeros are printed to pad the value to the size of the integer type.\n- `r`:Print using the â€˜rawâ€™ formatting. By default, GDB will use a Python-based pretty-printer, if one is available (see Pretty Printing). This typically results in a higher-level display of the valueâ€™s contents. The â€˜râ€™ format bypasses any Python pretty-printer which might exist.\n\n\nç¤ºä¾‹ï¼š\n```\n(lldb) p/x 10\n(int) $0 = 0x0000000a\n(lldb) p/t 10\n(int) $1 = 0b00000000000000000000000000001010\n(lldb) p/d 0x0000000a\n(int) $2 = 10\n(lldb) p/u 0x0000000a\n(int) $3 = 10\n(lldb) p/o 0x0000000a\n(int) $4 = 012\n(lldb) p/o 0x0000000a\n```\n\n# Examining Memory\nYou can use the command x (for â€œexamineâ€) to examine memory in any of several formats, independently of your programâ€™s data types.\n```\nx/nfu addr\nx addr\n```\n\n- `n`: the repeat count\n\tThe repeat count is a decimal integer; the default is 1. It specifies how much memory (counting by units u) to display. If a negative number is specified, memory is examined backward from addr.\n- `f`: the display format\n\tThe display format is one of the formats used by print (â€˜xâ€™, â€˜dâ€™, â€˜uâ€™, â€˜oâ€™, â€˜tâ€™, â€˜aâ€™, â€˜câ€™, â€˜fâ€™, â€˜sâ€™), â€˜iâ€™ (for machine instructions) and â€˜mâ€™ (for displaying memory tags). The default is â€˜xâ€™ (hexadecimal) initially. The default changes each time you use either x or print.\n- `u`:the unit size\n\tThe unit size is any of:\n\t\t- `b`: Bytes\n\t\t- `h`: Halfwords (two bytes).\n\t\t- `w`: Words (four bytes). This is the initial default.\n\t\t- `g`:Giant words (eight bytes).\n- `addr`:starting display address\n\taddr is the address where you want GDB to begin displaying memory.\n\tYou can also specify a negative repeat count to examine memory backward from the given address. For example, â€˜x/-3uh 0x54320â€™ prints three halfwords (h) at 0x5431a, 0x5431c, and 0x5431e.\n\t\n ç¤ºä¾‹ï¼š\n \n```\n# display three halfwords (h) of memory, formatted as unsigned decimal integers (â€˜uâ€™), starting at address 0x54320\nx/3uh 0x54320\n\n# prints the four words (â€˜wâ€™) of memory above the stack pointer in hexadecimal (â€˜xâ€™)\n\nx/4xw $sp\n\n# prints three halfwords (h) at 0x5431a, 0x5431c, and 0x5431e.\n\nx/-3uh 0x54320\n\n```","source":"_posts/lldb/2023-05-23-GDB Examining Memory.md","raw":"---\nlayout: post\ntitle: \"GDB Examining Memory\"\ndate: 2023-05-23\ntag: lldb\n---\nå‚è€ƒï¼š\n[gdb/Output-Formats](https://sourceware.org/gdb/onlinedocs/gdb/Output-Formats.html)\n[gdb/Memory](https://sourceware.org/gdb/onlinedocs/gdb/Memory.html#Memory)\n\n\n# Output Formats\n\n- `x` : Print the binary representation of the value in hexadecimal.\n- `d`: Print the binary representation of the value in hexadecimal.\n- `u`: Print the binary representation of the value as an decimal, as if it were unsigned.\n- `o`: Print the binary representation of the value in octal.\n- `t`: Print the binary representation of the value in binary. The letter â€˜tâ€™ stands for â€œtwoâ€.\n- `a`: Print as an address, both absolute in hexadecimal and as an offset from the nearest preceding symbol. \n- `c`: Cast the value to an integer (unlike other formats, this does not just reinterpret the underlying bits) and print it as a character constant.\n- `f`: Regard the bits of the value as a floating point number and print using typical floating point syntax.\n- `s`:Regard as a string, if possible. With this format, pointers to single-byte data are displayed as null-terminated strings and arrays of single-byte data are displayed as fixed-length strings. Other values are displayed in their natural types.\n- `z`:Like â€˜xâ€™ formatting, the value is treated as an integer and printed as hexadecimal, but leading zeros are printed to pad the value to the size of the integer type.\n- `r`:Print using the â€˜rawâ€™ formatting. By default, GDB will use a Python-based pretty-printer, if one is available (see Pretty Printing). This typically results in a higher-level display of the valueâ€™s contents. The â€˜râ€™ format bypasses any Python pretty-printer which might exist.\n\n\nç¤ºä¾‹ï¼š\n```\n(lldb) p/x 10\n(int) $0 = 0x0000000a\n(lldb) p/t 10\n(int) $1 = 0b00000000000000000000000000001010\n(lldb) p/d 0x0000000a\n(int) $2 = 10\n(lldb) p/u 0x0000000a\n(int) $3 = 10\n(lldb) p/o 0x0000000a\n(int) $4 = 012\n(lldb) p/o 0x0000000a\n```\n\n# Examining Memory\nYou can use the command x (for â€œexamineâ€) to examine memory in any of several formats, independently of your programâ€™s data types.\n```\nx/nfu addr\nx addr\n```\n\n- `n`: the repeat count\n\tThe repeat count is a decimal integer; the default is 1. It specifies how much memory (counting by units u) to display. If a negative number is specified, memory is examined backward from addr.\n- `f`: the display format\n\tThe display format is one of the formats used by print (â€˜xâ€™, â€˜dâ€™, â€˜uâ€™, â€˜oâ€™, â€˜tâ€™, â€˜aâ€™, â€˜câ€™, â€˜fâ€™, â€˜sâ€™), â€˜iâ€™ (for machine instructions) and â€˜mâ€™ (for displaying memory tags). The default is â€˜xâ€™ (hexadecimal) initially. The default changes each time you use either x or print.\n- `u`:the unit size\n\tThe unit size is any of:\n\t\t- `b`: Bytes\n\t\t- `h`: Halfwords (two bytes).\n\t\t- `w`: Words (four bytes). This is the initial default.\n\t\t- `g`:Giant words (eight bytes).\n- `addr`:starting display address\n\taddr is the address where you want GDB to begin displaying memory.\n\tYou can also specify a negative repeat count to examine memory backward from the given address. For example, â€˜x/-3uh 0x54320â€™ prints three halfwords (h) at 0x5431a, 0x5431c, and 0x5431e.\n\t\n ç¤ºä¾‹ï¼š\n \n```\n# display three halfwords (h) of memory, formatted as unsigned decimal integers (â€˜uâ€™), starting at address 0x54320\nx/3uh 0x54320\n\n# prints the four words (â€˜wâ€™) of memory above the stack pointer in hexadecimal (â€˜xâ€™)\n\nx/4xw $sp\n\n# prints three halfwords (h) at 0x5431a, 0x5431c, and 0x5431e.\n\nx/-3uh 0x54320\n\n```","slug":"lldb/2023-05-23-GDB Examining Memory","published":1,"updated":"2024-03-06T11:53:13.567Z","comments":1,"photos":[],"_id":"clti3glks002i57whg0fibore","content":"<p>å‚è€ƒï¼š<br><a href=\"https://sourceware.org/gdb/onlinedocs/gdb/Output-Formats.html\">gdb&#x2F;Output-Formats</a><br><a href=\"https://sourceware.org/gdb/onlinedocs/gdb/Memory.html#Memory\">gdb&#x2F;Memory</a></p>\n<h1 id=\"Output-Formats\"><a href=\"#Output-Formats\" class=\"headerlink\" title=\"Output Formats\"></a>Output Formats</h1><ul>\n<li><code>x</code> : Print the binary representation of the value in hexadecimal.</li>\n<li><code>d</code>: Print the binary representation of the value in hexadecimal.</li>\n<li><code>u</code>: Print the binary representation of the value as an decimal, as if it were unsigned.</li>\n<li><code>o</code>: Print the binary representation of the value in octal.</li>\n<li><code>t</code>: Print the binary representation of the value in binary. The letter â€˜tâ€™ stands for â€œtwoâ€.</li>\n<li><code>a</code>: Print as an address, both absolute in hexadecimal and as an offset from the nearest preceding symbol. </li>\n<li><code>c</code>: Cast the value to an integer (unlike other formats, this does not just reinterpret the underlying bits) and print it as a character constant.</li>\n<li><code>f</code>: Regard the bits of the value as a floating point number and print using typical floating point syntax.</li>\n<li><code>s</code>:Regard as a string, if possible. With this format, pointers to single-byte data are displayed as null-terminated strings and arrays of single-byte data are displayed as fixed-length strings. Other values are displayed in their natural types.</li>\n<li><code>z</code>:Like â€˜xâ€™ formatting, the value is treated as an integer and printed as hexadecimal, but leading zeros are printed to pad the value to the size of the integer type.</li>\n<li><code>r</code>:Print using the â€˜rawâ€™ formatting. By default, GDB will use a Python-based pretty-printer, if one is available (see Pretty Printing). This typically results in a higher-level display of the valueâ€™s contents. The â€˜râ€™ format bypasses any Python pretty-printer which might exist.</li>\n</ul>\n<p>ç¤ºä¾‹ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">(lldb) p/x 10<br>(int) <span class=\"hljs-variable\">$0</span> = 0x0000000a<br>(lldb) p/t 10<br>(int) <span class=\"hljs-variable\">$1</span> = 0b00000000000000000000000000001010<br>(lldb) p/d 0x0000000a<br>(int) <span class=\"hljs-variable\">$2</span> = 10<br>(lldb) p/u 0x0000000a<br>(int) <span class=\"hljs-variable\">$3</span> = 10<br>(lldb) p/o 0x0000000a<br>(int) <span class=\"hljs-variable\">$4</span> = 012<br>(lldb) p/o 0x0000000a<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"Examining-Memory\"><a href=\"#Examining-Memory\" class=\"headerlink\" title=\"Examining Memory\"></a>Examining Memory</h1><p>You can use the command x (for â€œexamineâ€) to examine memory in any of several formats, independently of your programâ€™s data types.</p>\n<figure class=\"highlight llvm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs llvm\"><span class=\"hljs-keyword\">x</span>/nfu addr<br><span class=\"hljs-keyword\">x</span> addr<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><code>n</code>: the repeat count<br>  The repeat count is a decimal integer; the default is 1. It specifies how much memory (counting by units u) to display. If a negative number is specified, memory is examined backward from addr.</li>\n<li><code>f</code>: the display format<br>  The display format is one of the formats used by print (â€˜xâ€™, â€˜dâ€™, â€˜uâ€™, â€˜oâ€™, â€˜tâ€™, â€˜aâ€™, â€˜câ€™, â€˜fâ€™, â€˜sâ€™), â€˜iâ€™ (for machine instructions) and â€˜mâ€™ (for displaying memory tags). The default is â€˜xâ€™ (hexadecimal) initially. The default changes each time you use either x or print.</li>\n<li><code>u</code>:the unit size<br>  The unit size is any of:<br>  - <code>b</code>: Bytes<br>  - <code>h</code>: Halfwords (two bytes).<br>  - <code>w</code>: Words (four bytes). This is the initial default.<br>  - <code>g</code>:Giant words (eight bytes).</li>\n<li><code>addr</code>:starting display address<br>  addr is the address where you want GDB to begin displaying memory.<br>  You can also specify a negative repeat count to examine memory backward from the given address. For example, â€˜x&#x2F;-3uh 0x54320â€™ prints three halfwords (h) at 0x5431a, 0x5431c, and 0x5431e.</li>\n</ul>\n<p> ç¤ºä¾‹ï¼š</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-comment\"># display three halfwords (h) of memory, formatted as unsigned decimal integers (â€˜uâ€™), starting at address 0x54320</span><br><span class=\"hljs-attribute\">x</span>/<span class=\"hljs-number\">3</span>uh <span class=\"hljs-number\">0</span>x54320<br><br><span class=\"hljs-comment\"># prints the four words (â€˜wâ€™) of memory above the stack pointer in hexadecimal (â€˜xâ€™)</span><br><br><span class=\"hljs-attribute\">x</span>/<span class=\"hljs-number\">4</span>xw $sp<br><br><span class=\"hljs-comment\"># prints three halfwords (h) at 0x5431a, 0x5431c, and 0x5431e.</span><br><br><span class=\"hljs-attribute\">x</span>/-<span class=\"hljs-number\">3</span>uh <span class=\"hljs-number\">0</span>x54320<br><br></code></pre></td></tr></table></figure>","excerpt":"","more":"<p>å‚è€ƒï¼š<br><a href=\"https://sourceware.org/gdb/onlinedocs/gdb/Output-Formats.html\">gdb&#x2F;Output-Formats</a><br><a href=\"https://sourceware.org/gdb/onlinedocs/gdb/Memory.html#Memory\">gdb&#x2F;Memory</a></p>\n<h1 id=\"Output-Formats\"><a href=\"#Output-Formats\" class=\"headerlink\" title=\"Output Formats\"></a>Output Formats</h1><ul>\n<li><code>x</code> : Print the binary representation of the value in hexadecimal.</li>\n<li><code>d</code>: Print the binary representation of the value in hexadecimal.</li>\n<li><code>u</code>: Print the binary representation of the value as an decimal, as if it were unsigned.</li>\n<li><code>o</code>: Print the binary representation of the value in octal.</li>\n<li><code>t</code>: Print the binary representation of the value in binary. The letter â€˜tâ€™ stands for â€œtwoâ€.</li>\n<li><code>a</code>: Print as an address, both absolute in hexadecimal and as an offset from the nearest preceding symbol. </li>\n<li><code>c</code>: Cast the value to an integer (unlike other formats, this does not just reinterpret the underlying bits) and print it as a character constant.</li>\n<li><code>f</code>: Regard the bits of the value as a floating point number and print using typical floating point syntax.</li>\n<li><code>s</code>:Regard as a string, if possible. With this format, pointers to single-byte data are displayed as null-terminated strings and arrays of single-byte data are displayed as fixed-length strings. Other values are displayed in their natural types.</li>\n<li><code>z</code>:Like â€˜xâ€™ formatting, the value is treated as an integer and printed as hexadecimal, but leading zeros are printed to pad the value to the size of the integer type.</li>\n<li><code>r</code>:Print using the â€˜rawâ€™ formatting. By default, GDB will use a Python-based pretty-printer, if one is available (see Pretty Printing). This typically results in a higher-level display of the valueâ€™s contents. The â€˜râ€™ format bypasses any Python pretty-printer which might exist.</li>\n</ul>\n<p>ç¤ºä¾‹ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">(lldb) p/x 10<br>(int) <span class=\"hljs-variable\">$0</span> = 0x0000000a<br>(lldb) p/t 10<br>(int) <span class=\"hljs-variable\">$1</span> = 0b00000000000000000000000000001010<br>(lldb) p/d 0x0000000a<br>(int) <span class=\"hljs-variable\">$2</span> = 10<br>(lldb) p/u 0x0000000a<br>(int) <span class=\"hljs-variable\">$3</span> = 10<br>(lldb) p/o 0x0000000a<br>(int) <span class=\"hljs-variable\">$4</span> = 012<br>(lldb) p/o 0x0000000a<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"Examining-Memory\"><a href=\"#Examining-Memory\" class=\"headerlink\" title=\"Examining Memory\"></a>Examining Memory</h1><p>You can use the command x (for â€œexamineâ€) to examine memory in any of several formats, independently of your programâ€™s data types.</p>\n<figure class=\"highlight llvm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs llvm\"><span class=\"hljs-keyword\">x</span>/nfu addr<br><span class=\"hljs-keyword\">x</span> addr<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><code>n</code>: the repeat count<br>  The repeat count is a decimal integer; the default is 1. It specifies how much memory (counting by units u) to display. If a negative number is specified, memory is examined backward from addr.</li>\n<li><code>f</code>: the display format<br>  The display format is one of the formats used by print (â€˜xâ€™, â€˜dâ€™, â€˜uâ€™, â€˜oâ€™, â€˜tâ€™, â€˜aâ€™, â€˜câ€™, â€˜fâ€™, â€˜sâ€™), â€˜iâ€™ (for machine instructions) and â€˜mâ€™ (for displaying memory tags). The default is â€˜xâ€™ (hexadecimal) initially. The default changes each time you use either x or print.</li>\n<li><code>u</code>:the unit size<br>  The unit size is any of:<br>  - <code>b</code>: Bytes<br>  - <code>h</code>: Halfwords (two bytes).<br>  - <code>w</code>: Words (four bytes). This is the initial default.<br>  - <code>g</code>:Giant words (eight bytes).</li>\n<li><code>addr</code>:starting display address<br>  addr is the address where you want GDB to begin displaying memory.<br>  You can also specify a negative repeat count to examine memory backward from the given address. For example, â€˜x&#x2F;-3uh 0x54320â€™ prints three halfwords (h) at 0x5431a, 0x5431c, and 0x5431e.</li>\n</ul>\n<p> ç¤ºä¾‹ï¼š</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-comment\"># display three halfwords (h) of memory, formatted as unsigned decimal integers (â€˜uâ€™), starting at address 0x54320</span><br><span class=\"hljs-attribute\">x</span>/<span class=\"hljs-number\">3</span>uh <span class=\"hljs-number\">0</span>x54320<br><br><span class=\"hljs-comment\"># prints the four words (â€˜wâ€™) of memory above the stack pointer in hexadecimal (â€˜xâ€™)</span><br><br><span class=\"hljs-attribute\">x</span>/<span class=\"hljs-number\">4</span>xw $sp<br><br><span class=\"hljs-comment\"># prints three halfwords (h) at 0x5431a, 0x5431c, and 0x5431e.</span><br><br><span class=\"hljs-attribute\">x</span>/-<span class=\"hljs-number\">3</span>uh <span class=\"hljs-number\">0</span>x54320<br><br></code></pre></td></tr></table></figure>"},{"layout":"post","title":"webrtc iOS æºç è°ƒè¯•","date":"2023-05-08T16:00:00.000Z","_content":"\n## è·å–æºç \n1. install [Chromium depot_tools](https://webrtc.github.io/webrtc-org/native-code/development/prerequisite-sw/)\n\n[install on Linux / Mac](https://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up)\n\n```\n$ git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git\n$ export PATH=/path/to/depot_tools:$PATH\n```\n\n2. [fetch source code](https://webrtc.github.io/webrtc-org/native-code/ios/)\n\n```\nfetch --nohooks webrtc_ios\ngclient sync\n```\n## ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®\n\nUsing Xcode\n\n```\ncd $src\ngn gen out/ios --args='target_os=\"ios\" target_cpu=\"arm64\" rtc_include_tests=false' --ide=xcode\nopen -a Xcode.app out/ios/all.xcodeproj \n```\n\né€‰æ‹© target `AppRTCMobile` æ·»åŠ ç­¾åï¼Œè¿è¡Œ\n\n# å¤„ç†é”™è¯¯\n\n![16922434326171692243431723.png](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16922434326171692243431723.png)\n\nè§£å†³æ–¹æ¡ˆï¼Œ ä¿®æ”¹ `src/build/conifg/ios/ios_sdk.gni`\n```\n# `security find-identity -v -p codesigning`.\nios_code_signing_identity_description = \"Apple Development\"\n```\næ‰§è¡Œå‘½ä»¤ `security find-identity -v -p codesigning` \n\nå°† `Apple Development` æ”¹ä¸ºå‘½ä»¤ç»™å‡ºçš„åˆ—è¡¨ä¸­çš„å…·ä½“çš„ä¸€é¡¹ï¼Œ ä¾‹å¦‚\n\n```\n# `security find-identity -v -p codesigning`.\nios_code_signing_identity_description = \"Apple Development: xiaobing yao (24ZM6UP2MW)\"\n```\n\nä¹‹åé‡æ–°æ‰§è¡Œä¸Šé¢çš„æ„å»ºå‘½ä»¤å³å¯ã€‚\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/webrtc/2023-05-09-webrtc-è°ƒè¯•.md","raw":"---\nlayout: post\ntitle: \"webrtc iOS æºç è°ƒè¯•\"\ndate: 2023-05-09\ntag: webrtc\n---\n\n## è·å–æºç \n1. install [Chromium depot_tools](https://webrtc.github.io/webrtc-org/native-code/development/prerequisite-sw/)\n\n[install on Linux / Mac](https://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up)\n\n```\n$ git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git\n$ export PATH=/path/to/depot_tools:$PATH\n```\n\n2. [fetch source code](https://webrtc.github.io/webrtc-org/native-code/ios/)\n\n```\nfetch --nohooks webrtc_ios\ngclient sync\n```\n## ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®\n\nUsing Xcode\n\n```\ncd $src\ngn gen out/ios --args='target_os=\"ios\" target_cpu=\"arm64\" rtc_include_tests=false' --ide=xcode\nopen -a Xcode.app out/ios/all.xcodeproj \n```\n\né€‰æ‹© target `AppRTCMobile` æ·»åŠ ç­¾åï¼Œè¿è¡Œ\n\n# å¤„ç†é”™è¯¯\n\n![16922434326171692243431723.png](https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16922434326171692243431723.png)\n\nè§£å†³æ–¹æ¡ˆï¼Œ ä¿®æ”¹ `src/build/conifg/ios/ios_sdk.gni`\n```\n# `security find-identity -v -p codesigning`.\nios_code_signing_identity_description = \"Apple Development\"\n```\næ‰§è¡Œå‘½ä»¤ `security find-identity -v -p codesigning` \n\nå°† `Apple Development` æ”¹ä¸ºå‘½ä»¤ç»™å‡ºçš„åˆ—è¡¨ä¸­çš„å…·ä½“çš„ä¸€é¡¹ï¼Œ ä¾‹å¦‚\n\n```\n# `security find-identity -v -p codesigning`.\nios_code_signing_identity_description = \"Apple Development: xiaobing yao (24ZM6UP2MW)\"\n```\n\nä¹‹åé‡æ–°æ‰§è¡Œä¸Šé¢çš„æ„å»ºå‘½ä»¤å³å¯ã€‚\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","slug":"webrtc/2023-05-09-webrtc-è°ƒè¯•","published":1,"updated":"2024-03-06T11:53:13.567Z","comments":1,"photos":[],"_id":"clti3glks002k57whg0ix1oaq","content":"<h2 id=\"è·å–æºç \"><a href=\"#è·å–æºç \" class=\"headerlink\" title=\"è·å–æºç \"></a>è·å–æºç </h2><ol>\n<li>install <a href=\"https://webrtc.github.io/webrtc-org/native-code/development/prerequisite-sw/\">Chromium depot_tools</a></li>\n</ol>\n<p><a href=\"https://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up\">install on Linux &#x2F; Mac</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">$ </span><span class=\"language-bash\">git <span class=\"hljs-built_in\">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class=\"hljs-meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"hljs-built_in\">export</span> PATH=/path/to/depot_tools:<span class=\"hljs-variable\">$PATH</span></span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><a href=\"https://webrtc.github.io/webrtc-org/native-code/ios/\">fetch source code</a></li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">fetch</span> <span class=\"hljs-comment\">--nohooks webrtc_ios</span><br>gclient sync<br></code></pre></td></tr></table></figure>\n<h2 id=\"ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®\"><a href=\"#ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®\" class=\"headerlink\" title=\"ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®\"></a>ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®</h2><p>Using Xcode</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\"><span class=\"hljs-keyword\">cd</span> <span class=\"hljs-variable\">$src</span><br>gn <span class=\"hljs-keyword\">gen</span> <span class=\"hljs-keyword\">out</span>/ios --<span class=\"hljs-keyword\">args</span>=&#x27;target_os=<span class=\"hljs-string\">&quot;ios&quot;</span> target_cpu=<span class=\"hljs-string\">&quot;arm64&quot;</span> rtc_include_tests=false&#x27; --ide=xcode<br><span class=\"hljs-keyword\">open</span> -a Xcode.<span class=\"hljs-keyword\">app</span> <span class=\"hljs-keyword\">out</span>/ios/all.xcodeproj <br></code></pre></td></tr></table></figure>\n\n<p>é€‰æ‹© target <code>AppRTCMobile</code> æ·»åŠ ç­¾åï¼Œè¿è¡Œ</p>\n<h1 id=\"å¤„ç†é”™è¯¯\"><a href=\"#å¤„ç†é”™è¯¯\" class=\"headerlink\" title=\"å¤„ç†é”™è¯¯\"></a>å¤„ç†é”™è¯¯</h1><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16922434326171692243431723.png\" alt=\"16922434326171692243431723.png\"></p>\n<p>è§£å†³æ–¹æ¡ˆï¼Œ ä¿®æ”¹ <code>src/build/conifg/ios/ios_sdk.gni</code></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># `security find-identity -v -p codesigning`.</span><br><span class=\"hljs-attr\">ios_code_signing_identity_description</span> = <span class=\"hljs-string\">&quot;Apple Development&quot;</span><br></code></pre></td></tr></table></figure>\n<p>æ‰§è¡Œå‘½ä»¤ <code>security find-identity -v -p codesigning</code> </p>\n<p>å°† <code>Apple Development</code> æ”¹ä¸ºå‘½ä»¤ç»™å‡ºçš„åˆ—è¡¨ä¸­çš„å…·ä½“çš„ä¸€é¡¹ï¼Œ ä¾‹å¦‚</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># `security find-identity -v -p codesigning`.</span><br><span class=\"hljs-attr\">ios_code_signing_identity_description</span> = <span class=\"hljs-string\">&quot;Apple Development: xiaobing yao (24ZM6UP2MW)&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>ä¹‹åé‡æ–°æ‰§è¡Œä¸Šé¢çš„æ„å»ºå‘½ä»¤å³å¯ã€‚</p>\n","excerpt":"","more":"<h2 id=\"è·å–æºç \"><a href=\"#è·å–æºç \" class=\"headerlink\" title=\"è·å–æºç \"></a>è·å–æºç </h2><ol>\n<li>install <a href=\"https://webrtc.github.io/webrtc-org/native-code/development/prerequisite-sw/\">Chromium depot_tools</a></li>\n</ol>\n<p><a href=\"https://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up\">install on Linux &#x2F; Mac</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">$ </span><span class=\"language-bash\">git <span class=\"hljs-built_in\">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class=\"hljs-meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"hljs-built_in\">export</span> PATH=/path/to/depot_tools:<span class=\"hljs-variable\">$PATH</span></span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><a href=\"https://webrtc.github.io/webrtc-org/native-code/ios/\">fetch source code</a></li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">fetch</span> <span class=\"hljs-comment\">--nohooks webrtc_ios</span><br>gclient sync<br></code></pre></td></tr></table></figure>\n<h2 id=\"ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®\"><a href=\"#ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®\" class=\"headerlink\" title=\"ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®\"></a>ç”Ÿæˆå¯è°ƒè¯•é¡¹ç›®</h2><p>Using Xcode</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\"><span class=\"hljs-keyword\">cd</span> <span class=\"hljs-variable\">$src</span><br>gn <span class=\"hljs-keyword\">gen</span> <span class=\"hljs-keyword\">out</span>/ios --<span class=\"hljs-keyword\">args</span>=&#x27;target_os=<span class=\"hljs-string\">&quot;ios&quot;</span> target_cpu=<span class=\"hljs-string\">&quot;arm64&quot;</span> rtc_include_tests=false&#x27; --ide=xcode<br><span class=\"hljs-keyword\">open</span> -a Xcode.<span class=\"hljs-keyword\">app</span> <span class=\"hljs-keyword\">out</span>/ios/all.xcodeproj <br></code></pre></td></tr></table></figure>\n\n<p>é€‰æ‹© target <code>AppRTCMobile</code> æ·»åŠ ç­¾åï¼Œè¿è¡Œ</p>\n<h1 id=\"å¤„ç†é”™è¯¯\"><a href=\"#å¤„ç†é”™è¯¯\" class=\"headerlink\" title=\"å¤„ç†é”™è¯¯\"></a>å¤„ç†é”™è¯¯</h1><p><img src=\"https://fastly.jsdelivr.net/gh/yxibng/filebed@main/img/images/blog/16922434326171692243431723.png\" alt=\"16922434326171692243431723.png\"></p>\n<p>è§£å†³æ–¹æ¡ˆï¼Œ ä¿®æ”¹ <code>src/build/conifg/ios/ios_sdk.gni</code></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># `security find-identity -v -p codesigning`.</span><br><span class=\"hljs-attr\">ios_code_signing_identity_description</span> = <span class=\"hljs-string\">&quot;Apple Development&quot;</span><br></code></pre></td></tr></table></figure>\n<p>æ‰§è¡Œå‘½ä»¤ <code>security find-identity -v -p codesigning</code> </p>\n<p>å°† <code>Apple Development</code> æ”¹ä¸ºå‘½ä»¤ç»™å‡ºçš„åˆ—è¡¨ä¸­çš„å…·ä½“çš„ä¸€é¡¹ï¼Œ ä¾‹å¦‚</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># `security find-identity -v -p codesigning`.</span><br><span class=\"hljs-attr\">ios_code_signing_identity_description</span> = <span class=\"hljs-string\">&quot;Apple Development: xiaobing yao (24ZM6UP2MW)&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>ä¹‹åé‡æ–°æ‰§è¡Œä¸Šé¢çš„æ„å»ºå‘½ä»¤å³å¯ã€‚</p>\n"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"clti3glkf000157wh84l07l5p","tag_id":"clti3glkh000357whddrza20q","_id":"clti3glki000857whhxjge1jl"},{"post_id":"clti3glki000957wh08s4ev8w","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkj000c57wh10t547ev"},{"post_id":"clti3glkg000257whf9lqhhge","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkj000e57whc5b69ivk"},{"post_id":"clti3glkj000a57wh1vhf9zb8","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkj000h57wh8xk0hagt"},{"post_id":"clti3glkj000d57wh44us7od4","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkk000j57whak758n67"},{"post_id":"clti3glki000557wh5t4ld6ay","tag_id":"clti3glkj000b57whb4h48nqr","_id":"clti3glkl000l57wh8c2y5a5g"},{"post_id":"clti3glkj000f57wh0glv8o4j","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkl000n57wh3cyc405t"},{"post_id":"clti3glkk000i57wh0btug6c2","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkl000p57whgp3h9j8m"},{"post_id":"clti3glki000657wh2bsz4zzr","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkl000r57whaztubblt"},{"post_id":"clti3glkk000k57whfy2v7tmp","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkl000t57whdcfofwsh"},{"post_id":"clti3glkl000m57wh9qjzazfh","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkm000v57wh0leabs89"},{"post_id":"clti3glkl000o57wh5to77wmw","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkm000y57wh334n10gm"},{"post_id":"clti3glkl000q57wh0qu7d1fx","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkm001057whcmso79g9"},{"post_id":"clti3glkl000s57wh74bc4qea","tag_id":"clti3glki000757wh4wy66aco","_id":"clti3glkm001257wha6wg04hm"},{"post_id":"clti3glkl000u57wh5hl2ezjv","tag_id":"clti3glkm000x57whc88w4quo","_id":"clti3glkn001557wh0zs179kp"},{"post_id":"clti3glkm000w57wh483n88gm","tag_id":"clti3glkm000x57whc88w4quo","_id":"clti3glkn001957whfml9hf4n"},{"post_id":"clti3glkm000z57whgjsucwbd","tag_id":"clti3glkn001857whhvt3cgd4","_id":"clti3glko001e57wh1rqlcr5p"},{"post_id":"clti3glkm001157whbvrc18cw","tag_id":"clti3glkn001857whhvt3cgd4","_id":"clti3glko001i57wh6wce07wg"},{"post_id":"clti3glkm001357whh03m2jle","tag_id":"clti3glkn001857whhvt3cgd4","_id":"clti3glkp001m57whdp7udpeq"},{"post_id":"clti3glkn001657whe0q069hb","tag_id":"clti3glkn001857whhvt3cgd4","_id":"clti3glkp001q57wh7um225kg"},{"post_id":"clti3glkn001757wh5g4bembt","tag_id":"clti3glkp001o57wh8qe6g1ok","_id":"clti3glkq001u57wh1zln6hhm"},{"post_id":"clti3glkn001a57wh5gmt7zg6","tag_id":"clti3glkp001o57wh8qe6g1ok","_id":"clti3glkq001y57whekesg8fb"},{"post_id":"clti3glkn001b57whf4eecfqb","tag_id":"clti3glkp001o57wh8qe6g1ok","_id":"clti3glkq002257wh1x5o0u11"},{"post_id":"clti3glkn001d57whczziahqc","tag_id":"clti3glkp001o57wh8qe6g1ok","_id":"clti3glkr002657whhgeugqhr"},{"post_id":"clti3glko001f57wh8r2a9gr6","tag_id":"clti3glkr002457whby0x34se","_id":"clti3glkr002a57wha5libsoi"},{"post_id":"clti3glko001h57wh2ayt3hwf","tag_id":"clti3glkr002857whdgs1abu4","_id":"clti3glks002e57whh2mr6vj2"},{"post_id":"clti3glko001j57whh72i1pfn","tag_id":"clti3glks002d57whgv0g1p34","_id":"clti3glks002j57whhlste2fs"},{"post_id":"clti3glkp001l57whbilu1h7m","tag_id":"clti3glks002d57whgv0g1p34","_id":"clti3glks002m57whe62c18s8"},{"post_id":"clti3glkp001n57wh550e3qun","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glks002o57wh3ud6dp0w"},{"post_id":"clti3glkp001p57whhtrdfqkm","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt002q57wh6dafegnn"},{"post_id":"clti3glkp001r57whh8ah3xvn","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt002s57whfnhm4hcn"},{"post_id":"clti3glkp001t57wh1wfjdy42","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt002u57wh44h6gka2"},{"post_id":"clti3glkq001v57wh7gux142p","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt002w57wh2mpbdh73"},{"post_id":"clti3glkq001x57wh08hl76pn","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt002y57wh7m7828mk"},{"post_id":"clti3glkq001z57wh2m4e99hd","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt003057whciax3i7f"},{"post_id":"clti3glkq002157whb89c9evn","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt003257whhi4o8h2i"},{"post_id":"clti3glkq002357wh5cxydnfm","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt003457wh3p7b95w6"},{"post_id":"clti3glkr002557whb7nncwt0","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt003657whfrop8p4v"},{"post_id":"clti3glkr002757wh4rlj3g96","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt003857whb93s5sp5"},{"post_id":"clti3glkr002957wh8h4h6hfp","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glkt003a57wh3a453gkf"},{"post_id":"clti3glkr002b57wh4jfjdt2f","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glku003c57whhrdrh8w3"},{"post_id":"clti3glkr002c57wh7ktt129w","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glku003e57whgtjl76hv"},{"post_id":"clti3glks002f57wh69bx7l8l","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glku003g57wh1amqe3tz"},{"post_id":"clti3glks002g57wh5creckit","tag_id":"clti3glks002l57wh85z7ehk3","_id":"clti3glku003i57wh8jqu7oej"},{"post_id":"clti3glks002i57whg0fibore","tag_id":"clti3glku003h57whc3secvhd","_id":"clti3glku003k57wh7y1f2ixx"},{"post_id":"clti3glks002k57whg0ix1oaq","tag_id":"clti3glku003j57whgg4j3nen","_id":"clti3glku003l57wh96cf9a1m"}],"Tag":[{"name":"ruby","_id":"clti3glkh000357whddrza20q"},{"name":"Shell","_id":"clti3glki000757wh4wy66aco"},{"name":"shell","_id":"clti3glkj000b57whb4h48nqr"},{"name":"aac","_id":"clti3glkm000x57whc88w4quo"},{"name":"c++","_id":"clti3glkn001857whhvt3cgd4"},{"name":"cmake","_id":"clti3glkp001o57wh8qe6g1ok"},{"name":"hls","_id":"clti3glkr002457whby0x34se"},{"name":"hls,m3u8","_id":"clti3glkr002857whdgs1abu4"},{"name":"iOS","_id":"clti3glks002d57whgv0g1p34"},{"name":"ffmpeg","_id":"clti3glks002l57wh85z7ehk3"},{"name":"lldb","_id":"clti3glku003h57whc3secvhd"},{"name":"webrtc","_id":"clti3glku003j57whgg4j3nen"}]}}